var __defProp=Object.defineProperty,__defProps=Object.defineProperties,__getOwnPropDescs=Object.getOwnPropertyDescriptors,__getOwnPropSymbols=Object.getOwnPropertySymbols,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__defNormalProp=(t,e,r)=>e in t?__defProp(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,__spreadValues=(t,e)=>{for(var r in e||(e={}))__hasOwnProp.call(e,r)&&__defNormalProp(t,r,e[r]);if(__getOwnPropSymbols)for(var r of __getOwnPropSymbols(e))__propIsEnum.call(e,r)&&__defNormalProp(t,r,e[r]);return t},__spreadProps=(t,e)=>__defProps(t,__getOwnPropDescs(e));!function(){"use strict";const t=class t{constructor(){this._controller=new AbortController,this.listeners=new Set}fetch(e,r={}){t.pendings.has(e)||(t.pendings.set(e,this),fetch(e,__spreadProps(__spreadValues({},r),{signal:this._controller.signal})).then((t=>{this.listeners.forEach((e=>e.resolve(t.clone())))})).catch((t=>{this.listeners.forEach((e=>e.reject(t)))})).finally((()=>{t.pendings.delete(e)})))}abort(){this._controller.abort()}};t.pendings=new Map;let e=t;class r{constructor(t,e){this.url=t,this.init=e,this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}ready(){let t=e.pendings.get(this.url);return t||(t=new e,t.fetch(this.url,this.init)),t.listeners.add(this),this.promise}abort(){this.reject("User abort.");const t=e.pendings.get(this.url);t&&(t.listeners.delete(this),0===t.listeners.size&&t.abort())}}class s{constructor(t=257){this.gridSize=t;const e=t-1;if(e&e-1)throw new Error("Expected grid size to be 2^n+1, got ".concat(t,"."));this.numTriangles=e*e*2-2,this.numParentTriangles=this.numTriangles-e*e,this.indices=new Uint32Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(4*this.numTriangles);for(let r=0;r<this.numTriangles;r++){let t=r+2,s=0,n=0,i=0,a=0,o=0,c=0;for(1&t?i=a=o=e:s=n=c=e;(t>>=1)>1;){const e=s+i>>1,r=n+a>>1;1&t?(i=s,a=n,s=o,n=c):(s=i,n=a,i=o,a=c),o=e,c=r}const h=4*r;this.coords[h+0]=s,this.coords[h+1]=n,this.coords[h+2]=i,this.coords[h+3]=a}}createTile(t){return new n(t,this)}}class n{constructor(t,e){const r=e.gridSize;if(t.length!==r*r)throw new Error("Expected terrain data of length ".concat(r*r," (").concat(r," x ").concat(r,"), got ").concat(t.length,"."));this.terrain=t,this.martini=e,this.errors=new Float32Array(t.length),this.update()}update(){const{numTriangles:t,numParentTriangles:e,coords:r,gridSize:s}=this.martini,{terrain:n,errors:i}=this;for(let a=t-1;a>=0;a--){const t=4*a,o=r[t+0],c=r[t+1],h=r[t+2],l=r[t+3],p=o+h>>1,f=c+l>>1,g=p+f-c,u=f+o-p,d=(n[c*s+o]+n[l*s+h])/2,M=f*s+p,b=Math.abs(d-n[M]);if(i[M]=Math.max(i[M],b),a<e){const t=(c+u>>1)*s+(o+g>>1),e=(l+u>>1)*s+(h+g>>1);i[M]=Math.max(i[M],i[t],i[e])}}}getMesh(t=0){const{gridSize:e,indices:r}=this.martini,{errors:s}=this;let n=0,i=0;const a=e-1;function o(a,c,h,l,p,f){const g=a+h>>1,u=c+l>>1;Math.abs(a-p)+Math.abs(c-f)>1&&s[u*e+g]>t?(o(p,f,a,c,g,u),o(h,l,p,f,g,u)):(r[c*e+a]=r[c*e+a]||++n,r[l*e+h]=r[l*e+h]||++n,r[f*e+p]=r[f*e+p]||++n,i++)}r.fill(0),o(0,0,a,a,a,0),o(a,a,0,0,0,a);const c=new Uint16Array(2*n),h=new Uint32Array(3*i);let l=0;function p(n,i,a,o,f,g){const u=n+a>>1,d=i+o>>1;if(Math.abs(n-f)+Math.abs(i-g)>1&&s[d*e+u]>t)p(f,g,n,i,u,d),p(a,o,f,g,u,d);else{const t=r[i*e+n]-1,s=r[o*e+a]-1,p=r[g*e+f]-1;c[2*t]=n,c[2*t+1]=i,c[2*s]=a,c[2*s+1]=o,c[2*p]=f,c[2*p+1]=g,h[l++]=t,h[l++]=s,h[l++]=p}}return p(0,0,a,a,a,0),p(a,a,0,0,0,a),{vertices:c,triangles:h}}getMeshWithSkirts(t=0){const{gridSize:e,indices:r}=this.martini,{errors:s}=this;let n=0,i=0;const a=e-1;let o,c,h=0,l=[],p=[],f=[],g=[];function u(d,M,b,w,m,_){const y=d+b>>1,P=M+w>>1;Math.abs(d-m)+Math.abs(M-_)>1&&s[P*e+y]>t?(u(m,_,d,M,y,P),u(b,w,m,_,y,P)):(o=M*e+d,c=w*e+b,h=_*e+m,0===r[o]&&(0===d?l.push(n):d===a&&p.push(n),0===M?f.push(n):M===a&&g.push(n),r[o]=++n),0===r[c]&&(0===b?l.push(n):b===a&&p.push(n),0===w?f.push(n):w===a&&g.push(n),r[c]=++n),0===r[h]&&(0===m?l.push(n):m===a&&p.push(n),0===_?f.push(n):_===a&&g.push(n),r[h]=++n),i++)}r.fill(0),u(0,0,a,a,a,0),u(a,a,0,0,0,a);const d=2*(n+l.length+p.length+f.length+g.length),M=3*(i+2*(l.length-1)+2*(p.length-1)+2*(f.length-1)+2*(g.length-1)),b=new Uint16Array(d),w=new Uint32Array(M);let m=0;function _(n,i,a,o,c,h){const l=n+a>>1,p=i+o>>1;if(Math.abs(n-c)+Math.abs(i-h)>1&&s[p*e+l]>t)_(c,h,n,i,l,p),_(a,o,c,h,l,p);else{const t=r[i*e+n]-1,s=r[o*e+a]-1,l=r[h*e+c]-1;b[2*t]=n,b[2*t+1]=i,b[2*s]=a,b[2*s+1]=o,b[2*l]=c,b[2*l+1]=h,w[m++]=t,w[m++]=s,w[m++]=l}}_(0,0,a,a,a,0),_(a,a,0,0,0,a),l.sort(((t,e)=>b[2*t+1]-b[2*e+1])),p.sort(((t,e)=>b[2*e+1]-b[2*t+1])),f.sort(((t,e)=>b[2*e]-b[2*t])),g.sort(((t,e)=>b[2*t]-b[2*e]));let y,P,v,S,x=2*n,T=0;function A(t){T=t.length;for(var e=0;e<T-1;e++)y=t[e],P=t[e+1],v=x/2,S=(x+2)/2,b[x++]=b[2*y],b[x++]=b[2*y+1],w[m++]=y,w[m++]=v,w[m++]=P,w[m++]=v,w[m++]=S,w[m++]=P;b[x++]=b[2*t[T-1]],b[x++]=b[2*t[T-1]+1]}return A(l),A(p),A(f),A(g),{vertices:b,triangles:w,numVerticesWithoutSkirts:n}}}const i=180/Math.PI;function a(t,e){return t/Math.pow(2,e)*360-180}function o(t,e){const r=Math.PI-2*Math.PI*t/Math.pow(2,e);return i*Math.atan(.5*(Math.exp(r)-Math.exp(-r)))}function c(t){const e=a(t[0]+1,t[2]);return[a(t[0],t[2]),o(t[1]+1,t[2]),e,o(t[1],t[2])]}const h="merc",l=6378137,p=Math.PI/180;function f(t,e){return[l*t*p,l*Math.log(Math.tan(.25*Math.PI+e*p*.5))]}function g(t){return t*Math.PI/180}const u={a:6378137,b:6356752.314245,f:1/298.257223563};function d(t,e,r){if(!(-80<=e&&e<=84))throw new RangeError("latitude ‘".concat(e,"’ outside UTM limits"));let s=r||Math.floor((t+180)/6)+1,n=g(6*(s-1)-180+3);const i="CDEFGHJKLMNPQRSTUVWXX".charAt(Math.floor(e/8+10));31===s&&"V"===i&&t>=3?(s++,n+=g(6)):32===s&&"X"===i&&t<9?(s--,n-=g(6)):32===s&&"X"===i&&t>=9?(s++,n+=g(6)):34===s&&"X"===i&&t<21?(s--,n-=g(6)):34===s&&"X"===i&&t>=21?(s++,n+=g(6)):36===s&&"X"===i&&t<33?(s--,n-=g(6)):36===s&&"X"===i&&t>=33&&(s++,n+=g(6));const a=g(e),o=g(t)-n,{a:c,f:h}=u,l=.9996,p=Math.sqrt(h*(2-h)),f=h/(2-h),d=f*f,M=f*d,b=f*M,w=f*b,m=f*w,_=Math.cos(o),y=Math.sin(o),P=Math.tan(a),v=Math.sinh(p*Math.atanh(p*P/Math.sqrt(1+P*P))),S=P*Math.sqrt(1+v*v)-v*Math.sqrt(1+P*P),x=Math.atan2(S,_),T=Math.asinh(y/Math.sqrt(S*S+_*_)),A=c/(1+f)*(1+1/4*d+1/64*b+1/256*m),O=[null,.5*f-2/3*d+5/16*M+41/180*b-127/288*w+7891/37800*m,13/48*d-.6*M+557/1440*b+281/630*w-1983433/1935360*m,61/240*M-103/140*b+15061/26880*w+167603/181440*m,49561/161280*b-179/168*w+6601661/7257600*m,34729/80640*w-3418889/1995840*m,.6650675310896665*m];let z=x;for(let g=1;g<=6;g++)z+=O[g]*Math.sin(2*g*x)*Math.cosh(2*g*T);let D=T;for(let g=1;g<=6;g++)D+=O[g]*Math.cos(2*g*x)*Math.sinh(2*g*T);let E=l*A*D,I=l*A*z;return E+=5e5,I<0&&(I+=1e7),[E,I]}class M{static getFromBitmap(t,e=256){this.offscreencanvas||(this.offscreencanvas=new OffscreenCanvas(512,512));const r=this.offscreencanvas.getContext("2d");if(!r)throw new Error("Get context 2d error.");r.drawImage(t,0,0,e,e);const s=r.getImageData(0,0,e,e).data,n=e+1,i=new Float32Array(n*n);for(let a=0;a<e;a++)for(let t=0;t<e;t++){const r=4*(a*e+t),o=s[r+0],c=s[r+1],h=s[r+2];i[a*n+t]=(256*o*256+256*c+h)/10-1e4}for(let a=0;a<n-1;a++)i[n*(n-1)+a]=i[n*(n-2)+a];for(let a=0;a<n;a++)i[n*a+n-1]=i[n*a+n-2];return i}static clip(t,e,r,s,n){if(r+n>e+1||s+n>e+1)throw console.log("clip: ",r,s,n),new RangeError("Clip terrain error");const i=n+1,a=e+1,o=new Float32Array(i*i);for(let c=0;c<i;c++)for(let e=0;e<i;e++)o[c*i+e]=t[(c+s)*a+(e+r)];return o}static getChildPosition(t,e,r){const s=c(t),n=c(r),i=s[2]-s[0],a=s[3]-s[1],o=(n[0]-s[0])/i,h=(s[3]-n[3])/a;return{x:Math.round(o*e),y:Math.round(h*e),bigBbox:s,smallBbox:n}}}const b=class{static getMartini(t){let e=this.martiniMap.get(t);return e||(e=new s(t+1),this.martiniMap.set(t,e)),e}static findAncestorTerrainData(t,e){const r=t[2];let s,n=t;const i=r>=e?r-e:5;for(let o=0;o<i;o++){n=[(a=n)[0]>>1,a[1]>>1,a[2]-1];const t=this.terrainDataMap.get(n.join("-"));if(t){s=t;break}}var a;return{terrain:s,tileNo:n}}static async getTerrainData(t,e,s){const n=t.join("-"),{baseSize:i}=this,{terrain:a,tileNo:o}=this.findAncestorTerrainData(t,s);if(a){let e=t[2]-o[2],r=this.baseSize;for(;e>0;)r/=2,e--;const{x:s,y:n,smallBbox:c}=M.getChildPosition(o,i,t);return{terrain:M.clip(a,i,s,n,r),size:r,bbox:c}}const h=new r(e,{cache:"force-cache",mode:"cors"});this.fetchingMap.set(n,h);try{const e=await h.ready(),r=await e.blob(),s=await createImageBitmap(r),a=M.getFromBitmap(s,i);return this.terrainDataMap.set(n,a),{terrain:a,size:i,bbox:c(t)}}finally{this.fetchingMap.delete(n)}}static async getTileGeometryAttributes(t,e,r,s=h,n){const{terrain:i,size:a,bbox:o}=await this.getTerrainData(t,e,r),c=this.getMartini(a).createTile(i),{vertices:l,triangles:p,numVerticesWithoutSkirts:g}=c.getMeshWithSkirts(10),u=l.length/2,M=new Float32Array(3*u),b=new Float32Array(2*u),w=t[2],m=a+1,_=s===h?f:d;for(let h=0;h<u;h++){const t=l[2*h],e=l[2*h+1],r=e*m+t,s=(o[2]-o[0])*t/a+o[0],c=(o[3]-o[1])*(a-e)/a+o[1],[p,f]=_(s,c,n),u=i[r],d=10*(21-w);M[3*h]=p,M[3*h+1]=f,M[3*h+2]=h>=g?u-d:u,b[2*h+0]=t/a,b[2*h+1]=(a-e)/a}return{positions:M,uv:b,triangles:p}}};b.terrainDataMap=new Map,b.fetchingMap=new Map,b.martiniMap=new Map,b.baseSize=512;let w=b;self.onmessage=async t=>{var e;const{id:r,tileNo:s,maxZ:n,url:i,coordType:a,utmZone:o,abort:c,dispose:h}=t.data;if(c)return null==(e=w.fetchingMap.get(r))||e.abort(),w.fetchingMap.delete(r),void self.postMessage({id:r,error:!0});if(h)w.terrainDataMap.delete(r);else try{const{positions:t,uv:e,triangles:c}=await w.getTileGeometryAttributes(s,i,n,a,o),h=[t.buffer,e.buffer,c.buffer];self.postMessage({id:r,positions:t,uv:e,triangles:c},h)}finally{w.fetchingMap.delete(r)}}}();
