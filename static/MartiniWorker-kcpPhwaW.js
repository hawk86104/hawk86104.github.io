var Et=Object.defineProperty,Xt=Object.defineProperties;var Ot=Object.getOwnPropertyDescriptors;var ct=Object.getOwnPropertySymbols;var kt=Object.prototype.hasOwnProperty,Ct=Object.prototype.propertyIsEnumerable;var ht=(A,E,O)=>E in A?Et(A,E,{enumerable:!0,configurable:!0,writable:!0,value:O}):A[E]=O,lt=(A,E)=>{for(var O in E||(E={}))kt.call(E,O)&&ht(A,O,E[O]);if(ct)for(var O of ct(E))Ct.call(E,O)&&ht(A,O,E[O]);return A},ft=(A,E)=>Xt(A,Ot(E));(function(){"use strict";const U=class U{constructor(){this._controller=new AbortController,this.listeners=new Set}fetch(t,e={}){U.pendings.has(t)||(U.pendings.set(t,this),fetch(t,ft(lt({},e),{signal:this._controller.signal})).then(n=>{this.listeners.forEach(o=>o.resolve(n.clone()))}).catch(n=>{this.listeners.forEach(o=>o.reject(n))}).finally(()=>{U.pendings.delete(t)}))}abort(){this._controller.abort()}};U.pendings=new Map;let A=U;class E{constructor(t,e){this.url=t,this.init=e,this.promise=new Promise((n,o)=>{this.resolve=n,this.reject=o})}ready(){let t=A.pendings.get(this.url);return t||(t=new A,t.fetch(this.url,this.init)),t.listeners.add(this),this.promise}abort(){this.reject("User abort.");const t=A.pendings.get(this.url);t&&(t.listeners.delete(this),t.listeners.size===0&&t.abort())}}class O{constructor(t=257){this.gridSize=t;const e=t-1;if(e&e-1)throw new Error("Expected grid size to be 2^n+1, got ".concat(t,"."));this.numTriangles=e*e*2-2,this.numParentTriangles=this.numTriangles-e*e,this.indices=new Uint32Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(this.numTriangles*4);for(let n=0;n<this.numTriangles;n++){let o=n+2,r=0,a=0,i=0,c=0,l=0,f=0;for(o&1?i=c=l=e:r=a=f=e;(o>>=1)>1;){const u=r+i>>1,M=a+c>>1;o&1?(i=r,c=a,r=l,a=f):(r=i,a=c,i=l,c=f),l=u,f=M}const g=n*4;this.coords[g+0]=r,this.coords[g+1]=a,this.coords[g+2]=i,this.coords[g+3]=c}}createTile(t){return new ut(t,this)}}class ut{constructor(t,e){const n=e.gridSize;if(t.length!==n*n)throw new Error("Expected terrain data of length ".concat(n*n," (").concat(n," x ").concat(n,"), got ").concat(t.length,"."));this.terrain=t,this.martini=e,this.errors=new Float32Array(t.length),this.update()}update(){const{numTriangles:t,numParentTriangles:e,coords:n,gridSize:o}=this.martini,{terrain:r,errors:a}=this;for(let i=t-1;i>=0;i--){const c=i*4,l=n[c+0],f=n[c+1],g=n[c+2],u=n[c+3],M=l+g>>1,p=f+u>>1,v=M+p-f,w=p+l-M,S=(r[f*o+l]+r[u*o+g])/2,h=p*o+M,b=Math.abs(S-r[h]);if(a[h]=Math.max(a[h],b),i<e){const d=(f+w>>1)*o+(l+v>>1),B=(u+w>>1)*o+(g+v>>1);a[h]=Math.max(a[h],a[d],a[B])}}}getMesh(t=0){const{gridSize:e,indices:n}=this.martini,{errors:o}=this;let r=0,a=0;const i=e-1;n.fill(0);function c(M,p,v,w,S,h){const b=M+v>>1,d=p+w>>1;Math.abs(M-S)+Math.abs(p-h)>1&&o[d*e+b]>t?(c(S,h,M,p,b,d),c(v,w,S,h,b,d)):(n[p*e+M]=n[p*e+M]||++r,n[w*e+v]=n[w*e+v]||++r,n[h*e+S]=n[h*e+S]||++r,a++)}c(0,0,i,i,i,0),c(i,i,0,0,0,i);const l=new Uint16Array(r*2),f=new Uint32Array(a*3);let g=0;function u(M,p,v,w,S,h){const b=M+v>>1,d=p+w>>1;if(Math.abs(M-S)+Math.abs(p-h)>1&&o[d*e+b]>t)u(S,h,M,p,b,d),u(v,w,S,h,b,d);else{const B=n[p*e+M]-1,P=n[w*e+v]-1,X=n[h*e+S]-1;l[2*B]=M,l[2*B+1]=p,l[2*P]=v,l[2*P+1]=w,l[2*X]=S,l[2*X+1]=h,f[g++]=B,f[g++]=P,f[g++]=X}}return u(0,0,i,i,i,0),u(i,i,0,0,0,i),{vertices:l,triangles:f}}getMeshWithSkirts(t=0){const{gridSize:e,indices:n}=this.martini,{errors:o}=this;let r=0,a=0;const i=e-1;let c,l,f=0,g=[],u=[],M=[],p=[];n.fill(0);function v(m,T,I,j,k,C){const R=m+I>>1,q=T+j>>1;Math.abs(m-k)+Math.abs(T-C)>1&&o[q*e+R]>t?(v(k,C,m,T,R,q),v(I,j,k,C,R,q)):(c=T*e+m,l=j*e+I,f=C*e+k,n[c]===0&&(m===0?g.push(r):m===i&&u.push(r),T===0?M.push(r):T===i&&p.push(r),n[c]=++r),n[l]===0&&(I===0?g.push(r):I===i&&u.push(r),j===0?M.push(r):j===i&&p.push(r),n[l]=++r),n[f]===0&&(k===0?g.push(r):k===i&&u.push(r),C===0?M.push(r):C===i&&p.push(r),n[f]=++r),a++)}v(0,0,i,i,i,0),v(i,i,0,0,0,i);const w=(r+g.length+u.length+M.length+p.length)*2,S=(a+(g.length-1)*2+(u.length-1)*2+(M.length-1)*2+(p.length-1)*2)*3,h=new Uint16Array(w),b=new Uint32Array(S);let d=0;function B(m,T,I,j,k,C){const R=m+I>>1,q=T+j>>1;if(Math.abs(m-k)+Math.abs(T-C)>1&&o[q*e+R]>t)B(k,C,m,T,R,q),B(I,j,k,C,R,q);else{const J=n[T*e+m]-1,N=n[j*e+I]-1,Q=n[C*e+k]-1;h[2*J]=m,h[2*J+1]=T,h[2*N]=I,h[2*N+1]=j,h[2*Q]=k,h[2*Q+1]=C,b[d++]=J,b[d++]=N,b[d++]=Q}}B(0,0,i,i,i,0),B(i,i,0,0,0,i),g.sort((m,T)=>h[2*m+1]-h[2*T+1]),u.sort((m,T)=>h[2*T+1]-h[2*m+1]),M.sort((m,T)=>h[2*T]-h[2*m]),p.sort((m,T)=>h[2*m]-h[2*T]);let P=r*2,X,z,W,G,V=0;function F(m){V=m.length;for(var T=0;T<V-1;T++)X=m[T],z=m[T+1],W=P/2,G=(P+2)/2,h[P++]=h[2*X],h[P++]=h[2*X+1],b[d++]=X,b[d++]=W,b[d++]=z,b[d++]=W,b[d++]=G,b[d++]=z;h[P++]=h[2*m[V-1]],h[P++]=h[2*m[V-1]+1]}return F(g),F(u),F(M),F(p),{vertices:h,triangles:b,numVerticesWithoutSkirts:r}}}var gt=Math.PI/180,dt=180/Math.PI;function Z(s){var t=K(s[0]+1,s[2]),e=K(s[0],s[2]),n=Y(s[1]+1,s[2]),o=Y(s[1],s[2]);return[e,n,t,o]}function Mt(s){var t=Z(s),e={type:"Polygon",coordinates:[[[t[0],t[3]],[t[0],t[1]],[t[2],t[1]],[t[2],t[3]],[t[0],t[3]]]]};return e}function K(s,t){return s/Math.pow(2,t)*360-180}function Y(s,t){var e=Math.PI-2*Math.PI*s/Math.pow(2,t);return dt*Math.atan(.5*(Math.exp(e)-Math.exp(-e)))}function y(s,t,e){var n=st(s,t,e);return n[0]=Math.floor(n[0]),n[1]=Math.floor(n[1]),n}function _(s){return[[s[0]*2,s[1]*2,s[2]+1],[s[0]*2+1,s[1]*2,s[2]+1],[s[0]*2+1,s[1]*2+1,s[2]+1],[s[0]*2,s[1]*2+1,s[2]+1]]}function tt(s){return[s[0]>>1,s[1]>>1,s[2]-1]}function nt(s){return _(tt(s))}function pt(s,t){for(var e=nt(s),n=0;n<e.length;n++)if(!et(t,e[n]))return!1;return!0}function et(s,t){for(var e=0;e<s.length;e++)if(rt(s[e],t))return!0;return!1}function rt(s,t){return s[0]===t[0]&&s[1]===t[1]&&s[2]===t[2]}function mt(s){for(var t="",e=s[2];e>0;e--){var n=0,o=1<<e-1;s[0]&o&&n++,s[1]&o&&(n+=2),t+=n.toString()}return t}function Tt(s){for(var t=0,e=0,n=s.length,o=n;o>0;o--){var r=1<<o-1,a=+s[n-o];a===1&&(t|=r),a===2&&(e|=r),a===3&&(t|=r,e|=r)}return[t,e,n]}function vt(s){var t=y(s[0],s[1],32),e=y(s[2],s[3],32),n=[t[0],t[1],e[0],e[1]],o=wt(n);if(o===0)return[0,0,0];var r=n[0]>>>32-o,a=n[1]>>>32-o;return[r,a,o]}function wt(s){for(var t=28,e=0;e<t;e++){var n=1<<32-(e+1);if((s[0]&n)!==(s[2]&n)||(s[1]&n)!==(s[3]&n))return e}return t}function st(s,t,e){var n=Math.sin(t*gt),o=Math.pow(2,e),r=o*(s/360+.5),a=o*(.5-.25*Math.log((1+n)/(1-n))/Math.PI);return r=r%o,r<0&&(r=r+o),[r,a,e]}var L={tileToGeoJSON:Mt,tileToBBOX:Z,getChildren:_,getParent:tt,getSiblings:nt,hasTile:et,hasSiblings:pt,tilesEqual:rt,tileToQuadkey:mt,quadkeyToTile:Tt,pointToTile:y,bboxToTile:vt,pointToTileFraction:st};const it="merc",ot=6378137,at=Math.PI/180;function St(s,t){const e=ot*s*at,n=ot*Math.log(Math.tan(Math.PI*.25+t*at*.5));return[e,n]}function D(s){return s*Math.PI/180}const bt={a:6378137,b:6356752314245e-6,f:1/298.257223563},It="CDEFGHJKLMNPQRSTUVWXX",Bt=5e5,Pt=1e7;function At(s,t,e){if(!(-80<=t&&t<=84))throw new RangeError("latitude ‘".concat(t,"’ outside UTM limits"));let n=e||Math.floor((s+180)/6)+1,o=D((n-1)*6-180+3);const r=It.charAt(Math.floor(t/8+10));n===31&&r==="V"&&s>=3?(n++,o+=D(6)):n===32&&r==="X"&&s<9?(n--,o-=D(6)):n===32&&r==="X"&&s>=9?(n++,o+=D(6)):n===34&&r==="X"&&s<21?(n--,o-=D(6)):n===34&&r==="X"&&s>=21?(n++,o+=D(6)):n===36&&r==="X"&&s<33?(n--,o-=D(6)):n===36&&r==="X"&&s>=33&&(n++,o+=D(6));const a=D(t),i=D(s)-o,{a:c,f:l}=bt,f=.9996,g=Math.sqrt(l*(2-l)),u=l/(2-l),M=u*u,p=u*M,v=u*p,w=u*v,S=u*w,h=Math.cos(i),b=Math.sin(i),d=Math.tan(a),B=Math.sinh(g*Math.atanh(g*d/Math.sqrt(1+d*d))),P=d*Math.sqrt(1+B*B)-B*Math.sqrt(1+d*d),X=Math.atan2(P,h),z=Math.asinh(b/Math.sqrt(P*P+h*h)),W=c/(1+u)*(1+1/4*M+1/64*v+1/256*S),G=[null,1/2*u-2/3*M+5/16*p+41/180*v-127/288*w+7891/37800*S,13/48*M-3/5*p+557/1440*v+281/630*w-1983433/1935360*S,61/240*p-103/140*v+15061/26880*w+167603/181440*S,49561/161280*v-179/168*w+6601661/7257600*S,34729/80640*w-3418889/1995840*S,212378941/319334400*S];let V=X;for(let I=1;I<=6;I++)V+=G[I]*Math.sin(2*I*X)*Math.cosh(2*I*z);let F=z;for(let I=1;I<=6;I++)F+=G[I]*Math.cos(2*I*X)*Math.sinh(2*I*z);let m=f*W*F,T=f*W*V;return m=m+Bt,T<0&&(T=T+Pt),[m,T]}class H{static getFromBitmap(t,e=256){this.offscreencanvas||(this.offscreencanvas=new OffscreenCanvas(512,512));const n=this.offscreencanvas.getContext("2d");if(!n)throw new Error("Get context 2d error.");n.drawImage(t,0,0,e,e);const o=n.getImageData(0,0,e,e).data,r=e+1,a=new Float32Array(r*r);for(let i=0;i<e;i++)for(let c=0;c<e;c++){const l=(i*e+c)*4,f=o[l+0],g=o[l+1],u=o[l+2];a[i*r+c]=(f*256*256+g*256+u)/10-1e4}for(let i=0;i<r-1;i++)a[r*(r-1)+i]=a[r*(r-2)+i];for(let i=0;i<r;i++)a[r*i+r-1]=a[r*i+r-2];return a}static clip(t,e,n,o,r){if(n+r>e+1||o+r>e+1)throw console.log("clip: ",n,o,r),new RangeError("Clip terrain error");const a=r+1,i=e+1,c=new Float32Array(a*a);for(let l=0;l<a;l++)for(let f=0;f<a;f++)c[l*a+f]=t[(l+o)*i+(f+n)];return c}static getChildPosition(t,e,n){const o=L.tileToBBOX(t),r=L.tileToBBOX(n),a=o[2]-o[0],i=o[3]-o[1],c=(r[0]-o[0])/a,l=(o[3]-r[3])/i,f=Math.round(c*e),g=Math.round(l*e);return{x:f,y:g,bigBbox:o,smallBbox:r}}}const $=class ${static getMartini(t){let e=this.martiniMap.get(t);return e||(e=new O(t+1),this.martiniMap.set(t,e)),e}static findAncestorTerrainData(t,e){const n=t[2];let o,r=t;const a=n>=e?n-e:5;for(let i=0;i<a;i++){r=L.getParent(r);const c=this.terrainDataMap.get(r.join("-"));if(c){o=c;break}}return{terrain:o,tileNo:r}}static async getTerrainData(t,e,n){const o=t.join("-"),{baseSize:r}=this,{terrain:a,tileNo:i}=this.findAncestorTerrainData(t,n);if(a){let l=t[2]-i[2],f=this.baseSize;for(;l>0;)f=f/2,l--;const{x:g,y:u,smallBbox:M}=H.getChildPosition(i,r,t);return{terrain:H.clip(a,r,g,u,f),size:f,bbox:M}}const c=new E(e,{cache:"force-cache"});this.fetchingMap.set(o,c);try{const f=await(await c.ready()).blob(),g=await createImageBitmap(f),u=H.getFromBitmap(g,r);return this.terrainDataMap.set(o,u),{terrain:u,size:r,bbox:L.tileToBBOX(t)}}finally{this.fetchingMap.delete(o)}}static async getTileGeometryAttributes(t,e,n,o=it,r){const{terrain:a,size:i,bbox:c}=await this.getTerrainData(t,e,n),f=this.getMartini(i).createTile(a),{vertices:g,triangles:u,numVerticesWithoutSkirts:M}=f.getMeshWithSkirts(10),p=g.length/2,v=new Float32Array(p*3),w=new Float32Array(p*2),S=t[2],h=i+1,b=o===it?St:At;for(let d=0;d<p;d++){const B=g[2*d],P=g[2*d+1],X=P*h+B,z=(c[2]-c[0])*B/i+c[0],W=(c[3]-c[1])*(i-P)/i+c[1],[G,V]=b(z,W,r),F=a[X],m=(21-S)*10;v[3*d]=G,v[3*d+1]=V,v[3*d+2]=d>=M?F-m:F,w[2*d+0]=B/i,w[2*d+1]=(i-P)/i}return{positions:v,uv:w,triangles:u}}};$.terrainDataMap=new Map,$.fetchingMap=new Map,$.martiniMap=new Map,$.baseSize=512;let x=$;self.onmessage=async s=>{var l;const{id:t,tileNo:e,maxZ:n,url:o,coordType:r,utmZone:a,abort:i,dispose:c}=s.data;if(i){(l=x.fetchingMap.get(t))==null||l.abort(),x.fetchingMap.delete(t),self.postMessage({id:t,error:!0});return}if(c){x.terrainDataMap.delete(t);return}try{const{positions:f,uv:g,triangles:u}=await x.getTileGeometryAttributes(e,o,n,r,a),M=[f.buffer,g.buffer,u.buffer];self.postMessage({id:t,positions:f,uv:g,triangles:u},M)}finally{x.fetchingMap.delete(t)}}})();
