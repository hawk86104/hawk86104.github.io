var __defProp=Object.defineProperty,__defProps=Object.defineProperties,__getOwnPropDescs=Object.getOwnPropertyDescriptors,__getOwnPropSymbols=Object.getOwnPropertySymbols,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__defNormalProp=(t,e,r)=>e in t?__defProp(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,__spreadValues=(t,e)=>{for(var r in e||(e={}))__hasOwnProp.call(e,r)&&__defNormalProp(t,r,e[r]);if(__getOwnPropSymbols)for(var r of __getOwnPropSymbols(e))__propIsEnum.call(e,r)&&__defNormalProp(t,r,e[r]);return t},__spreadProps=(t,e)=>__defProps(t,__getOwnPropDescs(e));!function(){"use strict";const t=class t{constructor(){this._controller=new AbortController,this.listeners=new Set}fetch(e,r={}){t.pendings.has(e)||(t.pendings.set(e,this),fetch(e,__spreadProps(__spreadValues({},r),{signal:this._controller.signal})).then((t=>{this.listeners.forEach((e=>e.resolve(t.clone())))})).catch((t=>{this.listeners.forEach((e=>e.reject(t)))})).finally((()=>{t.pendings.delete(e)})))}abort(){this._controller.abort()}};t.pendings=new Map;let e=t;class r{constructor(t,e){this.url=t,this.init=e,this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}ready(){let t=e.pendings.get(this.url);return t||(t=new e,t.fetch(this.url,this.init)),t.listeners.add(this),this.promise}abort(){this.reject("User abort.");const t=e.pendings.get(this.url);t&&(t.listeners.delete(this),0===t.listeners.size&&t.abort())}}class n{constructor(t=257){this.gridSize=t;const e=t-1;if(e&e-1)throw new Error("Expected grid size to be 2^n+1, got ".concat(t,"."));this.numTriangles=e*e*2-2,this.numParentTriangles=this.numTriangles-e*e,this.indices=new Uint32Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(4*this.numTriangles);for(let r=0;r<this.numTriangles;r++){let t=r+2,n=0,i=0,s=0,a=0,o=0,l=0;for(1&t?s=a=o=e:n=i=l=e;(t>>=1)>1;){const e=n+s>>1,r=i+a>>1;1&t?(s=n,a=i,n=o,i=l):(n=s,i=a,s=o,a=l),o=e,l=r}const c=4*r;this.coords[c+0]=n,this.coords[c+1]=i,this.coords[c+2]=s,this.coords[c+3]=a}}createTile(t){return new i(t,this)}}class i{constructor(t,e){const r=e.gridSize;if(t.length!==r*r)throw new Error("Expected terrain data of length ".concat(r*r," (").concat(r," x ").concat(r,"), got ").concat(t.length,"."));this.terrain=t,this.martini=e,this.errors=new Float32Array(t.length),this.update()}update(){const{numTriangles:t,numParentTriangles:e,coords:r,gridSize:n}=this.martini,{terrain:i,errors:s}=this;for(let a=t-1;a>=0;a--){const t=4*a,o=r[t+0],l=r[t+1],c=r[t+2],h=r[t+3],u=o+c>>1,f=l+h>>1,g=u+f-l,p=f+o-u,M=(i[l*n+o]+i[h*n+c])/2,d=f*n+u,b=Math.abs(M-i[d]);if(s[d]=Math.max(s[d],b),a<e){const t=(l+p>>1)*n+(o+g>>1),e=(h+p>>1)*n+(c+g>>1);s[d]=Math.max(s[d],s[t],s[e])}}}getMesh(t=0){const{gridSize:e,indices:r}=this.martini,{errors:n}=this;let i=0,s=0;const a=e-1;function o(a,l,c,h,u,f){const g=a+c>>1,p=l+h>>1;Math.abs(a-u)+Math.abs(l-f)>1&&n[p*e+g]>t?(o(u,f,a,l,g,p),o(c,h,u,f,g,p)):(r[l*e+a]=r[l*e+a]||++i,r[h*e+c]=r[h*e+c]||++i,r[f*e+u]=r[f*e+u]||++i,s++)}r.fill(0),o(0,0,a,a,a,0),o(a,a,0,0,0,a);const l=new Uint16Array(2*i),c=new Uint32Array(3*s);let h=0;function u(i,s,a,o,f,g){const p=i+a>>1,M=s+o>>1;if(Math.abs(i-f)+Math.abs(s-g)>1&&n[M*e+p]>t)u(f,g,i,s,p,M),u(a,o,f,g,p,M);else{const t=r[s*e+i]-1,n=r[o*e+a]-1,u=r[g*e+f]-1;l[2*t]=i,l[2*t+1]=s,l[2*n]=a,l[2*n+1]=o,l[2*u]=f,l[2*u+1]=g,c[h++]=t,c[h++]=n,c[h++]=u}}return u(0,0,a,a,a,0),u(a,a,0,0,0,a),{vertices:l,triangles:c}}getMeshWithSkirts(t=0){const{gridSize:e,indices:r}=this.martini,{errors:n}=this;let i=0,s=0;const a=e-1;let o,l,c=0,h=[],u=[],f=[],g=[];function p(M,d,b,w,m,_){const y=M+b>>1,P=d+w>>1;Math.abs(M-m)+Math.abs(d-_)>1&&n[P*e+y]>t?(p(m,_,M,d,y,P),p(b,w,m,_,y,P)):(o=d*e+M,l=w*e+b,c=_*e+m,0===r[o]&&(0===M?h.push(i):M===a&&u.push(i),0===d?f.push(i):d===a&&g.push(i),r[o]=++i),0===r[l]&&(0===b?h.push(i):b===a&&u.push(i),0===w?f.push(i):w===a&&g.push(i),r[l]=++i),0===r[c]&&(0===m?h.push(i):m===a&&u.push(i),0===_?f.push(i):_===a&&g.push(i),r[c]=++i),s++)}r.fill(0),p(0,0,a,a,a,0),p(a,a,0,0,0,a);const M=2*(i+h.length+u.length+f.length+g.length),d=3*(s+2*(h.length-1)+2*(u.length-1)+2*(f.length-1)+2*(g.length-1)),b=new Uint16Array(M),w=new Uint32Array(d);let m=0;function _(i,s,a,o,l,c){const h=i+a>>1,u=s+o>>1;if(Math.abs(i-l)+Math.abs(s-c)>1&&n[u*e+h]>t)_(l,c,i,s,h,u),_(a,o,l,c,h,u);else{const t=r[s*e+i]-1,n=r[o*e+a]-1,h=r[c*e+l]-1;b[2*t]=i,b[2*t+1]=s,b[2*n]=a,b[2*n+1]=o,b[2*h]=l,b[2*h+1]=c,w[m++]=t,w[m++]=n,w[m++]=h}}_(0,0,a,a,a,0),_(a,a,0,0,0,a),h.sort(((t,e)=>b[2*t+1]-b[2*e+1])),u.sort(((t,e)=>b[2*e+1]-b[2*t+1])),f.sort(((t,e)=>b[2*e]-b[2*t])),g.sort(((t,e)=>b[2*t]-b[2*e]));let y,P,v,T,S=2*i,O=0;function x(t){O=t.length;for(var e=0;e<O-1;e++)y=t[e],P=t[e+1],v=S/2,T=(S+2)/2,b[S++]=b[2*y],b[S++]=b[2*y+1],w[m++]=y,w[m++]=v,w[m++]=P,w[m++]=v,w[m++]=T,w[m++]=P;b[S++]=b[2*t[O-1]],b[S++]=b[2*t[O-1]+1]}return x(h),x(u),x(f),x(g),{vertices:b,triangles:w,numVerticesWithoutSkirts:i}}}var s=Math.PI/180,a=180/Math.PI;function o(t){var e=l(t[0]+1,t[2]);return[l(t[0],t[2]),c(t[1]+1,t[2]),e,c(t[1],t[2])]}function l(t,e){return t/Math.pow(2,e)*360-180}function c(t,e){var r=Math.PI-2*Math.PI*t/Math.pow(2,e);return a*Math.atan(.5*(Math.exp(r)-Math.exp(-r)))}function h(t,e,r){var n=d(t,e,r);return n[0]=Math.floor(n[0]),n[1]=Math.floor(n[1]),n}function u(t){return[[2*t[0],2*t[1],t[2]+1],[2*t[0]+1,2*t[1],t[2]+1],[2*t[0]+1,2*t[1]+1,t[2]+1],[2*t[0],2*t[1]+1,t[2]+1]]}function f(t){return[t[0]>>1,t[1]>>1,t[2]-1]}function g(t){return u(f(t))}function p(t,e){for(var r=0;r<t.length;r++)if(M(t[r],e))return!0;return!1}function M(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function d(t,e,r){var n=Math.sin(e*s),i=Math.pow(2,r),a=i*(t/360+.5);return(a%=i)<0&&(a+=i),[a,i*(.5-.25*Math.log((1+n)/(1-n))/Math.PI),r]}var b={tileToGeoJSON:function(t){var e=o(t);return{type:"Polygon",coordinates:[[[e[0],e[3]],[e[0],e[1]],[e[2],e[1]],[e[2],e[3]],[e[0],e[3]]]]}},tileToBBOX:o,getChildren:u,getParent:f,getSiblings:g,hasTile:p,hasSiblings:function(t,e){for(var r=g(t),n=0;n<r.length;n++)if(!p(e,r[n]))return!1;return!0},tilesEqual:M,tileToQuadkey:function(t){for(var e="",r=t[2];r>0;r--){var n=0,i=1<<r-1;0!=(t[0]&i)&&n++,0!=(t[1]&i)&&(n+=2),e+=n.toString()}return e},quadkeyToTile:function(t){for(var e=0,r=0,n=t.length,i=n;i>0;i--){var s=1<<i-1,a=+t[n-i];1===a&&(e|=s),2===a&&(r|=s),3===a&&(e|=s,r|=s)}return[e,r,n]},pointToTile:h,bboxToTile:function(t){var e=h(t[0],t[1],32),r=h(t[2],t[3],32),n=[e[0],e[1],r[0],r[1]],i=function(t){for(var e=28,r=0;r<e;r++){var n=1<<32-(r+1);if((t[0]&n)!=(t[2]&n)||(t[1]&n)!=(t[3]&n))return r}return e}(n);return 0===i?[0,0,0]:[n[0]>>>32-i,n[1]>>>32-i,i]},pointToTileFraction:d};const w="merc",m=6378137,_=Math.PI/180;function y(t,e){return[m*t*_,m*Math.log(Math.tan(.25*Math.PI+e*_*.5))]}function P(t){return t*Math.PI/180}const v={a:6378137,b:6356752.314245,f:1/298.257223563};function T(t,e,r){if(!(-80<=e&&e<=84))throw new RangeError("latitude ‘".concat(e,"’ outside UTM limits"));let n=r||Math.floor((t+180)/6)+1,i=P(6*(n-1)-180+3);const s="CDEFGHJKLMNPQRSTUVWXX".charAt(Math.floor(e/8+10));31===n&&"V"===s&&t>=3?(n++,i+=P(6)):32===n&&"X"===s&&t<9?(n--,i-=P(6)):32===n&&"X"===s&&t>=9?(n++,i+=P(6)):34===n&&"X"===s&&t<21?(n--,i-=P(6)):34===n&&"X"===s&&t>=21?(n++,i+=P(6)):36===n&&"X"===s&&t<33?(n--,i-=P(6)):36===n&&"X"===s&&t>=33&&(n++,i+=P(6));const a=P(e),o=P(t)-i,{a:l,f:c}=v,h=.9996,u=Math.sqrt(c*(2-c)),f=c/(2-c),g=f*f,p=f*g,M=f*p,d=f*M,b=f*d,w=Math.cos(o),m=Math.sin(o),_=Math.tan(a),y=Math.sinh(u*Math.atanh(u*_/Math.sqrt(1+_*_))),T=_*Math.sqrt(1+y*y)-y*Math.sqrt(1+_*_),S=Math.atan2(T,w),O=Math.asinh(m/Math.sqrt(T*T+w*w)),x=l/(1+f)*(1+1/4*g+1/64*M+1/256*b),A=[null,.5*f-2/3*g+5/16*p+41/180*M-127/288*d+7891/37800*b,13/48*g-.6*p+557/1440*M+281/630*d-1983433/1935360*b,61/240*p-103/140*M+15061/26880*d+167603/181440*b,49561/161280*M-179/168*d+6601661/7257600*b,34729/80640*d-3418889/1995840*b,.6650675310896665*b];let z=S;for(let P=1;P<=6;P++)z+=A[P]*Math.sin(2*P*S)*Math.cosh(2*P*O);let B=O;for(let P=1;P<=6;P++)B+=A[P]*Math.cos(2*P*S)*Math.sinh(2*P*O);let E=h*x*B,I=h*x*z;return E+=5e5,I<0&&(I+=1e7),[E,I]}class S{static getFromBitmap(t,e=256){this.offscreencanvas||(this.offscreencanvas=new OffscreenCanvas(512,512));const r=this.offscreencanvas.getContext("2d");if(!r)throw new Error("Get context 2d error.");r.drawImage(t,0,0,e,e);const n=r.getImageData(0,0,e,e).data,i=e+1,s=new Float32Array(i*i);for(let a=0;a<e;a++)for(let t=0;t<e;t++){const r=4*(a*e+t),o=n[r+0],l=n[r+1],c=n[r+2];s[a*i+t]=(256*o*256+256*l+c)/10-1e4}for(let a=0;a<i-1;a++)s[i*(i-1)+a]=s[i*(i-2)+a];for(let a=0;a<i;a++)s[i*a+i-1]=s[i*a+i-2];return s}static clip(t,e,r,n,i){if(r+i>e+1||n+i>e+1)throw console.log("clip: ",r,n,i),new RangeError("Clip terrain error");const s=i+1,a=e+1,o=new Float32Array(s*s);for(let l=0;l<s;l++)for(let e=0;e<s;e++)o[l*s+e]=t[(l+n)*a+(e+r)];return o}static getChildPosition(t,e,r){const n=b.tileToBBOX(t),i=b.tileToBBOX(r),s=n[2]-n[0],a=n[3]-n[1],o=(i[0]-n[0])/s,l=(n[3]-i[3])/a;return{x:Math.round(o*e),y:Math.round(l*e),bigBbox:n,smallBbox:i}}}const O=class{static getMartini(t){let e=this.martiniMap.get(t);return e||(e=new n(t+1),this.martiniMap.set(t,e)),e}static findAncestorTerrainData(t,e){const r=t[2];let n,i=t;const s=r>=e?r-e:5;for(let a=0;a<s;a++){i=b.getParent(i);const t=this.terrainDataMap.get(i.join("-"));if(t){n=t;break}}return{terrain:n,tileNo:i}}static async getTerrainData(t,e,n){const i=t.join("-"),{baseSize:s}=this,{terrain:a,tileNo:o}=this.findAncestorTerrainData(t,n);if(a){let e=t[2]-o[2],r=this.baseSize;for(;e>0;)r/=2,e--;const{x:n,y:i,smallBbox:l}=S.getChildPosition(o,s,t);return{terrain:S.clip(a,s,n,i,r),size:r,bbox:l}}const l=new r(e,{cache:"force-cache"});this.fetchingMap.set(i,l);try{const e=await l.ready(),r=await e.blob(),n=await createImageBitmap(r),a=S.getFromBitmap(n,s);return this.terrainDataMap.set(i,a),{terrain:a,size:s,bbox:b.tileToBBOX(t)}}finally{this.fetchingMap.delete(i)}}static async getTileGeometryAttributes(t,e,r,n=w,i){const{terrain:s,size:a,bbox:o}=await this.getTerrainData(t,e,r),l=this.getMartini(a).createTile(s),{vertices:c,triangles:h,numVerticesWithoutSkirts:u}=l.getMeshWithSkirts(10),f=c.length/2,g=new Float32Array(3*f),p=new Float32Array(2*f),M=t[2],d=a+1,b=n===w?y:T;for(let w=0;w<f;w++){const t=c[2*w],e=c[2*w+1],r=e*d+t,n=(o[2]-o[0])*t/a+o[0],l=(o[3]-o[1])*(a-e)/a+o[1],[h,f]=b(n,l,i),m=s[r],_=10*(21-M);g[3*w]=h,g[3*w+1]=f,g[3*w+2]=w>=u?m-_:m,p[2*w+0]=t/a,p[2*w+1]=(a-e)/a}return{positions:g,uv:p,triangles:h}}};O.terrainDataMap=new Map,O.fetchingMap=new Map,O.martiniMap=new Map,O.baseSize=512;let x=O;self.onmessage=async t=>{var e;const{id:r,tileNo:n,maxZ:i,url:s,coordType:a,utmZone:o,abort:l,dispose:c}=t.data;if(l)return null==(e=x.fetchingMap.get(r))||e.abort(),x.fetchingMap.delete(r),void self.postMessage({id:r,error:!0});if(c)x.terrainDataMap.delete(r);else try{const{positions:t,uv:e,triangles:l}=await x.getTileGeometryAttributes(n,s,i,a,o),c=[t.buffer,e.buffer,l.buffer];self.postMessage({id:r,positions:t,uv:e,triangles:l},c)}finally{x.fetchingMap.delete(r)}}}();
