{"version":3,"file":"MapWorker-D92lukyk.js","sources":["../src/plugins/simpleGIS/lib/threeSatelliteMap/Utils/Fetch.ts","../src/plugins/simpleGIS/lib/threeSatelliteMap/Providers/MapProvider/getTileBitmap.ts","../src/plugins/simpleGIS/lib/threeSatelliteMap/Providers/MapProvider/MapWorker.ts"],"sourcesContent":["// TODO 需要一个数据转换器\nclass AbortableFetch {\n    static pendings = new Map<string, AbortableFetch>();\n\n    private _controller = new AbortController();\n    listeners = new Set<Fetch>();\n\n    fetch(url: string, init: RequestInit = {}) {\n        if (AbortableFetch.pendings.has(url)) {\n            return;\n        }\n\n        AbortableFetch.pendings.set(url, this);\n\n        fetch(url, {\n            ...init,\n            signal: this._controller.signal\n        }).then(res => {\n            this.listeners.forEach(item => item.resolve(res.clone()));\n        }).catch(e => {\n            this.listeners.forEach(item => item.reject(e));\n        }).finally(() => {\n            AbortableFetch.pendings.delete(url);\n        });\n    }\n\n    abort() {\n        this._controller.abort();\n    }\n}\n\nclass Fetch {\n    resolve: (value: Response | PromiseLike<Response>) => void;\n    reject: (reason?: any) => void;\n    promise: Promise<Response>;\n\n    constructor(public url: string, public init?: RequestInit) {\n        this.promise = new Promise<Response>((resolve, reject) => {\n            this.resolve = resolve;\n            this.reject = reject;\n        });\n    }\n\n    ready() {\n        let abFetch = AbortableFetch.pendings.get(this.url);\n        if (!abFetch) {\n            abFetch = new AbortableFetch();\n            abFetch.fetch(this.url, this.init);\n        }\n        abFetch.listeners.add(this);\n        return this.promise;\n    }\n\n    abort() {\n        this.reject('User abort.');\n        const abFetch = AbortableFetch.pendings.get(this.url);\n        if (!abFetch) {\n            return;\n        }\n        abFetch.listeners.delete(this);\n        if (abFetch.listeners.size === 0) {\n            abFetch.abort();\n        }\n    }\n}\n\nexport { Fetch };","/*\n * @Description: \n * @Version: 1.668\n * @Autor: 地虎降天龙\n * @Date: 2024-02-26 18:58:32\n * @LastEditors: 地虎降天龙\n * @LastEditTime: 2024-03-14 15:53:19\n */\nimport { Fetch } from '../../Utils/Fetch';\n\nlet offscreencanvas: OffscreenCanvas;\n\nexport async function getTileBitmap(tileNo: number[], fetch: Fetch, debug = false): Promise<ImageBitmap> {\n    const res = await fetch.ready();\n    const blob = await res.blob();\n    const bitmap = await createImageBitmap(blob, debug ? undefined : { imageOrientation: 'flipY' });\n\n    if (!debug) {\n        return bitmap;\n    }\n\n    if (!offscreencanvas) {\n        offscreencanvas = new OffscreenCanvas(256, 256);\n    }\n    const ctx = offscreencanvas.getContext('2d');\n    if (!ctx) {\n        throw new Error('Offscreencanvas.getContext(\"2d\") error!');\n    }\n    const { width, height } = offscreencanvas;\n    ctx.drawImage(bitmap, 0, 0);\n    ctx.rect(0, 0, width, height);\n    ctx.strokeStyle = '#00FFFF';\n    ctx.font = '20px Arial';\n    ctx.stroke();\n    ctx.fillStyle = '#FF4444';\n    ctx.fillText(`${tileNo[0]}`, 10, 30);\n    ctx.fillStyle = '#44FF44';\n    ctx.fillText(`${tileNo[1]}`, 10, 55);\n    ctx.fillStyle = '#66AAFF';\n    ctx.fillText(`${tileNo[2]}`, 10, 80);\n    // @ts-ignore\n    return await createImageBitmap(offscreencanvas, { imageOrientation: 'flipY' });\n}","/*\n * @Description: \n * @Version: 1.668\n * @Autor: 地虎降天龙\n * @Date: 2024-02-26 18:58:32\n * @LastEditors: 地虎降天龙\n * @LastEditTime: 2024-03-14 15:53:43\n */\nimport { Fetch } from '../../Utils/Fetch';\nimport { getTileBitmap } from './getTileBitmap';\n\ntype MessageType = MessageEvent<{\n    id: string,\n    tileNo: number[],\n    url: string;\n    debug?: boolean;\n    abort?: boolean;\n}>;\n\nconst fetchingMap = new Map<string, Fetch>();\n\nself.onmessage = async (e: MessageType) => {\n    const { id, tileNo, url, debug, abort } = e.data;\n\n    if (abort) {\n        fetchingMap.get(id)?.abort();\n        fetchingMap.delete(id);\n        self.postMessage({ id, error: true });\n        return;\n    }\n\n    try {\n        const fetch = new Fetch(url, { cache: 'force-cache', mode: 'cors' });\n        fetchingMap.set(id, fetch);\n        const bitmap = await getTileBitmap(tileNo, fetch, debug);\n        // @ts-ignore\n        self.postMessage({ id, bitmap }, [bitmap]);\n    } catch (e) {\n        self.postMessage({ id, error: true });\n    } finally {\n        fetchingMap.delete(id);\n    }\n};"],"names":["e"],"mappings":"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"}