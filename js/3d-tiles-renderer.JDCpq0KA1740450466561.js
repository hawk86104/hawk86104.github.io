var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,a=(t,s,n)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[s]=n;import{M as o,D as l,G as c,V as h,a as u,b as d,P as p,B as m,c as g,C as f,d as _,S as b,e as y,E as w,R as T,I as x,Q as S,f as C,g as P,h as v,i as E,F as R,j as M,_ as L,k as A,L as F}from"./three.HaMTRCf61740450466561.js";function U(e){let t;try{t=new URL(e,"http://fakehost.com/")}catch(r){return null}const s=t.pathname.split("/").pop(),n=s.lastIndexOf(".");if(-1===n||n===s.length-1)return null;return s.substring(n+1)}class k{get unloadPriorityCallback(){return this._unloadPriorityCallback}set unloadPriorityCallback(e){1===e.length?(console.warn('LRUCache: "unloadPriorityCallback" function has been changed to take two arguments.'),this._unloadPriorityCallback=(t,s)=>{const n=e(t),r=e(s);return n<r?-1:n>r?1:0}):this._unloadPriorityCallback=e}constructor(){this.minSize=6e3,this.maxSize=8e3,this.minBytesSize=322122547.2,this.maxBytesSize=429496729.6,this.unloadPercent=.05,this.autoMarkUnused=!0,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadingHandle=-1,this.cachedBytes=0,this.bytesMap=new Map,this.loadedSet=new Set,this._unloadPriorityCallback=null,this.computeMemoryUsageCallback=()=>null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize||this.cachedBytes>=this.maxBytesSize}getMemoryUsage(e){var t;return null!=(t=this.bytesMap.get(e))?t:null}add(e,t){const s=this.itemSet;if(s.has(e))return!1;if(this.isFull())return!1;const n=this.usedSet,r=this.itemList,i=this.callbacks,a=this.bytesMap;r.push(e),n.add(e),s.set(e,Date.now()),i.set(e,t);const o=this.computeMemoryUsageCallback(e);return this.cachedBytes+=o||0,a.set(e,o),!0}has(e){return this.itemSet.has(e)}remove(e){const t=this.usedSet,s=this.itemSet,n=this.itemList,r=this.bytesMap,i=this.callbacks,a=this.loadedSet;if(s.has(e)){this.cachedBytes-=r.get(e)||0,r.delete(e),i.get(e)(e);const o=n.indexOf(e);return n.splice(o,1),t.delete(e),s.delete(e),i.delete(e),a.delete(e),!0}return!1}setLoaded(e,t){const{itemSet:s,loadedSet:n}=this;s.has(e)&&(!0===t?n.add(e):n.delete(e))}updateMemoryUsage(e){const t=this.itemSet,s=this.bytesMap;if(!t.has(e))return;this.cachedBytes-=s.get(e)||0;const n=this.computeMemoryUsageCallback(e);s.set(e,n),this.cachedBytes+=n}markUsed(e){const t=this.itemSet,s=this.usedSet;t.has(e)&&!s.has(e)&&(t.set(e,Date.now()),s.add(e))}markUnused(e){this.usedSet.delete(e)}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const{unloadPercent:e,minSize:t,maxSize:s,itemList:n,itemSet:r,usedSet:i,loadedSet:a,callbacks:o,bytesMap:l,minBytesSize:c,maxBytesSize:h}=this,u=n.length-i.size,d=n.length-a.size,p=Math.max(Math.min(n.length-t,u),0),m=this.cachedBytes-c,g=this.unloadPriorityCallback||this.defaultPriorityCallback;let f=!1;const _=p>0&&u>0||d&&n.length>s;if(u&&this.cachedBytes>c||d&&this.cachedBytes>h||_){n.sort(((e,t)=>{const s=i.has(e);if(s===i.has(t)){const s=a.has(e);return s===a.has(t)?-g(e,t):s?1:-1}return s?1:-1}));const d=Math.max(t*e,p*e),_=Math.ceil(Math.min(d,u,p)),b=Math.max(e*m,e*c),y=Math.min(b,m);let w=0,T=0;for(;this.cachedBytes-T>h||n.length-w>s;){const e=n[w],t=l.get(e)||0;if(i.has(e)&&a.has(e)||this.cachedBytes-T-t<h&&n.length-w<=s)break;T+=t,w++}for(;T<y||w<_;){const e=n[w],t=l.get(e)||0;if(i.has(e)||this.cachedBytes-T-t<c&&w>=_)break;T+=t,w++}n.splice(0,w).forEach((e=>{this.cachedBytes-=l.get(e)||0,o.get(e)(e),l.delete(e),r.delete(e),o.delete(e),a.delete(e),i.delete(e)})),f=w<p||T<m&&w<u,f=f&&w>0}f&&(this.unloadingHandle=requestAnimationFrame((()=>this.scheduleUnload())))}scheduleUnload(){cancelAnimationFrame(this.unloadingHandle),this.scheduled||(this.scheduled=!0,queueMicrotask((()=>{this.scheduled=!1,this.unloadUnusedContent()})))}}class D{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise(((s,n)=>{const r=this.items,i=this.callbacks;r.push(e),i.set(e,((...e)=>t(...e).then(s).catch(n))),this.autoUpdate&&this.scheduleJobRun()}))}remove(e){const t=this.items,s=this.callbacks,n=t.indexOf(e);-1!==n&&(t.splice(n,1),s.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,s=this.maxJobs;let n=this.currJobs;for(;s>n&&e.length>0;){n++;const s=e.pop(),r=t.get(s);t.delete(s),r(s).then((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})).catch((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}))}this.currJobs=n}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const O=-1,I=0,N=3,B=6378137;function V(e){return e===N||e===O}function z(e,t){return e.__lastFrameVisited===t&&e.__used}function j(e,t){e.__lastFrameVisited!==t.frameCount&&(e.__lastFrameVisited=t.frameCount,e.__used=!1,e.__inFrustum=!1,e.__isLeaf=!1,e.__visible=!1,e.__active=!1,e.__error=1/0,e.__distanceFromCamera=1/0,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__inFrustum=t.tileInView(e),t.calculateError(e))}function W(e,t){if(t.ensureChildrenArePreprocessed(e),j(e,t),G(e,t),!e.__hasRenderableContent){const s=e.children;for(let e=0,n=s.length;e<n;e++)W(s[e],t)}}function q(e,t){if(t.ensureChildrenArePreprocessed(e),z(e,t.frameCount)){e.__hasContent&&e.__loadingState===I&&!t.lruCache.isFull()&&t.queueTileForDownload(e);const s=e.children;for(let e=0,n=s.length;e<n;e++)q(s[e],t)}}function G(e,t){e.__used||(e.__used=!0,t.markTileUsed(e),t.stats.used++,!0===e.__inFrustum&&t.stats.inFrustum++)}function H(e,t){if(t.ensureChildrenArePreprocessed(e),j(e,t),!e.__inFrustum)return;if(!function(e,t){return!(e.__error<=t.errorTarget||t.maxDepth>0&&e.__depth+1>=t.maxDepth)}(e,t))return void G(e,t);let s=!1,n=!1;const r=e.children;for(let i=0,a=r.length;i<a;i++){const e=r[i];H(e,t),s=s||z(e,t.frameCount),n=n||e.__inFrustum}if("REPLACE"!==e.refine||n||0===r.length||e.__hasUnrenderableContent){if(G(e,t),s&&"REPLACE"===e.refine)for(let i=0,a=r.length;i<a;i++){W(r[i],t)}}else e.__inFrustum=!1}function J(e,t){const s=t.frameCount;if(!z(e,s))return;const n=e.children;let r=!1;for(let i=0,a=n.length;i<a;i++){const e=n[i];r=r||z(e,s)}if(r){let r=!1,i=!0;for(let e=0,a=n.length;e<a;e++){const a=n[e];if(J(a,t),r=r||a.__wasSetVisible||a.__childrenWereVisible,z(a,s)){const e=a.__allChildrenLoaded||a.__hasRenderableContent&&V(a.__loadingState)||!a.__hasContent&&0===a.children.length||a.__hasUnrenderableContent&&a.__loadingState===O;i=i&&e}}e.__childrenWereVisible=r,e.__allChildrenLoaded=i}else e.__isLeaf=!0}function Y(e,t){const s=t.stats;if(!z(e,t.frameCount))return;const n=t.lruCache;if(e.__isLeaf)return void(e.__loadingState===N?(e.__inFrustum&&(e.__visible=!0,s.visible++),e.__active=!0,s.active++):!n.isFull()&&e.__hasContent&&t.queueTileForDownload(e));const r=e.children,i=e.__hasContent,a=V(e.__loadingState)&&i,o=(t.errorTarget+1)*t.errorThreshold,l=e.__error<=o,c=e.__childrenWereVisible,h=e.__allChildrenLoaded;if((l||"ADD"===e.refine)&&!a&&!n.isFull()&&i&&t.queueTileForDownload(e),(l&&!h&&!c&&a||"ADD"===e.refine&&a)&&(e.__inFrustum&&(e.__visible=!0,s.visible++),e.__active=!0,s.active++),"REPLACE"===e.refine&&l&&!h)for(let u=0,d=r.length;u<d;u++){const e=r[u];z(e,t.frameCount)&&q(e,t)}else for(let u=0,d=r.length;u<d;u++)Y(r[u],t)}function Q(e,t){const s=z(e,t.frameCount);if(s||e.__usedLastFrame){let n=!1,r=!1;s?(n=e.__active,r=t.displayActiveTiles&&e.__active||e.__visible):j(e,t),e.__hasRenderableContent&&e.__loadingState===N&&(e.__wasSetActive!==n&&t.setTileActive(e,n),e.__wasSetVisible!==r&&t.invokeOnePlugin((t=>t.setTileVisible&&t.setTileVisible(e,r)))),e.__wasSetActive=n,e.__wasSetVisible=r,e.__usedLastFrame=s;const i=e.children;for(let e=0,s=i.length;e<s;e++){Q(i[e],t)}}}const Z=Symbol("PLUGIN_REGISTERED"),X=(e,t)=>e.__depthFromRenderedParent!==t.__depthFromRenderedParent?e.__depthFromRenderedParent>t.__depthFromRenderedParent?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0,$=(e,t)=>e.__depthFromRenderedParent!==t.__depthFromRenderedParent?e.__depthFromRenderedParent>t.__depthFromRenderedParent?1:-1:e.__loadingState!==t.__loadingState?e.__loadingState>t.__loadingState?-1:1:e.__lastFrameVisited!==t.__lastFrameVisited?e.__lastFrameVisited>t.__lastFrameVisited?-1:1:e.__hasUnrenderableContent!==t.__hasUnrenderableContent?e.__hasUnrenderableContent?-1:1:e.__error!==t.__error?e.__error>t.__error?-1:1:0;class K{get root(){const e=this.rootTileSet;return e?e.root:null}get loadProgress(){const e=this.stats,t=e.downloading+e.parsing,s=e.inCacheSinceLoad;return 0===s?1:1-t/s}constructor(e=null){this.rootLoadingState=I,this.rootTileSet=null,this.rootURL=e,this.fetchOptions={},this.plugins=[],this.queuedTiles=[],this.cachedSinceLoadComplete=new Set;const t=new k;t.unloadPriorityCallback=$;const s=new D;s.maxJobs=10,s.priorityCallback=X;const n=new D;n.maxJobs=1,n.priorityCallback=X,this.visibleTiles=new Set,this.activeTiles=new Set,this.usedSet=new Set,this.lruCache=t,this.downloadQueue=s,this.parseQueue=n,this.stats={inCacheSinceLoad:0,inCache:0,parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this.errorThreshold=1/0,this.displayActiveTiles=!1,this.maxDepth=1/0}registerPlugin(e){if(!0===e[Z])throw new Error("TilesRendererBase: A plugin can only be registered to a single tile set");const t=this.plugins,s=e.priority||0;let n=0;for(let r=0;r<t.length;r++){n=r;if((t[r].priority||0)>s)break}t.splice(n,0,e),e[Z]=!0,e.init&&e.init(this)}unregisterPlugin(e){const t=this.plugins;if("string"==typeof e&&(e=this.getPluginByName(name)),t.includes(e)){const s=t.indexOf(e);return t.splice(s,1),e.dispose&&e.dispose(),!0}return!1}getPluginByName(e){return this.plugins.find((t=>t.name===e))||null}traverse(e,t){this.root&&function(e,t=null,s=null){const n=[];for(n.push(e),n.push(null),n.push(0);n.length>0;){const e=n.pop(),r=n.pop(),i=n.pop();if(t&&t(i,r,e))return void(s&&s(i,r,e));const a=i.children;if(a)for(let t=a.length-1;t>=0;t--)n.push(a[t]),n.push(i),n.push(e+1);s&&s(i,r,e)}}(this.root,((t,...s)=>(this.ensureChildrenArePreprocessed(t),!!e&&e(t,...s))),t)}queueTileForDownload(e){e.__loadingState===I&&this.queuedTiles.push(e)}markTileUsed(e){this.usedSet.add(e),this.lruCache.markUsed(e)}update(){const{lruCache:e,usedSet:t,stats:s,root:n}=this;if(this.rootLoadingState===I&&(this.rootLoadingState=1,this.invokeOnePlugin((e=>e.loadRootTileSet&&e.loadRootTileSet())).then((()=>this.rootLoadingState=N)).catch((e=>{this.rootLoadingState=O,console.error(e)}))),!n)return;s.inFrustum=0,s.used=0,s.active=0,s.visible=0,this.frameCount++,t.forEach((t=>e.markUnused(t))),t.clear(),H(n,this),J(n,this),Y(n,this),Q(n,this);const r=this.queuedTiles;r.sort(e.unloadPriorityCallback);for(let i=0,a=r.length;i<a&&!e.isFull();i++)this.requestTileContents(r[i]);r.length=0,e.scheduleUnload()}resetFailedTiles(){this.rootLoadingState===O&&(this.rootLoadingState=I);const e=this.stats;0!==e.failed&&(this.traverse((e=>{e.__loadingState===O&&(e.__loadingState=I)})),e.failed=0)}dispose(){this.invokeAllPlugins((e=>{e!==this&&e.dispose&&e.dispose()}));const e=this.lruCache,t=[];this.traverse((e=>(t.push(e),!1)));for(let s=0,n=t.length;s<n;s++)e.remove(t[s]);this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}dispatchEvent(e){}fetchData(e,t){return fetch(e,t)}parseTile(e,t,s){return null}disposeTile(e){e.__visible&&(this.invokeOnePlugin((t=>t.setTileVisible&&t.setTileVisible(e,!1))),e.__visible=!1),e.__active&&(this.setTileActive(e,!1),e.__active=!1)}preprocessNode(e,t,s=null){var n;if(e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=s,e.children=e.children||[],null==(n=e.content)?void 0:n.uri){const t=U(e.content.uri);e.__hasContent=!0,e.__hasUnrenderableContent=Boolean(t&&/json$/.test(t)),e.__hasRenderableContent=!e.__hasUnrenderableContent}else e.__hasContent=!1,e.__hasUnrenderableContent=!1,e.__hasRenderableContent=!1;e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=I,null===s?(e.__depth=0,e.__depthFromRenderedParent=e.__hasRenderableContent?1:0,e.refine=e.refine||"REPLACE"):(e.__depth=s.__depth+1,e.__depthFromRenderedParent=s.__depthFromRenderedParent+(e.__hasRenderableContent?1:0),e.refine=e.refine||s.refine),e.__basePath=t,e.__lastFrameVisited=-1,this.invokeAllPlugins((n=>{n!==this&&n.preprocessNode&&n.preprocessNode(e,t,s)}))}setTileActive(e,t){t?this.activeTiles.add(e):this.activeTiles.delete(e)}setTileVisible(e,t){t?this.visibleTiles.add(e):this.visibleTiles.delete(e)}calculateError(e){return 0}tileInView(e){return!0}ensureChildrenArePreprocessed(e){const t=e.children;for(let s=0,n=t.length;s<n;s++){const n=t[s];if("__depth"in n)break;this.preprocessNode(n,e.__basePath,e)}}preprocessTileSet(e,t,s=null){const n=e.asset.version,[r,i]=n.split(".").map((e=>parseInt(e)));console.assert(r<=1,"TilesRenderer: asset.version is expected to be a 1.x or a compatible version."),1===r&&i>0&&console.warn("TilesRenderer: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let a=t.replace(/\/[^/]*\/?$/,"");a=new URL(a,window.location.href).toString(),this.preprocessNode(e.root,a,s)}loadRootTileSet(){let e=this.rootURL;this.invokeAllPlugins((t=>e=t.preprocessURL?t.preprocessURL(e,null):e));const t=this.invokeOnePlugin((t=>t.fetchData&&t.fetchData(e,this.fetchOptions))).then((t=>{if(t.ok)return t.json();throw new Error('TilesRenderer: Failed to load tileset "'.concat(e,'" with status ').concat(t.status," : ").concat(t.statusText))})).then((t=>{this.preprocessTileSet(t,e),this.rootTileSet=t}));return t.catch((t=>{console.error(t),this.rootTileSet=null,this.dispatchEvent({type:"load-error",tile:null,error:t,uri:e})})),t}requestTileContents(e){if(e.__loadingState!==I)return;let o=!1,l=new URL(e.content.uri,e.__basePath+"/").toString();this.invokeAllPlugins((t=>l=t.preprocessURL?t.preprocessURL(l,e):l));const c=this.stats,h=this.lruCache,u=this.downloadQueue,d=this.parseQueue,p=U(l),m=new AbortController,g=m.signal;return h.add(e,(t=>{m.abort(),o?t.children.length=0:this.invokeAllPlugins((e=>{e.disposeTile&&e.disposeTile(t)})),c.inCache--,this.cachedSinceLoadComplete.has(e)&&(this.cachedSinceLoadComplete.delete(e),c.inCacheSinceLoad--),1===t.__loadingState?c.downloading--:2===t.__loadingState&&c.parsing--,t.__loadingState=I,d.remove(t),u.remove(t)}))?(0===c.parsing&&0===c.downloading&&this.dispatchEvent({type:"tiles-load-start"}),this.cachedSinceLoadComplete.add(e),c.inCacheSinceLoad++,c.inCache++,c.downloading++,e.__loadingState=1,u.add(e,(e=>g.aborted?Promise.resolve():this.invokeOnePlugin((e=>{return e.fetchData&&e.fetchData(l,(o=((e,t)=>{for(var s in t||(t={}))r.call(t,s)&&a(e,s,t[s]);if(n)for(var s of n(t))i.call(t,s)&&a(e,s,t[s]);return e})({},this.fetchOptions),t(o,s({signal:g}))));var o})))).then((e=>{if(!g.aborted){if(e.ok)return"json"===p?e.json():e.arrayBuffer();throw new Error("Failed to load model with error code ".concat(e.status))}})).then((t=>{if(!g.aborted)return c.downloading--,c.parsing++,e.__loadingState=2,d.add(e,(s=>g.aborted?Promise.resolve():"json"===p&&t.root?(this.preprocessTileSet(t,l,e),e.children.push(t.root),o=!0,Promise.resolve()):this.invokeOnePlugin((e=>e.parseTile&&e.parseTile(t,s,p,l,g)))))})).then((()=>{g.aborted||(c.parsing--,e.__loadingState=N,h.setLoaded(e,!0),null===h.getMemoryUsage(e)&&(h.isFull()&&h.computeMemoryUsageCallback(e)>0?h.remove(e):h.updateMemoryUsage(e)),e.cached.scene&&this.dispatchEvent({type:"load-model",scene:e.cached.scene,tile:e}))})).catch((t=>{g.aborted||("AbortError"!==t.name?(d.remove(e),u.remove(e),2===e.__loadingState?c.parsing--:1===e.__loadingState&&c.downloading--,c.failed++,console.error('TilesRenderer : Failed to load tile at url "'.concat(e.content.uri,'".')),console.error(t),e.__loadingState=O,h.setLoaded(e,!0),this.dispatchEvent({type:"load-error",tile:e,error:t,uri:l})):h.remove(e))})).finally((()=>{0===c.parsing&&0===c.downloading&&(this.cachedSinceLoadComplete.clear(),c.inCacheSinceLoad=0,this.dispatchEvent({type:"tiles-load-end"}))}))):void 0}getAttributions(e=[]){return this.invokeAllPlugins((t=>t!==this&&t.getAttributions&&t.getAttributions(e))),e}invokeOnePlugin(e){const t=[...this.plugins,this];for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}invokeAllPlugins(e){const t=[...this.plugins,this],s=[];for(let n=0;n<t.length;n++){const r=e(t[n]);r&&s.push(r)}return 0===s.length?null:Promise.all(s)}}const ee=new TextDecoder;function te(e){return ee.decode(e)}function se(e,t,s,n,r,i){let a,o;switch(n){case"SCALAR":a=1;break;case"VEC2":a=2;break;case"VEC3":a=3;break;case"VEC4":a=4;break;default:throw new Error('FeatureTable : Feature type not provided for "'.concat(i,'".'))}const l=s*a;switch(r){case"BYTE":o=new Int8Array(e,t,l);break;case"UNSIGNED_BYTE":o=new Uint8Array(e,t,l);break;case"SHORT":o=new Int16Array(e,t,l);break;case"UNSIGNED_SHORT":o=new Uint16Array(e,t,l);break;case"INT":o=new Int32Array(e,t,l);break;case"UNSIGNED_INT":o=new Uint32Array(e,t,l);break;case"FLOAT":o=new Float32Array(e,t,l);break;case"DOUBLE":o=new Float64Array(e,t,l);break;default:throw new Error('FeatureTable : Feature component type not provided for "'.concat(i,'".'))}return o}class ne{constructor(e,t,s,n){this.buffer=e,this.binOffset=t+s,this.binLength=n;let r=null;if(0!==s){const n=new Uint8Array(e,t,s);r=JSON.parse(te(n))}else r={};this.header=r}getKeys(){return Object.keys(this.header)}getData(e,t,s=null,n=null){const r=this.header;if(!(e in r))return null;const i=r[e];if(i instanceof Object){if(Array.isArray(i))return i;{const{buffer:r,binOffset:a,binLength:o}=this,l=i.byteOffset||0,c=i.type||n,h=i.componentType||s;if("type"in i&&n&&i.type!==n)throw new Error("FeatureTable: Specified type does not match expected type.");const u=a+l,d=se(r,u,t,c,h,e);if(u+d.byteLength>a+o)throw new Error("FeatureTable: Feature data read outside binary body length.");return d}}return i}getBuffer(e,t){const{buffer:s,binOffset:n}=this;return s.slice(n+e,n+e+t)}}class re{constructor(e){var t;this.batchTable=e;const s=e.header.extensions["3DTILES_batch_table_hierarchy"];this.classes=s.classes;for(const r of this.classes){const e=r.instances;for(const t in e)r.instances[t]=this._parseProperty(e[t],r.length,t)}if(this.instancesLength=s.instancesLength,this.classIds=this._parseProperty(s.classIds,this.instancesLength,"classIds"),s.parentCounts?this.parentCounts=this._parseProperty(s.parentCounts,this.instancesLength,"parentCounts"):this.parentCounts=new Array(this.instancesLength).fill(1),s.parentIds){const e=this.parentCounts.reduce(((e,t)=>e+t),0);this.parentIds=this._parseProperty(s.parentIds,e,"parentIds")}else this.parentIds=null;this.instancesIds=[];const n={};for(const r of this.classIds)n[r]=null!=(t=n[r])?t:0,this.instancesIds.push(n[r]),n[r]++}_parseProperty(e,t,s){if(Array.isArray(e))return e;{const{buffer:n,binOffset:r}=this.batchTable;return se(n,r+e.byteOffset,t,"SCALAR",e.componentType||"UNSIGNED_SHORT",s)}}getDataFromId(e,t={}){const s=this.parentCounts[e];if(this.parentIds&&s>0){let n=0;for(let t=0;t<e;t++)n+=this.parentCounts[t];for(let r=0;r<s;r++){const s=this.parentIds[n+r];s!==e&&this.getDataFromId(s,t)}}const n=this.classIds[e],r=this.classes[n].instances,i=this.classes[n].name,a=this.instancesIds[e];for(const o in r)t[i]=t[i]||{},t[i][o]=r[o][a];return t}}class ie extends ne{get batchSize(){return console.warn("BatchTable.batchSize has been deprecated and replaced with BatchTable.count."),this.count}constructor(e,t,s,n,r){super(e,s,n,r),this.count=t,this.extensions={};const i=this.header.extensions;i&&i["3DTILES_batch_table_hierarchy"]&&(this.extensions["3DTILES_batch_table_hierarchy"]=new re(this))}getData(e,t=null,s=null){return console.warn("BatchTable: BatchTable.getData is deprecated. Use BatchTable.getDataFromId to get allproperties for an id or BatchTable.getPropertyArray for getting an array of value for a property."),super.getData(e,this.count,t,s)}getDataFromId(e,t={}){if(e<0||e>=this.count)throw new Error('BatchTable: id value "'.concat(e,'" out of bounds for "').concat(this.count,'" features number.'));for(const s of this.getKeys())"extensions"!==s&&(t[s]=super.getData(s,this.count)[e]);for(const s in this.extensions){const n=this.extensions[s];n.getDataFromId instanceof Function&&(t[s]=t[s]||{},n.getDataFromId(e,t[s]))}return t}getPropertyArray(e){return super.getData(e,this.count)}}class ae{constructor(){this.fetchOptions={},this.workingPath=""}load(e){return console.warn('Loader: "load" function has been deprecated in favor of "loadAsync".'),this.loadAsync(e)}loadAsync(e){return fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error('Failed to load file "'.concat(e,'" with status ').concat(t.status," : ").concat(t.statusText));return t.arrayBuffer()})).then((t=>(""===this.workingPath&&(this.workingPath=this.workingPathForURL(e)),this.parse(t))))}resolveExternalURL(e){return/^[^\\/]/.test(e)&&!/^http/.test(e)?this.workingPath+"/"+e:e}workingPathForURL(e){const t=e.split(/[\\/]/g);t.pop();return t.join("/")+"/"}parse(e){throw new Error("LoaderBase: Parse not implemented.")}}function oe(e){let t;if(t=e instanceof DataView?e:new DataView(e),"{"===String.fromCharCode(t.getUint8(0)))return null;let s="";for(let n=0;n<4;n++)s+=String.fromCharCode(t.getUint8(n));return s}class le extends ae{parse(e){const t=new DataView(e),s=oe(t);console.assert("b3dm"===s);const n=t.getUint32(4,!0);console.assert(1===n);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),a=t.getUint32(16,!0),o=t.getUint32(20,!0),l=t.getUint32(24,!0),c=e.slice(28,28+i+a),h=new ne(c,0,i,a),u=28+i+a,d=e.slice(u,u+o+l),p=new ie(d,h.getData("BATCH_LENGTH"),0,o,l),m=u+o+l;return{version:n,featureTable:h,batchTable:p,glbBytes:new Uint8Array(e,m,r-m)}}}class ce extends le{constructor(e=l){super(),this.manager=e,this.adjustmentTransform=new o}parse(e){const t=super.parse(e),s=t.glbBytes.slice().buffer;return new Promise(((e,n)=>{const r=this.manager,i=this.fetchOptions,a=r.getHandler("path.gltf")||new c(r);"include"===i.credentials&&"cors"===i.mode&&a.setCrossOrigin("use-credentials"),"credentials"in i&&a.setWithCredentials("include"===i.credentials),i.headers&&a.setRequestHeader(i.headers);let o=this.workingPath;!/[\\/]$/.test(o)&&o.length&&(o+="/");const l=this.adjustmentTransform;a.parse(s,o,(s=>{const{batchTable:n,featureTable:r}=t,{scene:i}=s,a=r.getData("RTC_CENTER");a&&(i.position.x+=a[0],i.position.y+=a[1],i.position.z+=a[2]),s.scene.updateMatrix(),s.scene.matrix.multiply(l),s.scene.matrix.decompose(s.scene.position,s.scene.quaternion,s.scene.scale),s.batchTable=n,s.featureTable=r,i.batchTable=n,i.featureTable=r,e(s)}),n)}))}}class he extends ae{parse(e){const t=new DataView(e),s=oe(t);console.assert("pnts"===s);const n=t.getUint32(4,!0);console.assert(1===n);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),a=t.getUint32(16,!0),o=t.getUint32(20,!0),l=t.getUint32(24,!0),c=e.slice(28,28+i+a),h=new ne(c,0,i,a),u=28+i+a,d=e.slice(u,u+o+l),p=new ie(d,h.getData("BATCH_LENGTH")||h.getData("POINTS_LENGTH"),0,o,l);return Promise.resolve({version:n,featureTable:h,batchTable:p})}}function ue(e){const t=e>>11,s=e>>5&63,n=31&e;return[Math.round(t/31*255),Math.round(s/63*255),Math.round(n/31*255)]}const de=new h;function pe(e,t,s=new d){de.set(e,t).divideScalar(256).multiplyScalar(2).subScalar(1),s.set(de.x,de.y,1-Math.abs(de.x)-Math.abs(de.y));const n=u.clamp(-s.z,0,1);return s.x>=0?s.setX(s.x-n):s.setX(s.x+n),s.y>=0?s.setY(s.y-n):s.setY(s.y+n),s.normalize(),s}const me={RGB:"color",POSITION:"position"};class ge extends he{constructor(e=l){super(),this.manager=e}parse(e){return super.parse(e).then((async e=>{const{featureTable:t,batchTable:s}=e,n=new p,r=t.header.extensions,i=new d;let a;if(r&&r["3DTILES_draco_point_compression"]){const{byteOffset:e,byteLength:s,properties:i}=r["3DTILES_draco_point_compression"],o=this.manager.getHandler("draco.drc");if(null==o)throw new Error("PNTSLoader: dracoLoader not available.");const l={};for(const t in i)if(t in me&&t in i){l[me[t]]=i[t]}const c={attributeIDs:l,attributeTypes:{position:"Float32Array",color:"Uint8Array"},useUniqueIDs:!0},h=t.getBuffer(e,s);a=await o.decodeGeometry(h,c),a.attributes.color&&(n.vertexColors=!0)}else{const e=t.getData("POINTS_LENGTH"),s=t.getData("POSITION",e,"FLOAT","VEC3"),r=t.getData("NORMAL",e,"FLOAT","VEC3"),o=t.getData("NORMAL",e,"UNSIGNED_BYTE","VEC2"),l=t.getData("RGB",e,"UNSIGNED_BYTE","VEC3"),c=t.getData("RGBA",e,"UNSIGNED_BYTE","VEC4"),h=t.getData("RGB565",e,"UNSIGNED_SHORT","SCALAR"),u=t.getData("CONSTANT_RGBA",e,"UNSIGNED_BYTE","VEC4"),p=t.getData("POSITION_QUANTIZED",e,"UNSIGNED_SHORT","VEC3"),_=t.getData("QUANTIZED_VOLUME_SCALE",e,"FLOAT","VEC3"),b=t.getData("QUANTIZED_VOLUME_OFFSET",e,"FLOAT","VEC3");if(a=new m,p){const t=new Float32Array(3*e);for(let s=0;s<e;s++)for(let e=0;e<3;e++){const n=3*s+e;t[n]=p[n]/65535*_[e]}i.x=b[0],i.y=b[1],i.z=b[2],a.setAttribute("position",new g(t,3,!1))}else a.setAttribute("position",new g(s,3,!1));if(null!==r)a.setAttribute("normal",new g(r,3,!1));else if(null!==o){const t=new Float32Array(3*e),s=new d;for(let n=0;n<e;n++){const e=pe(o[2*n],o[2*n+1],s);t[3*n]=e.x,t[3*n+1]=e.y,t[3*n+2]=e.z}a.setAttribute("normal",new g(t,3,!1))}if(null!==c)a.setAttribute("color",new g(c,4,!0)),n.vertexColors=!0,n.transparent=!0,n.depthWrite=!1;else if(null!==l)a.setAttribute("color",new g(l,3,!0)),n.vertexColors=!0;else if(null!==h){const t=new Uint8Array(3*e);for(let s=0;s<e;s++){const e=ue(h[s]);for(let n=0;n<3;n++){t[3*s+n]=e[n]}}a.setAttribute("color",new g(t,3,!0)),n.vertexColors=!0}else if(null!==u){const e=new f(u[0],u[1],u[2]);n.color=e;const t=u[3]/255;t<1&&(n.opacity=t,n.transparent=!0,n.depthWrite=!1)}}const o=new _(a,n);o.position.copy(i),e.scene=o,e.scene.featureTable=t,e.scene.batchTable=s;const l=t.getData("RTC_CENTER");return l&&(e.scene.position.x+=l[0],e.scene.position.y+=l[1],e.scene.position.z+=l[2]),e}))}}class fe extends ae{parse(e){const t=new DataView(e),s=oe(t);console.assert("i3dm"===s);const n=t.getUint32(4,!0);console.assert(1===n);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),a=t.getUint32(16,!0),o=t.getUint32(20,!0),l=t.getUint32(24,!0),c=t.getUint32(28,!0),h=e.slice(32,32+i+a),u=new ne(h,0,i,a),d=32+i+a,p=e.slice(d,d+o+l),m=new ie(p,u.getData("INSTANCES_LENGTH"),0,o,l),g=d+o+l,f=new Uint8Array(e,g,r-g);let _=null,b=null,y=null;if(c)_=f,b=Promise.resolve();else{const e=this.resolveExternalURL(te(f)),t=e.split(/[\\/]/g);t.pop(),y=t.join("/"),b=fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error('I3DMLoaderBase : Failed to load file "'.concat(e,'" with status ').concat(t.status," : ").concat(t.statusText));return t.arrayBuffer()})).then((e=>{_=new Uint8Array(e)}))}return b.then((()=>({version:n,featureTable:u,batchTable:m,glbBytes:_,gltfWorkingPath:y})))}}new b,new d;const _e=new b,be=new d,ye=new d,we=new d,Te=new o,xe=new o,Se=new y,Ce=new w,Pe=new d,ve=new d,Ee=new d,Re=new d,Me=new T;class Le{constructor(e=1,t=1,s=1){this.name="",this.radius=new d(e,t,s)}intersectRay(e,t){return Te.makeScale(...this.radius).invert(),Se.center.set(0,0,0),Se.radius=1,Me.copy(e).applyMatrix4(Te),Me.intersectSphere(Se,t)?(Te.makeScale(...this.radius),t.applyMatrix4(Te),t):null}getEastNorthUpFrame(e,t,s){return this.getEastNorthUpAxes(e,t,Pe,ve,Ee,Re),s.makeBasis(Pe,ve,Ee).setPosition(Re)}getEastNorthUpAxes(e,t,s,n,r,i=Re){this.getCartographicToPosition(e,t,0,i),this.getCartographicToNormal(e,t,r),s.set(-i.y,i.x,0).normalize(),n.crossVectors(r,s).normalize()}getAzElRollFromRotationMatrix(e,t,s,n,r=0){return 1===r?(Ce.set(-Math.PI/2,0,0,"XYZ"),xe.makeRotationFromEuler(Ce).premultiply(s)):2===r?(Ce.set(-Math.PI/2,0,Math.PI,"XYZ"),xe.makeRotationFromEuler(Ce).premultiply(s)):xe.copy(s),this.getEastNorthUpFrame(e,t,Te).invert(),xe.premultiply(Te),Ce.setFromRotationMatrix(xe,"ZXY"),n.azimuth=-Ce.z,n.elevation=Ce.x,n.roll=Ce.y,n}getRotationMatrixFromAzElRoll(e,t,s,n,r,i,a=0){return this.getEastNorthUpFrame(e,t,Te),Ce.set(n,r,-s,"ZXY"),i.makeRotationFromEuler(Ce).premultiply(Te).setPosition(0,0,0),1===a?(Ce.set(Math.PI/2,0,0,"XYZ"),xe.makeRotationFromEuler(Ce),i.multiply(xe)):2===a&&(Ce.set(-Math.PI/2,0,Math.PI,"XYZ"),xe.makeRotationFromEuler(Ce),i.multiply(xe)),i}getFrame(e,t,s,n,r,i,a,o=0){return this.getRotationMatrixFromAzElRoll(e,t,s,n,r,a,o),this.getCartographicToPosition(e,t,i,Re),a.setPosition(Re),a}getCartographicToPosition(e,t,s,n){this.getCartographicToNormal(e,t,be);const r=this.radius;ye.copy(be),ye.x*=r.x**2,ye.y*=r.y**2,ye.z*=r.z**2;const i=Math.sqrt(be.dot(ye));return ye.divideScalar(i),n.copy(ye).addScaledVector(be,s)}getPositionToCartographic(e,t){this.getPositionToSurfacePoint(e,ye),this.getPositionToNormal(e,be);const s=we.subVectors(e,ye);return t.lon=Math.atan2(be.y,be.x),t.lat=Math.asin(be.z),t.height=Math.sign(s.dot(e))*s.length(),t}getCartographicToNormal(e,t,s){return _e.set(1,-e+Math.PI/2,t),s.setFromSpherical(_e).normalize(),function(e){const{x:t,y:s,z:n}=e;e.x=n,e.y=t,e.z=s}(s),s}getPositionToNormal(e,t){const s=this.radius;return t.copy(e),t.x/=s.x**2,t.y/=s.y**2,t.z/=s.z**2,t.normalize(),t}getPositionToSurfacePoint(e,t){const s=this.radius,n=1/s.x**2,r=1/s.y**2,i=1/s.z**2,a=e.x*e.x*n,o=e.y*e.y*r,l=e.z*e.z*i,c=a+o+l,h=Math.sqrt(1/c),u=ye.copy(e).multiplyScalar(h);if(c<.1)return isFinite(h)?t.copy(u):null;const d=we.set(u.x*n*2,u.y*r*2,u.z*i*2);let p,m,g,f,_,b,y,w,T,x,S,C=(1-h)*e.length()/(.5*d.length()),P=0;do{C-=P,g=1/(1+C*n),f=1/(1+C*r),_=1/(1+C*i),b=g*g,y=f*f,w=_*_,T=b*g,x=y*f,S=w*_,p=a*b+o*y+l*w-1,m=a*T*n+o*x*r+l*S*i;P=p/(-2*m)}while(Math.abs(p)>1e-12);return t.set(e.x*g,e.y*f,e.z*_)}calculateHorizonDistance(e,t){const s=this.calculateEffectiveRadius(e);return Math.sqrt(2*s*t+t**2)}calculateEffectiveRadius(e){const t=this.radius.x,s=1-this.radius.z**2/t**2,n=e*u.DEG2RAD,r=Math.sin(n)**2;return t/Math.sqrt(1-s*r)}getPositionElevation(e){this.getPositionToSurfacePoint(e,ye);const t=we.subVectors(e,ye);return Math.sign(t.dot(e))*t.length()}copy(e){return this.radius.copy(e.radius),this}clone(){return(new this.constructor).copy(this)}}const Ae=new Le(B,B,6356752.314245179);Ae.name="WGS84 Earth";const Fe=new d,Ue=new d,ke=new d,De=new d,Oe=new S,Ie=new d,Ne=new o,Be=new o,Ve=new d,ze=new o,je=new S,We={};class qe extends fe{constructor(e=l){super(),this.manager=e,this.adjustmentTransform=new o,this.ellipsoid=Ae.clone()}resolveExternalURL(e){return this.manager.resolveURL(super.resolveExternalURL(e))}parse(e){return super.parse(e).then((e=>{const{featureTable:t,batchTable:s}=e,n=e.glbBytes.slice().buffer;return new Promise(((r,i)=>{var a;const o=this.fetchOptions,l=this.manager,h=l.getHandler("path.gltf")||new c(l);"include"===o.credentials&&"cors"===o.mode&&h.setCrossOrigin("use-credentials"),"credentials"in o&&h.setWithCredentials("include"===o.credentials),o.headers&&h.setRequestHeader(o.headers);let u=null!=(a=e.gltfWorkingPath)?a:this.workingPath;/[\\/]$/.test(u)||(u+="/");const p=this.adjustmentTransform;h.parse(n,u,(e=>{const n=t.getData("INSTANCES_LENGTH"),i=t.getData("POSITION",n,"FLOAT","VEC3"),a=t.getData("NORMAL_UP",n,"FLOAT","VEC3"),o=t.getData("NORMAL_RIGHT",n,"FLOAT","VEC3"),l=t.getData("SCALE_NON_UNIFORM",n,"FLOAT","VEC3"),c=t.getData("SCALE",n,"FLOAT","SCALAR"),h=t.getData("RTC_CENTER"),u=t.getData("EAST_NORTH_UP");["QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach((e=>{e in t.header&&console.warn('I3DMLoader: Unsupported FeatureTable feature "'.concat(e,'" detected.'))}));const m=new d;for(let t=0;t<n;t++)m.x+=i[3*t+0]/n,m.y+=i[3*t+1]/n,m.z+=i[3*t+2]/n;const g=[],f=[];e.scene.updateMatrixWorld(),e.scene.traverse((e=>{if(e.isMesh){f.push(e);const{geometry:t,material:s}=e,r=new x(t,s,n);r.position.copy(m),h&&(r.position.x+=h[0],r.position.y+=h[1],r.position.z+=h[2]),g.push(r)}}));for(let t=0;t<n;t++){De.set(i[3*t+0]-m.x,i[3*t+1]-m.y,i[3*t+2]-m.z),Oe.identity(),a&&(Ue.set(a[3*t+0],a[3*t+1],a[3*t+2]),ke.set(o[3*t+0],o[3*t+1],o[3*t+2]),Fe.crossVectors(ke,Ue).normalize(),Ne.makeBasis(ke,Ue,Fe),Oe.setFromRotationMatrix(Ne)),Ie.set(1,1,1),l&&Ie.set(l[3*t+0],l[3*t+1],l[3*t+2]),c&&Ie.multiplyScalar(c[t]);for(let e=0,s=g.length;e<s;e++){const s=g[e];je.copy(Oe),u&&(s.updateMatrixWorld(),Ve.copy(De).applyMatrix4(s.matrixWorld),this.ellipsoid.getPositionToCartographic(Ve,We),this.ellipsoid.getEastNorthUpFrame(We.lat,We.lon,ze),je.setFromRotationMatrix(ze)),Ne.compose(De,je,Ie).multiply(p);const n=f[e];Be.multiplyMatrices(Ne,n.matrixWorld),s.setMatrixAt(t,Be)}}e.scene.clear(),e.scene.add(...g),e.batchTable=s,e.featureTable=t,e.scene.batchTable=s,e.scene.featureTable=t,r(e)}),i)}))}))}}class Ge extends ae{parse(e){const t=new DataView(e),s=oe(t);console.assert("cmpt"===s,'CMPTLoader: The magic bytes equal "cmpt".');const n=t.getUint32(4,!0);console.assert(1===n,'CMPTLoader: The version listed in the header is "1".');const r=t.getUint32(8,!0);console.assert(r===e.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const i=t.getUint32(12,!0),a=[];let o=16;for(let l=0;l<i;l++){const t=new DataView(e,o,12),s=oe(t),n=t.getUint32(4,!0),r=t.getUint32(8,!0),i=new Uint8Array(e,o,r);a.push({type:s,buffer:i,version:n}),o+=r}return{version:n,tiles:a}}}class He extends Ge{constructor(e=l){super(),this.manager=e,this.adjustmentTransform=new o,this.ellipsoid=Ae.clone()}parse(e){const t=super.parse(e),{manager:s,ellipsoid:n,adjustmentTransform:r}=this,i=[];for(const a in t.tiles){const{type:e,buffer:o}=t.tiles[a];switch(e){case"b3dm":{const e=o.slice(),t=new ce(s);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions,t.adjustmentTransform.copy(r);const n=t.parse(e.buffer);i.push(n);break}case"pnts":{const e=o.slice(),t=new ge(s);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const n=t.parse(e.buffer);i.push(n);break}case"i3dm":{const e=o.slice(),t=new qe(s);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions,t.ellipsoid.copy(n),t.adjustmentTransform.copy(r);const a=t.parse(e.buffer);i.push(a);break}}}return Promise.all(i).then((e=>{const t=new C;return e.forEach((e=>{t.add(e.scene)})),{tiles:e,scene:t}}))}}const Je=new o;class Ye extends C{constructor(e){super(),this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e}raycast(e,t){return!this.tilesRenderer.optimizeRaycast||(this.tilesRenderer.raycast(e,t),!1)}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){null===this.parent?Je.copy(this.matrix):Je.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const e=Je.elements,t=this.matrixWorld.elements;let s=!1;for(let n=0;n<16;n++){const r=e[n],i=t[n];if(Math.abs(r-i)>Number.EPSILON){s=!0;break}}if(s){this.matrixWorld.copy(Je);const e=this.children;for(let t=0,s=e.length;t<s;t++)e[t].updateMatrixWorld()}}}}const Qe=new o,Ze=new T,Xe=new d,$e=[];function Ke(e,t){return e.distance-t.distance}function et(e,t,s,n){const{scene:r}=e.cached;s.invokeOnePlugin((s=>s.raycastTile&&s.raycastTile(e,r,t,n)))||t.intersectObject(r,!0,n)}function tt(e,t,s,n=null){const{group:r,activeTiles:i}=e;e.ensureChildrenArePreprocessed(t),null===n&&(n=Ze,Qe.copy(r.matrixWorld).invert(),n.copy(s.ray).applyMatrix4(Qe));const a=[],o=t.children;for(let h=0,u=o.length;h<u;h++){const e=o[h];if(!e.__used)continue;null!==e.cached.boundingVolume.intersectRay(n,Xe)&&(Xe.applyMatrix4(r.matrixWorld),a.push({distance:Xe.distanceToSquared(s.ray.origin),tile:e}))}a.sort(Ke);let l=null,c=1/0;if(i.has(t)){const n=function(e,t,s){et(e,t,s,$e),$e.sort(Ke);const n=$e[0]||null;return $e.length=0,n}(t,s,e);n&&(l=n,c=n.distance*n.distance)}for(let h=0,u=a.length;h<u;h++){const t=a[h],r=t.distance,i=t.tile;if(r>c)break;const o=tt(e,i,s,n);if(o){const e=o.distance*o.distance;e<c&&(l=o,c=e)}}return l}function st(e,t,s,n,r=null){const{group:i,activeTiles:a}=e,{boundingVolume:o}=t.cached;if(e.ensureChildrenArePreprocessed(t),null===r&&(r=Ze,Qe.copy(i.matrixWorld).invert(),r.copy(s.ray).applyMatrix4(Qe)),!t.__used||!o.intersectsRay(r))return;a.has(t)&&et(t,s,e,n);const l=t.children;for(let c=0,h=l.length;c<h;c++)st(e,l[c],s,n,r)}const nt=new d,rt=new d,it=new d,at=new T;class ot{constructor(e=new v,t=new o){this.box=e.clone(),this.transform=t.clone(),this.inverseTransform=new o,this.points=new Array(8).fill().map((()=>new d)),this.planes=new Array(6).fill().map((()=>new P))}clampPoint(e,t){return t.copy(e).applyMatrix4(this.inverseTransform).clamp(this.box.min,this.box.max).applyMatrix4(this.transform)}distanceToPoint(e){return this.clampPoint(e,it).distanceTo(e)}containsPoint(e){return it.copy(e).applyMatrix4(this.inverseTransform),this.box.containsPoint(it)}intersectsRay(e){return at.copy(e).applyMatrix4(this.inverseTransform),at.intersectsBox(this.box)}intersectRay(e,t){return at.copy(e).applyMatrix4(this.inverseTransform),at.intersectBox(this.box,t)?(t.applyMatrix4(this.transform),t):null}update(){const{points:e,inverseTransform:t,transform:s,box:n}=this;t.copy(s).invert();const{min:r,max:i}=n;let a=0;for(let o=-1;o<=1;o+=2)for(let t=-1;t<=1;t+=2)for(let n=-1;n<=1;n+=2)e[a].set(o<0?r.x:i.x,t<0?r.y:i.y,n<0?r.z:i.z).applyMatrix4(s),a++;this.updatePlanes()}updatePlanes(){nt.copy(this.box.min).applyMatrix4(this.transform),rt.copy(this.box.max).applyMatrix4(this.transform),it.set(0,0,1).transformDirection(this.transform),this.planes[0].setFromNormalAndCoplanarPoint(it,nt),this.planes[1].setFromNormalAndCoplanarPoint(it,rt).negate(),it.set(0,1,0).transformDirection(this.transform),this.planes[2].setFromNormalAndCoplanarPoint(it,nt),this.planes[3].setFromNormalAndCoplanarPoint(it,rt).negate(),it.set(1,0,0).transformDirection(this.transform),this.planes[4].setFromNormalAndCoplanarPoint(it,nt),this.planes[5].setFromNormalAndCoplanarPoint(it,rt).negate()}intersectsFrustum(e){const{points:t}=this,{planes:s}=e;for(let n=0;n<6;n++){const e=s[n];let r=-1/0;for(let s=0;s<8;s++){const n=t[s],i=e.distanceToPoint(n);r=r<i?i:r}if(r<0)return!1}for(let n=0;n<6;n++){const t=this.planes[n];let s=-1/0;for(let n=0;n<8;n++){const r=e.points[n],i=t.distanceToPoint(r);s=s<i?i:s}if(s<0)return!1}return!0}}const lt=Math.PI,ct=lt/2,ht=new d,ut=new d,dt=new d,pt=new o;let mt=0;const gt=[];function ft(e=!1){return e?(gt[mt]||(gt[mt]=new d),mt++,gt[mt-1]):new d}function _t(){mt=0}class bt extends Le{constructor(e,t,s,n=-ct,r=ct,i=0,a=2*lt,o=0,l=0){super(e,t,s),this.latStart=n,this.latEnd=r,this.lonStart=i,this.lonEnd=a,this.heightStart=o,this.heightEnd=l}_getPoints(e=!1){const{latStart:t,latEnd:s,lonStart:n,lonEnd:r,heightStart:i,heightEnd:a}=this,o=u.mapLinear(.5,0,1,t,s),l=u.mapLinear(.5,0,1,n,r),c=Math.floor(n/ct)*ct,h=[[-lt/2,0],[lt/2,0],[0,c],[0,c+lt/2],[0,c+lt],[0,c+3*lt/2],[t,r],[s,r],[t,n],[s,n],[0,n],[0,r],[o,l],[t,l],[s,l],[o,n],[o,r]],d=[],p=h.length;for(let m=0;m<=1;m++){const o=u.mapLinear(m,0,1,i,a);for(let i=0,a=p;i<a;i++){const[a,l]=h[i];if(a>=t&&a<=s&&l>=n&&l<=r){const t=ft(e);d.push(t),this.getCartographicToPosition(a,l,o,t)}}}return d}getBoundingBox(e,t){_t();const{latStart:s,latEnd:n,lonStart:r,lonEnd:i}=this;if(n-s<lt/2){const e=u.mapLinear(.5,0,1,s,n),a=u.mapLinear(.5,0,1,r,i);this.getCartographicToNormal(e,a,dt),ut.set(0,0,1),ht.crossVectors(ut,dt),ut.crossVectors(ht,dt),t.makeBasis(ht,ut,dt)}else ht.set(1,0,0),ut.set(0,1,0),dt.set(0,0,1),t.makeBasis(ht,ut,dt);pt.copy(t).invert();const a=this._getPoints(!0);for(let o=0,l=a.length;o<l;o++)a[o].applyMatrix4(pt);e.makeEmpty(),e.setFromPoints(a)}getBoundingSphere(e,t){_t();const s=this._getPoints(!0);e.makeEmpty(),e.setFromPoints(s,t)}}const yt=new d,wt=new d,Tt=new d,xt=new d,St=new d;class Ct{constructor(){this.sphere=null,this.obb=null,this.region=null,this.regionObb=null}intersectsRay(e){const t=this.sphere,s=this.obb||this.regionObb;return!(t&&!e.intersectsSphere(t))&&!(s&&!s.intersectsRay(e))}intersectRay(e,t=null){const s=this.sphere,n=this.obb||this.regionObb;let r=-1/0,i=-1/0;s&&e.intersectSphere(s,xt)&&(r=s.containsPoint(e.origin)?0:e.origin.distanceToSquared(xt)),n&&n.intersectRay(e,St)&&(i=n.containsPoint(e.origin)?0:e.origin.distanceToSquared(St));const a=Math.max(r,i);return a===-1/0?null:(e.at(Math.sqrt(a),t),t)}distanceToPoint(e){const t=this.sphere,s=this.obb||this.regionObb;let n=-1/0,r=-1/0;return t&&(n=Math.max(t.distanceToPoint(e),0)),s&&(r=s.distanceToPoint(e)),n>r?n:r}intersectsFrustum(e){const t=this.obb||this.regionObb,s=this.sphere;return!(s&&!e.intersectsSphere(s))&&(!(t&&!t.intersectsFrustum(e))&&Boolean(s||t))}getOBB(e,t){const s=this.obb||this.regionObb;s?(e.copy(s.box),t.copy(s.transform)):(this.getAABB(e),t.identity())}getAABB(e){if(this.sphere)this.sphere.getBoundingBox(e);else{const t=this.obb||this.regionObb;e.copy(t.box).applyMatrix4(t.transform)}}getSphere(e){if(this.sphere)e.copy(this.sphere);else if(this.region)this.region.getBoundingSphere(e);else{const t=this.obb||this.regionObb;t.box.getBoundingSphere(e),e.applyMatrix4(t.transform)}}setObbData(e,t){const s=new ot;yt.set(e[3],e[4],e[5]),wt.set(e[6],e[7],e[8]),Tt.set(e[9],e[10],e[11]);const n=yt.length(),r=wt.length(),i=Tt.length();yt.normalize(),wt.normalize(),Tt.normalize(),0===n&&yt.crossVectors(wt,Tt),0===r&&wt.crossVectors(yt,Tt),0===i&&Tt.crossVectors(yt,wt),s.transform.set(yt.x,wt.x,Tt.x,e[0],yt.y,wt.y,Tt.y,e[1],yt.z,wt.z,Tt.z,e[2],0,0,0,1).premultiply(t),s.box.min.set(-n,-r,-i),s.box.max.set(n,r,i),s.update(),this.obb=s}setSphereData(e,t,s,n,r){const i=new y;i.center.set(e,t,s),i.radius=n,i.applyMatrix4(r),this.sphere=i}setRegionData(e,t,s,n,r,i,a){const o=new bt(...e.radius,s,r,t,n,i,a),l=new ot;o.getBoundingBox(l.box,l.transform),l.update(),this.region=o,this.regionObb=l}}const Pt=new E;class vt extends R{constructor(){super(),this.points=Array(8).fill().map((()=>new d))}setFromProjectionMatrix(e,t){super.setFromProjectionMatrix(e,t),this.calculateFrustumPoints()}calculateFrustumPoints(){const{planes:e,points:t}=this;[[e[0],e[3],e[4]],[e[1],e[3],e[4]],[e[0],e[2],e[4]],[e[1],e[2],e[4]],[e[0],e[3],e[5]],[e[1],e[3],e[5]],[e[0],e[2],e[5]],[e[1],e[2],e[5]]].forEach(((e,s)=>{!function(e,t,s,n){const r=Pt.set(e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z,s.normal.x,s.normal.y,s.normal.z);n.set(-e.constant,-t.constant,-s.constant),n.applyMatrix3(r.invert())}(e[0],e[1],e[2],t[s])}))}}const Et=new o,Rt=new w,Mt=Symbol("INITIAL_FRUSTUM_CULLED"),Lt=new o,At=new o,Ft=new d,Ut=new h,kt=new d(1,0,0),Dt=new d(0,1,0);function Ot(e,t){e.traverse((e=>{e.frustumCulled=e[Mt]&&t}))}class It extends K{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel((t=>{Ot(t,!e)})))}constructor(...e){super(...e),this.group=new Ye(this),this.ellipsoid=Ae.clone(),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this.optimizeRaycast=!0,this._upRotationMatrix=new o,this.lruCache.computeMemoryUsageCallback=e=>{var t;return null!=(t=e.cached.bytesUsed)?t:null},this._autoDisableRendererCulling=!0;const t=new F;t.setURLModifier((e=>this.preprocessURL?this.preprocessURL(e):e)),this.manager=t,this._listeners={}}addEventListener(...e){A.prototype.addEventListener.call(this,...e)}hasEventListener(...e){A.prototype.hasEventListener.call(this,...e)}removeEventListener(...e){A.prototype.removeEventListener.call(this,...e)}dispatchEvent(...e){A.prototype.dispatchEvent.call(this,...e)}getBoundingBox(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return!!t&&(t.getAABB(e),!0)}getOrientedBoundingBox(e,t){if(!this.root)return!1;const s=this.root.cached.boundingVolume;return!!s&&(s.getOBB(e,t),!0)}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return!!t&&(t.getSphere(e),!0)}forEachLoadedModel(e){this.traverse((t=>{const s=t.cached.scene;s&&e(s,t)}))}raycast(e,t){if(this.root)if(e.firstHitOnly){const s=tt(this,this.root,e);s&&t.push(s)}else st(this,this.root,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,s=this.cameraMap;return!s.has(e)&&(s.set(e,new h),t.push(e),this.dispatchEvent({type:"add-camera",camera:e}),!0)}setResolution(e,t,s){const n=this.cameraMap;if(!n.has(e))return!1;const r=t.isVector2?t.x:t,i=t.isVector2?t.y:s,a=n.get(e);return a.width===r&&a.height===i||(a.set(r,i),this.dispatchEvent({type:"camera-resolution-change"})),!0}setResolutionFromRenderer(e,t){return t.getSize(Ut).multiplyScalar(t.getPixelRatio()),this.setResolution(e,Ut.x,Ut.y)}deleteCamera(e){const t=this.cameras,s=this.cameraMap;if(s.has(e)){const n=t.indexOf(e);return t.splice(n,1),s.delete(e),this.dispatchEvent({type:"delete-camera",camera:e}),!0}return!1}preprocessTileSet(e,t,s){super.preprocessTileSet(e,t,s),queueMicrotask((()=>{this.dispatchEvent({type:"load-tile-set",tileSet:e,url:t})}))}loadRootTileSet(...e){return super.loadRootTileSet(...e).then((()=>{const{asset:e,extensions:t={}}=this.rootTileSet;switch((e&&e.gltfUpAxis||"y").toLowerCase()){case"x":this._upRotationMatrix.makeRotationAxis(Dt,-Math.PI/2);break;case"y":this._upRotationMatrix.makeRotationAxis(kt,Math.PI/2)}if("3DTILES_ellipsoid"in t){const e=t["3DTILES_ellipsoid"],{ellipsoid:s}=this;s.name=e.body,e.radii?s.radius.set(...e.radii):s.radius.set(1,1,1)}this.dispatchEvent({type:"load-content"})}))}update(){let e=null;if(this.invokeAllPlugins((t=>{if(t.doTilesNeedUpdate){const s=t.doTilesNeedUpdate();e=null===e?s:e||s}})),!1===e)return this.dispatchEvent({type:"update-before"}),void this.dispatchEvent({type:"update-after"});this.dispatchEvent({type:"update-before"});const t=this.group,s=this.cameras,n=this.cameraMap,r=this.cameraInfo;if(0!==s.length){for(;r.length>s.length;)r.pop();for(;r.length<s.length;)r.push({frustum:new vt,isOrthographic:!1,sseDenominator:-1,position:new d,invScale:-1,pixelSize:0});At.copy(t.matrixWorld).invert(),Ft.setFromMatrixScale(At),Math.abs(Math.max(Ft.x-Ft.y,Ft.x-Ft.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let e=0,i=r.length;e<i;e++){const i=s[e],a=r[e],o=a.frustum,l=a.position,c=n.get(i);0!==c.width&&0!==c.height||console.warn("TilesRenderer: resolution for camera error calculation is not set.");const h=i.projectionMatrix.elements;if(a.isOrthographic=1===h[15],a.isOrthographic){const e=2/h[0],t=2/h[5];a.pixelSize=Math.max(t/c.height,e/c.width)}else a.sseDenominator=2/h[5]/c.height;Lt.copy(t.matrixWorld),Lt.premultiply(i.matrixWorldInverse),Lt.premultiply(i.projectionMatrix),o.setFromProjectionMatrix(Lt),l.set(0,0,0),l.applyMatrix4(i.matrixWorld),l.applyMatrix4(At)}super.update(),this.dispatchEvent({type:"update-after"})}else console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.")}preprocessNode(e,t,s=null){super.preprocessNode(e,t,s);const n=new o;if(e.transform){const t=e.transform;for(let e=0;e<16;e++)n.elements[e]=t[e]}s&&n.premultiply(s.cached.transform);const r=(new o).copy(n).invert(),i=new Ct;"sphere"in e.boundingVolume&&i.setSphereData(...e.boundingVolume.sphere,n),"box"in e.boundingVolume&&i.setObbData(e.boundingVolume.box,n),"region"in e.boundingVolume&&i.setRegionData(this.ellipsoid,...e.boundingVolume.region),e.cached={transform:n,transformInverse:r,active:!1,boundingVolume:i,metadata:null,scene:null,geometry:null,materials:null,textures:null}}async requestTileContents(...e){await super.requestTileContents(...e),this.dispatchEvent({type:"load-content"})}async parseTile(e,t,s,n,r){const i=t.cached,a=n.split(/[\\/]/g);a.pop();const o=a.join("/"),l=this.fetchOptions,h=this.manager;let u=null;const d=i.transform,p=this._upRotationMatrix,m=(oe(e)||s).toLowerCase();switch(m){case"b3dm":{const t=new ce(h);t.workingPath=o,t.fetchOptions=l,t.adjustmentTransform.copy(p),u=t.parse(e);break}case"pnts":{const t=new ge(h);t.workingPath=o,t.fetchOptions=l,u=t.parse(e);break}case"i3dm":{const t=new qe(h);t.workingPath=o,t.fetchOptions=l,t.adjustmentTransform.copy(p),t.ellipsoid.copy(this.ellipsoid),u=t.parse(e);break}case"cmpt":{const t=new He(h);t.workingPath=o,t.fetchOptions=l,t.adjustmentTransform.copy(p),t.ellipsoid.copy(this.ellipsoid),u=t.parse(e).then((e=>e.scene));break}case"gltf":case"glb":{const t=h.getHandler("path.gltf")||h.getHandler("path.glb")||new c(h);t.setWithCredentials("include"===l.credentials),t.setRequestHeader(l.headers||{}),"include"===l.credentials&&"cors"===l.mode&&t.setCrossOrigin("use-credentials");let s=t.resourcePath||t.path||o;!/[\\/]$/.test(s)&&s.length&&(s+="/"),u=t.parseAsync(e,s).then((e=>{const{scene:t}=e;return t.updateMatrix(),t.matrix.multiply(p).decompose(t.position,t.quaternion,t.scale),e}));break}default:console.warn('TilesRenderer: Content type "'.concat(m,'" not supported.')),u=Promise.resolve(null)}const g=await u;let f,_;g.isObject3D?(f=g,_=null):(f=g.scene,_=g),await this.invokeAllPlugins((e=>e.processTileModel&&e.processTileModel(f,t))),f.updateMatrix(),f.matrix.premultiply(d),f.matrix.decompose(f.position,f.quaternion,f.scale),f.traverse((e=>{e[Mt]=e.frustumCulled})),Ot(f,!this.autoDisableRendererCulling);const b=[],y=[],w=[];if(f.traverse((e=>{if(e.geometry&&y.push(e.geometry),e.material){const t=e.material;b.push(e.material);for(const e in t){const s=t[e];s&&s.isTexture&&w.push(s)}}})),r.aborted)for(let c=0,T=w.length;c<T;c++){const e=w[c];e.image instanceof ImageBitmap&&e.image.close(),e.dispose()}else i.materials=b,i.geometry=y,i.textures=w,i.scene=f,i.metadata=_,i.bytesUsed=function(e){const{TextureUtils:t}=L;if(!t)return 0;const s=new Set;let n=0;return e.traverse((e=>{if(e.geometry&&!s.has(e.geometry)&&(n+=M(e.geometry),s.add(e.geometry)),e.material){const r=e.material;for(const e in r){const i=r[e];if(i&&i.isTexture&&!s.has(i)){const{format:e,type:r,image:a}=i,{width:o,height:l}=a,c=t.getByteLength(o,l,e,r);n+=i.generateMipmaps?4*c/3:c,s.add(i)}}}})),n}(f)}disposeTile(e){super.disposeTile(e);const t=e.cached;if(t.scene){const s=t.materials,n=t.geometry,r=t.textures,i=t.scene.parent;t.scene.traverse((e=>{e.userData.meshFeatures&&e.userData.meshFeatures.dispose(),e.userData.structuralMetadata&&e.userData.structuralMetadata.dispose()}));for(let e=0,t=n.length;e<t;e++)n[e].dispose();for(let e=0,t=s.length;e<t;e++)s[e].dispose();for(let e=0,t=r.length;e<t;e++){const t=r[e];t.image instanceof ImageBitmap&&t.image.close(),t.dispose()}i&&i.remove(t.scene),this.dispatchEvent({type:"dispose-model",scene:t.scene,tile:e}),t.scene=null,t.materials=null,t.textures=null,t.geometry=null,t.metadata=null}}setTileVisible(e,t){const s=e.cached.scene,n=this.group;t?s&&(n.add(s),s.updateMatrixWorld(!0)):s&&n.remove(s),super.setTileVisible(e,t),this.dispatchEvent({type:"tile-visibility-change",scene:s,tile:e,visible:t})}calculateError(e){const t=e.cached,s=this.cameras,n=this.cameraInfo,r=t.boundingVolume;let i=-1/0,a=1/0;for(let o=0,l=s.length;o<l;o++){const t=n[o];let s;if(t.isOrthographic){const n=t.pixelSize;s=e.geometricError/n}else{const n=r.distanceToPoint(t.position),i=t.sseDenominator;s=e.geometricError/(n*i),a=Math.min(a,n)}i=Math.max(i,s)}e.__distanceFromCamera=a,e.__error=i}tileInView(e){const t=e.cached.boundingVolume,s=this.cameraInfo;for(let n=0,r=s.length;n<r;n++){const e=s[n].frustum;if(t.intersectsFrustum(e))return!0}return!1}setLatLonToYUp(e,t){const{ellipsoid:s,group:n}=this;Rt.set(Math.PI/2,Math.PI/2,0),Et.makeRotationFromEuler(Rt),s.getEastNorthUpFrame(e,t,n.matrix).multiply(Et).invert().decompose(n.position,n.quaternion,n.scale),n.updateMatrixWorld(!0)}}export{It as T};
