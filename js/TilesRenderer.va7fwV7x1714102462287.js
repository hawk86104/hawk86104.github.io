import{bK as $t,da as ne,bL as Tt,az as j,d2 as D,db as Zt,dc as es,bg as ts,bQ as te,a4 as oe,bR as k,aH as be,bl as M,b3 as S,b8 as _t,dd as ss,bV as At,bp as ns,de as rs,av as G,df as os,aI as bt,cC as xt,br as Ue,bO as yt,bN as Ee,bM as is,bT as St,ap as as,dg as cs,au as wt,b7 as ls,aw as us,bP as hs,dh as ds,cS as fs,ay as Et,b5 as re,bk as ps,aT as K,aG as ms,di as gs,dj as Ts,dk as _s,dl as Rt,cW as Ke,bo as Ve,aC as As,dm as bs,dn as xs,dp as ys,cJ as Ss,dq as ws,dr as Es,bx as Rs,ch as Ls,bU as qe,bJ as Ms,bI as Cs,ds as We,dt as Xe,du as Qe,bw as Lt,bv as Mt,dv as Is,dw as ae,by as Ct,b2 as Ns,cQ as It,bE as Os,cB as Ps,d5 as vs,dx as Fs}from"./vendor.eaCmW-JG1714102462287.js";import{a as Ye}from"./BufferGeometryUtils.-wgS0gdu1714102462287.js";class Ge extends $t{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new Hs(t)}),this.register(function(t){return new Qs(t)}),this.register(function(t){return new Ys(t)}),this.register(function(t){return new Js(t)}),this.register(function(t){return new Gs(t)}),this.register(function(t){return new js(t)}),this.register(function(t){return new zs(t)}),this.register(function(t){return new Ks(t)}),this.register(function(t){return new Bs(t)}),this.register(function(t){return new qs(t)}),this.register(function(t){return new Vs(t)}),this.register(function(t){return new Xs(t)}),this.register(function(t){return new Ws(t)}),this.register(function(t){return new ks(t)}),this.register(function(t){return new $s(t)}),this.register(function(t){return new Zs(t)})}load(e,t,s,n){const r=this;let o;if(this.resourcePath!=="")o=this.resourcePath;else if(this.path!==""){const c=ne.extractUrlBase(e);o=ne.resolveURL(c,this.path)}else o=ne.extractUrlBase(e);this.manager.itemStart(e);const i=function(c){n?n(c):console.error(c),r.manager.itemError(e),r.manager.itemEnd(e)},a=new Tt(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,function(c){try{r.parse(c,o,function(u){t(u),r.manager.itemEnd(e)},i)}catch(u){i(u)}},s,i)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,n){let r;const o={},i={},a=new TextDecoder;if(typeof e=="string")r=JSON.parse(e);else if(e instanceof ArrayBuffer)if(a.decode(new Uint8Array(e,0,4))===Nt){try{o[w.KHR_BINARY_GLTF]=new en(e)}catch(h){n&&n(h);return}r=JSON.parse(o[w.KHR_BINARY_GLTF].content)}else r=JSON.parse(a.decode(e));else r=e;if(r.asset===void 0||r.asset.version[0]<2){n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const c=new pn(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let u=0;u<this.pluginCallbacks.length;u++){const h=this.pluginCallbacks[u](c);h.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),i[h.name]=h,o[h.name]=!0}if(r.extensionsUsed)for(let u=0;u<r.extensionsUsed.length;++u){const h=r.extensionsUsed[u],d=r.extensionsRequired||[];switch(h){case w.KHR_MATERIALS_UNLIT:o[h]=new Us;break;case w.KHR_DRACO_MESH_COMPRESSION:o[h]=new tn(r,this.dracoLoader);break;case w.KHR_TEXTURE_TRANSFORM:o[h]=new sn;break;case w.KHR_MESH_QUANTIZATION:o[h]=new nn;break;default:d.indexOf(h)>=0&&i[h]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+h+'".')}}c.setExtensions(o),c.setPlugins(i),c.parse(s,n)}parseAsync(e,t){const s=this;return new Promise(function(n,r){s.parse(e,t,n,r)})}}function Ds(){let l={};return{get:function(e){return l[e]},add:function(e,t){l[e]=t},remove:function(e){delete l[e]},removeAll:function(){l={}}}}const w={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class ks{constructor(e){this.parser=e,this.name=w.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,n=t.length;s<n;s++){const r=t[s];r.extensions&&r.extensions[this.name]&&r.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let n=t.cache.get(s);if(n)return n;const r=t.json,a=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let c;const u=new j(16777215);a.color!==void 0&&u.setRGB(a.color[0],a.color[1],a.color[2],D);const h=a.range!==void 0?a.range:0;switch(a.type){case"directional":c=new ts(u),c.target.position.set(0,0,-1),c.add(c.target);break;case"point":c=new es(u),c.distance=h;break;case"spot":c=new Zt(u),c.distance=h,a.spot=a.spot||{},a.spot.innerConeAngle=a.spot.innerConeAngle!==void 0?a.spot.innerConeAngle:0,a.spot.outerConeAngle=a.spot.outerConeAngle!==void 0?a.spot.outerConeAngle:Math.PI/4,c.angle=a.spot.outerConeAngle,c.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return c.position.set(0,0,0),c.decay=2,V(c,a),a.intensity!==void 0&&(c.intensity=a.intensity),c.name=t.createUniqueName(a.name||"light_"+e),n=Promise.resolve(c),t.cache.add(s,n),n}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,r=s.json.nodes[e],i=(r.extensions&&r.extensions[this.name]||{}).light;return i===void 0?null:this._loadLight(i).then(function(a){return s._getNodeRef(t.cache,i,a)})}}class Us{constructor(){this.name=w.KHR_MATERIALS_UNLIT}getMaterialType(){return te}extendParams(e,t,s){const n=[];e.color=new j(1,1,1),e.opacity=1;const r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const o=r.baseColorFactor;e.color.setRGB(o[0],o[1],o[2],D),e.opacity=o[3]}r.baseColorTexture!==void 0&&n.push(s.assignTexture(e,"map",r.baseColorTexture,oe))}return Promise.all(n)}}class Bs{constructor(e){this.parser=e,this.name=w.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name].emissiveStrength;return r!==void 0&&(t.emissiveIntensity=r),Promise.resolve()}}class Hs{constructor(e){this.parser=e,this.name=w.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:k}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];if(o.clearcoatFactor!==void 0&&(t.clearcoat=o.clearcoatFactor),o.clearcoatTexture!==void 0&&r.push(s.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),o.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),o.clearcoatRoughnessTexture!==void 0&&r.push(s.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),o.clearcoatNormalTexture!==void 0&&(r.push(s.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),o.clearcoatNormalTexture.scale!==void 0)){const i=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new be(i,i)}return Promise.all(r)}}class Vs{constructor(e){this.parser=e,this.name=w.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:k}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return o.iridescenceFactor!==void 0&&(t.iridescence=o.iridescenceFactor),o.iridescenceTexture!==void 0&&r.push(s.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),o.iridescenceIor!==void 0&&(t.iridescenceIOR=o.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),o.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),o.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),o.iridescenceThicknessTexture!==void 0&&r.push(s.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(r)}}class Gs{constructor(e){this.parser=e,this.name=w.KHR_MATERIALS_SHEEN}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:k}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[];t.sheenColor=new j(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=n.extensions[this.name];if(o.sheenColorFactor!==void 0){const i=o.sheenColorFactor;t.sheenColor.setRGB(i[0],i[1],i[2],D)}return o.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=o.sheenRoughnessFactor),o.sheenColorTexture!==void 0&&r.push(s.assignTexture(t,"sheenColorMap",o.sheenColorTexture,oe)),o.sheenRoughnessTexture!==void 0&&r.push(s.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(r)}}class js{constructor(e){this.parser=e,this.name=w.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:k}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return o.transmissionFactor!==void 0&&(t.transmission=o.transmissionFactor),o.transmissionTexture!==void 0&&r.push(s.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(r)}}class zs{constructor(e){this.parser=e,this.name=w.KHR_MATERIALS_VOLUME}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:k}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];t.thickness=o.thicknessFactor!==void 0?o.thicknessFactor:0,o.thicknessTexture!==void 0&&r.push(s.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const i=o.attenuationColor||[1,1,1];return t.attenuationColor=new j().setRGB(i[0],i[1],i[2],D),Promise.all(r)}}class Ks{constructor(e){this.parser=e,this.name=w.KHR_MATERIALS_IOR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:k}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name];return t.ior=r.ior!==void 0?r.ior:1.5,Promise.resolve()}}class qs{constructor(e){this.parser=e,this.name=w.KHR_MATERIALS_SPECULAR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:k}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];t.specularIntensity=o.specularFactor!==void 0?o.specularFactor:1,o.specularTexture!==void 0&&r.push(s.assignTexture(t,"specularIntensityMap",o.specularTexture));const i=o.specularColorFactor||[1,1,1];return t.specularColor=new j().setRGB(i[0],i[1],i[2],D),o.specularColorTexture!==void 0&&r.push(s.assignTexture(t,"specularColorMap",o.specularColorTexture,oe)),Promise.all(r)}}class Ws{constructor(e){this.parser=e,this.name=w.EXT_MATERIALS_BUMP}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:k}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return t.bumpScale=o.bumpFactor!==void 0?o.bumpFactor:1,o.bumpTexture!==void 0&&r.push(s.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(r)}}class Xs{constructor(e){this.parser=e,this.name=w.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:k}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return o.anisotropyStrength!==void 0&&(t.anisotropy=o.anisotropyStrength),o.anisotropyRotation!==void 0&&(t.anisotropyRotation=o.anisotropyRotation),o.anisotropyTexture!==void 0&&r.push(s.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(r)}}class Qs{constructor(e){this.parser=e,this.name=w.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,n=s.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const r=n.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r.source,o)}}class Ys{constructor(e){this.parser=e,this.name=w.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,r=n.textures[e];if(!r.extensions||!r.extensions[t])return null;const o=r.extensions[t],i=n.images[o.source];let a=s.textureLoader;if(i.uri){const c=s.options.manager.getHandler(i.uri);c!==null&&(a=c)}return this.detectSupport().then(function(c){if(c)return s.loadTextureImage(e,o.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Js{constructor(e){this.parser=e,this.name=w.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,r=n.textures[e];if(!r.extensions||!r.extensions[t])return null;const o=r.extensions[t],i=n.images[o.source];let a=s.textureLoader;if(i.uri){const c=s.options.manager.getHandler(i.uri);c!==null&&(a=c)}return this.detectSupport().then(function(c){if(c)return s.loadTextureImage(e,o.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class $s{constructor(e){this.name=w.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const n=s.extensions[this.name],r=this.parser.getDependency("buffer",n.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return r.then(function(i){const a=n.byteOffset||0,c=n.byteLength||0,u=n.count,h=n.byteStride,d=new Uint8Array(i,a,c);return o.decodeGltfBufferAsync?o.decodeGltfBufferAsync(u,h,d,n.mode,n.filter).then(function(f){return f.buffer}):o.ready.then(function(){const f=new ArrayBuffer(u*h);return o.decodeGltfBuffer(new Uint8Array(f),u,h,d,n.mode,n.filter),f})})}else return null}}class Zs{constructor(e){this.name=w.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||s.mesh===void 0)return null;const n=t.meshes[s.mesh];for(const c of n.primitives)if(c.mode!==N.TRIANGLES&&c.mode!==N.TRIANGLE_STRIP&&c.mode!==N.TRIANGLE_FAN&&c.mode!==void 0)return null;const o=s.extensions[this.name].attributes,i=[],a={};for(const c in o)i.push(this.parser.getDependency("accessor",o[c]).then(u=>(a[c]=u,a[c])));return i.length<1?null:(i.push(this.parser.createNodeMesh(e)),Promise.all(i).then(c=>{const u=c.pop(),h=u.isGroup?u.children:[u],d=c[0].count,f=[];for(const p of h){const T=new M,m=new S,g=new Ve,_=new S(1,1,1),y=new _t(p.geometry,p.material,d);for(let A=0;A<d;A++)a.TRANSLATION&&m.fromBufferAttribute(a.TRANSLATION,A),a.ROTATION&&g.fromBufferAttribute(a.ROTATION,A),a.SCALE&&_.fromBufferAttribute(a.SCALE,A),y.setMatrixAt(A,T.compose(m,g,_));for(const A in a)if(A==="_COLOR_0"){const E=a[A];y.instanceColor=new ss(E.array,E.itemSize,E.normalized)}else A!=="TRANSLATION"&&A!=="ROTATION"&&A!=="SCALE"&&p.geometry.setAttribute(A,a[A]);At.prototype.copy.call(y,p),this.parser.assignFinalMaterial(y),f.push(y)}return u.isGroup?(u.clear(),u.add(...f),u):f[0]}))}}const Nt="glTF",Z=12,Je={JSON:1313821514,BIN:5130562};class en{constructor(e){this.name=w.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,Z),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Nt)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-Z,r=new DataView(e,Z);let o=0;for(;o<n;){const i=r.getUint32(o,!0);o+=4;const a=r.getUint32(o,!0);if(o+=4,a===Je.JSON){const c=new Uint8Array(e,Z+o,i);this.content=s.decode(c)}else if(a===Je.BIN){const c=Z+o;this.body=e.slice(c,c+i)}o+=i}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class tn{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=w.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,n=this.dracoLoader,r=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,i={},a={},c={};for(const u in o){const h=Be[u]||u.toLowerCase();i[h]=o[u]}for(const u in e.attributes){const h=Be[u]||u.toLowerCase();if(o[u]!==void 0){const d=s.accessors[e.attributes[u]],f=J[d.componentType];c[h]=f.name,a[h]=d.normalized===!0}}return t.getDependency("bufferView",r).then(function(u){return new Promise(function(h,d){n.decodeDracoFile(u,function(f){for(const p in f.attributes){const T=f.attributes[p],m=a[p];m!==void 0&&(T.normalized=m)}h(f)},i,c,D,d)})})}}class sn{constructor(){this.name=w.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class nn{constructor(){this.name=w.KHR_MESH_QUANTIZATION}}class Ot extends Is{constructor(e,t,s,n){super(e,t,s,n)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,n=this.valueSize,r=e*n*3+n;for(let o=0;o!==n;o++)t[o]=s[r+o];return t}interpolate_(e,t,s,n){const r=this.resultBuffer,o=this.sampleValues,i=this.valueSize,a=i*2,c=i*3,u=n-t,h=(s-t)/u,d=h*h,f=d*h,p=e*c,T=p-c,m=-2*f+3*d,g=f-d,_=1-m,y=g-d+h;for(let A=0;A!==i;A++){const E=o[T+A+i],x=o[T+A+a]*u,b=o[p+A+i],L=o[p+A]*u;r[A]=_*E+y*x+m*b+g*L}return r}}const rn=new Ve;class on extends Ot{interpolate_(e,t,s,n){const r=super.interpolate_(e,t,s,n);return rn.fromArray(r).normalize().toArray(r),r}}const N={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},J={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},$e={9728:As,9729:bt,9984:bs,9985:xs,9986:ys,9987:xt},Ze={33071:Ss,33648:ws,10497:Ue},Re={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Be={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},U={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},an={CUBICSPLINE:void 0,LINEAR:Rt,STEP:Es},Le={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function cn(l){return l.DefaultMaterial===void 0&&(l.DefaultMaterial=new St({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Rs})),l.DefaultMaterial}function z(l,e,t){for(const s in t.extensions)l[s]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[s]=t.extensions[s])}function V(l,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(l.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function ln(l,e,t){let s=!1,n=!1,r=!1;for(let c=0,u=e.length;c<u;c++){const h=e[c];if(h.POSITION!==void 0&&(s=!0),h.NORMAL!==void 0&&(n=!0),h.COLOR_0!==void 0&&(r=!0),s&&n&&r)break}if(!s&&!n&&!r)return Promise.resolve(l);const o=[],i=[],a=[];for(let c=0,u=e.length;c<u;c++){const h=e[c];if(s){const d=h.POSITION!==void 0?t.getDependency("accessor",h.POSITION):l.attributes.position;o.push(d)}if(n){const d=h.NORMAL!==void 0?t.getDependency("accessor",h.NORMAL):l.attributes.normal;i.push(d)}if(r){const d=h.COLOR_0!==void 0?t.getDependency("accessor",h.COLOR_0):l.attributes.color;a.push(d)}}return Promise.all([Promise.all(o),Promise.all(i),Promise.all(a)]).then(function(c){const u=c[0],h=c[1],d=c[2];return s&&(l.morphAttributes.position=u),n&&(l.morphAttributes.normal=h),r&&(l.morphAttributes.color=d),l.morphTargetsRelative=!0,l})}function un(l,e){if(l.updateMorphTargets(),e.weights!==void 0)for(let t=0,s=e.weights.length;t<s;t++)l.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(l.morphTargetInfluences.length===t.length){l.morphTargetDictionary={};for(let s=0,n=t.length;s<n;s++)l.morphTargetDictionary[t[s]]=s}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function hn(l){let e;const t=l.extensions&&l.extensions[w.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+Me(t.attributes):e=l.indices+":"+Me(l.attributes)+":"+l.mode,l.targets!==void 0)for(let s=0,n=l.targets.length;s<n;s++)e+=":"+Me(l.targets[s]);return e}function Me(l){let e="";const t=Object.keys(l).sort();for(let s=0,n=t.length;s<n;s++)e+=t[s]+":"+l[t[s]]+";";return e}function He(l){switch(l){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function dn(l){return l.search(/\.jpe?g($|\?)/i)>0||l.search(/^data\:image\/jpeg/)===0?"image/jpeg":l.search(/\.webp($|\?)/i)>0||l.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}const fn=new M;class pn{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Ds,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,n=!1,r=-1;typeof navigator<"u"&&(s=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)===!0,n=navigator.userAgent.indexOf("Firefox")>-1,r=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),typeof createImageBitmap>"u"||s||n&&r<98?this.textureLoader=new ns(this.options.manager):this.textureLoader=new rs(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Tt(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,n=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(o){return o._markDefs&&o._markDefs()}),Promise.all(this._invokeAll(function(o){return o.beforeRoot&&o.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(o){const i={scene:o[0][n.scene||0],scenes:o[0],animations:o[1],cameras:o[2],asset:n.asset,parser:s,userData:{}};return z(r,i,n),V(i,n),Promise.all(s._invokeAll(function(a){return a.afterRoot&&a.afterRoot(i)})).then(function(){e(i)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let n=0,r=t.length;n<r;n++){const o=t[n].joints;for(let i=0,a=o.length;i<a;i++)e[o[i]].isBone=!0}for(let n=0,r=e.length;n<r;n++){const o=e[n];o.mesh!==void 0&&(this._addNodeRef(this.meshCache,o.mesh),o.skin!==void 0&&(s[o.mesh].isSkinnedMesh=!0)),o.camera!==void 0&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const n=s.clone(),r=(o,i)=>{const a=this.associations.get(o);a!=null&&this.associations.set(i,a);for(const[c,u]of o.children.entries())r(u,i.children[c])};return r(s,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let n=0;n<t.length;n++){const r=e(t[n]);r&&s.push(r)}return s}getDependency(e,t){const s=e+":"+t;let n=this.cache.get(s);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne(function(r){return r.loadNode&&r.loadNode(t)});break;case"mesh":n=this._invokeOne(function(r){return r.loadMesh&&r.loadMesh(t)});break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne(function(r){return r.loadBufferView&&r.loadBufferView(t)});break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne(function(r){return r.loadMaterial&&r.loadMaterial(t)});break;case"texture":n=this._invokeOne(function(r){return r.loadTexture&&r.loadTexture(t)});break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne(function(r){return r.loadAnimation&&r.loadAnimation(t)});break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne(function(r){return r!=this&&r.getDependency&&r.getDependency(e,t)}),!n)throw new Error("Unknown type: "+e);break}this.cache.add(s,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,n=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(n.map(function(r,o){return s.getDependency(e,o)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[w.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(r,o){s.load(ne.resolveURL(t.uri,n.path),r,void 0,function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(s){const n=t.byteLength||0,r=t.byteOffset||0;return s.slice(r,r+n)})}loadAccessor(e){const t=this,s=this.json,n=this.json.accessors[e];if(n.bufferView===void 0&&n.sparse===void 0){const o=Re[n.type],i=J[n.componentType],a=n.normalized===!0,c=new i(n.count*o);return Promise.resolve(new G(c,o,a))}const r=[];return n.bufferView!==void 0?r.push(this.getDependency("bufferView",n.bufferView)):r.push(null),n.sparse!==void 0&&(r.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(r).then(function(o){const i=o[0],a=Re[n.type],c=J[n.componentType],u=c.BYTES_PER_ELEMENT,h=u*a,d=n.byteOffset||0,f=n.bufferView!==void 0?s.bufferViews[n.bufferView].byteStride:void 0,p=n.normalized===!0;let T,m;if(f&&f!==h){const g=Math.floor(d/f),_="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+g+":"+n.count;let y=t.cache.get(_);y||(T=new c(i,g*f,n.count*f/u),y=new os(T,f/u),t.cache.add(_,y)),m=new Ls(y,a,d%f/u,p)}else i===null?T=new c(n.count*a):T=new c(i,d,n.count*a),m=new G(T,a,p);if(n.sparse!==void 0){const g=Re.SCALAR,_=J[n.sparse.indices.componentType],y=n.sparse.indices.byteOffset||0,A=n.sparse.values.byteOffset||0,E=new _(o[1],y,n.sparse.count*g),x=new c(o[2],A,n.sparse.count*a);i!==null&&(m=new G(m.array.slice(),m.itemSize,m.normalized));for(let b=0,L=E.length;b<L;b++){const R=E[b];if(m.setX(R,x[b*a]),a>=2&&m.setY(R,x[b*a+1]),a>=3&&m.setZ(R,x[b*a+2]),a>=4&&m.setW(R,x[b*a+3]),a>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return m})}loadTexture(e){const t=this.json,s=this.options,r=t.textures[e].source,o=t.images[r];let i=this.textureLoader;if(o.uri){const a=s.manager.getHandler(o.uri);a!==null&&(i=a)}return this.loadTextureImage(e,r,i)}loadTextureImage(e,t,s){const n=this,r=this.json,o=r.textures[e],i=r.images[t],a=(i.uri||i.bufferView)+":"+o.sampler;if(this.textureCache[a])return this.textureCache[a];const c=this.loadImageSource(t,s).then(function(u){u.flipY=!1,u.name=o.name||i.name||"",u.name===""&&typeof i.uri=="string"&&i.uri.startsWith("data:image/")===!1&&(u.name=i.uri);const d=(r.samplers||{})[o.sampler]||{};return u.magFilter=$e[d.magFilter]||bt,u.minFilter=$e[d.minFilter]||xt,u.wrapS=Ze[d.wrapS]||Ue,u.wrapT=Ze[d.wrapT]||Ue,n.associations.set(u,{textures:e}),u}).catch(function(){return null});return this.textureCache[a]=c,c}loadImageSource(e,t){const s=this,n=this.json,r=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(h=>h.clone());const o=n.images[e],i=self.URL||self.webkitURL;let a=o.uri||"",c=!1;if(o.bufferView!==void 0)a=s.getDependency("bufferView",o.bufferView).then(function(h){c=!0;const d=new Blob([h],{type:o.mimeType});return a=i.createObjectURL(d),a});else if(o.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const u=Promise.resolve(a).then(function(h){return new Promise(function(d,f){let p=d;t.isImageBitmapLoader===!0&&(p=function(T){const m=new qe(T);m.needsUpdate=!0,d(m)}),t.load(ne.resolveURL(h,r.path),p,void 0,f)})}).then(function(h){return c===!0&&i.revokeObjectURL(a),h.userData.mimeType=o.mimeType||dn(o.uri),h}).catch(function(h){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),h});return this.sourceCache[e]=u,u}assignTexture(e,t,s,n){const r=this;return this.getDependency("texture",s.index).then(function(o){if(!o)return null;if(s.texCoord!==void 0&&s.texCoord>0&&(o=o.clone(),o.channel=s.texCoord),r.extensions[w.KHR_TEXTURE_TRANSFORM]){const i=s.extensions!==void 0?s.extensions[w.KHR_TEXTURE_TRANSFORM]:void 0;if(i){const a=r.associations.get(o);o=r.extensions[w.KHR_TEXTURE_TRANSFORM].extendTexture(o,i),r.associations.set(o,a)}}return n!==void 0&&(o.colorSpace=n),e[t]=o,o})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const n=t.attributes.tangent===void 0,r=t.attributes.color!==void 0,o=t.attributes.normal===void 0;if(e.isPoints){const i="PointsMaterial:"+s.uuid;let a=this.cache.get(i);a||(a=new yt,Ee.prototype.copy.call(a,s),a.color.copy(s.color),a.map=s.map,a.sizeAttenuation=!1,this.cache.add(i,a)),s=a}else if(e.isLine){const i="LineBasicMaterial:"+s.uuid;let a=this.cache.get(i);a||(a=new is,Ee.prototype.copy.call(a,s),a.color.copy(s.color),a.map=s.map,this.cache.add(i,a)),s=a}if(n||r||o){let i="ClonedMaterial:"+s.uuid+":";n&&(i+="derivative-tangents:"),r&&(i+="vertex-colors:"),o&&(i+="flat-shading:");let a=this.cache.get(i);a||(a=s.clone(),r&&(a.vertexColors=!0),o&&(a.flatShading=!0),n&&(a.normalScale&&(a.normalScale.y*=-1),a.clearcoatNormalScale&&(a.clearcoatNormalScale.y*=-1)),this.cache.add(i,a),this.associations.set(a,this.associations.get(s))),s=a}e.material=s}getMaterialType(){return St}loadMaterial(e){const t=this,s=this.json,n=this.extensions,r=s.materials[e];let o;const i={},a=r.extensions||{},c=[];if(a[w.KHR_MATERIALS_UNLIT]){const h=n[w.KHR_MATERIALS_UNLIT];o=h.getMaterialType(),c.push(h.extendParams(i,r,t))}else{const h=r.pbrMetallicRoughness||{};if(i.color=new j(1,1,1),i.opacity=1,Array.isArray(h.baseColorFactor)){const d=h.baseColorFactor;i.color.setRGB(d[0],d[1],d[2],D),i.opacity=d[3]}h.baseColorTexture!==void 0&&c.push(t.assignTexture(i,"map",h.baseColorTexture,oe)),i.metalness=h.metallicFactor!==void 0?h.metallicFactor:1,i.roughness=h.roughnessFactor!==void 0?h.roughnessFactor:1,h.metallicRoughnessTexture!==void 0&&(c.push(t.assignTexture(i,"metalnessMap",h.metallicRoughnessTexture)),c.push(t.assignTexture(i,"roughnessMap",h.metallicRoughnessTexture))),o=this._invokeOne(function(d){return d.getMaterialType&&d.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(d){return d.extendMaterialParams&&d.extendMaterialParams(e,i)})))}r.doubleSided===!0&&(i.side=as);const u=r.alphaMode||Le.OPAQUE;if(u===Le.BLEND?(i.transparent=!0,i.depthWrite=!1):(i.transparent=!1,u===Le.MASK&&(i.alphaTest=r.alphaCutoff!==void 0?r.alphaCutoff:.5)),r.normalTexture!==void 0&&o!==te&&(c.push(t.assignTexture(i,"normalMap",r.normalTexture)),i.normalScale=new be(1,1),r.normalTexture.scale!==void 0)){const h=r.normalTexture.scale;i.normalScale.set(h,h)}if(r.occlusionTexture!==void 0&&o!==te&&(c.push(t.assignTexture(i,"aoMap",r.occlusionTexture)),r.occlusionTexture.strength!==void 0&&(i.aoMapIntensity=r.occlusionTexture.strength)),r.emissiveFactor!==void 0&&o!==te){const h=r.emissiveFactor;i.emissive=new j().setRGB(h[0],h[1],h[2],D)}return r.emissiveTexture!==void 0&&o!==te&&c.push(t.assignTexture(i,"emissiveMap",r.emissiveTexture,oe)),Promise.all(c).then(function(){const h=new o(i);return r.name&&(h.name=r.name),V(h,r),t.associations.set(h,{materials:e}),r.extensions&&z(n,h,r),h})}createUniqueName(e){const t=cs.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,n=this.primitiveCache;function r(i){return s[w.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(i,t).then(function(a){return et(a,i,t)})}const o=[];for(let i=0,a=e.length;i<a;i++){const c=e[i],u=hn(c),h=n[u];if(h)o.push(h.promise);else{let d;c.extensions&&c.extensions[w.KHR_DRACO_MESH_COMPRESSION]?d=r(c):d=et(new wt,c,t),n[u]={primitive:c,promise:d},o.push(d)}}return Promise.all(o)}loadMesh(e){const t=this,s=this.json,n=this.extensions,r=s.meshes[e],o=r.primitives,i=[];for(let a=0,c=o.length;a<c;a++){const u=o[a].material===void 0?cn(this.cache):this.getDependency("material",o[a].material);i.push(u)}return i.push(t.loadGeometries(o)),Promise.all(i).then(function(a){const c=a.slice(0,a.length-1),u=a[a.length-1],h=[];for(let f=0,p=u.length;f<p;f++){const T=u[f],m=o[f];let g;const _=c[f];if(m.mode===N.TRIANGLES||m.mode===N.TRIANGLE_STRIP||m.mode===N.TRIANGLE_FAN||m.mode===void 0)g=r.isSkinnedMesh===!0?new ls(T,_):new us(T,_),g.isSkinnedMesh===!0&&g.normalizeSkinWeights(),m.mode===N.TRIANGLE_STRIP?g.geometry=Ye(g.geometry,Ms):m.mode===N.TRIANGLE_FAN&&(g.geometry=Ye(g.geometry,Cs));else if(m.mode===N.LINES)g=new hs(T,_);else if(m.mode===N.LINE_STRIP)g=new ds(T,_);else if(m.mode===N.LINE_LOOP)g=new fs(T,_);else if(m.mode===N.POINTS)g=new Et(T,_);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+m.mode);Object.keys(g.geometry.morphAttributes).length>0&&un(g,r),g.name=t.createUniqueName(r.name||"mesh_"+e),V(g,r),m.extensions&&z(n,g,m),t.assignFinalMaterial(g),h.push(g)}for(let f=0,p=h.length;f<p;f++)t.associations.set(h[f],{meshes:e,primitives:f});if(h.length===1)return r.extensions&&z(n,h[0],r),h[0];const d=new re;r.extensions&&z(n,d,r),t.associations.set(d,{meshes:e});for(let f=0,p=h.length;f<p;f++)d.add(h[f]);return d})}loadCamera(e){let t;const s=this.json.cameras[e],n=s[s.type];if(!n){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return s.type==="perspective"?t=new ps(K.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):s.type==="orthographic"&&(t=new ms(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),V(t,s),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],s=[];for(let n=0,r=t.joints.length;n<r;n++)s.push(this._loadNodeShallow(t.joints[n]));return t.inverseBindMatrices!==void 0?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(n){const r=n.pop(),o=n,i=[],a=[];for(let c=0,u=o.length;c<u;c++){const h=o[c];if(h){i.push(h);const d=new M;r!==null&&d.fromArray(r.array,c*16),a.push(d)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[c])}return new gs(i,a)})}loadAnimation(e){const t=this.json,s=this,n=t.animations[e],r=n.name?n.name:"animation_"+e,o=[],i=[],a=[],c=[],u=[];for(let h=0,d=n.channels.length;h<d;h++){const f=n.channels[h],p=n.samplers[f.sampler],T=f.target,m=T.node,g=n.parameters!==void 0?n.parameters[p.input]:p.input,_=n.parameters!==void 0?n.parameters[p.output]:p.output;T.node!==void 0&&(o.push(this.getDependency("node",m)),i.push(this.getDependency("accessor",g)),a.push(this.getDependency("accessor",_)),c.push(p),u.push(T))}return Promise.all([Promise.all(o),Promise.all(i),Promise.all(a),Promise.all(c),Promise.all(u)]).then(function(h){const d=h[0],f=h[1],p=h[2],T=h[3],m=h[4],g=[];for(let _=0,y=d.length;_<y;_++){const A=d[_],E=f[_],x=p[_],b=T[_],L=m[_];if(A===void 0)continue;A.updateMatrix&&A.updateMatrix();const R=s._createAnimationTracks(A,E,x,b,L);if(R)for(let C=0;C<R.length;C++)g.push(R[C])}return new Ts(r,void 0,g)})}createNodeMesh(e){const t=this.json,s=this,n=t.nodes[e];return n.mesh===void 0?null:s.getDependency("mesh",n.mesh).then(function(r){const o=s._getNodeRef(s.meshCache,n.mesh,r);return n.weights!==void 0&&o.traverse(function(i){if(i.isMesh)for(let a=0,c=n.weights.length;a<c;a++)i.morphTargetInfluences[a]=n.weights[a]}),o})}loadNode(e){const t=this.json,s=this,n=t.nodes[e],r=s._loadNodeShallow(e),o=[],i=n.children||[];for(let c=0,u=i.length;c<u;c++)o.push(s.getDependency("node",i[c]));const a=n.skin===void 0?Promise.resolve(null):s.getDependency("skin",n.skin);return Promise.all([r,Promise.all(o),a]).then(function(c){const u=c[0],h=c[1],d=c[2];d!==null&&u.traverse(function(f){f.isSkinnedMesh&&f.bind(d,fn)});for(let f=0,p=h.length;f<p;f++)u.add(h[f]);return u})}_loadNodeShallow(e){const t=this.json,s=this.extensions,n=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const r=t.nodes[e],o=r.name?n.createUniqueName(r.name):"",i=[],a=n._invokeOne(function(c){return c.createNodeMesh&&c.createNodeMesh(e)});return a&&i.push(a),r.camera!==void 0&&i.push(n.getDependency("camera",r.camera).then(function(c){return n._getNodeRef(n.cameraCache,r.camera,c)})),n._invokeAll(function(c){return c.createNodeAttachment&&c.createNodeAttachment(e)}).forEach(function(c){i.push(c)}),this.nodeCache[e]=Promise.all(i).then(function(c){let u;if(r.isBone===!0?u=new _s:c.length>1?u=new re:c.length===1?u=c[0]:u=new At,u!==c[0])for(let h=0,d=c.length;h<d;h++)u.add(c[h]);if(r.name&&(u.userData.name=r.name,u.name=o),V(u,r),r.extensions&&z(s,u,r),r.matrix!==void 0){const h=new M;h.fromArray(r.matrix),u.applyMatrix4(h)}else r.translation!==void 0&&u.position.fromArray(r.translation),r.rotation!==void 0&&u.quaternion.fromArray(r.rotation),r.scale!==void 0&&u.scale.fromArray(r.scale);return n.associations.has(u)||n.associations.set(u,{}),n.associations.get(u).nodes=e,u}),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],n=this,r=new re;s.name&&(r.name=n.createUniqueName(s.name)),V(r,s),s.extensions&&z(t,r,s);const o=s.nodes||[],i=[];for(let a=0,c=o.length;a<c;a++)i.push(n.getDependency("node",o[a]));return Promise.all(i).then(function(a){for(let u=0,h=a.length;u<h;u++)r.add(a[u]);const c=u=>{const h=new Map;for(const[d,f]of n.associations)(d instanceof Ee||d instanceof qe)&&h.set(d,f);return u.traverse(d=>{const f=n.associations.get(d);f!=null&&h.set(d,f)}),h};return n.associations=c(r),r})}_createAnimationTracks(e,t,s,n,r){const o=[],i=e.name?e.name:e.uuid,a=[];U[r.path]===U.weights?e.traverse(function(d){d.morphTargetInfluences&&a.push(d.name?d.name:d.uuid)}):a.push(i);let c;switch(U[r.path]){case U.weights:c=Xe;break;case U.rotation:c=Qe;break;case U.position:case U.scale:c=We;break;default:switch(s.itemSize){case 1:c=Xe;break;case 2:case 3:default:c=We;break}break}const u=n.interpolation!==void 0?an[n.interpolation]:Rt,h=this._getArrayFromAccessor(s);for(let d=0,f=a.length;d<f;d++){const p=new c(a[d]+"."+U[r.path],t.array,h,u);n.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(p),o.push(p)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const s=He(t.constructor),n=new Float32Array(t.length);for(let r=0,o=t.length;r<o;r++)n[r]=t[r]*s;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(s){const n=this instanceof Qe?on:Ot;return new n(this.times,this.values,this.getValueSize()/3,s)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function mn(l,e,t){const s=e.attributes,n=new Lt;if(s.POSITION!==void 0){const i=t.json.accessors[s.POSITION],a=i.min,c=i.max;if(a!==void 0&&c!==void 0){if(n.set(new S(a[0],a[1],a[2]),new S(c[0],c[1],c[2])),i.normalized){const u=He(J[i.componentType]);n.min.multiplyScalar(u),n.max.multiplyScalar(u)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const r=e.targets;if(r!==void 0){const i=new S,a=new S;for(let c=0,u=r.length;c<u;c++){const h=r[c];if(h.POSITION!==void 0){const d=t.json.accessors[h.POSITION],f=d.min,p=d.max;if(f!==void 0&&p!==void 0){if(a.setX(Math.max(Math.abs(f[0]),Math.abs(p[0]))),a.setY(Math.max(Math.abs(f[1]),Math.abs(p[1]))),a.setZ(Math.max(Math.abs(f[2]),Math.abs(p[2]))),d.normalized){const T=He(J[d.componentType]);a.multiplyScalar(T)}i.max(a)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}n.expandByVector(i)}l.boundingBox=n;const o=new Mt;n.getCenter(o.center),o.radius=n.min.distanceTo(n.max)/2,l.boundingSphere=o}function et(l,e,t){const s=e.attributes,n=[];function r(o,i){return t.getDependency("accessor",o).then(function(a){l.setAttribute(i,a)})}for(const o in s){const i=Be[o]||o.toLowerCase();i in l.attributes||n.push(r(s[o],i))}if(e.indices!==void 0&&!l.index){const o=t.getDependency("accessor",e.indices).then(function(i){l.setIndex(i)});n.push(o)}return Ke.workingColorSpace!==D&&"COLOR_0"in s&&console.warn('THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "'.concat(Ke.workingColorSpace,'" not supported.')),V(l,e),mn(l,e,t),Promise.all(n).then(function(){return e.targets!==void 0?ln(l,e.targets,t):l})}function tt(l){let e;try{e=new URL(l,"http://fakehost.com/")}catch(r){return null}const t=e.pathname.split("/").pop(),s=t.lastIndexOf(".");return s===-1||s===t.length-1?null:t.substring(s+1)}function gn(l){Promise.resolve().then(l)}class Tn{constructor(){this.maxSize=800,this.minSize=600,this.unloadPercent=.05,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadPriorityCallback=null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize}add(e,t){const s=this.itemSet;if(s.has(e)||this.isFull())return!1;const n=this.usedSet,r=this.itemList,o=this.callbacks;return r.push(e),n.add(e),s.set(e,Date.now()),o.set(e,t),!0}remove(e){const t=this.usedSet,s=this.itemSet,n=this.itemList,r=this.callbacks;if(s.has(e)){r.get(e)(e);const o=n.indexOf(e);return n.splice(o,1),t.delete(e),s.delete(e),r.delete(e),!0}return!1}markUsed(e){const t=this.itemSet,s=this.usedSet;t.has(e)&&!s.has(e)&&(t.set(e,Date.now()),s.add(e))}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const e=this.unloadPercent,t=this.minSize,s=this.itemList,n=this.itemSet,r=this.usedSet,o=this.callbacks,i=s.length-r.size,a=s.length-t,c=this.unloadPriorityCallback||this.defaultPriorityCallback;if(a>0&&i>0){s.sort((p,T)=>{const m=r.has(p),g=r.has(T);return m&&g?0:!m&&!g?c(T)-c(p):m?1:-1});const u=Math.min(a,i),h=Math.max(t*e,u*e);let d=Math.min(h,i);d=Math.ceil(d);const f=s.splice(0,d);for(let p=0,T=f.length;p<T;p++){const m=f[p];o.get(m)(m),n.delete(m),o.delete(m)}}}scheduleUnload(e=!0){this.scheduled||(this.scheduled=!0,gn(()=>{this.scheduled=!1,this.unloadUnusedContent(),e&&this.markAllUnused()}))}}class st{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise((s,n)=>{const r=(...a)=>t(...a).then(s).catch(n),o=this.items,i=this.callbacks;o.push(e),i.set(e,r),this.autoUpdate&&this.scheduleJobRun()})}remove(e){const t=this.items,s=this.callbacks,n=t.indexOf(e);n!==-1&&(t.splice(n,1),s.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,s=this.maxJobs;let n=this.currJobs;for(;s>n&&e.length>0;){n++;const r=e.pop(),o=t.get(r);t.delete(r),o(r).then(()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}).catch(()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})}this.currJobs=n}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const le=0,ue=1,Ce=2,ie=3,xe=4,ye=6378137,_n=1/298.257223563,An=-(_n*ye-ye);function je(l){return l===ie||l===xe}function q(l,e){return l.__lastFrameVisited===e&&l.__used}function Pt(l,e){l.__lastFrameVisited!==e&&(l.__lastFrameVisited=e,l.__used=!1,l.__inFrustum=!1,l.__isLeaf=!1,l.__visible=!1,l.__active=!1,l.__error=1/0,l.__distanceFromCamera=1/0,l.__childrenWereVisible=!1,l.__allChildrenLoaded=!1)}function vt(l,e,t,s){if(s.ensureChildrenArePreprocessed(l),Pt(l,e),l.__used=!0,t.markUsed(l),l.__contentEmpty){const n=l.children;for(let r=0,o=n.length;r<o;r++)vt(n[r],e,t,s)}}function Ft(l,e,t){if(t.ensureChildrenArePreprocessed(l),l.__contentEmpty&&(!l.__externalTileSet||je(l.__loadingState))){const n=l.children;for(let r=0,o=n.length;r<o;r++){const i=n[r];i.__depthFromRenderedParent=e,Ft(i,e,t)}}else t.requestTileContents(l)}function Dt(l,e=null,t=null,s=null,n=0){if(e&&e(l,s,n)){t&&t(l,s,n);return}const r=l.children;for(let o=0,i=r.length;o<i;o++)Dt(r[o],e,t,l,n+1);t&&t(l,s,n)}function kt(l,e){e.ensureChildrenArePreprocessed(l);const t=e.stats,s=e.frameCount,n=e.errorTarget,r=e.maxDepth,o=e.loadSiblings,i=e.lruCache,a=e.stopAtEmptyTiles;if(Pt(l,s),e.tileInView(l)===!1)return!1;if(l.__used=!0,i.markUsed(l),l.__inFrustum=!0,t.inFrustum++,(a||!l.__contentEmpty)&&!l.__externalTileSet&&(e.calculateError(l),l.__error<=n||e.maxDepth>0&&l.__depth+1>=r))return!0;let u=!1;const h=l.children;for(let d=0,f=h.length;d<f;d++){const p=h[d],T=kt(p,e);u=u||T}if(u&&o)for(let d=0,f=h.length;d<f;d++){const p=h[d];vt(p,s,i,e)}return!0}function Ut(l,e){const t=e.stats,s=e.frameCount;if(!q(l,s))return;t.used++;const n=l.children;let r=!1;for(let o=0,i=n.length;o<i;o++){const a=n[o];r=r||q(a,s)}if(!r)l.__isLeaf=!0;else{let o=!1,i=!0;for(let a=0,c=n.length;a<c;a++){const u=n[a];if(Ut(u,e),o=o||u.__wasSetVisible||u.__childrenWereVisible,q(u,s)){const h=u.__allChildrenLoaded||!u.__contentEmpty&&je(u.__loadingState)||!u.__externalTileSet&&u.__contentEmpty&&u.children.length===0||u.__externalTileSet&&u.__loadingState===xe;i=i&&h}}l.__childrenWereVisible=o,l.__allChildrenLoaded=i}}function Bt(l,e){const t=e.stats,s=e.frameCount;if(!q(l,s))return;const n=l.parent,r=n?n.__depthFromRenderedParent:-1;l.__depthFromRenderedParent=r;const o=e.lruCache;if(l.__isLeaf){l.__depthFromRenderedParent++,l.__loadingState===ie?(l.__inFrustum&&(l.__visible=!0,t.visible++),l.__active=!0,t.active++):!o.isFull()&&(!l.__contentEmpty||l.__externalTileSet)&&e.requestTileContents(l);return}const i=(e.errorTarget+1)*e.errorThreshold,a=l.__error<=i,c=a||l.refine==="ADD",u=!l.__contentEmpty,h=u||l.__externalTileSet,d=je(l.__loadingState)&&h,f=l.__childrenWereVisible,p=l.children,T=l.__allChildrenLoaded;if(c&&u&&l.__depthFromRenderedParent++,c&&!d&&!o.isFull()&&h&&e.requestTileContents(l),(a&&!T&&!f&&d||l.refine==="ADD"&&d)&&(l.__inFrustum&&(l.__visible=!0,t.visible++),l.__active=!0,t.active++),l.refine!=="ADD"&&a&&!T&&d)for(let m=0,g=p.length;m<g;m++){const _=p[m];q(_,s)&&!o.isFull()&&(_.__depthFromRenderedParent=l.__depthFromRenderedParent+1,Ft(_,_.__depthFromRenderedParent,e))}else for(let m=0,g=p.length;m<g;m++){const _=p[m];q(_,s)&&Bt(_,e)}}function Ht(l,e){const t=e.frameCount,s=q(l,t);if(s||l.__usedLastFrame){let n=!1,r=!1;s&&(n=l.__active,e.displayActiveTiles?r=l.__active||l.__visible:r=l.__visible),!l.__contentEmpty&&l.__loadingState===ie&&(l.__wasSetActive!==n&&e.setTileActive(l,n),l.__wasSetVisible!==r&&e.setTileVisible(l,r)),l.__wasSetActive=n,l.__wasSetVisible=r,l.__usedLastFrame=s;const o=l.children;for(let i=0,a=o.length;i<a;i++){const c=o[i];Ht(c,e)}}}const nt=(l,e)=>l.__depth!==e.__depth?l.__depth>e.__depth?-1:1:l.__inFrustum!==e.__inFrustum?l.__inFrustum?1:-1:l.__used!==e.__used?l.__used?1:-1:l.__error!==e.__error?l.__error>e.__error?1:-1:l.__distanceFromCamera!==e.__distanceFromCamera?l.__distanceFromCamera>e.__distanceFromCamera?-1:1:0,bn=l=>1/(l.__depthFromRenderedParent+1);class xn{get rootTileSet(){const e=this.tileSets[this.rootURL];return!e||e instanceof Promise?null:e}get root(){const e=this.rootTileSet;return e?e.root:null}constructor(e){this.tileSets={},this.rootURL=e,this.fetchOptions={},this.preprocessURL=null;const t=new Tn;t.unloadPriorityCallback=bn;const s=new st;s.maxJobs=4,s.priorityCallback=nt;const n=new st;n.maxJobs=1,n.priorityCallback=nt,this.lruCache=t,this.downloadQueue=s,this.parseQueue=n,this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this.errorThreshold=1/0,this.loadSiblings=!0,this.displayActiveTiles=!1,this.maxDepth=1/0,this.stopAtEmptyTiles=!0}traverse(e,t){const n=this.tileSets[this.rootURL];!n||!n.root||Dt(n.root,(r,...o)=>(this.ensureChildrenArePreprocessed(r),e?e(r,...o):!1),t)}update(){const e=this.stats,t=this.lruCache,s=this.tileSets,n=s[this.rootURL];if(this.rootURL in s){if(!n||!n.root)return}else{this.loadRootTileSet(this.rootURL);return}const r=n.root;e.inFrustum=0,e.used=0,e.active=0,e.visible=0,this.frameCount++,kt(r,this),Ut(r,this),Bt(r,this),Ht(r,this),t.scheduleUnload()}parseTile(e,t,s){return null}disposeTile(e){}preprocessNode(e,t,s=null){if(e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.uri&&(e.content.uri=new URL(e.content.uri,t+"/").toString()),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=s,e.children=e.children||[],e.content&&e.content.uri){const r=tt(e.content.uri),o=!!(r&&r.toLowerCase()==="json");e.__externalTileSet=o,e.__contentEmpty=o}else e.__externalTileSet=!1,e.__contentEmpty=!0;e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=le,e.__loadIndex=0,e.__loadAbort=null,e.__depthFromRenderedParent=-1,s===null?(e.__depth=0,e.refine=e.refine||"REPLACE"):(e.__depth=s.__depth+1,e.refine=e.refine||s.refine),e.__basePath=t}setTileActive(e,t){}setTileVisible(e,t){}calculateError(e){return 0}tileInView(e){return!0}ensureChildrenArePreprocessed(e){const t=e.children;for(let s=0,n=t.length;s<n;s++){const r=t[s];if("__depth"in r)break;this.preprocessNode(r,e.__basePath,e)}}resetFailedTiles(){const e=this.stats;e.failed!==0&&(this.traverse(t=>{t.__loadingState===xe&&(t.__loadingState=le)}),e.failed=0)}fetchTileSet(e,t,s=null){return fetch(e,t).then(n=>{if(n.ok)return n.json();throw new Error('TilesRenderer: Failed to load tileset "'.concat(e,'" with status ').concat(n.status," : ").concat(n.statusText))}).then(n=>{const r=n.asset.version,[o,i]=r.split(".").map(c=>parseInt(c));console.assert(o<=1,"TilesRenderer: asset.version is expected to be a 1.x or a compatible version."),o===1&&i>0&&console.warn("TilesRenderer: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let a=e.replace(/\/[^\/]*\/?$/,"");return a=new URL(a,window.location.href).toString(),this.preprocessNode(n.root,a,s),n})}loadRootTileSet(e){const t=this.tileSets;if(e in t)return t[e]instanceof Error?Promise.reject(t[e]):Promise.resolve(t[e]);{const s=this.fetchTileSet(this.preprocessURL?this.preprocessURL(e):e,this.fetchOptions).then(n=>{t[e]=n});return s.catch(n=>{console.error(n),t[e]=n}),t[e]=s,s}}requestTileContents(e){if(e.__loadingState!==le)return;const t=this.stats,s=this.lruCache,n=this.downloadQueue,r=this.parseQueue,o=e.__externalTileSet;s.add(e,h=>{h.__loadingState===ue?(h.__loadAbort.abort(),h.__loadAbort=null):o?h.children.length=0:this.disposeTile(h),h.__loadingState===ue?t.downloading--:h.__loadingState===Ce&&t.parsing--,h.__loadingState=le,h.__loadIndex++,r.remove(h),n.remove(h)}),e.__loadIndex++;const i=e.__loadIndex,a=new AbortController,c=a.signal;t.downloading++,e.__loadAbort=a,e.__loadingState=ue;const u=h=>{e.__loadIndex===i&&(h.name!=="AbortError"?(r.remove(e),n.remove(e),e.__loadingState===Ce?t.parsing--:e.__loadingState===ue&&t.downloading--,t.failed++,console.error('TilesRenderer : Failed to load tile at url "'.concat(e.content.uri,'".')),console.error(h),e.__loadingState=xe):s.remove(e))};o?n.add(e,h=>{if(h.__loadIndex!==i)return Promise.resolve();const d=this.preprocessURL?this.preprocessURL(h.content.uri):h.content.uri;return this.fetchTileSet(d,Object.assign({signal:c},this.fetchOptions),h)}).then(h=>{e.__loadIndex===i&&(t.downloading--,e.__loadAbort=null,e.__loadingState=ie,e.children.push(h.root))}).catch(u):n.add(e,h=>{if(h.__loadIndex!==i)return Promise.resolve();const d=this.preprocessURL?this.preprocessURL(h.content.uri):h.content.uri;return fetch(d,Object.assign({signal:c},this.fetchOptions))}).then(h=>{if(e.__loadIndex===i){if(h.ok)return h.arrayBuffer();throw new Error("Failed to load model with error code ".concat(h.status))}}).then(h=>{if(e.__loadIndex===i)return t.downloading--,t.parsing++,e.__loadAbort=null,e.__loadingState=Ce,r.add(e,d=>{if(d.__loadIndex!==i)return Promise.resolve();const f=d.content.uri,p=tt(f);return this.parseTile(h,d,p)})}).then(()=>{e.__loadIndex===i&&(t.parsing--,e.__loadingState=ie,e.__wasSetVisible&&this.setTileVisible(e,!0),e.__wasSetActive&&this.setTileActive(e,!0))}).catch(u)}dispose(){const e=this.lruCache,t=[];this.traverse(s=>(t.push(s),!1));for(let s=0,n=t.length;s<n;s++)e.remove(t[s]);this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}}function Vt(l){return new TextDecoder().decode(l)}class we{constructor(e,t,s,n){this.buffer=e,this.binOffset=t+s,this.binLength=n;let r=null;if(s!==0){const o=new Uint8Array(e,t,s);r=JSON.parse(Vt(o))}else r={};this.header=r}getKeys(){return Object.keys(this.header)}getData(e,t,s=null,n=null){const r=this.header;if(!(e in r))return null;const o=r[e];if(o instanceof Object){if(Array.isArray(o))return o;{const{buffer:i,binOffset:a,binLength:c}=this,u=o.byteOffset||0,h=o.type||n,d=o.componentType||s;if("type"in o&&n&&o.type!==n)throw new Error("FeatureTable: Specified type does not match expected type.");let f;switch(h){case"SCALAR":f=1;break;case"VEC2":f=2;break;case"VEC3":f=3;break;case"VEC4":f=4;break;default:throw new Error('FeatureTable : Feature type not provided for "'.concat(e,'".'))}let p;const T=a+u,m=t*f;switch(d){case"BYTE":p=new Int8Array(i,T,m);break;case"UNSIGNED_BYTE":p=new Uint8Array(i,T,m);break;case"SHORT":p=new Int16Array(i,T,m);break;case"UNSIGNED_SHORT":p=new Uint16Array(i,T,m);break;case"INT":p=new Int32Array(i,T,m);break;case"UNSIGNED_INT":p=new Uint32Array(i,T,m);break;case"FLOAT":p=new Float32Array(i,T,m);break;case"DOUBLE":p=new Float64Array(i,T,m);break;default:throw new Error('FeatureTable : Feature component type not provided for "'.concat(e,'".'))}if(T+m*p.BYTES_PER_ELEMENT>a+c)throw new Error("FeatureTable: Feature data read outside binary body length.");return p}}else return o}getBuffer(e,t){const{buffer:s,binOffset:n}=this;return s.slice(n+e,n+e+t)}}class ze extends we{constructor(e,t,s,n,r){super(e,s,n,r),this.batchSize=t}getData(e,t=null,s=null){return super.getData(e,this.batchSize,t,s)}}class ce{constructor(){this.fetchOptions={},this.workingPath=""}load(e){return fetch(e,this.fetchOptions).then(t=>{if(!t.ok)throw new Error('Failed to load file "'.concat(e,'" with status ').concat(t.status," : ").concat(t.statusText));return t.arrayBuffer()}).then(t=>(this.workingPath===""&&(this.workingPath=this.workingPathForURL(e)),this.parse(t)))}resolveExternalURL(e){return/^[^\\/]/.test(e)?this.workingPath+"/"+e:e}workingPathForURL(e){const t=e.split(/[\\/]/g);return t.pop(),t.join("/")+"/"}parse(e){throw new Error("LoaderBase: Parse not implemented.")}}function $(l){let e;if(l instanceof DataView?e=l:e=new DataView(l),String.fromCharCode(e.getUint8(0))==="{")return null;let t="";for(let s=0;s<4;s++)t+=String.fromCharCode(e.getUint8(s));return t}class yn extends ce{parse(e){const t=new DataView(e),s=$(t);console.assert(s==="b3dm");const n=t.getUint32(4,!0);console.assert(n===1);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const o=t.getUint32(12,!0),i=t.getUint32(16,!0),a=t.getUint32(20,!0),c=t.getUint32(24,!0),u=28,h=e.slice(u,u+o+i),d=new we(h,0,o,i),f=u+o+i,p=e.slice(f,f+a+c),T=new ze(p,d.getData("BATCH_LENGTH"),0,a,c),m=f+a+c,g=new Uint8Array(e,m,r-m);return{version:n,featureTable:d,batchTable:T,glbBytes:g}}}class Gt extends yn{constructor(e=ae){super(),this.manager=e,this.adjustmentTransform=new M}parse(e){const t=super.parse(e),s=t.glbBytes.slice().buffer;return new Promise((n,r)=>{const o=this.manager,i=this.fetchOptions,a=o.getHandler("path.gltf")||new Ge(o);i.credentials==="include"&&i.mode==="cors"&&a.setCrossOrigin("use-credentials"),"credentials"in i&&a.setWithCredentials(i.credentials==="include"),i.headers&&a.setRequestHeader(i.headers);let c=this.workingPath;!/[\\/]$/.test(c)&&c.length&&(c+="/");const u=this.adjustmentTransform;a.parse(s,c,h=>{const{batchTable:d,featureTable:f}=t,{scene:p}=h,T=f.getData("RTC_CENTER");T&&(p.position.x+=T[0],p.position.y+=T[1],p.position.z+=T[2]),h.scene.updateMatrix(),h.scene.matrix.multiply(u),h.scene.matrix.decompose(h.scene.position,h.scene.quaternion,h.scene.scale),h.batchTable=d,h.featureTable=f,p.batchTable=d,p.featureTable=f,n(h)},r)})}}class Sn extends ce{parse(e){const t=new DataView(e),s=$(t);console.assert(s==="pnts");const n=t.getUint32(4,!0);console.assert(n===1);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const o=t.getUint32(12,!0),i=t.getUint32(16,!0),a=t.getUint32(20,!0),c=t.getUint32(24,!0),u=28,h=e.slice(u,u+o+i),d=new we(h,0,o,i),f=u+o+i,p=e.slice(f,f+a+c),T=new ze(p,d.getData("BATCH_LENGTH")||d.getData("POINTS_LENGTH"),0,a,c);return Promise.resolve({version:n,featureTable:d,batchTable:T})}}function wn(l){const e=l>>11,t=l>>5&63,s=l&31,n=Math.round(e/31*255),r=Math.round(t/63*255),o=Math.round(s/31*255);return[n,r,o]}const rt={RGB:"color",POSITION:"position"};class jt extends Sn{constructor(e=ae){super(),this.manager=e}parse(e){return super.parse(e).then(async t=>{const{featureTable:s}=t,n=new yt,r=s.header.extensions,o=new S;let i;if(r&&r["3DTILES_draco_point_compression"]){const{byteOffset:u,byteLength:h,properties:d}=r["3DTILES_draco_point_compression"],f=this.manager.getHandler("draco.drc");if(f==null)throw new Error("PNTSLoader: dracoLoader not available.");const p={};for(const g in d)if(g in rt&&g in d){const _=rt[g];p[_]=d[g]}const T={attributeIDs:p,attributeTypes:{position:"Float32Array",color:"Uint8Array"},useUniqueIDs:!0},m=s.getBuffer(u,h);i=await f.decodeGeometry(m,T),i.attributes.color&&(n.vertexColors=!0)}else{const u=s.getData("POINTS_LENGTH"),h=s.getData("POSITION",u,"FLOAT","VEC3"),d=s.getData("RGB",u,"UNSIGNED_BYTE","VEC3"),f=s.getData("RGBA",u,"UNSIGNED_BYTE","VEC4"),p=s.getData("RGB565",u,"UNSIGNED_SHORT","SCALAR"),T=s.getData("CONSTANT_RGBA",u,"UNSIGNED_BYTE","VEC4"),m=s.getData("POSITION_QUANTIZED",u,"UNSIGNED_SHORT","VEC3"),g=s.getData("QUANTIZED_VOLUME_SCALE",u,"FLOAT","VEC3"),_=s.getData("QUANTIZED_VOLUME_OFFSET",u,"FLOAT","VEC3");if(i=new wt,m){const y=new Float32Array(u*3);for(let A=0;A<u;A++)for(let E=0;E<3;E++){const x=3*A+E;y[x]=m[x]/65535*g[E]}o.x=_[0],o.y=_[1],o.z=_[2],i.setAttribute("position",new G(y,3,!1))}else i.setAttribute("position",new G(h,3,!1));if(f!==null)i.setAttribute("color",new G(f,4,!0)),n.vertexColors=!0,n.transparent=!0,n.depthWrite=!1;else if(d!==null)i.setAttribute("color",new G(d,3,!0)),n.vertexColors=!0;else if(p!==null){const y=new Uint8Array(u*3);for(let A=0;A<u;A++){const E=wn(p[A]);for(let x=0;x<3;x++){const b=3*A+x;y[b]=E[x]}}i.setAttribute("color",new G(y,3,!0)),n.vertexColors=!0}else if(T!==null){const y=new j(T[0],T[1],T[2]);n.color=y;const A=T[3]/255;A<1&&(n.opacity=A,n.transparent=!0,n.depthWrite=!1)}}["BATCH_LENGTH","NORMAL","NORMAL_OCT16P"].forEach(u=>{u in s.header&&console.warn('PNTSLoader: Unsupported FeatureTable feature "'.concat(u,'" detected.'))});const a=new Et(i,n);a.position.copy(o),t.scene=a,t.scene.featureTable=s;const c=s.getData("RTC_CENTER");return c&&(t.scene.position.x+=c[0],t.scene.position.y+=c[1],t.scene.position.z+=c[2]),t})}}class En extends ce{parse(e){const t=new DataView(e),s=$(t);console.assert(s==="i3dm");const n=t.getUint32(4,!0);console.assert(n===1);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const o=t.getUint32(12,!0),i=t.getUint32(16,!0),a=t.getUint32(20,!0),c=t.getUint32(24,!0),u=t.getUint32(28,!0),h=32,d=e.slice(h,h+o+i),f=new we(d,0,o,i),p=h+o+i,T=e.slice(p,p+a+c),m=new ze(T,f.getData("INSTANCES_LENGTH"),0,a,c),g=p+a+c,_=new Uint8Array(e,g,r-g);let y=null,A=null;if(u)y=_,A=Promise.resolve();else{const E=this.resolveExternalURL(Vt(_));A=fetch(E,this.fetchOptions).then(x=>{if(!x.ok)throw new Error('I3DMLoaderBase : Failed to load file "'.concat(E,'" with status ').concat(x.status," : ").concat(x.statusText));return x.arrayBuffer()}).then(x=>{y=new Uint8Array(x)})}return A.then(()=>({version:n,featureTable:f,batchTable:m,glbBytes:y}))}}const ot=new S,Ie=new S,Ne=new S,it=new S,Oe=new Ve,he=new S,de=new M;class zt extends En{constructor(e=ae){super(),this.manager=e,this.adjustmentTransform=new M}resolveExternalURL(e){return this.manager.resolveURL(super.resolveExternalURL(e))}parse(e){return super.parse(e).then(t=>{const{featureTable:s,batchTable:n}=t,r=t.glbBytes.slice().buffer;return new Promise((o,i)=>{const a=this.fetchOptions,c=this.manager,u=c.getHandler("path.gltf")||new Ge(c);a.credentials==="include"&&a.mode==="cors"&&u.setCrossOrigin("use-credentials"),"credentials"in a&&u.setWithCredentials(a.credentials==="include"),a.headers&&u.setRequestHeader(a.headers);let h=this.workingPath;/[\\/]$/.test(h)||(h+="/");const d=this.adjustmentTransform;u.parse(r,h,f=>{const p=s.getData("INSTANCES_LENGTH"),T=s.getData("POSITION",p,"FLOAT","VEC3"),m=s.getData("NORMAL_UP",p,"FLOAT","VEC3"),g=s.getData("NORMAL_RIGHT",p,"FLOAT","VEC3"),_=s.getData("SCALE_NON_UNIFORM",p,"FLOAT","VEC3"),y=s.getData("SCALE",p,"FLOAT","SCALAR");["RTC_CENTER","QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","EAST_NORTH_UP","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach(b=>{b in s.header&&console.warn('I3DMLoader: Unsupported FeatureTable feature "'.concat(b,'" detected.'))});const A=new Map,E=[];f.scene.traverse(b=>{if(b.isMesh){const{geometry:L,material:R}=b,C=new _t(L,R,p);C.position.copy(b.position),C.rotation.copy(b.rotation),C.scale.copy(b.scale),E.push(C),A.set(b,C)}});const x=new S;for(let b=0;b<p;b++)x.x+=T[b*3+0]/p,x.y+=T[b*3+1]/p,x.z+=T[b*3+2]/p;A.forEach((b,L)=>{const R=L.parent;R&&(R.remove(L),R.add(b),b.updateMatrixWorld(),b.position.copy(x).applyMatrix4(b.matrixWorld))});for(let b=0;b<p;b++){it.set(T[b*3+0]-x.x,T[b*3+1]-x.y,T[b*3+2]-x.z),m?(Ie.set(m[b*3+0],m[b*3+1],m[b*3+2]),Ne.set(g[b*3+0],g[b*3+1],g[b*3+2]),ot.crossVectors(Ne,Ie).normalize(),de.makeBasis(Ne,Ie,ot),Oe.setFromRotationMatrix(de)):Oe.set(0,0,0,1),y?he.setScalar(y[b]):_?he.set(_[b*3+0],_[b*3+1],_[b*3+2]):he.set(1,1,1),de.compose(it,Oe,he).multiply(d);for(let L=0,R=E.length;L<R;L++)E[L].setMatrixAt(b,de)}f.batchTable=n,f.featureTable=s,f.scene.batchTable=n,f.scene.featureTable=s,o(f)},i)})})}}class Rn extends ce{parse(e){const t=new DataView(e),s=$(t);console.assert(s==="cmpt",'CMPTLoader: The magic bytes equal "cmpt".');const n=t.getUint32(4,!0);console.assert(n===1,'CMPTLoader: The version listed in the header is "1".');const r=t.getUint32(8,!0);console.assert(r===e.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const o=t.getUint32(12,!0),i=[];let a=16;for(let c=0;c<o;c++){const u=new DataView(e,a,12),h=$(u),d=u.getUint32(4,!0),f=u.getUint32(8,!0),p=new Uint8Array(e,a,f);i.push({type:h,buffer:p,version:d}),a+=f}return{version:n,tiles:i}}}class Ln extends Rn{constructor(e=ae){super(),this.manager=e,this.adjustmentTransform=new M}parse(e){const t=super.parse(e),s=this.manager,n=this.adjustmentTransform,r=[];for(const o in t.tiles){const{type:i,buffer:a}=t.tiles[o];switch(i){case"b3dm":{const c=a.slice(),u=new Gt(s);u.workingPath=this.workingPath,u.fetchOptions=this.fetchOptions,u.adjustmentTransform.copy(n);const h=u.parse(c.buffer);r.push(h);break}case"pnts":{const c=a.slice(),u=new jt(s);u.workingPath=this.workingPath,u.fetchOptions=this.fetchOptions;const h=u.parse(c.buffer);r.push(h);break}case"i3dm":{const c=a.slice(),u=new zt(s);u.workingPath=this.workingPath,u.fetchOptions=this.fetchOptions,u.adjustmentTransform.copy(n);const h=u.parse(c.buffer);r.push(h);break}}}return Promise.all(r).then(o=>{const i=new re;return o.forEach(a=>{i.add(a.scene)}),{tiles:o,scene:i}})}}class Mn{constructor(){this.name="CESIUM_RTC"}afterRoot(e){if(e.parser.json.extensions&&e.parser.json.extensions.CESIUM_RTC){const{center:t}=e.parser.json.extensions.CESIUM_RTC;t&&(e.scene.position.x+=t[0],e.scene.position.y+=t[1],e.scene.position.z+=t[2])}}}class Cn extends ce{constructor(e=ae){super(),this.manager=e}parse(e){return new Promise((t,s)=>{const n=this.manager,r=this.fetchOptions;let o=n.getHandler("path.gltf")||n.getHandler("path.glb");o||(o=new Ge(n),o.register(()=>new Mn),r.credentials==="include"&&r.mode==="cors"&&o.setCrossOrigin("use-credentials"),"credentials"in r&&o.setWithCredentials(r.credentials==="include"),r.headers&&o.setRequestHeader(r.headers));let i=o.resourcePath||o.path||this.workingPath;!/[\\/]$/.test(i)&&i.length&&(i+="/"),o.parse(e,i,a=>{t(a)},s)})}}const fe=new M;class In extends re{constructor(e){super(),this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e}raycast(e,t){this.tilesRenderer.optimizeRaycast&&this.tilesRenderer.raycast(e,t)}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){this.parent===null?fe.copy(this.matrix):fe.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const t=fe.elements,s=this.matrixWorld.elements;let n=!1;for(let r=0;r<16;r++){const o=t[r],i=s[r];if(Math.abs(o-i)>Number.EPSILON){n=!0;break}}if(n){this.matrixWorld.copy(fe);const r=this.children;for(let o=0,i=r.length;o<i;o++)r[o].updateMatrixWorld()}}}}const Se=new M,Kt=new Ct,Pe=new S,pe=[];function qt(l,e){return l.distance-e.distance}function Wt(l,e,t){l.traverse(s=>{Object.getPrototypeOf(s).raycast.call(s,e,t)})}function Nn(l,e){Wt(l,e,pe),pe.sort(qt);const t=pe[0]||null;return pe.length=0,t}function Xt(l,e,t,s=null){const{group:n,activeTiles:r}=l;l.ensureChildrenArePreprocessed(e),s===null&&(s=Kt,Se.copy(n.matrixWorld).invert(),s.copy(t.ray).applyMatrix4(Se));const o=[],i=e.children;for(let u=0,h=i.length;u<h;u++){const d=i[u];if(!d.__used)continue;d.cached.boundingVolume.intersectRay(s,Pe)!==null&&(Pe.applyMatrix4(n.matrixWorld),o.push({distance:Pe.distanceToSquared(t.ray.origin),tile:d}))}o.sort(qt);let a=null,c=1/0;if(r.has(e)){const u=Nn(e.cached.scene,t);u&&(a=u,c=u.distance*u.distance)}for(let u=0,h=o.length;u<h;u++){const d=o[u],f=d.distance,p=d.tile;if(f>c)break;const T=Xt(l,p,t,s);if(T){const m=T.distance*T.distance;m<c&&(a=T,c=m)}}return a}function Qt(l,e,t,s,n=null){const{group:r,activeTiles:o}=l,{scene:i,boundingVolume:a}=e.cached;if(l.ensureChildrenArePreprocessed(e),n===null&&(n=Kt,Se.copy(r.matrixWorld).invert(),n.copy(t.ray).applyMatrix4(Se)),!e.__used||!a.intersectsRay(n))return;o.has(e)&&Wt(i,t,s);const c=e.children;for(let u=0,h=c.length;u<h;u++)Qt(l,c[u],t,s,n)}const me=new S,ge=new S,O=new S;class at{constructor(e=new Lt,t=new M){this.box=e.clone(),this.transform=t.clone(),this.inverseTransform=new M,this.points=new Array(8).fill().map(()=>new S),this.planes=new Array(6).fill().map(()=>new Ns)}update(){const{points:e,inverseTransform:t,transform:s,box:n}=this;t.copy(s).invert();const{min:r,max:o}=n;let i=0;for(let a=-1;a<=1;a+=2)for(let c=-1;c<=1;c+=2)for(let u=-1;u<=1;u+=2)e[i].set(a<0?r.x:o.x,c<0?r.y:o.y,u<0?r.z:o.z).applyMatrix4(s),i++;this.updatePlanes()}updatePlanes(){me.copy(this.box.min).applyMatrix4(this.transform),ge.copy(this.box.max).applyMatrix4(this.transform),O.set(0,0,1).transformDirection(this.transform),this.planes[0].setFromNormalAndCoplanarPoint(O,me),this.planes[1].setFromNormalAndCoplanarPoint(O,ge).negate(),O.set(0,1,0).transformDirection(this.transform),this.planes[2].setFromNormalAndCoplanarPoint(O,me),this.planes[3].setFromNormalAndCoplanarPoint(O,ge).negate(),O.set(1,0,0).transformDirection(this.transform),this.planes[4].setFromNormalAndCoplanarPoint(O,me),this.planes[5].setFromNormalAndCoplanarPoint(O,ge).negate()}intersectsFrustum(e){const{points:t}=this,{planes:s}=e;for(let n=0;n<6;n++){const r=s[n];let o=-1/0;for(let i=0;i<8;i++){const a=t[i],c=r.distanceToPoint(a);o=o<c?c:o}if(o<0)return!1}for(let n=0;n<6;n++){const r=this.planes[n];let o=-1/0;for(let i=0;i<8;i++){const a=e.points[i],c=r.distanceToPoint(a);o=o<c?c:o}if(o<0)return!1}return!0}}new It;new S;function On(l){const{x:e,y:t,z:s}=l;l.x=s,l.y=e,l.z=t}function Pn(l){return-l+Math.PI/2}const ct=new It,B=new S,I=new S,Te=new S,vn=new S,lt=new S,ve=new S,Fe=new S,ut=new S,Fn=1e-12,Dn=.1;class kn{constructor(e=1,t=1,s=1){this.radius=new S(e,t,s)}constructLatLonFrame(e,t,s){return this.getCartographicToPosition(e,t,0,ut),this.getCartographicToNormal(e,t,Fe),this.getNorthernTangent(e,t,ve),lt.crossVectors(ve,Fe),s.makeBasis(lt,ve,Fe).setPosition(ut)}getNorthernTangent(e,t,s,n=vn){let r=1,o=e+1e-7;e>Math.PI/4&&(r=-1,o=e-1e-7);const i=this.getCartographicToNormal(e,t,I).normalize(),a=this.getCartographicToNormal(o,t,Te).normalize();return n.crossVectors(i,a).normalize().multiplyScalar(r),s.crossVectors(n,i).normalize()}getCartographicToPosition(e,t,s,n){this.getCartographicToNormal(e,t,B);const r=this.radius;I.copy(B),I.x*=r.x**2,I.y*=r.y**2,I.z*=r.z**2;const o=Math.sqrt(B.dot(I));return I.divideScalar(o),n.copy(I).addScaledVector(B,s)}getPositionToCartographic(e,t){this.getPositionToSurfacePoint(e,I),this.getPositionToNormal(e,B);const s=Te.subVectors(e,I);return t.lon=Math.atan2(B.y,B.x),t.lat=Math.asin(B.z),t.height=Math.sign(s.dot(e))*s.length(),t}getCartographicToNormal(e,t,s){return ct.set(1,Pn(e),t),s.setFromSpherical(ct).normalize(),On(s),s}getPositionToNormal(e,t){const s=this.radius;return t.copy(e),t.x/=s.x**2,t.y/=s.y**2,t.z/=s.z**2,t.normalize(),t}getPositionToSurfacePoint(e,t){const s=this.radius,n=1/s.x**2,r=1/s.y**2,o=1/s.z**2,i=e.x*e.x*n,a=e.y*e.y*r,c=e.z*e.z*o,u=i+a+c,h=Math.sqrt(1/u),d=I.copy(e).multiplyScalar(h);if(u<Dn)return isFinite(h)?t.copy(d):null;const f=Te.set(d.x*n*2,d.y*r*2,d.z*o*2);let p=(1-h)*e.length()/(.5*f.length()),T=0,m,g,_,y,A,E,x,b,L,R,C;do{p-=T,_=1/(1+p*n),y=1/(1+p*r),A=1/(1+p*o),E=_*_,x=y*y,b=A*A,L=E*_,R=x*y,C=b*A,m=i*E+a*x+c*b-1,g=i*L*n+a*R*r+c*C*o;const Jt=-2*g;T=m/Jt}while(Math.abs(m)>Fn);return t.set(e.x*_,e.y*y,e.z*A)}calculateHorizonDistance(e,t){const s=this.calculateEffectiveRadius(e);return Math.sqrt(2*s*t+t**2)}calculateEffectiveRadius(e){const t=this.radius.x,n=1-this.radius.z**2/t**2,r=e*K.DEG2RAD,o=Math.sin(r)**2;return t/Math.sqrt(1-n*o)}getPositionElevation(e){this.getPositionToSurfacePoint(e,I);const t=Te.subVectors(e,I);return Math.sign(t.dot(e))*t.length()}}const H=Math.PI,_e=H/2,ee=new S,W=new S,X=new S,ht=new M;let se=0;const De=[];function Un(l=!1){return l?(De[se]||(De[se]=new S),se++,De[se-1]):new S}function dt(){se=0}class Bn extends kn{constructor(e,t,s,n=-_e,r=_e,o=0,i=2*H,a=0,c=0){super(e,t,s),this.latStart=n,this.latEnd=r,this.lonStart=o,this.lonEnd=i,this.heightStart=a,this.heightEnd=c}_getPoints(e=!1){const{latStart:t,latEnd:s,lonStart:n,lonEnd:r,heightStart:o,heightEnd:i}=this,a=K.mapLinear(.5,0,1,t,s),c=K.mapLinear(.5,0,1,n,r),u=Math.floor(n/_e)*_e,h=[[-H/2,0],[H/2,0],[0,u],[0,u+H/2],[0,u+H],[0,u+3*H/2],[t,r],[s,r],[t,n],[s,n],[0,n],[0,r],[a,c],[t,c],[s,c],[a,n],[a,r]],d=[],f=h.length;for(let p=0;p<=1;p++){const T=K.mapLinear(p,0,1,o,i);for(let m=0,g=f;m<g;m++){const[_,y]=h[m];if(_>=t&&_<=s&&y>=n&&y<=r){const A=Un(e);d.push(A),this.getCartographicToPosition(_,y,T,A)}}}return d}getBoundingBox(e,t){dt();const{latStart:s,latEnd:n,lonStart:r,lonEnd:o}=this;if(n-s<H/2){const c=K.mapLinear(.5,0,1,s,n),u=K.mapLinear(.5,0,1,r,o);this.getCartographicToNormal(c,u,X),W.set(0,0,1),ee.crossVectors(W,X),W.crossVectors(ee,X),t.makeBasis(ee,W,X)}else ee.set(1,0,0),W.set(0,1,0),X.set(0,0,1),t.makeBasis(ee,W,X);ht.copy(t).invert();const a=this._getPoints(!0);for(let c=0,u=a.length;c<u;c++)a[c].applyMatrix4(ht);e.makeEmpty(),e.setFromPoints(a)}getBoundingSphere(e,t){dt();const s=this._getPoints(!0);e.makeEmpty(),e.setFromPoints(s,t)}}const P=new S,v=new S,F=new S,ft=new S,pt=new S,mt=new S,Q=new Ct;class Hn{constructor(){this.sphere=null,this.obb=null,this.region=null,this.regionObb=null}intersectsRay(e){const t=this.sphere,s=this.obb||this.regionObb;return!(t&&!e.intersectsSphere(t)||s&&(Q.copy(e).applyMatrix4(s.inverseTransform),!Q.intersectsBox(s.box)))}intersectRay(e,t=null){const s=this.sphere,n=this.obb||this.regionObb;let r=-1/0,o=-1/0;s&&e.intersectSphere(s,pt)&&(r=s.containsPoint(e.origin)?0:e.origin.distanceToSquared(pt)),n&&(Q.copy(e).applyMatrix4(n.inverseTransform),Q.intersectBox(n.box,mt)&&(o=n.box.containsPoint(Q.origin)?0:Q.origin.distanceToSquared(mt)));const i=Math.max(r,o);return i===-1/0?null:(e.at(Math.sqrt(i),t),t)}distanceToPoint(e){const t=this.sphere,s=this.obb||this.regionObb;let n=-1/0,r=-1/0;return t&&(n=Math.max(t.distanceToPoint(e),0)),s&&(ft.copy(e).applyMatrix4(s.inverseTransform),r=s.box.distanceToPoint(ft)),n>r?n:r}intersectsFrustum(e){const t=this.obb||this.regionObb,s=this.sphere;return s&&!e.intersectsSphere(s)||t&&!t.intersectsFrustum(e)?!1:!!(s||t)}getOBB(e,t){const s=this.obb||this.regionObb;s?(e.copy(s.box),t.copy(s.transform)):(this.getAABB(e),t.identity())}getAABB(e){if(this.sphere)this.sphere.getBoundingBox(e);else{const t=this.obb||this.regionObb;e.copy(t.box).applyMatrix4(t.transform)}}getSphere(e){if(this.sphere)e.copy(this.sphere);else if(this.region)this.region.getBoundingSphere(e);else{const t=this.obb||this.regionObb;t.box.getBoundingSphere(e),e.applyMatrix4(t.transform)}}setObbData(e,t){const s=new at;P.set(e[3],e[4],e[5]),v.set(e[6],e[7],e[8]),F.set(e[9],e[10],e[11]);const n=P.length(),r=v.length(),o=F.length();P.normalize(),v.normalize(),F.normalize(),n===0&&P.crossVectors(v,F),r===0&&v.crossVectors(P,F),o===0&&F.crossVectors(P,v),s.transform.set(P.x,v.x,F.x,e[0],P.y,v.y,F.y,e[1],P.z,v.z,F.z,e[2],0,0,0,1).premultiply(t),s.box.min.set(-n,-r,-o),s.box.max.set(n,r,o),s.update(),this.obb=s}setSphereData(e,t,s,n,r){const o=new Mt;o.center.set(e,t,s),o.radius=n,o.applyMatrix4(r),this.sphere=o}setRegionData(e,t,s,n,r,o){const i=new Bn(ye,ye,An,t,n,e,s,r,o),a=new at;i.getBoundingBox(a.box,a.transform),a.update(),this.region=i,this.regionObb=a}}const Vn=new Os;function Gn(l,e,t,s){const n=Vn.set(l.normal.x,l.normal.y,l.normal.z,e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z);return s.set(-l.constant,-e.constant,-t.constant),s.applyMatrix3(n.invert()),s}class jn extends Ps{constructor(){super(),this.points=Array(8).fill().map(()=>new S)}setFromProjectionMatrix(e,t){super.setFromProjectionMatrix(e,t),this.calculateFrustumPoints()}calculateFrustumPoints(){const{planes:e,points:t}=this;[[e[0],e[3],e[4]],[e[1],e[3],e[4]],[e[0],e[2],e[4]],[e[1],e[2],e[4]],[e[0],e[3],e[5]],[e[1],e[3],e[5]],[e[0],e[2],e[5]],[e[1],e[2],e[5]]].forEach((n,r)=>{Gn(n[0],n[1],n[2],t[r])})}}const Yt=Symbol("INITIAL_FRUSTUM_CULLED"),Ae=new M,ke=new M,Y=new S,zn=new S(1,0,0),Kn=new S(0,1,0);function gt(l,e){l.traverse(t=>{t.frustumCulled=t[Yt]&&e})}class Xn extends xn{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel(t=>{gt(t,!e)}))}constructor(...e){super(...e),this.group=new In(this),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this.activeTiles=new Set,this.visibleTiles=new Set,this.optimizeRaycast=!0,this._autoDisableRendererCulling=!0,this._eventDispatcher=new vs,this.onLoadTileSet=null,this.onLoadModel=null,this.onDisposeModel=null,this.onTileVisibilityChange=null;const t=new Fs;t.setURLModifier(n=>this.preprocessURL?this.preprocessURL(n):n),this.manager=t;const s=this;this._overridenRaycast=function(n,r){s.optimizeRaycast||Object.getPrototypeOf(this).raycast.call(this,n,r)}}addEventListener(...e){this._eventDispatcher.addEventListener(...e)}hasEventListener(...e){this._eventDispatcher.hasEventListener(...e)}removeEventListener(...e){this._eventDispatcher.removeEventListener(...e)}dispatchEvent(...e){this._eventDispatcher.dispatchEvent(...e)}getBounds(...e){return console.warn("TilesRenderer: getBounds has been renamed to getBoundingBox."),this.getBoundingBox(...e)}getOrientedBounds(...e){return console.warn("TilesRenderer: getOrientedBounds has been renamed to getOrientedBoundingBox."),this.getOrientedBoundingBox(...e)}getBoundingBox(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t&&t.getAABB(e),!0}getOrientedBoundingBox(e,t){if(!this.root)return!1;const s=this.root.cached.boundingVolume;return s&&s.getOBB(e,t),!0}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t?(t.getSphere(e),!0):!1}forEachLoadedModel(e){this.traverse(t=>{const s=t.cached.scene;s&&e(s,t)})}raycast(e,t){if(this.root)if(e.firstHitOnly){const s=Xt(this,this.root,e);s&&t.push(s)}else Qt(this,this.root,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,s=this.cameraMap;return s.has(e)?!1:(s.set(e,new be),t.push(e),!0)}setResolution(e,t,s){const n=this.cameraMap;return n.has(e)?(t instanceof be?n.get(e).copy(t):n.get(e).set(t,s),!0):!1}setResolutionFromRenderer(e,t){const s=this.cameraMap;if(!s.has(e))return!1;const n=s.get(e);return t.getSize(n),n.multiplyScalar(t.getPixelRatio()),!0}deleteCamera(e){const t=this.cameras,s=this.cameraMap;if(s.has(e)){const n=t.indexOf(e);return t.splice(n,1),s.delete(e),!0}return!1}fetchTileSet(e,...t){const s=super.fetchTileSet(e,...t);return s.then(n=>{Promise.resolve().then(()=>{this.dispatchEvent({type:"load-tile-set",tileSet:n,url:e}),this.onLoadTileSet&&this.onLoadTileSet(n,e)})}),s}update(){const e=this.group,t=this.cameras,s=this.cameraMap,n=this.cameraInfo;if(t.length===0){console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.");return}for(;n.length>t.length;)n.pop();for(;n.length<t.length;)n.push({frustum:new jn,isOrthographic:!1,sseDenominator:-1,position:new S,invScale:-1,pixelSize:0});ke.copy(e.matrixWorld).invert(),Y.setFromMatrixScale(ke);const r=Y.x;Math.abs(Math.max(Y.x-Y.y,Y.x-Y.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let o=0,i=n.length;o<i;o++){const a=t[o],c=n[o],u=c.frustum,h=c.position,d=s.get(a);(d.width===0||d.height===0)&&console.warn("TilesRenderer: resolution for camera error calculation is not set.");const f=a.projectionMatrix.elements;if(c.isOrthographic=f[15]===1,c.isOrthographic){const p=2/f[0],T=2/f[5];c.pixelSize=Math.max(T/d.height,p/d.width)}else c.sseDenominator=2/f[5]/d.height;c.invScale=r,Ae.copy(e.matrixWorld),Ae.premultiply(a.matrixWorldInverse),Ae.premultiply(a.projectionMatrix),u.setFromProjectionMatrix(Ae),h.set(0,0,0),h.applyMatrix4(a.matrixWorld),h.applyMatrix4(ke)}super.update()}preprocessNode(e,t,s=null){super.preprocessNode(e,t,s);const n=new M;if(e.transform){const i=e.transform;for(let a=0;a<16;a++)n.elements[a]=i[a]}else n.identity();s&&n.premultiply(s.cached.transform);const r=new M().copy(n).invert(),o=new Hn;"sphere"in e.boundingVolume&&o.setSphereData(...e.boundingVolume.sphere,n),"box"in e.boundingVolume&&o.setObbData(e.boundingVolume.box,n),"region"in e.boundingVolume&&o.setRegionData(...e.boundingVolume.region),e.cached={loadIndex:0,transform:n,transformInverse:r,active:!1,inFrustum:[],boundingVolume:o,scene:null,geometry:null,material:null}}parseTile(e,t,s){t._loadIndex=t._loadIndex||0,t._loadIndex++;const r=t.content.uri.split(/[\\\/]/g);r.pop();const o=r.join("/"),i=this.fetchOptions,a=this.manager,c=t._loadIndex;let u=null;const h=this.rootTileSet.asset&&this.rootTileSet.asset.gltfUpAxis||"y",d=t.cached,f=d.transform,p=new M;switch(h.toLowerCase()){case"x":p.makeRotationAxis(Kn,-Math.PI/2);break;case"y":p.makeRotationAxis(zn,Math.PI/2);break;case"z":p.identity();break}const T=($(e)||s).toLowerCase();switch(T){case"b3dm":{const g=new Gt(a);g.workingPath=o,g.fetchOptions=i,g.adjustmentTransform.copy(p),u=g.parse(e);break}case"pnts":{const g=new jt(a);g.workingPath=o,g.fetchOptions=i,u=g.parse(e);break}case"i3dm":{const g=new zt(a);g.workingPath=o,g.fetchOptions=i,g.adjustmentTransform.copy(p),u=g.parse(e);break}case"cmpt":{const g=new Ln(a);g.workingPath=o,g.fetchOptions=i,g.adjustmentTransform.copy(p),u=g.parse(e).then(_=>_.scene);break}case"gltf":case"glb":const m=new Cn(a);m.workingPath=o,m.fetchOptions=i,u=m.parse(e);break;default:console.warn('TilesRenderer: Content type "'.concat(T,'" not supported.')),u=Promise.resolve(null);break}return u.then(m=>{let g,_;if(m.isObject3D?(g=m,_=null):(g=m.scene,_=m),t._loadIndex!==c)return;g.updateMatrix(),(T==="glb"||T==="gltf")&&g.matrix.multiply(p),g.matrix.premultiply(f),g.matrix.decompose(g.position,g.quaternion,g.scale),g.traverse(x=>{x[Yt]=x.frustumCulled}),gt(g,!this.autoDisableRendererCulling),g.traverse(x=>{x.raycast=this._overridenRaycast});const y=[],A=[],E=[];g.traverse(x=>{if(x.geometry&&A.push(x.geometry),x.material){const b=x.material;y.push(x.material);for(const L in b){const R=b[L];R&&R.isTexture&&E.push(R)}}}),d.materials=y,d.geometry=A,d.textures=E,d.scene=g,d.metadata=_,this.dispatchEvent({type:"load-model",scene:g,tile:t}),this.onLoadModel&&this.onLoadModel(g,t)})}disposeTile(e){const t=e.cached;if(t.scene){const s=t.materials,n=t.geometry,r=t.textures,o=t.scene.parent;for(let i=0,a=n.length;i<a;i++)n[i].dispose();for(let i=0,a=s.length;i<a;i++)s[i].dispose();for(let i=0,a=r.length;i<a;i++){const c=r[i];c.image instanceof ImageBitmap&&c.image.close(),c.dispose()}o&&o.remove(t.scene),this.dispatchEvent({type:"dispose-model",scene:t.scene,tile:e}),this.onDisposeModel&&this.onDisposeModel(t.scene,e),t.scene=null,t.materials=null,t.textures=null,t.geometry=null,t.metadata=null}this.activeTiles.delete(e),this.visibleTiles.delete(e),e._loadIndex++}setTileVisible(e,t){const s=e.cached.scene,n=this.visibleTiles,r=this.group;t?(r.add(s),n.add(e),s.updateMatrixWorld(!0)):(r.remove(s),n.delete(e)),this.dispatchEvent({type:"tile-visibility-change",scene:s,tile:e,visible:t}),this.onTileVisibilityChange&&this.onTileVisibilityChange(s,e,t)}setTileActive(e,t){const s=this.activeTiles;t?s.add(e):s.delete(e)}calculateError(e){const t=e.cached,s=t.inFrustum,n=this.cameras,r=this.cameraInfo,o=t.boundingVolume;let i=-1/0,a=1/0;for(let c=0,u=n.length;c<u;c++){if(!s[c])continue;const h=r[c],d=h.invScale;let f;if(h.isOrthographic){const p=h.pixelSize;f=e.geometricError/(p*d)}else{const T=o.distanceToPoint(h.position)*d,m=h.sseDenominator;f=e.geometricError/(T*m),a=Math.min(a,T)}i=Math.max(i,f)}e.__distanceFromCamera=a,e.__error=i}tileInView(e){const t=e.cached,s=t.boundingVolume,n=t.inFrustum,r=this.cameraInfo;let o=!1;for(let i=0,a=r.length;i<a;i++){const c=r[i].frustum;s.intersectsFrustum(c)?(o=!0,n[i]=!0):n[i]=!1}return o}}export{Xn as T};
