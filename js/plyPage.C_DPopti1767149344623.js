import{importShared as e}from"./3d-tiles-renderer.de6b_qgz1767149344623.js";import{ol as t,Kk as r}from"./index.Btae5S5d1767149344623.js";import{useLoader as n}from"./customShaderMaterial.vue_vue_type_script_setup_true_lang.C_pYeFAB1767149344623.js";import"./index.vue_vue_type_script_setup_true_lang.C9DbtXj-1767149344623.js";const{BufferGeometry:s,FileLoader:a,Float32BufferAttribute:o,Loader:i,Color:l,SRGBColorSpace:c}=await e("three"),u=new l;class p extends i{constructor(e){super(e),this.propertyNameMapping={},this.customPropertyMapping={}}load(e,t,r,n){const s=this,o=new a(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,function(r){try{t(s.parse(r))}catch(a){n?n(a):console.error(a),s.manager.itemError(e)}},r,n)}setPropertyNameMapping(e){this.propertyNameMapping=e}setCustomPropertyNameMapping(e){this.customPropertyMapping=e}parse(e){function t(e,t=0){let r="";const n=/^ply([\s\S]*)end_header(\r\n|\r|\n)/.exec(e);null!==n&&(r=n[1]);const s={comments:[],elements:[],headerLength:t,objInfo:""},a=r.split(/\r\n|\r|\n/);let o;function i(e,t){const r={type:e[0]};return"list"===r.type?(r.name=e[3],r.countType=e[1],r.itemType=e[2]):r.name=e[1],r.name in t&&(r.name=t[r.name]),r}for(let l=0;l<a.length;l++){let e=a[l];if(e=e.trim(),""===e)continue;const t=e.split(/\s+/),r=t.shift();switch(e=t.join(" "),r){case"format":s.format=t[0],s.version=t[1];break;case"comment":s.comments.push(e);break;case"element":void 0!==o&&s.elements.push(o),o={},o.name=t[0],o.count=parseInt(t[1]),o.properties=[];break;case"property":o.properties.push(i(t,y.propertyNameMapping));break;case"obj_info":s.objInfo=e;break;default:console.log("unhandled",r,t)}}return void 0!==o&&s.elements.push(o),s}function r(e,t){switch(t){case"char":case"uchar":case"short":case"ushort":case"int":case"uint":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":return parseInt(e);case"float":case"double":case"float32":case"float64":return parseFloat(e)}}function n(e,t){const n={};for(let s=0;s<e.length;s++){if(t.empty())return null;if("list"===e[s].type){const a=[],o=r(t.next(),e[s].countType);for(let n=0;n<o;n++){if(t.empty())return null;a.push(r(t.next(),e[s].itemType))}n[e[s].name]=a}else n[e[s].name]=r(t.next(),e[s].type)}return n}function a(){const e={indices:[],vertices:[],normals:[],uvs:[],faceVertexUvs:[],colors:[],faceVertexColors:[]};for(const t of Object.keys(y.customPropertyMapping))e[t]=[];return e}function i(e){const t=e.map(e=>e.name);function r(e){for(let r=0,n=e.length;r<n;r++){const n=e[r];if(t.includes(n))return n}return null}return{attrX:r(["x","px","posx"])||"x",attrY:r(["y","py","posy"])||"y",attrZ:r(["z","pz","posz"])||"z",attrNX:r(["nx","normalx"]),attrNY:r(["ny","normaly"]),attrNZ:r(["nz","normalz"]),attrS:r(["s","u","texture_u","tx"]),attrT:r(["t","v","texture_v","ty"]),attrR:r(["red","diffuse_red","r","diffuse_r"]),attrG:r(["green","diffuse_green","g","diffuse_g"]),attrB:r(["blue","diffuse_blue","b","diffuse_b"])}}function l(e,t){const r=a();let s,o;s=null!==(o=/end_header\s+(\S[\s\S]*\S|\S)\s*$/.exec(e))?o[1].split(/\s+/):[];const l=new f(s);e:for(let a=0;a<t.elements.length;a++){const e=t.elements[a],s=i(e.properties);for(let t=0;t<e.count;t++){const t=n(e.properties,l);if(!t)break e;h(r,e.name,t,s)}}return p(r)}function p(e){let t=new s;e.indices.length>0&&t.setIndex(e.indices),t.setAttribute("position",new o(e.vertices,3)),e.normals.length>0&&t.setAttribute("normal",new o(e.normals,3)),e.uvs.length>0&&t.setAttribute("uv",new o(e.uvs,2)),e.colors.length>0&&t.setAttribute("color",new o(e.colors,3)),(e.faceVertexUvs.length>0||e.faceVertexColors.length>0)&&(t=t.toNonIndexed(),e.faceVertexUvs.length>0&&t.setAttribute("uv",new o(e.faceVertexUvs,2)),e.faceVertexColors.length>0&&t.setAttribute("color",new o(e.faceVertexColors,3)));for(const r of Object.keys(y.customPropertyMapping))e[r].length>0&&t.setAttribute(r,new o(e[r],y.customPropertyMapping[r].length));return t.computeBoundingSphere(),t}function h(e,t,r,n){if("vertex"===t){e.vertices.push(r[n.attrX],r[n.attrY],r[n.attrZ]),null!==n.attrNX&&null!==n.attrNY&&null!==n.attrNZ&&e.normals.push(r[n.attrNX],r[n.attrNY],r[n.attrNZ]),null!==n.attrS&&null!==n.attrT&&e.uvs.push(r[n.attrS],r[n.attrT]),null!==n.attrR&&null!==n.attrG&&null!==n.attrB&&(u.setRGB(r[n.attrR]/255,r[n.attrG]/255,r[n.attrB]/255,c),e.colors.push(u.r,u.g,u.b));for(const t of Object.keys(y.customPropertyMapping))for(const n of y.customPropertyMapping[t])e[t].push(r[n])}else if("face"===t){const t=r.vertex_indices||r.vertex_index,s=r.texcoord;3===t.length?(e.indices.push(t[0],t[1],t[2]),s&&6===s.length&&(e.faceVertexUvs.push(s[0],s[1]),e.faceVertexUvs.push(s[2],s[3]),e.faceVertexUvs.push(s[4],s[5]))):4===t.length&&(e.indices.push(t[0],t[1],t[3]),e.indices.push(t[1],t[2],t[3])),null!==n.attrR&&null!==n.attrG&&null!==n.attrB&&(u.setRGB(r[n.attrR]/255,r[n.attrG]/255,r[n.attrB]/255,c),e.faceVertexColors.push(u.r,u.g,u.b),e.faceVertexColors.push(u.r,u.g,u.b),e.faceVertexColors.push(u.r,u.g,u.b))}}function d(e,t){const r={};let n=0;for(let s=0;s<t.length;s++){const a=t[s],o=a.valueReader;if("list"===a.type){const t=[],s=a.countReader.read(e+n);n+=a.countReader.size;for(let r=0;r<s;r++)t.push(o.read(e+n)),n+=o.size;r[a.name]=t}else r[a.name]=o.read(e+n),n+=o.size}return[r,n]}function m(e,t,r){function n(e,t,r){switch(t){case"int8":case"char":return{read:t=>e.getInt8(t),size:1};case"uint8":case"uchar":return{read:t=>e.getUint8(t),size:1};case"int16":case"short":return{read:t=>e.getInt16(t,r),size:2};case"uint16":case"ushort":return{read:t=>e.getUint16(t,r),size:2};case"int32":case"int":return{read:t=>e.getInt32(t,r),size:4};case"uint32":case"uint":return{read:t=>e.getUint32(t,r),size:4};case"float32":case"float":return{read:t=>e.getFloat32(t,r),size:4};case"float64":case"double":return{read:t=>e.getFloat64(t,r),size:8}}}for(let s=0,a=e.length;s<a;s++){const a=e[s];"list"===a.type?(a.countReader=n(t,a.countType,r),a.valueReader=n(t,a.itemType,r)):a.valueReader=n(t,a.type,r)}}let g;const y=this;if(e instanceof ArrayBuffer){const r=new Uint8Array(e),{headerText:n,headerLength:s}=function(e){let t=0,r=!0,n="";const s=[],a=(new TextDecoder).decode(e.subarray(0,5)),o=/^ply\r\n/.test(a);do{const a=String.fromCharCode(e[t++]);"\n"!==a&&"\r"!==a?n+=a:("end_header"===n&&(r=!1),""!==n&&(s.push(n),n=""))}while(r&&t<e.length);return!0===o&&t++,{headerText:s.join("\r")+"\r",headerLength:t}}(r),o=t(n,s);if("ascii"===o.format){g=l((new TextDecoder).decode(r),o)}else g=function(e,t){const r=a(),n="binary_little_endian"===t.format,s=new DataView(e,t.headerLength);let o,l=0;for(let a=0;a<t.elements.length;a++){const e=t.elements[a],c=e.properties,u=i(c);m(c,s,n);for(let t=0;t<e.count;t++){o=d(l,c),l+=o[1];const t=o[0];h(r,e.name,t,u)}}return p(r)}(e,o)}else g=l(e,t(e));return g}}class f{constructor(e){this.arr=e,this.i=0}empty(){return this.i>=this.arr.length}next(){return this.arr[this.i++]}}const{withAsyncContext:h,defineComponent:d}=await e("vue"),{unref:m,createElementVNode:g,openBlock:y,createElementBlock:x}=await e("vue"),v=["geometry"],w=d({__name:"ply",async setup(e){let t,r;const s=([t,r]=h(()=>n(p,"./plugins/gaussianSplatting/model/luigi.ply")),t=await t,r(),t);return s.computeVertexNormals(),(e,t)=>(y(),x("TresPoints",{geometry:m(s)},[...t[0]||(t[0]=[g("TresPointsMaterial",{size:.01,color:"#0000ff"},null,-1)])],8,v))}}),{defineComponent:b}=await e("vue"),{createElementVNode:_,unref:C,createVNode:T,Suspense:N,withCtx:z,openBlock:S,createBlock:V,mergeProps:B}=await e("vue"),{SRGBColorSpace:M,BasicShadowMap:R,NoToneMapping:P}=await e("three"),{reactive:k}=await e("vue"),j=b({__name:"plyPage",setup(e){const n=k({clearColor:"#ffffff",alpha:!1,shadowMapType:R,outputColorSpace:M,toneMapping:P});return(e,s)=>(S(),V(C(t),B(n,{"window-size":""}),{default:z(()=>[s[0]||(s[0]=_("TresPerspectiveCamera",{position:[3,3,3],fov:45,near:.1,far:1e3,"look-at":[0,0,0]},null,-1)),T(C(r)),s[1]||(s[1]=_("TresAmbientLight",{intensity:3},null,-1)),(S(),V(N,null,{default:z(()=>[T(w,{position:[0,.7,0]})]),_:1})),s[2]||(s[2]=_("TresDirectionalLight",{position:[6,2,4],intensity:2},null,-1)),s[3]||(s[3]=_("TresGridHelper",null,null,-1))]),_:1},16))}});export{j as default};
