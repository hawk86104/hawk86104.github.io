var ee=Object.defineProperty;var ae=(R,l,t)=>l in R?ee(R,l,{enumerable:!0,configurable:!0,writable:!0,value:t}):R[l]=t;var $=(R,l,t)=>(ae(R,typeof l!="symbol"?l+"":l,t),t);import{ct as re,aF as te,aw as ne,cH as oe,bf as M,at as H,cI as N,aI as O,ak as K,cb as se,l as U,v as z,cJ as ie,w as A,cK as Y,L as D,cL as le,cp as W,a1 as ue,aQ as ce,aD as de,o as _e,c as me,a0 as pe,Z as he,a9 as ve,cM as Q,cN as X,cO as ge,cP as j,aC as q,cQ as fe}from"./vendor.DUm4xHeP1713239655324.js";class Ee extends re{constructor(){super();$(this,"virtualScene",null);this.virtualScene=new te}add(...t){return this.virtualScene.add(...t),this}destructor(){this.virtualScene.traverse(t=>{t instanceof ne&&(t.geometry.dispose(),t.material.dispose(),t.material.map&&t.material.map.dispose(),this.virtualScene.remove(t))}),this.virtualScene=null}}class J extends oe{constructor(l){super(l),this.type=M}parse(l){const h=function(e,n){switch(e){case 1:console.error("THREE.RGBELoader Read Error: "+(n||""));break;case 2:console.error("THREE.RGBELoader Write Error: "+(n||""));break;case 3:console.error("THREE.RGBELoader Bad File Format: "+(n||""));break;default:case 4:console.error("THREE.RGBELoader: Error: "+(n||""))}return-1},g="\n",u=function(e,n,d){n=n||1024;let c=e.pos,s=-1,a=0,_="",r=String.fromCharCode.apply(null,new Uint16Array(e.subarray(c,c+128)));for(;0>(s=r.indexOf(g))&&a<n&&c<e.byteLength;)_+=r,a+=r.length,c+=128,r+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(c,c+128)));return-1<s?(d!==!1&&(e.pos+=a+s+1),_+r.slice(0,s)):!1},w=function(e){const n=/^#\?(\S+)/,d=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,i=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,c=/^\s*FORMAT=(\S+)\s*$/,s=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,a={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let _,r;if(e.pos>=e.byteLength||!(_=u(e)))return h(1,"no header found");if(!(r=_.match(n)))return h(3,"bad initial token");for(a.valid|=1,a.programtype=r[1],a.string+=_+"\n";_=u(e),_!==!1;){if(a.string+=_+"\n",_.charAt(0)==="#"){a.comments+=_+"\n";continue}if((r=_.match(d))&&(a.gamma=parseFloat(r[1])),(r=_.match(i))&&(a.exposure=parseFloat(r[1])),(r=_.match(c))&&(a.valid|=2,a.format=r[1]),(r=_.match(s))&&(a.valid|=4,a.height=parseInt(r[1],10),a.width=parseInt(r[2],10)),a.valid&2&&a.valid&4)break}return a.valid&2?a.valid&4?a:h(3,"missing image size specifier"):h(3,"missing format specifier")},y=function(e,n,d){const i=n;if(i<8||i>32767||e[0]!==2||e[1]!==2||e[2]&128)return new Uint8Array(e);if(i!==(e[2]<<8|e[3]))return h(3,"wrong scanline width");const c=new Uint8Array(4*n*d);if(!c.length)return h(4,"unable to allocate buffer space");let s=0,a=0;const _=4*i,r=new Uint8Array(4),I=new Uint8Array(_);let P=d;for(;P>0&&a<e.byteLength;){if(a+4>e.byteLength)return h(1);if(r[0]=e[a++],r[1]=e[a++],r[2]=e[a++],r[3]=e[a++],r[0]!=2||r[1]!=2||(r[2]<<8|r[3])!=i)return h(3,"bad rgbe scanline format");let x=0,S;for(;x<_&&a<e.byteLength;){S=e[a++];const B=S>128;if(B&&(S-=128),S===0||x+S>_)return h(3,"bad scanline data");if(B){const G=e[a++];for(let V=0;V<S;V++)I[x++]=G}else I.set(e.subarray(a,a+S),x),x+=S,a+=S}const Z=i;for(let B=0;B<Z;B++){let G=0;c[s]=I[B+G],G+=i,c[s+1]=I[B+G],G+=i,c[s+2]=I[B+G],G+=i,c[s+3]=I[B+G],s+=4}P--}return c},k=function(e,n,d,i){const c=e[n+3],s=Math.pow(2,c-128)/255;d[i+0]=e[n+0]*s,d[i+1]=e[n+1]*s,d[i+2]=e[n+2]*s,d[i+3]=1},F=function(e,n,d,i){const c=e[n+3],s=Math.pow(2,c-128)/255;d[i+0]=N.toHalfFloat(Math.min(e[n+0]*s,65504)),d[i+1]=N.toHalfFloat(Math.min(e[n+1]*s,65504)),d[i+2]=N.toHalfFloat(Math.min(e[n+2]*s,65504)),d[i+3]=N.toHalfFloat(1)},p=new Uint8Array(l);p.pos=0;const v=w(p);if(v!==-1){const e=v.width,n=v.height,d=y(p.subarray(p.pos),e,n);if(d!==-1){let i,c,s;switch(this.type){case H:s=d.length/4;const a=new Float32Array(s*4);for(let r=0;r<s;r++)k(d,r*4,a,r*4);i=a,c=H;break;case M:s=d.length/4;const _=new Uint16Array(s*4);for(let r=0;r<s;r++)F(d,r*4,_,r*4);i=_,c=M;break;default:console.error("THREE.RGBELoader: unsupported type: ",this.type);break}return{width:e,height:n,data:i,header:v.string,gamma:v.gamma,exposure:v.exposure,type:c}}}return null}setDataType(l){return this.type=l,this}load(l,t,T,m){function L(f,h){switch(f.type){case H:case M:"colorSpace"in f?f.colorSpace="srgb-linear":f.encoding=3e3,f.minFilter=O,f.magFilter=O,f.generateMipmaps=!1,f.flipY=!0;break}t&&t(f,h)}return super.load(l,L,T,m)}}const C={sunset:"venice/venice_sunset_1k.hdr",studio:"studio/poly_haven_studio_1k.hdr",city:"city/canary_wharf_1k.hdr",umbrellas:"outdoor/outdoor_umbrellas_1k.hdr",night:"outdoor/satara_night_1k.hdr",forest:"outood/mossy_forest_1k.hdr",snow:"outdoor/snowy_forest_path_01_1k.hdr",dawn:"kiara/kiara_1_dawn_1k.hdr",hangar:"indoor/small_hangar_01_1k.hdr",urban:"indoor/abandoned_games_room_02_1k.hdr",modern:"city/modern_buildings_2_1k.hdr",shangai:"city/shanghai_bund_1k.hdr"},ye="https://raw.githubusercontent.com/Tresjs/assets/main/textures/hdr/";async function Re(R,l){const{scene:t}=K(),{preset:T,blur:m,files:L=[],path:f="",background:h}=se(R),E=U(),b=z(()=>Array.isArray(L.value)),o=z(()=>b.value?ie:J),g=U(null);return A(()=>[L,f],async([u,w])=>{if(u.value.length>0&&!T.value){try{g.value=await Y(D(o),b.value?[D(u)]:D(u),y=>{w.value&&y.setPath(D(w))})}catch(y){throw new Error("Failed to load environment map: ".concat(y))}g.value&&(E.value=b.value?g.value[0]:g.value,E.value.mapping=b.value?le:W)}},{immediate:!0}),A(()=>E.value,u=>{t.value&&(t.value.environment=u)},{immediate:!0}),A(()=>[h.value,E.value],([u,w])=>{if(t.value){let y=l!=null&&l.value?l.value.texture:w;t.value.background=u?y:void 0}},{immediate:!0}),A(()=>m==null?void 0:m.value,u=>{t.value&&(t.value.backgroundBlurriness=u)},{immediate:!0}),A(T,async u=>{if(u&&u in C){const w=ye,y=C[u];try{g.value=await Y(J,y,k=>{w&&k.setPath(w)})}catch(k){throw new Error("Failed to load environment map: ".concat(k))}g.value&&(E.value=g.value,E.value.mapping=W)}else if(u&&!(u in C))throw new Error("Preset must be one of: ".concat(Object.keys(C).join(", ")))},{immediate:!0}),{texture:E}}const ke=ue({__name:"component",props:{background:{type:[Boolean,String],default:!1},blur:{default:0},files:{default:[]},path:{default:""},preset:{default:void 0},resolution:{default:256},near:{default:1},far:{default:1e3},frames:{default:1/0},useDefaultScene:{type:Boolean,default:!1}},async setup(R,{expose:l}){let t,T;const m=R,L=U(null);l({texture:L});const{extend:f,renderer:h,scene:E}=K();let b=null,o=U(null),g=null;const u=U(null);ce(()=>{var p,v;(p=u.value)==null||p.destructor(),(v=o.value)==null||v.dispose()});const{onBeforeLoop:w}=ve();let y=1;w(()=>{g&&u.value&&o.value&&(m.frames===1/0||y<m.frames)&&(m.useDefaultScene?g.update(h.value,E.value):g.update(h.value,fe(u.value.virtualScene)),y++)});const k=([t,T]=de(()=>Re(m,o)),t=await t,T(),t).texture,F=p=>{p?(E.value.environment=p.texture,m.background&&(E.value.background=p.texture)):(E.value.environment=k.value,m.background&&(E.value.background=k.value))};return A(k,p=>{o.value&&F(o.value)},{immediate:!0,deep:!0}),f({EnvSence:Ee}),A(()=>ge().default,p=>{var v,e,n;if(p&&(!o.value||o.value.texture.type!==M)&&(b=p(),Array.isArray(b)&&b.length>0&&typeof((v=b[0])==null?void 0:v.type)!="symbol")){(e=o.value)==null||e.dispose(),o.value=new Q(m.resolution),o.value.texture.type=M,g=new X(m.near,m.far,o.value),F(o.value);return}(n=o.value)==null||n.dispose(),o.value=null,F(null)},{immediate:!0,deep:!0}),L.value=k,A(()=>m.useDefaultScene,p=>{var v;p&&(!o.value||o.value.texture.type!==j)&&((v=o.value)==null||v.dispose(),o.value=new Q(m.resolution),g=new X(m.near,m.far,o.value),o.value.texture.type=j,o.value.texture.generateMipmaps=!1,o.value.texture.minFilter=q,o.value.texture.magFilter=q,F(o.value))},{immediate:!0}),(p,v)=>D(o)?(_e(),me("TresEnvSence",{key:0,ref_key:"envSence",ref:u},[pe(p.$slots,"default")],512)):he("",!0)}});export{ke as _};
