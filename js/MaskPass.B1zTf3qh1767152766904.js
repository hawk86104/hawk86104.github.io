import{importShared as t}from"./3d-tiles-renderer.CPyPbRB51767152766904.js";import{useTres as e,useLoop as n,Box_default as s,OrbitControls_default as a}from"./index.BGo9PN8R1767152766904.js";import{ClearMaskPass as r,EffectComposer as i,RenderPass as o,MaskPass as l,ShaderPass as d,CopyShader as u}from"./RenderPass.coonXiPa1767152766904.js";import{UnrealBloomPass as f}from"./UnrealBloomPass.BAfZwd9i1767152766904.js";import{Pass as h,FullScreenQuad as c}from"./Pass.DpHiOVBi1767152766904.js";const m={uniforms:{tDiffuse:{value:null},tDisp:{value:null},byp:{value:0},amount:{value:.08},angle:{value:.02},seed:{value:.02},seed_x:{value:.02},seed_y:{value:.02},distortion_x:{value:.5},distortion_y:{value:.6},col_s:{value:.05}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\t\tvoid main() {\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t}",fragmentShader:"\n\n\t\tuniform int byp; //should we apply the glitch ?\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform sampler2D tDisp;\n\n\t\tuniform float amount;\n\t\tuniform float angle;\n\t\tuniform float seed;\n\t\tuniform float seed_x;\n\t\tuniform float seed_y;\n\t\tuniform float distortion_x;\n\t\tuniform float distortion_y;\n\t\tuniform float col_s;\n\n\t\tvarying vec2 vUv;\n\n\n\t\tfloat rand(vec2 co){\n\t\t\treturn fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n\t\t}\n\n\t\tvoid main() {\n\t\t\tif(byp<1) {\n\t\t\t\tvec2 p = vUv;\n\t\t\t\tfloat xs = floor(gl_FragCoord.x / 0.5);\n\t\t\t\tfloat ys = floor(gl_FragCoord.y / 0.5);\n\t\t\t\t//based on staffantans glitch shader for unity https://github.com/staffantan/unityglitch\n\t\t\t\tfloat disp = texture2D(tDisp, p*seed*seed).r;\n\t\t\t\tif(p.y<distortion_x+col_s && p.y>distortion_x-col_s*seed) {\n\t\t\t\t\tif(seed_x>0.){\n\t\t\t\t\t\tp.y = 1. - (p.y + distortion_y);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tp.y = distortion_y;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif(p.x<distortion_y+col_s && p.x>distortion_y-col_s*seed) {\n\t\t\t\t\tif(seed_y>0.){\n\t\t\t\t\t\tp.x=distortion_x;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tp.x = 1. - (p.x + distortion_x);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tp.x+=disp*seed_x*(seed/5.);\n\t\t\t\tp.y+=disp*seed_y*(seed/5.);\n\t\t\t\t//base from RGB shift shader\n\t\t\t\tvec2 offset = amount * vec2( cos(angle), sin(angle));\n\t\t\t\tvec4 cr = texture2D(tDiffuse, p + offset);\n\t\t\t\tvec4 cga = texture2D(tDiffuse, p);\n\t\t\t\tvec4 cb = texture2D(tDiffuse, p - offset);\n\t\t\t\tgl_FragColor = vec4(cr.r, cga.g, cb.b, cga.a);\n\t\t\t\t//add noise\n\t\t\t\tvec4 snow = 200.*amount*vec4(rand(vec2(xs * seed,ys * seed*50.))*0.2);\n\t\t\t\tgl_FragColor = gl_FragColor+ snow;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tgl_FragColor=texture2D (tDiffuse, vUv);\n\t\t\t}\n\t\t}"},{DataTexture:v,FloatType:p,MathUtils:_,RedFormat:g,ShaderMaterial:x,UniformsUtils:y}=await t("three");class w extends h{constructor(t=64){super(),this.uniforms=y.clone(m.uniforms),this.material=new x({uniforms:this.uniforms,vertexShader:m.vertexShader,fragmentShader:m.fragmentShader}),this.goWild=!1,this._heightMap=this._generateHeightmap(t),this.uniforms.tDisp.value=this.heightMap,this._fsQuad=new c(this.material),this._curF=0,this._randX=0,this._generateTrigger()}render(t,e,n){this.uniforms.tDiffuse.value=n.texture,this.uniforms.seed.value=Math.random(),this.uniforms.byp.value=0,this._curF%this._randX==0||1==this.goWild?(this.uniforms.amount.value=Math.random()/30,this.uniforms.angle.value=_.randFloat(-Math.PI,Math.PI),this.uniforms.seed_x.value=_.randFloat(-1,1),this.uniforms.seed_y.value=_.randFloat(-1,1),this.uniforms.distortion_x.value=_.randFloat(0,1),this.uniforms.distortion_y.value=_.randFloat(0,1),this._curF=0,this._generateTrigger()):this._curF%this._randX<this._randX/5?(this.uniforms.amount.value=Math.random()/90,this.uniforms.angle.value=_.randFloat(-Math.PI,Math.PI),this.uniforms.distortion_x.value=_.randFloat(0,1),this.uniforms.distortion_y.value=_.randFloat(0,1),this.uniforms.seed_x.value=_.randFloat(-.3,.3),this.uniforms.seed_y.value=_.randFloat(-.3,.3)):0==this.goWild&&(this.uniforms.byp.value=1),this._curF++,this.renderToScreen?(t.setRenderTarget(null),this._fsQuad.render(t)):(t.setRenderTarget(e),this.clear&&t.clear(),this._fsQuad.render(t))}dispose(){this.material.dispose(),this.heightMap.dispose(),this._fsQuad.dispose()}_generateTrigger(){this._randX=_.randInt(120,240)}_generateHeightmap(t){const e=new Float32Array(t*t),n=t*t;for(let a=0;a<n;a++){const t=_.randFloat(0,1);e[a]=t}const s=new v(e,t,t,g,p);return s.needsUpdate=!0,s}}const{defineComponent:F}=await t("vue"),{unref:D,openBlock:M,createBlock:P}=await t("vue"),{watchEffect:T}=await t("vue"),C=await t("three"),b=F({__name:"MaskPass",setup(t){const a=new r,{camera:h,renderer:c,scene:m,sizes:v}=e();let p=null;const _=0,g=.972,x=.21;T(()=>{v.width.value&&!p&&(p=new i(c),p.renderTarget1.stencilBuffer=!0,p.renderTarget2.stencilBuffer=!0,((t,e,n,s,a)=>{const r=new o(t,e);p.addPass(r);const i=new f(new C.Vector2(s,a),g,x,_);p.addPass(i)})(m.value,h.value,0,v.width.value,v.height.value),((t,e)=>{const n=new C.DirectionalLight(16777215);n.position.set(550,100,550),n.intensity=1.6,t.add(n);let s=new C.Mesh(new C.BoxGeometry(1,1,1),new C.MeshNormalMaterial);s.position.set(1,2,4),t.add(s);var r=new o(t,e);r.clear=!1,p.addPass(r);const i=new l(t,e);p.addPass(i);const d=new w;p.addPass(d),p.addPass(a)})(new C.Scene,h.value,0,v.width.value,v.height.value),(()=>{const t=new d(u);t.renderToScreen=!0,p.addPass(t)})())});const{onRender:y}=n();return y(()=>{p&&(c.autoClear=!1,p.render())}),(t,e)=>(M(),P(D(s),{args:[1,1,1],color:"orange",position:[3,2,1]}))}}),{defineComponent:S}=await t("vue"),{createElementVNode:U,unref:B,createVNode:j,resolveComponent:k,withCtx:R,openBlock:I,createBlock:X}=await t("vue"),Q=S({__name:"MaskPass",setup:t=>(t,e)=>{const n=k("TresCanvas");return I(),X(n,{renderMode:"manual","window-size":""},{default:R(()=>[e[0]||(e[0]=U("TresPerspectiveCamera",{position:[10,10,10]},null,-1)),e[1]||(e[1]=U("TresAmbientLight",{intensity:1},null,-1)),j(B(a)),e[2]||(e[2]=U("TresGridHelper",{args:[10,10]},null,-1)),j(b)]),_:1})}});export{Q as default};
