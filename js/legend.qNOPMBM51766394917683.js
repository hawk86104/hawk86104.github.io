import{F as e,_ as a,K as o}from"./@tresjs.CC-VM6g11766394917683.js";import{V as t,o as n,u as s,k as i,G as r,cC as l,$ as c,p as d,cH as u,c2 as p,av as m,au as v,g as h,C as f,d as g,f as w,ak as y,y as b,bM as M,bW as S,ba as C,be as R}from"./three.F31Lz30M1766394917683.js";import{d as x,a as I,q as F,s as k,w as P,ab as j,r as L,c as A,g as E,G as $,o as D,I as T,h as _,M as z,F as B,W as H,H as q,v as O,N as V,e as J,b as W,u as G,a9 as N,aa as U,ah as K,m as Y}from"./@vue.BxPWGdWw1766394917683.js";import{_ as Z}from"./@fesjs.Ctw9zm691766394917683.js";import"./postprocessing.DnKKyAPS1766394917683.js";import"./@vueuse.PX2Ih8Bm1766394917683.js";import"./vue-router.BpdVHiiA1766394917683.js";import"./lodash-es.DWe8oqPO1766394917683.js";import"./pinia.DlDVALGD1766394917683.js";import"./@qlin.y-0Z8WnK1766394917683.js";import"./@babel.BPq7uOAK1766394917683.js";import"./@floating-ui.Bhq4ibgf1766394917683.js";import"./@juggle.Vc7cP4_P1766394917683.js";const Q=x({__name:"legend",props:{deviceConfig:{},title:{default:"SYSTEM MONITOR"},panelPosition:{default:()=>({top:"20px",right:"20px"})},panelWidth:{default:"220px"},statusDotColor:{default:"#0f0"},sceneBackground:{default:1710618},sceneFogColor:{default:1710618},sceneFogRange:{default:()=>[10,30]},groundColor:{default:1381653},groundSize:{default:()=>[30,30]},gridSize:{default:30},gridDivisions:{default:30},gridColor1:{default:5592405},gridColor2:{default:2236962},ambientLightIntensity:{default:.8},directionalLightIntensity:{default:1.2},directionalLightPosition:{default:()=>[5,15,7]},fillLightIntensity:{default:.3},fillLightPosition:{default:()=>[-5,5,-5]},cameraInitialPosition:{default:()=>[0,5,10]},legendCameraPosition:{default:()=>[2,1.5,2.5]},legendCameraLookAt:{default:()=>[0,0,0]},legendCameraFov:{default:50},autoRotateSpeed:{default:.5},cameraMoveLerp:{default:.05},cameraFocusOffset:{default:()=>[0,3,5]},deviceRotationSpeed:{default:.01},pulseBaseIntensity:{default:.3},pulseRange:{default:1.5},pulseFrequency:{default:3}},setup(o,{expose:x}){const L=o,A=e(),{camera:E,renderer:$,scene:D,controls:T}=A,{onRender:_}=a(),z=new f,B=I([]),H=I([]),q=I(null),O=I(new t),V=I(new t),J=I(!1),W=e=>new Promise((a,o)=>{if("model"===e.type&&e.modelUrl){return void(new r).load(e.modelUrl,o=>{const t=o.scene,n=e.modelScale||1;t.scale.set(n,n,n),a(t)},void 0,o)}const t=(i=e.color,new s({color:5592405,emissive:i,emissiveIntensity:.5,roughness:.3,metalness:.8}));var i;let l;l="cube"===e.type?(e=>{const a=new w,o=new n(new y(1.2,1.2,1.2),e);a.add(o);const t=new n(new y(1.4,1.4,1.4),new b({color:e.emissive.getHex(),wireframe:!0,transparent:!0,opacity:.15}));return a.add(t),a})(t):"sphere"===e.type?(e=>{const a=new w,o=new n(new M(.7,1),e);a.add(o);const t=new n(new S(1,.05,6,30),new b({color:e.emissive.getHex(),transparent:!0,opacity:.5}));return t.rotation.x=Math.PI/2,a.add(t),a})(t):(e=>{const a=new w,o=new n(new C(.6,1.5,6),e);o.position.y=.2,a.add(o);const t=new n(new R(.8,.8,.1,6),e);return t.position.y=-.6,a.add(t),a})(t),a(l)}),G=async()=>{const e=L.deviceConfig.map(async e=>{try{const a=await W(e),o=[];a.traverse(a=>{if(a instanceof n){a.castShadow=!0,a.receiveShadow=!0;const t=a.material;(Array.isArray(t)?t:[t]).forEach(a=>{a instanceof s&&(a.emissive&&a.emissive instanceof i?a.emissive.set(e.color):a.emissive=new i(e.color),a.emissiveIntensity=.5,o.push(j(a)))})}}),a.position.set(...e.position),D.value&&D.value.add(j(a));const r=new t(...e.position);B.value.push({config:e,materials:o,mainMesh:j(a),originalPosition:r,anchorId:`anchor-${e.id}`})}catch(a){console.error(`加载模型 ${e.id} 失败`,a)}});await Promise.all(e)},N=()=>{if(!($&&D.value&&E.value&&q.value))return;const e=z.getElapsedTime();if(J.value&&E.value instanceof h&&T.value){const e=T.value;E.value.position.lerp(O.value,L.cameraMoveLerp),"target"in e&&e.target instanceof t&&e.target.lerp(V.value,L.cameraMoveLerp),E.value.position.distanceTo(O.value)<.01&&(E.value.position.copy(O.value),"target"in e&&e.target instanceof t&&e.target.copy(V.value),J.value=!1,"autoRotate"in e&&(e.autoRotate=!0),"dampingFactor"in e&&(e.dampingFactor=.005))}if(B.value.forEach(a=>{const o=a.config.speed||1,t=.5*(Math.sin(e*L.pulseFrequency*o)+1);a.materials.forEach(e=>{e.emissiveIntensity=L.pulseBaseIntensity+t*L.pulseRange}),a.mainMesh.rotation.y+=L.deviceRotationSpeed*o}),T.value){const e=T.value;"update"in e&&"function"==typeof e.update&&e.update()}const a=$.getDrawingBufferSize(new g);$.setViewport(0,0,a.x,a.y),$.setScissor(0,0,a.x,a.y),$.setScissorTest(!1),$.clear(),$.render(D.value,E.value),$.setScissorTest(!0),$.clearDepth(),B.value.forEach(e=>{const a=document.getElementById(e.anchorId);if(!a)return;const o=a.getBoundingClientRect(),t=$.getPixelRatio();if(o.bottom<0||o.top>window.innerHeight)return;const n=e.mainMesh.position.clone(),s=[];B.value.forEach(a=>{s.push(a.mainMesh.visible),a!==e&&(a.mainMesh.visible=!1)});const i=[];H.value.forEach(e=>{i.push(e.visible),e.visible=!1}),e.mainMesh.position.set(0,0,0),e.mainMesh.visible=!0;const r=o.width*t,l=o.height*t,c=o.left*t,d=(window.innerHeight-o.bottom)*t;$.setScissor(c,d,r,l),$.setViewport(c,d,r,l),$.render(D.value,q.value),e.mainMesh.position.copy(n),B.value.forEach((e,a)=>{e.mainMesh.visible=s[a]}),H.value.forEach((e,a)=>{e.visible=i[a]})}),$.setScissorTest(!1)};F(async()=>{await k(),(()=>{if(!D.value||!$||!E.value)return;L.sceneBackground,D.value.background=new i(L.sceneBackground),"number"==typeof L.sceneFogColor?D.value.fog=new l(L.sceneFogColor,L.sceneFogRange[0],L.sceneFogRange[1]):D.value.fog=new l(new i(L.sceneFogColor),L.sceneFogRange[0],L.sceneFogRange[1]),$.shadowMap&&($.shadowMap.enabled=!0,$.shadowMap.type=c);const e=new d(...L.groundSize),a=new s({color:L.groundColor,metalness:.1,roughness:.8}),o=new n(e,a);o.rotation.x=-Math.PI/2,o.receiveShadow=!0,D.value.add(o),H.value.push(o);const t=new u(L.gridSize,L.gridDivisions,L.gridColor1,L.gridColor2);D.value.add(t),H.value.push(t);const r=new p(16777215,L.ambientLightIntensity);D.value.add(r);const f=new m(16777215,L.directionalLightIntensity);f.position.set(...L.directionalLightPosition),f.castShadow=!0,f.shadow.mapSize.width=2048,f.shadow.mapSize.height=2048,f.shadow.camera.near=.5,f.shadow.camera.far=50,f.shadow.camera.left=-15,f.shadow.camera.right=15,f.shadow.camera.top=15,f.shadow.camera.bottom=-15,D.value.add(f);const g=new v(16777215,L.fillLightIntensity,20);if(g.position.set(...L.fillLightPosition),D.value.add(g),E.value instanceof h&&E.value.position.set(...L.cameraInitialPosition),T.value){const e=T.value;"autoRotate"in e&&(e.autoRotate=!0,e.autoRotateSpeed=L.autoRotateSpeed)}q.value=new h(L.legendCameraFov,1,.1,50),q.value.position.set(...L.legendCameraPosition),q.value.lookAt(...L.legendCameraLookAt)})(),await G(),_(N)}),P(()=>L.deviceConfig,async(e,a)=>{if(!a||0===a.length)return void(await G());const o=new Set(B.value.map(e=>e.config.id)),r=e.filter(e=>!o.has(e.id));if(r.length>0)for(const u of r)try{const e=await W(u),a=[];e.traverse(e=>{if(e instanceof n){e.castShadow=!0,e.receiveShadow=!0;const o=e.material;(Array.isArray(o)?o:[o]).forEach(e=>{e instanceof s&&(e.emissive&&e.emissive instanceof i?e.emissive.set(u.color):e.emissive=new i(u.color),e.emissiveIntensity=.5,a.push(j(e)))})}}),e.position.set(...u.position),D.value&&D.value.add(j(e));const o=new t(...u.position);B.value.push({config:u,materials:a,mainMesh:j(e),originalPosition:o,anchorId:`anchor-${u.id}`})}catch(d){console.error(`加载模型 ${u.id} 失败`,d)}const l=new Set(e.map(e=>e.id)),c=B.value.filter(e=>!l.has(e.config.id));c.length>0&&(c.forEach(e=>{D.value&&(D.value.remove(e.mainMesh),e.mainMesh.traverse(e=>{e instanceof n&&(e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose()))}))}),B.value=B.value.filter(e=>l.has(e.config.id)))},{deep:!0});return x({handleDeviceClick:e=>{const a=B.value.find(a=>a.config.id===e);a&&(e=>{if(!E.value||!T.value)return;const a=T.value;"autoRotate"in a&&(a.autoRotate=!1);const o=new t(...L.cameraFocusOffset),n=e.clone().add(o);V.value.copy(e),O.value.copy(n),J.value=!0,"enableDamping"in a&&(a.enableDamping=!0,a.dampingFactor=.05)})(a.mainMesh.position)},addRandomMesh:()=>{const e=["box","sphere","cone","cylinder","torus","octahedron","tetrahedron"],a=e[Math.floor(Math.random()*e.length)],o={box:"cube",sphere:"sphere",cone:"cone",cylinder:"cube",torus:"cube",octahedron:"sphere",tetrahedron:"cone"}[a]||"cube",t=15*(Math.random()-.5),n=3*Math.random()+.5,s=15*(Math.random()-.5),i=[65535,16711765,4521728,16755200,11141375,65450,16711850],r=i[Math.floor(Math.random()*i.length)];return{id:`random-mesh-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:{box:"立方体",sphere:"球体",cone:"圆锥",cylinder:"圆柱",torus:"圆环",octahedron:"八面体",tetrahedron:"四面体"}[a]||"形状",type:o,color:r,position:[t,n,s],speed:.5+1.5*Math.random(),author:"随机生成"}}}),(e,a)=>null}}),X={class:"legend-container"},ee={class:"legend-list"},ae=["id","onClick"],oe=["id"],te={class:"legend-info"},ne={class:"item-name"},se={class:"item-status"},ie={class:"item-value"},re=Z(x({__name:"legend",setup(e){const a=I([{id:"core-reactor",name:"T",type:"cube",color:65535,position:[0,0,0],speed:1,author:"Jsonco"},{id:"sensor-array",name:"V",type:"sphere",color:16711765,position:[-4,0,2],speed:1.5,author:"Jsonco"},{id:"storage-unit",name:"T",type:"cone",color:4521728,position:[4,0,-2],speed:.8,author:"Jsonco"}]),t=L({windowSize:!0,alpha:!0,antialias:!0}),n=L({enableDamping:!0,enableZoom:!0,enablePan:!0,enableRotate:!0,makeDefault:!0,autoRotate:!0,autoRotateSpeed:.5}),s=I(null),i={top:"20px",right:"20px"},r=A(()=>{const e=i||{};return{top:e&&"number"==typeof e.top?`${e.top}px`:e?.top||"20px",right:e&&"number"==typeof e.right?`${e.right}px`:e?.right||"20px",bottom:e&&"number"==typeof e.bottom?`${e.bottom}px`:e?.bottom||void 0,left:e&&"number"==typeof e.left?`${e.left}px`:e?.left||void 0,width:"220px"}}),l=()=>{if(s.value){const e=s.value.addRandomMesh();e&&a.value.push(e)}};return(e,i)=>{const c=E("TresCanvas");return D(),$("div",X,[T("div",{class:"legend-panel",style:V(r.value)},[T("div",{class:"legend-header"},[T("span",{class:"legend-title"},z("图例")),T("button",{class:"add-mesh-btn",onClick:l},[...i[0]||(i[0]=[T("span",{class:"btn-icon"},"+",-1),T("span",{class:"btn-text"},"添加随机形状",-1)])])]),T("div",ee,[(D(!0),$(B,null,H(a.value,e=>(D(),$("div",{key:e.id,id:`item-${e.id}`,class:"legend-item",onClick:a=>{return o=e.id,void(s.value&&s.value.handleDeviceClick(o));var o}},[T("div",{id:`anchor-${e.id}`,class:"legend-icon-anchor"},null,8,oe),T("div",te,[T("span",ne,z(e.name),1),T("span",se,[i[1]||(i[1]=O(" Author: ",-1)),T("span",ie,z(e.author),1)])]),e.color?(D(),$("div",{key:0,class:"corner-deco",style:V({borderColor:`#${e.color.toString(16).padStart(6,"0")}`})},null,4)):q("",!0)],8,ae))),128))])],4),_(c,Y({clearColor:"#1A1A1A"},t),{default:J(()=>[i[2]||(i[2]=T("TresPerspectiveCamera",{fov:60,near:.1,far:1e3,position:[0,5,10]},null,-1)),i[3]||(i[3]=T("TresAmbientLight",{intensity:.8},null,-1)),_(G(o),N(U(n)),null,16),(D(),W(K,null,{default:J(()=>[_(Q,{ref_key:"legendRef",ref:s,"device-config":a.value},null,8,["device-config"])]),_:1}))]),_:1},16)])}}}),[["__scopeId","data-v-bd9b39fa"]]);export{re as default};
