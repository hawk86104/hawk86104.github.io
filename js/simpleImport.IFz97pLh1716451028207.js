var R=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,A=Object.prototype.propertyIsEnumerable;var F=(t,e)=>{var n={};for(var r in t)Z.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(t!=null&&R)for(var r of R(t))e.indexOf(r)<0&&A.call(t,r)&&(n[r]=t[r]);return n};import{dz as I,a1 as z,dA as q,ak as V,aq as Y,aO as b,a7 as Q,a9 as X,b5 as ee,a2 as B,a3 as te,a4 as ne,a5 as re,ad as oe,a6 as se,o as J,c as ie,a as S,E as _,a8 as ae,L as M,bb as ce,G as le,Y as O,ac as pe,aa as ue,ab as de,x as me,ag as fe}from"./vendor.KwxG0fE31716451028207.js";import{J as ve,F as he,g as x,i as ge,e as we}from"./utils.13q4g9BV1716451028207.js";import"./_commonjsHelpers.5-cIlDoe1716451028207.js";import"./_commonjs-dynamic-modules.h-SxKiO41716451028207.js";window.THREE=I;function v(t,e){for(let n=0,r=t.length;n<r;n++)t[n](e)}const a={init:[],start:[],stop:[],keydown:[],keyup:[],pointerdown:[],pointerup:[],pointermove:[],update:[]},ye=()=>{},be=(t,e,n,r,o)=>{const s=o.scripts||{};let l="player,renderer,scene,camera";const m={};for(const f in a)l+=",".concat(f),m[f]=f;const C=JSON.stringify(m).replace(/\"/g,"");for(const f in s){let w=f;f===o.scene.object.uuid&&(w=e.uuid);const h=e.getObjectByProperty("uuid",w,!0);if(h===void 0){console.warn("APP.Player: Script without object.",w);continue}const P=s[f];for(let E=0;E<P.length;E++){const $=P[E],j=new Function(l,"".concat($.source,"\nreturn ").concat(C,";")).bind(h)({width:r.width.value,height:r.height.value,setCamera:ye},t,e,n);for(const g in j)if(j[g]!==void 0){if(a[g]===void 0){console.warn("APP.Player: Event type not supported (",g,")");continue}a[g].push(j[g].bind(h))}}}v(a.init,null)};function G(t){v(a.keydown,t)}function H(t){v(a.keyup,t)}function U(t){v(a.pointerdown,t)}function W(t){v(a.pointerup,t)}function K(t){v(a.pointermove,t)}const Ee=()=>{document.addEventListener("keydown",G),document.addEventListener("keyup",H),document.addEventListener("pointerdown",U),document.addEventListener("pointerup",W),document.addEventListener("pointermove",K),v(a.start,null)},$e=()=>{document.removeEventListener("keydown",G),document.removeEventListener("keyup",H),document.removeEventListener("pointerdown",U),document.removeEventListener("pointerup",W),document.removeEventListener("pointermove",K),v(a.stop,null),a.init=[],a.start=[],a.stop=[],a.keydown=[],a.keyup=[],a.pointerdown=[],a.pointerup=[],a.pointermove=[],a.update=[]},je=(t,e)=>{v(a.update,{time:t,delta:e})},Le=t=>{const e="const scriptsJson = \n".concat(JSON.stringify(t),"\n");return"/* eslint-disable prefer-rest-params */\n/* eslint-disable no-undefined */\n/* eslint-disable guard-for-in */\nimport * as THREE from 'three'\n\nwindow.THREE = THREE // Used by APP Scripts.\nconst Grscwh = { scene: null, renderer: null, camera: null, sizes: null }\nconst player = {\n	get renderer() {\n		return Grscwh.renderer?.value\n	},\n	loader: new THREE.TextureLoader(),\n	get scene() {\n			return Grscwh.scene?.value\n	},\n	get camera() {\n			return Grscwh.camera?.value\n	},\n	get width() {\n			return Grscwh.sizes?.width?.value\n	},\n	get height() {\n			return Grscwh.sizes?.height?.value\n	},\n	get dom() {\n			return Grscwh.renderer?.value.domElement.parentElement\n	},\n	get canvas() {\n			return Grscwh.renderer?.value.domElement\n	},\n	events: {},\n	init(scene, renderer, camera, sizes) {\n			Grscwh.scene = scene\n			Grscwh.renderer = renderer\n			Grscwh.camera = camera\n			Grscwh.sizes = sizes\n	},\n	load(sceneObject) {\n		".concat(e,"\n		this.events = {\n				init: [],\n				start: [],\n				stop: [],\n				keydown: [],\n				keyup: [],\n				pointerdown: [],\n				pointerup: [],\n				pointermove: [],\n				update: [],\n		}\n		let scriptWrapParams = 'player,renderer,scene,camera'\n		const scriptWrapResultObj = {}\n\n		for (const eventKey in this.events) {\n				scriptWrapParams += `,${eventKey}`\n				scriptWrapResultObj[eventKey] = eventKey\n		}\n		const scriptWrapResult = JSON.stringify(scriptWrapResultObj).replace(/\\\"/g, '')\n		for (const uuid in scriptsJson) {\n				let curUuid = uuid\n				//这里解决一个问题 目前并没有把 主场景scene直接替换而是通过group 加进入的，所以 如果事件是基于主场景scene 那么替换这个uuid为现在tres主场景的uuid\n				if (uuid === sceneObject.uuid) {\n						curUuid = this.scene.uuid\n				}\n				const object = this.scene.getObjectByProperty('uuid', curUuid, true)\n				if (object === undefined) {\n						console.warn('player: Script without object.', curUuid)\n						continue\n				}\n				const scripts = scriptsJson[uuid]\n				for (let i = 0; i < scripts.length; i++) {\n						const script = scripts[i]\n						// eslint-disable-next-line no-new-func\n						const functions = new Function(scriptWrapParams, `${script.source}\nreturn ${scriptWrapResult};`).bind(object)(\n								this,\n								this.renderer,\n								this.scene,\n								this.camera,\n						)\n						for (const name in functions) {\n								if (functions[name] === undefined) continue\n								if (this.events[name] === undefined) {\n										console.warn('player: Event type not supported (', name, ')')\n										continue\n								}\n								this.events[name].push(functions[name].bind(object))\n						}\n				}\n				this.dispatch(this.events.init, arguments)\n		}\n	},\n	dispatch(array, event) {\n		for (let i = 0, l = array.length; i < l; i++) {\n				array[i](event)\n		}\n	},\n	setCamera(value) {\n			console.warn('暂时不考虑摄像机的设置函数', value)\n			// camera = value\n			// camera.aspect = this.width / this.height\n			// camera.updateProjectionMatrix()\n	},\n	setScene(value) {\n			console.warn('暂时不考虑场景的设置函数', value)\n			// scene = value\n	},\n	setPixelRatio(value) {\n			console.warn('暂时不考虑像素比的设置函数', value)\n	},\n	setSize(value) {\n			console.warn('暂时不考虑尺寸的设置函数', value)\n	},\n	dispose() {\n			// renderer.dispose();\n			// camera = undefined;\n			// scene = undefined;\n			console.warn('暂时不考虑释放资源的函数')\n	},\n	onKeyDown(event) {\n		player.dispatch(player.events.keydown, event)\n	},\n	onKeyUp(event) {\n			player.dispatch(player.events.keyup, event)\n	},\n	onPointerDown(event) {\n			player.dispatch(player.events.pointerdown, event)\n	},\n	onPointerUp(event) {\n			player.dispatch(player.events.pointerup, event)\n	},\n	onPointerMove(event) {\n			player.dispatch(player.events.pointermove, event)\n	},\n	play() {\n			document.addEventListener('keydown', this.onKeyDown)\n			document.addEventListener('keyup', this.onKeyUp)\n			document.addEventListener('pointerdown', this.onPointerDown)\n			document.addEventListener('pointerup', this.onPointerUp)\n			document.addEventListener('pointermove', this.onPointerMove)\n			this.dispatch(this.events.start, null)\n			//renderer.setAnimationLoop( animate ); 播放是自动的\n	},\n	stop() {\n			document.removeEventListener('keydown', this.onKeyDown)\n			document.removeEventListener('keyup', this.onKeyUp)\n			document.removeEventListener('pointerdown', this.onPointerDown)\n			document.removeEventListener('pointerup', this.onPointerUp)\n			document.removeEventListener('pointermove', this.onPointerMove)\n			this.dispatch(this.events.stop, arguments)\n			// renderer.setAnimationLoop( null );播放是自动的\n	},\n	render(elapsed, delta) {\n			this.dispatch(this.events.update, { time: elapsed, delta })\n	},\n}\nexport default player\n")};let k=[];const Ce=(t,e,n,r)=>{const m=n.object,{uuid:o}=m,s=F(m,["uuid"]),l=JSON.parse(JSON.stringify(n));return l.object=s,'\n<template>\n    <loading />\n	<TresCanvas v-bind="state">\n		'.concat(r.orbitControls?"<OrbitControls />":"","\n		").concat(n?"<Tres".concat(n.object.type,'  ref="cameraRef" uuid="').concat(n.object.uuid,'" name="').concat(n.object.name,'" />'):"","\n		").concat(t,"\n		").concat(r.gridHelper?"<TresGridHelper />":"","\n	</TresCanvas>\n</template>\n<script setup lang=\"ts\">\nimport * as THREE from 'three'\nimport { reactive, watch, ref } from 'vue'\nimport { TresCanvas } from '@tresjs/core'\nimport { OrbitControls } from '@tresjs/cientos'\nimport sceneCom from '../components/scene.vue'\nimport { loading2 as loading } from 'PLS/UIdemo'\n\nconst state = reactive({\n	clearColor: '#201919',\n	windowSize:true,\n	antialias: true,\n	shadows: ").concat(e.shadows?"true":"false",",\n	shadowMapType: ").concat(e.shadowType?e.shadowType:"THREE.PCFShadowMap",",\n	toneMapping: ").concat(e.toneMapping?e.toneMapping:"THREE.NoToneMapping",",\n	toneMappingExposure:").concat(e.toneMappingExposure?e.toneMappingExposure:"1",",\n})\n\nconst cameraConfig = ").concat(l?"".concat(JSON.stringify(l)):"{}","\nconst loader = new THREE.ObjectLoader()\nconst cameraObject = loader.parse(cameraConfig)\nconst cameraRef = ref(null)\nwatch(\n	() => cameraRef.value,\n	(val) => {\n			val.copy(cameraObject)\n	},\n)\n<\/script>\n	")},T=t=>"<!-- name:".concat(t.name," uuid:").concat(t.uuid," type:").concat(t.type," -->"),Pe=(t,e,n)=>{let r="";n.forEach((s,l)=>{r+=T(s),r+='\n        <primitive :object="object['.concat(l,']" />\n        ')});let o="<template>\n    ".concat(r,'\n</template>\n\n<script setup lang="ts">\nconst props = withDefaults(\n    defineProps<{\n        object: any\n    }>(),\n    {},\n)\n<\/script>\n');t.file("".concat(e.fileName),o),k.push(e)},Se=()=>{let t="";return k.forEach(e=>{t+="import ".concat(e.comName," from './childComponent/").concat(e.fileName,"'\n")}),t},Oe=(t,e)=>{const n=t-1,r=["firstLevel","secondLevel","thirdLevel"],o=e.split("-").pop();return{fileName:"".concat(r[n],"-").concat(o,".vue"),comName:"".concat(r[n]).concat(o)}},ke=(t,e,n,r,o)=>{e.childLevel>=o;let s="".concat(T(n),'\n    <primitive :object="sceneObject.children[').concat(r,']">\n    ');if(n.children&&n.children.length){const l=Oe(o,n.uuid);s+="<".concat(l.comName,' :object="sceneObject.children[').concat(r,'].children" />'),Pe(t,l,n.children)}return s+="\n    </primitive>\n",s},Te=(t,e,n)=>{let r="";const o=t.folder("components/childComponent");return n.object&&n.object.children&&n.object.children.length&&n.object.children.forEach((s,l)=>{e.childLevel>0&&s.children&&s.children.length?r+=ke(o,e,s,l,1):r+="    ".concat(T(s),'\n    <primitive :object="sceneObject.children[').concat(l,']" />\n    ')}),t.file("components/scene.vue","<template>\n        ".concat(r,"</template>\n<script setup lang=\"ts\">\nimport { onMounted } from 'vue'\nimport * as THREE from 'three'\nimport { loadImageToBase64, loadJsonFile } from 'PLS/tresEditor'\nimport { useTresContext, useRenderLoop } from '@tresjs/core'\nimport player from '../common/eventScript'\n").concat(Se(),"\n\nconst { scene: tresScene, renderer, camera, sizes } = useTresContext()\nplayer.init(tresScene, renderer, camera, sizes)\n\nconst loader = new THREE.ObjectLoader()\nconst scene = await loadJsonFile('./plugins/").concat(e.pluginName,"/json/scene.json')\n\nif (scene.geometries) {\n    for (const geometry of scene.geometries) {\n        if (geometry.data && geometry.data.startsWith('url:')) {\n            let url = geometry.data.slice(4)\n            if (url.startsWith('geometries/')) {\n                url = `./plugins/").concat(e.pluginName,"/${url}`\n            }\n            geometry.data = await loadJsonFile(url)\n        }\n    }\n}\nif (scene.images) {\n    for (const image of scene.images) {\n        if (image.url && image.url.startsWith('url:')) {\n            let url = image.url.slice(4)\n            if (url.startsWith('images/')) {\n                url = `./plugins/").concat(e.pluginName,"/${url}`\n            }\n            image.url = await loadImageToBase64(url)\n        }\n    }\n}\n\nconst sceneObject = loader.parse(scene) as any\nonMounted(() => {\n    tresScene.value.background = sceneObject.background\n    tresScene.value.environment = sceneObject.environment\n    tresScene.value.fog = sceneObject.fog\n    player.load(sceneObject)\n    player.play()\n})\nconst { onLoop } = useRenderLoop()\nonLoop(({ delta, elapsed }) => {\n    if (player.renderer) {\n        player.render(elapsed * 1000, delta * 1000)\n    }\n})\n<\/script>")),"<Suspense>\n			<sceneCom />\n		</Suspense>"},Ne=t=>{const e=new Date,n=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0"),s="".concat(n,"-").concat(r,"-").concat(o);return'\n	export default {\n		"name": "'.concat(t,'",\n		"title": "编辑器导出的插件",\n		"intro": "描述",\n		"version": "0.0.1",\n		"author": "作者名",\n		"website": "站点地址",\n		"state": "active",\n		"creatTime": "').concat(s,'",\n		"updateTime": "').concat(s,'",\n		"require": [],\n		"preview": [\n			{ "src": "plugins/basic/base/preview/theBasic.png", "type": "img", "name": "index", "title": "实例" },\n		]\n	}')},Re=(t,e)=>{const n=[];e.geometries&&e.geometries.forEach(o=>{o.type==="BufferGeometry"&&(n.push({uuid:o.uuid,data:o.data}),o.data="url:geometries/".concat(o.uuid,".json"))});const r=[];if(e.images&&e.images.forEach(o=>{o.url&&(r.push({uuid:o.uuid,url:o.url}),o.url="url:images/".concat(o.uuid,".").concat(x(o.url)))}),n.length){const o=t.folder("geometries");n.forEach(s=>{o.file("".concat(s.uuid,".json"),JSON.stringify(s.data))})}if(r.length){const o=t.folder("images");r.forEach(s=>{o.file("".concat(s.uuid,".").concat(x(s.url)),s.url.split(";base64,").pop(),{base64:!0})})}t.file("json/scene.json",JSON.stringify(e))};function Fe(t,e){k=[];const n=e.pluginName,r=new ve,o=r.folder("public/plugins/".concat(n));Re(o,t.scene);const s=r.folder("src/plugins/".concat(n));s.file("config.js",Ne(n));const l=Ce(Te(s,e,t.scene),t.project,t.camera,e);return s.file("pages/index.vue",l),s.file("common/eventScript.js",Le(t.scripts)),r.generateAsync({type:"blob"}).then(m=>{he.saveAs(m,"".concat(n,".zip"))})}const Be=z({__name:"importJson",setup(t){let e,n=null;var r=new q;let o=null;const{scene:s,renderer:l,camera:m,sizes:C}=V(),f=()=>{if(!o)return;const i=p=>{var d,u;(d=p.geometry)==null||d.dispose(),(u=p.material)==null||u.dispose()},c=p=>{let d=p.children.filter(u=>!!u);d.forEach(u=>{u.children.length?c(u):(i(u),u.clear())}),p.clear(),d=null};c(o),o=null},w=i=>{f(),$e(),o=new ee,i.children&&(o.children=i.children,s.value.add(o),s.value.background=i.background,s.value.environment=i.environment,s.value.fog=i.fog)},h=new Y;h.addButton({title:"清空场景",label:"clear"}).on("click",()=>{confirm("确定要执行操作吗？")&&window.location.reload()}),h.addButton({title:"导入原生场景Json",label:"srcJson"}).on("click",()=>{var i,c;if(n){(c=(i=b).warning)==null||c.call(i,{content:"先清空场景",colorful:!0});return}e&&(e.accept=".json",e.value=null,e.click())});const $=h.addFolder({title:"分解场景[中间件 测试用]"});$.addButton({title:"生成分解场景Zip",label:"Json2Zip"}).on("click",()=>{var i,c;n?we(n):(c=(i=b).warning)==null||c.call(i,{content:"场景内无物体",colorful:!0})}),$.addButton({title:"导入分解场景Zip",label:"Zip2Json"}).on("click",()=>{var i,c;n?(c=(i=b).warning)==null||c.call(i,{content:"先清空场景",colorful:!0}):e&&(e.accept=".zip",e.value=null,e.click())});const y={orbitControls:!0,gridHelper:!0,pluginName:"testEditor",childLevel:1},L=h.addFolder({title:"TvT插件包"});L.addBinding(y,"pluginName",{label:"插件名称"}),L.addBinding(y,"orbitControls",{label:"默认控制器"}),L.addBinding(y,"gridHelper",{label:"默认网格"}),L.addButton({title:"生成插件包",label:"MakePlugin"}).on("click",()=>{var i,c,p,d;n?y.pluginName?Fe(n,y):(c=(i=b).warning)==null||c.call(i,{content:"请正确填写插件名称",colorful:!0}):(d=(p=b).warning)==null||d.call(p,{content:"场景内无物体",colorful:!0})});const N=i=>{n=i,w(r.parse(n.scene)),be(l.value,s.value,m.value,C,n),Ee()};Q(()=>{e=document.getElementById("fileInput"),e&&(e.onchange=i=>{const c=i.target.files[0];if(e.accept===".json"){const p=new FileReader;p.onload=d=>{const u=d.target.result;N(JSON.parse(u))},p.readAsText(c)}e.accept===".zip"&&ge(c,N)})});const{onLoop:D}=X();return D(({delta:i,elapsed:c})=>{je(c*1e3,i*1e3)}),(i,c)=>null}}),Je=O("TresPerspectiveCamera",{position:[15,15,15],fov:45,near:.1,far:1e3,"look-at":[0,0,0]},null,-1),_e=O("TresGridHelper",null,null,-1),Me=O("input",{id:"fileInput",type:"file",accept:".zip",style:{display:"none"}},null,-1),Ke=z({__name:"simpleImport",setup(t){const e=B({clearColor:"#201919",shadows:!0,alpha:!1,shadowMapType:te,outputColorSpace:ne,toneMapping:re}),n=B({enableDamping:!0,dampingFactor:.05}),r=oe(null);return se(()=>{r.value}),(o,s)=>(J(),ie(le,null,[S(M(ce),ae(e,{"window-size":""}),{default:_(()=>[Je,S(M(pe),ue(de(n)),null,16),(J(),me(fe,null,{default:_(()=>[S(Be)]),_:1})),_e]),_:1},16),Me],64))}});export{Ke as default};
