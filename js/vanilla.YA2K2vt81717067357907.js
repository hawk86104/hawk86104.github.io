var se=Object.defineProperty;var j=Object.getOwnPropertySymbols;var N=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable;var F=(n,e,s)=>e in n?se(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s,b=(n,e)=>{for(var s in e||(e={}))N.call(e,s)&&F(n,s,e[s]);if(j)for(var s of j(e))U.call(e,s)&&F(n,s,e[s]);return n};var z=(n,e)=>{var s={};for(var i in n)N.call(n,i)&&e.indexOf(i)<0&&(s[i]=n[i]);if(n!=null&&j)for(var i of j(n))e.indexOf(i)<0&&U.call(n,i)&&(s[i]=n[i]);return s};import{bK as oe,aT as ae}from"./vendor.Bhln4awG1717067357907.js";import{h as ce}from"./object_hash.MnKN4xNn1717067357907.js";import{g as P}from"./_commonjsHelpers.5-cIlDoe1717067357907.js";import{l as ue,b as fe,a as le,c as de}from"./builtins-300es.Tm_BdSQ71717067357907.js";var he=["<<=",">>=","++","--","<<",">>","<=",">=","==","!=","&&","||","+=","-=","*=","/=","%=","&=","^^","^=","|=","(",")","[","]",".","!","~","*","/","%","+","-","<",">","&","^","|","?",":","=",",",";","{","}"],me=we,pe=ue,L=he,ge=fe,_e=le,ve=de,g=999,k=9999,T=0,I=1,V=2,H=3,K=4,y=5,Se=6,Me=7,Ee=8,B=9,Ce=10,G=11,xe=["block-comment","line-comment","preprocessor","operator","integer","float","ident","builtin","keyword","whitespace","eof","integer"];function we(n){var e=0,s=0,i=g,t,a,r=[],l=[],_=1,u=0,o=0,h=!1,m=!1,d="",E;n=n||{};var M=ge,C=pe;n.version==="300 es"&&(M=ve,C=_e);for(var v={},O={},e=0;e<M.length;e++)v[M[e]]=!0;for(var e=0;e<C.length;e++)O[C[e]]=!0;return function(f){return l=[],f!==null?W(f):Y()};function p(f){f.length&&l.push({type:xe[i],data:f,position:o,line:_,column:u})}function W(f){e=0,f.toString&&(f=f.toString()),d+=f.replace(/\r\n/g,"\n"),E=d.length;for(var x;t=d[e],e<E;){switch(x=e,i){case T:e=Z();break;case I:e=Q();break;case V:e=A();break;case H:e=ee();break;case K:e=ie();break;case G:e=te();break;case y:e=re();break;case k:e=ne();break;case B:e=J();break;case g:e=q();break}if(x!==e)switch(d[x]){case"\n":u=0,++_;break;default:++u;break}}return s+=e,d=d.slice(e),l}function Y(f){return r.length&&p(r.join("")),i=Ce,p("(eof)"),l}function q(){return r=r.length?[]:r,a==="/"&&t==="*"?(o=s+e-1,i=T,a=t,e+1):a==="/"&&t==="/"?(o=s+e-1,i=I,a=t,e+1):t==="#"?(i=V,o=s+e,e):/\s/.test(t)?(i=B,o=s+e,e):(h=/\d/.test(t),m=/[^\w_]/.test(t),o=s+e,i=h?K:m?H:k,e)}function J(){return/[^\s]/g.test(t)?(p(r.join("")),i=g,e):(r.push(t),a=t,e+1)}function A(){return(t==="\r"||t==="\n")&&a!=="\\"?(p(r.join("")),i=g,e):(r.push(t),a=t,e+1)}function Q(){return A()}function Z(){return t==="/"&&a==="*"?(r.push(t),p(r.join("")),i=g,e+1):(r.push(t),a=t,e+1)}function ee(){if(a==="."&&/\d/.test(t))return i=y,e;if(a==="/"&&t==="*")return i=T,e;if(a==="/"&&t==="/")return i=I,e;if(t==="."&&r.length){for(;R(r););return i=y,e}if(t===";"||t===")"||t==="("){if(r.length)for(;R(r););return p(t),i=g,e+1}var f=r.length===2&&t!=="=";if(/[\w_\d\s]/.test(t)||f){for(;R(r););return i=g,e}return r.push(t),a=t,e+1}function R(f){var x=0,D,w;do{if(D=L.indexOf(f.slice(0,f.length+x).join("")),w=L[D],D===-1){if(x--+f.length>0)continue;w=f.slice(0,1).join("")}return p(w),o+=w.length,r=r.slice(w.length),r.length}while(!0)}function te(){return/[^a-fA-F0-9]/.test(t)?(p(r.join("")),i=g,e):(r.push(t),a=t,e+1)}function ie(){return t==="."||/[eE]/.test(t)?(r.push(t),i=y,a=t,e+1):t==="x"&&r.length===1&&r[0]==="0"?(i=G,r.push(t),a=t,e+1):/[^\d]/.test(t)?(p(r.join("")),i=g,e):(r.push(t),a=t,e+1)}function re(){return t==="f"&&(r.push(t),a=t,e+=1),/[eE]/.test(t)||(t==="-"||t==="+")&&/[eE]/.test(a)?(r.push(t),a=t,e+1):/[^\d]/.test(t)?(p(r.join("")),i=g,e):(r.push(t),a=t,e+1)}function ne(){if(/[^\d\w_]/.test(t)){var f=r.join("");return O[f]?i=Ee:v[f]?i=Me:i=Se,p(r.join("")),i=g,e}return r.push(t),a=t,e+1}}var be=me,ye=$e;function $e(n,e){var s=be(e),i=[];return i=i.concat(s(n)),i=i.concat(s(null)),i}const je=P(ye);var Re=De;function De(n){for(var e=[],s=0;s<n.length;s++)n[s].type!=="eof"&&e.push(n[s].data);return e.join("")}const X=P(Re);var Te=Ie;function Ie(n){var e=null,s=null,i=0,t=0,a=0,r=0,l=0,_=[],u,o,h;for(u=0,o;u<n.length;u++)if(h=n[u],h.data==="{"){if(i&&i++||(o=d(u,S(")"),S()),o<0)||(r=o,o=d(o,S("("),S(")")),o<0)||(l=o,o=d(o,$),o<0)||n[o].type!=="ident"||(s=n[o].data,o=d(o,$),o<0))continue;i=1,t=u,e=n[o].data,a=o;var m=d(o,$);switch(n[m]&&n[m].data){case"lowp":case"highp":case"mediump":a=m}}else if(i&&h.data==="}"){if(--i)continue;_.push({name:s,type:e,body:[t+1,u],args:[l,r+1],outer:[a,u+1]})}for(u=0;u<n.length;u++)if(h=n[u],h.data===";"){if(o=d(u,S(")"),S()),o<0||(r=o,o=d(o,S("("),S(")")),o<0)||(l=o,o=d(o,$),o<0)||n[o].type!=="ident"||(s=n[o].data,o=d(o,$),o<0)||n[o].type==="operator"||n[o].data==="return")continue;e=n[o].data,_.push({name:s,type:e,body:!1,args:[l,r+1],outer:[o,u+1]})}return _.sort(function(E,M){return E.outer[0]-M.outer[0]});function d(E,M,C){for(var v=E-1;v>=0;v--){if(M(n[v]))return v;if(C&&C(n[v]))return-1}return-1}}function S(n){return function(e){return e.type==="operator"&&(!n||e.data===n)}}function $(n){return n.type!=="whitespace"}const Pe=P(Te);var c={position:"csm_Position",positionRaw:"csm_PositionRaw",pointSize:"csm_PointSize",fragColor:"csm_FragColor",diffuseColor:"csm_DiffuseColor",normal:"csm_Normal",roughness:"csm_Roughness",metalness:"csm_Metalness",emissive:"csm_Emissive"};const Oe={["".concat(c.normal)]:{"#include <beginnormal_vertex>":"\n    vec3 objectNormal = ".concat(c.normal,";\n    #ifdef USE_TANGENT\n	    vec3 objectTangent = vec3( tangent.xyz );\n    #endif\n    ")},["".concat(c.position)]:{"#include <begin_vertex>":"\n    vec3 transformed = ".concat(c.position,";\n  ")},["".concat(c.positionRaw)]:{"#include <begin_vertex>":"\n    vec4 csm_positionUnprojected = ".concat(c.positionRaw,";\n    mat4x4 csm_unprojectMatrix = projectionMatrix * modelViewMatrix;\n    #ifdef USE_INSTANCING\n      csm_unprojectMatrix = csm_unprojectMatrix * instanceMatrix;\n    #endif\n    csm_positionUnprojected = inverse(csm_unprojectMatrix) * csm_positionUnprojected;\n    vec3 transformed = csm_positionUnprojected.xyz;\n  ")},["".concat(c.pointSize)]:{"gl_PointSize = size;":"\n    gl_PointSize = ".concat(c.pointSize,";\n    ")},["".concat(c.diffuseColor)]:{"#include <color_fragment>":"\n    #include <color_fragment>\n    diffuseColor = ".concat(c.diffuseColor,";\n  ")},["".concat(c.fragColor)]:{"#include <dithering_fragment>":"\n    #include <dithering_fragment>\n    gl_FragColor  = ".concat(c.fragColor,";\n  ")},["".concat(c.emissive)]:{"vec3 totalEmissiveRadiance = emissive;":"\n    vec3 totalEmissiveRadiance = ".concat(c.emissive,";\n    ")},["".concat(c.roughness)]:{"#include <roughnessmap_fragment>":"\n    #include <roughnessmap_fragment>\n    roughnessFactor = ".concat(c.roughness,";\n    ")},["".concat(c.metalness)]:{"#include <metalnessmap_fragment>":"\n    #include <metalnessmap_fragment>\n    metalnessFactor = ".concat(c.metalness,";\n    ")}},Ae={["".concat(c.position)]:{"gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );":"\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( ".concat(c.position,", 1.0 );\n  ")},["".concat(c.positionRaw)]:{"gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );":"\n    gl_Position = ".concat(c.position,";\n  ")},["".concat(c.diffuseColor)]:{"gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );":"\n    gl_FragColor = ".concat(c.diffuseColor,";\n  ")},["".concat(c.fragColor)]:{"gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );":"\n    gl_FragColor = ".concat(c.fragColor,";\n  ")}},Fe="\n\n#ifdef IS_VERTEX\n    vec3 csm_Position = position;\n    vec4 csm_PositionRaw = projectionMatrix * modelViewMatrix * vec4(position, 1.);\n    vec3 csm_Normal = normal;\n#else\n    #if defined IS_SHADERMATERIAL || defined IS_MESHDEPTHMATERIAL || defined IS_MESHNORMALMATERIAL\n        vec4 csm_DiffuseColor = vec4(1., 0., 1., 1.);\n        vec4 csm_FragColor = vec4(1., 0., 1., 1.);\n    #else\n        #if defined IS_MESHSTANDARDMATERIAL || defined IS_MESHPHYSICALMATERIAL\n            vec3 csm_Emissive = emissive;\n            float csm_Roughness = roughness;\n            float csm_Metalness = metalness;\n        #endif\n        \n        #ifdef USE_MAP\n            vec4 _csm_sampledDiffuseColor = texture2D(map, vUv);\n\n            #ifdef DECODE_VIDEO_TEXTURE\n            // inline sRGB decode (TODO: Remove this code when https://crbug.com/1256340 is solved)\n            _csm_sampledDiffuseColor = vec4(mix(pow(_csm_sampledDiffuseColor.rgb * 0.9478672986 + vec3(0.0521327014), vec3(2.4)), _csm_sampledDiffuseColor.rgb * 0.0773993808, vec3(lessThanEqual(_csm_sampledDiffuseColor.rgb, vec3(0.04045)))), _csm_sampledDiffuseColor.w);\n            #endif\n\n            vec4 csm_DiffuseColor = vec4(diffuse, opacity) * _csm_sampledDiffuseColor;\n            vec4 csm_FragColor = vec4(diffuse, opacity) * _csm_sampledDiffuseColor;\n        #else\n            vec4 csm_DiffuseColor = vec4(diffuse, opacity);\n            vec4 csm_FragColor = vec4(diffuse, opacity);\n        #endif\n    #endif\n#endif\n",Ne=(n,e,s)=>n.split(e).join(s),Ue=function(n){return n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},ze=(n,e)=>new RegExp("\\b".concat(Ue(e),"\\b")).test(n);function Le(n){try{new n}catch(e){if(e.message.indexOf("is not a constructor")>=0)return!1}return!0}class Ge extends oe{constructor(_){var u=_,{baseMaterial:e,fragmentShader:s,vertexShader:i,uniforms:t,patchMap:a,cacheKey:r}=u,l=z(u,["baseMaterial","fragmentShader","vertexShader","uniforms","patchMap","cacheKey"]);let o;if(Le(e)?o=new e(l):(o=e,Object.assign(o,l)),o.type==="RawShaderMaterial")throw new Error("CustomShaderMaterial does not support RawShaderMaterial");super(),this.uniforms=t||{},this._customPatchMap=a||{},this._fs=s||"",this._vs=i||"",this._cacheKey=r,this._base=e,this._type=o.type,this._instanceID=ae.generateUUID();for(const h in o){let m=h;h.startsWith("_")&&(m=h.split("_")[1]),this[m]===void 0&&(this[m]=0),this[m]=o[m]}this.update({fragmentShader:s,vertexShader:i,uniforms:t,cacheKey:r})}update(e){const s=(e==null?void 0:e.uniforms)||{},i=(e==null?void 0:e.fragmentShader)||this._fs,t=(e==null?void 0:e.vertexShader)||this._vs,a=Object.values(s).reduce((r,{value:l})=>r+JSON.stringify(l),"");this.uuid=(e==null||e.cacheKey==null?void 0:e.cacheKey())||ce([i,t,a,this._instanceID]),this.generateMaterial({fragmentShader:i,vertexShader:t,uniforms:s})}clone(){const e=new this.constructor({baseMaterial:this._base,fragmentShader:this._fs,vertexShader:this._vs,patchMap:this._customPatchMap,uniforms:this.uniforms,cacheKey:this._cacheKey});for(const s in this)s!=="uuid"&&(e[s]=this[s]);return e}generateMaterial({fragmentShader:e,vertexShader:s,uniforms:i}){const t=this.parseShader(e),a=this.parseShader(s);this.uniforms=i||{},this.customProgramCacheKey=()=>this.uuid,this.onBeforeCompile=r=>{if(t){const l=this.patchShader(t,r.fragmentShader);r.fragmentShader=this.getMaterialDefine()+l}if(a){const l=this.patchShader(a,r.vertexShader);r.vertexShader="#define IS_VERTEX;\n"+l,r.vertexShader=this.getMaterialDefine()+r.vertexShader}r.uniforms=b(b({},r.uniforms),this.uniforms),this.uniforms=r.uniforms},this.needsUpdate=!0}getMaterialDefine(){return"#define IS_".concat(this._type.toUpperCase(),";\n")}getPatchMapForMaterial(){switch(this._type){case"ShaderMaterial":return Ae;default:return Oe}}patchShader(e,s){let i=s;const t=b(b({},this.getPatchMapForMaterial()),this._customPatchMap);return Object.keys(t).forEach(a=>{Object.keys(t[a]).forEach(r=>{ze(e.main,a)&&(i=Ne(i,r,t[a][r]))})}),i=i.replace("void main() {","\n          ".concat(e.header,"\n          void main() {\n            ").concat(Fe,"\n            ").concat(e.main,"\n          ")),i=e.defines+i,i}parseShader(e){if(!e)return;const s=e.replace(/\/\*\*(.*?)\*\/|\/\/(.*?)\n/gm,""),i=je(s),t=Pe(i),a=t.map(_=>_.name).indexOf("main"),r=X(i.slice(0,a>=0?t[a].outer[0]:void 0)),l=a>=0?this.getShaderFromIndex(i,t[a].body):"";return{defines:"",header:r,main:l}}getShaderFromIndex(e,s){return X(e.slice(s[0],s[1]))}}export{Ge as C,Pe as a,X as s,je as t};
