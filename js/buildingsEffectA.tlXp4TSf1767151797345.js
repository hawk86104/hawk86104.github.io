import{importShared as t}from"./3d-tiles-renderer.BWkWgmMi1767151797345.js";import{Pane as e}from"./tweakpane.BbuIEN141767151797345.js";import{loadCityFBX as o,_sfc_main as i}from"./pagesShow.vue_vue_type_script_setup_true_lang.3JYoHtbU1767151797345.js";import{useLoop as n}from"./index.DdZsEhdb1767151797345.js";import{B as a}from"./three-custom-shader-material.es.Bj7mllmU1767151797345.js";const{defineComponent:l}=await t("vue"),{unref:r,openBlock:u,createElementBlock:d}=await t("vue"),s=["object"],{watchEffect:c,watch:m}=await t("vue"),f=await t("three"),v=l({__name:"bModel",props:{model:{},bulidingsColor:{default:"#e523ff"},landColor:{default:"#112233"},topColor:{default:"#ffff00"},opacity:{default:.9},gradient:{type:Boolean,default:!0}},setup(t){const e=t,o=e.model.city;e.model.model.children[0].material=new f.MeshBasicMaterial({color:"#ffff00"}),o.renderOrder=1001;const i=e.model.land;(()=>{const{geometry:t}=o;t.computeBoundingBox(),t.computeBoundingSphere();const{max:i,min:n}=t.boundingBox;if(o.material.__csm)return;const l=new a({baseMaterial:o.material,vertexShader:"\n\t\tvarying vec4 vPosition;\n\t\tvoid main() {\n\t\t\tvPosition = modelMatrix * vec4(position,1.0);\n\t\t\tcsm_Position = position * vec3(1.0);\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform mat4 modelMatrix;\n\t\tvarying vec4 vPosition;\n\t\tuniform vec3 uMax; \n\t\tuniform vec3 uMin; \n\t\tuniform float uOpacity;  \n\t\tuniform float uBorderWidth; \n\t\tuniform vec3 uLightColor;\n\t\tuniform vec3 uColor;\n\t\tuniform float uCircleTime; \n\t\tuniform float uTime; \n\t\tuniform vec3 uTopColor;\t\t\t\t\t//顶部颜色\n\t\tuniform bool uGradient;\n\t\tvec4 uMax_world;\n\t\tvec4 uMin_world;\n\t\tvoid main() {\n\t\t\t// 转世界坐标\n\t\t\tuMax_world =  modelMatrix * vec4(uMax,1.0);\n\t\t\tuMin_world =  modelMatrix * vec4(uMin,1.0);\n\t\t\tvec3 distColor = uColor;\n\t\t\tfloat residue = uTime - floor(uTime / uCircleTime) * uCircleTime;\n\t\t\tfloat rate = residue / uCircleTime;\n\t\t\tfloat lightOffset = rate * (uMax_world.y - uMin_world.y);\n\n\t\t\tif (uMin_world.y + lightOffset < vPosition.y && uMin_world.y + lightOffset + uBorderWidth > vPosition.y) {\n\t\t\t\tcsm_DiffuseColor = vec4(uLightColor, uOpacity);\n\t\t\t} else {\n\t\t\t\tcsm_DiffuseColor = vec4(distColor, uOpacity);\n\t\t\t}\n\n\t\t\t//根据高度计算颜色\n\t\t\tif(uGradient){\n\t\t\t\tfloat rateHight = (vPosition.y - uMin_world.y) / (uMax_world.y - uMin_world.y); \n\t\t\t\tvec3 outColor = mix(csm_DiffuseColor.xyz, uTopColor, rateHight*2.0);\n\t\t\t\tcsm_DiffuseColor = vec4(outColor, uOpacity);\n\t\t\t}\n    }\n\t\t",silent:!0,uniforms:{uMax:{value:i},uMin:{value:n},uBorderWidth:{value:5},uCircleTime:{value:5},uColor:{value:new f.Color(e.bulidingsColor)},uOpacity:{value:e.opacity},uLightColor:{value:new f.Color("#ffffff")},uTopColor:{value:new f.Color(e.topColor)},uTime:{value:0},uGradient:{value:e.gradient}},depthWrite:!0,depthTest:!0,transparent:!0,side:f.DoubleSide});o.material.dispose(),o.material=l})();const{onBeforeRender:l}=n();l(({delta:t})=>{o.material.uniforms.uTime.value+=t}),c(()=>{e.bulidingsColor&&o.material.uniforms.uColor.value.setStyle(e.bulidingsColor),e.landColor&&((t,o)=>{let n;n=Array.isArray(i.material)?i.material:[i.material],n.forEach(t=>{t[o].setStyle(e.landColor),t.side=f.DoubleSide})})(0,"color"),e.opacity&&(o.material.uniforms.uOpacity.value=e.opacity)}),m(e,(t,e)=>{o.material.uniforms.uGradient.value=t.gradient});const v=e.model.model.clone();return(t,e)=>(u(),d("primitive",{object:r(v)},null,8,s))}});const{defineComponent:p}=await t("vue"),{unref:C,openBlock:g,createElementBlock:w}=await t("vue"),y=["object"],{Color:h,EdgesGeometry:_,ShaderMaterial:x,LineSegments:M}=await t("three"),{watchEffect:b}=await t("vue"),B=p({__name:"bLine",props:{builds:{},color:{default:"#FFF"},srcColor:{default:"#000"},scale:{default:2e3},gradual:{default:10},speed:{default:.5}},setup(t){const e=t;let o=null;const i={transparent:!0,uniforms:{uColor:{value:new h(e.color)},uSrcColor:{value:new h(e.srcColor)},uScale:{value:e.scale},uTime:{value:0},uGradual:{value:e.gradual}},vertexShader:"varying vec3 vPosition;\nvoid main(){\n\tvPosition=position;\n\tvec4 viewPosition=modelViewMatrix*vec4(position,1.);\n\tgl_Position=projectionMatrix*viewPosition;\n}",fragmentShader:"uniform float uScale;\nuniform float uGradual;\nuniform float uTime;\nuniform vec3 uColor;\nuniform vec3 uSrcColor;\nvarying vec3 vPosition;\n\nvoid main(){\n\tfloat dis=distance(vPosition.xz,vec2(.0,.0));\n\tif(dis>uScale){\n\t\tdiscard;\n\t}\n\tfloat opacity=smoothstep(uScale/uGradual*uTime,uScale*uTime,dis);\n\topacity*=step(dis,uScale*uTime);\n\t\n\tif(opacity<.3){\n\t\tgl_FragColor=vec4(uSrcColor,1.-opacity);\n\t}else{\n\t\tgl_FragColor=vec4(uColor,opacity);\n\t}\n\t\n}"};let a=new _(e.builds.geometry).clone();a=a.applyMatrix4(e.builds.matrix);const l=new x(i);o=new M(a,l),o.material.linewidth=e.width,o.renderOrder=1e3,b(()=>{e.color&&(i.uniforms.uColor.value=new h(e.color)),e.srcColor&&(i.uniforms.uSrcColor.value=new h(e.srcColor)),e.scale&&(i.uniforms.uScale.value=e.scale),e.gradual&&(i.uniforms.uGradual.value=e.gradual)});const{onBeforeRender:r}=n();return r(({delta:t})=>{i.uniforms.uTime.value+=t*e.speed,i.uniforms.uTime.value%=1}),(t,e)=>(g(),w("primitive",{object:C(o)},null,8,y))}}),{withAsyncContext:S,defineComponent:T}=await t("vue"),{unref:P,createVNode:O,mergeProps:j,withCtx:G,openBlock:F,createBlock:k}=await t("vue"),{reactive:E}=await t("vue"),D=T({__name:"buildingsEffectA",async setup(t){let n,a;const l=([n,a]=S(()=>o()),n=await n,a(),n),r=E({color:"#FFF",srcColor:"#000",scale:2e3,gradual:6.6,speed:.3}),u=new e({title:"效果参数",expanded:!0});return u.addBinding(r,"srcColor",{label:"线原颜色"}),u.addBinding(r,"color",{label:"线扫颜色"}),u.addBinding(r,"speed",{label:"速度",min:.1,max:1,step:.1}),u.addBinding(r,"scale",{label:"最大扩散",min:10,max:2e3,step:10}),u.addBinding(r,"gradual",{label:"扩散系数",min:1.1,max:10,step:.1}),(t,e)=>(F(),k(i,{showAxesHelper:!1,autoRotate:!1,showBuildings:!1},{ability:G(()=>[O(v,{model:P(l),bulidingsColor:"#000000",landColor:"#112233",topColor:"#999"},null,8,["model"]),O(B,j({builds:P(l).city},r),null,16,["builds"])]),_:1}))}});export{D as default};
