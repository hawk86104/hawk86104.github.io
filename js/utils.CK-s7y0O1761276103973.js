import"./@fesjs.DnM7nINA1761276103973.js";import{J as e}from"./jszip.y_yjJ09m1761276103973.js";import{F as s}from"./file-saver.BkNR6Vtn1761276103973.js";import{al as a,t,cc as r}from"./three.Bhn4-0ry1761276103973.js";async function i(e){const s=new t;return new Promise((a,t)=>{s.load(e,e=>a(JSON.parse(e)),void 0,e=>t(e))})}r.enabled=!0;class n extends a{constructor(e){super(e)}load(e,s,a,r){const i=new t(this.manager);i.setResponseType("json"),i.load(e,e=>s&&s(e),a,r)}}async function o(e){const s=new t;return new Promise((a,t)=>{s.setResponseType("blob"),s.load(e,s=>{const r=new FileReader;r.onloadend=()=>{const s=function(e){return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",bmp:"image/bmp",webp:"image/webp"}[e.split(".").pop().toLowerCase()]||"application/octet-stream"}(e),t=r.result.split(",")[1];a(`data:${s};base64,${t}`)},r.onerror=e=>{t(e)},r.readAsDataURL(s)},void 0,e=>t(e))})}class l extends a{constructor(e){super(e)}load(s,a,r,i){const n=new t(this.manager);n.setResponseType("blob"),n.load(s,async s=>{try{const t=await e.loadAsync(s);a&&a(t)}catch(t){i&&i(t)}},r,i)}}const c=e=>{const s=e.substring(0,15);return"data:image/jpeg;base64,".startsWith(s)||"data:image/JPEG;base64,".startsWith(s)?"JPEG":"data:image/png;base64,".startsWith(s)||"data:image/PNG;base64,".startsWith(s)?"PNG":"data:image/gif;base64,".startsWith(s)||"data:image/GIF;base64,".startsWith(s)?"GIF":"data:image/webp;base64,".startsWith(s||"data:image/WEBP;base64,".startsWith(s))?"WEBP":"Unknown"},u=a=>{const t=[];a.scene.geometries&&a.scene.geometries.forEach(e=>{"BufferGeometry"===e.type&&(t.push({uuid:e.uuid,data:e.data}),e.data=`url:geometries/${e.uuid}.json`)});const r=[];a.scene.images&&a.scene.images.forEach(e=>{e.url&&(r.push({uuid:e.uuid,url:e.url}),e.url.type?e.url=`url:images/${e.uuid}.${e.url.type}.json`:e.url=`url:images/${e.uuid}.${c(e.url)}`)});const i=new e;if(t.length){const e=i.folder("geometries");t.forEach(s=>{e.file(`${s.uuid}.json`,JSON.stringify(s.data))})}if(r.length){const e=i.folder("images");r.forEach(s=>{s.url.type?e.file(`${s.uuid}.${s.url.type}.json`,JSON.stringify(s.url)):e.file(`${s.uuid}.${c(s.url)}`,s.url.split(";base64,").pop(),{base64:!0})})}const n=JSON.stringify(a);return i.file("app.json",n),i.generateAsync({type:"blob"}).then(e=>{s.saveAs(e,"config.zip")})},g=(e,s,a)=>{e.geometries<=0&&e.images<=0&&a(s)},p=(s,a)=>{let t=null;return e.loadAsync(s).then(e=>{e.files["app.json"]?e.files["app.json"].async("string").then(s=>{t=JSON.parse(s);const r=(e=>{const s={geometries:0,images:0};return e.scene.geometries?.forEach(e=>{e.data?.startsWith("url:")&&s.geometries++}),e.scene.images?.forEach(e=>{e.url.startsWith("url:")&&s.images++}),s})(t);g(r,t,a),t.scene.geometries?.forEach(s=>{s.data?.startsWith("url:")&&e.files[s.data.slice(4)].async("string").then(e=>{s.data=JSON.parse(e),r.geometries--,g(r,t,a)})}),t.scene.images?.forEach(s=>{if(s.url.startsWith("url:")){const i=s.url.slice(4);i.endsWith(".json")?e.files[i].async("string").then(e=>{s.url=JSON.parse(e),r.images--,g(r,t,a)}):e.files[i].async("base64").then(e=>{const n=i.split("."),o=n[n.length-1].toUpperCase();s.url=`data:image/${o};base64,${e}`,r.images--,g(r,t,a)})}})}):console.error("非标准文件：不存在 app.json")},e=>{console.error(`${s.name}: ${e.message}`)}),t};export{n as J,l as Z,o as a,u as e,c as g,p as i,i as l};
