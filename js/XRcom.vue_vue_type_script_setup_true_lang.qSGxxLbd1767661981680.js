import{GLTFLoader as e,importShared as t}from"./3d-tiles-renderer.COLnOnaF1767661981680.js";import{useTres as n,createEventHook as o}from"./index.DJAV0vsW1767661981680.js";class s{constructor(t,n,o,s,i=null,a=null){this.controller=n,this.handModel=t,this.bones=[],null===i&&(i=new e).setPath(o||"https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/generic-hand/"),i.load(`${s}.glb`,e=>{const t=e.scene.children[0];this.handModel.add(t);const n=t.getObjectByProperty("type","SkinnedMesh");n.frustumCulled=!1,n.castShadow=!0,n.receiveShadow=!0;["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"].forEach(e=>{const n=t.getObjectByName(e);void 0!==n?n.jointName=e:console.warn(`Couldn't find ${e} in ${s} hand mesh`),this.bones.push(n)}),a&&a(t)})}updateMesh(){const e=this.controller.joints;for(let t=0;t<this.bones.length;t++){const n=this.bones[t];if(n){const t=e[n.jointName];if(t.visible){const e=t.position;n.position.copy(e),n.quaternion.copy(t.quaternion)}}}}}class i{static createButton(e,t={}){const n=document.createElement("button");function o(){n.style.display="",n.style.cursor="auto",n.style.left="calc(50% - 75px)",n.style.width="150px",n.onmouseenter=null,n.onmouseleave=null,n.onclick=null}function s(e){e.style.position="absolute",e.style.bottom="20px",e.style.padding="12px 6px",e.style.border="1px solid #fff",e.style.borderRadius="4px",e.style.background="rgba(0,0,0,0.1)",e.style.color="#fff",e.style.font="normal 13px sans-serif",e.style.textAlign="center",e.style.opacity="0.5",e.style.outline="none",e.style.zIndex="999"}if("xr"in navigator)return n.id="VRButton",n.style.display="none",s(n),navigator.xr.isSessionSupported("immersive-vr").then(function(s){s?function(){let o=null;async function s(t){t.addEventListener("end",i),await e.xr.setSession(t),n.textContent="EXIT VR",o=t}function i(){o.removeEventListener("end",i),n.textContent="ENTER VR",o=null}n.style.display="",n.style.cursor="pointer",n.style.left="calc(50% - 50px)",n.style.width="100px",n.textContent="ENTER VR";const a={...t,optionalFeatures:["local-floor","bounded-floor","layers",...t.optionalFeatures||[]]};n.onmouseenter=function(){n.style.opacity="1.0"},n.onmouseleave=function(){n.style.opacity="0.5"},n.onclick=function(){null===o?navigator.xr.requestSession("immersive-vr",a).then(s):(o.end(),void 0!==navigator.xr.offerSession&&navigator.xr.offerSession("immersive-vr",a).then(s).catch(e=>{console.warn(e)}))},void 0!==navigator.xr.offerSession&&navigator.xr.offerSession("immersive-vr",a).then(s).catch(e=>{console.warn(e)})}():(o(),n.textContent="VR NOT SUPPORTED"),s&&i.xrSessionIsGranted&&n.click()}).catch(function(e){o(),console.warn("Exception when trying to call xr.isSessionSupported",e),n.textContent="VR NOT ALLOWED"}),n;{const e=document.createElement("a");return!1===window.isSecureContext?(e.href=document.location.href.replace(/^http:/,"https:"),e.innerHTML="WEBXR NEEDS HTTPS"):(e.href="https://immersiveweb.dev/",e.innerHTML="WEBXR NOT AVAILABLE"),e.style.left="calc(50% - 90px)",e.style.width="180px",e.style.textDecoration="none",s(e),e}}static registerSessionGrantedListener(){if("undefined"!=typeof navigator&&"xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",()=>{i.xrSessionIsGranted=!0})}}}i.xrSessionIsGranted=!1,i.registerSessionGrantedListener();const a={ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})};async function r(e){const t=await fetch(e);if(t.ok)return t.json();throw new Error(t.statusText)}async function l(e,t,n=null,o=!0){if(!e)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No basePath supplied");const s=await async function(e){if(!e)throw new Error("No basePath supplied");return await r(`${e}/profilesList.json`)}(t);let i;if(e.profiles.some(e=>{const n=s[e];return n&&(i={profileId:e,profilePath:`${t}/${n.path}`,deprecated:!!n.deprecated}),!!i}),!i){if(!n)throw new Error("No matching profile name found");const e=s[n];if(!e)throw new Error(`No matching profile name found and default profile "${n}" missing.`);i={profileId:n,profilePath:`${t}/${e.path}`,deprecated:!!e.deprecated}}const a=await r(i.profilePath);let l;if(o){let t;if(t="any"===e.handedness?a.layouts[Object.keys(a.layouts)[0]]:a.layouts[e.handedness],!t)throw new Error(`No matching handedness, ${e.handedness}, in profile ${i.profileId}`);t.assetPath&&(l=i.profilePath.replace("profile.json",t.assetPath))}return{profile:a,assetPath:l}}const d={xAxis:0,yAxis:0,button:0,state:a.ComponentState.DEFAULT};class h{constructor(e){this.componentProperty=e.componentProperty,this.states=e.states,this.valueNodeName=e.valueNodeName,this.valueNodeProperty=e.valueNodeProperty,this.valueNodeProperty===a.VisualResponseProperty.TRANSFORM&&(this.minNodeName=e.minNodeName,this.maxNodeName=e.maxNodeName),this.value=0,this.updateFromComponent(d)}updateFromComponent({xAxis:e,yAxis:t,button:n,state:o}){const{normalizedXAxis:s,normalizedYAxis:i}=function(e=0,t=0){let n=e,o=t;if(Math.sqrt(e*e+t*t)>1){const s=Math.atan2(t,e);n=Math.cos(s),o=Math.sin(s)}return{normalizedXAxis:.5*n+.5,normalizedYAxis:.5*o+.5}}(e,t);switch(this.componentProperty){case a.ComponentProperty.X_AXIS:this.value=this.states.includes(o)?s:.5;break;case a.ComponentProperty.Y_AXIS:this.value=this.states.includes(o)?i:.5;break;case a.ComponentProperty.BUTTON:this.value=this.states.includes(o)?n:0;break;case a.ComponentProperty.STATE:this.valueNodeProperty===a.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(o):this.value=this.states.includes(o)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}class p{constructor(e,t){if(!(e&&t&&t.visualResponses&&t.gamepadIndices&&0!==Object.keys(t.gamepadIndices).length))throw new Error("Invalid arguments supplied");this.id=e,this.type=t.type,this.rootNodeName=t.rootNodeName,this.touchPointNodeName=t.touchPointNodeName,this.visualResponses={},Object.keys(t.visualResponses).forEach(e=>{const n=new h(t.visualResponses[e]);this.visualResponses[e]=n}),this.gamepadIndices=Object.assign({},t.gamepadIndices),this.values={state:a.ComponentState.DEFAULT,button:void 0!==this.gamepadIndices.button?0:void 0,xAxis:void 0!==this.gamepadIndices.xAxis?0:void 0,yAxis:void 0!==this.gamepadIndices.yAxis?0:void 0}}get data(){return{id:this.id,...this.values}}updateFromGamepad(e){if(this.values.state=a.ComponentState.DEFAULT,void 0!==this.gamepadIndices.button&&e.buttons.length>this.gamepadIndices.button){const t=e.buttons[this.gamepadIndices.button];this.values.button=t.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,t.pressed||1===this.values.button?this.values.state=a.ComponentState.PRESSED:(t.touched||this.values.button>a.ButtonTouchThreshold)&&(this.values.state=a.ComponentState.TOUCHED)}void 0!==this.gamepadIndices.xAxis&&e.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=e.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===a.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>a.AxisTouchThreshold&&(this.values.state=a.ComponentState.TOUCHED)),void 0!==this.gamepadIndices.yAxis&&e.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=e.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===a.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>a.AxisTouchThreshold&&(this.values.state=a.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach(e=>{e.updateFromComponent(this.values)})}}class c{constructor(e,t,n){if(!e)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No profile supplied");this.xrInputSource=e,this.assetUrl=n,this.id=t.profileId,this.layoutDescription=t.layouts[e.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach(e=>{const t=this.layoutDescription.components[e];this.components[e]=new p(e,t)}),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const e=[];return Object.values(this.components).forEach(t=>{e.push(t.data)}),e}updateFromGamepad(){Object.values(this.components).forEach(e=>{e.updateFromGamepad(this.xrInputSource.gamepad)})}}const{Mesh:u,MeshBasicMaterial:m,Object3D:x,SphereGeometry:f}=await t("three");class v extends x{constructor(){super(),this.motionController=null,this.envMap=null}setEnvironmentMap(e){return this.envMap==e||(this.envMap=e,this.traverse(e=>{e.isMesh&&(e.material.envMap=this.envMap,e.material.needsUpdate=!0)})),this}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&(this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach(e=>{Object.values(e.visualResponses).forEach(e=>{const{valueNode:t,minNode:n,maxNode:o,value:s,valueNodeProperty:i}=e;t&&(i===a.VisualResponseProperty.VISIBILITY?t.visible=s:i===a.VisualResponseProperty.TRANSFORM&&(t.quaternion.slerpQuaternions(n.quaternion,o.quaternion,s),t.position.lerpVectors(n.position,o.position,s)))})}))}}function g(e,t){!function(e,t){Object.values(e.components).forEach(e=>{const{type:n,touchPointNodeName:o,visualResponses:s}=e;if(n===a.ComponentType.TOUCHPAD)if(e.touchPointNode=t.getObjectByName(o),e.touchPointNode){const t=new f(.001),n=new m({color:255}),o=new u(t,n);e.touchPointNode.add(o)}else console.warn(`Could not find touch dot, ${e.touchPointNodeName}, in touchpad component ${e.id}`);Object.values(s).forEach(e=>{const{valueNodeName:n,minNodeName:o,maxNodeName:s,valueNodeProperty:i}=e;if(i===a.VisualResponseProperty.TRANSFORM){if(e.minNode=t.getObjectByName(o),e.maxNode=t.getObjectByName(s),!e.minNode)return void console.warn(`Could not find ${o} in the model`);if(!e.maxNode)return void console.warn(`Could not find ${s} in the model`)}e.valueNode=t.getObjectByName(n),e.valueNode||console.warn(`Could not find ${n} in the model`)})})}(e.motionController,t),e.envMap&&t.traverse(t=>{t.isMesh&&(t.material.envMap=e.envMap,t.material.needsUpdate=!0)}),e.add(t)}class y{constructor(t=null,n=null){this.gltfLoader=t,this.path="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",this._assetCache={},this.onLoad=n,this.gltfLoader||(this.gltfLoader=new e)}setPath(e){return this.path=e,this}createControllerModel(e){const t=new v;let n=null;return e.addEventListener("connected",e=>{const o=e.data;"tracked-pointer"===o.targetRayMode&&o.gamepad&&!o.hand&&l(o,this.path,"generic-trigger").then(({profile:e,assetPath:s})=>{t.motionController=new c(o,e,s);const i=this._assetCache[t.motionController.assetUrl];if(i)n=i.scene.clone(),g(t,n),this.onLoad&&this.onLoad(n);else{if(!this.gltfLoader)throw new Error("GLTFLoader not set.");this.gltfLoader.setPath(""),this.gltfLoader.load(t.motionController.assetUrl,e=>{this._assetCache[t.motionController.assetUrl]=e,n=e.scene.clone(),g(t,n),this.onLoad&&this.onLoad(n)},null,()=>{throw new Error(`Asset ${t.motionController.assetUrl} missing or malformed.`)})}}).catch(e=>{console.warn(e)})}),e.addEventListener("disconnected",()=>{t.motionController=null,t.remove(n),n=null}),t}}const{DynamicDrawUsage:b,SphereGeometry:w,BoxGeometry:N,MeshStandardMaterial:C,InstancedMesh:S,Matrix4:E,Vector3:A}=await t("three"),M=new E,T=new A;class I{constructor(e,t,n,o,s){let i;this.controller=t,this.handModel=e,this.envMap=null,s&&s.primitive&&"sphere"!==s.primitive?"box"===s.primitive&&(i=new N(1,1,1)):i=new w(1,10,10);const a=new C;this.handMesh=new S(i,a,30),this.handMesh.frustumCulled=!1,this.handMesh.instanceMatrix.setUsage(b),this.handMesh.castShadow=!0,this.handMesh.receiveShadow=!0,this.handModel.add(this.handMesh),this.joints=["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]}updateMesh(){const e=this.controller.joints;let t=0;for(let n=0;n<this.joints.length;n++){const o=e[this.joints[n]];o.visible&&(T.setScalar(o.jointRadius||.008),M.compose(o.position,o.quaternion,T),this.handMesh.setMatrixAt(n,M),t++)}this.handMesh.count=t,this.handMesh.instanceMatrix.needsUpdate=!0}}const{Object3D:P}=await t("three");class j extends P{constructor(e){super(),this.controller=e,this.motionController=null,this.envMap=null,this.mesh=null}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&this.motionController.updateMesh()}}class L{constructor(e=null,t=null){this.gltfLoader=e,this.path=null,this.onLoad=t}setPath(e){return this.path=e,this}createHandModel(e,t){const n=new j(e);return e.addEventListener("connected",o=>{const i=o.data;i.hand&&!n.motionController&&(n.xrInputSource=i,void 0===t||"spheres"===t?n.motionController=new I(n,e,this.path,i.handedness,{primitive:"sphere"}):"boxes"===t?n.motionController=new I(n,e,this.path,i.handedness,{primitive:"box"}):"mesh"===t&&(n.motionController=new s(n,e,this.path,i.handedness,this.gltfLoader,this.onLoad))),e.visible=!0}),e.addEventListener("disconnected",()=>{e.visible=!1}),n}}const{defineComponent:R}=await t("vue"),{unref:O,renderSlot:k,createElementVNode:U,Fragment:B,openBlock:D,createElementBlock:F}=await t("vue"),V=["object"],$=["geometry"],G=["object"],H=["geometry"],X=["object"],z=["object"],q=["object"],_=["object"],W=await t("three"),Y=R({__name:"XRcom",props:{sessionInit:{default:{requiredFeatures:["hand-tracking"]}}},setup(e,{expose:t}){const s=e,{renderer:a,camera:r,scene:l}=n();a.xr.enabled=!0;const d=i.createButton(a,s.sessionInit);d.style.zIndex="999999",document.body.appendChild(d);const h=a.xr.getController(0),p=a.xr.getController(1),c=new y,u=new L,m=a.xr.getControllerGrip(0);m.add(c.createControllerModel(m));const x=a.xr.getHand(0);x.add(u.createHandModel(x));const f=a.xr.getControllerGrip(1);f.add(c.createControllerModel(f));const v=a.xr.getHand(1);v.add(u.createHandModel(v));const g=(new W.BufferGeometry).setFromPoints([new W.Vector3(0,0,0),new W.Vector3(0,0,-1)]),b=o(),w=o();return a.setAnimationLoop(()=>{b.trigger(),a.render(l.value,r.value),w.trigger()}),t({controller0:h,controller1:p,onBeforeLoop:b.on,onAfterLoop:w.on}),(e,t)=>(D(),F(B,null,[U("primitive",{object:O(h)},[k(e.$slots,"controller0",{},()=>[U("TresLine",{scale:[1,1,5],geometry:O(g)},null,8,$)])],8,V),U("primitive",{object:O(p)},[k(e.$slots,"controller1",{},()=>[U("TresLine",{scale:[1,1,5],geometry:O(g)},null,8,H)])],8,G),U("primitive",{object:O(m)},null,8,X),U("primitive",{object:O(x)},null,8,z),U("primitive",{object:O(f)},null,8,q),U("primitive",{object:O(v)},null,8,_)],64))}});export{Y as _sfc_main};
