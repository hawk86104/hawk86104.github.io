import{importShared as e}from"./3d-tiles-renderer.6uaxtGOi1769565599278.js";import{useTres as t,TresCanvas_default as n,OrbitControls_default as a}from"./index.CG-C7MIu1769565599278.js";import{shaderMaterial as o}from"./shaderMaterial.CbTiUBVQ1769565599278.js";import{Pane as r}from"./tweakpane.BbuIEN141769565599278.js";const l=await e("three"),i=o({alphaTest:0,viewport:new l.Vector2(1980,1080),focal:1e3,centerAndScaleTexture:null,covAndColorTexture:null},"\n    precision highp sampler2D;\n    precision highp usampler2D;\n    out vec4 vColor;\n    out vec3 vPosition;\n    uniform vec2 resolution;\n    uniform vec2 viewport;\n    uniform float focal;\n    attribute uint splatIndex;\n    uniform sampler2D centerAndScaleTexture;\n    uniform usampler2D covAndColorTexture;    \n\n    vec2 unpackInt16(in uint value) {\n      int v = int(value);\n      int v0 = v >> 16;\n      int v1 = (v & 0xFFFF);\n      if((v & 0x8000) != 0)\n        v1 |= 0xFFFF0000;\n      return vec2(float(v1), float(v0));\n    }\n\n    void main () {\n      ivec2 texSize = textureSize(centerAndScaleTexture, 0);\n      ivec2 texPos = ivec2(splatIndex%uint(texSize.x), splatIndex/uint(texSize.x));\n      vec4 centerAndScaleData = texelFetch(centerAndScaleTexture, texPos, 0);\n      vec4 center = vec4(centerAndScaleData.xyz, 1);\n      vec4 camspace = modelViewMatrix * center;\n      vec4 pos2d = projectionMatrix * camspace;\n\n      float bounds = 1.2 * pos2d.w;\n      if (pos2d.z < -pos2d.w || pos2d.x < -bounds || pos2d.x > bounds\n        || pos2d.y < -bounds || pos2d.y > bounds) {\n        gl_Position = vec4(0.0, 0.0, 2.0, 1.0);\n        return;\n      }\n\n      uvec4 covAndColorData = texelFetch(covAndColorTexture, texPos, 0);\n      vec2 cov3D_M11_M12 = unpackInt16(covAndColorData.x) * centerAndScaleData.w;\n      vec2 cov3D_M13_M22 = unpackInt16(covAndColorData.y) * centerAndScaleData.w;\n      vec2 cov3D_M23_M33 = unpackInt16(covAndColorData.z) * centerAndScaleData.w;\n      mat3 Vrk = mat3(\n        cov3D_M11_M12.x, cov3D_M11_M12.y, cov3D_M13_M22.x,\n        cov3D_M11_M12.y, cov3D_M13_M22.y, cov3D_M23_M33.x,\n        cov3D_M13_M22.x, cov3D_M23_M33.x, cov3D_M23_M33.y\n      );\n\n      mat3 J = mat3(\n        focal / camspace.z, 0., -(focal * camspace.x) / (camspace.z * camspace.z),\n        0., focal / camspace.z, -(focal * camspace.y) / (camspace.z * camspace.z),\n        0., 0., 0.\n      );\n\n      mat3 W = transpose(mat3(modelViewMatrix));\n      mat3 T = W * J;\n      mat3 cov = transpose(T) * Vrk * T;\n      vec2 vCenter = vec2(pos2d) / pos2d.w;\n      float diagonal1 = cov[0][0] + 0.3;\n      float offDiagonal = cov[0][1];\n      float diagonal2 = cov[1][1] + 0.3;\n      float mid = 0.5 * (diagonal1 + diagonal2);\n      float radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));\n      float lambda1 = mid + radius;\n      float lambda2 = max(mid - radius, 0.1);\n      vec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));\n      vec2 v1 = min(sqrt(2.0 * lambda1), 1024.0) * diagonalVector;\n      vec2 v2 = min(sqrt(2.0 * lambda2), 1024.0) * vec2(diagonalVector.y, -diagonalVector.x);\n      uint colorUint = covAndColorData.w;\n      vColor = vec4(\n        float(colorUint & uint(0xFF)) / 255.0,\n        float((colorUint >> uint(8)) & uint(0xFF)) / 255.0,\n        float((colorUint >> uint(16)) & uint(0xFF)) / 255.0,\n        float(colorUint >> uint(24)) / 255.0\n      );\n      vPosition = position;\n\n      gl_Position = vec4(\n        vCenter \n          + position.x * v2 / viewport * 2.0 \n          + position.y * v1 / viewport * 2.0, pos2d.z / pos2d.w, 1.0);\n    }\n    ",`\n    #include <alphatest_pars_fragment>\n    #include <alphahash_pars_fragment>\n    in vec4 vColor;\n    in vec3 vPosition;\n    void main () {\n      float A = -dot(vPosition.xy, vPosition.xy);\n      if (A < -4.0) discard;\n      float B = exp(A) * vColor.a;\n      vec4 diffuseColor = vec4(vColor.rgb, B);\n      #include <alphatest_fragment>\n      #include <alphahash_fragment>\n      gl_FragColor = diffuseColor;\n      #include <tonemapping_fragment>\n      #include <${parseInt(l.REVISION.replace(/\D+/g,""))>=154?"colorspace_fragment":"encodings_fragment"}>\n    }\n  `);function s(e){let t=null,n=0;e.onmessage=a=>{if("push"==a.data.method){0===n&&(t=new Float32Array(a.data.length));const e=new Float32Array(a.data.matrices);t.set(e,n),n+=e.length}else if("sort"==a.data.method&&null!==t){const n=function(e,n=!1){const a=t.length/16;let o=-1/0,r=1/0;const l=new Float32Array(a),i=new Int32Array(l.buffer),s=new Int32Array(a);let c=0;for(let m=0;m<a;m++){const a=e[0]*t[16*m+12]+e[1]*t[16*m+13]+e[2]*t[16*m+14]+e[3];(n||a<0&&t[16*m+15]>-1e-4*a)&&(l[c]=a,s[c]=m,c++,a>o&&(o=a),a<r&&(r=a))}const u=65535/(o-r),d=new Uint32Array(65536);for(let t=0;t<c;t++)i[t]=(l[t]-r)*u|0,d[i[t]]++;const f=new Uint32Array(65536);for(let t=1;t<65536;t++)f[t]=f[t-1]+d[t-1];const p=new Uint32Array(c);for(let t=0;t<c;t++)p[f[i[t]]++]=s[t];return p}(new Float32Array(a.data.view),a.data.hashed);e.postMessage({indices:n,key:a.data.key},[n.buffer])}}}class c extends l.Loader{constructor(e,t=25e3){super(),this.gl=e,this.chunkSize=t}async loadAsync(e,t,n){return new Promise(a=>this.load(e,a,t,n))}load(e,t,n,a){const o={gl:this.gl,url:this.manager.resolveURL(e),worker:new Worker(URL.createObjectURL(new Blob(["(",s.toString(),")(self)"],{type:"application/javascript"}))),manager:this.manager,update:(e,t,n)=>function(e,t,n,a){if(e.updateMatrixWorld(),t.gl.getCurrentViewport(n.viewport),n.material.viewport.x=n.viewport.z,n.material.viewport.y=n.viewport.w,n.material.focal=n.viewport.w/2*Math.abs(e.projectionMatrix.elements[5]),n.ready){if(a&&n.sorted)return;n.ready=!1;const e=new Float32Array([n.modelViewMatrix.elements[2],-n.modelViewMatrix.elements[6],n.modelViewMatrix.elements[10],n.modelViewMatrix.elements[14]]);t.worker.postMessage({method:"sort",src:t.url,key:n.uuid,view:e.buffer,hashed:a},[e.buffer]),a&&t.loaded&&(n.sorted=!0)}}(t,o,e,n),connect:e=>function(e,t){e.loading||async function(e){e.loading=!0;let t=0,n=0;const a=[];let o=0;const r=0!==e.totalDownloadBytes;for(;;)try{const{value:l,done:i}=await e.stream.read();if(i)break;if(t+=l.length,null!=e.totalDownloadBytes){const n=t/e.totalDownloadBytes*100;if(e.onProgress&&n-o>1){const a=new ProgressEvent("progress",{lengthComputable:r,loaded:t,total:e.totalDownloadBytes});e.onProgress(a),o=n}}a.push(l);const s=t-n;if(null!=e.totalDownloadBytes&&s>e.rowLength*e.chunkSize){const t=Math.floor(s/e.rowLength),o=new Uint8Array(s);let l=0;for(const e of a)o.set(e,l),l+=e.length;if(a.length=0,s>t*e.rowLength){const n=new Uint8Array(s-t*e.rowLength);n.set(o.subarray(s-n.length,s),0),a.push(n)}const i=new Uint8Array(t*e.rowLength);i.set(o.subarray(0,i.byteLength),0);const c=u(e,i.buffer,t);if(e.worker.postMessage({method:"push",src:e.url,length:16*e.numVertices,matrices:c.buffer},[c.buffer]),n+=t*e.rowLength,e.onProgress){const t=new ProgressEvent("progress",{lengthComputable:r,loaded:e.totalDownloadBytes,total:e.totalDownloadBytes});e.onProgress(t)}}}catch(l){console.error(l);break}if(t-n>0){const t=new Uint8Array(a.reduce((e,t)=>e+t.length,0));let n=0;for(const e of a)t.set(e,n),n+=e.length;const o=Math.floor(t.byteLength/e.rowLength),r=u(e,t.buffer,o);e.worker.postMessage({method:"push",src:e.url,length:16*o,matrices:r.buffer},[r.buffer])}e.loaded=!0,e.manager.itemEnd(e.url)}(e);t.ready=!1,t.pm=new l.Matrix4,t.vm1=new l.Matrix4,t.vm2=new l.Matrix4,t.viewport=new l.Vector4;const n=new Uint32Array(e.bufferTextureWidth*e.bufferTextureHeight),a=new l.InstancedBufferAttribute(n,1,!1);a.setUsage(l.DynamicDrawUsage);const o=t.geometry=new l.InstancedBufferGeometry,r=new Float32Array(18),i=new l.BufferAttribute(r,3);function s(e){if(t&&e.data.key===t.uuid){const n=new Uint32Array(e.data.indices);o.attributes.splatIndex.set(n),o.attributes.splatIndex.needsUpdate=!0,o.instanceCount=n.length,t.ready=!0}}async function c(){for(;;){const t=e.gl.properties.get(e.centerAndScaleTexture),n=e.gl.properties.get(e.covAndColorTexture);if(null!=t&&t.__webglTexture&&null!=n&&n.__webglTexture&&e.loadedVertexCount>0)break;await new Promise(e=>setTimeout(e,10))}t.ready=!0}return o.setAttribute("position",i),i.setXYZ(2,-2,2,0),i.setXYZ(1,2,2,0),i.setXYZ(0,-2,-2,0),i.setXYZ(5,-2,-2,0),i.setXYZ(4,2,2,0),i.setXYZ(3,2,-2,0),i.needsUpdate=!0,o.setAttribute("splatIndex",a),o.instanceCount=1,e.worker.addEventListener("message",s),c(),()=>e.worker.removeEventListener("message",s)}(o,e),loading:!1,loaded:!1,loadedVertexCount:0,chunkSize:this.chunkSize,totalDownloadBytes:0,numVertices:0,rowLength:32,maxVertexes:0,bufferTextureWidth:0,bufferTextureHeight:0,stream:null,centerAndScaleData:null,covAndColorData:null,covAndColorTexture:null,centerAndScaleTexture:null,onProgress:n};(async function(e){e.manager.itemStart(e.url);const t=await fetch(e.url);if(null===t.body)throw"Failed to fetch file";const n=t.headers.get("Content-Length"),a=n?parseInt(n):void 0;if(null==a)throw"Failed to get content length";e.stream=t.body.getReader(),e.totalDownloadBytes=a,e.numVertices=Math.floor(e.totalDownloadBytes/e.rowLength);const o=e.gl.getContext(),r=o.getParameter(o.MAX_TEXTURE_SIZE);e.maxVertexes=r*r,e.numVertices>e.maxVertexes&&(e.numVertices=e.maxVertexes);return e.bufferTextureWidth=r,e.bufferTextureHeight=Math.floor((e.numVertices-1)/r)+1,e.centerAndScaleData=new Float32Array(e.bufferTextureWidth*e.bufferTextureHeight*4),e.covAndColorData=new Uint32Array(e.bufferTextureWidth*e.bufferTextureHeight*4),e.centerAndScaleTexture=new l.DataTexture(e.centerAndScaleData,e.bufferTextureWidth,e.bufferTextureHeight,l.RGBAFormat,l.FloatType),e.centerAndScaleTexture.needsUpdate=!0,e.covAndColorTexture=new l.DataTexture(e.covAndColorData,e.bufferTextureWidth,e.bufferTextureHeight,l.RGBAIntegerFormat,l.UnsignedIntType),e.covAndColorTexture.internalFormat="RGBA32UI",e.covAndColorTexture.needsUpdate=!0,e})(o).then(t).catch(e=>{null==a||a(e),o.manager.itemError(o.url)})}}function u(e,t,n){const a=e.gl.getContext();if(e.loadedVertexCount+n>e.maxVertexes&&(n=e.maxVertexes-e.loadedVertexCount),n<=0)throw"Failed to parse file";const o=new Uint8Array(t),r=new Float32Array(t),i=new Float32Array(16*n),s=new Uint8Array(e.covAndColorData.buffer),c=new Int16Array(e.covAndColorData.buffer);for(let u=0;u<n;u++){const t=new l.Quaternion(-(o[32*u+28+1]-128)/128,(o[32*u+28+2]-128)/128,(o[32*u+28+3]-128)/128,-(o[32*u+28+0]-128)/128);t.invert();const n=new l.Vector3(r[8*u+0],r[8*u+1],-r[8*u+2]),a=new l.Vector3(r[8*u+3+0],r[8*u+3+1],r[8*u+3+2]),d=new l.Matrix4;d.makeRotationFromQuaternion(t),d.transpose(),d.scale(a);const f=d.clone();d.transpose(),d.premultiply(f),d.setPosition(n);const p=[0,1,2,5,6,10];let m=0;for(let e=0;e<p.length;e++)Math.abs(d.elements[p[e]])>m&&(m=Math.abs(d.elements[p[e]]));let g=4*e.loadedVertexCount+4*u;e.centerAndScaleData[g+0]=n.x,e.centerAndScaleData[g+1]=-n.y,e.centerAndScaleData[g+2]=n.z,e.centerAndScaleData[g+3]=m/32767,g=8*e.loadedVertexCount+4*u*2;for(let e=0;e<p.length;e++)c[g+e]=32767*d.elements[p[e]]/m;g=16*e.loadedVertexCount+4*(4*u+3);const v=new l.Color(o[32*u+24+0]/255,o[32*u+24+1]/255,o[32*u+24+2]/255);v.convertSRGBToLinear(),s[g+0]=255*v.r,s[g+1]=255*v.g,s[g+2]=255*v.b,s[g+3]=o[32*u+24+3],d.elements[15]=Math.max(a.x,a.y,a.z)*o[32*u+24+3]/255;for(let e=0;e<16;e++)i[16*u+e]=d.elements[e]}for(;n>0;){let t=0,o=0;const r=e.loadedVertexCount%e.bufferTextureWidth,l=Math.floor(e.loadedVertexCount/e.bufferTextureWidth);e.loadedVertexCount%e.bufferTextureWidth!=0?(t=Math.min(e.bufferTextureWidth,r+n)-r,o=1):Math.floor(n/e.bufferTextureWidth)>0?(t=e.bufferTextureWidth,o=Math.floor(n/e.bufferTextureWidth)):(t=n%e.bufferTextureWidth,o=1);const i=e.gl.properties.get(e.centerAndScaleTexture);a.bindTexture(a.TEXTURE_2D,i.__webglTexture),a.texSubImage2D(a.TEXTURE_2D,0,r,l,t,o,a.RGBA,a.FLOAT,e.centerAndScaleData,4*e.loadedVertexCount);const s=e.gl.properties.get(e.covAndColorTexture);a.bindTexture(a.TEXTURE_2D,s.__webglTexture),a.texSubImage2D(a.TEXTURE_2D,0,r,l,t,o,a.RGBA_INTEGER,a.UNSIGNED_INT,e.covAndColorData,4*e.loadedVertexCount),e.gl.resetState(),e.loadedVertexCount+=t*o,n-=t*o}return i}class d extends l.Mesh{constructor(e,t,{toneMapped:n=!1,alphaTest:a=0,alphaHash:o=!1}={}){super(),this.frustumCulled=!1,this.onBeforeRender=()=>e.update(this,t,o),this.material=new i,Object.assign(this.material,{transparent:!o,depthTest:!0,alphaTest:o?0:a,centerAndScaleTexture:e.centerAndScaleTexture,covAndColorTexture:e.covAndColorTexture,depthWrite:!!o||a>0,blending:o?l.NormalBlending:l.CustomBlending,blendSrcAlpha:l.OneFactor,alphaHash:!!o,toneMapped:n}),e.connect(this)}}const{withAsyncContext:f,defineComponent:p}=await e("vue"),{openBlock:m,createElementBlock:g}=await e("vue"),v=["object"],{watch:x,onUnmounted:h,ref:w,toRaw:y}=await e("vue"),A=p({__name:"splat",props:{url:{type:String,default:"./plugins/gaussianSplatting/model/luigi.splat"}},async setup(e){let n,a;const o=e,{camera:r,renderer:l}=t(),i=new c(l);let s=([n,a]=f(()=>i.loadAsync(o.url)),n=await n,a(),n);const u=w(null);u.value=new d(s,r.value,{alphaTest:.1}),x(()=>o.url,async e=>{e&&(s=await i.loadAsync(e)),p(),u.value=new d(s,r.value,{alphaTest:.1})});const p=()=>{u.value&&(u.value.geometry.dispose(),u.value.material&&u.value.material.dispose())};return h(()=>{p()}),(e,t)=>(m(),g("primitive",{object:y(u.value)},null,8,v))}}),{defineComponent:b}=await e("vue"),{createElementVNode:T,unref:D,createVNode:M,mergeProps:C,Suspense:_,withCtx:S,openBlock:V,createBlock:U}=await e("vue"),{SRGBColorSpace:F,BasicShadowMap:B,NoToneMapping:k}=await e("three"),{reactive:I,onMounted:P}=await e("vue"),z=b({__name:"splatPage",setup(e){const t=I({clearColor:"#ffffff",alpha:!1,shadowMapType:B,outputColorSpace:F,toneMapping:k}),o=I({url:"./plugins/gaussianSplatting/model/luigi.splat"}),l=new r({title:"参数",expanded:!0}),i=document.createElement("input");i.type="file",i.accept=".splat",i.style.display="none",document.body.appendChild(i);return l.addButton({title:"替换splat文件",label:"500MB以内"}).on("click",()=>{i&&(i.value="",i.click())}),P(()=>{i.onchange=e=>{const t=e.target.files[0];if(!t)return;if(t.size>524288e3)return void alert("文件大小不能超过500MB");const n=URL.createObjectURL(t);o.url=n}}),(e,r)=>(V(),U(D(n),C(t,{"window-size":""}),{default:S(()=>[r[0]||(r[0]=T("TresPerspectiveCamera",{position:[3,3,3],fov:45,near:.1,far:1e3,"look-at":[0,0,0]},null,-1)),M(D(a)),r[1]||(r[1]=T("TresAmbientLight",{intensity:3},null,-1)),(V(),U(_,null,{default:S(()=>[M(A,C(o,{position:[0,.7,0],"rotate-x":-Math.PI}),null,16,["rotate-x"])]),_:1})),r[2]||(r[2]=T("TresDirectionalLight",{position:[6,2,4],intensity:2},null,-1)),r[3]||(r[3]=T("TresGridHelper",null,null,-1))]),_:1},16))}});export{z as default};
