import{bL as ns,et as ne,bM as St,aD as j,c_ as D,cC as rs,eu as os,cc as is,bR as te,a8 as oe,b6 as k,aL as xe,bl as M,ba as y,bf as wt,cu as as,bS as Et,bq as cs,ev as ls,az as G,ew as us,aM as Rt,cK as Lt,bs as He,bP as Mt,bO as Re,bN as hs,c5 as It,at as ds,ex as fs,ay as Ct,be as ps,aA as ms,bQ as gs,e8 as Ts,cY as _s,aC as Nt,bc as re,bk as As,aX as K,aK as bs,ey as xs,ez as ys,eA as Ss,eB as Ot,eh as Qe,bp as je,aG as ws,eC as Es,eD as Rs,eE as Ls,cE as Ms,eF as Is,eG as Cs,by as Ns,cm as Os,c6 as Ye,bK as Ps,bJ as Fs,eH as Je,eI as $e,eJ as Ze,bx as Pt,bw as ze,eK as vs,eL as ae,bz as Ke,bg as Ft,b9 as Ds,cW as vt,bF as ks,cJ as Bs,eb as Us,e5 as Hs}from"./vendor.FqxLcdZR1717389855480.js";import{a as et}from"./BufferGeometryUtils.MI6PQeCK1717389855480.js";class qe extends ns{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new Ks(t)}),this.register(function(t){return new en(t)}),this.register(function(t){return new tn(t)}),this.register(function(t){return new sn(t)}),this.register(function(t){return new Ws(t)}),this.register(function(t){return new Xs(t)}),this.register(function(t){return new Qs(t)}),this.register(function(t){return new Ys(t)}),this.register(function(t){return new zs(t)}),this.register(function(t){return new Js(t)}),this.register(function(t){return new qs(t)}),this.register(function(t){return new Zs(t)}),this.register(function(t){return new $s(t)}),this.register(function(t){return new Gs(t)}),this.register(function(t){return new nn(t)}),this.register(function(t){return new rn(t)})}load(e,t,s,n){const r=this;let o;if(this.resourcePath!=="")o=this.resourcePath;else if(this.path!==""){const c=ne.extractUrlBase(e);o=ne.resolveURL(c,this.path)}else o=ne.extractUrlBase(e);this.manager.itemStart(e);const i=function(c){n?n(c):console.error(c),r.manager.itemError(e),r.manager.itemEnd(e)},a=new St(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,function(c){try{r.parse(c,o,function(h){t(h),r.manager.itemEnd(e)},i)}catch(h){i(h)}},s,i)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,n){let r;const o={},i={},a=new TextDecoder;if(typeof e=="string")r=JSON.parse(e);else if(e instanceof ArrayBuffer)if(a.decode(new Uint8Array(e,0,4))===Dt){try{o[E.KHR_BINARY_GLTF]=new on(e)}catch(u){n&&n(u);return}r=JSON.parse(o[E.KHR_BINARY_GLTF].content)}else r=JSON.parse(a.decode(e));else r=e;if(r.asset===void 0||r.asset.version[0]<2){n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const c=new An(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let h=0;h<this.pluginCallbacks.length;h++){const u=this.pluginCallbacks[h](c);u.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),i[u.name]=u,o[u.name]=!0}if(r.extensionsUsed)for(let h=0;h<r.extensionsUsed.length;++h){const u=r.extensionsUsed[h],d=r.extensionsRequired||[];switch(u){case E.KHR_MATERIALS_UNLIT:o[u]=new js;break;case E.KHR_DRACO_MESH_COMPRESSION:o[u]=new an(r,this.dracoLoader);break;case E.KHR_TEXTURE_TRANSFORM:o[u]=new cn;break;case E.KHR_MESH_QUANTIZATION:o[u]=new ln;break;default:d.indexOf(u)>=0&&i[u]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+u+'".')}}c.setExtensions(o),c.setPlugins(i),c.parse(s,n)}parseAsync(e,t){const s=this;return new Promise(function(n,r){s.parse(e,t,n,r)})}}function Vs(){let l={};return{get:function(e){return l[e]},add:function(e,t){l[e]=t},remove:function(e){delete l[e]},removeAll:function(){l={}}}}const E={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class Gs{constructor(e){this.parser=e,this.name=E.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,n=t.length;s<n;s++){const r=t[s];r.extensions&&r.extensions[this.name]&&r.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let n=t.cache.get(s);if(n)return n;const r=t.json,a=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let c;const h=new j(16777215);a.color!==void 0&&h.setRGB(a.color[0],a.color[1],a.color[2],D);const u=a.range!==void 0?a.range:0;switch(a.type){case"directional":c=new is(h),c.target.position.set(0,0,-1),c.add(c.target);break;case"point":c=new os(h),c.distance=u;break;case"spot":c=new rs(h),c.distance=u,a.spot=a.spot||{},a.spot.innerConeAngle=a.spot.innerConeAngle!==void 0?a.spot.innerConeAngle:0,a.spot.outerConeAngle=a.spot.outerConeAngle!==void 0?a.spot.outerConeAngle:Math.PI/4,c.angle=a.spot.outerConeAngle,c.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return c.position.set(0,0,0),c.decay=2,V(c,a),a.intensity!==void 0&&(c.intensity=a.intensity),c.name=t.createUniqueName(a.name||"light_"+e),n=Promise.resolve(c),t.cache.add(s,n),n}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,r=s.json.nodes[e],i=(r.extensions&&r.extensions[this.name]||{}).light;return i===void 0?null:this._loadLight(i).then(function(a){return s._getNodeRef(t.cache,i,a)})}}class js{constructor(){this.name=E.KHR_MATERIALS_UNLIT}getMaterialType(){return te}extendParams(e,t,s){const n=[];e.color=new j(1,1,1),e.opacity=1;const r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const o=r.baseColorFactor;e.color.setRGB(o[0],o[1],o[2],D),e.opacity=o[3]}r.baseColorTexture!==void 0&&n.push(s.assignTexture(e,"map",r.baseColorTexture,oe))}return Promise.all(n)}}class zs{constructor(e){this.parser=e,this.name=E.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name].emissiveStrength;return r!==void 0&&(t.emissiveIntensity=r),Promise.resolve()}}class Ks{constructor(e){this.parser=e,this.name=E.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:k}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];if(o.clearcoatFactor!==void 0&&(t.clearcoat=o.clearcoatFactor),o.clearcoatTexture!==void 0&&r.push(s.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),o.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),o.clearcoatRoughnessTexture!==void 0&&r.push(s.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),o.clearcoatNormalTexture!==void 0&&(r.push(s.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),o.clearcoatNormalTexture.scale!==void 0)){const i=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new xe(i,i)}return Promise.all(r)}}class qs{constructor(e){this.parser=e,this.name=E.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:k}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return o.iridescenceFactor!==void 0&&(t.iridescence=o.iridescenceFactor),o.iridescenceTexture!==void 0&&r.push(s.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),o.iridescenceIor!==void 0&&(t.iridescenceIOR=o.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),o.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),o.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),o.iridescenceThicknessTexture!==void 0&&r.push(s.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(r)}}class Ws{constructor(e){this.parser=e,this.name=E.KHR_MATERIALS_SHEEN}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:k}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[];t.sheenColor=new j(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=n.extensions[this.name];if(o.sheenColorFactor!==void 0){const i=o.sheenColorFactor;t.sheenColor.setRGB(i[0],i[1],i[2],D)}return o.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=o.sheenRoughnessFactor),o.sheenColorTexture!==void 0&&r.push(s.assignTexture(t,"sheenColorMap",o.sheenColorTexture,oe)),o.sheenRoughnessTexture!==void 0&&r.push(s.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(r)}}class Xs{constructor(e){this.parser=e,this.name=E.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:k}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return o.transmissionFactor!==void 0&&(t.transmission=o.transmissionFactor),o.transmissionTexture!==void 0&&r.push(s.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(r)}}class Qs{constructor(e){this.parser=e,this.name=E.KHR_MATERIALS_VOLUME}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:k}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];t.thickness=o.thicknessFactor!==void 0?o.thicknessFactor:0,o.thicknessTexture!==void 0&&r.push(s.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const i=o.attenuationColor||[1,1,1];return t.attenuationColor=new j().setRGB(i[0],i[1],i[2],D),Promise.all(r)}}class Ys{constructor(e){this.parser=e,this.name=E.KHR_MATERIALS_IOR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:k}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name];return t.ior=r.ior!==void 0?r.ior:1.5,Promise.resolve()}}class Js{constructor(e){this.parser=e,this.name=E.KHR_MATERIALS_SPECULAR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:k}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];t.specularIntensity=o.specularFactor!==void 0?o.specularFactor:1,o.specularTexture!==void 0&&r.push(s.assignTexture(t,"specularIntensityMap",o.specularTexture));const i=o.specularColorFactor||[1,1,1];return t.specularColor=new j().setRGB(i[0],i[1],i[2],D),o.specularColorTexture!==void 0&&r.push(s.assignTexture(t,"specularColorMap",o.specularColorTexture,oe)),Promise.all(r)}}class $s{constructor(e){this.parser=e,this.name=E.EXT_MATERIALS_BUMP}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:k}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return t.bumpScale=o.bumpFactor!==void 0?o.bumpFactor:1,o.bumpTexture!==void 0&&r.push(s.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(r)}}class Zs{constructor(e){this.parser=e,this.name=E.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:k}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return o.anisotropyStrength!==void 0&&(t.anisotropy=o.anisotropyStrength),o.anisotropyRotation!==void 0&&(t.anisotropyRotation=o.anisotropyRotation),o.anisotropyTexture!==void 0&&r.push(s.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(r)}}class en{constructor(e){this.parser=e,this.name=E.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,n=s.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const r=n.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r.source,o)}}class tn{constructor(e){this.parser=e,this.name=E.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,r=n.textures[e];if(!r.extensions||!r.extensions[t])return null;const o=r.extensions[t],i=n.images[o.source];let a=s.textureLoader;if(i.uri){const c=s.options.manager.getHandler(i.uri);c!==null&&(a=c)}return this.detectSupport().then(function(c){if(c)return s.loadTextureImage(e,o.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class sn{constructor(e){this.parser=e,this.name=E.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,r=n.textures[e];if(!r.extensions||!r.extensions[t])return null;const o=r.extensions[t],i=n.images[o.source];let a=s.textureLoader;if(i.uri){const c=s.options.manager.getHandler(i.uri);c!==null&&(a=c)}return this.detectSupport().then(function(c){if(c)return s.loadTextureImage(e,o.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class nn{constructor(e){this.name=E.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const n=s.extensions[this.name],r=this.parser.getDependency("buffer",n.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return r.then(function(i){const a=n.byteOffset||0,c=n.byteLength||0,h=n.count,u=n.byteStride,d=new Uint8Array(i,a,c);return o.decodeGltfBufferAsync?o.decodeGltfBufferAsync(h,u,d,n.mode,n.filter).then(function(f){return f.buffer}):o.ready.then(function(){const f=new ArrayBuffer(h*u);return o.decodeGltfBuffer(new Uint8Array(f),h,u,d,n.mode,n.filter),f})})}else return null}}class rn{constructor(e){this.name=E.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||s.mesh===void 0)return null;const n=t.meshes[s.mesh];for(const c of n.primitives)if(c.mode!==N.TRIANGLES&&c.mode!==N.TRIANGLE_STRIP&&c.mode!==N.TRIANGLE_FAN&&c.mode!==void 0)return null;const o=s.extensions[this.name].attributes,i=[],a={};for(const c in o)i.push(this.parser.getDependency("accessor",o[c]).then(h=>(a[c]=h,a[c])));return i.length<1?null:(i.push(this.parser.createNodeMesh(e)),Promise.all(i).then(c=>{const h=c.pop(),u=h.isGroup?h.children:[h],d=c[0].count,f=[];for(const p of u){const T=new M,m=new y,g=new je,_=new y(1,1,1),S=new wt(p.geometry,p.material,d);for(let b=0;b<d;b++)a.TRANSLATION&&m.fromBufferAttribute(a.TRANSLATION,b),a.ROTATION&&g.fromBufferAttribute(a.ROTATION,b),a.SCALE&&_.fromBufferAttribute(a.SCALE,b),S.setMatrixAt(b,T.compose(m,g,_));for(const b in a)if(b==="_COLOR_0"){const w=a[b];S.instanceColor=new as(w.array,w.itemSize,w.normalized)}else b!=="TRANSLATION"&&b!=="ROTATION"&&b!=="SCALE"&&p.geometry.setAttribute(b,a[b]);Et.prototype.copy.call(S,p),this.parser.assignFinalMaterial(S),f.push(S)}return h.isGroup?(h.clear(),h.add(...f),h):f[0]}))}}const Dt="glTF",Z=12,tt={JSON:1313821514,BIN:5130562};class on{constructor(e){this.name=E.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,Z),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Dt)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-Z,r=new DataView(e,Z);let o=0;for(;o<n;){const i=r.getUint32(o,!0);o+=4;const a=r.getUint32(o,!0);if(o+=4,a===tt.JSON){const c=new Uint8Array(e,Z+o,i);this.content=s.decode(c)}else if(a===tt.BIN){const c=Z+o;this.body=e.slice(c,c+i)}o+=i}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class an{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=E.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,n=this.dracoLoader,r=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,i={},a={},c={};for(const h in o){const u=Ve[h]||h.toLowerCase();i[u]=o[h]}for(const h in e.attributes){const u=Ve[h]||h.toLowerCase();if(o[h]!==void 0){const d=s.accessors[e.attributes[h]],f=J[d.componentType];c[u]=f.name,a[u]=d.normalized===!0}}return t.getDependency("bufferView",r).then(function(h){return new Promise(function(u,d){n.decodeDracoFile(h,function(f){for(const p in f.attributes){const T=f.attributes[p],m=a[p];m!==void 0&&(T.normalized=m)}u(f)},i,c,D,d)})})}}class cn{constructor(){this.name=E.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class ln{constructor(){this.name=E.KHR_MESH_QUANTIZATION}}class kt extends vs{constructor(e,t,s,n){super(e,t,s,n)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,n=this.valueSize,r=e*n*3+n;for(let o=0;o!==n;o++)t[o]=s[r+o];return t}interpolate_(e,t,s,n){const r=this.resultBuffer,o=this.sampleValues,i=this.valueSize,a=i*2,c=i*3,h=n-t,u=(s-t)/h,d=u*u,f=d*u,p=e*c,T=p-c,m=-2*f+3*d,g=f-d,_=1-m,S=g-d+u;for(let b=0;b!==i;b++){const w=o[T+b+i],x=o[T+b+a]*h,A=o[p+b+i],L=o[p+b]*h;r[b]=_*w+S*x+m*A+g*L}return r}}const un=new je;class hn extends kt{interpolate_(e,t,s,n){const r=super.interpolate_(e,t,s,n);return un.fromArray(r).normalize().toArray(r),r}}const N={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},J={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},st={9728:ws,9729:Rt,9984:Es,9985:Rs,9986:Ls,9987:Lt},nt={33071:Ms,33648:Is,10497:He},Le={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Ve={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},B={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},dn={CUBICSPLINE:void 0,LINEAR:Ot,STEP:Cs},Me={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function fn(l){return l.DefaultMaterial===void 0&&(l.DefaultMaterial=new It({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Ns})),l.DefaultMaterial}function z(l,e,t){for(const s in t.extensions)l[s]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[s]=t.extensions[s])}function V(l,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(l.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function pn(l,e,t){let s=!1,n=!1,r=!1;for(let c=0,h=e.length;c<h;c++){const u=e[c];if(u.POSITION!==void 0&&(s=!0),u.NORMAL!==void 0&&(n=!0),u.COLOR_0!==void 0&&(r=!0),s&&n&&r)break}if(!s&&!n&&!r)return Promise.resolve(l);const o=[],i=[],a=[];for(let c=0,h=e.length;c<h;c++){const u=e[c];if(s){const d=u.POSITION!==void 0?t.getDependency("accessor",u.POSITION):l.attributes.position;o.push(d)}if(n){const d=u.NORMAL!==void 0?t.getDependency("accessor",u.NORMAL):l.attributes.normal;i.push(d)}if(r){const d=u.COLOR_0!==void 0?t.getDependency("accessor",u.COLOR_0):l.attributes.color;a.push(d)}}return Promise.all([Promise.all(o),Promise.all(i),Promise.all(a)]).then(function(c){const h=c[0],u=c[1],d=c[2];return s&&(l.morphAttributes.position=h),n&&(l.morphAttributes.normal=u),r&&(l.morphAttributes.color=d),l.morphTargetsRelative=!0,l})}function mn(l,e){if(l.updateMorphTargets(),e.weights!==void 0)for(let t=0,s=e.weights.length;t<s;t++)l.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(l.morphTargetInfluences.length===t.length){l.morphTargetDictionary={};for(let s=0,n=t.length;s<n;s++)l.morphTargetDictionary[t[s]]=s}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function gn(l){let e;const t=l.extensions&&l.extensions[E.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+Ie(t.attributes):e=l.indices+":"+Ie(l.attributes)+":"+l.mode,l.targets!==void 0)for(let s=0,n=l.targets.length;s<n;s++)e+=":"+Ie(l.targets[s]);return e}function Ie(l){let e="";const t=Object.keys(l).sort();for(let s=0,n=t.length;s<n;s++)e+=t[s]+":"+l[t[s]]+";";return e}function Ge(l){switch(l){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function Tn(l){return l.search(/\.jpe?g($|\?)/i)>0||l.search(/^data\:image\/jpeg/)===0?"image/jpeg":l.search(/\.webp($|\?)/i)>0||l.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}const _n=new M;class An{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Vs,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,n=!1,r=-1;typeof navigator<"u"&&(s=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)===!0,n=navigator.userAgent.indexOf("Firefox")>-1,r=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),typeof createImageBitmap>"u"||s||n&&r<98?this.textureLoader=new cs(this.options.manager):this.textureLoader=new ls(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new St(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,n=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(o){return o._markDefs&&o._markDefs()}),Promise.all(this._invokeAll(function(o){return o.beforeRoot&&o.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(o){const i={scene:o[0][n.scene||0],scenes:o[0],animations:o[1],cameras:o[2],asset:n.asset,parser:s,userData:{}};return z(r,i,n),V(i,n),Promise.all(s._invokeAll(function(a){return a.afterRoot&&a.afterRoot(i)})).then(function(){e(i)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let n=0,r=t.length;n<r;n++){const o=t[n].joints;for(let i=0,a=o.length;i<a;i++)e[o[i]].isBone=!0}for(let n=0,r=e.length;n<r;n++){const o=e[n];o.mesh!==void 0&&(this._addNodeRef(this.meshCache,o.mesh),o.skin!==void 0&&(s[o.mesh].isSkinnedMesh=!0)),o.camera!==void 0&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const n=s.clone(),r=(o,i)=>{const a=this.associations.get(o);a!=null&&this.associations.set(i,a);for(const[c,h]of o.children.entries())r(h,i.children[c])};return r(s,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let n=0;n<t.length;n++){const r=e(t[n]);r&&s.push(r)}return s}getDependency(e,t){const s=e+":"+t;let n=this.cache.get(s);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne(function(r){return r.loadNode&&r.loadNode(t)});break;case"mesh":n=this._invokeOne(function(r){return r.loadMesh&&r.loadMesh(t)});break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne(function(r){return r.loadBufferView&&r.loadBufferView(t)});break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne(function(r){return r.loadMaterial&&r.loadMaterial(t)});break;case"texture":n=this._invokeOne(function(r){return r.loadTexture&&r.loadTexture(t)});break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne(function(r){return r.loadAnimation&&r.loadAnimation(t)});break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne(function(r){return r!=this&&r.getDependency&&r.getDependency(e,t)}),!n)throw new Error("Unknown type: "+e);break}this.cache.add(s,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,n=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(n.map(function(r,o){return s.getDependency(e,o)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[E.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(r,o){s.load(ne.resolveURL(t.uri,n.path),r,void 0,function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(s){const n=t.byteLength||0,r=t.byteOffset||0;return s.slice(r,r+n)})}loadAccessor(e){const t=this,s=this.json,n=this.json.accessors[e];if(n.bufferView===void 0&&n.sparse===void 0){const o=Le[n.type],i=J[n.componentType],a=n.normalized===!0,c=new i(n.count*o);return Promise.resolve(new G(c,o,a))}const r=[];return n.bufferView!==void 0?r.push(this.getDependency("bufferView",n.bufferView)):r.push(null),n.sparse!==void 0&&(r.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(r).then(function(o){const i=o[0],a=Le[n.type],c=J[n.componentType],h=c.BYTES_PER_ELEMENT,u=h*a,d=n.byteOffset||0,f=n.bufferView!==void 0?s.bufferViews[n.bufferView].byteStride:void 0,p=n.normalized===!0;let T,m;if(f&&f!==u){const g=Math.floor(d/f),_="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+g+":"+n.count;let S=t.cache.get(_);S||(T=new c(i,g*f,n.count*f/h),S=new us(T,f/h),t.cache.add(_,S)),m=new Os(S,a,d%f/h,p)}else i===null?T=new c(n.count*a):T=new c(i,d,n.count*a),m=new G(T,a,p);if(n.sparse!==void 0){const g=Le.SCALAR,_=J[n.sparse.indices.componentType],S=n.sparse.indices.byteOffset||0,b=n.sparse.values.byteOffset||0,w=new _(o[1],S,n.sparse.count*g),x=new c(o[2],b,n.sparse.count*a);i!==null&&(m=new G(m.array.slice(),m.itemSize,m.normalized));for(let A=0,L=w.length;A<L;A++){const R=w[A];if(m.setX(R,x[A*a]),a>=2&&m.setY(R,x[A*a+1]),a>=3&&m.setZ(R,x[A*a+2]),a>=4&&m.setW(R,x[A*a+3]),a>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return m})}loadTexture(e){const t=this.json,s=this.options,r=t.textures[e].source,o=t.images[r];let i=this.textureLoader;if(o.uri){const a=s.manager.getHandler(o.uri);a!==null&&(i=a)}return this.loadTextureImage(e,r,i)}loadTextureImage(e,t,s){const n=this,r=this.json,o=r.textures[e],i=r.images[t],a=(i.uri||i.bufferView)+":"+o.sampler;if(this.textureCache[a])return this.textureCache[a];const c=this.loadImageSource(t,s).then(function(h){h.flipY=!1,h.name=o.name||i.name||"",h.name===""&&typeof i.uri=="string"&&i.uri.startsWith("data:image/")===!1&&(h.name=i.uri);const d=(r.samplers||{})[o.sampler]||{};return h.magFilter=st[d.magFilter]||Rt,h.minFilter=st[d.minFilter]||Lt,h.wrapS=nt[d.wrapS]||He,h.wrapT=nt[d.wrapT]||He,n.associations.set(h,{textures:e}),h}).catch(function(){return null});return this.textureCache[a]=c,c}loadImageSource(e,t){const s=this,n=this.json,r=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(u=>u.clone());const o=n.images[e],i=self.URL||self.webkitURL;let a=o.uri||"",c=!1;if(o.bufferView!==void 0)a=s.getDependency("bufferView",o.bufferView).then(function(u){c=!0;const d=new Blob([u],{type:o.mimeType});return a=i.createObjectURL(d),a});else if(o.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const h=Promise.resolve(a).then(function(u){return new Promise(function(d,f){let p=d;t.isImageBitmapLoader===!0&&(p=function(T){const m=new Ye(T);m.needsUpdate=!0,d(m)}),t.load(ne.resolveURL(u,r.path),p,void 0,f)})}).then(function(u){return c===!0&&i.revokeObjectURL(a),u.userData.mimeType=o.mimeType||Tn(o.uri),u}).catch(function(u){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),u});return this.sourceCache[e]=h,h}assignTexture(e,t,s,n){const r=this;return this.getDependency("texture",s.index).then(function(o){if(!o)return null;if(s.texCoord!==void 0&&s.texCoord>0&&(o=o.clone(),o.channel=s.texCoord),r.extensions[E.KHR_TEXTURE_TRANSFORM]){const i=s.extensions!==void 0?s.extensions[E.KHR_TEXTURE_TRANSFORM]:void 0;if(i){const a=r.associations.get(o);o=r.extensions[E.KHR_TEXTURE_TRANSFORM].extendTexture(o,i),r.associations.set(o,a)}}return n!==void 0&&(o.colorSpace=n),e[t]=o,o})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const n=t.attributes.tangent===void 0,r=t.attributes.color!==void 0,o=t.attributes.normal===void 0;if(e.isPoints){const i="PointsMaterial:"+s.uuid;let a=this.cache.get(i);a||(a=new Mt,Re.prototype.copy.call(a,s),a.color.copy(s.color),a.map=s.map,a.sizeAttenuation=!1,this.cache.add(i,a)),s=a}else if(e.isLine){const i="LineBasicMaterial:"+s.uuid;let a=this.cache.get(i);a||(a=new hs,Re.prototype.copy.call(a,s),a.color.copy(s.color),a.map=s.map,this.cache.add(i,a)),s=a}if(n||r||o){let i="ClonedMaterial:"+s.uuid+":";n&&(i+="derivative-tangents:"),r&&(i+="vertex-colors:"),o&&(i+="flat-shading:");let a=this.cache.get(i);a||(a=s.clone(),r&&(a.vertexColors=!0),o&&(a.flatShading=!0),n&&(a.normalScale&&(a.normalScale.y*=-1),a.clearcoatNormalScale&&(a.clearcoatNormalScale.y*=-1)),this.cache.add(i,a),this.associations.set(a,this.associations.get(s))),s=a}e.material=s}getMaterialType(){return It}loadMaterial(e){const t=this,s=this.json,n=this.extensions,r=s.materials[e];let o;const i={},a=r.extensions||{},c=[];if(a[E.KHR_MATERIALS_UNLIT]){const u=n[E.KHR_MATERIALS_UNLIT];o=u.getMaterialType(),c.push(u.extendParams(i,r,t))}else{const u=r.pbrMetallicRoughness||{};if(i.color=new j(1,1,1),i.opacity=1,Array.isArray(u.baseColorFactor)){const d=u.baseColorFactor;i.color.setRGB(d[0],d[1],d[2],D),i.opacity=d[3]}u.baseColorTexture!==void 0&&c.push(t.assignTexture(i,"map",u.baseColorTexture,oe)),i.metalness=u.metallicFactor!==void 0?u.metallicFactor:1,i.roughness=u.roughnessFactor!==void 0?u.roughnessFactor:1,u.metallicRoughnessTexture!==void 0&&(c.push(t.assignTexture(i,"metalnessMap",u.metallicRoughnessTexture)),c.push(t.assignTexture(i,"roughnessMap",u.metallicRoughnessTexture))),o=this._invokeOne(function(d){return d.getMaterialType&&d.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(d){return d.extendMaterialParams&&d.extendMaterialParams(e,i)})))}r.doubleSided===!0&&(i.side=ds);const h=r.alphaMode||Me.OPAQUE;if(h===Me.BLEND?(i.transparent=!0,i.depthWrite=!1):(i.transparent=!1,h===Me.MASK&&(i.alphaTest=r.alphaCutoff!==void 0?r.alphaCutoff:.5)),r.normalTexture!==void 0&&o!==te&&(c.push(t.assignTexture(i,"normalMap",r.normalTexture)),i.normalScale=new xe(1,1),r.normalTexture.scale!==void 0)){const u=r.normalTexture.scale;i.normalScale.set(u,u)}if(r.occlusionTexture!==void 0&&o!==te&&(c.push(t.assignTexture(i,"aoMap",r.occlusionTexture)),r.occlusionTexture.strength!==void 0&&(i.aoMapIntensity=r.occlusionTexture.strength)),r.emissiveFactor!==void 0&&o!==te){const u=r.emissiveFactor;i.emissive=new j().setRGB(u[0],u[1],u[2],D)}return r.emissiveTexture!==void 0&&o!==te&&c.push(t.assignTexture(i,"emissiveMap",r.emissiveTexture,oe)),Promise.all(c).then(function(){const u=new o(i);return r.name&&(u.name=r.name),V(u,r),t.associations.set(u,{materials:e}),r.extensions&&z(n,u,r),u})}createUniqueName(e){const t=fs.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,n=this.primitiveCache;function r(i){return s[E.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(i,t).then(function(a){return rt(a,i,t)})}const o=[];for(let i=0,a=e.length;i<a;i++){const c=e[i],h=gn(c),u=n[h];if(u)o.push(u.promise);else{let d;c.extensions&&c.extensions[E.KHR_DRACO_MESH_COMPRESSION]?d=r(c):d=rt(new Ct,c,t),n[h]={primitive:c,promise:d},o.push(d)}}return Promise.all(o)}loadMesh(e){const t=this,s=this.json,n=this.extensions,r=s.meshes[e],o=r.primitives,i=[];for(let a=0,c=o.length;a<c;a++){const h=o[a].material===void 0?fn(this.cache):this.getDependency("material",o[a].material);i.push(h)}return i.push(t.loadGeometries(o)),Promise.all(i).then(function(a){const c=a.slice(0,a.length-1),h=a[a.length-1],u=[];for(let f=0,p=h.length;f<p;f++){const T=h[f],m=o[f];let g;const _=c[f];if(m.mode===N.TRIANGLES||m.mode===N.TRIANGLE_STRIP||m.mode===N.TRIANGLE_FAN||m.mode===void 0)g=r.isSkinnedMesh===!0?new ps(T,_):new ms(T,_),g.isSkinnedMesh===!0&&g.normalizeSkinWeights(),m.mode===N.TRIANGLE_STRIP?g.geometry=et(g.geometry,Ps):m.mode===N.TRIANGLE_FAN&&(g.geometry=et(g.geometry,Fs));else if(m.mode===N.LINES)g=new gs(T,_);else if(m.mode===N.LINE_STRIP)g=new Ts(T,_);else if(m.mode===N.LINE_LOOP)g=new _s(T,_);else if(m.mode===N.POINTS)g=new Nt(T,_);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+m.mode);Object.keys(g.geometry.morphAttributes).length>0&&mn(g,r),g.name=t.createUniqueName(r.name||"mesh_"+e),V(g,r),m.extensions&&z(n,g,m),t.assignFinalMaterial(g),u.push(g)}for(let f=0,p=u.length;f<p;f++)t.associations.set(u[f],{meshes:e,primitives:f});if(u.length===1)return r.extensions&&z(n,u[0],r),u[0];const d=new re;r.extensions&&z(n,d,r),t.associations.set(d,{meshes:e});for(let f=0,p=u.length;f<p;f++)d.add(u[f]);return d})}loadCamera(e){let t;const s=this.json.cameras[e],n=s[s.type];if(!n){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return s.type==="perspective"?t=new As(K.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):s.type==="orthographic"&&(t=new bs(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),V(t,s),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],s=[];for(let n=0,r=t.joints.length;n<r;n++)s.push(this._loadNodeShallow(t.joints[n]));return t.inverseBindMatrices!==void 0?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(n){const r=n.pop(),o=n,i=[],a=[];for(let c=0,h=o.length;c<h;c++){const u=o[c];if(u){i.push(u);const d=new M;r!==null&&d.fromArray(r.array,c*16),a.push(d)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[c])}return new xs(i,a)})}loadAnimation(e){const t=this.json,s=this,n=t.animations[e],r=n.name?n.name:"animation_"+e,o=[],i=[],a=[],c=[],h=[];for(let u=0,d=n.channels.length;u<d;u++){const f=n.channels[u],p=n.samplers[f.sampler],T=f.target,m=T.node,g=n.parameters!==void 0?n.parameters[p.input]:p.input,_=n.parameters!==void 0?n.parameters[p.output]:p.output;T.node!==void 0&&(o.push(this.getDependency("node",m)),i.push(this.getDependency("accessor",g)),a.push(this.getDependency("accessor",_)),c.push(p),h.push(T))}return Promise.all([Promise.all(o),Promise.all(i),Promise.all(a),Promise.all(c),Promise.all(h)]).then(function(u){const d=u[0],f=u[1],p=u[2],T=u[3],m=u[4],g=[];for(let _=0,S=d.length;_<S;_++){const b=d[_],w=f[_],x=p[_],A=T[_],L=m[_];if(b===void 0)continue;b.updateMatrix&&b.updateMatrix();const R=s._createAnimationTracks(b,w,x,A,L);if(R)for(let I=0;I<R.length;I++)g.push(R[I])}return new ys(r,void 0,g)})}createNodeMesh(e){const t=this.json,s=this,n=t.nodes[e];return n.mesh===void 0?null:s.getDependency("mesh",n.mesh).then(function(r){const o=s._getNodeRef(s.meshCache,n.mesh,r);return n.weights!==void 0&&o.traverse(function(i){if(i.isMesh)for(let a=0,c=n.weights.length;a<c;a++)i.morphTargetInfluences[a]=n.weights[a]}),o})}loadNode(e){const t=this.json,s=this,n=t.nodes[e],r=s._loadNodeShallow(e),o=[],i=n.children||[];for(let c=0,h=i.length;c<h;c++)o.push(s.getDependency("node",i[c]));const a=n.skin===void 0?Promise.resolve(null):s.getDependency("skin",n.skin);return Promise.all([r,Promise.all(o),a]).then(function(c){const h=c[0],u=c[1],d=c[2];d!==null&&h.traverse(function(f){f.isSkinnedMesh&&f.bind(d,_n)});for(let f=0,p=u.length;f<p;f++)h.add(u[f]);return h})}_loadNodeShallow(e){const t=this.json,s=this.extensions,n=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const r=t.nodes[e],o=r.name?n.createUniqueName(r.name):"",i=[],a=n._invokeOne(function(c){return c.createNodeMesh&&c.createNodeMesh(e)});return a&&i.push(a),r.camera!==void 0&&i.push(n.getDependency("camera",r.camera).then(function(c){return n._getNodeRef(n.cameraCache,r.camera,c)})),n._invokeAll(function(c){return c.createNodeAttachment&&c.createNodeAttachment(e)}).forEach(function(c){i.push(c)}),this.nodeCache[e]=Promise.all(i).then(function(c){let h;if(r.isBone===!0?h=new Ss:c.length>1?h=new re:c.length===1?h=c[0]:h=new Et,h!==c[0])for(let u=0,d=c.length;u<d;u++)h.add(c[u]);if(r.name&&(h.userData.name=r.name,h.name=o),V(h,r),r.extensions&&z(s,h,r),r.matrix!==void 0){const u=new M;u.fromArray(r.matrix),h.applyMatrix4(u)}else r.translation!==void 0&&h.position.fromArray(r.translation),r.rotation!==void 0&&h.quaternion.fromArray(r.rotation),r.scale!==void 0&&h.scale.fromArray(r.scale);return n.associations.has(h)||n.associations.set(h,{}),n.associations.get(h).nodes=e,h}),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],n=this,r=new re;s.name&&(r.name=n.createUniqueName(s.name)),V(r,s),s.extensions&&z(t,r,s);const o=s.nodes||[],i=[];for(let a=0,c=o.length;a<c;a++)i.push(n.getDependency("node",o[a]));return Promise.all(i).then(function(a){for(let h=0,u=a.length;h<u;h++)r.add(a[h]);const c=h=>{const u=new Map;for(const[d,f]of n.associations)(d instanceof Re||d instanceof Ye)&&u.set(d,f);return h.traverse(d=>{const f=n.associations.get(d);f!=null&&u.set(d,f)}),u};return n.associations=c(r),r})}_createAnimationTracks(e,t,s,n,r){const o=[],i=e.name?e.name:e.uuid,a=[];B[r.path]===B.weights?e.traverse(function(d){d.morphTargetInfluences&&a.push(d.name?d.name:d.uuid)}):a.push(i);let c;switch(B[r.path]){case B.weights:c=$e;break;case B.rotation:c=Ze;break;case B.position:case B.scale:c=Je;break;default:switch(s.itemSize){case 1:c=$e;break;case 2:case 3:default:c=Je;break}break}const h=n.interpolation!==void 0?dn[n.interpolation]:Ot,u=this._getArrayFromAccessor(s);for(let d=0,f=a.length;d<f;d++){const p=new c(a[d]+"."+B[r.path],t.array,u,h);n.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(p),o.push(p)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const s=Ge(t.constructor),n=new Float32Array(t.length);for(let r=0,o=t.length;r<o;r++)n[r]=t[r]*s;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(s){const n=this instanceof Ze?hn:kt;return new n(this.times,this.values,this.getValueSize()/3,s)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function bn(l,e,t){const s=e.attributes,n=new Pt;if(s.POSITION!==void 0){const i=t.json.accessors[s.POSITION],a=i.min,c=i.max;if(a!==void 0&&c!==void 0){if(n.set(new y(a[0],a[1],a[2]),new y(c[0],c[1],c[2])),i.normalized){const h=Ge(J[i.componentType]);n.min.multiplyScalar(h),n.max.multiplyScalar(h)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const r=e.targets;if(r!==void 0){const i=new y,a=new y;for(let c=0,h=r.length;c<h;c++){const u=r[c];if(u.POSITION!==void 0){const d=t.json.accessors[u.POSITION],f=d.min,p=d.max;if(f!==void 0&&p!==void 0){if(a.setX(Math.max(Math.abs(f[0]),Math.abs(p[0]))),a.setY(Math.max(Math.abs(f[1]),Math.abs(p[1]))),a.setZ(Math.max(Math.abs(f[2]),Math.abs(p[2]))),d.normalized){const T=Ge(J[d.componentType]);a.multiplyScalar(T)}i.max(a)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}n.expandByVector(i)}l.boundingBox=n;const o=new ze;n.getCenter(o.center),o.radius=n.min.distanceTo(n.max)/2,l.boundingSphere=o}function rt(l,e,t){const s=e.attributes,n=[];function r(o,i){return t.getDependency("accessor",o).then(function(a){l.setAttribute(i,a)})}for(const o in s){const i=Ve[o]||o.toLowerCase();i in l.attributes||n.push(r(s[o],i))}if(e.indices!==void 0&&!l.index){const o=t.getDependency("accessor",e.indices).then(function(i){l.setIndex(i)});n.push(o)}return Qe.workingColorSpace!==D&&"COLOR_0"in s&&console.warn('THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "'.concat(Qe.workingColorSpace,'" not supported.')),V(l,e),bn(l,e,t),Promise.all(n).then(function(){return e.targets!==void 0?pn(l,e.targets,t):l})}function ot(l){let e;try{e=new URL(l,"http://fakehost.com/")}catch(r){return null}const t=e.pathname.split("/").pop(),s=t.lastIndexOf(".");return s===-1||s===t.length-1?null:t.substring(s+1)}class xn{constructor(){this.maxSize=800,this.minSize=600,this.unloadPercent=.05,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadPriorityCallback=null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize}add(e,t){const s=this.itemSet;if(s.has(e)||this.isFull())return!1;const n=this.usedSet,r=this.itemList,o=this.callbacks;return r.push(e),n.add(e),s.set(e,Date.now()),o.set(e,t),!0}remove(e){const t=this.usedSet,s=this.itemSet,n=this.itemList,r=this.callbacks;if(s.has(e)){r.get(e)(e);const o=n.indexOf(e);return n.splice(o,1),t.delete(e),s.delete(e),r.delete(e),!0}return!1}markUsed(e){const t=this.itemSet,s=this.usedSet;t.has(e)&&!s.has(e)&&(t.set(e,Date.now()),s.add(e))}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const e=this.unloadPercent,t=this.minSize,s=this.itemList,n=this.itemSet,r=this.usedSet,o=this.callbacks,i=s.length-r.size,a=s.length-t,c=this.unloadPriorityCallback||this.defaultPriorityCallback;if(a>0&&i>0){s.sort((p,T)=>{const m=r.has(p),g=r.has(T);return m&&g?0:!m&&!g?c(T)-c(p):m?1:-1});const h=Math.min(a,i),u=Math.max(t*e,h*e);let d=Math.min(u,i);d=Math.ceil(d);const f=s.splice(0,d);for(let p=0,T=f.length;p<T;p++){const m=f[p];o.get(m)(m),n.delete(m),o.delete(m)}}}scheduleUnload(e=!0){this.scheduled||(this.scheduled=!0,queueMicrotask(()=>{this.scheduled=!1,this.unloadUnusedContent(),e&&this.markAllUnused()}))}}class it{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise((s,n)=>{const r=(...a)=>t(...a).then(s).catch(n),o=this.items,i=this.callbacks;o.push(e),i.set(e,r),this.autoUpdate&&this.scheduleJobRun()})}remove(e){const t=this.items,s=this.callbacks,n=t.indexOf(e);n!==-1&&(t.splice(n,1),s.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,s=this.maxJobs;let n=this.currJobs;for(;s>n&&e.length>0;){n++;const r=e.pop(),o=t.get(r);t.delete(r),o(r).then(()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}).catch(()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})}this.currJobs=n}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const le=0,ue=1,Ce=2,ie=3,ye=4,Se=6378137,yn=1/298.257223563,Sn=-(yn*Se-Se);function We(l){return l===ie||l===ye}function q(l,e){return l.__lastFrameVisited===e&&l.__used}function Bt(l,e){l.__lastFrameVisited!==e&&(l.__lastFrameVisited=e,l.__used=!1,l.__inFrustum=!1,l.__isLeaf=!1,l.__visible=!1,l.__active=!1,l.__error=1/0,l.__distanceFromCamera=1/0,l.__childrenWereVisible=!1,l.__allChildrenLoaded=!1)}function Ut(l,e,t,s){if(s.ensureChildrenArePreprocessed(l),Bt(l,e),l.__used=!0,t.markUsed(l),l.__contentEmpty){const n=l.children;for(let r=0,o=n.length;r<o;r++)Ut(n[r],e,t,s)}}function Ht(l,e,t){if(t.ensureChildrenArePreprocessed(l),l.__contentEmpty&&(!l.__externalTileSet||We(l.__loadingState))){const n=l.children;for(let r=0,o=n.length;r<o;r++){const i=n[r];i.__depthFromRenderedParent=e,Ht(i,e,t)}}else t.requestTileContents(l)}function Vt(l,e=null,t=null,s=null,n=0){if(e&&e(l,s,n)){t&&t(l,s,n);return}const r=l.children;for(let o=0,i=r.length;o<i;o++)Vt(r[o],e,t,l,n+1);t&&t(l,s,n)}function Gt(l,e){e.ensureChildrenArePreprocessed(l);const t=e.stats,s=e.frameCount,n=e.errorTarget,r=e.maxDepth,o=e.loadSiblings,i=e.lruCache,a=e.stopAtEmptyTiles;if(Bt(l,s),e.tileInView(l)===!1)return!1;if(l.__used=!0,i.markUsed(l),l.__inFrustum=!0,t.inFrustum++,(a||!l.__contentEmpty)&&!l.__externalTileSet&&(e.calculateError(l),l.__error<=n||e.maxDepth>0&&l.__depth+1>=r))return!0;let h=!1;const u=l.children;for(let d=0,f=u.length;d<f;d++){const p=u[d],T=Gt(p,e);h=h||T}if(h&&o)for(let d=0,f=u.length;d<f;d++){const p=u[d];Ut(p,s,i,e)}return!0}function jt(l,e){const t=e.stats,s=e.frameCount;if(!q(l,s))return;t.used++;const n=l.children;let r=!1;for(let o=0,i=n.length;o<i;o++){const a=n[o];r=r||q(a,s)}if(!r)l.__isLeaf=!0;else{let o=!1,i=!0;for(let a=0,c=n.length;a<c;a++){const h=n[a];if(jt(h,e),o=o||h.__wasSetVisible||h.__childrenWereVisible,q(h,s)){const u=h.__allChildrenLoaded||!h.__contentEmpty&&We(h.__loadingState)||!h.__externalTileSet&&h.__contentEmpty&&h.children.length===0||h.__externalTileSet&&h.__loadingState===ye;i=i&&u}}l.__childrenWereVisible=o,l.__allChildrenLoaded=i}}function zt(l,e){const t=e.stats,s=e.frameCount;if(!q(l,s))return;const n=l.parent,r=n?n.__depthFromRenderedParent:-1;l.__depthFromRenderedParent=r;const o=e.lruCache;if(l.__isLeaf){l.__depthFromRenderedParent++,l.__loadingState===ie?(l.__inFrustum&&(l.__visible=!0,t.visible++),l.__active=!0,t.active++):!o.isFull()&&(!l.__contentEmpty||l.__externalTileSet)&&e.requestTileContents(l);return}const i=(e.errorTarget+1)*e.errorThreshold,a=l.__error<=i,c=a||l.refine==="ADD",h=!l.__contentEmpty,u=h||l.__externalTileSet,d=We(l.__loadingState)&&u,f=l.__childrenWereVisible,p=l.children,T=l.__allChildrenLoaded;if(c&&h&&l.__depthFromRenderedParent++,c&&!d&&!o.isFull()&&u&&e.requestTileContents(l),(a&&!T&&!f&&d||l.refine==="ADD"&&d)&&(l.__inFrustum&&(l.__visible=!0,t.visible++),l.__active=!0,t.active++),l.refine!=="ADD"&&a&&!T&&d)for(let m=0,g=p.length;m<g;m++){const _=p[m];q(_,s)&&!o.isFull()&&(_.__depthFromRenderedParent=l.__depthFromRenderedParent+1,Ht(_,_.__depthFromRenderedParent,e))}else for(let m=0,g=p.length;m<g;m++){const _=p[m];q(_,s)&&zt(_,e)}}function Kt(l,e){const t=e.frameCount,s=q(l,t);if(s||l.__usedLastFrame){let n=!1,r=!1;s&&(n=l.__active,e.displayActiveTiles?r=l.__active||l.__visible:r=l.__visible),!l.__contentEmpty&&l.__loadingState===ie&&(l.__wasSetActive!==n&&e.setTileActive(l,n),l.__wasSetVisible!==r&&e.setTileVisible(l,r)),l.__wasSetActive=n,l.__wasSetVisible=r,l.__usedLastFrame=s;const o=l.children;for(let i=0,a=o.length;i<a;i++){const c=o[i];Kt(c,e)}}}const at=(l,e)=>l.__depth!==e.__depth?l.__depth>e.__depth?-1:1:l.__inFrustum!==e.__inFrustum?l.__inFrustum?1:-1:l.__used!==e.__used?l.__used?1:-1:l.__error!==e.__error?l.__error>e.__error?1:-1:l.__distanceFromCamera!==e.__distanceFromCamera?l.__distanceFromCamera>e.__distanceFromCamera?-1:1:0,wn=l=>1/(l.__depthFromRenderedParent+1);class En{get rootTileSet(){const e=this.tileSets[this.rootURL];return!e||e instanceof Promise?null:e}get root(){const e=this.rootTileSet;return e?e.root:null}constructor(e){this.tileSets={},this.rootURL=e,this.fetchOptions={},this.preprocessURL=null;const t=new xn;t.unloadPriorityCallback=wn;const s=new it;s.maxJobs=4,s.priorityCallback=at;const n=new it;n.maxJobs=1,n.priorityCallback=at,this.lruCache=t,this.downloadQueue=s,this.parseQueue=n,this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this.errorThreshold=1/0,this.loadSiblings=!0,this.displayActiveTiles=!1,this.maxDepth=1/0,this.stopAtEmptyTiles=!0}traverse(e,t){const n=this.tileSets[this.rootURL];!n||!n.root||Vt(n.root,(r,...o)=>(this.ensureChildrenArePreprocessed(r),e?e(r,...o):!1),t)}update(){const e=this.stats,t=this.lruCache,s=this.tileSets,n=s[this.rootURL];if(this.rootURL in s){if(!n||!n.root)return}else{this.loadRootTileSet(this.rootURL);return}const r=n.root;e.inFrustum=0,e.used=0,e.active=0,e.visible=0,this.frameCount++,Gt(r,this),jt(r,this),zt(r,this),Kt(r,this),t.scheduleUnload()}parseTile(e,t,s){return null}disposeTile(e){}preprocessNode(e,t,s=null){if(e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.uri&&(e.content.uri=new URL(e.content.uri,t+"/").toString()),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=s,e.children=e.children||[],e.content&&e.content.uri){const r=ot(e.content.uri),o=!!(r&&r.toLowerCase()==="json");e.__externalTileSet=o,e.__contentEmpty=o}else e.__externalTileSet=!1,e.__contentEmpty=!0;e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=le,e.__loadIndex=0,e.__loadAbort=null,e.__depthFromRenderedParent=-1,s===null?(e.__depth=0,e.refine=e.refine||"REPLACE"):(e.__depth=s.__depth+1,e.refine=e.refine||s.refine),e.__basePath=t}setTileActive(e,t){}setTileVisible(e,t){}calculateError(e){return 0}tileInView(e){return!0}ensureChildrenArePreprocessed(e){const t=e.children;for(let s=0,n=t.length;s<n;s++){const r=t[s];if("__depth"in r)break;this.preprocessNode(r,e.__basePath,e)}}resetFailedTiles(){const e=this.stats;e.failed!==0&&(this.traverse(t=>{t.__loadingState===ye&&(t.__loadingState=le)}),e.failed=0)}fetchTileSet(e,t,s=null){return fetch(e,t).then(n=>{if(n.ok)return n.json();throw new Error('TilesRenderer: Failed to load tileset "'.concat(e,'" with status ').concat(n.status," : ").concat(n.statusText))}).then(n=>{const r=n.asset.version,[o,i]=r.split(".").map(c=>parseInt(c));console.assert(o<=1,"TilesRenderer: asset.version is expected to be a 1.x or a compatible version."),o===1&&i>0&&console.warn("TilesRenderer: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let a=e.replace(/\/[^\/]*\/?$/,"");return a=new URL(a,window.location.href).toString(),this.preprocessNode(n.root,a,s),n})}loadRootTileSet(e){const t=this.tileSets;if(e in t)return t[e]instanceof Error?Promise.reject(t[e]):Promise.resolve(t[e]);{const s=this.fetchTileSet(this.preprocessURL?this.preprocessURL(e):e,this.fetchOptions).then(n=>{t[e]=n});return s.catch(n=>{console.error(n),t[e]=n}),t[e]=s,s}}requestTileContents(e){if(e.__loadingState!==le)return;const t=this.stats,s=this.lruCache,n=this.downloadQueue,r=this.parseQueue,o=e.__externalTileSet;s.add(e,u=>{u.__loadingState===ue?(u.__loadAbort.abort(),u.__loadAbort=null):o?u.children.length=0:this.disposeTile(u),u.__loadingState===ue?t.downloading--:u.__loadingState===Ce&&t.parsing--,u.__loadingState=le,u.__loadIndex++,r.remove(u),n.remove(u)}),e.__loadIndex++;const i=e.__loadIndex,a=new AbortController,c=a.signal;t.downloading++,e.__loadAbort=a,e.__loadingState=ue;const h=u=>{e.__loadIndex===i&&(u.name!=="AbortError"?(r.remove(e),n.remove(e),e.__loadingState===Ce?t.parsing--:e.__loadingState===ue&&t.downloading--,t.failed++,console.error('TilesRenderer : Failed to load tile at url "'.concat(e.content.uri,'".')),console.error(u),e.__loadingState=ye):s.remove(e))};o?n.add(e,u=>{if(u.__loadIndex!==i)return Promise.resolve();const d=this.preprocessURL?this.preprocessURL(u.content.uri):u.content.uri;return this.fetchTileSet(d,Object.assign({signal:c},this.fetchOptions),u)}).then(u=>{e.__loadIndex===i&&(t.downloading--,e.__loadAbort=null,e.__loadingState=ie,e.children.push(u.root))}).catch(h):n.add(e,u=>{if(u.__loadIndex!==i)return Promise.resolve();const d=this.preprocessURL?this.preprocessURL(u.content.uri):u.content.uri;return fetch(d,Object.assign({signal:c},this.fetchOptions))}).then(u=>{if(e.__loadIndex===i){if(u.ok)return u.arrayBuffer();throw new Error("Failed to load model with error code ".concat(u.status))}}).then(u=>{if(e.__loadIndex===i)return t.downloading--,t.parsing++,e.__loadAbort=null,e.__loadingState=Ce,r.add(e,d=>{if(d.__loadIndex!==i)return Promise.resolve();const f=d.content.uri,p=ot(f);return this.parseTile(u,d,p)})}).then(()=>{e.__loadIndex===i&&(t.parsing--,e.__loadingState=ie,e.__wasSetVisible&&this.setTileVisible(e,!0),e.__wasSetActive&&this.setTileActive(e,!0))}).catch(h)}dispose(){const e=this.lruCache,t=[];this.traverse(s=>(t.push(s),!1));for(let s=0,n=t.length;s<n;s++)e.remove(t[s]);this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}}const Rn=new TextDecoder;function qt(l){return Rn.decode(l)}class Ee{constructor(e,t,s,n){this.buffer=e,this.binOffset=t+s,this.binLength=n;let r=null;if(s!==0){const o=new Uint8Array(e,t,s);r=JSON.parse(qt(o))}else r={};this.header=r}getKeys(){return Object.keys(this.header)}getData(e,t,s=null,n=null){const r=this.header;if(!(e in r))return null;const o=r[e];if(o instanceof Object){if(Array.isArray(o))return o;{const{buffer:i,binOffset:a,binLength:c}=this,h=o.byteOffset||0,u=o.type||n,d=o.componentType||s;if("type"in o&&n&&o.type!==n)throw new Error("FeatureTable: Specified type does not match expected type.");let f;switch(u){case"SCALAR":f=1;break;case"VEC2":f=2;break;case"VEC3":f=3;break;case"VEC4":f=4;break;default:throw new Error('FeatureTable : Feature type not provided for "'.concat(e,'".'))}let p;const T=a+h,m=t*f;switch(d){case"BYTE":p=new Int8Array(i,T,m);break;case"UNSIGNED_BYTE":p=new Uint8Array(i,T,m);break;case"SHORT":p=new Int16Array(i,T,m);break;case"UNSIGNED_SHORT":p=new Uint16Array(i,T,m);break;case"INT":p=new Int32Array(i,T,m);break;case"UNSIGNED_INT":p=new Uint32Array(i,T,m);break;case"FLOAT":p=new Float32Array(i,T,m);break;case"DOUBLE":p=new Float64Array(i,T,m);break;default:throw new Error('FeatureTable : Feature component type not provided for "'.concat(e,'".'))}if(T+m*p.BYTES_PER_ELEMENT>a+c)throw new Error("FeatureTable: Feature data read outside binary body length.");return p}}else return o}getBuffer(e,t){const{buffer:s,binOffset:n}=this;return s.slice(n+e,n+e+t)}}class Xe extends Ee{constructor(e,t,s,n,r){super(e,s,n,r),this.batchSize=t}getData(e,t=null,s=null){return super.getData(e,this.batchSize,t,s)}}class ce{constructor(){this.fetchOptions={},this.workingPath=""}load(e){return fetch(e,this.fetchOptions).then(t=>{if(!t.ok)throw new Error('Failed to load file "'.concat(e,'" with status ').concat(t.status," : ").concat(t.statusText));return t.arrayBuffer()}).then(t=>(this.workingPath===""&&(this.workingPath=this.workingPathForURL(e)),this.parse(t)))}resolveExternalURL(e){return/^[^\\/]/.test(e)?this.workingPath+"/"+e:e}workingPathForURL(e){const t=e.split(/[\\/]/g);return t.pop(),t.join("/")+"/"}parse(e){throw new Error("LoaderBase: Parse not implemented.")}}function $(l){let e;if(l instanceof DataView?e=l:e=new DataView(l),String.fromCharCode(e.getUint8(0))==="{")return null;let t="";for(let s=0;s<4;s++)t+=String.fromCharCode(e.getUint8(s));return t}class Ln extends ce{parse(e){const t=new DataView(e),s=$(t);console.assert(s==="b3dm");const n=t.getUint32(4,!0);console.assert(n===1);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const o=t.getUint32(12,!0),i=t.getUint32(16,!0),a=t.getUint32(20,!0),c=t.getUint32(24,!0),h=28,u=e.slice(h,h+o+i),d=new Ee(u,0,o,i),f=h+o+i,p=e.slice(f,f+a+c),T=new Xe(p,d.getData("BATCH_LENGTH"),0,a,c),m=f+a+c,g=new Uint8Array(e,m,r-m);return{version:n,featureTable:d,batchTable:T,glbBytes:g}}}class Wt extends Ln{constructor(e=ae){super(),this.manager=e,this.adjustmentTransform=new M}parse(e){const t=super.parse(e),s=t.glbBytes.slice().buffer;return new Promise((n,r)=>{const o=this.manager,i=this.fetchOptions,a=o.getHandler("path.gltf")||new qe(o);i.credentials==="include"&&i.mode==="cors"&&a.setCrossOrigin("use-credentials"),"credentials"in i&&a.setWithCredentials(i.credentials==="include"),i.headers&&a.setRequestHeader(i.headers);let c=this.workingPath;!/[\\/]$/.test(c)&&c.length&&(c+="/");const h=this.adjustmentTransform;a.parse(s,c,u=>{const{batchTable:d,featureTable:f}=t,{scene:p}=u,T=f.getData("RTC_CENTER");T&&(p.position.x+=T[0],p.position.y+=T[1],p.position.z+=T[2]),u.scene.updateMatrix(),u.scene.matrix.multiply(h),u.scene.matrix.decompose(u.scene.position,u.scene.quaternion,u.scene.scale),u.batchTable=d,u.featureTable=f,p.batchTable=d,p.featureTable=f,n(u)},r)})}}class Mn extends ce{parse(e){const t=new DataView(e),s=$(t);console.assert(s==="pnts");const n=t.getUint32(4,!0);console.assert(n===1);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const o=t.getUint32(12,!0),i=t.getUint32(16,!0),a=t.getUint32(20,!0),c=t.getUint32(24,!0),h=28,u=e.slice(h,h+o+i),d=new Ee(u,0,o,i),f=h+o+i,p=e.slice(f,f+a+c),T=new Xe(p,d.getData("BATCH_LENGTH")||d.getData("POINTS_LENGTH"),0,a,c);return Promise.resolve({version:n,featureTable:d,batchTable:T})}}function In(l){const e=l>>11,t=l>>5&63,s=l&31,n=Math.round(e/31*255),r=Math.round(t/63*255),o=Math.round(s/31*255);return[n,r,o]}const ct={RGB:"color",POSITION:"position"};class Xt extends Mn{constructor(e=ae){super(),this.manager=e}parse(e){return super.parse(e).then(async t=>{const{featureTable:s,batchTable:n}=t,r=new Mt,o=s.header.extensions,i=new y;let a;if(o&&o["3DTILES_draco_point_compression"]){const{byteOffset:u,byteLength:d,properties:f}=o["3DTILES_draco_point_compression"],p=this.manager.getHandler("draco.drc");if(p==null)throw new Error("PNTSLoader: dracoLoader not available.");const T={};for(const _ in f)if(_ in ct&&_ in f){const S=ct[_];T[S]=f[_]}const m={attributeIDs:T,attributeTypes:{position:"Float32Array",color:"Uint8Array"},useUniqueIDs:!0},g=s.getBuffer(u,d);a=await p.decodeGeometry(g,m),a.attributes.color&&(r.vertexColors=!0)}else{const u=s.getData("POINTS_LENGTH"),d=s.getData("POSITION",u,"FLOAT","VEC3"),f=s.getData("RGB",u,"UNSIGNED_BYTE","VEC3"),p=s.getData("RGBA",u,"UNSIGNED_BYTE","VEC4"),T=s.getData("RGB565",u,"UNSIGNED_SHORT","SCALAR"),m=s.getData("CONSTANT_RGBA",u,"UNSIGNED_BYTE","VEC4"),g=s.getData("POSITION_QUANTIZED",u,"UNSIGNED_SHORT","VEC3"),_=s.getData("QUANTIZED_VOLUME_SCALE",u,"FLOAT","VEC3"),S=s.getData("QUANTIZED_VOLUME_OFFSET",u,"FLOAT","VEC3");if(a=new Ct,g){const b=new Float32Array(u*3);for(let w=0;w<u;w++)for(let x=0;x<3;x++){const A=3*w+x;b[A]=g[A]/65535*_[x]}i.x=S[0],i.y=S[1],i.z=S[2],a.setAttribute("position",new G(b,3,!1))}else a.setAttribute("position",new G(d,3,!1));if(p!==null)a.setAttribute("color",new G(p,4,!0)),r.vertexColors=!0,r.transparent=!0,r.depthWrite=!1;else if(f!==null)a.setAttribute("color",new G(f,3,!0)),r.vertexColors=!0;else if(T!==null){const b=new Uint8Array(u*3);for(let w=0;w<u;w++){const x=In(T[w]);for(let A=0;A<3;A++){const L=3*w+A;b[L]=x[A]}}a.setAttribute("color",new G(b,3,!0)),r.vertexColors=!0}else if(m!==null){const b=new j(m[0],m[1],m[2]);r.color=b;const w=m[3]/255;w<1&&(r.opacity=w,r.transparent=!0,r.depthWrite=!1)}}["BATCH_LENGTH","NORMAL","NORMAL_OCT16P"].forEach(u=>{u in s.header&&console.warn('PNTSLoader: Unsupported FeatureTable feature "'.concat(u,'" detected.'))});const c=new Nt(a,r);c.position.copy(i),t.scene=c,t.scene.featureTable=s,t.scene.batchTable=n;const h=s.getData("RTC_CENTER");return h&&(t.scene.position.x+=h[0],t.scene.position.y+=h[1],t.scene.position.z+=h[2]),t})}}class Cn extends ce{parse(e){const t=new DataView(e),s=$(t);console.assert(s==="i3dm");const n=t.getUint32(4,!0);console.assert(n===1);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const o=t.getUint32(12,!0),i=t.getUint32(16,!0),a=t.getUint32(20,!0),c=t.getUint32(24,!0),h=t.getUint32(28,!0),u=32,d=e.slice(u,u+o+i),f=new Ee(d,0,o,i),p=u+o+i,T=e.slice(p,p+a+c),m=new Xe(T,f.getData("INSTANCES_LENGTH"),0,a,c),g=p+a+c,_=new Uint8Array(e,g,r-g);let S=null,b=null;if(h)S=_,b=Promise.resolve();else{const w=this.resolveExternalURL(qt(_));b=fetch(w,this.fetchOptions).then(x=>{if(!x.ok)throw new Error('I3DMLoaderBase : Failed to load file "'.concat(w,'" with status ').concat(x.status," : ").concat(x.statusText));return x.arrayBuffer()}).then(x=>{S=new Uint8Array(x)})}return b.then(()=>({version:n,featureTable:f,batchTable:m,glbBytes:S}))}}const lt=new y,Ne=new y,Oe=new y,ut=new y,Pe=new je,he=new y,de=new M;class Qt extends Cn{constructor(e=ae){super(),this.manager=e,this.adjustmentTransform=new M}resolveExternalURL(e){return this.manager.resolveURL(super.resolveExternalURL(e))}parse(e){return super.parse(e).then(t=>{const{featureTable:s,batchTable:n}=t,r=t.glbBytes.slice().buffer;return new Promise((o,i)=>{const a=this.fetchOptions,c=this.manager,h=c.getHandler("path.gltf")||new qe(c);a.credentials==="include"&&a.mode==="cors"&&h.setCrossOrigin("use-credentials"),"credentials"in a&&h.setWithCredentials(a.credentials==="include"),a.headers&&h.setRequestHeader(a.headers);let u=this.workingPath;/[\\/]$/.test(u)||(u+="/");const d=this.adjustmentTransform;h.parse(r,u,f=>{const p=s.getData("INSTANCES_LENGTH"),T=s.getData("POSITION",p,"FLOAT","VEC3"),m=s.getData("NORMAL_UP",p,"FLOAT","VEC3"),g=s.getData("NORMAL_RIGHT",p,"FLOAT","VEC3"),_=s.getData("SCALE_NON_UNIFORM",p,"FLOAT","VEC3"),S=s.getData("SCALE",p,"FLOAT","SCALAR");["RTC_CENTER","QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","EAST_NORTH_UP","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach(A=>{A in s.header&&console.warn('I3DMLoader: Unsupported FeatureTable feature "'.concat(A,'" detected.'))});const b=new Map,w=[];f.scene.traverse(A=>{if(A.isMesh){const{geometry:L,material:R}=A,I=new wt(L,R,p);I.position.copy(A.position),I.rotation.copy(A.rotation),I.scale.copy(A.scale),w.push(I),b.set(A,I)}});const x=new y;for(let A=0;A<p;A++)x.x+=T[A*3+0]/p,x.y+=T[A*3+1]/p,x.z+=T[A*3+2]/p;b.forEach((A,L)=>{const R=L.parent;R&&(R.remove(L),R.add(A),A.updateMatrixWorld(),A.position.copy(x).applyMatrix4(A.matrixWorld))});for(let A=0;A<p;A++){ut.set(T[A*3+0]-x.x,T[A*3+1]-x.y,T[A*3+2]-x.z),m?(Ne.set(m[A*3+0],m[A*3+1],m[A*3+2]),Oe.set(g[A*3+0],g[A*3+1],g[A*3+2]),lt.crossVectors(Oe,Ne).normalize(),de.makeBasis(Oe,Ne,lt),Pe.setFromRotationMatrix(de)):Pe.set(0,0,0,1),S?he.setScalar(S[A]):_?he.set(_[A*3+0],_[A*3+1],_[A*3+2]):he.set(1,1,1),de.compose(ut,Pe,he).multiply(d);for(let L=0,R=w.length;L<R;L++)w[L].setMatrixAt(A,de)}f.batchTable=n,f.featureTable=s,f.scene.batchTable=n,f.scene.featureTable=s,o(f)},i)})})}}class Nn extends ce{parse(e){const t=new DataView(e),s=$(t);console.assert(s==="cmpt",'CMPTLoader: The magic bytes equal "cmpt".');const n=t.getUint32(4,!0);console.assert(n===1,'CMPTLoader: The version listed in the header is "1".');const r=t.getUint32(8,!0);console.assert(r===e.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const o=t.getUint32(12,!0),i=[];let a=16;for(let c=0;c<o;c++){const h=new DataView(e,a,12),u=$(h),d=h.getUint32(4,!0),f=h.getUint32(8,!0),p=new Uint8Array(e,a,f);i.push({type:u,buffer:p,version:d}),a+=f}return{version:n,tiles:i}}}class On extends Nn{constructor(e=ae){super(),this.manager=e,this.adjustmentTransform=new M}parse(e){const t=super.parse(e),s=this.manager,n=this.adjustmentTransform,r=[];for(const o in t.tiles){const{type:i,buffer:a}=t.tiles[o];switch(i){case"b3dm":{const c=a.slice(),h=new Wt(s);h.workingPath=this.workingPath,h.fetchOptions=this.fetchOptions,h.adjustmentTransform.copy(n);const u=h.parse(c.buffer);r.push(u);break}case"pnts":{const c=a.slice(),h=new Xt(s);h.workingPath=this.workingPath,h.fetchOptions=this.fetchOptions;const u=h.parse(c.buffer);r.push(u);break}case"i3dm":{const c=a.slice(),h=new Qt(s);h.workingPath=this.workingPath,h.fetchOptions=this.fetchOptions,h.adjustmentTransform.copy(n);const u=h.parse(c.buffer);r.push(u);break}}}return Promise.all(r).then(o=>{const i=new re;return o.forEach(a=>{i.add(a.scene)}),{tiles:o,scene:i}})}}class Pn{constructor(){this.name="CESIUM_RTC"}afterRoot(e){if(e.parser.json.extensions&&e.parser.json.extensions.CESIUM_RTC){const{center:t}=e.parser.json.extensions.CESIUM_RTC;t&&(e.scene.position.x+=t[0],e.scene.position.y+=t[1],e.scene.position.z+=t[2])}}}class Fn extends ce{constructor(e=ae){super(),this.manager=e}parse(e){return new Promise((t,s)=>{const n=this.manager,r=this.fetchOptions;let o=n.getHandler("path.gltf")||n.getHandler("path.glb");o||(o=new qe(n),o.register(()=>new Pn)),r.credentials==="include"&&r.mode==="cors"&&o.setCrossOrigin("use-credentials"),"credentials"in r&&o.setWithCredentials(r.credentials==="include"),r.headers&&(console.log(r),o.setRequestHeader(r.headers));let i=o.resourcePath||o.path||this.workingPath;!/[\\/]$/.test(i)&&i.length&&(i+="/"),o.parse(e,i,a=>{t(a)},s)})}}const fe=new M;class vn extends re{constructor(e){super(),this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e}raycast(e,t){return this.tilesRenderer.optimizeRaycast?(this.tilesRenderer.raycast(e,t),!1):!0}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){this.parent===null?fe.copy(this.matrix):fe.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const t=fe.elements,s=this.matrixWorld.elements;let n=!1;for(let r=0;r<16;r++){const o=t[r],i=s[r];if(Math.abs(o-i)>Number.EPSILON){n=!0;break}}if(n){this.matrixWorld.copy(fe);const r=this.children;for(let o=0,i=r.length;o<i;o++)r[o].updateMatrixWorld()}}}}const Dn=parseInt(Ft)<165,we=new M,Yt=new Ke,Fe=new y,be=[];function Jt(l,e){return l.distance-e.distance}function $t(l,e,t){Dn?(l.traverse(s=>{Object.getPrototypeOf(s).raycast.call(s,e,t)}),be.sort(Jt)):e.intersectObject(l,!0,t)}function kn(l,e){$t(l,e,be);const t=be[0]||null;return be.length=0,t}function Zt(l,e,t,s=null){const{group:n,activeTiles:r}=l;l.ensureChildrenArePreprocessed(e),s===null&&(s=Yt,we.copy(n.matrixWorld).invert(),s.copy(t.ray).applyMatrix4(we));const o=[],i=e.children;for(let h=0,u=i.length;h<u;h++){const d=i[h];if(!d.__used)continue;d.cached.boundingVolume.intersectRay(s,Fe)!==null&&(Fe.applyMatrix4(n.matrixWorld),o.push({distance:Fe.distanceToSquared(t.ray.origin),tile:d}))}o.sort(Jt);let a=null,c=1/0;if(r.has(e)){const h=kn(e.cached.scene,t);h&&(a=h,c=h.distance*h.distance)}for(let h=0,u=o.length;h<u;h++){const d=o[h],f=d.distance,p=d.tile;if(f>c)break;const T=Zt(l,p,t,s);if(T){const m=T.distance*T.distance;m<c&&(a=T,c=m)}}return a}function es(l,e,t,s,n=null){const{group:r,activeTiles:o}=l,{scene:i,boundingVolume:a}=e.cached;if(l.ensureChildrenArePreprocessed(e),n===null&&(n=Yt,we.copy(r.matrixWorld).invert(),n.copy(t.ray).applyMatrix4(we)),!e.__used||!a.intersectsRay(n))return;o.has(e)&&$t(i,t,s);const c=e.children;for(let h=0,u=c.length;h<u;h++)es(l,c[h],t,s,n)}const pe=new y,me=new y,O=new y;class ht{constructor(e=new Pt,t=new M){this.box=e.clone(),this.transform=t.clone(),this.inverseTransform=new M,this.points=new Array(8).fill().map(()=>new y),this.planes=new Array(6).fill().map(()=>new Ds)}update(){const{points:e,inverseTransform:t,transform:s,box:n}=this;t.copy(s).invert();const{min:r,max:o}=n;let i=0;for(let a=-1;a<=1;a+=2)for(let c=-1;c<=1;c+=2)for(let h=-1;h<=1;h+=2)e[i].set(a<0?r.x:o.x,c<0?r.y:o.y,h<0?r.z:o.z).applyMatrix4(s),i++;this.updatePlanes()}updatePlanes(){pe.copy(this.box.min).applyMatrix4(this.transform),me.copy(this.box.max).applyMatrix4(this.transform),O.set(0,0,1).transformDirection(this.transform),this.planes[0].setFromNormalAndCoplanarPoint(O,pe),this.planes[1].setFromNormalAndCoplanarPoint(O,me).negate(),O.set(0,1,0).transformDirection(this.transform),this.planes[2].setFromNormalAndCoplanarPoint(O,pe),this.planes[3].setFromNormalAndCoplanarPoint(O,me).negate(),O.set(1,0,0).transformDirection(this.transform),this.planes[4].setFromNormalAndCoplanarPoint(O,pe),this.planes[5].setFromNormalAndCoplanarPoint(O,me).negate()}intersectsFrustum(e){const{points:t}=this,{planes:s}=e;for(let n=0;n<6;n++){const r=s[n];let o=-1/0;for(let i=0;i<8;i++){const a=t[i],c=r.distanceToPoint(a);o=o<c?c:o}if(o<0)return!1}for(let n=0;n<6;n++){const r=this.planes[n];let o=-1/0;for(let i=0;i<8;i++){const a=e.points[i],c=r.distanceToPoint(a);o=o<c?c:o}if(o<0)return!1}return!0}}new vt;new y;function Bn(l){const{x:e,y:t,z:s}=l;l.x=s,l.y=e,l.z=t}function Un(l){return-l+Math.PI/2}const dt=new vt,U=new y,C=new y,ge=new y,Hn=new y,Te=new M,ve=new ze,ft=new y,De=new y,ke=new y,pt=new y,mt=new Ke,Vn=1e-12,Gn=.1;class jn{constructor(e=1,t=1,s=1){this.radius=new y(e,t,s)}intersectRay(e,t){return Te.makeScale(...this.radius).invert(),ve.center.set(0,0,0),ve.radius=1,mt.copy(e).applyMatrix4(Te),mt.intersectSphere(ve,t)?(Te.makeScale(...this.radius),t.applyMatrix4(Te),t):null}constructLatLonFrame(e,t,s){return this.getCartographicToPosition(e,t,0,pt),this.getCartographicToNormal(e,t,ke),this.getNorthernTangent(e,t,De),ft.crossVectors(De,ke),s.makeBasis(ft,De,ke).setPosition(pt)}getNorthernTangent(e,t,s,n=Hn){let r=1,o=e+1e-7;e>Math.PI/4&&(r=-1,o=e-1e-7);const i=this.getCartographicToNormal(e,t,C).normalize(),a=this.getCartographicToNormal(o,t,ge).normalize();return n.crossVectors(i,a).normalize().multiplyScalar(r),s.crossVectors(n,i).normalize()}getCartographicToPosition(e,t,s,n){this.getCartographicToNormal(e,t,U);const r=this.radius;C.copy(U),C.x*=r.x**2,C.y*=r.y**2,C.z*=r.z**2;const o=Math.sqrt(U.dot(C));return C.divideScalar(o),n.copy(C).addScaledVector(U,s)}getPositionToCartographic(e,t){this.getPositionToSurfacePoint(e,C),this.getPositionToNormal(e,U);const s=ge.subVectors(e,C);return t.lon=Math.atan2(U.y,U.x),t.lat=Math.asin(U.z),t.height=Math.sign(s.dot(e))*s.length(),t}getCartographicToNormal(e,t,s){return dt.set(1,Un(e),t),s.setFromSpherical(dt).normalize(),Bn(s),s}getPositionToNormal(e,t){const s=this.radius;return t.copy(e),t.x/=s.x**2,t.y/=s.y**2,t.z/=s.z**2,t.normalize(),t}getPositionToSurfacePoint(e,t){const s=this.radius,n=1/s.x**2,r=1/s.y**2,o=1/s.z**2,i=e.x*e.x*n,a=e.y*e.y*r,c=e.z*e.z*o,h=i+a+c,u=Math.sqrt(1/h),d=C.copy(e).multiplyScalar(u);if(h<Gn)return isFinite(u)?t.copy(d):null;const f=ge.set(d.x*n*2,d.y*r*2,d.z*o*2);let p=(1-u)*e.length()/(.5*f.length()),T=0,m,g,_,S,b,w,x,A,L,R,I;do{p-=T,_=1/(1+p*n),S=1/(1+p*r),b=1/(1+p*o),w=_*_,x=S*S,A=b*b,L=w*_,R=x*S,I=A*b,m=i*w+a*x+c*A-1,g=i*L*n+a*R*r+c*I*o;const ss=-2*g;T=m/ss}while(Math.abs(m)>Vn);return t.set(e.x*_,e.y*S,e.z*b)}calculateHorizonDistance(e,t){const s=this.calculateEffectiveRadius(e);return Math.sqrt(2*s*t+t**2)}calculateEffectiveRadius(e){const t=this.radius.x,n=1-this.radius.z**2/t**2,r=e*K.DEG2RAD,o=Math.sin(r)**2;return t/Math.sqrt(1-n*o)}getPositionElevation(e){this.getPositionToSurfacePoint(e,C);const t=ge.subVectors(e,C);return Math.sign(t.dot(e))*t.length()}}const H=Math.PI,_e=H/2,ee=new y,W=new y,X=new y,gt=new M;let se=0;const Be=[];function zn(l=!1){return l?(Be[se]||(Be[se]=new y),se++,Be[se-1]):new y}function Tt(){se=0}class Kn extends jn{constructor(e,t,s,n=-_e,r=_e,o=0,i=2*H,a=0,c=0){super(e,t,s),this.latStart=n,this.latEnd=r,this.lonStart=o,this.lonEnd=i,this.heightStart=a,this.heightEnd=c}_getPoints(e=!1){const{latStart:t,latEnd:s,lonStart:n,lonEnd:r,heightStart:o,heightEnd:i}=this,a=K.mapLinear(.5,0,1,t,s),c=K.mapLinear(.5,0,1,n,r),h=Math.floor(n/_e)*_e,u=[[-H/2,0],[H/2,0],[0,h],[0,h+H/2],[0,h+H],[0,h+3*H/2],[t,r],[s,r],[t,n],[s,n],[0,n],[0,r],[a,c],[t,c],[s,c],[a,n],[a,r]],d=[],f=u.length;for(let p=0;p<=1;p++){const T=K.mapLinear(p,0,1,o,i);for(let m=0,g=f;m<g;m++){const[_,S]=u[m];if(_>=t&&_<=s&&S>=n&&S<=r){const b=zn(e);d.push(b),this.getCartographicToPosition(_,S,T,b)}}}return d}getBoundingBox(e,t){Tt();const{latStart:s,latEnd:n,lonStart:r,lonEnd:o}=this;if(n-s<H/2){const c=K.mapLinear(.5,0,1,s,n),h=K.mapLinear(.5,0,1,r,o);this.getCartographicToNormal(c,h,X),W.set(0,0,1),ee.crossVectors(W,X),W.crossVectors(ee,X),t.makeBasis(ee,W,X)}else ee.set(1,0,0),W.set(0,1,0),X.set(0,0,1),t.makeBasis(ee,W,X);gt.copy(t).invert();const a=this._getPoints(!0);for(let c=0,h=a.length;c<h;c++)a[c].applyMatrix4(gt);e.makeEmpty(),e.setFromPoints(a)}getBoundingSphere(e,t){Tt();const s=this._getPoints(!0);e.makeEmpty(),e.setFromPoints(s,t)}}const P=new y,F=new y,v=new y,_t=new y,At=new y,bt=new y,Q=new Ke;class qn{constructor(){this.sphere=null,this.obb=null,this.region=null,this.regionObb=null}intersectsRay(e){const t=this.sphere,s=this.obb||this.regionObb;return!(t&&!e.intersectsSphere(t)||s&&(Q.copy(e).applyMatrix4(s.inverseTransform),!Q.intersectsBox(s.box)))}intersectRay(e,t=null){const s=this.sphere,n=this.obb||this.regionObb;let r=-1/0,o=-1/0;s&&e.intersectSphere(s,At)&&(r=s.containsPoint(e.origin)?0:e.origin.distanceToSquared(At)),n&&(Q.copy(e).applyMatrix4(n.inverseTransform),Q.intersectBox(n.box,bt)&&(o=n.box.containsPoint(Q.origin)?0:Q.origin.distanceToSquared(bt)));const i=Math.max(r,o);return i===-1/0?null:(e.at(Math.sqrt(i),t),t)}distanceToPoint(e){const t=this.sphere,s=this.obb||this.regionObb;let n=-1/0,r=-1/0;return t&&(n=Math.max(t.distanceToPoint(e),0)),s&&(_t.copy(e).applyMatrix4(s.inverseTransform),r=s.box.distanceToPoint(_t)),n>r?n:r}intersectsFrustum(e){const t=this.obb||this.regionObb,s=this.sphere;return s&&!e.intersectsSphere(s)||t&&!t.intersectsFrustum(e)?!1:!!(s||t)}getOBB(e,t){const s=this.obb||this.regionObb;s?(e.copy(s.box),t.copy(s.transform)):(this.getAABB(e),t.identity())}getAABB(e){if(this.sphere)this.sphere.getBoundingBox(e);else{const t=this.obb||this.regionObb;e.copy(t.box).applyMatrix4(t.transform)}}getSphere(e){if(this.sphere)e.copy(this.sphere);else if(this.region)this.region.getBoundingSphere(e);else{const t=this.obb||this.regionObb;t.box.getBoundingSphere(e),e.applyMatrix4(t.transform)}}setObbData(e,t){const s=new ht;P.set(e[3],e[4],e[5]),F.set(e[6],e[7],e[8]),v.set(e[9],e[10],e[11]);const n=P.length(),r=F.length(),o=v.length();P.normalize(),F.normalize(),v.normalize(),n===0&&P.crossVectors(F,v),r===0&&F.crossVectors(P,v),o===0&&v.crossVectors(P,F),s.transform.set(P.x,F.x,v.x,e[0],P.y,F.y,v.y,e[1],P.z,F.z,v.z,e[2],0,0,0,1).premultiply(t),s.box.min.set(-n,-r,-o),s.box.max.set(n,r,o),s.update(),this.obb=s}setSphereData(e,t,s,n,r){const o=new ze;o.center.set(e,t,s),o.radius=n,o.applyMatrix4(r),this.sphere=o}setRegionData(e,t,s,n,r,o){const i=new Kn(Se,Se,Sn,t,n,e,s,r,o),a=new ht;i.getBoundingBox(a.box,a.transform),a.update(),this.region=i,this.regionObb=a}}const Wn=new ks;function Xn(l,e,t,s){const n=Wn.set(l.normal.x,l.normal.y,l.normal.z,e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z);return s.set(-l.constant,-e.constant,-t.constant),s.applyMatrix3(n.invert()),s}class Qn extends Bs{constructor(){super(),this.points=Array(8).fill().map(()=>new y)}setFromProjectionMatrix(e,t){super.setFromProjectionMatrix(e,t),this.calculateFrustumPoints()}calculateFrustumPoints(){const{planes:e,points:t}=this;[[e[0],e[3],e[4]],[e[1],e[3],e[4]],[e[0],e[2],e[4]],[e[1],e[2],e[4]],[e[0],e[3],e[5]],[e[1],e[3],e[5]],[e[0],e[2],e[5]],[e[1],e[2],e[5]]].forEach((n,r)=>{Xn(n[0],n[1],n[2],t[r])})}}const xt=parseInt(Ft)<165,ts=Symbol("INITIAL_FRUSTUM_CULLED"),Ae=new M,Ue=new M,Y=new y,Yn=new y(1,0,0),Jn=new y(0,1,0);function yt(l,e){l.traverse(t=>{t.frustumCulled=t[ts]&&e})}class er extends En{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel(t=>{yt(t,!e)}))}constructor(...e){super(...e),this.group=new vn(this),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this.activeTiles=new Set,this.visibleTiles=new Set,this.optimizeRaycast=!0,this._autoDisableRendererCulling=!0,this._eventDispatcher=new Us,this.onLoadTileSet=null,this.onLoadModel=null,this.onDisposeModel=null,this.onTileVisibilityChange=null;const t=new Hs;if(t.setURLModifier(s=>this.preprocessURL?this.preprocessURL(s):s),this.manager=t,xt){const s=this;this._overridenRaycast=function(n,r){s.optimizeRaycast||Object.getPrototypeOf(this).raycast.call(this,n,r)}}}addEventListener(...e){this._eventDispatcher.addEventListener(...e)}hasEventListener(...e){this._eventDispatcher.hasEventListener(...e)}removeEventListener(...e){this._eventDispatcher.removeEventListener(...e)}dispatchEvent(...e){this._eventDispatcher.dispatchEvent(...e)}getBounds(...e){return console.warn("TilesRenderer: getBounds has been renamed to getBoundingBox."),this.getBoundingBox(...e)}getOrientedBounds(...e){return console.warn("TilesRenderer: getOrientedBounds has been renamed to getOrientedBoundingBox."),this.getOrientedBoundingBox(...e)}getBoundingBox(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t&&t.getAABB(e),!0}getOrientedBoundingBox(e,t){if(!this.root)return!1;const s=this.root.cached.boundingVolume;return s&&s.getOBB(e,t),!0}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t?(t.getSphere(e),!0):!1}forEachLoadedModel(e){this.traverse(t=>{const s=t.cached.scene;s&&e(s,t)})}raycast(e,t){if(this.root)if(e.firstHitOnly){const s=Zt(this,this.root,e);s&&t.push(s)}else es(this,this.root,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,s=this.cameraMap;return s.has(e)?!1:(s.set(e,new xe),t.push(e),!0)}setResolution(e,t,s){const n=this.cameraMap;return n.has(e)?(t instanceof xe?n.get(e).copy(t):n.get(e).set(t,s),!0):!1}setResolutionFromRenderer(e,t){const s=this.cameraMap;if(!s.has(e))return!1;const n=s.get(e);return t.getSize(n),n.multiplyScalar(t.getPixelRatio()),!0}deleteCamera(e){const t=this.cameras,s=this.cameraMap;if(s.has(e)){const n=t.indexOf(e);return t.splice(n,1),s.delete(e),!0}return!1}fetchTileSet(e,...t){const s=super.fetchTileSet(e,...t);return s.then(n=>{queueMicrotask(()=>{this.dispatchEvent({type:"load-tile-set",tileSet:n,url:e}),this.onLoadTileSet&&this.onLoadTileSet(n,e)})}).catch(()=>{}),s}update(){const e=this.group,t=this.cameras,s=this.cameraMap,n=this.cameraInfo;if(t.length===0){console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.");return}for(;n.length>t.length;)n.pop();for(;n.length<t.length;)n.push({frustum:new Qn,isOrthographic:!1,sseDenominator:-1,position:new y,invScale:-1,pixelSize:0});Ue.copy(e.matrixWorld).invert(),Y.setFromMatrixScale(Ue);const r=Y.x;Math.abs(Math.max(Y.x-Y.y,Y.x-Y.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let o=0,i=n.length;o<i;o++){const a=t[o],c=n[o],h=c.frustum,u=c.position,d=s.get(a);(d.width===0||d.height===0)&&console.warn("TilesRenderer: resolution for camera error calculation is not set.");const f=a.projectionMatrix.elements;if(c.isOrthographic=f[15]===1,c.isOrthographic){const p=2/f[0],T=2/f[5];c.pixelSize=Math.max(T/d.height,p/d.width)}else c.sseDenominator=2/f[5]/d.height;c.invScale=r,Ae.copy(e.matrixWorld),Ae.premultiply(a.matrixWorldInverse),Ae.premultiply(a.projectionMatrix),h.setFromProjectionMatrix(Ae),u.set(0,0,0),u.applyMatrix4(a.matrixWorld),u.applyMatrix4(Ue)}super.update()}preprocessNode(e,t,s=null){super.preprocessNode(e,t,s);const n=new M;if(e.transform){const i=e.transform;for(let a=0;a<16;a++)n.elements[a]=i[a]}s&&n.premultiply(s.cached.transform);const r=new M().copy(n).invert(),o=new qn;"sphere"in e.boundingVolume&&o.setSphereData(...e.boundingVolume.sphere,n),"box"in e.boundingVolume&&o.setObbData(e.boundingVolume.box,n),"region"in e.boundingVolume&&o.setRegionData(...e.boundingVolume.region),e.cached={loadIndex:0,transform:n,transformInverse:r,active:!1,inFrustum:[],boundingVolume:o,scene:null,geometry:null,materials:null,textures:null}}parseTile(e,t,s){t._loadIndex=t._loadIndex||0,t._loadIndex++;const r=t.content.uri.split(/[\\\/]/g);r.pop();const o=r.join("/"),i=this.fetchOptions,a=this.manager,c=t._loadIndex;let h=null;const u=this.rootTileSet.asset&&this.rootTileSet.asset.gltfUpAxis||"y",d=t.cached,f=d.transform,p=new M;switch(u.toLowerCase()){case"x":p.makeRotationAxis(Jn,-Math.PI/2);break;case"y":p.makeRotationAxis(Yn,Math.PI/2);break}const T=($(e)||s).toLowerCase();switch(T){case"b3dm":{const g=new Wt(a);g.workingPath=o,g.fetchOptions=i,g.adjustmentTransform.copy(p),h=g.parse(e);break}case"pnts":{const g=new Xt(a);g.workingPath=o,g.fetchOptions=i,h=g.parse(e);break}case"i3dm":{const g=new Qt(a);g.workingPath=o,g.fetchOptions=i,g.adjustmentTransform.copy(p),h=g.parse(e);break}case"cmpt":{const g=new On(a);g.workingPath=o,g.fetchOptions=i,g.adjustmentTransform.copy(p),h=g.parse(e).then(_=>_.scene);break}case"gltf":case"glb":const m=new Fn(a);m.workingPath=o,m.fetchOptions=i,h=m.parse(e);break;default:console.warn('TilesRenderer: Content type "'.concat(T,'" not supported.')),h=Promise.resolve(null);break}return h.then(m=>{let g,_;if(m.isObject3D?(g=m,_=null):(g=m.scene,_=m),t._loadIndex!==c)return;g.updateMatrix(),(T==="glb"||T==="gltf")&&g.matrix.multiply(p),g.matrix.premultiply(f),g.matrix.decompose(g.position,g.quaternion,g.scale),g.traverse(x=>{x[ts]=x.frustumCulled}),yt(g,!this.autoDisableRendererCulling),xt&&g.traverse(x=>{x.raycast=this._overridenRaycast});const S=[],b=[],w=[];g.traverse(x=>{if(x.geometry&&b.push(x.geometry),x.material){const A=x.material;S.push(x.material);for(const L in A){const R=A[L];R&&R.isTexture&&w.push(R)}}}),d.materials=S,d.geometry=b,d.textures=w,d.scene=g,d.metadata=_,this.dispatchEvent({type:"load-model",scene:g,tile:t}),this.onLoadModel&&this.onLoadModel(g,t)})}disposeTile(e){const t=e.cached;if(t.scene){const s=t.materials,n=t.geometry,r=t.textures,o=t.scene.parent;t.scene.traverse(i=>{i.userData.meshFeatures&&i.userData.meshFeatures.dispose(),i.userData.structuralMetadata&&i.userData.structuralMetadata.dispose()});for(let i=0,a=n.length;i<a;i++)n[i].dispose();for(let i=0,a=s.length;i<a;i++)s[i].dispose();for(let i=0,a=r.length;i<a;i++){const c=r[i];c.image instanceof ImageBitmap&&c.image.close(),c.dispose()}o&&o.remove(t.scene),this.dispatchEvent({type:"dispose-model",scene:t.scene,tile:e}),this.onDisposeModel&&this.onDisposeModel(t.scene,e),t.scene=null,t.materials=null,t.textures=null,t.geometry=null,t.metadata=null}this.activeTiles.delete(e),this.visibleTiles.delete(e),e._loadIndex++}setTileVisible(e,t){const s=e.cached.scene,n=this.visibleTiles,r=this.group;t?(r.add(s),n.add(e),s.updateMatrixWorld(!0)):(r.remove(s),n.delete(e)),this.dispatchEvent({type:"tile-visibility-change",scene:s,tile:e,visible:t}),this.onTileVisibilityChange&&this.onTileVisibilityChange(s,e,t)}setTileActive(e,t){const s=this.activeTiles;t?s.add(e):s.delete(e)}calculateError(e){const t=e.cached,s=t.inFrustum,n=this.cameras,r=this.cameraInfo,o=t.boundingVolume;let i=-1/0,a=1/0;for(let c=0,h=n.length;c<h;c++){if(!s[c])continue;const u=r[c],d=u.invScale;let f;if(u.isOrthographic){const p=u.pixelSize;f=e.geometricError/(p*d)}else{const T=o.distanceToPoint(u.position)*d,m=u.sseDenominator;f=e.geometricError/(T*m),a=Math.min(a,T)}i=Math.max(i,f)}e.__distanceFromCamera=a,e.__error=i}tileInView(e){const t=e.cached,s=t.boundingVolume,n=t.inFrustum,r=this.cameraInfo;let o=!1;for(let i=0,a=r.length;i<a;i++){const c=r[i].frustum;s.intersectsFrustum(c)?(o=!0,n[i]=!0):n[i]=!1}return o}}export{er as T};
