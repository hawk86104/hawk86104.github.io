import{importShared as e}from"./3d-tiles-renderer.6uaxtGOi1769565599278.js";import{useLoop as o,OrbitControls_default as t}from"./index.CG-C7MIu1769565599278.js";import{instance as a}from"./Resource.B-o37Rph1769565599278.js";import{B as r}from"./three-custom-shader-material.es.BljuZF8P1769565599278.js";import{buildingsCustomShaderMaterial_default as i,buildingsCustomShaderMaterial_default$1 as l}from"./buildingsCustomShaderMaterial.D6vHRvel1769565599278.js";import{LineSegmentsGeometry as n,LineMaterial as s,LineSegments2 as u}from"./LineSegments2.BeY6aCHq1769565599278.js";const{watch:d}=await e("vue"),c=async()=>{a.getResource("FBXLoader","https://opensource.cdn.icegl.cn/model/digitalCity/shanghai.FBX","shanghai.FBX");const e=a.getReactiveItem("shanghai.FBX");return new Promise((o,t)=>{const a=d(()=>e(),e=>{if(e){a();let t=null,r=null,i=null;e.traverse(e=>{"CITY_UNTRIANGULATED"===e.name&&(t=e),"LANDMASS"===e.name&&(r=e),"ROADS"===e.name&&(i=e)}),o({model:e,city:t,land:r,roads:i})}else t(new Error("FBX 加载失败，未得到模型"))})})},{defineComponent:m}=await e("vue"),{unref:p,openBlock:f,createElementBlock:w}=await e("vue"),h=["object"],{watchEffect:y,watch:g}=await e("vue"),v=await e("three"),C=m({__name:"buildingsModelCustomShader",props:{model:{},bulidingsColor:{default:"#e523ff"},landColor:{default:"#112233"},topColor:{default:"#ffff00"},opacity:{default:.9},gradient:{type:Boolean,default:!0}},setup(e){const t=e,a=t.model.city;a.renderOrder=1001;const n=t.model.land;(()=>{const{geometry:e}=a;e.computeBoundingBox(),e.computeBoundingSphere();const{max:o,min:n}=e.boundingBox;if(a.material.__csm)return;const s=new r({baseMaterial:a.material,vertexShader:l,fragmentShader:i,silent:!0,uniforms:{uMax:{value:o},uMin:{value:n},uBorderWidth:{value:5},uCircleTime:{value:5},uColor:{value:new v.Color(t.bulidingsColor)},uOpacity:{value:t.opacity},uLightColor:{value:new v.Color("#ffffff")},uTopColor:{value:new v.Color(t.topColor)},uTime:{value:0},uGradient:{value:t.gradient}},depthWrite:!0,depthTest:!0,transparent:!0,side:v.DoubleSide});a.material.dispose(),a.material=s})();const{onBeforeRender:s}=o();s(({delta:e})=>{a.material.uniforms.uTime.value+=e}),y(()=>{t.bulidingsColor&&a.material.uniforms.uColor.value.setStyle(t.bulidingsColor),t.landColor&&((e,o)=>{let a;a=Array.isArray(n.material)?n.material:[n.material],a.forEach(e=>{e[o].setStyle(t.landColor),e.side=v.DoubleSide})})(0,"color"),t.opacity&&(a.material.uniforms.uOpacity.value=t.opacity)}),g(t,(e,o)=>{a.material.uniforms.uGradient.value=e.gradient});const u=t.model.model.clone();return(e,o)=>(f(),w("primitive",{object:p(u)},null,8,h))}}),{defineComponent:B}=await e("vue"),{unref:b,openBlock:S,createElementBlock:x}=await e("vue"),M=["object"],{Color:T,EdgesGeometry:_,ShaderMaterial:R}=await e("three"),{watchEffect:E}=await e("vue"),k=B({__name:"buildingsLines",props:{builds:{},width:{default:1},color:{default:"#FFF"},opacity:{default:1},style:{default:"Wireframe"}},setup(e){const o=e;let t=null,a=null;if("Wireframe"===o.style){const e=new _(o.builds.geometry);let a=(new n).fromEdgesGeometry(e),r=new s({color:o.color,linewidth:o.width,opacity:o.opacity,transparent:!0,depthWrite:!0,depthTest:!0});r.resolution.set(window.innerWidth,window.innerHeight),t=new u(a,r),t.applyMatrix4(o.builds.matrix.clone())}else{a={transparent:!0,uniforms:{uColor:{value:new T(o.color)},uOpacity:{value:o.opacity}},vertexShader:"\n       void main() {\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:" \n        uniform vec3 uColor;\n\t\t\t\tuniform float uOpacity;\n        void main() {\n          gl_FragColor = vec4(uColor, uOpacity);\n        }\n      "};const e=new _(o.builds.geometry),r=new R(a);t=new LineSegments(e,r),t.applyMatrix4(o.builds.matrix.clone()),t.material.linewidth=o.width,t.renderOrder=1e3}return E(()=>{"Shader"===o.style&&(o.color&&(a.uniforms.uColor.value=new T(o.color)),o.opacity&&(a.uniforms.uOpacity.value=o.opacity)),"Wireframe"===o.style&&(o.color&&(t.material.color=new T(o.color)),o.opacity&&(t.material.opacity=o.opacity)),o.width&&(t.material.linewidth=o.width)}),(e,o)=>(S(),x("primitive",{object:b(t)},null,8,M))}}),{defineComponent:A}=await e("vue"),{createElementVNode:L,unref:j,normalizeProps:F,guardReactiveProps:G,createVNode:O,Fragment:D,openBlock:H,createElementBlock:P,createCommentVNode:W,renderSlot:N,resolveComponent:X,mergeProps:V,withCtx:I,createBlock:$}=await e("vue"),z={key:1,args:[1e3],position:[0,19,0]},U={key:2,args:[6e3,100],position:[0,19,0]},{SRGBColorSpace:Y,BasicShadowMap:q,ACESFilmicToneMapping:J}=await e("three"),{reactive:K,ref:Q,onMounted:Z}=await e("vue"),ee=A({__name:"pagesShow",props:{showBuildings:{type:Boolean,default:!0},autoRotate:{type:Boolean,default:!0},showAxesHelper:{type:Boolean,default:!0},showGridHelper:{type:Boolean,default:!0},disableRender:{type:Boolean,default:!1}},setup(e,{expose:o}){const a=e,r=K({clearColor:"#000000",shadows:!0,alpha:!1,useLegacyLights:!0,shadowMapType:q,outputColorSpace:Y,toneMapping:J,toneMappingExposure:1.2,renderMode:a.disableRender?"manual":"always"}),i={autoRotate:a.autoRotate,enableDamping:!0,makeDefault:!0};let l=Q(null);const n=Q(!1);Z(async()=>{a.showBuildings&&(l.value=await c())});const s=e=>{},u=()=>{n.value||(n.value=!0)},d=Q();return o({context:d,contextReady:n}),(e,o)=>{const n=X("TresCanvas");return H(),$(n,V({ref_key:"tcRef",ref:d},r,{"window-size":"",onReady:s,onLoop:u}),{default:I(()=>[o[0]||(o[0]=L("TresPerspectiveCamera",{position:[600,750,-1221],fov:45,near:1,far:1e5},null,-1)),O(j(t),F(G(i)),null,16),o[1]||(o[1]=L("TresAmbientLight",{color:"#ffffff"},null,-1)),o[2]||(o[2]=L("TresDirectionalLight",{position:[100,100,0],intensity:.5,color:"#ffffff"},null,-1)),a.showBuildings&&j(l)?(H(),P(D,{key:0},[O(C,{model:j(l)},null,8,["model"]),O(k,{builds:j(l).city,color:"#000"},null,8,["builds"])],64)):W("",!0),N(e.$slots,"ability"),a.showAxesHelper?(H(),P("TresAxesHelper",z)):W("",!0),a.showGridHelper?(H(),P("TresGridHelper",U)):W("",!0)]),_:3},16)}}});export{ee as _sfc_main,C as _sfc_main$1,k as _sfc_main$2,c as loadCityFBX};
