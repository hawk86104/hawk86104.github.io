import{importShared as r,mergeGeometries as U}from"./3d-tiles-renderer.DZNovkLO1767148983502.js";import{Pane as I}from"./tweakpane.BQRZXf8M1767148983502.js";import{loadCityFBX as V,_sfc_main as A,_sfc_main$2 as F}from"./pagesShow.vue_vue_type_script_setup_true_lang.Crq63Xp41767148983502.js";import{h337 as L}from"./heatmap.DPNtOJCL1767148983502.js";import{resetUV as N}from"./utils.DURg_k-q1767148983502.js";import{defineStore as j,_export_sfc as H}from"./index.DTe2qqjO1767148983502.js";import{computeBoundsTree as G,disposeBoundsTree as O,acceleratedRaycast as R}from"./ExtensionUtilities.2O-yyDsQ1767148983502.js";const{MathUtils:f}=await r("three"),w=36,h=-10,x=(n,e)=>n.getValueAt(e)+h,X=(n,e)=>{if(!e){let t=0;for(e=[];t<1e3;)e.push({x:f.randInt(1,n._config.width),y:f.randInt(1,n._config.height),value:f.randInt(h,w)}),t++}n.setData({max:w,min:h,data:e})},z=(n=250,e=250,t=!0)=>{const o=document.createElement("heatmap-canvas");return o.style.position="absolute",t||(o.style.display="none"),o.style.top="0",o.style.left="0",document.body.appendChild(o),L.create({container:o,width:n,height:e,blur:".8",radius:10,gradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"}})},{ref:b}=await r("vue"),E=j("buildingsHeatmap",()=>{const n=b(!1),e=b(0);function t(a){n.value=a}function o(a){e.value=a}return{showDiv:n,temperature:e,setShowDiv:t,setTemperature:o}}),{defineComponent:Y}=await r("vue"),{unref:W,createElementVNode:B,Fragment:q,openBlock:J,createElementBlock:K}=await r("vue"),Q=["object","rotation-x"],Z=["object"],{watchEffect:ee}=await r("vue"),s=await r("three"),te=Y({__name:"buildingsHeatmap",props:{model:{},opacity:{default:1}},setup(n){(()=>{s.BufferGeometry.prototype.computeBoundsTree=G,s.BufferGeometry.prototype.disposeBoundsTree=O,s.Mesh.prototype.raycast=R})();const t=n,o=z();X(o);const a=new s.Texture(o._renderer.canvas);a.needsUpdate=!0;const l=i=>new s.ShaderMaterial({vertexShader:`
		varying vec2 vUv;
		void main() {
			gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
			vUv = uv;
		}
		`,fragmentShader:`
		uniform sampler2D heightMap;
		uniform float uOpacity;
		varying vec2 vUv;
		void main() {
			gl_FragColor = vec4(texture2D(heightMap, vUv.xy).rgb, uOpacity);
    }
		`,uniforms:{uOpacity:{value:t.opacity},heightMap:{type:"t",value:i}},depthWrite:!0,depthTest:!0,transparent:!0,side:s.DoubleSide}),c=t.model.city.clone();delete c.geometry.attributes.normal,delete c.geometry.attributes.uv;const v=c.geometry.clone().applyMatrix4(c.matrix),u=t.model.land.clone();delete u.geometry.attributes.normal;const y=u.geometry.clone().applyMatrix4(u.matrix),m=U([v,y]);m.applyMatrix4(new s.Matrix4().makeRotationX(Math.PI/2)),N(m),m.computeBoundsTree();const g=l(a),$=new s.Mesh(m,g);ee(()=>{t.opacity&&(g.uniforms.uOpacity.value=t.opacity)});const d=E(),P=i=>{if(i){const _={x:i.uv.x*o._config.width,y:(1-i.uv.y)*o._config.height};console.log("数值：",i),console.log("数值———：",x(o,_)),d.setTemperature(x(o,_))}},T=i=>{i&&d.$patch({showDiv:!0})},k=i=>{i&&d.setShowDiv(!1)};return(i,_)=>(J(),K(q,null,[B("primitive",{object:W($),"rotation-x":-Math.PI/2,onPointermove:P,onPointerenter:T,onPointerleave:k},null,40,Q),B("primitive",{object:t.model.model.children[0].clone()},null,8,Z)],64))}}),{unref:M,toDisplayString:oe,vShow:ne,normalizeStyle:ae,withDirectives:ie,openBlock:re,createElementBlock:se}=await r("vue"),{ref:ce,onMounted:le,onUnmounted:ue}=await r("vue"),me={__name:"dataDiv",setup(n){const e=E(),t=ce({top:0,left:0});function o(a){t.value.left=a.clientX+5+"px",t.value.top=a.clientY-20+"px"}return le(()=>{window.addEventListener("mousemove",o)}),ue(()=>{window.removeEventListener("mousemove",o)}),(a,l)=>ie((re(),se("div",{class:"title",style:ae(t.value)},"温度："+oe(M(e).temperature)+"℃ ",5)),[[ne,M(e).showDiv]])}},pe=H(me,[["__scopeId","data-v-fac3e7fd"]]),{withAsyncContext:de,defineComponent:_e}=await r("vue"),{unref:D,mergeProps:S,createVNode:p,withCtx:fe,Fragment:he,openBlock:ve,createElementBlock:ye}=await r("vue"),{reactive:C,ref:ge}=await r("vue"),Ce=_e({__name:"heatmap2",async setup(n){let e,t;const o=ge(!1),a=([e,t]=de(()=>V()),e=await e,t(),e);o.value=!0;const l=C({width:1,color:"#000",opacity:1,show:!0}),c=C({opacity:.9});return new I({title:"参数",expanded:!0}).addBinding(c,"opacity",{label:"透明度",min:0,max:1,step:.1}),(u,y)=>(ve(),ye(he,null,[p(A,{showBuildings:!1,autoRotate:!1},{ability:fe(()=>[p(te,S({model:D(a)},c),null,16,["model"]),p(F,S(l,{builds:D(a).city}),null,16,["builds"])]),_:1}),p(pe)],64))}});export{Ce as default};
