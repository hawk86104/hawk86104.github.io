import{importShared as e}from"./3d-tiles-renderer.CPyPbRB51767152766904.js";import{useTres as t,useLoop as n,OrbitControls_default as r,component_default$4 as o}from"./index.BGo9PN8R1767152766904.js";import{_sfc_main$6 as s}from"./generalFont.vue_vue_type_script_setup_true_lang.BGlCyMZM1767152766904.js";import"./default.vue_vue_type_script_setup_true_lang.Dw-R0TE61767152766904.js";import"./three-mesh-ui.module.C5atkdvh1767152766904.js";import"./domPanel.vue_vue_type_style_index_0_lang.DYISUz3Y1767152766904.js";import{useLoader as a}from"./customShaderMaterial.vue_vue_type_script_setup_true_lang.Dh0yXqlp1767152766904.js";import"./index.vue_vue_type_script_setup_true_lang.C2TY6ijJ1767152766904.js";import{STLLoader as i}from"./Resource.CtYzjHNP1767152766904.js";import{Pane as l}from"./tweakpane.BbuIEN141767152766904.js";import{INTERSECTED as u,CONTAINED as c,NOT_INTERSECTED as p,computeBoundsTree as m,disposeBoundsTree as v,acceleratedRaycast as d}from"./ExtensionUtilities.CYR3yjDb1767152766904.js";const f=await e("three"),{withAsyncContext:g,defineComponent:y}=await e("vue"),{unref:w,createElementVNode:_,Fragment:h,openBlock:b,createElementBlock:x}=await e("vue"),j=["geometry","material"],B=["geometry"],M=await e("three"),{ref:T,watchEffect:A}=await e("vue"),C=y({__name:"model",props:{controls:{}},async setup(e){let r,o;const s=e;M.BufferGeometry.prototype.computeBoundsTree=m,M.BufferGeometry.prototype.disposeBoundsTree=v,M.Mesh.prototype.raycast=d;const y=([r,o]=g(()=>a(i,"https://opensource.cdn.icegl.cn/model/industry4/TR12J_OCC.stl")),r=await r,o(),r),C=new M.MeshStandardMaterial({color:16777215,roughness:.2,metalness:1,vertexColors:!0}),k=new Uint8Array(3*y.attributes.position.count);k.fill(255);const E=new M.BufferAttribute(k,3,!0);E.setUsage(M.DynamicDrawUsage),y.setAttribute("color",E);const S=T(null),F=T(null),R=T(!1),X=T(-1),z=T(.2),Y=new M.Vector2,{camera:O}=t(),U=T(new M.Raycaster),V=15/255,Z=78/255,G=85/255;let H=null;A(()=>{S.value&&(console.log("targetMesh.value init",S.value),S.value.geometry.computeBoundsTree(),H=y.boundsTree,((e,t,n,r,o,s)=>{window.addEventListener("pointermove",n=>{e.x=n.clientX/window.innerWidth*2-1,e.y=-n.clientY/window.innerHeight*2+1,t.value=!0}),window.addEventListener("pointerdown",a=>{e.x=a.clientX/window.innerWidth*2-1,e.y=-a.clientY/window.innerHeight*2+1,r.value=a.button;const i=new f.Raycaster;i.setFromCamera(e,n.value),i.firstHitOnly=!0;const l=i.intersectObject(o.value,!0);t.value=!0,s.enabled=0===l.length},!0),window.addEventListener("pointerup",e=>{r.value=-1,"touch"===e.pointerType&&(t.value=!1)},!0)})(Y,R,O,X,S,s.controls.instance))});const{onBeforeRender:L}=n();L(()=>{const e=y.index;if(F.value)if(s.controls.instance.active||!R.value)F.value.visible=!1;else{F.value.scale.setScalar(z.value),U.value.setFromCamera(Y,O.value),U.value.firstHitOnly=!0;const t=U.value.intersectObject(S.value,!0);if(t.length){F.value.position.copy(t[0].point),s.controls.instance.enabled=!1,F.value.visible=!0;const n=new M.Matrix4;n.copy(S.value.matrixWorld).invert();const r=new M.Sphere;r.center.copy(F.value.position).applyMatrix4(n),r.radius=100*z.value;const o=[],a=new M.Vector3;if(H?.shapecast({intersectsBounds:e=>{const t=r.intersectsBox(e),{min:n,max:o}=e;if(t){for(let e=0;e<=1;e++)for(let t=0;t<=1;t++)for(let s=0;s<=1;s++)if(a.set(0===e?n.x:o.x,0===t?n.y:o.y,0===s?n.z:o.z),!r.containsPoint(a))return u;return c}return t?u:p},intersectsTriangle:(e,t,n)=>{if(n||e.intersectsSphere(r)){const e=3*t;o.push(e,e+1,e+2)}return!1}}),0===X.value||2===X.value){let t=1,n=1,r=1;0===X.value&&(t=V,n=Z,r=G);for(let s=0,a=o.length;s<a;s++){const a=e.getX(o[s]);E.setX(a,t),E.setY(a,n),E.setZ(a,r)}E.needsUpdate=!0}}else F.value.visible=!1,s.controls.instance.enabled=!0}});const P=(new l).addButton({title:"点击按钮",label:"生成模型"}),N=new M.BufferGeometry;return N.setAttribute("position",new M.BufferAttribute(new Float32Array,0)),P.on("click",()=>{const e=[],t=[];for(let r=0;r<E.count;r++)E.getX(r)===V&&E.getY(r)===Z&&E.getZ(r)===G&&(e.push(y.attributes.position.getX(r),y.attributes.position.getY(r),y.attributes.position.getZ(r)),t.push(y.attributes.normal.getX(r),y.attributes.normal.getY(r),y.attributes.normal.getZ(r)));const n=new Float32Array(e);N.setAttribute("position",new M.BufferAttribute(n,3)),N.setAttribute("normal",new M.BufferAttribute(n,3))}),(e,t)=>(b(),x(h,null,[_("TresMesh",{ref_key:"targetMesh",ref:S,geometry:w(y),scale:.005,material:w(C)},null,8,j),_("TresMesh",{ref_key:"brushMesh",ref:F,visible:!1},[...t[0]||(t[0]=[_("TresSphereGeometry",{args:[1,40,40]},null,-1),_("TresMeshStandardMaterial",{color:15483002,roughness:.75,metalness:0,transparent:!0,opacity:.5,premultipliedAlpha:!0,emissive:15483002,emissiveIntensity:.5},null,-1)])],512),_("TresMesh",{geometry:w(N),position:[-2,-2,2],scale:.005},[...t[1]||(t[1]=[_("TresMeshStandardMaterial",{color:"#023249",roughness:.2,metalness:0,envMapIntensity:.2},null,-1)])],8,B)],64))}}),{defineComponent:k}=await e("vue"),{unref:E,createVNode:S,createElementVNode:F,mergeProps:R,Suspense:X,withCtx:z,openBlock:Y,createBlock:O,resolveComponent:U,Fragment:V,createElementBlock:Z}=await e("vue"),{reactive:G,ref:H}=await e("vue"),L=k({__name:"collectTriangles",setup(e){const t=G({clearColor:"#999999",antialias:!0}),n=G({autoRotate:!1}),a=H(null);return(e,i)=>{const l=U("TresCanvas");return Y(),Z(V,null,[S(E(s)),S(l,R(t,{"window-size":""}),{default:z(()=>[i[0]||(i[0]=F("TresPerspectiveCamera",{position:[5,1,15],fov:30,near:.1,far:1e3},null,-1)),S(E(r),R({ref_key:"controlsRef",ref:a},n),null,16),i[1]||(i[1]=F("TresAmbientLight",{intensity:1},null,-1)),(Y(),O(X,null,{default:z(()=>[S(C,{controls:a.value},null,8,["controls"])]),_:1})),(Y(),O(X,null,{default:z(()=>[S(E(o),{background:!1,files:["pos-x.jpg","neg-x.jpg","pos-y.jpg","neg-y.jpg","pos-z.jpg","neg-z.jpg"],path:"https://opensource.cdn.icegl.cn/images/skyBox/6jpg/"},null,8,["path"])]),_:1}))]),_:1},16)],64)}}});export{L as default};
