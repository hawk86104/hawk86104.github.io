var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,a=(t,s,n)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[s]=n;import{M as o,D as l,G as c,P as h,V as d,B as u,a as p,C as m,b as g,I as f,Q as _,c as b,R as y,d as w,e as T,f as x,S as C,g as S,E as v,h as P,i as E,F as R,j as U,_ as A,k as M,l as F,L}from"./three.aWgA1gea1733214749102.js";function k(e){let t;try{t=new URL(e,"http://fakehost.com/")}catch(r){return null}const s=t.pathname.split("/").pop(),n=s.lastIndexOf(".");if(-1===n||n===s.length-1)return null;return s.substring(n+1)}class O{get unloadPriorityCallback(){return this._unloadPriorityCallback}set unloadPriorityCallback(e){1===e.length?(console.warn('LRUCache: "unloadPriorityCallback" function has been changed to take two arguments.'),this._unloadPriorityCallback=(t,s)=>{const n=e(t),r=e(s);return n<r?-1:n>r?1:0}):this._unloadPriorityCallback=e}constructor(){this.minSize=6e3,this.maxSize=8e3,this.minBytesSize=322122547.2,this.maxBytesSize=429496729.6,this.unloadPercent=.05,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.markUnusedQueued=!1,this.unloadingHandle=-1,this.cachedBytes=0,this.bytesMap=new Map,this.loadedSet=new Set,this._unloadPriorityCallback=null,this.computeMemoryUsageCallback=()=>null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize||this.cachedBytes>=this.maxBytesSize}getMemoryUsage(e){var t;return null!=(t=this.bytesMap.get(e))?t:null}add(e,t){this.markUnusedQueued&&this.markAllUnused();const s=this.itemSet;if(s.has(e))return!1;if(this.isFull())return!1;const n=this.usedSet,r=this.itemList,i=this.callbacks,a=this.bytesMap;r.push(e),n.add(e),s.set(e,Date.now()),i.set(e,t);const o=this.computeMemoryUsageCallback(e);return this.cachedBytes+=o||0,a.set(e,o),!0}remove(e){const t=this.usedSet,s=this.itemSet,n=this.itemList,r=this.bytesMap,i=this.callbacks,a=this.loadedSet;if(s.has(e)){this.cachedBytes-=r.get(e)||0,r.delete(e),i.get(e)(e);const o=n.indexOf(e);return n.splice(o,1),t.delete(e),s.delete(e),i.delete(e),a.delete(e),!0}return!1}setLoaded(e,t){const{itemSet:s,loadedSet:n}=this;s.has(e)&&(!0===t?n.add(e):n.delete(e))}updateMemoryUsage(e){const t=this.itemSet,s=this.bytesMap;if(!t.has(e))return;this.cachedBytes-=s.get(e)||0;const n=this.computeMemoryUsageCallback(e);s.set(e,n),this.cachedBytes+=n}markUsed(e){this.markUnusedQueued&&this.markAllUnused();const t=this.itemSet,s=this.usedSet;t.has(e)&&!s.has(e)&&(t.set(e,Date.now()),s.add(e))}markAllUnused(){this.usedSet.clear(),this.markUnusedQueued=!1,-1!==this.unloadingHandle&&(cancelAnimationFrame(this.unloadingHandle),this.unloadingHandle=-1)}unloadUnusedContent(){const{unloadPercent:e,minSize:t,maxSize:s,itemList:n,itemSet:r,usedSet:i,loadedSet:a,callbacks:o,bytesMap:l,minBytesSize:c,maxBytesSize:h}=this,d=n.length-i.size,u=n.length-a.size,p=Math.max(Math.min(n.length-t,d),0),m=this.cachedBytes-c,g=this.unloadPriorityCallback||this.defaultPriorityCallback;let f=!1;const _=p>0&&d>0||u&&n.length>s;if(d&&this.cachedBytes>c||u&&this.cachedBytes>h||_){n.sort(((e,t)=>{const s=i.has(e);if(s===i.has(t)){const s=a.has(e);return s===a.has(t)?-g(e,t):s?1:-1}return s?1:-1}));const u=Math.max(t*e,p*e),_=Math.ceil(Math.min(u,d,p)),b=Math.max(e*m,e*c),y=Math.min(b,m);let w=0,T=0;for(;this.cachedBytes-T>h||n.length-w>s;){const e=n[w],t=l.get(e)||0;if(i.has(e)&&a.has(e)||this.cachedBytes-T-t<h&&n.length-w<=s)break;T+=t,w++}for(;T<y||w<_;){const e=n[w],t=l.get(e)||0;if(i.has(e)||this.cachedBytes-T-t<c&&w>=_)break;T+=t,w++}n.splice(0,w).forEach((e=>{this.cachedBytes-=l.get(e)||0,o.get(e)(e),l.delete(e),r.delete(e),o.delete(e),a.delete(e),i.delete(e)})),f=w<p||T<m&&w<d,f=f&&w>0}f&&(this.unloadingHandle=requestAnimationFrame((()=>this.scheduleUnload())))}scheduleUnload(){this.scheduled||(this.scheduled=!0,queueMicrotask((()=>{this.scheduled=!1,this.unloadUnusedContent(),this.markUnusedQueued=!0})))}}class D{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise(((s,n)=>{const r=this.items,i=this.callbacks;r.push(e),i.set(e,((...e)=>t(...e).then(s).catch(n))),this.autoUpdate&&this.scheduleJobRun()}))}remove(e){const t=this.items,s=this.callbacks,n=t.indexOf(e);-1!==n&&(t.splice(n,1),s.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,s=this.maxJobs;let n=this.currJobs;for(;s>n&&e.length>0;){n++;const s=e.pop(),r=t.get(s);t.delete(s),r(s).then((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})).catch((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}))}this.currJobs=n}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const I=-1,N=3,B=6378137,V=1738100;function z(e){return e===N||e===I}function j(e,t){return e.__lastFrameVisited===t&&e.__used}function H(e,t){e.__lastFrameVisited!==t.frameCount&&(e.__lastFrameVisited=t.frameCount,e.__used=!1,e.__inFrustum=!1,e.__isLeaf=!1,e.__visible=!1,e.__active=!1,e.__error=1/0,e.__distanceFromCamera=1/0,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__inFrustum=t.tileInView(e),t.calculateError(e))}function q(e,t){if(t.ensureChildrenArePreprocessed(e),H(e,t),G(e,t),!e.__hasRenderableContent){const s=e.children;for(let e=0,n=s.length;e<n;e++)q(s[e],t)}}function W(e,t){t.ensureChildrenArePreprocessed(e);if(j(e,t.frameCount)&&!e.__hasRenderableContent&&(!e.__hasContent||z(e.__loadingState))){const s=e.children;for(let e=0,n=s.length;e<n;e++){W(s[e],t)}}else j(e,t.frameCount)&&!t.lruCache.isFull()&&t.queueTileForDownload(e)}function G(e,t){e.__used||(e.__used=!0,t.lruCache.markUsed(e),t.stats.used++,!0===e.__inFrustum&&t.stats.inFrustum++)}function Q(e,t=null,s=null,n=null,r=0){if(t&&t(e,n,r))return void(s&&s(e,n,r));const i=e.children;for(let a=0,o=i.length;a<o;a++)Q(i[a],t,s,e,r+1);s&&s(e,n,r)}function J(e,t){if(t.ensureChildrenArePreprocessed(e),H(e,t),!e.__inFrustum)return;if(!function(e,t){return!(e.__error<=t.errorTarget||t.maxDepth>0&&e.__depth+1>=t.maxDepth)}(e,t))return void G(e,t);let s=!1,n=!1;const r=e.children;for(let i=0,a=r.length;i<a;i++){const e=r[i];J(e,t),s=s||j(e,t.frameCount),n=n||e.__inFrustum}if("REPLACE"!==e.refine||n||0===r.length||e.__hasUnrenderableContent){if(G(e,t),s&&"REPLACE"===e.refine)for(let i=0,a=r.length;i<a;i++){q(r[i],t)}}else e.__inFrustum=!1}function Y(e,t){const s=t.frameCount;if(!j(e,s))return;const n=e.children;let r=!1;for(let i=0,a=n.length;i<a;i++){const e=n[i];r=r||j(e,s)}if(r){let r=!1,i=!0;for(let e=0,a=n.length;e<a;e++){const a=n[e];if(Y(a,t),r=r||a.__wasSetVisible||a.__childrenWereVisible,j(a,s)){const e=a.__allChildrenLoaded||a.__hasRenderableContent&&z(a.__loadingState)||!a.__hasContent&&0===a.children.length||a.__hasUnrenderableContent&&a.__loadingState===I;i=i&&e}}e.__childrenWereVisible=r,e.__allChildrenLoaded=i}else e.__isLeaf=!0}function Z(e,t){const s=t.stats;if(!j(e,t.frameCount))return;const n=t.lruCache;if(e.__isLeaf)return void(e.__loadingState===N?(e.__inFrustum&&(e.__visible=!0,s.visible++),e.__active=!0,s.active++):!n.isFull()&&e.__hasContent&&t.queueTileForDownload(e));const r=e.children,i=e.__hasContent,a=z(e.__loadingState)&&i,o=(t.errorTarget+1)*t.errorThreshold,l=e.__error<=o,c=e.__childrenWereVisible,h=0===e.__depthFromRenderedParent,d=e.__allChildrenLoaded||h;if((l||"ADD"===e.refine)&&!a&&!n.isFull()&&i&&t.queueTileForDownload(e),(l&&!d&&!c&&a||"ADD"===e.refine&&a)&&(e.__inFrustum&&(e.__visible=!0,s.visible++),e.__active=!0,s.active++),"REPLACE"===e.refine&&l&&!d&&a)for(let u=0,p=r.length;u<p;u++){const e=r[u];j(e,t.frameCount)&&W(e,t)}else for(let u=0,p=r.length;u<p;u++)Z(r[u],t)}function X(e,t){const s=j(e,t.frameCount);if(s||e.__usedLastFrame){let n=!1,r=!1;s?(n=e.__active,r=t.displayActiveTiles&&e.__active||e.__visible):H(e,t),e.__hasRenderableContent&&e.__loadingState===N&&(e.__wasSetActive!==n&&t.setTileActive(e,n),e.__wasSetVisible!==r&&t.setTileVisible(e,r)),e.__wasSetActive=n,e.__wasSetVisible=r,e.__usedLastFrame=s;const i=e.children;for(let e=0,s=i.length;e<s;e++){X(i[e],t)}}}const $=Symbol("PLUGIN_REGISTERED"),K=(e,t)=>e.__depthFromRenderedParent!==t.__depthFromRenderedParent?e.__depthFromRenderedParent>t.__depthFromRenderedParent?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0,ee=(e,t)=>e.__depthFromRenderedParent!==t.__depthFromRenderedParent?e.__depthFromRenderedParent>t.__depthFromRenderedParent?1:-1:e.__loadingState!==t.__loadingState?e.__loadingState>t.__loadingState?-1:1:e.__lastFrameVisited!==t.__lastFrameVisited?e.__lastFrameVisited>t.__lastFrameVisited?-1:1:e.__hasUnrenderableContent!==t.__hasUnrenderableContent?e.__hasUnrenderableContent?-1:1:e.__error!==t.__error?e.__error>t.__error?-1:1:0;class te{get root(){const e=this.rootTileSet;return e?e.root:null}set loadSiblings(e){console.warn('TilesRenderer: "loadSiblings" option has been removed.')}set stopAtEmptyTiles(e){console.warn('TilesRenderer: "stopAtEmptyTiles" option has been removed.')}set preprocessURL(e){console.warn('TilesRendererBase: The "preprocessURL" callback has been deprecated. Use a plugin, instead.'),this._preprocessURL=e}get preprocessURL(){return this._preprocessURL}constructor(e=null){this.rootTileSetTriggered=!1,this.rootTileSet=null,this.rootURL=e,this.fetchOptions={},this.plugins=[],this.queuedTiles=[],this._preprocessURL=null;const t=new O;t.unloadPriorityCallback=ee;const s=new D;s.maxJobs=4,s.priorityCallback=K;const n=new D;n.maxJobs=1,n.priorityCallback=K,this.lruCache=t,this.downloadQueue=s,this.parseQueue=n,this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this.errorThreshold=1/0,this.displayActiveTiles=!1,this.maxDepth=1/0}registerPlugin(e){if(!0===e[$])throw new Error("TilesRendererBase: A plugin can only be registered to a single tile set");this.plugins.push(e),e[$]=!0,e.init&&e.init(this)}unregisterPlugin(e){const t=this.plugins;if("string"==typeof e&&(e=this.getPluginByName(name)),t.includes(e)){const s=t.indexOf(e);return t.splice(s,1),e.dispose&&e.dispose(),!0}return!1}getPluginByName(e){return this.plugins.find((t=>t.name===e))||null}traverse(e,t){this.root&&Q(this.root,((t,...s)=>(this.ensureChildrenArePreprocessed(t),!!e&&e(t,...s))),t)}queueTileForDownload(e){this.queuedTiles.push(e)}update(){const e=this.stats,t=this.lruCache;if(this.rootTileSetTriggered||(this.rootTileSetTriggered=!0,this.invokeOnePlugin((e=>e.loadRootTileSet&&e.loadRootTileSet()))),!this.root)return;const s=this.root;e.inFrustum=0,e.used=0,e.active=0,e.visible=0,this.frameCount++,J(s,this),Y(s,this),Z(s,this),X(s,this);const n=this.queuedTiles;n.sort(t.unloadPriorityCallback);for(let r=0,i=n.length;r<i&&!t.isFull();r++)this.requestTileContents(n[r]);n.length=0,t.scheduleUnload()}resetFailedTiles(){const e=this.stats;0!==e.failed&&(this.traverse((e=>{e.__loadingState===I&&(e.__loadingState=0)})),e.failed=0)}dispose(){this.invokeAllPlugins((e=>{e!==this&&e.dispose&&e.dispose()}));const e=this.lruCache,t=[];this.traverse((e=>(t.push(e),!1)));for(let s=0,n=t.length;s<n;s++)e.remove(t[s]);this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}fetchData(e,t){return fetch(e,t)}parseTile(e,t,s){return null}disposeTile(e){e.__visible&&(this.setTileVisible(e,!1),e.__visible=!1),e.__active&&(this.setTileActive(e,!1),e.__active=!1)}preprocessNode(e,t,s=null){var n;if(e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=s,e.children=e.children||[],null==(n=e.content)?void 0:n.uri){const t=k(e.content.uri);e.__hasContent=!0,e.__hasUnrenderableContent=Boolean(t&&/json$/.test(t)),e.__hasRenderableContent=!e.__hasUnrenderableContent}else e.__hasContent=!1,e.__hasUnrenderableContent=!1,e.__hasRenderableContent=!1;e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=0,e.__loadIndex=0,e.__loadAbort=null,null===s?(e.__depth=0,e.__depthFromRenderedParent=0,e.refine=e.refine||"REPLACE"):(e.__depth=s.__depth+1,e.__depthFromRenderedParent=s.__depthFromRenderedParent+(e.__hasRenderableContent?1:0),e.refine=e.refine||s.refine),e.__basePath=t,e.__lastFrameVisited=-1,this.invokeAllPlugins((n=>{n!==this&&n.preprocessNode&&n.preprocessNode(e,t,s)}))}setTileActive(e,t){}setTileVisible(e,t){}calculateError(e){return 0}tileInView(e){return!0}ensureChildrenArePreprocessed(e){const t=e.children;for(let s=0,n=t.length;s<n;s++){const n=t[s];if("__depth"in n)break;this.preprocessNode(n,e.__basePath,e)}}preprocessTileSet(e,t,s=null){const n=e.asset.version,[r,i]=n.split(".").map((e=>parseInt(e)));console.assert(r<=1,"TilesRenderer: asset.version is expected to be a 1.x or a compatible version."),1===r&&i>0&&console.warn("TilesRenderer: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let a=t.replace(/\/[^/]*\/?$/,"");a=new URL(a,window.location.href).toString(),this.preprocessNode(e.root,a,s)}loadRootTileSet(){let e=this.rootURL;this.invokeAllPlugins((t=>e=t.preprocessURL?t.preprocessURL(e,null):e));const t=this.invokeOnePlugin((t=>t.fetchData&&t.fetchData(e,this.fetchOptions))).then((t=>{if(t.ok)return t.json();throw new Error('TilesRenderer: Failed to load tileset "'.concat(e,'" with status ').concat(t.status," : ").concat(t.statusText))})).then((t=>{this.preprocessTileSet(t,e),this.rootTileSet=t}));return t.catch((e=>{console.error(e),this.rootTileSet=null})),t}requestTileContents(e){if(0!==e.__loadingState)return;let o=!1,l=new URL(e.content.uri,e.__basePath+"/").toString();this.invokeAllPlugins((t=>l=t.preprocessURL?t.preprocessURL(l,e):l));const c=this.stats,h=this.lruCache,d=this.downloadQueue,u=this.parseQueue,p=k(l);if(!h.add(e,(e=>{1===e.__loadingState?(e.__loadAbort.abort(),e.__loadAbort=null):o?e.children.length=0:this.invokeAllPlugins((t=>{t.disposeTile&&t.disposeTile(e)})),1===e.__loadingState?c.downloading--:2===e.__loadingState&&c.parsing--,e.__loadingState=0,e.__loadIndex++,u.remove(e),d.remove(e)})))return;e.__loadIndex++;const m=e.__loadIndex,g=new AbortController,f=g.signal;c.downloading++,e.__loadAbort=g,e.__loadingState=1;return d.add(e,(e=>e.__loadIndex!==m?Promise.resolve():this.invokeOnePlugin((e=>{return e.fetchData&&e.fetchData(l,(o=((e,t)=>{for(var s in t||(t={}))r.call(t,s)&&a(e,s,t[s]);if(n)for(var s of n(t))i.call(t,s)&&a(e,s,t[s]);return e})({},this.fetchOptions),t(o,s({signal:f}))));var o})))).then((t=>{if(e.__loadIndex===m){if(t.ok)return"json"===p?t.json():t.arrayBuffer();throw new Error("Failed to load model with error code ".concat(t.status))}})).then((t=>{if(e.__loadIndex===m)return c.downloading--,c.parsing++,e.__loadAbort=null,e.__loadingState=2,u.add(e,(s=>s.__loadIndex!==m?Promise.resolve():"json"===p&&t.root?(this.preprocessTileSet(t,l,e),e.children.push(t.root),o=!0,Promise.resolve()):this.invokeOnePlugin((e=>e.parseTile&&e.parseTile(t,s,p,l)))))})).then((()=>{e.__loadIndex===m&&(c.parsing--,e.__loadingState=N,h.setLoaded(e,!0),null===h.getMemoryUsage(e)&&(h.isFull()&&h.computeMemoryUsageCallback(e)>0?h.remove(e):h.updateMemoryUsage(e)))})).catch((t=>{e.__loadIndex===m&&("AbortError"!==t.name?(u.remove(e),d.remove(e),2===e.__loadingState?c.parsing--:1===e.__loadingState&&c.downloading--,c.failed++,console.error('TilesRenderer : Failed to load tile at url "'.concat(e.content.uri,'".')),console.error(t),e.__loadingState=I,h.setLoaded(e,!0)):h.remove(e))}))}getAttributions(e=[]){return this.invokeAllPlugins((t=>t!==this&&t.getAttributions&&t.getAttributions(e))),e}invokeOnePlugin(e){const t=[...this.plugins,this];for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}invokeAllPlugins(e){const t=[...this.plugins,this],s=[];for(let n=0;n<t.length;n++){const r=e(t[n]);r&&s.push(r)}return 0===s.length?null:Promise.all(s)}}const se=new TextDecoder;function ne(e){return se.decode(e)}function re(e,t,s,n,r,i){let a,o;switch(n){case"SCALAR":a=1;break;case"VEC2":a=2;break;case"VEC3":a=3;break;case"VEC4":a=4;break;default:throw new Error('FeatureTable : Feature type not provided for "'.concat(i,'".'))}const l=s*a;switch(r){case"BYTE":o=new Int8Array(e,t,l);break;case"UNSIGNED_BYTE":o=new Uint8Array(e,t,l);break;case"SHORT":o=new Int16Array(e,t,l);break;case"UNSIGNED_SHORT":o=new Uint16Array(e,t,l);break;case"INT":o=new Int32Array(e,t,l);break;case"UNSIGNED_INT":o=new Uint32Array(e,t,l);break;case"FLOAT":o=new Float32Array(e,t,l);break;case"DOUBLE":o=new Float64Array(e,t,l);break;default:throw new Error('FeatureTable : Feature component type not provided for "'.concat(i,'".'))}return o}class ie{constructor(e,t,s,n){this.buffer=e,this.binOffset=t+s,this.binLength=n;let r=null;if(0!==s){const n=new Uint8Array(e,t,s);r=JSON.parse(ne(n))}else r={};this.header=r}getKeys(){return Object.keys(this.header)}getData(e,t,s=null,n=null){const r=this.header;if(!(e in r))return null;const i=r[e];if(i instanceof Object){if(Array.isArray(i))return i;{const{buffer:r,binOffset:a,binLength:o}=this,l=i.byteOffset||0,c=i.type||n,h=i.componentType||s;if("type"in i&&n&&i.type!==n)throw new Error("FeatureTable: Specified type does not match expected type.");const d=a+l,u=re(r,d,t,c,h,e);if(d+u.byteLength>a+o)throw new Error("FeatureTable: Feature data read outside binary body length.");return u}}return i}getBuffer(e,t){const{buffer:s,binOffset:n}=this;return s.slice(n+e,n+e+t)}}class ae{constructor(e){var t;this.batchTable=e;const s=e.header.extensions["3DTILES_batch_table_hierarchy"];this.classes=s.classes;for(const r of this.classes){const e=r.instances;for(const t in e)r.instances[t]=this._parseProperty(e[t],r.length,t)}if(this.instancesLength=s.instancesLength,this.classIds=this._parseProperty(s.classIds,this.instancesLength,"classIds"),s.parentCounts?this.parentCounts=this._parseProperty(s.parentCounts,this.instancesLength,"parentCounts"):this.parentCounts=new Array(this.instancesLength).fill(1),s.parentIds){const e=this.parentCounts.reduce(((e,t)=>e+t),0);this.parentIds=this._parseProperty(s.parentIds,e,"parentIds")}else this.parentIds=null;this.instancesIds=[];const n={};for(const r of this.classIds)n[r]=null!=(t=n[r])?t:0,this.instancesIds.push(n[r]),n[r]++}_parseProperty(e,t,s){if(Array.isArray(e))return e;{const{buffer:n,binOffset:r}=this.batchTable;return re(n,r+e.byteOffset,t,"SCALAR",e.componentType||"UNSIGNED_SHORT",s)}}getDataFromId(e,t={}){const s=this.parentCounts[e];if(this.parentIds&&s>0){let n=0;for(let t=0;t<e;t++)n+=this.parentCounts[t];for(let r=0;r<s;r++){const s=this.parentIds[n+r];s!==e&&this.getDataFromId(s,t)}}const n=this.classIds[e],r=this.classes[n].instances,i=this.classes[n].name,a=this.instancesIds[e];for(const o in r)t[i]=t[i]||{},t[i][o]=r[o][a];return t}}class oe extends ie{get batchSize(){return console.warn("BatchTable.batchSize has been deprecated and replaced with BatchTable.count."),this.count}constructor(e,t,s,n,r){super(e,s,n,r),this.count=t,this.extensions={};const i=this.header.extensions;i&&i["3DTILES_batch_table_hierarchy"]&&(this.extensions["3DTILES_batch_table_hierarchy"]=new ae(this))}getData(e,t=null,s=null){return console.warn("BatchTable: BatchTable.getData is deprecated. Use BatchTable.getDataFromId to get allproperties for an id or BatchTable.getPropertyArray for getting an array of value for a property."),super.getData(e,this.count,t,s)}getDataFromId(e,t={}){if(e<0||e>=this.count)throw new Error('BatchTable: id value "'.concat(e,'" out of bounds for "').concat(this.count,'" features number.'));for(const s of this.getKeys())"extensions"!==s&&(t[s]=super.getData(s,this.count)[e]);for(const s in this.extensions){const n=this.extensions[s];n.getDataFromId instanceof Function&&(t[s]=t[s]||{},n.getDataFromId(e,t[s]))}return t}getPropertyArray(e){return super.getData(e,this.count)}}class le{constructor(){this.fetchOptions={},this.workingPath=""}load(e){return console.warn('Loader: "load" function has been deprecated in favor of "loadAsync".'),this.loadAsync(e)}loadAsync(e){return fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error('Failed to load file "'.concat(e,'" with status ').concat(t.status," : ").concat(t.statusText));return t.arrayBuffer()})).then((t=>(""===this.workingPath&&(this.workingPath=this.workingPathForURL(e)),this.parse(t))))}resolveExternalURL(e){return/^[^\\/]/.test(e)&&!/^http/.test(e)?this.workingPath+"/"+e:e}workingPathForURL(e){const t=e.split(/[\\/]/g);t.pop();return t.join("/")+"/"}parse(e){throw new Error("LoaderBase: Parse not implemented.")}}function ce(e){let t;if(t=e instanceof DataView?e:new DataView(e),"{"===String.fromCharCode(t.getUint8(0)))return null;let s="";for(let n=0;n<4;n++)s+=String.fromCharCode(t.getUint8(n));return s}class he extends le{parse(e){const t=new DataView(e),s=ce(t);console.assert("b3dm"===s);const n=t.getUint32(4,!0);console.assert(1===n);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),a=t.getUint32(16,!0),o=t.getUint32(20,!0),l=t.getUint32(24,!0),c=e.slice(28,28+i+a),h=new ie(c,0,i,a),d=28+i+a,u=e.slice(d,d+o+l),p=new oe(u,h.getData("BATCH_LENGTH"),0,o,l),m=d+o+l;return{version:n,featureTable:h,batchTable:p,glbBytes:new Uint8Array(e,m,r-m)}}}class de extends he{constructor(e=l){super(),this.manager=e,this.adjustmentTransform=new o}parse(e){const t=super.parse(e),s=t.glbBytes.slice().buffer;return new Promise(((e,n)=>{const r=this.manager,i=this.fetchOptions,a=r.getHandler("path.gltf")||new c(r);"include"===i.credentials&&"cors"===i.mode&&a.setCrossOrigin("use-credentials"),"credentials"in i&&a.setWithCredentials("include"===i.credentials),i.headers&&a.setRequestHeader(i.headers);let o=this.workingPath;!/[\\/]$/.test(o)&&o.length&&(o+="/");const l=this.adjustmentTransform;a.parse(s,o,(s=>{const{batchTable:n,featureTable:r}=t,{scene:i}=s,a=r.getData("RTC_CENTER");a&&(i.position.x+=a[0],i.position.y+=a[1],i.position.z+=a[2]),s.scene.updateMatrix(),s.scene.matrix.multiply(l),s.scene.matrix.decompose(s.scene.position,s.scene.quaternion,s.scene.scale),s.batchTable=n,s.featureTable=r,i.batchTable=n,i.featureTable=r,e(s)}),n)}))}}class ue extends le{parse(e){const t=new DataView(e),s=ce(t);console.assert("pnts"===s);const n=t.getUint32(4,!0);console.assert(1===n);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),a=t.getUint32(16,!0),o=t.getUint32(20,!0),l=t.getUint32(24,!0),c=e.slice(28,28+i+a),h=new ie(c,0,i,a),d=28+i+a,u=e.slice(d,d+o+l),p=new oe(u,h.getData("BATCH_LENGTH")||h.getData("POINTS_LENGTH"),0,o,l);return Promise.resolve({version:n,featureTable:h,batchTable:p})}}function pe(e){const t=e>>11,s=e>>5&63,n=31&e;return[Math.round(t/31*255),Math.round(s/63*255),Math.round(n/31*255)]}const me={RGB:"color",POSITION:"position"};class ge extends ue{constructor(e=l){super(),this.manager=e}parse(e){return super.parse(e).then((async e=>{const{featureTable:t,batchTable:s}=e,n=new h,r=t.header.extensions,i=new d;let a;if(r&&r["3DTILES_draco_point_compression"]){const{byteOffset:e,byteLength:s,properties:i}=r["3DTILES_draco_point_compression"],o=this.manager.getHandler("draco.drc");if(null==o)throw new Error("PNTSLoader: dracoLoader not available.");const l={};for(const t in i)if(t in me&&t in i){l[me[t]]=i[t]}const c={attributeIDs:l,attributeTypes:{position:"Float32Array",color:"Uint8Array"},useUniqueIDs:!0},h=t.getBuffer(e,s);a=await o.decodeGeometry(h,c),a.attributes.color&&(n.vertexColors=!0)}else{const e=t.getData("POINTS_LENGTH"),s=t.getData("POSITION",e,"FLOAT","VEC3"),r=t.getData("RGB",e,"UNSIGNED_BYTE","VEC3"),o=t.getData("RGBA",e,"UNSIGNED_BYTE","VEC4"),l=t.getData("RGB565",e,"UNSIGNED_SHORT","SCALAR"),c=t.getData("CONSTANT_RGBA",e,"UNSIGNED_BYTE","VEC4"),h=t.getData("POSITION_QUANTIZED",e,"UNSIGNED_SHORT","VEC3"),d=t.getData("QUANTIZED_VOLUME_SCALE",e,"FLOAT","VEC3"),g=t.getData("QUANTIZED_VOLUME_OFFSET",e,"FLOAT","VEC3");if(a=new u,h){const t=new Float32Array(3*e);for(let s=0;s<e;s++)for(let e=0;e<3;e++){const n=3*s+e;t[n]=h[n]/65535*d[e]}i.x=g[0],i.y=g[1],i.z=g[2],a.setAttribute("position",new p(t,3,!1))}else a.setAttribute("position",new p(s,3,!1));if(null!==o)a.setAttribute("color",new p(o,4,!0)),n.vertexColors=!0,n.transparent=!0,n.depthWrite=!1;else if(null!==r)a.setAttribute("color",new p(r,3,!0)),n.vertexColors=!0;else if(null!==l){const t=new Uint8Array(3*e);for(let s=0;s<e;s++){const e=pe(l[s]);for(let n=0;n<3;n++){t[3*s+n]=e[n]}}a.setAttribute("color",new p(t,3,!0)),n.vertexColors=!0}else if(null!==c){const e=new m(c[0],c[1],c[2]);n.color=e;const t=c[3]/255;t<1&&(n.opacity=t,n.transparent=!0,n.depthWrite=!1)}}["BATCH_LENGTH","NORMAL","NORMAL_OCT16P"].forEach((e=>{e in t.header&&console.warn('PNTSLoader: Unsupported FeatureTable feature "'.concat(e,'" detected.'))}));const o=new g(a,n);o.position.copy(i),e.scene=o,e.scene.featureTable=t,e.scene.batchTable=s;const l=t.getData("RTC_CENTER");return l&&(e.scene.position.x+=l[0],e.scene.position.y+=l[1],e.scene.position.z+=l[2]),e}))}}class fe extends le{parse(e){const t=new DataView(e),s=ce(t);console.assert("i3dm"===s);const n=t.getUint32(4,!0);console.assert(1===n);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),a=t.getUint32(16,!0),o=t.getUint32(20,!0),l=t.getUint32(24,!0),c=t.getUint32(28,!0),h=e.slice(32,32+i+a),d=new ie(h,0,i,a),u=32+i+a,p=e.slice(u,u+o+l),m=new oe(p,d.getData("INSTANCES_LENGTH"),0,o,l),g=u+o+l,f=new Uint8Array(e,g,r-g);let _=null,b=null,y=null;if(c)_=f,b=Promise.resolve();else{const e=this.resolveExternalURL(ne(f)),t=e.split(/[\\/]/g);t.pop(),y=t.join("/"),b=fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error('I3DMLoaderBase : Failed to load file "'.concat(e,'" with status ').concat(t.status," : ").concat(t.statusText));return t.arrayBuffer()})).then((e=>{_=new Uint8Array(e)}))}return b.then((()=>({version:n,featureTable:d,batchTable:m,glbBytes:_,gltfWorkingPath:y})))}}const _e=new d,be=new d,ye=new d,we=new d,Te=new _,xe=new d,Ce=new o,Se=new o;class ve extends fe{constructor(e=l){super(),this.manager=e,this.adjustmentTransform=new o}resolveExternalURL(e){return this.manager.resolveURL(super.resolveExternalURL(e))}parse(e){return super.parse(e).then((e=>{const{featureTable:t,batchTable:s}=e,n=e.glbBytes.slice().buffer;return new Promise(((r,i)=>{var a;const o=this.fetchOptions,l=this.manager,h=l.getHandler("path.gltf")||new c(l);"include"===o.credentials&&"cors"===o.mode&&h.setCrossOrigin("use-credentials"),"credentials"in o&&h.setWithCredentials("include"===o.credentials),o.headers&&h.setRequestHeader(o.headers);let u=null!=(a=e.gltfWorkingPath)?a:this.workingPath;/[\\/]$/.test(u)||(u+="/");const p=this.adjustmentTransform;h.parse(n,u,(e=>{const n=t.getData("INSTANCES_LENGTH"),i=t.getData("POSITION",n,"FLOAT","VEC3"),a=t.getData("NORMAL_UP",n,"FLOAT","VEC3"),o=t.getData("NORMAL_RIGHT",n,"FLOAT","VEC3"),l=t.getData("SCALE_NON_UNIFORM",n,"FLOAT","VEC3"),c=t.getData("SCALE",n,"FLOAT","SCALAR"),h=t.getData("RTC_CENTER");["QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","EAST_NORTH_UP","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach((e=>{e in t.header&&console.warn('I3DMLoader: Unsupported FeatureTable feature "'.concat(e,'" detected.'))}));const u=new d;for(let t=0;t<n;t++)u.x+=i[3*t+0]/n,u.y+=i[3*t+1]/n,u.z+=i[3*t+2]/n;const m=[],g=[];e.scene.updateMatrixWorld(),e.scene.traverse((e=>{if(e.isMesh){g.push(e);const{geometry:t,material:s}=e,r=new f(t,s,n);r.position.copy(u),h&&(r.position.x+=h[0],r.position.y+=h[1],r.position.z+=h[2]),m.push(r)}}));for(let t=0;t<n;t++){we.set(i[3*t+0]-u.x,i[3*t+1]-u.y,i[3*t+2]-u.z),a?(be.set(a[3*t+0],a[3*t+1],a[3*t+2]),ye.set(o[3*t+0],o[3*t+1],o[3*t+2]),_e.crossVectors(ye,be).normalize(),Ce.makeBasis(ye,be,_e),Te.setFromRotationMatrix(Ce)):Te.set(0,0,0,1),xe.set(1,1,1),l&&xe.set(l[3*t+0],l[3*t+1],l[3*t+2]),c&&xe.multiplyScalar(c[t]),Ce.compose(we,Te,xe).multiply(p);for(let e=0,s=m.length;e<s;e++){const s=m[e],n=g[e];Se.multiplyMatrices(Ce,n.matrixWorld),s.setMatrixAt(t,Se)}}e.scene.clear(),e.scene.add(...m),e.batchTable=s,e.featureTable=t,e.scene.batchTable=s,e.scene.featureTable=t,r(e)}),i)}))}))}}class Pe extends le{parse(e){const t=new DataView(e),s=ce(t);console.assert("cmpt"===s,'CMPTLoader: The magic bytes equal "cmpt".');const n=t.getUint32(4,!0);console.assert(1===n,'CMPTLoader: The version listed in the header is "1".');const r=t.getUint32(8,!0);console.assert(r===e.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const i=t.getUint32(12,!0),a=[];let o=16;for(let l=0;l<i;l++){const t=new DataView(e,o,12),s=ce(t),n=t.getUint32(4,!0),r=t.getUint32(8,!0),i=new Uint8Array(e,o,r);a.push({type:s,buffer:i,version:n}),o+=r}return{version:n,tiles:a}}}class Ee extends Pe{constructor(e=l){super(),this.manager=e,this.adjustmentTransform=new o}parse(e){const t=super.parse(e),s=this.manager,n=this.adjustmentTransform,r=[];for(const i in t.tiles){const{type:e,buffer:a}=t.tiles[i];switch(e){case"b3dm":{const e=a.slice(),t=new de(s);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions,t.adjustmentTransform.copy(n);const i=t.parse(e.buffer);r.push(i);break}case"pnts":{const e=a.slice(),t=new ge(s);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const n=t.parse(e.buffer);r.push(n);break}case"i3dm":{const e=a.slice(),t=new ve(s);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions,t.adjustmentTransform.copy(n);const i=t.parse(e.buffer);r.push(i);break}}}return Promise.all(r).then((e=>{const t=new b;return e.forEach((e=>{t.add(e.scene)})),{tiles:e,scene:t}}))}}class Re{constructor(){this.name="CESIUM_RTC"}afterRoot(e){if(e.parser.json.extensions&&e.parser.json.extensions.CESIUM_RTC){const{center:t}=e.parser.json.extensions.CESIUM_RTC;t&&(e.scene.position.x+=t[0],e.scene.position.y+=t[1],e.scene.position.z+=t[2])}}}class Ue extends le{constructor(e=l){super(),this.manager=e}parse(e){return new Promise(((t,s)=>{const n=this.manager,r=this.fetchOptions;let i=n.getHandler("path.gltf")||n.getHandler("path.glb");i||(i=new c(n),i.register((()=>new Re))),"include"===r.credentials&&"cors"===r.mode&&i.setCrossOrigin("use-credentials"),"credentials"in r&&i.setWithCredentials("include"===r.credentials),r.headers&&i.setRequestHeader(r.headers);let a=i.resourcePath||i.path||this.workingPath;!/[\\/]$/.test(a)&&a.length&&(a+="/"),i.parse(e,a,(e=>{t(e)}),s)}))}}const Ae=new o;class Me extends b{constructor(e){super(),this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e}raycast(e,t){return!this.tilesRenderer.optimizeRaycast||(this.tilesRenderer.raycast(e,t),!1)}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){null===this.parent?Ae.copy(this.matrix):Ae.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const e=Ae.elements,t=this.matrixWorld.elements;let s=!1;for(let n=0;n<16;n++){const r=e[n],i=t[n];if(Math.abs(r-i)>Number.EPSILON){s=!0;break}}if(s){this.matrixWorld.copy(Ae);const e=this.children;for(let t=0,s=e.length;t<s;t++)e[t].updateMatrixWorld()}}}}const Fe=parseInt(w)<165,Le=new o,ke=new y,Oe=new d,De=[];function Ie(e,t){return e.distance-t.distance}function Ne(e,t,s,n){const{scene:r}=e.cached;if(Fe)r.traverse((e=>{Object.getPrototypeOf(e).raycast.call(e,t,n)})),De.sort(Ie);else{s.invokeOnePlugin((s=>s.raycastTile&&s.raycastTile(e,r,t,n)))||t.intersectObject(r,!0,n)}}function Be(e,t,s,n=null){const{group:r,activeTiles:i}=e;e.ensureChildrenArePreprocessed(t),null===n&&(n=ke,Le.copy(r.matrixWorld).invert(),n.copy(s.ray).applyMatrix4(Le));const a=[],o=t.children;for(let h=0,d=o.length;h<d;h++){const e=o[h];if(!e.__used)continue;null!==e.cached.boundingVolume.intersectRay(n,Oe)&&(Oe.applyMatrix4(r.matrixWorld),a.push({distance:Oe.distanceToSquared(s.ray.origin),tile:e}))}a.sort(Ie);let l=null,c=1/0;if(i.has(t)){const n=function(e,t,s){Ne(e,t,s,De);const n=De[0]||null;return De.length=0,n}(t,s,e);n&&(l=n,c=n.distance*n.distance)}for(let h=0,d=a.length;h<d;h++){const t=a[h],r=t.distance,i=t.tile;if(r>c)break;const o=Be(e,i,s,n);if(o){const e=o.distance*o.distance;e<c&&(l=o,c=e)}}return l}function Ve(e,t,s,n,r=null){const{group:i,activeTiles:a}=e,{boundingVolume:o}=t.cached;if(e.ensureChildrenArePreprocessed(t),null===r&&(r=ke,Le.copy(i.matrixWorld).invert(),r.copy(s.ray).applyMatrix4(Le)),!t.__used||!o.intersectsRay(r))return;a.has(t)&&Ne(t,s,e,n);const l=t.children;for(let c=0,h=l.length;c<h;c++)Ve(e,l[c],s,n,r)}const ze=new d,je=new d,He=new d,qe=new y;class We{constructor(e=new x,t=new o){this.box=e.clone(),this.transform=t.clone(),this.inverseTransform=new o,this.points=new Array(8).fill().map((()=>new d)),this.planes=new Array(6).fill().map((()=>new T))}clampPoint(e,t){return t.copy(e).applyMatrix4(this.inverseTransform).clamp(this.box.min,this.box.max).applyMatrix4(this.transform)}distanceToPoint(e){return this.clampPoint(e,He).distanceTo(e)}containsPoint(e){return He.copy(e).applyMatrix4(this.inverseTransform),this.box.containsPoint(He)}intersectsRay(e){return qe.copy(e).applyMatrix4(this.inverseTransform),qe.intersectsBox(this.box)}intersectRay(e,t){return qe.copy(e).applyMatrix4(this.inverseTransform),qe.intersectBox(this.box,t)?(t.applyMatrix4(this.transform),t):null}update(){const{points:e,inverseTransform:t,transform:s,box:n}=this;t.copy(s).invert();const{min:r,max:i}=n;let a=0;for(let o=-1;o<=1;o+=2)for(let t=-1;t<=1;t+=2)for(let n=-1;n<=1;n+=2)e[a].set(o<0?r.x:i.x,t<0?r.y:i.y,n<0?r.z:i.z).applyMatrix4(s),a++;this.updatePlanes()}updatePlanes(){ze.copy(this.box.min).applyMatrix4(this.transform),je.copy(this.box.max).applyMatrix4(this.transform),He.set(0,0,1).transformDirection(this.transform),this.planes[0].setFromNormalAndCoplanarPoint(He,ze),this.planes[1].setFromNormalAndCoplanarPoint(He,je).negate(),He.set(0,1,0).transformDirection(this.transform),this.planes[2].setFromNormalAndCoplanarPoint(He,ze),this.planes[3].setFromNormalAndCoplanarPoint(He,je).negate(),He.set(1,0,0).transformDirection(this.transform),this.planes[4].setFromNormalAndCoplanarPoint(He,ze),this.planes[5].setFromNormalAndCoplanarPoint(He,je).negate()}intersectsFrustum(e){const{points:t}=this,{planes:s}=e;for(let n=0;n<6;n++){const e=s[n];let r=-1/0;for(let s=0;s<8;s++){const n=t[s],i=e.distanceToPoint(n);r=r<i?i:r}if(r<0)return!1}for(let n=0;n<6;n++){const t=this.planes[n];let s=-1/0;for(let n=0;n<8;n++){const r=e.points[n],i=t.distanceToPoint(r);s=s<i?i:s}if(s<0)return!1}return!0}}new C,new d;const Ge=new C,Qe=new d,Je=new d,Ye=new d,Ze=new d,Xe=new o,$e=new o,Ke=new S,et=new v,tt=new d,st=new d,nt=new d,rt=new d,it=new y;class at{constructor(e=1,t=1,s=1){this.radius=new d(e,t,s)}intersectRay(e,t){return Xe.makeScale(...this.radius).invert(),Ke.center.set(0,0,0),Ke.radius=1,it.copy(e).applyMatrix4(Xe),it.intersectSphere(Ke,t)?(Xe.makeScale(...this.radius),t.applyMatrix4(Xe),t):null}getEastNorthUpFrame(e,t,s){return this.getEastNorthUpAxes(e,t,tt,st,nt,rt),s.makeBasis(tt,st,nt).setPosition(rt)}getEastNorthUpAxes(e,t,s,n,r,i=rt){this.getCartographicToPosition(e,t,0,i),this.getCartographicToNormal(e,t,r),s.set(-i.y,i.x,0).normalize(),n.crossVectors(r,s).normalize()}getNorthernTangent(e,t,s,n=Ze){return console.log("Ellipsoid: getNorthernTangent has been deprecated. Use getEastNorthUpAxes instead."),this.getEastNorthUpAxes(e,t,n,s,nt),n.multiplyScalar(-1),s}getAzElRollFromRotationMatrix(e,t,s,n,r=0){return 1===r?(et.set(-Math.PI/2,0,0,"XYZ"),$e.makeRotationFromEuler(et).premultiply(s)):2===r?(et.set(-Math.PI/2,0,Math.PI,"XYZ"),$e.makeRotationFromEuler(et).premultiply(s)):$e.copy(s),this.getEastNorthUpFrame(e,t,Xe).invert(),$e.premultiply(Xe),et.setFromRotationMatrix($e,"ZXY"),n.azimuth=-et.z,n.elevation=et.x,n.roll=et.y,n}getRotationMatrixFromAzElRoll(e,t,s,n,r,i,a=0){return this.getEastNorthUpFrame(e,t,Xe),et.set(n,r,-s,"ZXY"),i.makeRotationFromEuler(et).premultiply(Xe).setPosition(0,0,0),1===a?(et.set(Math.PI/2,0,0,"XYZ"),$e.makeRotationFromEuler(et),i.multiply($e)):2===a&&(et.set(-Math.PI/2,0,Math.PI,"XYZ"),$e.makeRotationFromEuler(et),i.multiply($e)),i}getCartographicToPosition(e,t,s,n){this.getCartographicToNormal(e,t,Qe);const r=this.radius;Je.copy(Qe),Je.x*=r.x**2,Je.y*=r.y**2,Je.z*=r.z**2;const i=Math.sqrt(Qe.dot(Je));return Je.divideScalar(i),n.copy(Je).addScaledVector(Qe,s)}getPositionToCartographic(e,t){this.getPositionToSurfacePoint(e,Je),this.getPositionToNormal(e,Qe);const s=Ye.subVectors(e,Je);return t.lon=Math.atan2(Qe.y,Qe.x),t.lat=Math.asin(Qe.z),t.height=Math.sign(s.dot(e))*s.length(),t}getCartographicToNormal(e,t,s){return Ge.set(1,-e+Math.PI/2,t),s.setFromSpherical(Ge).normalize(),function(e){const{x:t,y:s,z:n}=e;e.x=n,e.y=t,e.z=s}(s),s}getPositionToNormal(e,t){const s=this.radius;return t.copy(e),t.x/=s.x**2,t.y/=s.y**2,t.z/=s.z**2,t.normalize(),t}getPositionToSurfacePoint(e,t){const s=this.radius,n=1/s.x**2,r=1/s.y**2,i=1/s.z**2,a=e.x*e.x*n,o=e.y*e.y*r,l=e.z*e.z*i,c=a+o+l,h=Math.sqrt(1/c),d=Je.copy(e).multiplyScalar(h);if(c<.1)return isFinite(h)?t.copy(d):null;const u=Ye.set(d.x*n*2,d.y*r*2,d.z*i*2);let p,m,g,f,_,b,y,w,T,x,C,S=(1-h)*e.length()/(.5*u.length()),v=0;do{S-=v,g=1/(1+S*n),f=1/(1+S*r),_=1/(1+S*i),b=g*g,y=f*f,w=_*_,T=b*g,x=y*f,C=w*_,p=a*b+o*y+l*w-1,m=a*T*n+o*x*r+l*C*i;v=p/(-2*m)}while(Math.abs(p)>1e-12);return t.set(e.x*g,e.y*f,e.z*_)}calculateHorizonDistance(e,t){const s=this.calculateEffectiveRadius(e);return Math.sqrt(2*s*t+t**2)}calculateEffectiveRadius(e){const t=this.radius.x,s=1-this.radius.z**2/t**2,n=e*P.DEG2RAD,r=Math.sin(n)**2;return t/Math.sqrt(1-s*r)}getPositionElevation(e){this.getPositionToSurfacePoint(e,Je);const t=Ye.subVectors(e,Je);return Math.sign(t.dot(e))*t.length()}copy(e){return this.radius.copy(e.radius),this}clone(){return(new this.constructor).copy(this)}}const ot=Math.PI,lt=ot/2,ct=new d,ht=new d,dt=new d,ut=new o;let pt=0;const mt=[];function gt(e=!1){return e?(mt[pt]||(mt[pt]=new d),pt++,mt[pt-1]):new d}function ft(){pt=0}class _t extends at{constructor(e,t,s,n=-lt,r=lt,i=0,a=2*ot,o=0,l=0){super(e,t,s),this.latStart=n,this.latEnd=r,this.lonStart=i,this.lonEnd=a,this.heightStart=o,this.heightEnd=l}_getPoints(e=!1){const{latStart:t,latEnd:s,lonStart:n,lonEnd:r,heightStart:i,heightEnd:a}=this,o=P.mapLinear(.5,0,1,t,s),l=P.mapLinear(.5,0,1,n,r),c=Math.floor(n/lt)*lt,h=[[-ot/2,0],[ot/2,0],[0,c],[0,c+ot/2],[0,c+ot],[0,c+3*ot/2],[t,r],[s,r],[t,n],[s,n],[0,n],[0,r],[o,l],[t,l],[s,l],[o,n],[o,r]],d=[],u=h.length;for(let p=0;p<=1;p++){const o=P.mapLinear(p,0,1,i,a);for(let i=0,a=u;i<a;i++){const[a,l]=h[i];if(a>=t&&a<=s&&l>=n&&l<=r){const t=gt(e);d.push(t),this.getCartographicToPosition(a,l,o,t)}}}return d}getBoundingBox(e,t){ft();const{latStart:s,latEnd:n,lonStart:r,lonEnd:i}=this;if(n-s<ot/2){const e=P.mapLinear(.5,0,1,s,n),a=P.mapLinear(.5,0,1,r,i);this.getCartographicToNormal(e,a,dt),ht.set(0,0,1),ct.crossVectors(ht,dt),ht.crossVectors(ct,dt),t.makeBasis(ct,ht,dt)}else ct.set(1,0,0),ht.set(0,1,0),dt.set(0,0,1),t.makeBasis(ct,ht,dt);ut.copy(t).invert();const a=this._getPoints(!0);for(let o=0,l=a.length;o<l;o++)a[o].applyMatrix4(ut);e.makeEmpty(),e.setFromPoints(a)}getBoundingSphere(e,t){ft();const s=this._getPoints(!0);e.makeEmpty(),e.setFromPoints(s,t)}}const bt=new d,yt=new d,wt=new d,Tt=new d,xt=new d;class Ct{constructor(){this.sphere=null,this.obb=null,this.region=null,this.regionObb=null}intersectsRay(e){const t=this.sphere,s=this.obb||this.regionObb;return!(t&&!e.intersectsSphere(t))&&!(s&&!s.intersectsRay(e))}intersectRay(e,t=null){const s=this.sphere,n=this.obb||this.regionObb;let r=-1/0,i=-1/0;s&&e.intersectSphere(s,Tt)&&(r=s.containsPoint(e.origin)?0:e.origin.distanceToSquared(Tt)),n&&n.intersectRay(e,xt)&&(i=n.containsPoint(e.origin)?0:e.origin.distanceToSquared(xt));const a=Math.max(r,i);return a===-1/0?null:(e.at(Math.sqrt(a),t),t)}distanceToPoint(e){const t=this.sphere,s=this.obb||this.regionObb;let n=-1/0,r=-1/0;return t&&(n=Math.max(t.distanceToPoint(e),0)),s&&(r=s.distanceToPoint(e)),n>r?n:r}intersectsFrustum(e){const t=this.obb||this.regionObb,s=this.sphere;return!(s&&!e.intersectsSphere(s))&&(!(t&&!t.intersectsFrustum(e))&&Boolean(s||t))}getOBB(e,t){const s=this.obb||this.regionObb;s?(e.copy(s.box),t.copy(s.transform)):(this.getAABB(e),t.identity())}getAABB(e){if(this.sphere)this.sphere.getBoundingBox(e);else{const t=this.obb||this.regionObb;e.copy(t.box).applyMatrix4(t.transform)}}getSphere(e){if(this.sphere)e.copy(this.sphere);else if(this.region)this.region.getBoundingSphere(e);else{const t=this.obb||this.regionObb;t.box.getBoundingSphere(e),e.applyMatrix4(t.transform)}}setObbData(e,t){const s=new We;bt.set(e[3],e[4],e[5]),yt.set(e[6],e[7],e[8]),wt.set(e[9],e[10],e[11]);const n=bt.length(),r=yt.length(),i=wt.length();bt.normalize(),yt.normalize(),wt.normalize(),0===n&&bt.crossVectors(yt,wt),0===r&&yt.crossVectors(bt,wt),0===i&&wt.crossVectors(bt,yt),s.transform.set(bt.x,yt.x,wt.x,e[0],bt.y,yt.y,wt.y,e[1],bt.z,yt.z,wt.z,e[2],0,0,0,1).premultiply(t),s.box.min.set(-n,-r,-i),s.box.max.set(n,r,i),s.update(),this.obb=s}setSphereData(e,t,s,n,r){const i=new S;i.center.set(e,t,s),i.radius=n,i.applyMatrix4(r),this.sphere=i}setRegionData(e,t,s,n,r,i,a){const o=new _t(...e.radius,s,r,t,n,i,a),l=new We;o.getBoundingBox(l.box,l.transform),l.update(),this.region=o,this.regionObb=l}}const St=new E;class vt extends R{constructor(){super(),this.points=Array(8).fill().map((()=>new d))}setFromProjectionMatrix(e,t){super.setFromProjectionMatrix(e,t),this.calculateFrustumPoints()}calculateFrustumPoints(){const{planes:e,points:t}=this;[[e[0],e[3],e[4]],[e[1],e[3],e[4]],[e[0],e[2],e[4]],[e[1],e[2],e[4]],[e[0],e[3],e[5]],[e[1],e[3],e[5]],[e[0],e[2],e[5]],[e[1],e[2],e[5]]].forEach(((e,s)=>{!function(e,t,s,n){const r=St.set(e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z,s.normal.x,s.normal.y,s.normal.z);n.set(-e.constant,-t.constant,-s.constant),n.applyMatrix3(r.invert())}(e[0],e[1],e[2],t[s])}))}}const Pt=new at(B,B,6356752.314245179);new at(V,V,1736e3);const Et=new o,Rt=new v,Ut=parseInt(w)<165,At=Symbol("INITIAL_FRUSTUM_CULLED"),Mt=new o,Ft=new o,Lt=new d,kt=new M,Ot=new d(1,0,0),Dt=new d(0,1,0);function It(e,t){e.traverse((e=>{e.frustumCulled=e[At]&&t}))}class Nt extends te{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel((t=>{It(t,!e)})))}constructor(...e){super(...e),this.group=new Me(this),this.ellipsoid=Pt.clone(),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this.activeTiles=new Set,this.visibleTiles=new Set,this.optimizeRaycast=!0,this._eventDispatcher=new F,this._upRotationMatrix=new o,this.lruCache.computeMemoryUsageCallback=e=>{var t;return null!=(t=e.cached.bytesUsed)?t:null},this._autoDisableRendererCulling=!0,this._loadingTiles=!1;const t=new L;if(t.setURLModifier((e=>this.preprocessURL?this.preprocessURL(e):e)),this.manager=t,Ut){const e=this;this._overridenRaycast=function(t,s){e.optimizeRaycast||Object.getPrototypeOf(this).raycast.call(this,t,s)}}}addEventListener(...e){this._eventDispatcher.addEventListener(...e)}hasEventListener(...e){this._eventDispatcher.hasEventListener(...e)}removeEventListener(...e){this._eventDispatcher.removeEventListener(...e)}dispatchEvent(...e){this._eventDispatcher.dispatchEvent(...e)}getBounds(...e){return console.warn("TilesRenderer: getBounds has been renamed to getBoundingBox."),this.getBoundingBox(...e)}getOrientedBounds(...e){return console.warn("TilesRenderer: getOrientedBounds has been renamed to getOrientedBoundingBox."),this.getOrientedBoundingBox(...e)}getBoundingBox(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return!!t&&(t.getAABB(e),!0)}getOrientedBoundingBox(e,t){if(!this.root)return!1;const s=this.root.cached.boundingVolume;return!!s&&(s.getOBB(e,t),!0)}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return!!t&&(t.getSphere(e),!0)}forEachLoadedModel(e){this.traverse((t=>{const s=t.cached.scene;s&&e(s,t)}))}raycast(e,t){if(this.root)if(e.firstHitOnly){const s=Be(this,this.root,e);s&&t.push(s)}else Ve(this,this.root,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,s=this.cameraMap;return!s.has(e)&&(s.set(e,new M),t.push(e),this.dispatchEvent({type:"add-camera",camera:e}),!0)}setResolution(e,t,s){const n=this.cameraMap;if(!n.has(e))return!1;const r=t.isVector2?t.x:t,i=t.isVector2?t.y:s,a=n.get(e);return a.width===r&&a.height===i||(a.set(r,i),this.dispatchEvent({type:"camera-resolution-change"})),!0}setResolutionFromRenderer(e,t){return t.getSize(kt).multiplyScalar(t.getPixelRatio()),this.setResolution(e,kt.x,kt.y)}deleteCamera(e){const t=this.cameras,s=this.cameraMap;if(s.has(e)){const n=t.indexOf(e);return t.splice(n,1),s.delete(e),this.dispatchEvent({type:"delete-camera",camera:e}),!0}return!1}preprocessTileSet(e,t,s){super.preprocessTileSet(e,t,s),queueMicrotask((()=>{this.dispatchEvent({type:"load-tile-set",tileSet:e,url:t})}))}loadRootTileSet(...e){return super.loadRootTileSet(...e).then((()=>{switch((this.rootTileSet.asset&&this.rootTileSet.asset.gltfUpAxis||"y").toLowerCase()){case"x":this._upRotationMatrix.makeRotationAxis(Dt,-Math.PI/2);break;case"y":this._upRotationMatrix.makeRotationAxis(Ot,Math.PI/2)}this.dispatchEvent({type:"load-content"})})).catch((()=>{}))}update(){let e=null;if(this.invokeAllPlugins((t=>{if(t.doTilesNeedUpdate){const s=t.doTilesNeedUpdate();e=null===e?s:e||s}})),!1===e)return this.dispatchEvent({type:"update-before"}),void this.dispatchEvent({type:"update-after"});this.dispatchEvent({type:"update-before"});const t=this.group,s=this.cameras,n=this.cameraMap,r=this.cameraInfo;if(0!==s.length){for(;r.length>s.length;)r.pop();for(;r.length<s.length;)r.push({frustum:new vt,isOrthographic:!1,sseDenominator:-1,position:new d,invScale:-1,pixelSize:0});Ft.copy(t.matrixWorld).invert(),Lt.setFromMatrixScale(Ft),Math.abs(Math.max(Lt.x-Lt.y,Lt.x-Lt.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let e=0,i=r.length;e<i;e++){const i=s[e],a=r[e],o=a.frustum,l=a.position,c=n.get(i);0!==c.width&&0!==c.height||console.warn("TilesRenderer: resolution for camera error calculation is not set.");const h=i.projectionMatrix.elements;if(a.isOrthographic=1===h[15],a.isOrthographic){const e=2/h[0],t=2/h[5];a.pixelSize=Math.max(t/c.height,e/c.width)}else a.sseDenominator=2/h[5]/c.height;Mt.copy(t.matrixWorld),Mt.premultiply(i.matrixWorldInverse),Mt.premultiply(i.projectionMatrix),o.setFromProjectionMatrix(Mt),l.set(0,0,0),l.applyMatrix4(i.matrixWorld),l.applyMatrix4(Ft)}super.update(),this.dispatchEvent({type:"update-after"})}else console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.")}preprocessNode(e,t,s=null){super.preprocessNode(e,t,s);const n=new o;if(e.transform){const t=e.transform;for(let e=0;e<16;e++)n.elements[e]=t[e]}s&&n.premultiply(s.cached.transform);const r=(new o).copy(n).invert(),i=new Ct;"sphere"in e.boundingVolume&&i.setSphereData(...e.boundingVolume.sphere,n),"box"in e.boundingVolume&&i.setObbData(e.boundingVolume.box,n),"region"in e.boundingVolume&&i.setRegionData(this.ellipsoid,...e.boundingVolume.region),e.cached={_loadIndex:0,transform:n,transformInverse:r,active:!1,boundingVolume:i,metadata:null,scene:null,geometry:null,materials:null,textures:null}}async requestTileContents(...e){await super.requestTileContents(...e),this.dispatchEvent({type:"load-content"})}async parseTile(e,t,s,n){const r=t.cached;r._loadIndex++;const i=n.split(/[\\/]/g);i.pop();const a=i.join("/"),o=this.fetchOptions,l=this.manager,c=r._loadIndex;let h=null;const d=r.transform,u=this._upRotationMatrix,p=(ce(e)||s).toLowerCase();switch(p){case"b3dm":{const t=new de(l);t.workingPath=a,t.fetchOptions=o,t.adjustmentTransform.copy(u),h=t.parse(e);break}case"pnts":{const t=new ge(l);t.workingPath=a,t.fetchOptions=o,h=t.parse(e);break}case"i3dm":{const t=new ve(l);t.workingPath=a,t.fetchOptions=o,t.adjustmentTransform.copy(u),h=t.parse(e);break}case"cmpt":{const t=new Ee(l);t.workingPath=a,t.fetchOptions=o,t.adjustmentTransform.copy(u),h=t.parse(e).then((e=>e.scene));break}case"gltf":case"glb":{const t=new Ue(l);t.workingPath=a,t.fetchOptions=o,h=t.parse(e);break}default:console.warn('TilesRenderer: Content type "'.concat(p,'" not supported.')),h=Promise.resolve(null)}const m=this.stats;!1===this._loadingTiles&&m.parsing+m.downloading>0&&(this.dispatchEvent({type:"tiles-load-start"}),this._loadingTiles=!0);const g=await h;let f,_;if(g.isObject3D?(f=g,_=null):(f=g.scene,_=g),await this.invokeAllPlugins((e=>e.processTileModel&&e.processTileModel(f,t))),r._loadIndex!==c)return;f.updateMatrix(),"glb"!==p&&"gltf"!==p||f.matrix.multiply(u),f.matrix.premultiply(d),f.matrix.decompose(f.position,f.quaternion,f.scale),f.traverse((e=>{e[At]=e.frustumCulled})),It(f,!this.autoDisableRendererCulling),Ut&&f.traverse((e=>{e.raycast=this._overridenRaycast}));const b=[],y=[],w=[];f.traverse((e=>{if(e.geometry&&y.push(e.geometry),e.material){const t=e.material;b.push(e.material);for(const e in t){const s=t[e];s&&s.isTexture&&w.push(s)}}})),r.materials=b,r.geometry=y,r.textures=w,r.scene=f,r.metadata=_,r.bytesUsed=function(e){const{TextureUtils:t}=A;if(!t)return 0;const s=new Set;let n=0;return e.traverse((e=>{if(e.geometry&&!s.has(e.geometry)&&(n+=U(e.geometry),s.add(e.geometry)),e.material){const r=e.material;for(const e in r){const i=r[e];if(i&&i.isTexture&&!s.has(i)){const{format:e,type:r,image:a}=i,{width:o,height:l}=a,c=t.getByteLength(o,l,e,r);n+=i.generateMipmaps?4*c/3:c,s.add(i)}}}})),n}(f),this.dispatchEvent({type:"load-model",scene:f,tile:t}),!0===this._loadingTiles&&m.parsing+m.downloading===1&&(this.dispatchEvent({type:"tiles-load-end"}),this._loadingTiles=!1)}disposeTile(e){super.disposeTile(e);const t=e.cached;if(t.scene){const s=t.materials,n=t.geometry,r=t.textures,i=t.scene.parent;t.scene.traverse((e=>{e.userData.meshFeatures&&e.userData.meshFeatures.dispose(),e.userData.structuralMetadata&&e.userData.structuralMetadata.dispose()}));for(let e=0,t=n.length;e<t;e++)n[e].dispose();for(let e=0,t=s.length;e<t;e++)s[e].dispose();for(let e=0,t=r.length;e<t;e++){const t=r[e];t.image instanceof ImageBitmap&&t.image.close(),t.dispose()}i&&i.remove(t.scene),this.dispatchEvent({type:"dispose-model",scene:t.scene,tile:e}),t.scene=null,t.materials=null,t.textures=null,t.geometry=null,t.metadata=null}t._loadIndex++}setTileVisible(e,t){const s=e.cached.scene,n=this.visibleTiles,r=this.group;t?(r.add(s),n.add(e),s.updateMatrixWorld(!0)):(r.remove(s),n.delete(e)),this.dispatchEvent({type:"tile-visibility-change",scene:s,tile:e,visible:t})}setTileActive(e,t){const s=this.activeTiles;t?s.add(e):s.delete(e)}calculateError(e){const t=e.cached,s=this.cameras,n=this.cameraInfo,r=t.boundingVolume;let i=-1/0,a=1/0;for(let o=0,l=s.length;o<l;o++){const t=n[o];let s;if(t.isOrthographic){const n=t.pixelSize;s=e.geometricError/n}else{const n=r.distanceToPoint(t.position),i=t.sseDenominator;s=e.geometricError/(n*i),a=Math.min(a,n)}i=Math.max(i,s)}e.__distanceFromCamera=a,e.__error=i}tileInView(e){const t=e.cached.boundingVolume,s=this.cameraInfo;for(let n=0,r=s.length;n<r;n++){const e=s[n].frustum;if(t.intersectsFrustum(e))return!0}return!1}setLatLonToYUp(e,t){const{ellipsoid:s,group:n}=this;Rt.set(Math.PI/2,Math.PI/2,0),Et.makeRotationFromEuler(Rt),s.getEastNorthUpFrame(e,t,n.matrix).multiply(Et).invert().decompose(n.position,n.quaternion,n.scale),n.updateMatrixWorld(!0)}}[["onLoadTileSet","load-tile-set"],["onLoadModel","load-model"],["onDisposeModel","dispose-model"],["onTileVisibilityChange","tile-visibility-change"]].forEach((([e,t])=>{const s=Symbol(e);Object.defineProperty(Nt.prototype,e,{get(){return this[s]||null},set(n){console.warn('TilesRenderer: "'.concat(e,'" has been deprecated in favor of the "').concat(t,'" event.')),this[s]&&this.removeEventListener(t,this[s]),this[s]=n,this.addEventListener(t,n)}})}));export{Nt as T};
