import{o as w}from"./object_hash.DvA9o96b1718275421844.js";import{aX as T,bP as j}from"./vendor.n5mLuYaN1718275421844.js";import{t as N,a as F,s as O}from"./index.iuxbrWH61718275421844.js";function L(e,n){if(typeof e!="object"||e===null)return e;var a=e[Symbol.toPrimitive];if(a!==void 0){var r=a.call(e,n||"default");if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(n==="string"?String:Number)(e)}function D(e){var n=L(e,"string");return typeof n=="symbol"?n:String(n)}function c(e,n,a){return n=D(n),n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function C(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),a.push.apply(a,r)}return a}function S(e){for(var n=1;n<arguments.length;n++){var a=arguments[n]!=null?arguments[n]:{};n%2?C(Object(a),!0).forEach(function(r){c(e,r,a[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):C(Object(a)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(a,r))})}return e}function H(e,n){if(e==null)return{};var a={},r=Object.keys(e),t,o;for(o=0;o<r.length;o++)t=r[o],!(n.indexOf(t)>=0)&&(a[t]=e[t]);return a}function U(e,n){if(e==null)return{};var a=H(e,n),r,t;if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(t=0;t<o.length;t++)r=o[t],!(n.indexOf(r)>=0)&&Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}function B(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function I(e,n){for(var a=0;a<n.length;a++){var r=n[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,D(r.key),r)}}function k(e,n,a){return n&&I(e.prototype,n),a&&I(e,a),Object.defineProperty(e,"prototype",{writable:!1}),e}function x(e){if(e===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function A(e,n){return A=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,t){return r.__proto__=t,r},A(e,n)}function z(e,n){if(typeof n!="function"&&n!==null)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),n&&A(e,n)}function E(e){return E=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(a){return a.__proto__||Object.getPrototypeOf(a)},E(e)}function V(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function K(e,n){if(n&&(typeof n=="object"||typeof n=="function"))return n;if(n!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return x(e)}function G(e){var n=V();return function(){var r=E(e),t;if(n){var o=E(this).constructor;t=Reflect.construct(r,arguments,o)}else t=r.apply(this,arguments);return K(this,t)}}var i={position:"csm_Position",positionRaw:"csm_PositionRaw",pointSize:"csm_PointSize",fragColor:"csm_FragColor",diffuseColor:"csm_DiffuseColor",normal:"csm_Normal",roughness:"csm_Roughness",metalness:"csm_Metalness",emissive:"csm_Emissive",ao:"csm_AO",bump:"csm_Bump",depthAlpha:"csm_DepthAlpha"},_,y,W=(_={},c(_,"".concat(i.normal),{"#include <beginnormal_vertex>":"\n    vec3 objectNormal = ".concat(i.normal,";\n    #ifdef USE_TANGENT\n	    vec3 objectTangent = vec3( tangent.xyz );\n    #endif\n    ")}),c(_,"".concat(i.position),{"#include <begin_vertex>":"\n    vec3 transformed = ".concat(i.position,";\n  ")}),c(_,"".concat(i.positionRaw),{"#include <begin_vertex>":"\n    vec4 csm_internal_positionUnprojected = ".concat(i.positionRaw,";\n    mat4x4 csm_internal_unprojectMatrix = projectionMatrix * modelViewMatrix;\n    #ifdef USE_INSTANCING\n      csm_internal_unprojectMatrix = csm_internal_unprojectMatrix * instanceMatrix;\n    #endif\n    csm_internal_positionUnprojected = inverse(csm_internal_unprojectMatrix) * csm_internal_positionUnprojected;\n    vec3 transformed = csm_internal_positionUnprojected.xyz;\n  ")}),c(_,"".concat(i.pointSize),{"gl_PointSize = size;":"\n    gl_PointSize = ".concat(i.pointSize,";\n    ")}),c(_,"".concat(i.diffuseColor),{"#include <color_fragment>":"\n    #include <color_fragment>\n    diffuseColor = ".concat(i.diffuseColor,";\n  ")}),c(_,"".concat(i.fragColor),{"#include <dithering_fragment>":"\n    #include <dithering_fragment>\n    gl_FragColor  = ".concat(i.fragColor,";\n  ")}),c(_,"".concat(i.emissive),{"vec3 totalEmissiveRadiance = emissive;":"\n    vec3 totalEmissiveRadiance = ".concat(i.emissive,";\n    ")}),c(_,"".concat(i.roughness),{"#include <roughnessmap_fragment>":"\n    #include <roughnessmap_fragment>\n    roughnessFactor = ".concat(i.roughness,";\n    ")}),c(_,"".concat(i.metalness),{"#include <metalnessmap_fragment>":"\n    #include <metalnessmap_fragment>\n    metalnessFactor = ".concat(i.metalness,";\n    ")}),c(_,"".concat(i.ao),{"#include <aomap_fragment>":"\n    #include <aomap_fragment>\n    reflectedLight.indirectDiffuse *= 1. - ".concat(i.ao,";\n    ")}),c(_,"".concat(i.bump),{"#include <normal_fragment_maps>":"\n    #include <normal_fragment_maps>\n\n    vec3 csm_internal_orthogonal = ".concat(i.bump," - (dot(").concat(i.bump,", normal) * normal);\n    vec3 csm_internal_projectedbump = mat3(csm_internal_vModelViewMatrix) * csm_internal_orthogonal;\n    normal = normalize(normal - csm_internal_projectedbump);\n    ")}),c(_,"".concat(i.depthAlpha),{"gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );":"\n      gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity * ".concat(i.depthAlpha," );\n    "),"gl_FragColor = packDepthToRGBA( fragCoordZ );":"\n      gl_FragColor = packDepthToRGBA( fragCoordZ );\n      gl_FragColor.a *= ".concat(i.depthAlpha,";\n    ")}),_),X=(y={},c(y,"".concat(i.position),{"gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );":"\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( ".concat(i.position,", 1.0 );\n  ")}),c(y,"".concat(i.positionRaw),{"gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );":"\n    gl_Position = ".concat(i.position,";\n  ")}),c(y,"".concat(i.diffuseColor),{"gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );":"\n    gl_FragColor = ".concat(i.diffuseColor,";\n  ")}),c(y,"".concat(i.fragColor),{"gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );":"\n    gl_FragColor = ".concat(i.fragColor,";\n  ")}),y),Z="\n\n#ifdef IS_VERTEX\n    // csm_Position & csm_PositionRaw\n    #ifdef IS_UNKNOWN\n        vec3 csm_Position = vec3(0.0);\n        vec4 csm_PositionRaw = vec4(0.0);\n        vec3 csm_Normal = vec3(0.0);\n    #else\n        vec3 csm_Position = position;\n        vec4 csm_PositionRaw = projectionMatrix * modelViewMatrix * vec4(position, 1.);\n        vec3 csm_Normal = normal;\n    #endif\n\n    // csm_PointSize\n    #ifdef IS_POINTSMATERIAL\n        float csm_PointSize = size;\n    #endif\n#else\n    // csm_DiffuseColor & csm_FragColor\n    #if defined IS_UNKNOWN || defined IS_SHADERMATERIAL || defined IS_MESHDEPTHMATERIAL || defined IS_MESHNORMALMATERIAL || defined IS_SHADOWMATERIAL\n        vec4 csm_DiffuseColor = vec4(1.0, 0.0, 1.0, 1.0);\n        vec4 csm_FragColor = vec4(1.0, 0.0, 1.0, 1.0);\n    #else\n        #ifdef USE_MAP\n            vec4 _csm_sampledDiffuseColor = texture2D(map, vMapUv);\n\n            #ifdef DECODE_VIDEO_TEXTURE\n            // inline sRGB decode (TODO: Remove this code when https://crbug.com/1256340 is solved)\n            _csm_sampledDiffuseColor = vec4(mix(pow(_csm_sampledDiffuseColor.rgb * 0.9478672986 + vec3(0.0521327014), vec3(2.4)), _csm_sampledDiffuseColor.rgb * 0.0773993808, vec3(lessThanEqual(_csm_sampledDiffuseColor.rgb, vec3(0.04045)))), _csm_sampledDiffuseColor.w);\n            #endif\n\n            vec4 csm_DiffuseColor = vec4(diffuse, opacity) * _csm_sampledDiffuseColor;\n            vec4 csm_FragColor = vec4(diffuse, opacity) * _csm_sampledDiffuseColor;\n        #else\n            vec4 csm_DiffuseColor = vec4(diffuse, opacity);\n            vec4 csm_FragColor = vec4(diffuse, opacity);\n        #endif\n    #endif\n\n    // csm_Emissive, csm_Roughness, csm_Metalness\n    #if defined IS_MESHSTANDARDMATERIAL || defined IS_MESHPHYSICALMATERIAL\n        vec3 csm_Emissive = emissive;\n        float csm_Roughness = roughness;\n        float csm_Metalness = metalness;\n    #endif\n\n    // csm_AO\n    #if defined IS_MESHSTANDARDMATERIAL || defined IS_MESHPHYSICALMATERIAL || defined IS_MESHBASICMATERIAL || defined IS_MESHLAMBERTMATERIAL || defined IS_MESHPHONGMATERIAL || defined IS_MESHTOONMATERIAL\n        float csm_AO = 0.0;\n    #endif\n\n    // csm_Bump\n    #if defined IS_MESHLAMBERTMATERIAL || defined IS_MESHMATCAPMATERIAL || defined IS_MESHNORMALMATERIAL || defined IS_MESHPHONGMATERIAL || defined IS_MESHPHYSICALMATERIAL || defined IS_MESHSTANDARDMATERIAL || defined IS_MESHTOONMATERIAL || defined IS_SHADOWMATERIAL \n        vec3 csm_Bump = vec3(0.0);\n    #endif\n\n    float csm_DepthAlpha = 1.0;\n#endif\n",Y="\n    varying mat4 csm_internal_vModelViewMatrix;\n",$="\n    csm_internal_vModelViewMatrix = modelViewMatrix;\n",q="\n    varying mat4 csm_internal_vModelViewMatrix;\n",J="\n    \n",p,Q=(p={},c(p,"".concat(i.position),"*"),c(p,"".concat(i.positionRaw),"*"),c(p,"".concat(i.normal),"*"),c(p,"".concat(i.pointSize),["PointsMaterial"]),c(p,"".concat(i.diffuseColor),"*"),c(p,"".concat(i.fragColor),"*"),c(p,"".concat(i.emissive),["MeshStandardMaterial","MeshPhysicalMaterial"]),c(p,"".concat(i.roughness),["MeshStandardMaterial","MeshPhysicalMaterial"]),c(p,"".concat(i.metalness),["MeshStandardMaterial","MeshPhysicalMaterial"]),c(p,"".concat(i.ao),["MeshStandardMaterial","MeshPhysicalMaterial","MeshBasicMaterial","MeshLambertMaterial","MeshPhongMaterial","MeshToonMaterial"]),c(p,"".concat(i.bump),["MeshLambertMaterial","MeshMatcapMaterial","MeshNormalMaterial","MeshPhongMaterial","MeshPhysicalMaterial","MeshStandardMaterial","MeshToonMaterial","ShadowMaterial"]),c(p,"".concat(i.depthAlpha),"*"),p),ee=["baseMaterial","fragmentShader","vertexShader","uniforms","patchMap","cacheKey","silent"],ne=function(n,a,r){return n.split(a).join(r)},te=function(n){return n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},re=function(n,a){return new RegExp("\\b".concat(te(a),"\\b")).test(n)};function ae(e){try{new e}catch(n){if(n.message.indexOf("is not a constructor")>=0)return!1}return!0}function ie(e,n){var a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;Object.assign(e,n);var r=Object.getPrototypeOf(n);Object.entries(Object.getOwnPropertyDescriptors(r)).filter(function(t){var o=typeof t[1].get=="function",u=typeof t[1].set=="function",l=typeof t[1].value=="function",s=t[0]==="constructor";return(o||u||l)&&!s}).forEach(function(t){if(typeof e[t[0]]=="function"){a||console.warn("Function ".concat(t[0]," already exists on CSM, renaming to base_").concat(t[0]));var o="base_".concat(t[0]);e[o]=t[1].value.bind(e);return}Object.defineProperty(e,t[0],t[1])})}function oe(e){var n=e.toString().trim(),a=n.substring(n.indexOf("{")+1,n.lastIndexOf("}"));return a.trim().length===0}function P(e){return e.replace(/\s/g,"")}function ce(e,n,a){var r=e.lastIndexOf(n);return r===-1?e:e.substring(0,r)+a+e.substring(r+n.length)}var ue=function(e){z(a,e);var n=G(a);function a(r){var t,o=r.baseMaterial,u=r.fragmentShader,l=r.vertexShader,s=r.uniforms,m=r.patchMap,h=r.cacheKey,v=r.silent,d=U(r,ee);B(this,a);var f;if(ae(o)?f=new o(d):(f=o,Object.assign(f,d)),f.type==="RawShaderMaterial")throw new Error("CustomShaderMaterial does not support RawShaderMaterial");t=n.call(this),ie(x(t),f,v),t.__csm={patchMap:m||{},fragmentShader:u||"",vertexShader:l||"",cacheKey:h,baseMaterial:o,instanceID:T.generateUUID(),type:f.type,isAlreadyExtended:!oe(f.onBeforeCompile),cacheHash:"",silent:v},t.uniforms=S(S({},t.uniforms||{}),s||{});{var M=t.__csm,g=M.fragmentShader,b=M.vertexShader,R=t.uniforms;t.__csm.cacheHash=t.getCacheHash(),t.generateMaterial(g,b,R)}return t}return k(a,[{key:"update",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.uniforms=t.uniforms||this.uniforms,Object.assign(this.__csm,t);var o=this.__csm,u=o.fragmentShader,l=o.vertexShader,s=this.uniforms,m=this.getCacheHash();this.__csm.cacheHash=m,this.generateMaterial(u,l,s)}},{key:"clone",value:function(){var t={baseMaterial:this.__csm.baseMaterial,fragmentShader:this.__csm.fragmentShader,vertexShader:this.__csm.vertexShader,uniforms:this.uniforms,silent:this.__csm.silent,patchMap:this.__csm.patchMap,cacheKey:this.__csm.cacheKey},o=new this.constructor(t);return Object.assign(this,o),o}},{key:"getCacheHash",value:function(){var t=this.__csm,o=t.fragmentShader,u=t.vertexShader,l=this.uniforms,s=Object.values(l).reduce(function(h,v){var d=v.value;return h+JSON.stringify(d)},""),m=P(o)+P(u)+s;return m.trim().length>0?w(m):this.customProgramCacheKey()}},{key:"generateMaterial",value:function(t,o,u){var l=this,s=this.parseShader(t),m=this.parseShader(o);this.uniforms=u||{},this.customProgramCacheKey=function(){return l.__csm.cacheHash};var h=function(f){try{if(s){var M=l.patchShader(s,f.fragmentShader,!0);f.fragmentShader=l.getMaterialDefine()+M}if(m){var g=l.patchShader(m,f.vertexShader);f.vertexShader="#define IS_VERTEX;\n"+g,f.vertexShader=l.getMaterialDefine()+f.vertexShader}f.uniforms=S(S({},f.uniforms),l.uniforms),l.uniforms=f.uniforms}catch(b){console.error(b)}};if(this.__csm.isAlreadyExtended){var v=this.onBeforeCompile;this.onBeforeCompile=function(d,f){v(d,f),h(d)}}else this.onBeforeCompile=h;this.needsUpdate=!0}},{key:"patchShader",value:function(t,o,u){var l=this,s=o,m=S(S({},this.getPatchMapForMaterial()),this.__csm.patchMap);Object.keys(m).forEach(function(d){Object.keys(m[d]).forEach(function(f){var M=Q[d],g=l.__csm.type;if(d==="*"||re(t.main,d))if(!M||Array.isArray(M)&&M.includes(g)||M==="*")s=ne(s,f,m[d][f]);else throw new Error("CSM: ".concat(d," is not available in ").concat(g,". Shader cannot compile."))})}),s=s.replace("void main() {","\n        #ifndef CSM_IS_HEAD_DEFAULTS_DEFINED\n          ".concat(u?q:Y,"\n          #define CSM_IS_HEAD_DEFAULTS_DEFINED 1\n        #endif\n\n        ").concat(t.header,"\n        \n        void main() {\n          #ifndef CSM_IS_DEFAULTS_DEFINED\n            ").concat(Z,"\n            #define CSM_IS_DEFAULTS_DEFINED 1\n          #endif\n          \n          #ifndef CSM_IS_MAIN_DEFAULTS_DEFINED\n            ").concat(u?J:$,"\n            #define CSM_IS_MAIN_DEFAULTS_DEFINED 1\n          #endif\n\n          // CSM_START\n      "));var h=this.__csm.isAlreadyExtended,v=s.includes("// CSM_END");return h&&v?s=ce(s,"// CSM_END","\n          // CSM_END\n          ".concat(t.main,"\n          // CSM_END\n        ")):s=s.replace("// CSM_START","\n        // CSM_START\n        ".concat(t.main,"\n        // CSM_END\n          ")),s=t.defines+s,s}},{key:"parseShader",value:function(t){if(t){var o=t.replace(/\/\*\*(.*?)\*\/|\/\/(.*?)\n/gm,""),u=N(o),l=F(u),s=l.map(function(v){return v.name}).indexOf("main"),m=O(u.slice(0,s>=0?l[s].outer[0]:void 0)),h=s>=0?this.getShaderFromIndex(u,l[s].body):"";return{defines:"",header:m,main:h}}}},{key:"getMaterialDefine",value:function(){var t=this.__csm.type;return t?"#define IS_".concat(t.toUpperCase(),";\n"):"#define IS_UNKNOWN;\n"}},{key:"getPatchMapForMaterial",value:function(){switch(this.__csm.type){case"ShaderMaterial":return X;default:return W}}},{key:"getShaderFromIndex",value:function(t,o){return O(t.slice(o[0],o[1]))}}]),a}(j);export{ue as C};
