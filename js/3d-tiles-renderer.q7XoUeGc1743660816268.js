import{M as t,D as e,G as s,V as i,a as n,b as r,P as a,B as o,c as l,C as c,d as h,S as d,e as u,E as p,R as m,I as f,Q as g,f as y,g as _,h as b,i as T,F as x,j as v,T as w,L as P,k as C,l as M,m as S,n as A,o as E,p as D,O as U,q as R,r as L,s as k,t as F,W as I,u as O,v as z,w as V,Z as N,x as B,y as W,z as j,A as G,H,U as q,J as Z}from"./three.2wx8FU0g1743660816268.js";function $(t){let e;try{e=new URL(t,"http://fakehost.com/")}catch(n){return null}const s=e.pathname.split("/").pop(),i=s.lastIndexOf(".");if(-1===i||i===s.length-1)return null;return s.substring(i+1)}class Q{get unloadPriorityCallback(){return this._unloadPriorityCallback}set unloadPriorityCallback(t){1===t.length?(console.warn('LRUCache: "unloadPriorityCallback" function has been changed to take two arguments.'),this._unloadPriorityCallback=(e,s)=>{const i=t(e),n=t(s);return i<n?-1:i>n?1:0}):this._unloadPriorityCallback=t}constructor(){this.minSize=6e3,this.maxSize=8e3,this.minBytesSize=322122547.2,this.maxBytesSize=429496729.6,this.unloadPercent=.05,this.autoMarkUnused=!0,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadingHandle=-1,this.cachedBytes=0,this.bytesMap=new Map,this.loadedSet=new Set,this._unloadPriorityCallback=null,this.computeMemoryUsageCallback=()=>null;const t=this.itemSet;this.defaultPriorityCallback=e=>t.get(e)}isFull(){return this.itemSet.size>=this.maxSize||this.cachedBytes>=this.maxBytesSize}getMemoryUsage(t){return this.bytesMap.get(t)??null}add(t,e){const s=this.itemSet;if(s.has(t))return!1;if(this.isFull())return!1;const i=this.usedSet,n=this.itemList,r=this.callbacks,a=this.bytesMap;n.push(t),i.add(t),s.set(t,Date.now()),r.set(t,e);const o=this.computeMemoryUsageCallback(t);return this.cachedBytes+=o||0,a.set(t,o),!0}has(t){return this.itemSet.has(t)}remove(t){const e=this.usedSet,s=this.itemSet,i=this.itemList,n=this.bytesMap,r=this.callbacks,a=this.loadedSet;if(s.has(t)){this.cachedBytes-=n.get(t)||0,n.delete(t),r.get(t)(t);const o=i.indexOf(t);return i.splice(o,1),e.delete(t),s.delete(t),r.delete(t),a.delete(t),!0}return!1}setLoaded(t,e){const{itemSet:s,loadedSet:i}=this;s.has(t)&&(!0===e?i.add(t):i.delete(t))}updateMemoryUsage(t){const e=this.itemSet,s=this.bytesMap;if(!e.has(t))return;this.cachedBytes-=s.get(t)||0;const i=this.computeMemoryUsageCallback(t);s.set(t,i),this.cachedBytes+=i}markUsed(t){const e=this.itemSet,s=this.usedSet;e.has(t)&&!s.has(t)&&(e.set(t,Date.now()),s.add(t))}markUnused(t){this.usedSet.delete(t)}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const{unloadPercent:t,minSize:e,maxSize:s,itemList:i,itemSet:n,usedSet:r,loadedSet:a,callbacks:o,bytesMap:l,minBytesSize:c,maxBytesSize:h}=this,d=i.length-r.size,u=i.length-a.size,p=Math.max(Math.min(i.length-e,d),0),m=this.cachedBytes-c,f=this.unloadPriorityCallback||this.defaultPriorityCallback;let g=!1;const y=p>0&&d>0||u&&i.length>s;if(d&&this.cachedBytes>c||u&&this.cachedBytes>h||y){i.sort(((t,e)=>{const s=r.has(t);if(s===r.has(e)){const s=a.has(t);return s===a.has(e)?-f(t,e):s?1:-1}return s?1:-1}));const u=Math.max(e*t,p*t),y=Math.ceil(Math.min(u,d,p)),_=Math.max(t*m,t*c),b=Math.min(_,m);let T=0,x=0;for(;this.cachedBytes-x>h||i.length-T>s;){const t=i[T],e=l.get(t)||0;if(r.has(t)&&a.has(t)||this.cachedBytes-x-e<h&&i.length-T<=s)break;x+=e,T++}for(;x<b||T<y;){const t=i[T],e=l.get(t)||0;if(r.has(t)||this.cachedBytes-x-e<c&&T>=y)break;x+=e,T++}i.splice(0,T).forEach((t=>{this.cachedBytes-=l.get(t)||0,o.get(t)(t),l.delete(t),n.delete(t),o.delete(t),a.delete(t),r.delete(t)})),g=T<p||x<m&&T<d,g=g&&T>0}g&&(this.unloadingHandle=requestAnimationFrame((()=>this.scheduleUnload())))}scheduleUnload(){cancelAnimationFrame(this.unloadingHandle),this.scheduled||(this.scheduled=!0,queueMicrotask((()=>{this.scheduled=!1,this.unloadUnusedContent()})))}}class Y{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=t=>{requestAnimationFrame(t)},this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}sort(){const t=this.priorityCallback;this.items.sort(t)}add(t,e){return new Promise(((s,i)=>{const n=this.items,r=this.callbacks;n.push(t),r.set(t,((...t)=>e(...t).then(s).catch(i))),this.autoUpdate&&this.scheduleJobRun()}))}remove(t){const e=this.items,s=this.callbacks,i=e.indexOf(t);-1!==i&&(e.splice(i,1),s.delete(t))}tryRunJobs(){this.sort();const t=this.items,e=this.callbacks,s=this.maxJobs;let i=this.currJobs;for(;s>i&&t.length>0;){i++;const s=t.pop(),n=e.get(s);e.delete(s),n(s).then((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})).catch((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}))}this.currJobs=i}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const J=-1,X=0,K=3,tt=6378137;function et(t){return t===K||t===J}function st(t,e){return t.__lastFrameVisited===e&&t.__used}function it(t,e){t.__lastFrameVisited!==e.frameCount&&(t.__lastFrameVisited=e.frameCount,t.__used=!1,t.__inFrustum=!1,t.__isLeaf=!1,t.__visible=!1,t.__active=!1,t.__error=1/0,t.__distanceFromCamera=1/0,t.__childrenWereVisible=!1,t.__allChildrenLoaded=!1,t.__inFrustum=e.tileInView(t),e.calculateError(t))}function nt(t,e){if(e.ensureChildrenArePreprocessed(t),it(t,e),at(t,e),!t.__hasRenderableContent){const s=t.children;for(let t=0,i=s.length;t<i;t++)nt(s[t],e)}}function rt(t,e){if(e.ensureChildrenArePreprocessed(t),st(t,e.frameCount)){t.__hasContent&&t.__loadingState===X&&!e.lruCache.isFull()&&e.queueTileForDownload(t);const s=t.children;for(let t=0,i=s.length;t<i;t++)rt(s[t],e)}}function at(t,e){t.__used||(t.__used=!0,e.markTileUsed(t),e.stats.used++,!0===t.__inFrustum&&e.stats.inFrustum++)}function ot(t,e=null,s=null){const i=[];for(i.push(t),i.push(null),i.push(0);i.length>0;){const t=i.pop(),n=i.pop(),r=i.pop();if(e&&e(r,n,t))return void(s&&s(r,n,t));const a=r.children;if(a)for(let e=a.length-1;e>=0;e--)i.push(a[e]),i.push(r),i.push(t+1);s&&s(r,n,t)}}function lt(t,e){if(e.ensureChildrenArePreprocessed(t),it(t,e),!t.__inFrustum)return;if(!function(t,e){return!(t.__error<=e.errorTarget||e.maxDepth>0&&t.__depth+1>=e.maxDepth)}(t,e))return void at(t,e);let s=!1,i=!1;const n=t.children;for(let r=0,a=n.length;r<a;r++){const t=n[r];lt(t,e),s=s||st(t,e.frameCount),i=i||t.__inFrustum}if("REPLACE"!==t.refine||i||0===n.length||t.__hasUnrenderableContent){if(at(t,e),s&&"REPLACE"===t.refine)for(let r=0,a=n.length;r<a;r++){nt(n[r],e)}}else t.__inFrustum=!1}function ct(t,e){const s=e.frameCount;if(!st(t,s))return;const i=t.children;let n=!1;for(let r=0,a=i.length;r<a;r++){const t=i[r];n=n||st(t,s)}if(n){let n=!1,r=!0;for(let t=0,a=i.length;t<a;t++){const a=i[t];if(ct(a,e),n=n||a.__wasSetVisible||a.__childrenWereVisible,st(a,s)){const t=a.__allChildrenLoaded||a.__hasRenderableContent&&et(a.__loadingState)||!a.__hasContent&&0===a.children.length||a.__hasUnrenderableContent&&a.__loadingState===J;r=r&&t}}t.__childrenWereVisible=n,t.__allChildrenLoaded=r}else t.__isLeaf=!0}function ht(t,e){const s=e.stats;if(!st(t,e.frameCount))return;const i=e.lruCache;if(t.__isLeaf)return void(t.__loadingState===K?(t.__inFrustum&&(t.__visible=!0,s.visible++),t.__active=!0,s.active++):!i.isFull()&&t.__hasContent&&e.queueTileForDownload(t));const n=t.children,r=t.__hasContent,a=et(t.__loadingState)&&r,o=(e.errorTarget+1)*e.errorThreshold,l=t.__error<=o,c=t.__childrenWereVisible,h=t.__allChildrenLoaded;if((l||"ADD"===t.refine)&&!a&&!i.isFull()&&r&&e.queueTileForDownload(t),(l&&!h&&!c&&a||"ADD"===t.refine&&a)&&(t.__inFrustum&&(t.__visible=!0,s.visible++),t.__active=!0,s.active++),"REPLACE"===t.refine&&l&&!h)for(let d=0,u=n.length;d<u;d++){const t=n[d];st(t,e.frameCount)&&rt(t,e)}else for(let d=0,u=n.length;d<u;d++)ht(n[d],e)}function dt(t,e){const s=st(t,e.frameCount);if(s||t.__usedLastFrame){let i=!1,n=!1;s?(i=t.__active,n=e.displayActiveTiles&&t.__active||t.__visible):it(t,e),t.__hasRenderableContent&&t.__loadingState===K&&(t.__wasSetActive!==i&&e.setTileActive(t,i),t.__wasSetVisible!==n&&e.invokeOnePlugin((e=>e.setTileVisible&&e.setTileVisible(t,n)))),t.__wasSetActive=i,t.__wasSetVisible=n,t.__usedLastFrame=s;const r=t.children;for(let t=0,s=r.length;t<s;t++){dt(r[t],e)}}}const ut=Symbol("PLUGIN_REGISTERED"),pt=(t,e)=>t.__depthFromRenderedParent!==e.__depthFromRenderedParent?t.__depthFromRenderedParent>e.__depthFromRenderedParent?-1:1:t.__inFrustum!==e.__inFrustum?t.__inFrustum?1:-1:t.__used!==e.__used?t.__used?1:-1:t.__error!==e.__error?t.__error>e.__error?1:-1:t.__distanceFromCamera!==e.__distanceFromCamera?t.__distanceFromCamera>e.__distanceFromCamera?-1:1:0,mt=(t,e)=>t.__depthFromRenderedParent!==e.__depthFromRenderedParent?t.__depthFromRenderedParent>e.__depthFromRenderedParent?1:-1:t.__loadingState!==e.__loadingState?t.__loadingState>e.__loadingState?-1:1:t.__lastFrameVisited!==e.__lastFrameVisited?t.__lastFrameVisited>e.__lastFrameVisited?-1:1:t.__hasUnrenderableContent!==e.__hasUnrenderableContent?t.__hasUnrenderableContent?-1:1:t.__error!==e.__error?t.__error>e.__error?-1:1:0;class ft{get root(){const t=this.rootTileSet;return t?t.root:null}get loadProgress(){const t=this.stats,e=t.downloading+t.parsing,s=t.inCacheSinceLoad;return 0===s?1:1-e/s}constructor(t=null){this.rootLoadingState=X,this.rootTileSet=null,this.rootURL=t,this.fetchOptions={},this.plugins=[],this.queuedTiles=[],this.cachedSinceLoadComplete=new Set;const e=new Q;e.unloadPriorityCallback=mt;const s=new Y;s.maxJobs=10,s.priorityCallback=pt;const i=new Y;i.maxJobs=1,i.priorityCallback=pt,this.visibleTiles=new Set,this.activeTiles=new Set,this.usedSet=new Set,this.lruCache=e,this.downloadQueue=s,this.parseQueue=i,this.stats={inCacheSinceLoad:0,inCache:0,parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this.errorThreshold=1/0,this.displayActiveTiles=!1,this.maxDepth=1/0}registerPlugin(t){if(!0===t[ut])throw new Error("TilesRendererBase: A plugin can only be registered to a single tile set");const e=this.plugins,s=t.priority||0;let i=0;for(let n=0;n<e.length;n++){i=n;if((e[n].priority||0)>s)break}e.splice(i,0,t),t[ut]=!0,t.init&&t.init(this)}unregisterPlugin(t){const e=this.plugins;if("string"==typeof t&&(t=this.getPluginByName(name)),e.includes(t)){const s=e.indexOf(t);return e.splice(s,1),t.dispose&&t.dispose(),!0}return!1}getPluginByName(t){return this.plugins.find((e=>e.name===t))||null}traverse(t,e){this.root&&ot(this.root,((e,...s)=>(this.ensureChildrenArePreprocessed(e),!!t&&t(e,...s))),e)}queueTileForDownload(t){t.__loadingState===X&&this.queuedTiles.push(t)}markTileUsed(t){this.usedSet.add(t),this.lruCache.markUsed(t)}update(){const{lruCache:t,usedSet:e,stats:s,root:i}=this;if(this.rootLoadingState===X&&(this.rootLoadingState=1,this.invokeOnePlugin((t=>t.loadRootTileSet&&t.loadRootTileSet())).then((()=>this.rootLoadingState=K)).catch((t=>{this.rootLoadingState=J,console.error(t)}))),!i)return;s.inFrustum=0,s.used=0,s.active=0,s.visible=0,this.frameCount++,e.forEach((e=>t.markUnused(e))),e.clear(),lt(i,this),ct(i,this),ht(i,this),dt(i,this);const n=this.queuedTiles;n.sort(t.unloadPriorityCallback);for(let r=0,a=n.length;r<a&&!t.isFull();r++)this.requestTileContents(n[r]);n.length=0,t.scheduleUnload()}resetFailedTiles(){this.rootLoadingState===J&&(this.rootLoadingState=X);const t=this.stats;0!==t.failed&&(this.traverse((t=>{t.__loadingState===J&&(t.__loadingState=X)})),t.failed=0)}dispose(){this.invokeAllPlugins((t=>{t!==this&&t.dispose&&t.dispose()}));const t=this.lruCache,e=[];this.traverse((t=>(e.push(t),!1)));for(let s=0,i=e.length;s<i;s++)t.remove(e[s]);this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}dispatchEvent(t){}fetchData(t,e){return fetch(t,e)}parseTile(t,e,s){return null}disposeTile(t){t.__visible&&(this.invokeOnePlugin((e=>e.setTileVisible&&e.setTileVisible(t,!1))),t.__visible=!1),t.__active&&(this.setTileActive(t,!1),t.__active=!1)}preprocessNode(t,e,s=null){if(t.content&&(!("uri"in t.content)&&"url"in t.content&&(t.content.uri=t.content.url,delete t.content.url),t.content.boundingVolume&&!("box"in t.content.boundingVolume||"sphere"in t.content.boundingVolume||"region"in t.content.boundingVolume)&&delete t.content.boundingVolume),t.parent=s,t.children=t.children||[],t.content?.uri){const e=$(t.content.uri);t.__hasContent=!0,t.__hasUnrenderableContent=Boolean(e&&/json$/.test(e)),t.__hasRenderableContent=!t.__hasUnrenderableContent}else t.__hasContent=!1,t.__hasUnrenderableContent=!1,t.__hasRenderableContent=!1;t.__distanceFromCamera=1/0,t.__error=1/0,t.__inFrustum=!1,t.__isLeaf=!1,t.__usedLastFrame=!1,t.__used=!1,t.__wasSetVisible=!1,t.__visible=!1,t.__childrenWereVisible=!1,t.__allChildrenLoaded=!1,t.__wasSetActive=!1,t.__active=!1,t.__loadingState=X,null===s?(t.__depth=0,t.__depthFromRenderedParent=t.__hasRenderableContent?1:0,t.refine=t.refine||"REPLACE"):(t.__depth=s.__depth+1,t.__depthFromRenderedParent=s.__depthFromRenderedParent+(t.__hasRenderableContent?1:0),t.refine=t.refine||s.refine),t.__basePath=e,t.__lastFrameVisited=-1,this.invokeAllPlugins((i=>{i!==this&&i.preprocessNode&&i.preprocessNode(t,e,s)}))}setTileActive(t,e){e?this.activeTiles.add(t):this.activeTiles.delete(t)}setTileVisible(t,e){e?this.visibleTiles.add(t):this.visibleTiles.delete(t)}calculateError(t){return 0}tileInView(t){return!0}ensureChildrenArePreprocessed(t){const e=t.children;for(let s=0,i=e.length;s<i;s++){const i=e[s];if("__depth"in i)break;this.preprocessNode(i,t.__basePath,t)}}preprocessTileSet(t,e,s=null){const i=t.asset.version,[n,r]=i.split(".").map((t=>parseInt(t)));console.assert(n<=1,"TilesRenderer: asset.version is expected to be a 1.x or a compatible version."),1===n&&r>0&&console.warn("TilesRenderer: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let a=e.replace(/\/[^/]*\/?$/,"");a=new URL(a,window.location.href).toString(),this.preprocessNode(t.root,a,s)}loadRootTileSet(){let t=this.rootURL;this.invokeAllPlugins((e=>t=e.preprocessURL?e.preprocessURL(t,null):t));const e=this.invokeOnePlugin((e=>e.fetchData&&e.fetchData(t,this.fetchOptions))).then((e=>{if(e.ok)return e.json();throw new Error(`TilesRenderer: Failed to load tileset "${t}" with status ${e.status} : ${e.statusText}`)})).then((e=>{this.preprocessTileSet(e,t),this.rootTileSet=e}));return e.catch((e=>{console.error(e),this.rootTileSet=null,this.dispatchEvent({type:"load-error",tile:null,error:e,uri:t})})),e}requestTileContents(t){if(t.__loadingState!==X)return;let e=!1,s=new URL(t.content.uri,t.__basePath+"/").toString();this.invokeAllPlugins((e=>s=e.preprocessURL?e.preprocessURL(s,t):s));const i=this.stats,n=this.lruCache,r=this.downloadQueue,a=this.parseQueue,o=$(s),l=new AbortController,c=l.signal;return n.add(t,(s=>{l.abort(),e?s.children.length=0:this.invokeAllPlugins((t=>{t.disposeTile&&t.disposeTile(s)})),i.inCache--,this.cachedSinceLoadComplete.has(t)&&(this.cachedSinceLoadComplete.delete(t),i.inCacheSinceLoad--),1===s.__loadingState?i.downloading--:2===s.__loadingState&&i.parsing--,s.__loadingState=X,a.remove(s),r.remove(s)}))?(0===i.parsing&&0===i.downloading&&this.dispatchEvent({type:"tiles-load-start"}),this.cachedSinceLoadComplete.add(t),i.inCacheSinceLoad++,i.inCache++,i.downloading++,t.__loadingState=1,r.add(t,(t=>c.aborted?Promise.resolve():this.invokeOnePlugin((t=>t.fetchData&&t.fetchData(s,{...this.fetchOptions,signal:c}))))).then((t=>{if(!c.aborted){if(t.ok)return"json"===o?t.json():t.arrayBuffer();throw new Error(`Failed to load model with error code ${t.status}`)}})).then((n=>{if(!c.aborted)return i.downloading--,i.parsing++,t.__loadingState=2,a.add(t,(i=>c.aborted?Promise.resolve():"json"===o&&n.root?(this.preprocessTileSet(n,s,t),t.children.push(n.root),e=!0,Promise.resolve()):this.invokeOnePlugin((t=>t.parseTile&&t.parseTile(n,i,o,s,c)))))})).then((()=>{c.aborted||(i.parsing--,t.__loadingState=K,n.setLoaded(t,!0),null===n.getMemoryUsage(t)&&(n.isFull()&&n.computeMemoryUsageCallback(t)>0?n.remove(t):n.updateMemoryUsage(t)),t.cached.scene&&this.dispatchEvent({type:"load-model",scene:t.cached.scene,tile:t}))})).catch((e=>{c.aborted||("AbortError"!==e.name?(a.remove(t),r.remove(t),2===t.__loadingState?i.parsing--:1===t.__loadingState&&i.downloading--,i.failed++,console.error(`TilesRenderer : Failed to load tile at url "${t.content.uri}".`),console.error(e),t.__loadingState=J,n.setLoaded(t,!0),this.dispatchEvent({type:"load-error",tile:t,error:e,uri:s})):n.remove(t))})).finally((()=>{0===i.parsing&&0===i.downloading&&(this.cachedSinceLoadComplete.clear(),i.inCacheSinceLoad=0,this.dispatchEvent({type:"tiles-load-end"}))}))):void 0}getAttributions(t=[]){return this.invokeAllPlugins((e=>e!==this&&e.getAttributions&&e.getAttributions(t))),t}invokeOnePlugin(t){const e=[...this.plugins,this];for(let s=0;s<e.length;s++){const i=t(e[s]);if(i)return i}return null}invokeAllPlugins(t){const e=[...this.plugins,this],s=[];for(let i=0;i<e.length;i++){const n=t(e[i]);n&&s.push(n)}return 0===s.length?null:Promise.all(s)}}const gt=new TextDecoder;function yt(t){return gt.decode(t)}function _t(t,e,s,i,n,r){let a,o;switch(i){case"SCALAR":a=1;break;case"VEC2":a=2;break;case"VEC3":a=3;break;case"VEC4":a=4;break;default:throw new Error(`FeatureTable : Feature type not provided for "${r}".`)}const l=s*a;switch(n){case"BYTE":o=new Int8Array(t,e,l);break;case"UNSIGNED_BYTE":o=new Uint8Array(t,e,l);break;case"SHORT":o=new Int16Array(t,e,l);break;case"UNSIGNED_SHORT":o=new Uint16Array(t,e,l);break;case"INT":o=new Int32Array(t,e,l);break;case"UNSIGNED_INT":o=new Uint32Array(t,e,l);break;case"FLOAT":o=new Float32Array(t,e,l);break;case"DOUBLE":o=new Float64Array(t,e,l);break;default:throw new Error(`FeatureTable : Feature component type not provided for "${r}".`)}return o}class bt{constructor(t,e,s,i){this.buffer=t,this.binOffset=e+s,this.binLength=i;let n=null;if(0!==s){const i=new Uint8Array(t,e,s);n=JSON.parse(yt(i))}else n={};this.header=n}getKeys(){return Object.keys(this.header)}getData(t,e,s=null,i=null){const n=this.header;if(!(t in n))return null;const r=n[t];if(r instanceof Object){if(Array.isArray(r))return r;{const{buffer:n,binOffset:a,binLength:o}=this,l=r.byteOffset||0,c=r.type||i,h=r.componentType||s;if("type"in r&&i&&r.type!==i)throw new Error("FeatureTable: Specified type does not match expected type.");const d=a+l,u=_t(n,d,e,c,h,t);if(d+u.byteLength>a+o)throw new Error("FeatureTable: Feature data read outside binary body length.");return u}}return r}getBuffer(t,e){const{buffer:s,binOffset:i}=this;return s.slice(i+t,i+t+e)}}class Tt{constructor(t){this.batchTable=t;const e=t.header.extensions["3DTILES_batch_table_hierarchy"];this.classes=e.classes;for(const i of this.classes){const t=i.instances;for(const e in t)i.instances[e]=this._parseProperty(t[e],i.length,e)}if(this.instancesLength=e.instancesLength,this.classIds=this._parseProperty(e.classIds,this.instancesLength,"classIds"),e.parentCounts?this.parentCounts=this._parseProperty(e.parentCounts,this.instancesLength,"parentCounts"):this.parentCounts=new Array(this.instancesLength).fill(1),e.parentIds){const t=this.parentCounts.reduce(((t,e)=>t+e),0);this.parentIds=this._parseProperty(e.parentIds,t,"parentIds")}else this.parentIds=null;this.instancesIds=[];const s={};for(const i of this.classIds)s[i]=s[i]??0,this.instancesIds.push(s[i]),s[i]++}_parseProperty(t,e,s){if(Array.isArray(t))return t;{const{buffer:i,binOffset:n}=this.batchTable;return _t(i,n+t.byteOffset,e,"SCALAR",t.componentType||"UNSIGNED_SHORT",s)}}getDataFromId(t,e={}){const s=this.parentCounts[t];if(this.parentIds&&s>0){let i=0;for(let e=0;e<t;e++)i+=this.parentCounts[e];for(let n=0;n<s;n++){const s=this.parentIds[i+n];s!==t&&this.getDataFromId(s,e)}}const i=this.classIds[t],n=this.classes[i].instances,r=this.classes[i].name,a=this.instancesIds[t];for(const o in n)e[r]=e[r]||{},e[r][o]=n[o][a];return e}}class xt extends bt{get batchSize(){return console.warn("BatchTable.batchSize has been deprecated and replaced with BatchTable.count."),this.count}constructor(t,e,s,i,n){super(t,s,i,n),this.count=e,this.extensions={};const r=this.header.extensions;r&&r["3DTILES_batch_table_hierarchy"]&&(this.extensions["3DTILES_batch_table_hierarchy"]=new Tt(this))}getData(t,e=null,s=null){return console.warn("BatchTable: BatchTable.getData is deprecated. Use BatchTable.getDataFromId to get allproperties for an id or BatchTable.getPropertyArray for getting an array of value for a property."),super.getData(t,this.count,e,s)}getDataFromId(t,e={}){if(t<0||t>=this.count)throw new Error(`BatchTable: id value "${t}" out of bounds for "${this.count}" features number.`);for(const s of this.getKeys())"extensions"!==s&&(e[s]=super.getData(s,this.count)[t]);for(const s in this.extensions){const i=this.extensions[s];i.getDataFromId instanceof Function&&(e[s]=e[s]||{},i.getDataFromId(t,e[s]))}return e}getPropertyArray(t){return super.getData(t,this.count)}}class vt{constructor(){this.fetchOptions={},this.workingPath=""}load(t){return console.warn('Loader: "load" function has been deprecated in favor of "loadAsync".'),this.loadAsync(t)}loadAsync(t){return fetch(t,this.fetchOptions).then((e=>{if(!e.ok)throw new Error(`Failed to load file "${t}" with status ${e.status} : ${e.statusText}`);return e.arrayBuffer()})).then((e=>(""===this.workingPath&&(this.workingPath=this.workingPathForURL(t)),this.parse(e))))}resolveExternalURL(t){return/^[^\\/]/.test(t)&&!/^http/.test(t)?this.workingPath+"/"+t:t}workingPathForURL(t){const e=t.split(/[\\/]/g);e.pop();return e.join("/")+"/"}parse(t){throw new Error("LoaderBase: Parse not implemented.")}}function wt(t){let e;if(e=t instanceof DataView?t:new DataView(t),"{"===String.fromCharCode(e.getUint8(0)))return null;let s="";for(let i=0;i<4;i++)s+=String.fromCharCode(e.getUint8(i));return s}class Pt extends vt{parse(t){const e=new DataView(t),s=wt(e);console.assert("b3dm"===s);const i=e.getUint32(4,!0);console.assert(1===i);const n=e.getUint32(8,!0);console.assert(n===t.byteLength);const r=e.getUint32(12,!0),a=e.getUint32(16,!0),o=e.getUint32(20,!0),l=e.getUint32(24,!0),c=t.slice(28,28+r+a),h=new bt(c,0,r,a),d=28+r+a,u=t.slice(d,d+o+l),p=new xt(u,h.getData("BATCH_LENGTH"),0,o,l),m=d+o+l;return{version:i,featureTable:h,batchTable:p,glbBytes:new Uint8Array(t,m,n-m)}}}class Ct extends Pt{constructor(s=e){super(),this.manager=s,this.adjustmentTransform=new t}parse(t){const e=super.parse(t),i=e.glbBytes.slice().buffer;return new Promise(((t,n)=>{const r=this.manager,a=this.fetchOptions,o=r.getHandler("path.gltf")||new s(r);"include"===a.credentials&&"cors"===a.mode&&o.setCrossOrigin("use-credentials"),"credentials"in a&&o.setWithCredentials("include"===a.credentials),a.headers&&o.setRequestHeader(a.headers);let l=this.workingPath;!/[\\/]$/.test(l)&&l.length&&(l+="/");const c=this.adjustmentTransform;o.parse(i,l,(s=>{const{batchTable:i,featureTable:n}=e,{scene:r}=s,a=n.getData("RTC_CENTER");a&&(r.position.x+=a[0],r.position.y+=a[1],r.position.z+=a[2]),s.scene.updateMatrix(),s.scene.matrix.multiply(c),s.scene.matrix.decompose(s.scene.position,s.scene.quaternion,s.scene.scale),s.batchTable=i,s.featureTable=n,r.batchTable=i,r.featureTable=n,t(s)}),n)}))}}class Mt extends vt{parse(t){const e=new DataView(t),s=wt(e);console.assert("pnts"===s);const i=e.getUint32(4,!0);console.assert(1===i);const n=e.getUint32(8,!0);console.assert(n===t.byteLength);const r=e.getUint32(12,!0),a=e.getUint32(16,!0),o=e.getUint32(20,!0),l=e.getUint32(24,!0),c=t.slice(28,28+r+a),h=new bt(c,0,r,a),d=28+r+a,u=t.slice(d,d+o+l),p=new xt(u,h.getData("BATCH_LENGTH")||h.getData("POINTS_LENGTH"),0,o,l);return Promise.resolve({version:i,featureTable:h,batchTable:p})}}function St(t){const e=t>>11,s=t>>5&63,i=31&t;return[Math.round(e/31*255),Math.round(s/63*255),Math.round(i/31*255)]}const At=new i;function Et(t,e,s=new r){At.set(t,e).divideScalar(256).multiplyScalar(2).subScalar(1),s.set(At.x,At.y,1-Math.abs(At.x)-Math.abs(At.y));const i=n.clamp(-s.z,0,1);return s.x>=0?s.setX(s.x-i):s.setX(s.x+i),s.y>=0?s.setY(s.y-i):s.setY(s.y+i),s.normalize(),s}const Dt={RGB:"color",POSITION:"position"};class Ut extends Mt{constructor(t=e){super(),this.manager=t}parse(t){return super.parse(t).then((async t=>{const{featureTable:e,batchTable:s}=t,i=new a,n=e.header.extensions,d=new r;let u;if(n&&n["3DTILES_draco_point_compression"]){const{byteOffset:t,byteLength:s,properties:r}=n["3DTILES_draco_point_compression"],a=this.manager.getHandler("draco.drc");if(null==a)throw new Error("PNTSLoader: dracoLoader not available.");const o={};for(const e in r)if(e in Dt&&e in r){o[Dt[e]]=r[e]}const l={attributeIDs:o,attributeTypes:{position:"Float32Array",color:"Uint8Array"},useUniqueIDs:!0},c=e.getBuffer(t,s);u=await a.decodeGeometry(c,l),u.attributes.color&&(i.vertexColors=!0)}else{const t=e.getData("POINTS_LENGTH"),s=e.getData("POSITION",t,"FLOAT","VEC3"),n=e.getData("NORMAL",t,"FLOAT","VEC3"),a=e.getData("NORMAL",t,"UNSIGNED_BYTE","VEC2"),h=e.getData("RGB",t,"UNSIGNED_BYTE","VEC3"),p=e.getData("RGBA",t,"UNSIGNED_BYTE","VEC4"),m=e.getData("RGB565",t,"UNSIGNED_SHORT","SCALAR"),f=e.getData("CONSTANT_RGBA",t,"UNSIGNED_BYTE","VEC4"),g=e.getData("POSITION_QUANTIZED",t,"UNSIGNED_SHORT","VEC3"),y=e.getData("QUANTIZED_VOLUME_SCALE",t,"FLOAT","VEC3"),_=e.getData("QUANTIZED_VOLUME_OFFSET",t,"FLOAT","VEC3");if(u=new o,g){const e=new Float32Array(3*t);for(let s=0;s<t;s++)for(let t=0;t<3;t++){const i=3*s+t;e[i]=g[i]/65535*y[t]}d.x=_[0],d.y=_[1],d.z=_[2],u.setAttribute("position",new l(e,3,!1))}else u.setAttribute("position",new l(s,3,!1));if(null!==n)u.setAttribute("normal",new l(n,3,!1));else if(null!==a){const e=new Float32Array(3*t),s=new r;for(let i=0;i<t;i++){const t=Et(a[2*i],a[2*i+1],s);e[3*i]=t.x,e[3*i+1]=t.y,e[3*i+2]=t.z}u.setAttribute("normal",new l(e,3,!1))}if(null!==p)u.setAttribute("color",new l(p,4,!0)),i.vertexColors=!0,i.transparent=!0,i.depthWrite=!1;else if(null!==h)u.setAttribute("color",new l(h,3,!0)),i.vertexColors=!0;else if(null!==m){const e=new Uint8Array(3*t);for(let s=0;s<t;s++){const t=St(m[s]);for(let i=0;i<3;i++){e[3*s+i]=t[i]}}u.setAttribute("color",new l(e,3,!0)),i.vertexColors=!0}else if(null!==f){const t=new c(f[0],f[1],f[2]);i.color=t;const e=f[3]/255;e<1&&(i.opacity=e,i.transparent=!0,i.depthWrite=!1)}}const p=new h(u,i);p.position.copy(d),t.scene=p,t.scene.featureTable=e,t.scene.batchTable=s;const m=e.getData("RTC_CENTER");return m&&(t.scene.position.x+=m[0],t.scene.position.y+=m[1],t.scene.position.z+=m[2]),t}))}}class Rt extends vt{parse(t){const e=new DataView(t),s=wt(e);console.assert("i3dm"===s);const i=e.getUint32(4,!0);console.assert(1===i);const n=e.getUint32(8,!0);console.assert(n===t.byteLength);const r=e.getUint32(12,!0),a=e.getUint32(16,!0),o=e.getUint32(20,!0),l=e.getUint32(24,!0),c=e.getUint32(28,!0),h=t.slice(32,32+r+a),d=new bt(h,0,r,a),u=32+r+a,p=t.slice(u,u+o+l),m=new xt(p,d.getData("INSTANCES_LENGTH"),0,o,l),f=u+o+l,g=new Uint8Array(t,f,n-f);let y=null,_=null,b=null;if(c)y=g,_=Promise.resolve();else{const t=this.resolveExternalURL(yt(g)),e=t.split(/[\\/]/g);e.pop(),b=e.join("/"),_=fetch(t,this.fetchOptions).then((e=>{if(!e.ok)throw new Error(`I3DMLoaderBase : Failed to load file "${t}" with status ${e.status} : ${e.statusText}`);return e.arrayBuffer()})).then((t=>{y=new Uint8Array(t)}))}return _.then((()=>({version:i,featureTable:d,batchTable:m,glbBytes:y,gltfWorkingPath:b})))}}new d,new r;const Lt=new d,kt=new r,Ft=new r,It=new r,Ot=new t,zt=new t,Vt=new u,Nt=new p,Bt=new r,Wt=new r,jt=new r,Gt=new r,Ht=new m;class qt{constructor(t=1,e=1,s=1){this.name="",this.radius=new r(t,e,s)}intersectRay(t,e){return Ot.makeScale(...this.radius).invert(),Vt.center.set(0,0,0),Vt.radius=1,Ht.copy(t).applyMatrix4(Ot),Ht.intersectSphere(Vt,e)?(Ot.makeScale(...this.radius),e.applyMatrix4(Ot),e):null}getEastNorthUpFrame(t,e,s){return this.getEastNorthUpAxes(t,e,Bt,Wt,jt,Gt),s.makeBasis(Bt,Wt,jt).setPosition(Gt)}getEastNorthUpAxes(t,e,s,i,n,r=Gt){this.getCartographicToPosition(t,e,0,r),this.getCartographicToNormal(t,e,n),s.set(-r.y,r.x,0).normalize(),i.crossVectors(n,s).normalize()}getAzElRollFromRotationMatrix(t,e,s,i,n=0){return 1===n?(Nt.set(-Math.PI/2,0,0,"XYZ"),zt.makeRotationFromEuler(Nt).premultiply(s)):2===n?(Nt.set(-Math.PI/2,0,Math.PI,"XYZ"),zt.makeRotationFromEuler(Nt).premultiply(s)):zt.copy(s),this.getEastNorthUpFrame(t,e,Ot).invert(),zt.premultiply(Ot),Nt.setFromRotationMatrix(zt,"ZXY"),i.azimuth=-Nt.z,i.elevation=Nt.x,i.roll=Nt.y,i}getRotationMatrixFromAzElRoll(t,e,s,i,n,r,a=0){return this.getEastNorthUpFrame(t,e,Ot),Nt.set(i,n,-s,"ZXY"),r.makeRotationFromEuler(Nt).premultiply(Ot).setPosition(0,0,0),1===a?(Nt.set(Math.PI/2,0,0,"XYZ"),zt.makeRotationFromEuler(Nt),r.multiply(zt)):2===a&&(Nt.set(-Math.PI/2,0,Math.PI,"XYZ"),zt.makeRotationFromEuler(Nt),r.multiply(zt)),r}getFrame(t,e,s,i,n,r,a,o=0){return this.getRotationMatrixFromAzElRoll(t,e,s,i,n,a,o),this.getCartographicToPosition(t,e,r,Gt),a.setPosition(Gt),a}getCartographicToPosition(t,e,s,i){this.getCartographicToNormal(t,e,kt);const n=this.radius;Ft.copy(kt),Ft.x*=n.x**2,Ft.y*=n.y**2,Ft.z*=n.z**2;const r=Math.sqrt(kt.dot(Ft));return Ft.divideScalar(r),i.copy(Ft).addScaledVector(kt,s)}getPositionToCartographic(t,e){this.getPositionToSurfacePoint(t,Ft),this.getPositionToNormal(t,kt);const s=It.subVectors(t,Ft);return e.lon=Math.atan2(kt.y,kt.x),e.lat=Math.asin(kt.z),e.height=Math.sign(s.dot(t))*s.length(),e}getCartographicToNormal(t,e,s){return Lt.set(1,-t+Math.PI/2,e),s.setFromSpherical(Lt).normalize(),function(t){const{x:e,y:s,z:i}=t;t.x=i,t.y=e,t.z=s}(s),s}getPositionToNormal(t,e){const s=this.radius;return e.copy(t),e.x/=s.x**2,e.y/=s.y**2,e.z/=s.z**2,e.normalize(),e}getPositionToSurfacePoint(t,e){const s=this.radius,i=1/s.x**2,n=1/s.y**2,r=1/s.z**2,a=t.x*t.x*i,o=t.y*t.y*n,l=t.z*t.z*r,c=a+o+l,h=Math.sqrt(1/c),d=Ft.copy(t).multiplyScalar(h);if(c<.1)return isFinite(h)?e.copy(d):null;const u=It.set(d.x*i*2,d.y*n*2,d.z*r*2);let p,m,f,g,y,_,b,T,x,v,w,P=(1-h)*t.length()/(.5*u.length()),C=0;do{P-=C,f=1/(1+P*i),g=1/(1+P*n),y=1/(1+P*r),_=f*f,b=g*g,T=y*y,x=_*f,v=b*g,w=T*y,p=a*_+o*b+l*T-1,m=a*x*i+o*v*n+l*w*r;C=p/(-2*m)}while(Math.abs(p)>1e-12);return e.set(t.x*f,t.y*g,t.z*y)}calculateHorizonDistance(t,e){const s=this.calculateEffectiveRadius(t);return Math.sqrt(2*s*e+e**2)}calculateEffectiveRadius(t){const e=this.radius.x,s=1-this.radius.z**2/e**2,i=t*n.DEG2RAD,r=Math.sin(i)**2;return e/Math.sqrt(1-s*r)}getPositionElevation(t){this.getPositionToSurfacePoint(t,Ft);const e=It.subVectors(t,Ft);return Math.sign(e.dot(t))*e.length()}copy(t){return this.radius.copy(t.radius),this}clone(){return(new this.constructor).copy(this)}}const Zt=new qt(tt,tt,6356752.314245179);Zt.name="WGS84 Earth";const $t=new r,Qt=new r,Yt=new r,Jt=new r,Xt=new g,Kt=new r,te=new t,ee=new t,se=new r,ie=new t,ne=new g,re={};class ae extends Rt{constructor(s=e){super(),this.manager=s,this.adjustmentTransform=new t,this.ellipsoid=Zt.clone()}resolveExternalURL(t){return this.manager.resolveURL(super.resolveExternalURL(t))}parse(t){return super.parse(t).then((t=>{const{featureTable:e,batchTable:i}=t,n=t.glbBytes.slice().buffer;return new Promise(((a,o)=>{const l=this.fetchOptions,c=this.manager,h=c.getHandler("path.gltf")||new s(c);"include"===l.credentials&&"cors"===l.mode&&h.setCrossOrigin("use-credentials"),"credentials"in l&&h.setWithCredentials("include"===l.credentials),l.headers&&h.setRequestHeader(l.headers);let d=t.gltfWorkingPath??this.workingPath;/[\\/]$/.test(d)||(d+="/");const u=this.adjustmentTransform;h.parse(n,d,(t=>{const s=e.getData("INSTANCES_LENGTH"),n=e.getData("POSITION",s,"FLOAT","VEC3"),o=e.getData("NORMAL_UP",s,"FLOAT","VEC3"),l=e.getData("NORMAL_RIGHT",s,"FLOAT","VEC3"),c=e.getData("SCALE_NON_UNIFORM",s,"FLOAT","VEC3"),h=e.getData("SCALE",s,"FLOAT","SCALAR"),d=e.getData("RTC_CENTER"),p=e.getData("EAST_NORTH_UP");["QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach((t=>{t in e.header&&console.warn(`I3DMLoader: Unsupported FeatureTable feature "${t}" detected.`)}));const m=new r;for(let e=0;e<s;e++)m.x+=n[3*e+0]/s,m.y+=n[3*e+1]/s,m.z+=n[3*e+2]/s;const g=[],y=[];t.scene.updateMatrixWorld(),t.scene.traverse((t=>{if(t.isMesh){y.push(t);const{geometry:e,material:i}=t,n=new f(e,i,s);n.position.copy(m),d&&(n.position.x+=d[0],n.position.y+=d[1],n.position.z+=d[2]),g.push(n)}}));for(let e=0;e<s;e++){Jt.set(n[3*e+0]-m.x,n[3*e+1]-m.y,n[3*e+2]-m.z),Xt.identity(),o&&(Qt.set(o[3*e+0],o[3*e+1],o[3*e+2]),Yt.set(l[3*e+0],l[3*e+1],l[3*e+2]),$t.crossVectors(Yt,Qt).normalize(),te.makeBasis(Yt,Qt,$t),Xt.setFromRotationMatrix(te)),Kt.set(1,1,1),c&&Kt.set(c[3*e+0],c[3*e+1],c[3*e+2]),h&&Kt.multiplyScalar(h[e]);for(let t=0,s=g.length;t<s;t++){const s=g[t];ne.copy(Xt),p&&(s.updateMatrixWorld(),se.copy(Jt).applyMatrix4(s.matrixWorld),this.ellipsoid.getPositionToCartographic(se,re),this.ellipsoid.getEastNorthUpFrame(re.lat,re.lon,ie),ne.setFromRotationMatrix(ie)),te.compose(Jt,ne,Kt).multiply(u);const i=y[t];ee.multiplyMatrices(te,i.matrixWorld),s.setMatrixAt(e,ee)}}t.scene.clear(),t.scene.add(...g),t.batchTable=i,t.featureTable=e,t.scene.batchTable=i,t.scene.featureTable=e,a(t)}),o)}))}))}}class oe extends vt{parse(t){const e=new DataView(t),s=wt(e);console.assert("cmpt"===s,'CMPTLoader: The magic bytes equal "cmpt".');const i=e.getUint32(4,!0);console.assert(1===i,'CMPTLoader: The version listed in the header is "1".');const n=e.getUint32(8,!0);console.assert(n===t.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const r=e.getUint32(12,!0),a=[];let o=16;for(let l=0;l<r;l++){const e=new DataView(t,o,12),s=wt(e),i=e.getUint32(4,!0),n=e.getUint32(8,!0),r=new Uint8Array(t,o,n);a.push({type:s,buffer:r,version:i}),o+=n}return{version:i,tiles:a}}}class le extends oe{constructor(s=e){super(),this.manager=s,this.adjustmentTransform=new t,this.ellipsoid=Zt.clone()}parse(t){const e=super.parse(t),{manager:s,ellipsoid:i,adjustmentTransform:n}=this,r=[];for(const a in e.tiles){const{type:t,buffer:o}=e.tiles[a];switch(t){case"b3dm":{const t=o.slice(),e=new Ct(s);e.workingPath=this.workingPath,e.fetchOptions=this.fetchOptions,e.adjustmentTransform.copy(n);const i=e.parse(t.buffer);r.push(i);break}case"pnts":{const t=o.slice(),e=new Ut(s);e.workingPath=this.workingPath,e.fetchOptions=this.fetchOptions;const i=e.parse(t.buffer);r.push(i);break}case"i3dm":{const t=o.slice(),e=new ae(s);e.workingPath=this.workingPath,e.fetchOptions=this.fetchOptions,e.ellipsoid.copy(i),e.adjustmentTransform.copy(n);const a=e.parse(t.buffer);r.push(a);break}}}return Promise.all(r).then((t=>{const e=new y;return t.forEach((t=>{e.add(t.scene)})),{tiles:t,scene:e}}))}}const ce=new t;class he extends y{constructor(t){super(),this.name="TilesRenderer.TilesGroup",this.tilesRenderer=t}raycast(t,e){return!this.tilesRenderer.optimizeRaycast||(this.tilesRenderer.raycast(t,e),!1)}updateMatrixWorld(t){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||t){null===this.parent?ce.copy(this.matrix):ce.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const t=ce.elements,e=this.matrixWorld.elements;let s=!1;for(let i=0;i<16;i++){const n=t[i],r=e[i];if(Math.abs(n-r)>Number.EPSILON){s=!0;break}}if(s){this.matrixWorld.copy(ce);const t=this.children;for(let e=0,s=t.length;e<s;e++)t[e].updateMatrixWorld()}}}}const de=new t,ue=new m,pe=new r,me=[];function fe(t,e){return t.distance-e.distance}function ge(t,e,s,i){const{scene:n}=t.cached;s.invokeOnePlugin((s=>s.raycastTile&&s.raycastTile(t,n,e,i)))||e.intersectObject(n,!0,i)}function ye(t,e,s,i=null){const{group:n,activeTiles:r}=t;t.ensureChildrenArePreprocessed(e),null===i&&(i=ue,de.copy(n.matrixWorld).invert(),i.copy(s.ray).applyMatrix4(de));const a=[],o=e.children;for(let h=0,d=o.length;h<d;h++){const t=o[h];if(!t.__used)continue;null!==t.cached.boundingVolume.intersectRay(i,pe)&&(pe.applyMatrix4(n.matrixWorld),a.push({distance:pe.distanceToSquared(s.ray.origin),tile:t}))}a.sort(fe);let l=null,c=1/0;if(r.has(e)){const i=function(t,e,s){ge(t,e,s,me),me.sort(fe);const i=me[0]||null;return me.length=0,i}(e,s,t);i&&(l=i,c=i.distance*i.distance)}for(let h=0,d=a.length;h<d;h++){const e=a[h],n=e.distance,r=e.tile;if(n>c)break;const o=ye(t,r,s,i);if(o){const t=o.distance*o.distance;t<c&&(l=o,c=t)}}return l}function _e(t,e,s,i,n=null){const{group:r,activeTiles:a}=t,{boundingVolume:o}=e.cached;if(t.ensureChildrenArePreprocessed(e),null===n&&(n=ue,de.copy(r.matrixWorld).invert(),n.copy(s.ray).applyMatrix4(de)),!e.__used||!o.intersectsRay(n))return;a.has(e)&&ge(e,s,t,i);const l=e.children;for(let c=0,h=l.length;c<h;c++)_e(t,l[c],s,i,n)}const be=new r,Te=new r,xe=new r,ve=new m;class we{constructor(e=new b,s=new t){this.box=e.clone(),this.transform=s.clone(),this.inverseTransform=new t,this.points=new Array(8).fill().map((()=>new r)),this.planes=new Array(6).fill().map((()=>new _))}clampPoint(t,e){return e.copy(t).applyMatrix4(this.inverseTransform).clamp(this.box.min,this.box.max).applyMatrix4(this.transform)}distanceToPoint(t){return this.clampPoint(t,xe).distanceTo(t)}containsPoint(t){return xe.copy(t).applyMatrix4(this.inverseTransform),this.box.containsPoint(xe)}intersectsRay(t){return ve.copy(t).applyMatrix4(this.inverseTransform),ve.intersectsBox(this.box)}intersectRay(t,e){return ve.copy(t).applyMatrix4(this.inverseTransform),ve.intersectBox(this.box,e)?(e.applyMatrix4(this.transform),e):null}update(){const{points:t,inverseTransform:e,transform:s,box:i}=this;e.copy(s).invert();const{min:n,max:r}=i;let a=0;for(let o=-1;o<=1;o+=2)for(let e=-1;e<=1;e+=2)for(let i=-1;i<=1;i+=2)t[a].set(o<0?n.x:r.x,e<0?n.y:r.y,i<0?n.z:r.z).applyMatrix4(s),a++;this.updatePlanes()}updatePlanes(){be.copy(this.box.min).applyMatrix4(this.transform),Te.copy(this.box.max).applyMatrix4(this.transform),xe.set(0,0,1).transformDirection(this.transform),this.planes[0].setFromNormalAndCoplanarPoint(xe,be),this.planes[1].setFromNormalAndCoplanarPoint(xe,Te).negate(),xe.set(0,1,0).transformDirection(this.transform),this.planes[2].setFromNormalAndCoplanarPoint(xe,be),this.planes[3].setFromNormalAndCoplanarPoint(xe,Te).negate(),xe.set(1,0,0).transformDirection(this.transform),this.planes[4].setFromNormalAndCoplanarPoint(xe,be),this.planes[5].setFromNormalAndCoplanarPoint(xe,Te).negate()}intersectsFrustum(t){const{points:e}=this,{planes:s}=t;for(let i=0;i<6;i++){const t=s[i];let n=-1/0;for(let s=0;s<8;s++){const i=e[s],r=t.distanceToPoint(i);n=n<r?r:n}if(n<0)return!1}for(let i=0;i<6;i++){const e=this.planes[i];let s=-1/0;for(let i=0;i<8;i++){const n=t.points[i],r=e.distanceToPoint(n);s=s<r?r:s}if(s<0)return!1}return!0}}const Pe=Math.PI,Ce=Pe/2,Me=new r,Se=new r,Ae=new r,Ee=new t;let De=0;const Ue=[];function Re(t=!1){return t?(Ue[De]||(Ue[De]=new r),De++,Ue[De-1]):new r}function Le(){De=0}class ke extends qt{constructor(t,e,s,i=-Ce,n=Ce,r=0,a=2*Pe,o=0,l=0){super(t,e,s),this.latStart=i,this.latEnd=n,this.lonStart=r,this.lonEnd=a,this.heightStart=o,this.heightEnd=l}_getPoints(t=!1){const{latStart:e,latEnd:s,lonStart:i,lonEnd:r,heightStart:a,heightEnd:o}=this,l=n.mapLinear(.5,0,1,e,s),c=n.mapLinear(.5,0,1,i,r),h=Math.floor(i/Ce)*Ce,d=[[-Pe/2,0],[Pe/2,0],[0,h],[0,h+Pe/2],[0,h+Pe],[0,h+3*Pe/2],[e,r],[s,r],[e,i],[s,i],[0,i],[0,r],[l,c],[e,c],[s,c],[l,i],[l,r]],u=[],p=d.length;for(let m=0;m<=1;m++){const l=n.mapLinear(m,0,1,a,o);for(let n=0,a=p;n<a;n++){const[a,o]=d[n];if(a>=e&&a<=s&&o>=i&&o<=r){const e=Re(t);u.push(e),this.getCartographicToPosition(a,o,l,e)}}}return u}getBoundingBox(t,e){Le();const{latStart:s,latEnd:i,lonStart:r,lonEnd:a}=this;if(i-s<Pe/2){const t=n.mapLinear(.5,0,1,s,i),o=n.mapLinear(.5,0,1,r,a);this.getCartographicToNormal(t,o,Ae),Se.set(0,0,1),Me.crossVectors(Se,Ae),Se.crossVectors(Me,Ae),e.makeBasis(Me,Se,Ae)}else Me.set(1,0,0),Se.set(0,1,0),Ae.set(0,0,1),e.makeBasis(Me,Se,Ae);Ee.copy(e).invert();const o=this._getPoints(!0);for(let n=0,l=o.length;n<l;n++)o[n].applyMatrix4(Ee);t.makeEmpty(),t.setFromPoints(o)}getBoundingSphere(t,e){Le();const s=this._getPoints(!0);t.makeEmpty(),t.setFromPoints(s,e)}}const Fe=new r,Ie=new r,Oe=new r,ze=new r,Ve=new r;class Ne{constructor(){this.sphere=null,this.obb=null,this.region=null,this.regionObb=null}intersectsRay(t){const e=this.sphere,s=this.obb||this.regionObb;return!(e&&!t.intersectsSphere(e))&&!(s&&!s.intersectsRay(t))}intersectRay(t,e=null){const s=this.sphere,i=this.obb||this.regionObb;let n=-1/0,r=-1/0;s&&t.intersectSphere(s,ze)&&(n=s.containsPoint(t.origin)?0:t.origin.distanceToSquared(ze)),i&&i.intersectRay(t,Ve)&&(r=i.containsPoint(t.origin)?0:t.origin.distanceToSquared(Ve));const a=Math.max(n,r);return a===-1/0?null:(t.at(Math.sqrt(a),e),e)}distanceToPoint(t){const e=this.sphere,s=this.obb||this.regionObb;let i=-1/0,n=-1/0;return e&&(i=Math.max(e.distanceToPoint(t),0)),s&&(n=s.distanceToPoint(t)),i>n?i:n}intersectsFrustum(t){const e=this.obb||this.regionObb,s=this.sphere;return!(s&&!t.intersectsSphere(s))&&(!(e&&!e.intersectsFrustum(t))&&Boolean(s||e))}getOBB(t,e){const s=this.obb||this.regionObb;s?(t.copy(s.box),e.copy(s.transform)):(this.getAABB(t),e.identity())}getAABB(t){if(this.sphere)this.sphere.getBoundingBox(t);else{const e=this.obb||this.regionObb;t.copy(e.box).applyMatrix4(e.transform)}}getSphere(t){if(this.sphere)t.copy(this.sphere);else if(this.region)this.region.getBoundingSphere(t);else{const e=this.obb||this.regionObb;e.box.getBoundingSphere(t),t.applyMatrix4(e.transform)}}setObbData(t,e){const s=new we;Fe.set(t[3],t[4],t[5]),Ie.set(t[6],t[7],t[8]),Oe.set(t[9],t[10],t[11]);const i=Fe.length(),n=Ie.length(),r=Oe.length();Fe.normalize(),Ie.normalize(),Oe.normalize(),0===i&&Fe.crossVectors(Ie,Oe),0===n&&Ie.crossVectors(Fe,Oe),0===r&&Oe.crossVectors(Fe,Ie),s.transform.set(Fe.x,Ie.x,Oe.x,t[0],Fe.y,Ie.y,Oe.y,t[1],Fe.z,Ie.z,Oe.z,t[2],0,0,0,1).premultiply(e),s.box.min.set(-i,-n,-r),s.box.max.set(i,n,r),s.update(),this.obb=s}setSphereData(t,e,s,i,n){const r=new u;r.center.set(t,e,s),r.radius=i,r.applyMatrix4(n),this.sphere=r}setRegionData(t,e,s,i,n,r,a){const o=new ke(...t.radius,s,n,e,i,r,a),l=new we;o.getBoundingBox(l.box,l.transform),l.update(),this.region=o,this.regionObb=l}}const Be=new T;class We extends x{constructor(){super(),this.points=Array(8).fill().map((()=>new r))}setFromProjectionMatrix(t,e){super.setFromProjectionMatrix(t,e),this.calculateFrustumPoints()}calculateFrustumPoints(){const{planes:t,points:e}=this;[[t[0],t[3],t[4]],[t[1],t[3],t[4]],[t[0],t[2],t[4]],[t[1],t[2],t[4]],[t[0],t[3],t[5]],[t[1],t[3],t[5]],[t[0],t[2],t[5]],[t[1],t[2],t[5]]].forEach(((t,s)=>{!function(t,e,s,i){const n=Be.set(t.normal.x,t.normal.y,t.normal.z,e.normal.x,e.normal.y,e.normal.z,s.normal.x,s.normal.y,s.normal.z);i.set(-t.constant,-e.constant,-s.constant),i.applyMatrix3(n.invert())}(t[0],t[1],t[2],e[s])}))}}const je=new t,Ge=new p,He=Symbol("INITIAL_FRUSTUM_CULLED"),qe=new t,Ze=new t,$e=new r,Qe=new i,Ye=new r(1,0,0),Je=new r(0,1,0);function Xe(t,e){t.traverse((t=>{t.frustumCulled=t[He]&&e}))}class Ke extends ft{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(t){this._autoDisableRendererCulling!==t&&(super._autoDisableRendererCulling=t,this.forEachLoadedModel((e=>{Xe(e,!t)})))}constructor(...e){super(...e),this.group=new he(this),this.ellipsoid=Zt.clone(),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this.optimizeRaycast=!0,this._upRotationMatrix=new t,this.lruCache.computeMemoryUsageCallback=t=>t.cached.bytesUsed??null,this._autoDisableRendererCulling=!0;const s=new P;s.setURLModifier((t=>this.preprocessURL?this.preprocessURL(t):t)),this.manager=s,this._listeners={}}addEventListener(...t){C.prototype.addEventListener.call(this,...t)}hasEventListener(...t){C.prototype.hasEventListener.call(this,...t)}removeEventListener(...t){C.prototype.removeEventListener.call(this,...t)}dispatchEvent(...t){C.prototype.dispatchEvent.call(this,...t)}getBoundingBox(t){if(!this.root)return!1;const e=this.root.cached.boundingVolume;return!!e&&(e.getAABB(t),!0)}getOrientedBoundingBox(t,e){if(!this.root)return!1;const s=this.root.cached.boundingVolume;return!!s&&(s.getOBB(t,e),!0)}getBoundingSphere(t){if(!this.root)return!1;const e=this.root.cached.boundingVolume;return!!e&&(e.getSphere(t),!0)}forEachLoadedModel(t){this.traverse((e=>{const s=e.cached.scene;s&&t(s,e)}))}raycast(t,e){if(this.root)if(t.firstHitOnly){const s=ye(this,this.root,t);s&&e.push(s)}else _e(this,this.root,t,e)}hasCamera(t){return this.cameraMap.has(t)}setCamera(t){const e=this.cameras,s=this.cameraMap;return!s.has(t)&&(s.set(t,new i),e.push(t),this.dispatchEvent({type:"add-camera",camera:t}),!0)}setResolution(t,e,s){const i=this.cameraMap;if(!i.has(t))return!1;const n=e.isVector2?e.x:e,r=e.isVector2?e.y:s,a=i.get(t);return a.width===n&&a.height===r||(a.set(n,r),this.dispatchEvent({type:"camera-resolution-change"})),!0}setResolutionFromRenderer(t,e){return e.getSize(Qe).multiplyScalar(e.getPixelRatio()),this.setResolution(t,Qe.x,Qe.y)}deleteCamera(t){const e=this.cameras,s=this.cameraMap;if(s.has(t)){const i=e.indexOf(t);return e.splice(i,1),s.delete(t),this.dispatchEvent({type:"delete-camera",camera:t}),!0}return!1}preprocessTileSet(t,e,s){super.preprocessTileSet(t,e,s),queueMicrotask((()=>{this.dispatchEvent({type:"load-tile-set",tileSet:t,url:e})}))}loadRootTileSet(...t){return super.loadRootTileSet(...t).then((()=>{const{asset:t,extensions:e={}}=this.rootTileSet;switch((t&&t.gltfUpAxis||"y").toLowerCase()){case"x":this._upRotationMatrix.makeRotationAxis(Je,-Math.PI/2);break;case"y":this._upRotationMatrix.makeRotationAxis(Ye,Math.PI/2)}if("3DTILES_ellipsoid"in e){const t=e["3DTILES_ellipsoid"],{ellipsoid:s}=this;s.name=t.body,t.radii?s.radius.set(...t.radii):s.radius.set(1,1,1)}this.dispatchEvent({type:"load-content"})}))}update(){let t=null;if(this.invokeAllPlugins((e=>{if(e.doTilesNeedUpdate){const s=e.doTilesNeedUpdate();t=null===t?s:t||s}})),!1===t)return this.dispatchEvent({type:"update-before"}),void this.dispatchEvent({type:"update-after"});this.dispatchEvent({type:"update-before"});const e=this.group,s=this.cameras,i=this.cameraMap,n=this.cameraInfo;if(0!==s.length){for(;n.length>s.length;)n.pop();for(;n.length<s.length;)n.push({frustum:new We,isOrthographic:!1,sseDenominator:-1,position:new r,invScale:-1,pixelSize:0});Ze.copy(e.matrixWorld).invert(),$e.setFromMatrixScale(Ze),Math.abs(Math.max($e.x-$e.y,$e.x-$e.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let t=0,r=n.length;t<r;t++){const r=s[t],a=n[t],o=a.frustum,l=a.position,c=i.get(r);0!==c.width&&0!==c.height||console.warn("TilesRenderer: resolution for camera error calculation is not set.");const h=r.projectionMatrix.elements;if(a.isOrthographic=1===h[15],a.isOrthographic){const t=2/h[0],e=2/h[5];a.pixelSize=Math.max(e/c.height,t/c.width)}else a.sseDenominator=2/h[5]/c.height;qe.copy(e.matrixWorld),qe.premultiply(r.matrixWorldInverse),qe.premultiply(r.projectionMatrix),o.setFromProjectionMatrix(qe),l.set(0,0,0),l.applyMatrix4(r.matrixWorld),l.applyMatrix4(Ze)}super.update(),this.dispatchEvent({type:"update-after"})}else console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.")}preprocessNode(e,s,i=null){super.preprocessNode(e,s,i);const n=new t;if(e.transform){const t=e.transform;for(let e=0;e<16;e++)n.elements[e]=t[e]}i&&n.premultiply(i.cached.transform);const r=(new t).copy(n).invert(),a=new Ne;"sphere"in e.boundingVolume&&a.setSphereData(...e.boundingVolume.sphere,n),"box"in e.boundingVolume&&a.setObbData(e.boundingVolume.box,n),"region"in e.boundingVolume&&a.setRegionData(this.ellipsoid,...e.boundingVolume.region),e.cached={transform:n,transformInverse:r,active:!1,boundingVolume:a,metadata:null,scene:null,geometry:null,materials:null,textures:null}}async requestTileContents(...t){await super.requestTileContents(...t),this.dispatchEvent({type:"load-content"})}async parseTile(t,e,i,n,r){const a=e.cached,o=n.split(/[\\/]/g);o.pop();const l=o.join("/"),c=this.fetchOptions,h=this.manager;let d=null;const u=a.transform,p=this._upRotationMatrix,m=(wt(t)||i).toLowerCase();switch(m){case"b3dm":{const e=new Ct(h);e.workingPath=l,e.fetchOptions=c,e.adjustmentTransform.copy(p),d=e.parse(t);break}case"pnts":{const e=new Ut(h);e.workingPath=l,e.fetchOptions=c,d=e.parse(t);break}case"i3dm":{const e=new ae(h);e.workingPath=l,e.fetchOptions=c,e.adjustmentTransform.copy(p),e.ellipsoid.copy(this.ellipsoid),d=e.parse(t);break}case"cmpt":{const e=new le(h);e.workingPath=l,e.fetchOptions=c,e.adjustmentTransform.copy(p),e.ellipsoid.copy(this.ellipsoid),d=e.parse(t).then((t=>t.scene));break}case"gltf":case"glb":{const e=h.getHandler("path.gltf")||h.getHandler("path.glb")||new s(h);e.setWithCredentials("include"===c.credentials),e.setRequestHeader(c.headers||{}),"include"===c.credentials&&"cors"===c.mode&&e.setCrossOrigin("use-credentials");let i=e.resourcePath||e.path||l;!/[\\/]$/.test(i)&&i.length&&(i+="/"),d=e.parseAsync(t,i).then((t=>{const{scene:e}=t;return e.updateMatrix(),e.matrix.multiply(p).decompose(e.position,e.quaternion,e.scale),t}));break}default:console.warn(`TilesRenderer: Content type "${m}" not supported.`),d=Promise.resolve(null)}const f=await d;let g,y;f.isObject3D?(g=f,y=null):(g=f.scene,y=f),await this.invokeAllPlugins((t=>t.processTileModel&&t.processTileModel(g,e))),g.updateMatrix(),g.matrix.premultiply(u),g.matrix.decompose(g.position,g.quaternion,g.scale),g.traverse((t=>{t[He]=t.frustumCulled})),Xe(g,!this.autoDisableRendererCulling);const _=[],b=[],T=[];if(g.traverse((t=>{if(t.geometry&&b.push(t.geometry),t.material){const e=t.material;_.push(t.material);for(const t in e){const s=e[t];s&&s.isTexture&&T.push(s)}}})),r.aborted)for(let s=0,x=T.length;s<x;s++){const t=T[s];t.image instanceof ImageBitmap&&t.image.close(),t.dispose()}else a.materials=_,a.geometry=b,a.textures=T,a.scene=g,a.metadata=y,a.bytesUsed=function(t){const{TextureUtils:e}=w;if(!e)return 0;const s=new Set;let i=0;return t.traverse((t=>{if(t.geometry&&!s.has(t.geometry)&&(i+=v(t.geometry),s.add(t.geometry)),t.material){const n=t.material;for(const t in n){const r=n[t];if(r&&r.isTexture&&!s.has(r)){const{format:t,type:n,image:a}=r,{width:o,height:l}=a,c=e.getByteLength(o,l,t,n);i+=r.generateMipmaps?4*c/3:c,s.add(r)}}}})),i}(g)}disposeTile(t){super.disposeTile(t);const e=t.cached;if(e.scene){const s=e.materials,i=e.geometry,n=e.textures,r=e.scene.parent;e.scene.traverse((t=>{t.userData.meshFeatures&&t.userData.meshFeatures.dispose(),t.userData.structuralMetadata&&t.userData.structuralMetadata.dispose()}));for(let t=0,e=i.length;t<e;t++)i[t].dispose();for(let t=0,e=s.length;t<e;t++)s[t].dispose();for(let t=0,e=n.length;t<e;t++){const e=n[t];e.image instanceof ImageBitmap&&e.image.close(),e.dispose()}r&&r.remove(e.scene),this.dispatchEvent({type:"dispose-model",scene:e.scene,tile:t}),e.scene=null,e.materials=null,e.textures=null,e.geometry=null,e.metadata=null}}setTileVisible(t,e){const s=t.cached.scene,i=this.group;e?s&&(i.add(s),s.updateMatrixWorld(!0)):s&&i.remove(s),super.setTileVisible(t,e),this.dispatchEvent({type:"tile-visibility-change",scene:s,tile:t,visible:e})}calculateError(t){const e=t.cached,s=this.cameras,i=this.cameraInfo,n=e.boundingVolume;let r=-1/0,a=1/0;for(let o=0,l=s.length;o<l;o++){const e=i[o];let s;if(e.isOrthographic){const i=e.pixelSize;s=t.geometricError/i}else{const i=n.distanceToPoint(e.position),r=e.sseDenominator;s=t.geometricError/(i*r),a=Math.min(a,i)}r=Math.max(r,s)}t.__distanceFromCamera=a,t.__error=r}tileInView(t){const e=t.cached.boundingVolume,s=this.cameraInfo;for(let i=0,n=s.length;i<n;i++){const t=s[i].frustum;if(e.intersectsFrustum(t))return!0}return!1}setLatLonToYUp(t,e){const{ellipsoid:s,group:i}=this;Ge.set(Math.PI/2,Math.PI/2,0),je.makeRotationFromEuler(Ge),s.getEastNorthUpFrame(t,e,i.matrix).multiply(je).invert().decompose(i.position,i.quaternion,i.scale),i.updateMatrixWorld(!0)}}class ts extends M{constructor(){super(new S(0,0),new es),this.renderOrder=1/0}onBeforeRender(t){const e=this.material.uniforms;t.getSize(e.resolution.value)}updateMatrixWorld(){this.matrixWorld.makeTranslation(this.position)}dispose(){this.geometry.dispose(),this.material.dispose()}}class es extends A{constructor(){super({depthWrite:!1,depthTest:!1,transparent:!0,uniforms:{resolution:{value:new i},size:{value:15},thickness:{value:2},opacity:{value:1}},vertexShader:"\n\n\t\t\t\tuniform float pixelRatio;\n\t\t\t\tuniform float size;\n\t\t\t\tuniform float thickness;\n\t\t\t\tuniform vec2 resolution;\n\t\t\t\tvarying vec2 vUv;\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvUv = uv;\n\n\t\t\t\t\tfloat aspect = resolution.x / resolution.y;\n\t\t\t\t\tvec2 offset = uv * 2.0 - vec2( 1.0 );\n\t\t\t\t\toffset.y *= aspect;\n\n\t\t\t\t\tvec4 screenPoint = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t\tscreenPoint.xy += offset * ( size + thickness ) * screenPoint.w / resolution.x;\n\n\t\t\t\t\tgl_Position = screenPoint;\n\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\n\t\t\t\tuniform float size;\n\t\t\t\tuniform float thickness;\n\t\t\t\tuniform float opacity;\n\n\t\t\t\tvarying vec2 vUv;\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tfloat ht = 0.5 * thickness;\n\t\t\t\t\tfloat planeDim = size + thickness;\n\t\t\t\t\tfloat offset = ( planeDim - ht - 2.0 ) / planeDim;\n\t\t\t\t\tfloat texelThickness = ht / planeDim;\n\n\t\t\t\t\tvec2 vec = vUv * 2.0 - vec2( 1.0 );\n\t\t\t\t\tfloat dist = abs( length( vec ) - offset );\n\t\t\t\t\tfloat fw = fwidth( dist ) * 0.5;\n\t\t\t\t\tfloat a = smoothstep( texelThickness - fw, texelThickness + fw, dist );\n\n\t\t\t\t\tgl_FragColor = vec4( 1, 1, 1, opacity * ( 1.0 - a ) );\n\n\t\t\t\t}\n\t\t\t"})}}const ss=new i,is=new i;class ns{constructor(){this.domElement=null,this.buttons=0,this.pointerType=null,this.pointerOrder=[],this.previousPositions={},this.pointerPositions={},this.startPositions={},this.pointerSetThisFrame={},this.hoverPosition=new i,this.hoverSet=!1}reset(){this.buttons=0,this.pointerType=null,this.pointerOrder=[],this.previousPositions={},this.pointerPositions={},this.startPositions={},this.pointerSetThisFrame={},this.hoverPosition=new i,this.hoverSet=!1}updateFrame(){const{previousPositions:t,pointerPositions:e}=this;for(const s in e)t[s].copy(e[s])}setHoverEvent(t){"mouse"!==t.pointerType&&"wheel"!==t.type||(this.getAdjustedPointer(t,this.hoverPosition),this.hoverSet=!0)}getLatestPoint(t){return null!==this.pointerType?(this.getCenterPoint(t),t):this.hoverSet?(t.copy(this.hoverPosition),t):null}getAdjustedPointer(t,e){const s=(this.domElement?this.domElement:t.target).getBoundingClientRect(),i=t.clientX-s.left,n=t.clientY-s.top;e.set(i,n)}addPointer(t){const e=t.pointerId,s=new i;this.getAdjustedPointer(t,s),this.pointerOrder.push(e),this.pointerPositions[e]=s,this.previousPositions[e]=s.clone(),this.startPositions[e]=s.clone(),1===this.getPointerCount()&&(this.pointerType=t.pointerType,this.buttons=t.buttons)}updatePointer(t){const e=t.pointerId;return e in this.pointerPositions&&(this.getAdjustedPointer(t,this.pointerPositions[e]),!0)}deletePointer(t){const e=t.pointerId,s=this.pointerOrder;s.splice(s.indexOf(e),1),delete this.pointerPositions[e],delete this.previousPositions[e],delete this.startPositions[e],0===this.getPointerCount.length&&(this.buttons=0,this.pointerType=null)}getPointerCount(){return this.pointerOrder.length}getCenterPoint(t,e=this.pointerPositions){const s=this.pointerOrder;if(1===this.getPointerCount()||"mouse"===this.getPointerType()){const i=s[0];return t.copy(e[i]),t}if(2===this.getPointerCount()){const s=this.pointerOrder[0],i=this.pointerOrder[1],n=e[s],r=e[i];return t.addVectors(n,r).multiplyScalar(.5),t}return null}getPreviousCenterPoint(t){return this.getCenterPoint(t,this.previousPositions)}getStartCenterPoint(t){return this.getCenterPoint(t,this.startPositions)}getMoveDistance(){return this.getCenterPoint(ss),this.getPreviousCenterPoint(is),ss.sub(is).length()}getTouchPointerDistance(t=this.pointerPositions){if(this.getPointerCount()<=1||"mouse"===this.getPointerType())return 0;const{pointerOrder:e}=this,s=e[0],i=e[1],n=t[s],r=t[i];return n.distanceTo(r)}getPreviousTouchPointerDistance(){return this.getTouchPointerDistance(this.previousPositions)}getStartTouchPointerDistance(){return this.getTouchPointerDistance(this.startPositions)}getPointerType(){return this.pointerType}isPointerTouch(){return"touch"===this.getPointerType()}getPointerButtons(){return this.buttons}isLeftClicked(){return Boolean(1&this.buttons)}isRightClicked(){return Boolean(2&this.buttons)}}const rs=new t,as=new m,os=new r;function ls(t,e,s){return s.makeTranslation(-t.x,-t.y,-t.z),rs.makeRotationFromQuaternion(e),s.premultiply(rs),rs.makeTranslation(t.x,t.y,t.z),s.premultiply(rs),s}function cs(t,e,s,i){i.x=(t-s.offsetLeft)/s.clientWidth*2-1,i.y=-(e-s.offsetTop)/s.clientHeight*2+1,i.isVector3&&(i.z=0)}function hs(t,e,s){return e.intersectRay(t,s)?s:(rs.makeScale(...e.radius).invert(),as.copy(t).applyMatrix4(rs),os.set(0,0,0),as.closestPointToPoint(os,s).normalize(),rs.makeScale(...e.radius),s.applyMatrix4(rs))}function ds(t,e,s){const{origin:i,direction:n}=t.ray;i.set(e.x,e.y,-1).unproject(s),n.set(e.x,e.y,1).unproject(s).sub(i),t.near=0,t.far=n.length(),t.camera=s,n.normalize()}const us=.05,ps=.025,ms=new t,fs=new r,gs=new r,ys=new r,_s=new r,bs=new r,Ts=new g,xs=new _,vs=new r,ws=new r,Ps=new r,Cs=new g,Ms=new i,Ss=new i,As=new i,Es=new i,Ds=new i,Us=new i,Rs={type:"change"},Ls={type:"start"},ks={type:"end"};class Fs extends C{get enabled(){return this._enabled}set enabled(t){t!==this.enabled&&(this._enabled=t,this.resetState(),this.pointerTracker.reset(),this.enabled||(this.dragInertia.set(0,0,0),this.rotationInertia.set(0,0)))}constructor(t=null,e=null,s=null,n=null){super(),this.isEnvironmentControls=!0,this.domElement=null,this.camera=null,this.scene=null,this.tilesRenderer=null,this._enabled=!0,this.cameraRadius=5,this.rotationSpeed=1,this.minAltitude=0,this.maxAltitude=.45*Math.PI,this.minDistance=10,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.zoomSpeed=1,this.adjustHeight=!0,this.enableDamping=!1,this.dampingFactor=.15,this.reorientOnDrag=!0,this.scaleZoomOrientationAtEdges=!1,this.state=0,this.pointerTracker=new ns,this.needsUpdate=!1,this.actionHeightOffset=0,this.pivotPoint=new r,this.zoomDirectionSet=!1,this.zoomPointSet=!1,this.zoomDirection=new r,this.zoomPoint=new r,this.zoomDelta=0,this.rotationInertia=new i,this.dragInertia=new r,this.pivotMesh=new ts,this.pivotMesh.raycast=()=>{},this.pivotMesh.scale.setScalar(.25),this.raycaster=new E,this.raycaster.firstHitOnly=!0,this.up=new r(0,1,0),this.clock=new D,this.fallbackPlane=new _(new r(0,1,0),0),this.useFallbackPlane=!0,this._detachCallback=null,this._upInitialized=!1,this._lastUsedState=0,this._zoomPointWasSet=!1,this._tilesOnChangeCallback=()=>this.zoomPointSet=!1,s&&this.attach(s),e&&this.setCamera(e),t&&this.setScene(t),n&&this.setTilesRenderer(n)}setScene(t){this.scene=t}setCamera(t){this.camera=t,this._upInitialized=!1,this.zoomDirectionSet=!1,this.zoomPointSet=!1,this.needsUpdate=!0,this.raycaster.camera=t,this.resetState()}setTilesRenderer(t){this.tilesRenderer&&this.tilesRenderer.removeEventListener("tile-visibility-change",this._tilesOnChangeCallback),this.tilesRenderer=t,null!==this.tilesRenderer&&(this.tilesRenderer.addEventListener("tile-visibility-change",this._tilesOnChangeCallback),null===this.scene&&this.setScene(this.tilesRenderer.group))}attach(t){if(this.domElement)throw new Error("EnvironmentControls: Controls already attached to element");this.domElement=t,this.pointerTracker.domElement=t,t.style.touchAction="none";let e=!1;const s=t=>{t.preventDefault()},i=t=>{"Shift"===t.key&&(e=!0)},n=t=>{"Shift"===t.key&&(e=!1)},r=t=>{t.preventDefault();const{camera:s,raycaster:i,domElement:n,up:r,pivotMesh:a,pointerTracker:o}=this;if(o.addPointer(t),this.needsUpdate=!0,o.isPointerTouch())if(a.visible=!1,0===o.getPointerCount())n.setPointerCapture(t.pointerId);else if(o.getPointerCount()>2)return void this.resetState();o.getCenterPoint(Ss),cs(Ss.x,Ss.y,n,Ss),ds(i,Ss,s);const l=Math.abs(i.ray.direction.dot(r));if(l<us||l<ps)return;const c=this._raycast(i);c&&(2===o.getPointerCount()||o.isRightClicked()||o.isLeftClicked()&&e?(this.setState(o.isPointerTouch()?4:2),this.pivotPoint.copy(c.point),this.pivotMesh.position.copy(c.point),this.pivotMesh.updateMatrixWorld(),this.scene.add(this.pivotMesh)):o.isLeftClicked()&&(this.setState(1),this.pivotPoint.copy(c.point),this.pivotMesh.position.copy(c.point),this.pivotMesh.updateMatrixWorld(),this.scene.add(this.pivotMesh)))};let a=!1;const o=t=>{t.preventDefault(),this.zoomDirectionSet=!1,this.zoomPointSet=!1,0!==this.state&&(this.needsUpdate=!0);const{pointerTracker:e}=this;e.setHoverEvent(t),e.updatePointer(t)&&(e.isPointerTouch()&&2===e.getPointerCount()&&(a||(a=!0,queueMicrotask((()=>{a=!1,e.getCenterPoint(Ds);const t=e.getStartTouchPointerDistance(),s=e.getTouchPointerDistance(),i=s-t;if(0===this.state||4===this.state){e.getCenterPoint(Ds),e.getStartCenterPoint(Us);const t=2*window.devicePixelRatio,s=Ds.distanceTo(Us);(Math.abs(i)>t||s>t)&&(Math.abs(i)>s?(this.setState(3),this.zoomDirectionSet=!1):this.setState(2))}if(3===this.state){const t=e.getPreviousTouchPointerDistance();this.zoomDelta+=s-t}else 2===this.state&&(this.pivotMesh.visible=this.enabled)})))),this.dispatchEvent(Rs))},l=e=>{const{pointerTracker:s}=this;s.deletePointer(e),"touch"===s.getPointerType()&&0===s.getPointerCount()&&t.releasePointerCapture(e.pointerId),this.resetState(),this.needsUpdate=!0},c=t=>{t.preventDefault();const{pointerTracker:e}=this;let s;switch(e.setHoverEvent(t),e.updatePointer(t),this.dispatchEvent(Ls),t.deltaMode){case 2:s=100*t.deltaY;break;case 1:s=16*t.deltaY;break;case 0:s=t.deltaY}const i=Math.sign(s),n=Math.log(Math.abs(s)+1);this.zoomDelta-=3*i*n,this.needsUpdate=!0,this._lastUsedState=3,this.dispatchEvent(ks)},h=t=>{const{pointerTracker:s}=this;e=!1,t.buttons!==s.getPointerButtons()&&(s.deletePointer(t),this.resetState())};t.addEventListener("contextmenu",s),t.addEventListener("keydown",i),t.addEventListener("keyup",n),t.addEventListener("pointerdown",r),t.addEventListener("pointermove",o),t.addEventListener("pointerup",l),t.addEventListener("wheel",c,{passive:!1}),t.addEventListener("pointerenter",h),this._detachCallback=()=>{t.removeEventListener("contextmenu",s),t.removeEventListener("keydown",i),t.removeEventListener("keyup",n),t.removeEventListener("pointerdown",r),t.removeEventListener("pointermove",o),t.removeEventListener("pointerup",l),t.removeEventListener("wheel",c),t.removeEventListener("pointerenter",h)}}getUpDirection(t,e){e.copy(this.up)}getCameraUpDirection(t){this.getUpDirection(this.camera.position,t)}getPivotPoint(t){let e=null;3===this._lastUsedState?this._zoomPointWasSet&&(e=t.copy(this.zoomPoint)):2!==this._lastUsedState&&1!==this._lastUsedState||(e=t.copy(this.pivotPoint));const{camera:s,raycaster:i}=this;null!==e&&(gs.copy(e).project(s),(gs.x<-1||gs.x>1||gs.y<-1||gs.y>1)&&(e=null)),ds(i,{x:0,y:0},s);const n=this._raycast(i);return n&&(null===e||n.distance<e.distanceTo(i.ray.origin))&&(e=t.copy(n.point)),e}detach(){this.domElement=null,this._detachCallback&&(this._detachCallback(),this._detachCallback=null,this.pointerTracker.reset())}resetState(){0!==this.state&&this.dispatchEvent(ks),this.state=0,this.pivotMesh.removeFromParent(),this.pivotMesh.visible=this.enabled,this.actionHeightOffset=0}setState(t=this.state,e=!0){this.state!==t&&(0===this.state&&e&&this.dispatchEvent(Ls),this.pivotMesh.visible=this.enabled,this.dragInertia.set(0,0,0),this.rotationInertia.set(0,0),this.state=t,0!==t&&4!==t&&(this._lastUsedState=t))}update(t=Math.min(this.clock.getDelta(),.064)){if(!this.enabled||!this.camera||0===t)return;const{camera:e,cameraRadius:s,pivotPoint:i,up:n,state:r,adjustHeight:a}=this;e.updateMatrixWorld(),this.getCameraUpDirection(vs),this._upInitialized||(this._upInitialized=!0,this.up.copy(vs));const o=this._inertiaNeedsUpdate();if(this.needsUpdate||o){const e=this.zoomDelta;3!==r&&0===e||(this._updateZoom(),this.rotationInertia.set(0,0),this.dragInertia.set(0,0,0)),this._updatePosition(t),this._updateRotation(t),(0!==r||0!==e||o)&&this.dispatchEvent(Rs),this.needsUpdate=!1}o&&this._updateInertiaDamping(t);const l=e.isOrthographicCamera?null:a&&this._getPointBelowCamera()||null,c=e.isOrthographicCamera?i:l&&l.point||null;if(this.getCameraUpDirection(vs),this._setFrame(vs,c),(1===this.state||2===this.state)&&0!==this.actionHeightOffset){const{actionHeightOffset:t}=this;e.position.addScaledVector(n,-t),i.addScaledVector(n,-t),l&&(l.distance-=t)}if(this.actionHeightOffset=0,l){const t=l.distance;if(t<s){const r=s-t;e.position.addScaledVector(n,r),i.addScaledVector(n,r),this.actionHeightOffset=r}}this.pointerTracker.updateFrame()}adjustCamera(t){const{adjustHeight:e,cameraRadius:s}=this;if(t.isPerspectiveCamera){this.getUpDirection(t.position,vs);const i=e&&this._getPointBelowCamera(t.position,vs)||null;if(i){const e=i.distance;e<s&&t.position.addScaledVector(vs,s-e)}}}dispose(){this.detach()}_updateInertiaDamping(t){const{rotationInertia:e,dragInertia:s,enableDamping:i,dampingFactor:n}=this,r=Math.pow(2,-t/n);e.multiplyScalar(r),(e.lengthSq()<1e-4||!i)&&e.set(0,0),s.multiplyScalar(r),(s.lengthSq()<.01||!i)&&s.set(0,0,0)}_inertiaNeedsUpdate(){const{rotationInertia:t,dragInertia:e}=this;return 0!==t.lengthSq()||0!==e.lengthSq()}_updateZoom(){const{zoomPoint:t,zoomDirection:e,camera:s,minDistance:i,maxDistance:n,pointerTracker:r,domElement:a,minZoom:o,maxZoom:l,zoomSpeed:c}=this;let h=this.zoomDelta;if(this.zoomDelta=0,r.getLatestPoint(Ss))if(s.isOrthographicCamera){this._updateZoomDirection();const t=this.zoomPointSet||this._updateZoomPoint();ws.unproject(s);const e=Math.pow(.95,Math.abs(.05*h));let i=h>0?1/Math.abs(e):e;i*=c,i>1?l<s.zoom*i&&(i=1):o>s.zoom*i&&(i=1),s.zoom*=i,s.updateProjectionMatrix(),t&&(cs(Ss.x,Ss.y,a,Ps),Ps.unproject(s),s.position.sub(Ps).add(ws),s.updateMatrixWorld())}else{this._updateZoomDirection();const r=gs.copy(e);if(this.zoomPointSet||this._updateZoomPoint()){const r=t.distanceTo(s.position);if(h<0){const t=Math.min(0,r-n);h=h*r*c*.0025,h=Math.max(h,t)}else{const t=Math.max(0,r-i);h=h*Math.max(r-i,0)*c*.0025,h=Math.min(h,t)}s.position.addScaledVector(e,h),s.updateMatrixWorld()}else{const t=this._getPointBelowCamera();if(t){const e=t.distance;r.set(0,0,-1).transformDirection(s.matrixWorld),s.position.addScaledVector(r,h*e*.01),s.updateMatrixWorld()}}}}_updateZoomDirection(){if(this.zoomDirectionSet)return;const{domElement:t,raycaster:e,camera:s,zoomDirection:i,pointerTracker:n}=this;n.getLatestPoint(Ss),cs(Ss.x,Ss.y,t,ws),ds(e,ws,s),i.copy(e.ray.direction).normalize(),this.zoomDirectionSet=!0}_updateZoomPoint(){const{camera:t,zoomDirectionSet:e,zoomDirection:s,raycaster:i,zoomPoint:n,pointerTracker:r,domElement:a}=this;if(this._zoomPointWasSet=!1,!e)return!1;t.isOrthographicCamera&&r.getLatestPoint(Ms)?(cs(Ms.x,Ms.y,a,Ms),ds(i,Ms,t)):(i.ray.origin.copy(t.position),i.ray.direction.copy(s),i.near=0,i.far=1/0);const o=this._raycast(i);return!!o&&(n.copy(o.point),this.zoomPointSet=!0,this._zoomPointWasSet=!0,!0)}_getPointBelowCamera(t=this.camera.position,e=this.up){const{raycaster:s}=this;s.ray.direction.copy(e).multiplyScalar(-1),s.ray.origin.copy(t).addScaledVector(e,1e5),s.near=0,s.far=1/0;const i=this._raycast(s);return i&&(i.distance-=1e5),i}_updatePosition(t){const{raycaster:e,camera:s,pivotPoint:i,up:n,pointerTracker:r,domElement:a,state:o,dragInertia:l,enableDamping:c}=this;if(1===o){if(r.getCenterPoint(Ss),cs(Ss.x,Ss.y,a,Ss),xs.setFromNormalAndCoplanarPoint(n,i),ds(e,Ss,s),Math.abs(e.ray.direction.dot(n))<us){const t=Math.acos(us);bs.crossVectors(e.ray.direction,n).normalize(),e.ray.direction.copy(n).applyAxisAngle(bs,t).multiplyScalar(-1)}if(this.getUpDirection(i,vs),Math.abs(e.ray.direction.dot(vs))<ps){const t=Math.acos(ps);bs.crossVectors(e.ray.direction,vs).normalize(),e.ray.direction.copy(vs).applyAxisAngle(bs,t).multiplyScalar(-1)}e.ray.intersectPlane(xs,gs)&&(fs.subVectors(i,gs),s.position.add(fs),s.updateMatrixWorld(),fs.multiplyScalar(1/t),r.getMoveDistance()/t<2*window.devicePixelRatio?l.lerp(fs,.5):l.copy(fs))}else c&&(s.position.addScaledVector(l,t),s.updateMatrixWorld())}_updateRotation(t){const{pivotPoint:e,pointerTracker:s,domElement:i,state:n,rotationInertia:r,enableDamping:a}=this;2===n?(s.getCenterPoint(Ss),s.getPreviousCenterPoint(As),Es.subVectors(Ss,As).multiplyScalar(2*Math.PI/i.clientHeight),this._applyRotation(Es.x,Es.y,e),Es.multiplyScalar(1/t),s.getMoveDistance()/t<2*window.devicePixelRatio?r.lerp(Es,.5):r.copy(Es)):a&&this._applyRotation(r.x*t,r.y*t,e)}_applyRotation(t,e,s){if(0===t&&0===e)return;const{camera:i,minAltitude:n,maxAltitude:r,rotationSpeed:a}=this,o=-t*a;let l=e*a;ys.set(0,0,1).transformDirection(i.matrixWorld),this.getUpDirection(s,vs),gs.crossVectors(vs,ys).normalize(),_s.set(1,0,0).transformDirection(i.matrixWorld).normalize();const c=Math.sign(gs.dot(_s))*vs.angleTo(ys);l>0?(l=Math.min(c-n-.01,l),l=Math.max(0,l)):(l=Math.max(c-r,l),l=Math.min(0,l)),Ts.setFromAxisAngle(vs,o),ls(s,Ts,ms),i.matrixWorld.premultiply(ms),bs.set(-1,0,0).transformDirection(i.matrixWorld),Ts.setFromAxisAngle(bs,l),ls(s,Ts,ms),i.matrixWorld.premultiply(ms),i.matrixWorld.decompose(i.position,i.quaternion,gs)}_setFrame(t,e){const{up:s,camera:i,state:r,zoomPoint:a,zoomDirectionSet:o,zoomPointSet:l,reorientOnDrag:c,scaleZoomOrientationAtEdges:h}=this;i.updateMatrixWorld(),Ts.setFromUnitVectors(s,t);const d=r;if(o&&(l||this._updateZoomPoint())){if(this.getUpDirection(a,gs),h){let t=Math.max(gs.dot(s)-.6,0)/.4;t=n.mapLinear(t,0,.5,0,1),t=Math.min(t,1),i.isOrthographicCamera&&(t*=.1),Ts.slerp(Cs,1-t)}ls(a,Ts,ms),i.matrixWorld.premultiply(ms),i.matrixWorld.decompose(i.position,i.quaternion,gs),this.zoomDirectionSet=!1,this._updateZoomDirection()}else 1===d&&c&&e&&(ls(e,Ts,ms),i.matrixWorld.premultiply(ms),i.matrixWorld.decompose(i.position,i.quaternion,gs));s.copy(t),i.updateMatrixWorld()}_raycast(t){const{scene:e,useFallbackPlane:s,fallbackPlane:i}=this,n=t.intersectObject(e)[0]||null;if(n)return n;if(s){const e=i;if(t.ray.intersectPlane(e,gs)){return{point:gs.clone(),distance:t.ray.origin.distanceTo(gs)}}}return null}}const Is=new t,Os=new t,zs=new r,Vs=new r,Ns=new r,Bs=new r,Ws=new r,js=new r,Gs=new r,Hs=new g,qs=new r,Zs=new r,$s={},Qs=new m,Ys=new qt,Js=new i;class Xs extends Fs{get ellipsoid(){return this.tilesRenderer?this.tilesRenderer.ellipsoid:null}get tilesGroup(){return this.tilesRenderer?this.tilesRenderer.group:null}constructor(t=null,e=null,s=null,i=null){super(t,e,s),this.isGlobeControls=!0,this._dragMode=0,this._rotationMode=0,this.maxZoom=.01,this.nearMargin=.25,this.farMargin=0,this.useFallbackPlane=!1,this.reorientOnDrag=!1,this.dragQuaternion=new g,this.setTilesRenderer(i)}setScene(t){null===t&&null!==this.tilesRenderer?super.setScene(this.tilesRenderer.group):super.setScene(t)}getPivotPoint(t){const{camera:e,tilesGroup:s,ellipsoid:i}=this;return Bs.set(0,0,-1).transformDirection(e.matrixWorld),Is.copy(s.matrixWorld).invert(),Qs.origin.copy(e.position),Qs.direction.copy(Bs),Qs.applyMatrix4(Is),hs(Qs,i,Vs),Vs.applyMatrix4(s.matrixWorld),(null===super.getPivotPoint(t)||t.distanceTo(Qs.origin)>Vs.distanceTo(Qs.origin))&&t.copy(Vs),t}getVectorToCenter(t){const{tilesGroup:e,camera:s}=this;return t.setFromMatrixPosition(e.matrixWorld).sub(s.position)}getDistanceToCenter(){return this.getVectorToCenter(Vs).length()}getUpDirection(t,e){const{tilesGroup:s,ellipsoid:i}=this;Is.copy(s.matrixWorld).invert(),Vs.copy(t).applyMatrix4(Is),i.getPositionToNormal(Vs,e),e.transformDirection(s.matrixWorld)}getCameraUpDirection(t){const{tilesGroup:e,ellipsoid:s,camera:i}=this;i.isOrthographicCamera?(this._getVirtualOrthoCameraPosition(Vs),Is.copy(e.matrixWorld).invert(),Vs.applyMatrix4(Is),s.getPositionToNormal(Vs,t),t.transformDirection(e.matrixWorld)):this.getUpDirection(i.position,t)}update(t=Math.min(this.clock.getDelta(),.064)){if(!this.enabled||!this.tilesGroup||!this.camera||0===t)return;const{camera:e,pivotMesh:s}=this;this._isNearControls()?this.scaleZoomOrientationAtEdges=this.zoomDelta<0:(0!==this.state&&1!==this._dragMode&&1!==this._rotationMode&&(s.visible=!1),this.scaleZoomOrientationAtEdges=!1),super.update(t),this.adjustCamera(e)}adjustCamera(t){super.adjustCamera(t);const{tilesGroup:e,ellipsoid:s,nearMargin:i,farMargin:r}=this,a=Math.max(...s.radius);if(t.isPerspectiveCamera){const o=Vs.setFromMatrixPosition(e.matrixWorld).sub(t.position).length(),l=i*a,c=n.clamp((o-a)/l,0,1),h=n.lerp(1,1e3,c);t.near=Math.max(h,o-a-l);const d=Is.copy(e.matrixWorld).invert();zs.copy(t.position).applyMatrix4(d),s.getPositionToCartographic(zs,$s);const u=Math.max(s.getPositionElevation(zs),400),p=s.calculateHorizonDistance($s.lat,u);t.far=2.5*p+.1+a*r,t.updateProjectionMatrix()}else{this._getVirtualOrthoCameraPosition(t.position,t),t.updateMatrixWorld(),Is.copy(t.matrixWorld).invert(),Vs.setFromMatrixPosition(e.matrixWorld).applyMatrix4(Is);const s=-Vs.z;t.near=s-a*(1+i),t.far=s+.1+a*r,t.position.addScaledVector(Bs,t.near),t.far-=t.near,t.near=0,t.updateProjectionMatrix(),t.updateMatrixWorld()}}resetState(){super.resetState(),this._dragMode=0,this._rotationMode=0}_updatePosition(t){if(1!==this.state){const{enableDamping:e,tilesGroup:s,dragQuaternion:i,dragInertia:n,camera:r}=this;e&&(1!==i.w||0===i.x&&0===i.y&&0===i.z||(i.w=Math.min(i.w,1-1e-9)),Ns.setFromMatrixPosition(s.matrixWorld),Hs.identity().slerp(i,n.x*t),ls(Ns,Hs,Os),r.matrixWorld.premultiply(Os),r.matrixWorld.decompose(r.position,r.quaternion,Vs))}else{0===this._dragMode&&(this._dragMode=this._isNearControls()?1:-1);const{raycaster:e,camera:s,pivotPoint:i,pointerTracker:n,domElement:r,tilesGroup:a}=this,o=zs,l=js;n.getCenterPoint(Js),cs(Js.x,Js.y,r,Js),ds(e,Js,s),Is.copy(a.matrixWorld).invert(),e.ray.applyMatrix4(Is);const c=Vs.copy(i).applyMatrix4(Is).length();Ys.radius.setScalar(c),s.isPerspectiveCamera?Ys.intersectRay(e.ray,Vs)||function(t,e,s){const i=t.origin.length(),n=Math.acos(e/i);s.copy(t.origin).multiplyScalar(-1).normalize();const r=os.crossVectors(s,t.direction).normalize();s.multiplyScalar(-1).applyAxisAngle(r,-n).normalize().multiplyScalar(e)}(e.ray,c,Vs):hs(e.ray,Ys,Vs),Vs.applyMatrix4(a.matrixWorld),Ns.setFromMatrixPosition(a.matrixWorld),o.subVectors(i,Ns).normalize(),l.subVectors(Vs,Ns).normalize(),Hs.setFromUnitVectors(l,o),ls(Ns,Hs,Os),s.matrixWorld.premultiply(Os),s.matrixWorld.decompose(s.position,s.quaternion,Vs);const{dragInertia:h,dragQuaternion:d}=this;n.getMoveDistance()/t<2*window.devicePixelRatio?(d.slerp(Hs,.5),h.set(1/t,0,0)):(d.copy(Hs),h.set(1/t,0,0))}this._alignCameraUp(this.up)}_updateRotation(...t){1===this._rotationMode||this._isNearControls()?(this._rotationMode=1,super._updateRotation(...t)):(this.pivotMesh.visible=!1,this._rotationMode=-1),this._alignCameraUp(this.up)}_updateZoom(){const{zoomDelta:t,ellipsoid:e,zoomSpeed:s,zoomPoint:i,camera:r,maxZoom:a}=this,o=n.clamp(n.mapLinear(Math.abs(t),0,20,0,1),0,1);if(this._isNearControls()||t>0){if(this._updateZoomDirection(),t<0&&(this.zoomPointSet||this._updateZoomPoint())){Bs.set(0,0,-1).transformDirection(r.matrixWorld).normalize(),Zs.copy(this.up).multiplyScalar(-1),this.getUpDirection(i,qs);const t=n.clamp(n.mapLinear(-qs.dot(Zs),1,.95,0,1),0,1),e=1-Bs.dot(Zs),s=r.isOrthographicCamera?.05:1,a=n.clamp(3*o,0,1),l=Math.min(t*e*s*a,.1);Zs.lerpVectors(Bs,Zs,l).normalize(),Hs.setFromUnitVectors(Bs,Zs),ls(i,Hs,Os),r.matrixWorld.premultiply(Os),r.matrixWorld.decompose(r.position,r.quaternion,Zs),this.zoomDirection.subVectors(i,r.position).normalize()}super._updateZoom()}else if(r.isPerspectiveCamera){const i=this._getPerspectiveTransitionDistance(),r=this._getMaxPerspectiveDistance(),a=n.mapLinear(this.getDistanceToCenter(),i,r,0,1);this._tiltTowardsCenter(n.lerp(0,.4,a*o)),this._alignCameraUpToNorth(n.lerp(0,.2,a*o));const l=t*(this.getDistanceToCenter()-e.radius.x)*s*.0025,c=Math.max(l,Math.min(this.getDistanceToCenter()-r,0));this.getVectorToCenter(Vs).normalize(),this.camera.position.addScaledVector(Vs,c),this.camera.updateMatrixWorld(),this.zoomDelta=0}else{const t=this._getOrthographicTransitionZoom(),e=this._getMinOrthographicZoom(),i=n.mapLinear(r.zoom,t,e,0,1);this._tiltTowardsCenter(n.lerp(0,.4,i*o)),this._alignCameraUpToNorth(n.lerp(0,.2,i*o));const l=this.zoomDelta,c=Math.pow(.95,Math.abs(.05*l)),h=l>0?1/Math.abs(c):c,d=e/r.zoom,u=Math.max(h*s,Math.min(d,1));r.zoom=Math.min(a,r.zoom*u),r.updateProjectionMatrix(),this.zoomDelta=0,this.zoomDirectionSet=!1}}_alignCameraUpToNorth(t){const{tilesGroup:e}=this;Gs.set(0,0,1).transformDirection(e.matrixWorld),this._alignCameraUp(Gs,t)}_alignCameraUp(t,e=null){const{camera:s}=this;Bs.set(0,0,-1).transformDirection(s.matrixWorld),Ws.set(-1,0,0).transformDirection(s.matrixWorld),js.crossVectors(t,Bs),null===e&&(e=1-Math.abs(Bs.dot(t)),e=n.mapLinear(e,0,1,-.01,1),e=n.clamp(e,0,1)**2),js.lerp(Ws,1-e).normalize(),Hs.setFromUnitVectors(Ws,js),s.quaternion.premultiply(Hs),s.updateMatrixWorld()}_tiltTowardsCenter(t){const{camera:e,tilesGroup:s}=this;Bs.set(0,0,-1).transformDirection(e.matrixWorld).normalize(),Vs.setFromMatrixPosition(s.matrixWorld).sub(e.position).normalize(),Vs.lerp(Bs,1-t).normalize(),Hs.setFromUnitVectors(Bs,Vs),e.quaternion.premultiply(Hs),e.updateMatrixWorld()}_getPerspectiveTransitionDistance(){const{camera:t,ellipsoid:e}=this;if(!t.isPerspectiveCamera)throw new Error;const s=Math.max(...e.radius),i=2*Math.atan(Math.tan(n.DEG2RAD*t.fov*.5)*t.aspect),r=s/Math.tan(n.DEG2RAD*t.fov*.5),a=s/Math.tan(.5*i);return Math.max(r,a)}_getMaxPerspectiveDistance(){const{camera:t,ellipsoid:e}=this;if(!t.isPerspectiveCamera)throw new Error;const s=Math.max(...e.radius),i=2*Math.atan(Math.tan(n.DEG2RAD*t.fov*.5)*t.aspect),r=s/Math.tan(n.DEG2RAD*t.fov*.5),a=s/Math.tan(.5*i);return 2*Math.max(r,a)}_getOrthographicTransitionZoom(){const{camera:t,ellipsoid:e}=this;if(!t.isOrthographicCamera)throw new Error;const s=t.top-t.bottom,i=t.right-t.left;return 2*Math.max(s,i)/(2*Math.max(...e.radius))}_getMinOrthographicZoom(){const{camera:t,ellipsoid:e}=this;if(!t.isOrthographicCamera)throw new Error;const s=t.top-t.bottom,i=t.right-t.left;return.7*Math.min(s,i)/(2*Math.max(...e.radius))}_getVirtualOrthoCameraPosition(t,e=this.camera){const{tilesGroup:s,ellipsoid:i}=this;if(!e.isOrthographicCamera)throw new Error;Is.copy(s.matrixWorld).invert(),Qs.origin.copy(e.position),Qs.direction.set(0,0,-1).transformDirection(e.matrixWorld),Qs.applyMatrix4(Is),hs(Qs,i,zs),zs.applyMatrix4(s.matrixWorld);const n=e.top-e.bottom,r=e.right-e.left,a=Math.max(n,r)/e.zoom;Bs.set(0,0,-1).transformDirection(e.matrixWorld);const o=zs.sub(e.position).dot(Bs);t.copy(e.position).addScaledVector(Bs,o-4*a)}_isNearControls(){const{camera:t}=this;return t.isPerspectiveCamera?this.getDistanceToCenter()<this._getPerspectiveTransitionDistance():t.zoom>this._getOrthographicTransitionZoom()}}const Ks=new r,ti=new r,ei=new U,si=new r,ii=new r,ni=new r,ri=new g,ai=new g;class oi extends C{get animating(){return 0!==this._alpha&&1!==this._alpha}get camera(){return 0===this._alpha?this.perspectiveCamera:1===this._alpha?this.orthographicCamera:this.transitionCamera}get mode(){return 0===this._target?"perspective":"orthographic"}set mode(t){if(t===this.mode)return;const e=this.camera;"perspective"===t?(this._target=0,this._alpha=0):(this._target=1,this._alpha=1),this.dispatchEvent({type:"camera-change",camera:this.camera,prevCamera:e})}constructor(t=new R,e=new U){super(),this.perspectiveCamera=t,this.orthographicCamera=e,this.transitionCamera=new R,this.orthographicPositionalZoom=!0,this.orthographicOffset=50,this.fixedPoint=new r,this.duration=200,this.autoSync=!0,this.easeFunction=t=>t,this._target=0,this._alpha=0,this._clock=new D}toggle(){this._target=1===this._target?0:1,this._clock.getDelta(),this.dispatchEvent({type:"toggle"})}update(t=Math.min(this._clock.getDelta(),.064)){this.autoSync&&this.syncCameras();const{perspectiveCamera:e,orthographicCamera:s,transitionCamera:i,camera:r}=this,a=1e3*t;if(this._alpha!==this._target){const t=Math.sign(this._target-this._alpha)*a/this.duration;this._alpha=n.clamp(this._alpha+t,0,1),this.dispatchEvent({type:"change"})}const o=r;let l=null;0===this._alpha?l=e:1===this._alpha?l=s:(l=i,this._updateTransitionCamera()),o!==l&&(l===i&&this.dispatchEvent({type:"transition-start"}),this.dispatchEvent({type:"camera-change",camera:l,prevCamera:o}),o===i&&this.dispatchEvent({type:"transition-end"}))}syncCameras(){const t=this._getFromCamera(),{perspectiveCamera:e,orthographicCamera:s,transitionCamera:i,fixedPoint:r}=this;if(Ks.set(0,0,-1).transformDirection(t.matrixWorld).normalize(),t.isPerspectiveCamera){if(this.orthographicPositionalZoom)s.position.copy(e.position).addScaledVector(Ks,-this.orthographicOffset),s.rotation.copy(e.rotation),s.updateMatrixWorld();else{const t=ti.subVectors(r,s.position).dot(Ks),i=ti.subVectors(r,e.position).dot(Ks);ti.copy(e.position).addScaledVector(Ks,i),s.rotation.copy(e.rotation),s.position.copy(ti).addScaledVector(Ks,-t),s.updateMatrixWorld()}const t=Math.abs(ti.subVectors(e.position,r).dot(Ks)),i=2*Math.tan(n.DEG2RAD*e.fov*.5)*t,a=s.top-s.bottom;s.zoom=a/i,s.updateProjectionMatrix()}else{const t=Math.abs(ti.subVectors(s.position,r).dot(Ks)),i=.5*((s.top-s.bottom)/s.zoom)/Math.tan(n.DEG2RAD*e.fov*.5);e.rotation.copy(s.rotation),e.position.copy(s.position).addScaledVector(Ks,t).addScaledVector(Ks,-i),e.updateMatrixWorld(),this.orthographicPositionalZoom&&(s.position.copy(e.position).addScaledVector(Ks,-this.orthographicOffset),s.updateMatrixWorld())}i.position.copy(e.position),i.rotation.copy(e.rotation)}_getTransitionDirection(){return Math.sign(this._target-this._alpha)}_getToCamera(){const t=this._getTransitionDirection();return 0===t?0===this._target?this.perspectiveCamera:this.orthographicCamera:t>0?this.orthographicCamera:this.perspectiveCamera}_getFromCamera(){const t=this._getTransitionDirection();return 0===t?0===this._target?this.perspectiveCamera:this.orthographicCamera:t>0?this.perspectiveCamera:this.orthographicCamera}_updateTransitionCamera(){const{perspectiveCamera:t,orthographicCamera:e,transitionCamera:s,fixedPoint:i}=this,r=this.easeFunction(this._alpha);Ks.set(0,0,-1).transformDirection(e.matrixWorld).normalize(),ei.copy(e),ei.position.addScaledVector(Ks,e.near),e.far-=e.near,e.near=0,Ks.set(0,0,-1).transformDirection(t.matrixWorld).normalize();const a=Math.abs(ti.subVectors(t.position,i).dot(Ks)),o=2*Math.tan(n.DEG2RAD*t.fov*.5)*a,l=ai.slerpQuaternions(t.quaternion,ei.quaternion,r),c=n.lerp(t.fov,1,r),h=.5*o/Math.tan(n.DEG2RAD*c*.5),d=ni.copy(ei.position).sub(i).applyQuaternion(ri.copy(ei.quaternion).invert()),u=ii.copy(t.position).sub(i).applyQuaternion(ri.copy(t.quaternion).invert()),p=si.lerpVectors(u,d,r);p.z-=Math.abs(p.z)-h;const m=-(u.z-p.z),f=-(d.z-p.z),g=n.lerp(m+t.near,f+ei.near,r),y=n.lerp(m+t.far,f+ei.far,r),_=Math.max(y,0)-Math.max(g,0);s.aspect=t.aspect,s.fov=c,s.near=Math.max(g,1e-5*_),s.far=y,s.position.copy(p).applyQuaternion(l).add(i),s.quaternion.copy(l),s.updateProjectionMatrix(),s.updateMatrixWorld()}}class li{constructor(){this.creditsCount={}}_adjustAttributions(t,e){const s=this.creditsCount,i=t.split(/;/g);for(let n=0,r=i.length;n<r;n++){const t=i[n];t in s||(s[t]=0),s[t]+=e?1:-1,s[t]<=0&&delete s[t]}}addAttributions(t){this._adjustAttributions(t,!0)}removeAttributions(t){this._adjustAttributions(t,!1)}toString(){return Object.entries(this.creditsCount).sort(((t,e)=>{const s=t[1];return e[1]-s})).map((t=>t[0])).join("; ")}}function ci(t){let e=null;return ot(t,(t=>{if(t.content&&t.content.uri){const[,s]=t.content.uri.split("?");return e=new URLSearchParams(s).get("session"),!0}return!1})),e}class hi{constructor({apiToken:t,autoRefreshToken:e=!1,logoUrl:s=null,useRecommendedSettings:i=!0}){this.name="GOOGLE_CLOUD_AUTH_PLUGIN",this.apiToken=t,this.autoRefreshToken=e,this.useRecommendedSettings=i,this.logoUrl=s,this.sessionToken=null,this.tiles=null,this._onLoadCallback=null,this._visibilityChangeCallback=null,this._tokenRefreshPromise=null,this._attributionsManager=new li,this._logoAttribution={value:"",type:"image",collapsible:!1},this._attribution={value:"",type:"string",collapsible:!0}}init(t){null!=t&&(t.resetFailedTiles(),null==t.rootURL&&(t.rootURL="https://tile.googleapis.com/v1/3dtiles/root.json"),this.useRecommendedSettings&&(t.parseQueue.maxJobs=10,t.downloadQueue.maxJobs=30,t.errorTarget=40),this.tiles=t,this._onLoadCallback=({tileSet:e})=>{this.sessionToken=ci(e.root),t.removeEventListener("load-tile-set",this._onLoadCallback)},this._visibilityChangeCallback=({tile:t,visible:e})=>{const s=t.cached.metadata.asset.copyright||"";e?this._attributionsManager.addAttributions(s):this._attributionsManager.removeAttributions(s)},t.addEventListener("load-tile-set",this._onLoadCallback),t.addEventListener("tile-visibility-change",this._visibilityChangeCallback))}getAttributions(t){this.tiles.visibleTiles.size>0&&(this.logoUrl&&(this._logoAttribution.value=this.logoUrl,t.push(this._logoAttribution)),this._attribution.value=this._attributionsManager.toString(),t.push(this._attribution))}preprocessURL(t){return t=new URL(t),/^http/.test(t.protocol)&&(t.searchParams.append("key",this.apiToken),null!==this.sessionToken&&t.searchParams.append("session",this.sessionToken)),t.toString()}dispose(){const{tiles:t}=this;t.removeEventListener("load-tile-set",this._onLoadCallback),t.removeEventListener("tile-visibility-change",this._visibilityChangeCallback)}async fetchData(t,e){null!==this._tokenRefreshPromise&&(await this._tokenRefreshPromise,t=this.preprocessURL(t));const s=await fetch(t,e);return s.status>=400&&s.status<=499&&this.autoRefreshToken?(await this._refreshToken(e),fetch(this.preprocessURL(t),e)):s}_refreshToken(t){if(null===this._tokenRefreshPromise){const e=new URL(this.tiles.rootURL);e.searchParams.append("key",this.apiToken),this._tokenRefreshPromise=fetch(e,t).then((t=>t.json())).then((t=>{this.sessionToken=ci(t.root),this._tokenRefreshPromise=null})),this._tokenRefreshPromise.catch((t=>{this.tiles.dispatchEvent({type:"load-error",tile:null,error:t,rootURL:e})}))}return this._tokenRefreshPromise}}class di{constructor({apiToken:t,assetId:e=null,autoRefreshToken:s=!1}){this.name="CESIUM_ION_AUTH_PLUGIN",this.apiToken=t,this.assetId=e,this.autoRefreshToken=s,this.tiles=null,this.endpointURL=null,this._bearerToken=null,this._tileSetVersion=-1,this._tokenRefreshPromise=null,this._attributions=[]}init(t){null!==this.assetId&&(t.rootURL=`https://api.cesium.com/v1/assets/${this.assetId}/endpoint`),this.tiles=t,this.endpointURL=t.rootURL,t.resetFailedTiles()}loadRootTileSet(){return this._refreshToken().then((()=>this.tiles.loadRootTileSet()))}preprocessURL(t){return t=new URL(t),/^http/.test(t.protocol)&&-1!=this._tileSetVersion&&t.searchParams.append("v",this._tileSetVersion),t.toString()}fetchData(t,e){return null!==this.tiles.getPluginByName("GOOGLE_CLOUD_AUTH_PLUGIN")?null:Promise.resolve().then((async()=>{null!==this._tokenRefreshPromise&&(await this._tokenRefreshPromise,t=this.preprocessURL(t));const s=await fetch(t,e);return s.status>=400&&s.status<=499&&this.autoRefreshToken?(await this._refreshToken(e),fetch(this.preprocessURL(t),e)):s}))}getAttributions(t){this.tiles.visibleTiles.size>0&&t.push(...this._attributions)}_refreshToken(t){if(null===this._tokenRefreshPromise){const e=new URL(this.endpointURL);e.searchParams.append("access_token",this.apiToken),this._tokenRefreshPromise=fetch(e,t).then((t=>{if(!t.ok)throw new Error(`CesiumIonAuthPlugin: Failed to load data with error code ${t.status}`);return t.json()})).then((t=>{const s=this.tiles;if("externalType"in t){const e=new URL(t.options.url);s.rootURL=t.options.url,s.registerPlugin(new hi({apiToken:e.searchParams.get("key")}))}else{if(s.rootURL=t.url,s.fetchOptions.headers=s.fetchOptions.headers||{},s.fetchOptions.headers.Authorization=`Bearer ${t.accessToken}`,e.searchParams.has("v")&&-1===this._tileSetVersion){const e=new URL(t.url);this._tileSetVersion=e.searchParams.get("v")}this._bearerToken=t.accessToken,t.attributions&&(this._attributions=t.attributions.map((t=>({value:t.html,type:"html",collapsible:t.collapsible}))))}return this._tokenRefreshPromise=null,t})),this._tokenRefreshPromise.catch((t=>{this.tiles.dispatchEvent({type:"load-error",tile:null,error:t,url:e})}))}return this._tokenRefreshPromise}}const ui=new t;class pi{constructor(){this.name="UPDATE_ON_CHANGE_PLUGIN",this.tiles=null,this.needsUpdate=!1,this.cameraMatrices=new Map}init(e){this.tiles=e,this._needsUpdateCallback=()=>{this.needsUpdate=!0},this._onCameraAdd=({camera:e})=>{this.needsUpdate=!0,this.cameraMatrices.set(e,new t)},this._onCameraDelete=({camera:t})=>{this.needsUpdate=!0,this.cameraMatrices.delete(t)},e.addEventListener("camera-resolution-change",this._needsUpdateCallback),e.addEventListener("load-content",this._needsUpdateCallback),e.addEventListener("add-camera",this._onCameraAdd),e.addEventListener("delete-camera",this._onCameraDelete),e.cameras.forEach((t=>{this._onCameraAdd({camera:t})}))}doTilesNeedUpdate(){const t=this.tiles;let e=!1;this.cameraMatrices.forEach(((s,i)=>{ui.copy(t.group.matrixWorld).premultiply(i.matrixWorldInverse).premultiply(i.projectionMatrixInverse),e=e||!ui.equals(s),s.copy(ui)}));const s=this.needsUpdate;return this.needsUpdate=!1,s||e}dispose(){const t=this.tiles;t.removeEventListener("camera-resolution-change",this._needsUpdateCallback),t.removeEventListener("content-load",this._needsUpdateCallback),t.removeEventListener("camera-add",this._onCameraAdd),t.removeEventListener("camera-delete",this._onCameraDelete)}}const mi=new r;function fi(t,e){if(t.isInterleavedBufferAttribute||t.array instanceof e)return t;const s=e===Int8Array||e===Int16Array||e===Int32Array?-1:0,i=new e(t.count*t.itemSize),r=new l(i,t.itemSize,!0),a=t.itemSize,o=t.count;for(let l=0;l<o;l++)for(let e=0;e<a;e++){const i=n.clamp(t.getComponent(l,e),s,1);r.setComponent(l,e,i)}return r}class gi{constructor(t){this._options={generateNormals:!1,disableMipmaps:!0,compressIndex:!0,compressNormals:!1,compressUvs:!1,compressPosition:!1,uvType:Int8Array,normalType:Int8Array,positionType:Int16Array,...t},this.name="TILES_COMPRESSION_PLUGIN",this.priority=-100}processTileModel(t,e){const{generateNormals:s,disableMipmaps:i,compressIndex:r,compressUvs:a,compressNormals:o,compressPosition:c,uvType:h,normalType:d,positionType:u}=this._options;t.traverse((t=>{if(t.material&&i){const e=t.material;for(const t in e){const s=e[t];s&&s.isTexture&&s.generateMipmaps&&(s.generateMipmaps=!1,s.minFilter=L)}}if(t.geometry){const e=t.geometry,i=e.attributes;if(a){const{uv:t,uv1:e,uv2:s,uv3:n}=i;t&&(i.uv=fi(t,h)),e&&(i.uv1=fi(e,h)),s&&(i.uv2=fi(s,h)),n&&(i.uv3=fi(n,h))}if(s&&!i.normals&&e.computeVertexNormals(),o&&i.normals&&(i.normals=fi(i.normals,d)),c&&function(t,e=Int16Array){const s=t.geometry,i=s.attributes,r=i.position;if(r.isInterleavedBufferAttribute||r.array instanceof e)return r;const a=new e(r.count*r.itemSize),o=new l(a,r.itemSize,!1),c=r.itemSize,h=r.count;s.computeBoundingBox();const d=s.boundingBox,{min:u,max:p}=d,m=2**(8*e.BYTES_PER_ELEMENT-1)-1,f=-m;for(let l=0;l<h;l++)for(let t=0;t<c;t++){const e=0===t?"x":1===t?"y":"z",s=u[e],i=p[e],a=n.mapLinear(r.getComponent(l,t),s,i,f,m);o.setComponent(l,t,a)}d.getCenter(mi),t.position.add(mi),t.scale.x*=.5*(p.x-u.x)/m,t.scale.y*=.5*(p.y-u.y)/m,t.scale.z*=.5*(p.z-u.z)/m,i.position=o,t.geometry.boundingBox=null,t.geometry.boundingSphere=null,t.updateMatrixWorld()}(t,u),r&&e.index){const t=i.position.count,s=e.index,n=t>65535?Uint32Array:t>255?Uint16Array:Uint8Array;if(!(s.array instanceof n)){const t=new n(e.index.count);t.set(s.array);const i=new l(t,1);e.setIndex(i)}}}}))}}function yi(t,e,s){return t&&e in t?t[e]:s}function _i(t){return"BOOLEAN"!==t&&"STRING"!==t&&"ENUM"!==t}function bi(t){return/^VEC/.test(t)}function Ti(t){return/^MATRIX/.test(t)}function xi(t,e,s,i=null){return Ti(s)||bi(s)?i.fromArray(t,e):t[e]}function vi(e){const{type:s,componentType:n}=e;switch(s){case"SCALAR":return"INT64"===n?0n:0;case"VEC2":return new i;case"VEC3":return new r;case"VEC4":return new F;case"MAT2":return new k;case"MAT3":return new T;case"MAT4":return new t;case"BOOLEAN":return!1;case"STRING":return"";case"ENUM":return 0}}function wi(t,e){if(null==e)return!1;switch(t){case"SCALAR":case"ENUM":return"number"==typeof e||"bigint"==typeof e;case"VEC2":return e.isVector2;case"VEC3":return e.isVector3;case"VEC4":return e.isVector4;case"MAT2":return e.isMatrix2;case"MAT3":return e.isMatrix3;case"MAT4":return e.isMatrix4;case"BOOLEAN":return"boolean"==typeof e;case"STRING":return"string"==typeof e}throw new Error("ClassProperty: invalid type.")}function Pi(t,e=null){switch(t){case"INT8":return Int8Array;case"INT16":return Int16Array;case"INT32":return Int32Array;case"INT64":return BigInt64Array;case"UINT8":return Uint8Array;case"UINT16":return Uint16Array;case"UINT32":return Uint32Array;case"UINT64":return BigUint64Array;case"FLOAT32":return Float32Array;case"FLOAT64":return Float64Array}switch(e){case"BOOLEAN":case"STRING":return Uint8Array}throw new Error("ClassProperty: invalid type.")}function Ci(t,e=null){const s=t.default,i=t.type;if(e=e||vi(t),null===s){switch(i){case"SCALAR":return 0;case"VEC2":return e.set(0,0);case"VEC3":return e.set(0,0,0);case"VEC4":return e.set(0,0,0,0);case"MAT2":case"MAT3":case"MAT4":return e.identity();case"BOOLEAN":return!1;case"STRING":case"ENUM":return""}throw new Error("ClassProperty: invalid type.")}if(Ti(i))e.fromArray(s);else{if(!bi(i))return s;e.fromArray(s)}}function Mi(t,e){if(null===t.noData)return e;const s=t.noData,i=t.type;if(Array.isArray(e))for(let r=0,a=e.length;r<a;r++)e[r]=n(e[r]);else e=n(e);return e;function n(e){return function(t){if(Ti(i)){const e=t.elements;for(let t=0,i=s.length;t<i;t++)if(s[t]!==e[t])return!1;return!0}if(bi(i)){for(let e=0,i=s.length;e<i;e++)if(s[e]!==t.getComponent(e))return!1;return!0}return s===t}(e)&&(e=Ci(t,e)),e}}function Si(t,e){const{type:s,componentType:i,scale:n,offset:r,normalized:a}=t;if(Array.isArray(e))for(let c=0,h=e.length;c<h;c++)e[c]=o(e[c]);else e=o(e);return e;function o(t){return t=Ti(s)?function(t){const e=t.elements;for(let s=0,i=e.length;s<i;s++)e[s]=l(e[s]);return t}(t):bi(s)?function(t){t.x=l(t.x),t.y=l(t.y),"z"in t&&(t.z=l(t.z));"w"in t&&(t.w=l(t.w));return t}(t):l(t)}function l(t){return a&&(t=function(t,e){switch(t){case"INT8":return Math.max(e/127,-1);case"INT16":return Math.max(e,32767,-1);case"INT32":return Math.max(e/2147483647,-1);case"INT64":return Math.max(Number(e)/0x8000000000000000,-1);case"UINT8":return e/255;case"UINT16":return e/65535;case"UINT32":return e/4294967295;case"UINT64":return Number(e)/0x10000000000000000}}(i,t)),(a||function(t){return/^FLOAT/.test(t)}(i))&&(t=t*n+r),t}}function Ai(t,e,s=null){if(t.array){Array.isArray(e)||(e=new Array(t.count||0)),e.length=null!==s?s:t.count;for(let s=0,i=e.length;s<i;s++)wi(t.type,e[s])||(e[s]=vi(t))}else wi(t.type,e)||(e=vi(t));return e}function Ei(t,e){for(const s in e)s in t||delete e[s];for(const s in t){const i=t[s];e[s]=Ai(i,e[s])}}class Di{constructor(t,e,s=null){this.name=e.name||null,this.description=e.description||null,this.type=e.type,this.componentType=e.componentType||null,this.enumType=e.enumType||null,this.array=e.array||!1,this.count=e.count||0,this.normalized=e.normalized||!1,this.offset=e.offset||0,this.scale=yi(e,"scale",1),this.max=yi(e,"max",1/0),this.min=yi(e,"min",-1/0),this.required=e.required||!1,this.noData=yi(e,"noData",null),this.default=yi(e,"default",null),this.semantic=yi(e,"semantic",null),this.enumSet=null,this.accessorProperty=s,s&&(this.offset=yi(s,"offset",this.offset),this.scale=yi(s,"scale",this.scale),this.max=yi(s,"max",this.max),this.min=yi(s,"min",this.min)),"ENUM"===e.type&&(this.enumSet=t[this.enumType],null===this.componentType&&(this.componentType=yi(this.enumSet,"valueType","UINT16")))}shapeToProperty(t,e=null){return Ai(this,t,e)}resolveDefaultElement(t){return Ci(this,t)}resolveDefault(t){return function(t,e=null){if(t.array){(e=e&&Array.isArray(e)?e:[]).length=t.count;for(let s=0,i=e.length;s<i;s++)e[s]=Ci(t,e[s])}else e=Ci(t,e);return e}(this,t)}resolveNoData(t){return Mi(this,t)}resolveEnumsToStrings(t){const e=this.enumSet;if("ENUM"===this.type)if(Array.isArray(t))for(let i=0,n=t.length;i<n;i++)t[i]=s(t[i]);else t=s(t);return t;function s(t){const s=e.values.find((e=>e.value===t));return null===s?"":s.name}}adjustValueScaleOffset(t){return _i(this.type)?Si(this,t):t}}class Ui{constructor(t,e={},s={},i=null){this.definition=t,this.class=e[t.class],this.className=t.class,this.enums=s,this.data=i,this.name="name"in t?t.name:null,this.properties=null}getPropertyNames(){return Object.keys(this.class.properties)}includesData(t){return Boolean(this.definition.properties[t])}dispose(){}_initProperties(t=Di){const e={};for(const s in this.class.properties)e[s]=new t(this.enums,this.class.properties[s],this.definition.properties[s]);this.properties=e}}class Ri extends Di{constructor(t,e,s=null){super(t,e,s),this.attribute=s.attribute}}class Li extends Ui{constructor(...t){super(...t),this.isPropertyAttributeAccessor=!0,this._initProperties(Ri)}getData(t,e,s={}){const i=this.properties;Ei(i,s);for(const n in i)s[n]=this.getPropertyValue(n,t,e,s[n]);return s}getPropertyValue(t,e,s,i=null){if(e>=this.count)throw new Error("PropertyAttributeAccessor: Requested index is outside the range of the buffer.");const n=this.properties[t],r=n.type;if(!n)throw new Error("PropertyAttributeAccessor: Requested class property does not exist.");if(!this.definition.properties[t])return n.resolveDefault(i);i=n.shapeToProperty(i);const a=s.getAttribute(n.attribute.toLowerCase());if(Ti(r)){const t=i.elements;for(let s=0,i=t.length;s<i;s<i)t[s]=a.getComponent(e,s)}else if(bi(r))i.fromBufferAttribute(a,e);else{if("SCALAR"!==r&&"ENUM"!==r)throw new Error("StructuredMetadata.PropertyAttributeAccessor: BOOLEAN and STRING types are not supported by property attributes.");i=a.getX(e)}return i=n.adjustValueScaleOffset(i),i=n.resolveEnumsToStrings(i),i=n.resolveNoData(i)}}class ki extends Di{constructor(t,e,s=null){super(t,e,s),this.values=s.values,this.valueLength=function(t){switch(t){case"ENUM":case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return-1}}(this.type),this.arrayOffsets=yi(s,"arrayOffsets",null),this.stringOffsets=yi(s,"stringOffsets",null),this.arrayOffsetType=yi(s,"arrayOffsetType","UINT32"),this.stringOffsetType=yi(s,"stringOffsetType","UINT32")}getArrayLengthFromId(t,e){let s=this.count;if(null!==this.arrayOffsets){const{arrayOffsets:i,arrayOffsetType:n}=this,r=new(Pi(n))(t[i]);s=r[e+1]-r[e]}return s}getIndexOffsetFromId(t,e){let s=e;if(this.arrayOffsets){const{arrayOffsets:e,arrayOffsetType:i}=this;s=new(Pi(i))(t[e])[s]}else this.array&&(s*=this.count);return s}}class Fi extends Ui{constructor(...t){super(...t),this.isPropertyTableAccessor=!0,this.count=this.definition.count,this._initProperties(ki)}getData(t,e={}){const s=this.properties;Ei(s,e);for(const i in s)e[i]=this.getPropertyValue(i,t,e[i]);return e}_readValueAtIndex(t,e,s,i=null){const n=this.properties[t],{componentType:r,type:a}=n,o=this.data,l=o[n.values],c=new(Pi(r,a))(l),h=n.getIndexOffsetFromId(o,e);if(_i(a)||"ENUM"===a)return xi(c,(h+s)*n.valueLength,a,i);if("STRING"===a){let t=h+s,e=0;if(null!==n.stringOffsets){const{stringOffsets:s,stringOffsetType:i}=n,r=new(Pi(i))(o[s]);e=r[t+1]-r[t],t=r[t]}const r=new Uint8Array(c.buffer,t,e);i=(new TextDecoder).decode(r)}else if("BOOLEAN"===a){const t=h+s,e=t%8;i=1===(c[Math.floor(t/8)]>>e&1)}return i}getPropertyValue(t,e,s=null){if(e>=this.count)throw new Error("PropertyTableAccessor: Requested index is outside the range of the table.");const i=this.properties[t];if(!i)throw new Error("PropertyTableAccessor: Requested property does not exist.");if(!this.definition.properties[t])return i.resolveDefault(s);const n=i.array,r=this.data,a=i.getArrayLengthFromId(r,e);if(s=i.shapeToProperty(s,a),n)for(let o=0,l=s.length;o<l;o++)s[o]=this._readValueAtIndex(t,e,o,s[o]);else s=this._readValueAtIndex(t,e,0,s);return s=i.adjustValueScaleOffset(s),s=i.resolveEnumsToStrings(s),s=i.resolveNoData(s)}}const Ii=new W;class Oi{constructor(){this._renderer=new I,this._target=new O(1,1),this._texTarget=new O,this._quad=new z(new A({blending:V,blendDst:N,blendSrc:B,uniforms:{map:{value:null},pixel:{value:new i}},vertexShader:"\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\t\t\t\tuniform sampler2D map;\n\t\t\t\tuniform ivec2 pixel;\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tgl_FragColor = texelFetch( map, pixel, 0 );\n\n\t\t\t\t}\n\t\t\t"}))}increaseSizeTo(t){this._target.setSize(Math.max(this._target.width,t),1)}readDataAsync(t){const{_renderer:e,_target:s}=this;return e.readRenderTargetPixelsAsync(s,0,0,t.length/4,1,t)}readData(t){const{_renderer:e,_target:s}=this;e.readRenderTargetPixels(s,0,0,t.length/4,1,t)}renderPixelToTarget(t,e,s){const{_renderer:i,_target:n}=this;Ii.min.copy(e),Ii.max.copy(e),Ii.max.x+=1,Ii.max.y+=1,i.initRenderTarget(n),i.copyTextureToTexture(t,n.texture,Ii,s,0)}}const zi=new class{constructor(){let t=null;Object.getOwnPropertyNames(Oi.prototype).forEach((e=>{"constructor"!==e&&(this[e]=(...s)=>(t=t||new Oi,t[e](...s)))}))}},Vi=new i,Ni=new i,Bi=new i;function Wi(t,e,s=new Array(3)){let i=3*e,n=3*e+1,r=3*e+2;return t.index&&(i=t.index.getX(i),n=t.index.getX(n),r=t.index.getX(r)),s[0]=i,s[1]=n,s[2]=r,s}function ji(t,e,s,i,n){const[r,a,o]=i,l=function(t,e){return 0===e?t.getAttribute("uv"):t.getAttribute(`uv${e}`)}(t,e);Vi.fromBufferAttribute(l,r),Ni.fromBufferAttribute(l,a),Bi.fromBufferAttribute(l,o),n.set(0,0,0).addScaledVector(Vi,s.x).addScaledVector(Ni,s.y).addScaledVector(Bi,s.z)}function Gi(t,e,s,i){const n=t.x-Math.floor(t.x),r=t.y-Math.floor(t.y),a=Math.floor(n*e%e),o=Math.floor(r*s%s);return i.set(a,o),i}const Hi=new i,qi=new i,Zi=new i;class $i extends Di{constructor(t,e,s=null){super(t,e,s),this.channels=yi(s,"channels",[0]),this.index=yi(s,"index",null),this.texCoord=yi(s,"texCoord",null),this.valueLength=parseInt(this.type.replace(/[^0-9]/g,""))||1}readDataFromBuffer(t,e,s=null){const i=this.type;if("BOOLEAN"===i||"STRING"===i)throw new Error("PropertyTextureAccessor: BOOLEAN and STRING types not supported.");return xi(t,e*this.valueLength,i,s)}}class Qi extends Ui{constructor(...t){super(...t),this.isPropertyTextureAccessor=!0,this._asyncRead=!1,this._initProperties($i)}getData(t,e,s,i={}){const n=this.properties;Ei(n,i);const r=Object.keys(n),a=r.map((t=>i[t]));return this.getPropertyValuesAtTexel(r,t,e,s,a),r.forEach(((t,e)=>i[t]=a[e])),i}async getDataAsync(t,e,s,i={}){const n=this.properties;Ei(n,i);const r=Object.keys(n),a=r.map((t=>i[t]));return await this.getPropertyValuesAtTexelAsync(r,t,e,s,a),r.forEach(((t,e)=>i[t]=a[e])),i}getPropertyValuesAtTexelAsync(...t){this._asyncRead=!0;const e=this.getPropertyValuesAtTexel(...t);return this._asyncRead=!1,e}getPropertyValuesAtTexel(t,e,s,i,n=[]){for(;n.length<t.length;)n.push(null);n.length=t.length,zi.increaseSizeTo(n.length);const r=this.data,a=this.definition.properties,o=this.properties,l=Wi(i,e);for(let d=0,u=t.length;d<u;d++){const e=t[d];if(!a[e])continue;const n=o[e],c=r[n.index];ji(i,n.texCoord,s,l,Hi),Gi(Hi,c.image.width,c.image.height,qi),Zi.set(d,0),zi.renderPixelToTarget(c,qi,Zi)}const c=new Uint8Array(4*t.length);return this._asyncRead?zi.readDataAsync(c).then((()=>(h.call(this),n))):(zi.readData(c),h.call(this),n);function h(){for(let e=0,s=t.length;e<s;e++){const s=t[e],i=o[s],r=i.type;if(n[e]=Ai(i,n[e]),!i)throw new Error("PropertyTextureAccessor: Requested property does not exist.");if(!a[s]){n[e]=i.resolveDefault(n);continue}const l=i.valueLength*(i.count||1),h=i.channels.map((t=>c[4*e+t])),d=new(Pi(i.componentType,r))(l);if(new Uint8Array(d.buffer).set(h),i.array){const t=n[e];for(let e=0,s=t.length;e<s;e++)t[e]=i.readDataFromBuffer(d,e,t[e])}else n[e]=i.readDataFromBuffer(d,0,n[e]);n[e]=i.adjustValueScaleOffset(n[e]),n[e]=i.resolveEnumsToStrings(n[e]),n[e]=i.resolveNoData(n[e])}}}dispose(){this.data.forEach((t=>{t&&(t.dispose(),t.image instanceof ImageBitmap&&t.image.close())}))}}class Yi{constructor(t,e,s,i=null,n=null){const{schema:r,propertyTables:a=[],propertyTextures:o=[],propertyAttributes:l=[]}=t,{enums:c,classes:h}=r,d=a.map((t=>new Fi(t,h,c,s)));let u=[],p=[];i&&(i.propertyTextures&&(u=i.propertyTextures.map((t=>new Qi(o[t],h,c,e)))),i.propertyAttributes&&(p=i.propertyAttributes.map((t=>new Li(l[t],h,c))))),this.schema=r,this.tableAccessors=d,this.textureAccessors=u,this.attributeAccessors=p,this.object=n,this.textures=e,this.nodeMetadata=i}getPropertyTableData(t,e,s=null){if(Array.isArray(t)&&Array.isArray(e)){s=s||[];const i=Math.min(t.length,e.length);s.length=i;for(let n=0;n<i;n++){const i=this.tableAccessors[t[n]];s[n]=i.getData(e[n],s[n])}}else{s=s||{};s=this.tableAccessors[t].getData(e,s)}return s}getPropertyTableInfo(t=null){if(null===t&&(t=this.tableAccessors.map(((t,e)=>e))),Array.isArray(t))return t.map((t=>{const e=this.tableAccessors[t];return{name:e.name,className:e.definition.class}}));{const e=this.tableAccessors[t];return{name:e.name,className:e.definition.class}}}getPropertyTextureData(t,e,s=[]){const i=this.textureAccessors;s.length=i.length;for(let n=0;n<i.length;n++){const r=i[n];s[n]=r.getData(t,e,this.object.geometry,s[n])}return s}async getPropertyTextureDataAsync(t,e,s=[]){const i=this.textureAccessors;s.length=i.length;const n=[];for(let r=0;r<i.length;r++){const a=i[r].getDataAsync(t,e,this.object.geometry,s[r]).then((t=>{s[r]=t}));n.push(a)}return await Promise.all(n),s}getPropertyTextureInfo(){return this.textureAccessors}getPropertyAttributeData(t,e=[]){const s=this.attributeAccessors;e.length=s.length;for(let i=0;i<s.length;i++){const n=s[i];e[i]=n.getData(t,this.object.geometry,e[i])}return e}getPropertyAttributeInfo(){return this.attributeAccessors.map((t=>({name:t.name,className:t.definition.class})))}dispose(){this.textureAccessors.forEach((t=>t.dispose())),this.tableAccessors.forEach((t=>t.dispose())),this.attributeAccessors.forEach((t=>t.dispose()))}}const Ji="EXT_structural_metadata";function Xi(t,e=[]){const s=t.json.textures?.length||0,i=new Array(s).fill(null);return e.forEach((({properties:e})=>{for(const s in e){const{index:n}=e[s];null===i[n]&&(i[n]=t.loadTexture(n))}})),Promise.all(i)}function Ki(t,e=[]){const s=t.json.bufferViews?.length||0,i=new Array(s).fill(null);return e.forEach((({properties:e})=>{for(const s in e){const{values:n,arrayOffsets:r,stringOffsets:a}=e[s];null===i[n]&&(i[n]=t.loadBufferView(n)),null===i[r]&&(i[r]=t.loadBufferView(r)),null===i[a]&&(i[a]=t.loadBufferView(a))}})),Promise.all(i)}class tn{constructor(t){this.parser=t,this.name=Ji}async afterRoot({scene:t,parser:e}){const s=e.json.extensionsUsed;if(!s||!s.includes(Ji))return;let i=null,n=e.json.extensions[Ji];if(n.schemaUri){const{manager:t,path:s,requestHeader:r,crossOrigin:a}=e.options,o=new URL(n.schemaUri,s).toString(),l=new j(t);l.setCrossOrigin(a),l.setResponseType("json"),l.setRequestHeader(r),i=l.loadAsync(o).then((t=>{n={...n,schema:t}}))}const[r,a]=await Promise.all([Xi(e,n.propertyTextures),Ki(e,n.propertyTables),i]),o=new Yi(n,r,a);t.userData.structuralMetadata=o,t.traverse((t=>{if(e.associations.has(t)){const{meshes:s,primitives:i}=e.associations.get(t),l=e.json.meshes[s].primitives[i];if(l&&l.extensions&&l.extensions[Ji]){const e=l.extensions[Ji];t.userData.structuralMetadata=new Yi(n,r,a,e,t)}else t.userData.structuralMetadata=o}}))}}const en=new i,sn=new i,nn=new i;class rn{constructor(t,e,s){this.geometry=t,this.textures=e,this.data=s,this._asyncRead=!1,this.featureIds=s.featureIds.map((t=>{const{texture:e,...s}=t,i={label:null,propertyTable:null,nullFeatureId:null,...s};return e&&(i.texture={texCoord:0,channels:[0],...e}),i}))}getTextures(){return this.textures}getFeatureInfo(){return this.featureIds}getFeaturesAsync(...t){this._asyncRead=!0;const e=this.getFeatures(...t);return this._asyncRead=!1,e}getFeatures(t,e){const{geometry:s,textures:i,featureIds:n}=this,r=new Array(n.length).fill(null),a=n.length;zi.increaseSizeTo(a);const o=Wi(s,t),l=o[function(t){return t.x>t.y&&t.x>t.z?0:t.y>t.z?1:2}(e)];for(let d=0,u=n.length;d<u;d++){const t=n[d],a="nullFeatureId"in t?t.nullFeatureId:null;if("texture"in t){const n=i[t.texture.index];ji(s,t.texture.texCoord,e,o,en),Gi(en,n.image.width,n.image.height,sn),nn.set(d,0),zi.renderPixelToTarget(i[t.texture.index],sn,nn)}else if("attribute"in t){const e=s.getAttribute(`_feature_id_${t.attribute}`).getX(l);e!==a&&(r[d]=e)}else{const t=l;t!==a&&(r[d]=t)}}const c=new Uint8Array(4*a);return this._asyncRead?zi.readDataAsync(c).then((()=>(h(),r))):(zi.readData(c),h(),r);function h(){const t=new Uint32Array(1);for(let e=0,s=n.length;e<s;e++){const s=n[e],i="nullFeatureId"in s?s.nullFeatureId:null;if("texture"in s){const{channels:n}=s.texture,a=n.map((t=>c[4*e+t]));new Uint8Array(t.buffer).set(a);const o=t[0];o!==i&&(r[e]=o)}}}}dispose(){this.textures.forEach((t=>{t&&(t.dispose(),t.image instanceof ImageBitmap&&t.image.close())}))}}const an="EXT_mesh_features";function on(t,e,s){t.traverse((t=>{if(e.associations.has(t)){const{meshes:i,primitives:n}=e.associations.get(t),r=e.json.meshes[i].primitives[n];r&&r.extensions&&r.extensions[an]&&s(t,r.extensions[an])}}))}class ln{constructor(t){this.parser=t,this.name=an}async afterRoot({scene:t,parser:e}){const s=e.json.extensionsUsed;if(!s||!s.includes(an))return;const i=e.json.textures?.length||0,n=new Array(i).fill(null);on(t,e,((t,{featureIds:s})=>{s.forEach((t=>{if(t.texture&&null===n[t.texture.index]){const s=t.texture.index;n[s]=e.loadTexture(s)}}))}));const r=await Promise.all(n);on(t,e,((t,e)=>{t.userData.meshFeatures=new rn(t.geometry,r,e)}))}}class cn{constructor(){this.name="CESIUM_RTC"}afterRoot(t){if(t.parser.json.extensions&&t.parser.json.extensions.CESIUM_RTC){const{center:e}=t.parser.json.extensions.CESIUM_RTC;e&&(t.scene.position.x+=e[0],t.scene.position.y+=e[1],t.scene.position.z+=e[2])}}}class hn{constructor(t){t={metadata:!0,rtc:!0,plugins:[],dracoLoader:null,ktxLoader:null,meshoptDecoder:null,autoDispose:!0,...t},this.tiles=null,this.metadata=t.metadata,this.rtc=t.rtc,this.plugins=t.plugins,this.dracoLoader=t.dracoLoader,this.ktxLoader=t.ktxLoader,this.meshoptDecoder=t.meshoptDecoder,this._gltfRegex=/\.(gltf|glb)$/g,this._dracoRegex=/\.drc$/g,this._loader=null}init(t){const e=new s(t.manager);this.dracoLoader&&(e.setDRACOLoader(this.dracoLoader),t.manager.addHandler(this._dracoRegex,this.dracoLoader)),this.ktxLoader&&e.setKTX2Loader(this.ktxLoader),this.meshoptDecoder&&e.setMeshoptDecoder(this.meshoptDecoder),this.rtc&&e.register((()=>new cn)),this.metadata&&(e.register((()=>new tn)),e.register((()=>new ln))),this.plugins.forEach((t=>e.register(t))),t.manager.addHandler(this._gltfRegex,e),this.tiles=t,this._loader=e}dispose(){this.tiles.manager.removeHandler(this._gltfRegex),this.tiles.manager.removeHandler(this._dracoRegex),this.autoDispose&&(this.ktxLoader.dispose(),this.dracoLoader.dispose())}}class dn{set delay(t){this.deferCallbacks.delay=t}get delay(){return this.deferCallbacks.delay}set bytesTarget(t){this.lruCache.minBytesSize=t}get bytesTarget(){return this.lruCache.minBytesSize}get estimatedGpuBytes(){return this.lruCache.cachedBytes}constructor(t={}){const{delay:e=0,bytesTarget:s=0}=t;this.name="UNLOAD_TILES_PLUGIN",this.tiles=null,this.lruCache=new Q,this.deferCallbacks=new un,this.delay=e,this.bytesTarget=s}init(t){this.tiles=t;const{lruCache:e,deferCallbacks:s}=this;s.callback=t=>{e.markUnused(t),e.scheduleUnload(!1)};const i=e=>{const s=e.cached.scene;t.visibleTiles.has(e)||t.invokeOnePlugin((t=>t.unloadTileFromGPU&&t.unloadTileFromGPU(s,e)))};this._onUpdateBefore=()=>{e.unloadPriorityCallback=t.lruCache.unloadPriorityCallback,e.computeMemoryUsageCallback=t.lruCache.computeMemoryUsageCallback,e.minSize=1/0,e.maxSize=1/0,e.maxBytesSize=1/0,e.unloadPercent=1,e.autoMarkUnused=!1},this._onVisibilityChangeCallback=({tile:n,visible:r})=>{r?(e.add(n,i),t.markTileUsed(n),s.cancel(n)):s.run(n)},t.forEachLoadedModel(((e,s)=>{const i=t.visibleTiles.has(s);this._onVisibilityChangeCallback({scene:e,visible:i})})),t.addEventListener("tile-visibility-change",this._onVisibilityChangeCallback),t.addEventListener("update-before",this._onUpdateBefore)}unloadTileFromGPU(t,e){t&&t.traverse((t=>{if(t.material){const e=t.material;e.dispose();for(const t in e){const s=e[t];s&&s.isTexture&&s.dispose()}}t.geometry&&t.geometry.dispose()}))}dispose(){this.tiles.removeEventListener("tile-visibility-change",this._onVisibilityChangeCallback),this.tiles.removeEventListener("update-before",this._onUpdateBefore),this.deferCallbacks.cancelAll()}}class un{constructor(t=(()=>{})){this.map=new Map,this.callback=t,this.delay=0}run(t){const{map:e,delay:s}=this;if(e.has(t))throw new Error("DeferCallbackManager: Callback already initialized.");0===s?this.callback(t):e.set(t,setTimeout((()=>this.callback(t)),s))}cancel(t){const{map:e}=this;e.has(t)&&(clearTimeout(e.get(t)),e.delete(t))}cancelAll(){this.map.forEach(((t,e)=>{this.cancel(e)}))}}const{clamp:pn}=n;class mn{constructor(){this.duration=250,this.fadeCount=0,this._lastTick=-1,this._fadeState=new Map,this.onFadeComplete=null,this.onFadeStart=null,this.onFadeSetComplete=null,this.onFadeSetStart=null}deleteObject(t){t&&this.completeFade(t)}guaranteeState(t){const e=this._fadeState;if(e.has(t))return!1;return e.set(t,{fadeInTarget:0,fadeOutTarget:0,fadeIn:0,fadeOut:0}),!0}completeFade(t){const e=this._fadeState;if(!e.has(t))return;const s=0===e.get(t).fadeOutTarget;e.delete(t),this.fadeCount--,this.onFadeComplete&&this.onFadeComplete(t,s),0===this.fadeCount&&this.onFadeSetComplete&&this.onFadeSetComplete()}completeAllFades(){this._fadeState.forEach(((t,e)=>{this.completeFade(e)}))}forEachObject(t){this._fadeState.forEach(((e,s)=>{t(s,e)}))}fadeIn(t){const e=this.guaranteeState(t),s=this._fadeState.get(t);s.fadeInTarget=1,s.fadeOutTarget=0,s.fadeOut=0,e&&(this.fadeCount++,1===this.fadeCount&&this.onFadeSetStart&&this.onFadeSetStart(),this.onFadeStart&&this.onFadeStart(t))}fadeOut(t){const e=this.guaranteeState(t),s=this._fadeState.get(t);s.fadeOutTarget=1,e&&(s.fadeInTarget=1,s.fadeIn=1,this.fadeCount++,1===this.fadeCount&&this.onFadeSetStart&&this.onFadeSetStart(),this.onFadeStart&&this.onFadeStart(t))}isFading(t){return this._fadeState.has(t)}isFadingOut(t){const e=this._fadeState.get(t);return e&&1===e.fadeOutTarget}update(){const t=window.performance.now();-1===this._lastTick&&(this._lastTick=t);const e=pn((t-this._lastTick)/this.duration,0,1);this._lastTick=t;this._fadeState.forEach(((t,s)=>{const{fadeOutTarget:i,fadeInTarget:n}=t;let{fadeOut:r,fadeIn:a}=t;const o=Math.sign(n-a);a=pn(a+o*e,0,1);const l=Math.sign(i-r);r=pn(r+l*e,0,1),t.fadeIn=a,t.fadeOut=r;((1===r||0===r)&&(1===a||0===a)||r>=a)&&this.completeFade(s)}))}}function fn(t,e){const s={fadeIn:{value:0},fadeOut:{value:0},fadeTexture:{value:null}};return t.defines={...t.defines||{},FEATURE_FADE:0},t.onBeforeCompile=t=>{e&&e(t),t.uniforms={...t.uniforms,...s},t.vertexShader=t.vertexShader.replace(/void\s+main\(\)\s+{/,(t=>`\n\t\t\t\t\t#ifdef USE_BATCHING_FRAG\n\n\t\t\t\t\tvarying float vBatchId;\n\n\t\t\t\t\t#endif\n\n\t\t\t\t\t${t}\n\n\t\t\t\t\t\t#ifdef USE_BATCHING_FRAG\n\n\t\t\t\t\t\t// add 0.5 to the value to avoid floating error that may cause flickering\n\t\t\t\t\t\tvBatchId = getIndirectIndex( gl_DrawID ) + 0.5;\n\n\t\t\t\t\t\t#endif\n\t\t\t\t`)),t.fragmentShader=t.fragmentShader.replace(/void main\(/,(t=>`\n\t\t\t\t#if FEATURE_FADE\n\n\t\t\t\t// adapted from https://www.shadertoy.com/view/Mlt3z8\n\t\t\t\tfloat bayerDither2x2( vec2 v ) {\n\n\t\t\t\t\treturn mod( 3.0 * v.y + 2.0 * v.x, 4.0 );\n\n\t\t\t\t}\n\n\t\t\t\tfloat bayerDither4x4( vec2 v ) {\n\n\t\t\t\t\tvec2 P1 = mod( v, 2.0 );\n\t\t\t\t\tvec2 P2 = floor( 0.5 * mod( v, 4.0 ) );\n\t\t\t\t\treturn 4.0 * bayerDither2x2( P1 ) + bayerDither2x2( P2 );\n\n\t\t\t\t}\n\n\t\t\t\t// the USE_BATCHING define is not available in fragment shaders\n\t\t\t\t#ifdef USE_BATCHING_FRAG\n\n\t\t\t\t// functions for reading the fade state of a given batch id\n\t\t\t\tuniform sampler2D fadeTexture;\n\t\t\t\tvarying float vBatchId;\n\t\t\t\tvec2 getFadeValues( const in float i ) {\n\n\t\t\t\t\tint size = textureSize( fadeTexture, 0 ).x;\n\t\t\t\t\tint j = int( i );\n\t\t\t\t\tint x = j % size;\n\t\t\t\t\tint y = j / size;\n\t\t\t\t\treturn texelFetch( fadeTexture, ivec2( x, y ), 0 ).rg;\n\n\t\t\t\t}\n\n\t\t\t\t#else\n\n\t\t\t\tuniform float fadeIn;\n\t\t\t\tuniform float fadeOut;\n\n\t\t\t\t#endif\n\n\t\t\t\t#endif\n\n\t\t\t\t${t}\n\t\t\t`)).replace(/#include <dithering_fragment>/,(t=>`\n\n\t\t\t\t${t}\n\n\t\t\t\t#if FEATURE_FADE\n\n\t\t\t\t#ifdef USE_BATCHING_FRAG\n\n\t\t\t\tvec2 fadeValues = getFadeValues( vBatchId );\n\t\t\t\tfloat fadeIn = fadeValues.r;\n\t\t\t\tfloat fadeOut = fadeValues.g;\n\n\t\t\t\t#endif\n\n\t\t\t\tfloat bayerValue = bayerDither4x4( floor( mod( gl_FragCoord.xy, 4.0 ) ) );\n\t\t\t\tfloat bayerBins = 16.0;\n\t\t\t\tfloat dither = ( 0.5 + bayerValue ) / bayerBins;\n\t\t\t\tif ( dither >= fadeIn ) {\n\n\t\t\t\t\tdiscard;\n\n\t\t\t\t}\n\n\t\t\t\tif ( dither < fadeOut ) {\n\n\t\t\t\t\tdiscard;\n\n\t\t\t\t}\n\n\t\t\t\t#endif\n\n\t\t\t`))},s}class gn{constructor(){this._fadeParams=new WeakMap,this.fading=0}setFade(t,e,s){if(!t)return;const i=this._fadeParams;t.traverse((t=>{const n=t.material;if(n){const t=i.get(n);t.fadeIn.value=e,t.fadeOut.value=s;const r=Number(!(0===e||1===e)||!(0===s||1===s));n.defines.FEATURE_FADE!==r&&(this.fading+=1===r?1:-1,n.defines.FEATURE_FADE=r,n.needsUpdate=!0)}}))}prepareScene(t){t.traverse((t=>{t.material&&this.prepareMaterial(t.material)}))}deleteScene(t){if(!t)return;const e=this._fadeParams;t.traverse((t=>{const s=t.material;s&&(e.delete(s),s.onBeforeCompile=()=>{},s.needsUpdate=!0)}))}prepareMaterial(t){const e=this._fadeParams;e.has(t)||e.set(t,fn(t))}}class yn{constructor(t,e=new G){this.other=t,this.material=e,this.visible=!0,this.parent=null,this._instanceInfo=[],this._visibilityChanged=!0;const s=new Proxy(this,{get(e,i){if(i in e)return e[i];{const n=t[i];return n instanceof Function?(...t)=>(e.syncInstances(),n.call(s,...t)):t[i]}},set:(e,s,i)=>(s in e?e[s]=i:t[s]=i,!0),deleteProperty:(e,s)=>s in e?delete e[s]:delete t[s]});return s}syncInstances(){const t=this._instanceInfo,e=this.other._instanceInfo;for(;e.length>t.length;){const s=t.length;t.push(new Proxy({visible:!1},{get:(t,i)=>i in t?t[i]:e[s][i],set:(t,i,n)=>(i in t?t[i]=n:e[s][i]=n,!0)}))}}}class _n extends yn{constructor(...t){super(...t);const e=this.material,s=fn(e,e.onBeforeCompile);e.defines.FEATURE_FADE=1,e.defines.USE_BATCHING_FRAG=1,e.needsUpdate=!0,this.fadeTexture=null,this._fadeParams=s}setFadeAt(t,e,s){this._initFadeTexture(),this.fadeTexture.setValueAt(t,255*e,255*s)}_initFadeTexture(){let t=Math.sqrt(this._maxInstanceCount);t=Math.ceil(t);const e=t*t*2,s=this.fadeTexture;if(!s||s.image.data.length!==e){const i=new Uint8Array(e),n=new bn(i,t,t,H,q);if(s){s.dispose();const t=s.image.data,e=this.fadeTexture.image.data,i=Math.min(t.length,e.length);e.set(new t.constructor(t.buffer,0,i))}this.fadeTexture=n,this._fadeParams.fadeTexture.value=n,n.needsUpdate=!0}}dispose(){this.fadeTexture&&this.fadeTexture.dispose()}}class bn extends Z{setValueAt(t,...e){const{data:s,width:i,height:n}=this.image,r=Math.floor(s.length/(i*n));let a=!1;for(let o=0;o<r;o++){const i=t*r+o,n=s[i],l=e[o]||0;n!==l&&(s[i]=l,a=!0)}a&&(this.needsUpdate=!0)}}const Tn=Symbol("HAS_POPPED_IN"),xn=new r,vn=new r,wn=new g,Pn=new g,Cn=new r;function Mn(){const t=this._fadeManager,e=this.tiles;this._fadingBefore=t.fadeCount,this._displayActiveTiles=e.displayActiveTiles,e.displayActiveTiles=!0}function Sn(){const t=this._fadeManager,e=this._fadeMaterialManager,s=this._displayActiveTiles,i=this._fadingBefore,n=this._prevCameraTransforms,{tiles:r,maximumFadeOutTiles:a,batchedMesh:o}=this,{cameras:l}=r;r.displayActiveTiles=s,t.update();const c=t.fadeCount;if(0!==i&&0!==c&&(r.dispatchEvent({type:"fade-change"}),r.dispatchEvent({type:"force-rerender"})),s||r.visibleTiles.forEach((t=>{const e=t.cached.scene;e&&(e.visible=t.__inFrustum),this.forEachBatchIds(t,((e,s,i)=>{s.setVisibleAt(e,t.__inFrustum),i.batchedMesh.setVisibleAt(e,t.__inFrustum)}))})),a<this._fadingOutCount){let e=!0;l.forEach((t=>{if(!n.has(t))return;const s=t.matrixWorld,i=n.get(t);s.decompose(vn,Pn,Cn),i.decompose(xn,wn,Cn);const r=Pn.angleTo(wn),a=vn.distanceTo(xn);e=e&&(r>.25||a>.1)})),e&&t.completeAllFades()}if(l.forEach((t=>{n.get(t).copy(t.matrixWorld)})),t.forEachObject(((s,{fadeIn:i,fadeOut:n})=>{const a=s.cached.scene,o=t.isFadingOut(s);r.markTileUsed(s),a&&(e.setFade(a,i,n),o&&(a.visible=!0)),this.forEachBatchIds(s,((t,e,s)=>{e.setFadeAt(t,i,n),e.setVisibleAt(t,!0),s.batchedMesh.setVisibleAt(t,!1)}))})),o){const t=r.getPluginByName("BATCHED_TILES_PLUGIN").batchedMesh.material;o.material.map=t.map}}class An{get fadeDuration(){return this._fadeManager.duration}set fadeDuration(t){this._fadeManager.duration=Number(t)}get fadingTiles(){return this._fadeManager.fadeCount}constructor(t){t={maximumFadeOutTiles:50,fadeRootTiles:!1,fadeDuration:250,...t},this.name="FADE_TILES_PLUGIN",this.priority=-2,this.tiles=null,this.batchedMesh=null,this._fadeManager=new mn,this._fadeMaterialManager=new gn,this._prevCameraTransforms=null,this._fadingOutCount=0,this.maximumFadeOutTiles=t.maximumFadeOutTiles,this.fadeRootTiles=t.fadeRootTiles,this.fadeDuration=t.fadeDuration}init(e){this._onLoadModel=({scene:t})=>{this._fadeMaterialManager.prepareScene(t)},this._onDisposeModel=({tile:t,scene:e})=>{this._fadeManager.deleteObject(t),this._fadeMaterialManager.deleteScene(e)},this._onAddCamera=({camera:e})=>{this._prevCameraTransforms.set(e,new t)},this._onDeleteCamera=({camera:t})=>{this._prevCameraTransforms.delete(t)},this._onTileVisibilityChange=({tile:t,visible:e})=>{const s=t.cached.scene;s&&(s.visible=!0),this.forEachBatchIds(t,((t,e,s)=>{e.setFadeAt(t,0,0),e.setVisibleAt(t,!1),s.batchedMesh.setVisibleAt(t,!1)}))},this._onUpdateBefore=()=>{Mn.call(this)},this._onUpdateAfter=()=>{Sn.call(this)},e.addEventListener("load-model",this._onLoadModel),e.addEventListener("dispose-model",this._onDisposeModel),e.addEventListener("add-camera",this._onAddCamera),e.addEventListener("delete-camera",this._onDeleteCamera),e.addEventListener("update-before",this._onUpdateBefore),e.addEventListener("update-after",this._onUpdateAfter),e.addEventListener("tile-visibility-change",this._onTileVisibilityChange);const s=this._fadeManager;s.onFadeSetStart=()=>{e.dispatchEvent({type:"fade-start"}),e.dispatchEvent({type:"force-rerender"})},s.onFadeSetComplete=()=>{e.dispatchEvent({type:"fade-end"}),e.dispatchEvent({type:"force-rerender"})},s.onFadeComplete=(t,s)=>{this._fadeMaterialManager.setFade(t.cached.scene,0,0),this.forEachBatchIds(t,((t,e,i)=>{e.setFadeAt(t,0,0),e.setVisibleAt(t,!1),i.batchedMesh.setVisibleAt(t,s)})),s||(e.invokeOnePlugin((e=>e!==this&&e.setTileVisible&&e.setTileVisible(t,!1))),this._fadingOutCount--)};const i=new Map;e.cameras.forEach((e=>{i.set(e,new t)})),e.forEachLoadedModel(((t,e)=>{this._onLoadModel({scene:t})})),this.tiles=e,this._fadeManager=s,this._prevCameraTransforms=i}initBatchedMesh(){const t=this.tiles.getPluginByName("BATCHED_TILES_PLUGIN")?.batchedMesh;if(t){if(null===this.batchedMesh){this._onBatchedMeshDispose=()=>{this.batchedMesh.dispose(),this.batchedMesh.removeFromParent(),this.batchedMesh=null,t.removeEventListener("dispose",this._onBatchedMeshDispose)};const e=t.material.clone();e.onBeforeCompile=t.material.onBeforeCompile,this.batchedMesh=new _n(t,e),this.tiles.group.add(this.batchedMesh)}}else null!==this.batchedMesh&&(this._onBatchedMeshDispose(),this._onBatchedMeshDispose=null)}setTileVisible(t,e){const s=this._fadeManager,i=s.isFading(t);if(s.isFadingOut(t)&&this._fadingOutCount--,e){1===t.__depthFromRenderedParent?((t[Tn]||this.fadeRootTiles)&&this._fadeManager.fadeIn(t),t[Tn]=!0):this._fadeManager.fadeIn(t)}else this._fadingOutCount++,s.fadeOut(t);if(i)return!0;const n=this._fadeManager.isFading(t);return!(e||!n)}dispose(){const t=this.tiles;this._fadeManager.completeAllFades(),null!==this.batchedMesh&&this._onBatchedMeshDispose(),t.removeEventListener("load-model",this._onLoadModel),t.removeEventListener("dispose-model",this._onDisposeModel),t.removeEventListener("add-camera",this._onAddCamera),t.removeEventListener("delete-camera",this._onDeleteCamera),t.removeEventListener("update-before",this._onUpdateBefore),t.removeEventListener("update-after",this._onUpdateAfter),t.removeEventListener("tile-visibility-change",this._onTileVisibilityChange),t.forEachLoadedModel(((t,e)=>{this._fadeManager.deleteObject(e),t&&(t.visible=!0)}))}forEachBatchIds(t,e){if(this.initBatchedMesh(),this.batchedMesh){const s=this.tiles.getPluginByName("BATCHED_TILES_PLUGIN"),i=s.getTileBatchIds(t);i&&i.forEach((t=>{e(t,this.batchedMesh,s)}))}}}export{di as C,hn as G,Ke as T,pi as U,oi as a,Xs as b,gi as c,dn as d,An as e};
