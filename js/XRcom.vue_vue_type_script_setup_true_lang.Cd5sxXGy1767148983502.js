import{GLTFLoader as j,importShared as y}from"./3d-tiles-renderer.DZNovkLO1767148983502.js";import{Fs as I,createEventHook as C}from"./index.DTe2qqjO1767148983502.js";const O="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/generic-hand/";class F{constructor(e,t,n,i,s=null,a=null){this.controller=t,this.handModel=e,this.bones=[],s===null&&(s=new j,s.setPath(n||O)),s.load(`${i}.glb`,d=>{const r=d.scene.children[0];this.handModel.add(r);const o=r.getObjectByProperty("type","SkinnedMesh");o.frustumCulled=!1,o.castShadow=!0,o.receiveShadow=!0,["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"].forEach(p=>{const c=r.getObjectByName(p);c!==void 0?c.jointName=p:console.warn(`Couldn't find ${p} in ${i} hand mesh`),this.bones.push(c)}),a&&a(r)})}updateMesh(){const e=this.controller.joints;for(let t=0;t<this.bones.length;t++){const n=this.bones[t];if(n){const i=e[n.jointName];if(i.visible){const s=i.position;n.position.copy(s),n.quaternion.copy(i.quaternion)}}}}}class g{static createButton(e,t={}){const n=document.createElement("button");function i(){let o=null;async function f(u){u.addEventListener("end",p),await e.xr.setSession(u),n.textContent="EXIT VR",o=u}function p(){o.removeEventListener("end",p),n.textContent="ENTER VR",o=null}n.style.display="",n.style.cursor="pointer",n.style.left="calc(50% - 50px)",n.style.width="100px",n.textContent="ENTER VR";const c={...t,optionalFeatures:["local-floor","bounded-floor","layers",...t.optionalFeatures||[]]};n.onmouseenter=function(){n.style.opacity="1.0"},n.onmouseleave=function(){n.style.opacity="0.5"},n.onclick=function(){o===null?navigator.xr.requestSession("immersive-vr",c).then(f):(o.end(),navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",c).then(f).catch(u=>{console.warn(u)}))},navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",c).then(f).catch(u=>{console.warn(u)})}function s(){n.style.display="",n.style.cursor="auto",n.style.left="calc(50% - 75px)",n.style.width="150px",n.onmouseenter=null,n.onmouseleave=null,n.onclick=null}function a(){s(),n.textContent="VR NOT SUPPORTED"}function d(o){s(),console.warn("Exception when trying to call xr.isSessionSupported",o),n.textContent="VR NOT ALLOWED"}function r(o){o.style.position="absolute",o.style.bottom="20px",o.style.padding="12px 6px",o.style.border="1px solid #fff",o.style.borderRadius="4px",o.style.background="rgba(0,0,0,0.1)",o.style.color="#fff",o.style.font="normal 13px sans-serif",o.style.textAlign="center",o.style.opacity="0.5",o.style.outline="none",o.style.zIndex="999"}if("xr"in navigator)return n.id="VRButton",n.style.display="none",r(n),navigator.xr.isSessionSupported("immersive-vr").then(function(o){o?i():a(),o&&g.xrSessionIsGranted&&n.click()}).catch(d),n;{const o=document.createElement("a");return window.isSecureContext===!1?(o.href=document.location.href.replace(/^http:/,"https:"),o.innerHTML="WEBXR NEEDS HTTPS"):(o.href="https://immersiveweb.dev/",o.innerHTML="WEBXR NOT AVAILABLE"),o.style.left="calc(50% - 90px)",o.style.width="180px",o.style.textDecoration="none",r(o),o}}static registerSessionGrantedListener(){if(typeof navigator<"u"&&"xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",()=>{g.xrSessionIsGranted=!0})}}}g.xrSessionIsGranted=!1;g.registerSessionGrantedListener();const h={ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})};async function R(l){const e=await fetch(l);if(e.ok)return e.json();throw new Error(e.statusText)}async function _(l){if(!l)throw new Error("No basePath supplied");return await R(`${l}/profilesList.json`)}async function k(l,e,t=null,n=!0){if(!l)throw new Error("No xrInputSource supplied");if(!e)throw new Error("No basePath supplied");const i=await _(e);let s;if(l.profiles.some(r=>{const o=i[r];return o&&(s={profileId:r,profilePath:`${e}/${o.path}`,deprecated:!!o.deprecated}),!!s}),!s){if(!t)throw new Error("No matching profile name found");const r=i[t];if(!r)throw new Error(`No matching profile name found and default profile "${t}" missing.`);s={profileId:t,profilePath:`${e}/${r.path}`,deprecated:!!r.deprecated}}const a=await R(s.profilePath);let d;if(n){let r;if(l.handedness==="any"?r=a.layouts[Object.keys(a.layouts)[0]]:r=a.layouts[l.handedness],!r)throw new Error(`No matching handedness, ${l.handedness}, in profile ${s.profileId}`);r.assetPath&&(d=s.profilePath.replace("profile.json",r.assetPath))}return{profile:a,assetPath:d}}const B={xAxis:0,yAxis:0,button:0,state:h.ComponentState.DEFAULT};function U(l=0,e=0){let t=l,n=e;if(Math.sqrt(l*l+e*e)>1){const a=Math.atan2(e,l);t=Math.cos(a),n=Math.sin(a)}return{normalizedXAxis:t*.5+.5,normalizedYAxis:n*.5+.5}}class V{constructor(e){this.componentProperty=e.componentProperty,this.states=e.states,this.valueNodeName=e.valueNodeName,this.valueNodeProperty=e.valueNodeProperty,this.valueNodeProperty===h.VisualResponseProperty.TRANSFORM&&(this.minNodeName=e.minNodeName,this.maxNodeName=e.maxNodeName),this.value=0,this.updateFromComponent(B)}updateFromComponent({xAxis:e,yAxis:t,button:n,state:i}){const{normalizedXAxis:s,normalizedYAxis:a}=U(e,t);switch(this.componentProperty){case h.ComponentProperty.X_AXIS:this.value=this.states.includes(i)?s:.5;break;case h.ComponentProperty.Y_AXIS:this.value=this.states.includes(i)?a:.5;break;case h.ComponentProperty.BUTTON:this.value=this.states.includes(i)?n:0;break;case h.ComponentProperty.STATE:this.valueNodeProperty===h.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(i):this.value=this.states.includes(i)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}class G{constructor(e,t){if(!e||!t||!t.visualResponses||!t.gamepadIndices||Object.keys(t.gamepadIndices).length===0)throw new Error("Invalid arguments supplied");this.id=e,this.type=t.type,this.rootNodeName=t.rootNodeName,this.touchPointNodeName=t.touchPointNodeName,this.visualResponses={},Object.keys(t.visualResponses).forEach(n=>{const i=new V(t.visualResponses[n]);this.visualResponses[n]=i}),this.gamepadIndices=Object.assign({},t.gamepadIndices),this.values={state:h.ComponentState.DEFAULT,button:this.gamepadIndices.button!==void 0?0:void 0,xAxis:this.gamepadIndices.xAxis!==void 0?0:void 0,yAxis:this.gamepadIndices.yAxis!==void 0?0:void 0}}get data(){return{id:this.id,...this.values}}updateFromGamepad(e){if(this.values.state=h.ComponentState.DEFAULT,this.gamepadIndices.button!==void 0&&e.buttons.length>this.gamepadIndices.button){const t=e.buttons[this.gamepadIndices.button];this.values.button=t.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,t.pressed||this.values.button===1?this.values.state=h.ComponentState.PRESSED:(t.touched||this.values.button>h.ButtonTouchThreshold)&&(this.values.state=h.ComponentState.TOUCHED)}this.gamepadIndices.xAxis!==void 0&&e.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=e.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===h.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>h.AxisTouchThreshold&&(this.values.state=h.ComponentState.TOUCHED)),this.gamepadIndices.yAxis!==void 0&&e.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=e.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===h.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>h.AxisTouchThreshold&&(this.values.state=h.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach(t=>{t.updateFromComponent(this.values)})}}class H{constructor(e,t,n){if(!e)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No profile supplied");this.xrInputSource=e,this.assetUrl=n,this.id=t.profileId,this.layoutDescription=t.layouts[e.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach(i=>{const s=this.layoutDescription.components[i];this.components[i]=new G(i,s)}),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const e=[];return Object.values(this.components).forEach(t=>{e.push(t.data)}),e}updateFromGamepad(){Object.values(this.components).forEach(e=>{e.updateFromGamepad(this.xrInputSource.gamepad)})}}const{Mesh:$,MeshBasicMaterial:X,Object3D:D,SphereGeometry:z}=await y("three"),q="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",W="generic-trigger";class Y extends D{constructor(){super(),this.motionController=null,this.envMap=null}setEnvironmentMap(e){return this.envMap==e?this:(this.envMap=e,this.traverse(t=>{t.isMesh&&(t.material.envMap=this.envMap,t.material.needsUpdate=!0)}),this)}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&(this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach(t=>{Object.values(t.visualResponses).forEach(n=>{const{valueNode:i,minNode:s,maxNode:a,value:d,valueNodeProperty:r}=n;i&&(r===h.VisualResponseProperty.VISIBILITY?i.visible=d:r===h.VisualResponseProperty.TRANSFORM&&(i.quaternion.slerpQuaternions(s.quaternion,a.quaternion,d),i.position.lerpVectors(s.position,a.position,d)))})}))}}function J(l,e){Object.values(l.components).forEach(t=>{const{type:n,touchPointNodeName:i,visualResponses:s}=t;if(n===h.ComponentType.TOUCHPAD)if(t.touchPointNode=e.getObjectByName(i),t.touchPointNode){const a=new z(.001),d=new X({color:255}),r=new $(a,d);t.touchPointNode.add(r)}else console.warn(`Could not find touch dot, ${t.touchPointNodeName}, in touchpad component ${t.id}`);Object.values(s).forEach(a=>{const{valueNodeName:d,minNodeName:r,maxNodeName:o,valueNodeProperty:f}=a;if(f===h.VisualResponseProperty.TRANSFORM){if(a.minNode=e.getObjectByName(r),a.maxNode=e.getObjectByName(o),!a.minNode){console.warn(`Could not find ${r} in the model`);return}if(!a.maxNode){console.warn(`Could not find ${o} in the model`);return}}a.valueNode=e.getObjectByName(d),a.valueNode||console.warn(`Could not find ${d} in the model`)})})}function S(l,e){J(l.motionController,e),l.envMap&&e.traverse(t=>{t.isMesh&&(t.material.envMap=l.envMap,t.material.needsUpdate=!0)}),l.add(e)}class Q{constructor(e=null,t=null){this.gltfLoader=e,this.path=q,this._assetCache={},this.onLoad=t,this.gltfLoader||(this.gltfLoader=new j)}setPath(e){return this.path=e,this}createControllerModel(e){const t=new Y;let n=null;return e.addEventListener("connected",i=>{const s=i.data;s.targetRayMode!=="tracked-pointer"||!s.gamepad||s.hand||k(s,this.path,W).then(({profile:a,assetPath:d})=>{t.motionController=new H(s,a,d);const r=this._assetCache[t.motionController.assetUrl];if(r)n=r.scene.clone(),S(t,n),this.onLoad&&this.onLoad(n);else{if(!this.gltfLoader)throw new Error("GLTFLoader not set.");this.gltfLoader.setPath(""),this.gltfLoader.load(t.motionController.assetUrl,o=>{this._assetCache[t.motionController.assetUrl]=o,n=o.scene.clone(),S(t,n),this.onLoad&&this.onLoad(n)},null,()=>{throw new Error(`Asset ${t.motionController.assetUrl} missing or malformed.`)})}}).catch(a=>{console.warn(a)})}),e.addEventListener("disconnected",()=>{t.motionController=null,t.remove(n),n=null}),t}}const{DynamicDrawUsage:K,SphereGeometry:Z,BoxGeometry:ee,MeshStandardMaterial:te,InstancedMesh:ne,Matrix4:se,Vector3:oe}=await y("three"),M=new se,T=new oe;class L{constructor(e,t,n,i,s){this.controller=t,this.handModel=e,this.envMap=null;let a;!s||!s.primitive||s.primitive==="sphere"?a=new Z(1,10,10):s.primitive==="box"&&(a=new ee(1,1,1));const d=new te;this.handMesh=new ne(a,d,30),this.handMesh.frustumCulled=!1,this.handMesh.instanceMatrix.setUsage(K),this.handMesh.castShadow=!0,this.handMesh.receiveShadow=!0,this.handModel.add(this.handMesh),this.joints=["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]}updateMesh(){const t=this.controller.joints;let n=0;for(let i=0;i<this.joints.length;i++){const s=t[this.joints[i]];s.visible&&(T.setScalar(s.jointRadius||.008),M.compose(s.position,s.quaternion,T),this.handMesh.setMatrixAt(i,M),n++)}this.handMesh.count=n,this.handMesh.instanceMatrix.needsUpdate=!0}}const{Object3D:ie}=await y("three");class ae extends ie{constructor(e){super(),this.controller=e,this.motionController=null,this.envMap=null,this.mesh=null}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&this.motionController.updateMesh()}}class re{constructor(e=null,t=null){this.gltfLoader=e,this.path=null,this.onLoad=t}setPath(e){return this.path=e,this}createHandModel(e,t){const n=new ae(e);return e.addEventListener("connected",i=>{const s=i.data;s.hand&&!n.motionController&&(n.xrInputSource=s,t===void 0||t==="spheres"?n.motionController=new L(n,e,this.path,s.handedness,{primitive:"sphere"}):t==="boxes"?n.motionController=new L(n,e,this.path,s.handedness,{primitive:"box"}):t==="mesh"&&(n.motionController=new F(n,e,this.path,s.handedness,this.gltfLoader,this.onLoad))),e.visible=!0}),e.addEventListener("disconnected",()=>{e.visible=!1}),n}}const{defineComponent:le}=await y("vue"),{unref:m,renderSlot:P,createElementVNode:x,Fragment:de,openBlock:he,createElementBlock:ce}=await y("vue"),ue=["object"],pe=["geometry"],fe=["object"],me=["geometry"],xe=["object"],ge=["object"],ye=["object"],ve=["object"],b=await y("three"),Ne=le({__name:"XRcom",props:{sessionInit:{default:{requiredFeatures:["hand-tracking"]}}},setup(l,{expose:e}){const t=l,{renderer:n,camera:i,scene:s}=I();n.xr.enabled=!0;const a=g.createButton(n,t.sessionInit);a.style.zIndex="999999",document.body.appendChild(a);const d=n.xr.getController(0),r=n.xr.getController(1),o=new Q,f=new re,p=n.xr.getControllerGrip(0);p.add(o.createControllerModel(p));const c=n.xr.getHand(0);c.add(f.createHandModel(c));const u=n.xr.getControllerGrip(1);u.add(o.createControllerModel(u));const v=n.xr.getHand(1);v.add(f.createHandModel(v));const w=new b.BufferGeometry().setFromPoints([new b.Vector3(0,0,0),new b.Vector3(0,0,-1)]),E=C(),N=C();return n.setAnimationLoop(()=>{E.trigger(),n.render(s.value,i.value),N.trigger()}),e({controller0:d,controller1:r,onBeforeLoop:E.on,onAfterLoop:N.on}),(A,be)=>(he(),ce(de,null,[x("primitive",{object:m(d)},[P(A.$slots,"controller0",{},()=>[x("TresLine",{scale:[1,1,5],geometry:m(w)},null,8,pe)])],8,ue),x("primitive",{object:m(r)},[P(A.$slots,"controller1",{},()=>[x("TresLine",{scale:[1,1,5],geometry:m(w)},null,8,me)])],8,fe),x("primitive",{object:m(p)},null,8,xe),x("primitive",{object:m(c)},null,8,ge),x("primitive",{object:m(u)},null,8,ye),x("primitive",{object:m(v)},null,8,ve)],64))}});export{Ne as _sfc_main};
