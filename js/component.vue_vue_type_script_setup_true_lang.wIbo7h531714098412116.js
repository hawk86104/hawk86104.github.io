var ee=Object.defineProperty;var ae=(b,l,t)=>l in b?ee(b,l,{enumerable:!0,configurable:!0,writable:!0,value:t}):b[l]=t;var $=(b,l,t)=>(ae(b,typeof l!="symbol"?l+"":l,t),t);import{bV as re,aF as te,aw as ne,bW as oe,bm as x,at as V,bX as C,aI as z,ak as J,bY as se,l as U,v as O,bZ as ie,w as F,b_ as Y,L as D,b$ as le,c0 as W,a1 as ue,aQ as ce,aD as de,o as _e,c as me,a0 as pe,Z as he,a9 as ve,c1 as X,c2 as Z,c3 as ge,c4 as j,aC as q,c5 as fe}from"./vendor.33RuSNcm1714098412116.js";class Ee extends re{constructor(){super();$(this,"virtualScene",null);this.virtualScene=new te}add(...t){return this.virtualScene.add(...t),this}destructor(){this.virtualScene.traverse(t=>{t instanceof ne&&(t.geometry.dispose(),t.material.dispose(),t.material.map&&t.material.map.dispose(),this.virtualScene.remove(t))}),this.virtualScene=null}}class Q extends oe{constructor(l){super(l),this.type=x}parse(l){const h=function(e,n){switch(e){case 1:console.error("THREE.RGBELoader Read Error: "+(n||""));break;case 2:console.error("THREE.RGBELoader Write Error: "+(n||""));break;case 3:console.error("THREE.RGBELoader Bad File Format: "+(n||""));break;default:case 4:console.error("THREE.RGBELoader: Error: "+(n||""))}return-1},f="\n",u=function(e,n,d){n=n||1024;let c=e.pos,s=-1,a=0,_="",r=String.fromCharCode.apply(null,new Uint16Array(e.subarray(c,c+128)));for(;0>(s=r.indexOf(f))&&a<n&&c<e.byteLength;)_+=r,a+=r.length,c+=128,r+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(c,c+128)));return-1<s?(d!==!1&&(e.pos+=a+s+1),_+r.slice(0,s)):!1},w=function(e){const n=/^#\?(\S+)/,d=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,i=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,c=/^\s*FORMAT=(\S+)\s*$/,s=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,a={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let _,r;if(e.pos>=e.byteLength||!(_=u(e)))return h(1,"no header found");if(!(r=_.match(n)))return h(3,"bad initial token");for(a.valid|=1,a.programtype=r[1],a.string+=_+"\n";_=u(e),_!==!1;){if(a.string+=_+"\n",_.charAt(0)==="#"){a.comments+=_+"\n";continue}if((r=_.match(d))&&(a.gamma=parseFloat(r[1])),(r=_.match(i))&&(a.exposure=parseFloat(r[1])),(r=_.match(c))&&(a.valid|=2,a.format=r[1]),(r=_.match(s))&&(a.valid|=4,a.height=parseInt(r[1],10),a.width=parseInt(r[2],10)),a.valid&2&&a.valid&4)break}return a.valid&2?a.valid&4?a:h(3,"missing image size specifier"):h(3,"missing format specifier")},R=function(e,n,d){const i=n;if(i<8||i>32767||e[0]!==2||e[1]!==2||e[2]&128)return new Uint8Array(e);if(i!==(e[2]<<8|e[3]))return h(3,"wrong scanline width");const c=new Uint8Array(4*n*d);if(!c.length)return h(4,"unable to allocate buffer space");let s=0,a=0;const _=4*i,r=new Uint8Array(4),I=new Uint8Array(_);let H=d;for(;H>0&&a<e.byteLength;){if(a+4>e.byteLength)return h(1);if(r[0]=e[a++],r[1]=e[a++],r[2]=e[a++],r[3]=e[a++],r[0]!=2||r[1]!=2||(r[2]<<8|r[3])!=i)return h(3,"bad rgbe scanline format");let M=0,S;for(;M<_&&a<e.byteLength;){S=e[a++];const B=S>128;if(B&&(S-=128),S===0||M+S>_)return h(3,"bad scanline data");if(B){const G=e[a++];for(let P=0;P<S;P++)I[M++]=G}else I.set(e.subarray(a,a+S),M),M+=S,a+=S}const K=i;for(let B=0;B<K;B++){let G=0;c[s]=I[B+G],G+=i,c[s+1]=I[B+G],G+=i,c[s+2]=I[B+G],G+=i,c[s+3]=I[B+G],s+=4}H--}return c},v=function(e,n,d,i){const c=e[n+3],s=Math.pow(2,c-128)/255;d[i+0]=e[n+0]*s,d[i+1]=e[n+1]*s,d[i+2]=e[n+2]*s,d[i+3]=1},L=function(e,n,d,i){const c=e[n+3],s=Math.pow(2,c-128)/255;d[i+0]=C.toHalfFloat(Math.min(e[n+0]*s,65504)),d[i+1]=C.toHalfFloat(Math.min(e[n+1]*s,65504)),d[i+2]=C.toHalfFloat(Math.min(e[n+2]*s,65504)),d[i+3]=C.toHalfFloat(1)},p=new Uint8Array(l);p.pos=0;const g=w(p);if(g!==-1){const e=g.width,n=g.height,d=R(p.subarray(p.pos),e,n);if(d!==-1){let i,c,s;switch(this.type){case V:s=d.length/4;const a=new Float32Array(s*4);for(let r=0;r<s;r++)v(d,r*4,a,r*4);i=a,c=V;break;case x:s=d.length/4;const _=new Uint16Array(s*4);for(let r=0;r<s;r++)L(d,r*4,_,r*4);i=_,c=x;break;default:console.error("THREE.RGBELoader: unsupported type: ",this.type);break}return{width:e,height:n,data:i,header:g.string,gamma:g.gamma,exposure:g.exposure,type:c}}}return null}setDataType(l){return this.type=l,this}load(l,t,T,m){function A(E,h){switch(E.type){case V:case x:"colorSpace"in E?E.colorSpace="srgb-linear":E.encoding=3e3,E.minFilter=z,E.magFilter=z,E.generateMipmaps=!1,E.flipY=!0;break}t&&t(E,h)}return super.load(l,A,T,m)}}const N={sunset:"venice/venice_sunset_1k.hdr",studio:"studio/poly_haven_studio_1k.hdr",city:"city/canary_wharf_1k.hdr",umbrellas:"outdoor/outdoor_umbrellas_1k.hdr",night:"outdoor/satara_night_1k.hdr",forest:"outood/mossy_forest_1k.hdr",snow:"outdoor/snowy_forest_path_01_1k.hdr",dawn:"kiara/kiara_1_dawn_1k.hdr",hangar:"indoor/small_hangar_01_1k.hdr",urban:"indoor/abandoned_games_room_02_1k.hdr",modern:"city/modern_buildings_2_1k.hdr",shangai:"city/shanghai_bund_1k.hdr"},ye="https://raw.githubusercontent.com/Tresjs/assets/main/textures/hdr/";async function Re(b,l){const{scene:t}=J(),{preset:T,blur:m,files:A=[],path:E="",background:h}=se(b),y=U(),k=O(()=>Array.isArray(A.value)),o=O(()=>k.value?ie:Q),f=U(null);return F(()=>[A,E],async([u,w])=>{if(u.value.length>0&&!T.value){try{f.value=await Y(D(o),k.value?[D(u)]:D(u),R=>{w.value&&R.setPath(D(w))})}catch(R){throw new Error("Failed to load environment map: ".concat(R))}f.value&&(y.value=k.value?f.value[0]:f.value,y.value.mapping=k.value?le:W)}},{immediate:!0}),F(()=>y.value,u=>{t.value&&(t.value.environment=u)},{immediate:!0}),F(()=>[h.value,y.value],([u,w])=>{if(t.value){let R=l!=null&&l.value?l.value.texture:w,v=t.value.background;v!=null&&v.isColor||(v=void 0),t.value.background=u?R:v}},{immediate:!0}),F(()=>m==null?void 0:m.value,u=>{t.value&&(t.value.backgroundBlurriness=u)},{immediate:!0}),F(T,async u=>{if(u&&u in N){const w=ye,R=N[u];try{f.value=await Y(Q,R,v=>{w&&v.setPath(w)})}catch(v){throw new Error("Failed to load environment map: ".concat(v))}f.value&&(y.value=f.value,y.value.mapping=W)}else if(u&&!(u in N))throw new Error("Preset must be one of: ".concat(Object.keys(N).join(", ")))},{immediate:!0}),{texture:y}}const ke=ue({__name:"component",props:{background:{type:[Boolean,String],default:!1},blur:{default:0},files:{default:[]},path:{default:""},preset:{default:void 0},resolution:{default:256},near:{default:1},far:{default:1e3},frames:{default:1/0},useDefaultScene:{type:Boolean,default:!1}},async setup(b,{expose:l}){let t,T;const m=b,A=U(null);l({texture:A});const{extend:E,renderer:h,scene:y}=J();let k=null,o=U(null),f=null;const u=U(null);ce(()=>{var p,g;(p=u.value)==null||p.destructor(),(g=o.value)==null||g.dispose()});const{onBeforeLoop:w}=ve();let R=1;w(()=>{f&&u.value&&o.value&&(m.frames===1/0||R<m.frames)&&(m.useDefaultScene?f.update(h.value,y.value):f.update(h.value,fe(u.value.virtualScene)),R++)});const v=([t,T]=de(()=>Re(m,o)),t=await t,T(),t).texture,L=p=>{p?(y.value.environment=p.texture,m.background&&(y.value.background=p.texture)):(y.value.environment=v.value,m.background&&(y.value.background=v.value))};return F(v,p=>{o.value&&L(o.value)},{immediate:!0,deep:!0}),E({EnvSence:Ee}),F(()=>ge().default,p=>{var g,e,n;if(p&&(!o.value||o.value.texture.type!==x)&&(k=p(),Array.isArray(k)&&k.length>0&&typeof((g=k[0])==null?void 0:g.type)!="symbol")){(e=o.value)==null||e.dispose(),o.value=new X(m.resolution),o.value.texture.type=x,f=new Z(m.near,m.far,o.value),L(o.value);return}(n=o.value)==null||n.dispose(),o.value=null,L(null)},{immediate:!0,deep:!0}),A.value=v,F(()=>m.useDefaultScene,p=>{var g;p&&(!o.value||o.value.texture.type!==j)&&((g=o.value)==null||g.dispose(),o.value=new X(m.resolution),f=new Z(m.near,m.far,o.value),o.value.texture.type=j,o.value.texture.generateMipmaps=!1,o.value.texture.minFilter=q,o.value.texture.magFilter=q,L(o.value))},{immediate:!0}),(p,g)=>D(o)?(_e(),me("TresEnvSence",{key:0,ref_key:"envSence",ref:u},[pe(p.$slots,"default")],512)):he("",!0)}});export{ke as _};
