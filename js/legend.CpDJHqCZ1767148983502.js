import{importShared as R,GLTFLoader as ee}from"./3d-tiles-renderer.DZNovkLO1767148983502.js";import{Fs as te,_l as oe,Kk as ne,_export_sfc as ae}from"./index.DTe2qqjO1767148983502.js";const{defineComponent:se}=await R("vue"),{onMounted:ie,ref:b,watch:re,nextTick:le,markRaw:x}=await R("vue"),t=await R("three"),ce=se({__name:"legend",props:{deviceConfig:{},title:{default:"SYSTEM MONITOR"},panelPosition:{default:()=>({top:"20px",right:"20px"})},panelWidth:{default:"220px"},statusDotColor:{default:"#0f0"},sceneBackground:{default:1710618},sceneFogColor:{default:1710618},sceneFogRange:{default:()=>[10,30]},groundColor:{default:1381653},groundSize:{default:()=>[30,30]},gridSize:{default:30},gridDivisions:{default:30},gridColor1:{default:5592405},gridColor2:{default:2236962},ambientLightIntensity:{default:.8},directionalLightIntensity:{default:1.2},directionalLightPosition:{default:()=>[5,15,7]},fillLightIntensity:{default:.3},fillLightPosition:{default:()=>[-5,5,-5]},cameraInitialPosition:{default:()=>[0,5,10]},legendCameraPosition:{default:()=>[2,1.5,2.5]},legendCameraLookAt:{default:()=>[0,0,0]},legendCameraFov:{default:50},autoRotateSpeed:{default:.5},cameraMoveLerp:{default:.05},cameraFocusOffset:{default:()=>[0,3,5]},deviceRotationSpeed:{default:.01},pulseBaseIntensity:{default:.3},pulseRange:{default:1.5},pulseFrequency:{default:3}},setup(z,{expose:P}){const n=z,T=te(),{camera:v,renderer:m,scene:u,controls:y}=T,{onRender:A}=oe(),c=new t.Clock,h=b([]),S=b([]),g=b(null),k=b(new t.Vector3),V=b(new t.Vector3),B=b(!1),U=a=>new t.MeshStandardMaterial({color:5592405,emissive:a,emissiveIntensity:.5,roughness:.3,metalness:.8}),W=a=>{const o=new t.Group,e=new t.Mesh(new t.BoxGeometry(1.2,1.2,1.2),a);o.add(e);const i=new t.Mesh(new t.BoxGeometry(1.4,1.4,1.4),new t.MeshBasicMaterial({color:a.emissive.getHex(),wireframe:!0,transparent:!0,opacity:.15}));return o.add(i),o},K=a=>{const o=new t.Group,e=new t.Mesh(new t.IcosahedronGeometry(.7,1),a);o.add(e);const i=new t.Mesh(new t.TorusGeometry(1,.05,6,30),new t.MeshBasicMaterial({color:a.emissive.getHex(),transparent:!0,opacity:.5}));return i.rotation.x=Math.PI/2,o.add(i),o},Y=a=>{const o=new t.Group,e=new t.Mesh(new t.ConeGeometry(.6,1.5,6),a);e.position.y=.2,o.add(e);const i=new t.Mesh(new t.CylinderGeometry(.8,.8,.1,6),a);return i.position.y=-.6,o.add(i),o},G=a=>new Promise((o,e)=>{if(a.type==="model"&&a.modelUrl){new ee().load(a.modelUrl,s=>{const l=s.scene,p=a.modelScale||1;l.scale.set(p,p,p),o(l)},void 0,e);return}const i=U(a.color);let d;a.type==="cube"?d=W(i):a.type==="sphere"?d=K(i):d=Y(i),o(d)}),N=async()=>{const a=n.deviceConfig.map(async o=>{try{const e=await G(o),i=[];e.traverse(r=>{if(r instanceof t.Mesh){r.castShadow=!0,r.receiveShadow=!0;const s=r.material;(Array.isArray(s)?s:[s]).forEach(p=>{p instanceof t.MeshStandardMaterial&&(!p.emissive||!(p.emissive instanceof t.Color)?p.emissive=new t.Color(o.color):p.emissive.set(o.color),p.emissiveIntensity=.5,i.push(x(p)))})}}),e.position.set(...o.position),u.value&&u.value.add(x(e));const d=new t.Vector3(...o.position);h.value.push({config:o,materials:i,mainMesh:x(e),originalPosition:d,anchorId:`anchor-${o.id}`})}catch(e){console.error(`加载模型 ${o.id} 失败`,e)}});await Promise.all(a)},Z=()=>{if(!u.value||!m||!v.value)return;typeof n.sceneBackground=="number"?u.value.background=new t.Color(n.sceneBackground):u.value.background=new t.Color(n.sceneBackground),typeof n.sceneFogColor=="number"?u.value.fog=new t.Fog(n.sceneFogColor,n.sceneFogRange[0],n.sceneFogRange[1]):u.value.fog=new t.Fog(new t.Color(n.sceneFogColor),n.sceneFogRange[0],n.sceneFogRange[1]),m.shadowMap&&(m.shadowMap.enabled=!0,m.shadowMap.type=t.PCFSoftShadowMap);const a=new t.PlaneGeometry(...n.groundSize),o=new t.MeshStandardMaterial({color:n.groundColor,metalness:.1,roughness:.8}),e=new t.Mesh(a,o);e.rotation.x=-Math.PI/2,e.receiveShadow=!0,u.value.add(e),S.value.push(e);const i=new t.GridHelper(n.gridSize,n.gridDivisions,n.gridColor1,n.gridColor2);u.value.add(i),S.value.push(i);const d=new t.AmbientLight(16777215,n.ambientLightIntensity);u.value.add(d);const r=new t.DirectionalLight(16777215,n.directionalLightIntensity);r.position.set(...n.directionalLightPosition),r.castShadow=!0,r.shadow.mapSize.width=2048,r.shadow.mapSize.height=2048,r.shadow.camera.near=.5,r.shadow.camera.far=50,r.shadow.camera.left=-15,r.shadow.camera.right=15,r.shadow.camera.top=15,r.shadow.camera.bottom=-15,u.value.add(r);const s=new t.PointLight(16777215,n.fillLightIntensity,20);if(s.position.set(...n.fillLightPosition),u.value.add(s),v.value instanceof t.PerspectiveCamera&&v.value.position.set(...n.cameraInitialPosition),y.value){const l=y.value;"autoRotate"in l&&(l.autoRotate=!0,l.autoRotateSpeed=n.autoRotateSpeed)}g.value=new t.PerspectiveCamera(n.legendCameraFov,1,.1,50),g.value.position.set(...n.legendCameraPosition),g.value.lookAt(...n.legendCameraLookAt)},Q=a=>{if(!v.value||!y.value)return;const o=y.value;"autoRotate"in o&&(o.autoRotate=!1);const e=new t.Vector3(...n.cameraFocusOffset),i=a.clone().add(e);V.value.copy(a),k.value.copy(i),B.value=!0,"enableDamping"in o&&(o.enableDamping=!0,o.dampingFactor=.05)},X=a=>{const o=h.value.find(e=>e.config.id===a);o&&Q(o.mainMesh.position)},j=()=>{if(!m||!u.value||!v.value||!g.value)return;const a=c.getElapsedTime();if(B.value&&v.value instanceof t.PerspectiveCamera&&y.value){const e=y.value;v.value.position.lerp(k.value,n.cameraMoveLerp),"target"in e&&e.target instanceof t.Vector3&&e.target.lerp(V.value,n.cameraMoveLerp),v.value.position.distanceTo(k.value)<.01&&(v.value.position.copy(k.value),"target"in e&&e.target instanceof t.Vector3&&e.target.copy(V.value),B.value=!1,"autoRotate"in e&&(e.autoRotate=!0),"dampingFactor"in e&&(e.dampingFactor=.005))}if(h.value.forEach(e=>{const i=e.config.speed||1,d=(Math.sin(a*n.pulseFrequency*i)+1)*.5;e.materials.forEach(r=>{r.emissiveIntensity=n.pulseBaseIntensity+d*n.pulseRange}),e.mainMesh.rotation.y+=n.deviceRotationSpeed*i}),y.value){const e=y.value;"update"in e&&typeof e.update=="function"&&e.update()}const o=m.getDrawingBufferSize(new t.Vector2);m.setViewport(0,0,o.x,o.y),m.setScissor(0,0,o.x,o.y),m.setScissorTest(!1),m.clear(),m.render(u.value,v.value),m.setScissorTest(!0),m.clearDepth(),h.value.forEach(e=>{const i=document.getElementById(e.anchorId);if(!i)return;const d=i.getBoundingClientRect(),r=m.getPixelRatio();if(d.bottom<0||d.top>window.innerHeight)return;const s=e.mainMesh.position.clone(),l=[];h.value.forEach(f=>{l.push(f.mainMesh.visible),f!==e&&(f.mainMesh.visible=!1)});const p=[];S.value.forEach(f=>{p.push(f.visible),f.visible=!1}),e.mainMesh.position.set(0,0,0),e.mainMesh.visible=!0;const _=d.width*r,C=d.height*r,M=d.left*r,I=(window.innerHeight-d.bottom)*r;m.setScissor(M,I,_,C),m.setViewport(M,I,_,C),m.render(u.value,g.value),e.mainMesh.position.copy(s),h.value.forEach((f,D)=>{f.mainMesh.visible=l[D]}),S.value.forEach((f,D)=>{f.visible=p[D]})}),m.setScissorTest(!1)};return ie(async()=>{await le(),Z(),await N(),A(j)}),re(()=>n.deviceConfig,async(a,o)=>{if(!o||o.length===0){await N();return}const e=new Set(h.value.map(s=>s.config.id)),i=a.filter(s=>!e.has(s.id));if(i.length>0)for(const s of i)try{const l=await G(s),p=[];l.traverse(C=>{if(C instanceof t.Mesh){C.castShadow=!0,C.receiveShadow=!0;const M=C.material;(Array.isArray(M)?M:[M]).forEach(f=>{f instanceof t.MeshStandardMaterial&&(!f.emissive||!(f.emissive instanceof t.Color)?f.emissive=new t.Color(s.color):f.emissive.set(s.color),f.emissiveIntensity=.5,p.push(x(f)))})}}),l.position.set(...s.position),u.value&&u.value.add(x(l));const _=new t.Vector3(...s.position);h.value.push({config:s,materials:p,mainMesh:x(l),originalPosition:_,anchorId:`anchor-${s.id}`})}catch(l){console.error(`加载模型 ${s.id} 失败`,l)}const d=new Set(a.map(s=>s.id)),r=h.value.filter(s=>!d.has(s.config.id));r.length>0&&(r.forEach(s=>{u.value&&(u.value.remove(s.mainMesh),s.mainMesh.traverse(l=>{l instanceof t.Mesh&&(l.geometry&&l.geometry.dispose(),l.material&&(Array.isArray(l.material)?l.material.forEach(p=>p.dispose()):l.material.dispose()))}))}),h.value=h.value.filter(s=>d.has(s.config.id)))},{deep:!0}),P({handleDeviceClick:X,addRandomMesh:()=>{const a={box:"cube",sphere:"sphere",cone:"cone",cylinder:"cube",torus:"cube",octahedron:"sphere",tetrahedron:"cone"},o=["box","sphere","cone","cylinder","torus","octahedron","tetrahedron"],e=o[Math.floor(Math.random()*o.length)],i=a[e]||"cube",d=(Math.random()-.5)*15,r=Math.random()*3+.5,s=(Math.random()-.5)*15,l=[65535,16711765,4521728,16755200,11141375,65450,16711850],p=l[Math.floor(Math.random()*l.length)],_=`random-mesh-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,M={box:"立方体",sphere:"球体",cone:"圆锥",cylinder:"圆柱",torus:"圆环",octahedron:"八面体",tetrahedron:"四面体"}[e]||"形状";return{id:_,name:M,type:i,color:p,position:[d,r,s],speed:.5+Math.random()*1.5,author:"随机生成"}}}),(a,o)=>null}}),{defineComponent:de}=await R("vue"),{toDisplayString:E,createElementVNode:w,renderList:ue,Fragment:pe,openBlock:F,createElementBlock:L,createTextVNode:me,normalizeStyle:H,createCommentVNode:he,unref:fe,normalizeProps:ve,guardReactiveProps:ge,createVNode:$,Suspense:we,withCtx:O,createBlock:ye,resolveComponent:Ce,mergeProps:Me}=await R("vue"),Se={class:"legend-container"},_e={class:"legend-list"},be=["id","onClick"],xe=["id"],Re={class:"legend-info"},Pe={class:"item-name"},ke={class:"item-status"},Fe={class:"item-value"},{reactive:J,ref:q,computed:Ie}=await R("vue"),Le="图例",Te="220px",Ae=de({__name:"legend",setup(z){const P=q([{id:"core-reactor",name:"T",type:"cube",color:65535,position:[0,0,0],speed:1,author:"Jsonco"},{id:"sensor-array",name:"V",type:"sphere",color:16711765,position:[-4,0,2],speed:1.5,author:"Jsonco"},{id:"storage-unit",name:"T",type:"cone",color:4521728,position:[4,0,-2],speed:.8,author:"Jsonco"}]),n=J({windowSize:!0,alpha:!0,antialias:!0}),T=J({enableDamping:!0,enableZoom:!0,enablePan:!0,enableRotate:!0,makeDefault:!0,autoRotate:!0,autoRotateSpeed:.5}),v=q(null),m={top:"20px",right:"20px"},u=Ie(()=>{const c=m||{};return{top:c&&typeof c.top=="number"?`${c.top}px`:c?.top||"20px",right:c&&typeof c.right=="number"?`${c.right}px`:c?.right||"20px",bottom:c&&typeof c.bottom=="number"?`${c.bottom}px`:c?.bottom||void 0,left:c&&typeof c.left=="number"?`${c.left}px`:c?.left||void 0,width:Te}}),y=c=>{v.value&&v.value.handleDeviceClick(c)},A=()=>{if(v.value){const c=v.value.addRandomMesh();c&&P.value.push(c)}};return(c,h)=>{const S=Ce("TresCanvas");return F(),L("div",Se,[w("div",{class:"legend-panel",style:H(u.value)},[w("div",{class:"legend-header"},[w("span",{class:"legend-title"},E(Le)),w("button",{class:"add-mesh-btn",onClick:A},[...h[0]||(h[0]=[w("span",{class:"btn-icon"},"+",-1),w("span",{class:"btn-text"},"添加随机形状",-1)])])]),w("div",_e,[(F(!0),L(pe,null,ue(P.value,g=>(F(),L("div",{key:g.id,id:`item-${g.id}`,class:"legend-item",onClick:k=>y(g.id)},[w("div",{id:`anchor-${g.id}`,class:"legend-icon-anchor"},null,8,xe),w("div",Re,[w("span",Pe,E(g.name),1),w("span",ke,[h[1]||(h[1]=me(" Author: ",-1)),w("span",Fe,E(g.author),1)])]),g.color?(F(),L("div",{key:0,class:"corner-deco",style:H({borderColor:`#${g.color.toString(16).padStart(6,"0")}`})},null,4)):he("",!0)],8,be))),128))])],4),$(S,Me({clearColor:"#1A1A1A"},n),{default:O(()=>[h[2]||(h[2]=w("TresPerspectiveCamera",{fov:60,near:.1,far:1e3,position:[0,5,10]},null,-1)),h[3]||(h[3]=w("TresAmbientLight",{intensity:.8},null,-1)),$(fe(ne),ve(ge(T)),null,16),(F(),ye(we,null,{default:O(()=>[$(ce,{ref_key:"legendRef",ref:v,"device-config":P.value},null,8,["device-config"])]),_:1}))]),_:1},16)])}}}),Ee=ae(Ae,[["__scopeId","data-v-bd9b39fa"]]);export{Ee as default};
