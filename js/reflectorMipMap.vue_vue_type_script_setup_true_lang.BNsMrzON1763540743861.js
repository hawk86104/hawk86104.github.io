import{F as e,_ as t}from"./@tresjs.BCHtwiaC1763540743861.js";import{P as n,p as r}from"./index.Crdf3MNx1763540743861.js";import{d as o}from"./@vue.Co_gxueH1763540743861.js";import{P as a,M as s,d as l,U as i,V as p,Q as u,A as d}from"./three.rXKzP9fQ1763540743861.js";const m=o({__name:"reflectorMipMap",props:{parent:{},resolution:{default:512},ignoreObjects:{default:[]}},setup(o,{expose:m}){const c=o,g=new a,w=new s,x=new l,y=new n,f=r({width:c.resolution,height:c.resolution,settings:{type:i}}),v=r({width:c.resolution,height:c.resolution,settings:{type:i}}),{camera:h,renderer:j,scene:M}=e(),{onBeforeRender:W}=t();return W(()=>{(()=>{if(!h.value)return;g.set(new p(0,1,0),0),g.applyMatrix4(c.parent.matrixWorld),x.copy(h.value);const e=new p(0,0,1).clone().negate(),t=h.value.getWorldPosition(new p);e.reflect(g.normal);const n=new p;g.projectPoint(t,n);const r=n.clone();r.sub(t),r.add(n),x.position.copy(r);const o=new p(0,0,-1);o.applyQuaternion(h.value.getWorldQuaternion(new u)),o.add(t);const a=new p;c.parent.getWorldPosition(a),a.sub(o),a.reflect(g.normal).negate(),a.add(c.parent.getWorldPosition(new p)),x.up.set(0,1,0),x.applyQuaternion(h.value.getWorldQuaternion(new u)),x.up.reflect(g.normal),x.lookAt(a),x.updateMatrixWorld();const l=new s;l.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),l.multiply(x.projectionMatrix),l.multiply(x.matrixWorldInverse),w.copy(l),g.applyMatrix4(x.matrixWorldInverse);const i=new d(g.normal.x,g.normal.y,g.normal.z,g.constant),m=x.projectionMatrix,y=new d;y.x=(Math.sign(i.x)+m.elements[8])/m.elements[0],y.y=(Math.sign(i.y)+m.elements[9])/m.elements[5],y.z=-1,y.w=(1+m.elements[10])/m.elements[14],i.multiplyScalar(2/i.dot(y)),m.elements[2]=i.x,m.elements[6]=i.y,m.elements[10]=i.z+1,m.elements[14]=i.w;const v=j.getRenderTarget();j.setRenderTarget(f.value),j.state.buffers.depth.setMask(!0),!1===j.autoClear&&j.clear(),c.ignoreObjects.forEach(e=>e.visible=!1),j.render(M.value,x),c.ignoreObjects.forEach(e=>e.visible=!0),j.setRenderTarget(v)})(),f.value&&v.value&&j&&y.update(f.value.texture,v.value,j)}),m({matrix:w,renderTarget:v}),(e,t)=>null}});export{m as _};
