import{M as e,D as t,G as s,P as n,V as r,B as i,a,C as o,b as l,I as c,Q as h,c as d,R as u,d as p,e as m,f as g,S as f,g as _,E as b,h as y,i as w,F as T,j as x,_ as C,k as S,l as v,L as P}from"./three.3esZ7Hzr1726652192279.js";function E(e){let t;try{t=new URL(e,"http://fakehost.com/")}catch(r){return null}const s=t.pathname.split("/").pop(),n=s.lastIndexOf(".");if(-1===n||n===s.length-1)return null;return s.substring(n+1)}class R{get unloadPriorityCallback(){return this._unloadPriorityCallback}set unloadPriorityCallback(e){1===e.length?(console.warn('LRUCache: "unloadPriorityCallback" function has been changed to take two arguments.'),this._unloadPriorityCallback=(t,s)=>{const n=e(t),r=e(s);return n<r?-1:n>r?1:0}):this._unloadPriorityCallback=e}constructor(){this.maxSize=800,this.minSize=600,this.minBytesSize=322122547.2,this.maxBytesSize=429496729.6,this.unloadPercent=.05,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.markUnusedQueued=!1,this.unloadingHandle=-1,this.cachedBytes=0,this.bytesMap=new Map,this._unloadPriorityCallback=null,this.getMemoryUsageCallback=()=>0;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize||this.cachedBytes>=this.maxBytesSize}add(e,t){this.markUnusedQueued&&this.markAllUnused();const s=this.itemSet;if(s.has(e))return!1;if(this.isFull())return!1;const n=this.usedSet,r=this.itemList,i=this.callbacks,a=this.bytesMap;r.push(e),n.add(e),s.set(e,Date.now()),i.set(e,t);const o=this.getMemoryUsageCallback(e);return this.cachedBytes+=o,a.set(e,o),!0}remove(e){const t=this.usedSet,s=this.itemSet,n=this.itemList,r=this.bytesMap,i=this.callbacks;if(s.has(e)){this.cachedBytes-=r.get(e),r.delete(e),i.get(e)(e);const a=n.indexOf(e);return n.splice(a,1),t.delete(e),s.delete(e),i.delete(e),!0}return!1}updateMemoryUsage(e){const t=this.itemSet,s=this.bytesMap;if(!t.has(e))return;this.cachedBytes-=s.get(e);const n=this.getMemoryUsageCallback(e);s.set(e,n),this.cachedBytes+=n}markUsed(e){this.markUnusedQueued&&this.markAllUnused();const t=this.itemSet,s=this.usedSet;t.has(e)&&!s.has(e)&&(t.set(e,Date.now()),s.add(e))}markAllUnused(){this.usedSet.clear(),this.markUnusedQueued=!1,-1!==this.unloadingHandle&&(cancelAnimationFrame(this.unloadingHandle),this.unloadingHandle=-1)}unloadUnusedContent(){const{unloadPercent:e,minSize:t,maxSize:s,itemList:n,itemSet:r,usedSet:i,callbacks:a,bytesMap:o,minBytesSize:l,maxBytesSize:c}=this,h=n.length-i.size,d=Math.max(Math.min(n.length-t,h),0),u=this.cachedBytes-l,p=this.unloadPriorityCallback||this.defaultPriorityCallback;let m=d;const g=d>0&&h>0||n.length>s;if(h&&this.cachedBytes>l||this.cachedBytes>c||g){n.sort(((e,t)=>{const s=i.has(e),n=i.has(t);return s&&n?0:s||n?s?1:-1:-p(e,t)}));const g=Math.max(t*e,d*e),f=Math.ceil(Math.min(g,h,d)),_=Math.max(e*u,e*l),b=Math.min(_,u);let y=0,w=0;for(;;){const e=n[y],t=o.get(e);if(!(y<f||w<b||this.cachedBytes-w-t>c||n.length-y>s)||y>=h&&this.cachedBytes-w-t<=c&&n.length-y<=s)break;w+=t,y++,o.delete(e),a.get(e)(e),r.delete(e),a.delete(e)}n.splice(0,y),this.cachedBytes-=w,m=y<d||w<u&&y<h}m&&(this.unloadingHandle=requestAnimationFrame((()=>this.scheduleUnload())))}scheduleUnload(){this.scheduled||(this.scheduled=!0,queueMicrotask((()=>{this.scheduled=!1,this.unloadUnusedContent(),this.markUnusedQueued=!0})))}}class A{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise(((s,n)=>{const r=this.items,i=this.callbacks;r.push(e),i.set(e,((...e)=>t(...e).then(s).catch(n))),this.autoUpdate&&this.scheduleJobRun()}))}remove(e){const t=this.items,s=this.callbacks,n=t.indexOf(e);-1!==n&&(t.splice(n,1),s.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,s=this.maxJobs;let n=this.currJobs;for(;s>n&&e.length>0;){n++;const s=e.pop(),r=t.get(s);t.delete(s),r(s).then((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})).catch((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}))}this.currJobs=n}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const U=3,M=4,F=6378137;function L(e){return e===U||e===M}function k(e,t){return e.__lastFrameVisited===t&&e.__used}function O(e,t){e.__lastFrameVisited!==t.frameCount&&(e.__lastFrameVisited=t.frameCount,e.__used=!1,e.__inFrustum=!1,e.__isLeaf=!1,e.__visible=!1,e.__active=!1,e.__error=1/0,e.__distanceFromCamera=1/0,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__inFrustum=t.tileInView(e),t.calculateError(e))}function I(e,t){if(t.ensureChildrenArePreprocessed(e),O(e,t),N(e,t),!e.__hasRenderableContent){const s=e.children;for(let e=0,n=s.length;e<n;e++)I(s[e],t)}}function D(e,t){t.ensureChildrenArePreprocessed(e);if(k(e,t.frameCount)&&!e.__hasRenderableContent&&(!e.__hasUnrenderableContent||L(e.__loadingState))){const s=e.children;for(let e=0,n=s.length;e<n;e++){D(s[e],t)}}else t.queueTileForDownload(e)}function N(e,t){e.__used=!0,t.lruCache.markUsed(e),t.stats.used++,!0===e.__inFrustum&&t.stats.inFrustum++}function B(e,t=null,s=null,n=null,r=0){if(t&&t(e,n,r))return void(s&&s(e,n,r));const i=e.children;for(let a=0,o=i.length;a<o;a++)B(i[a],t,s,e,r+1);s&&s(e,n,r)}function V(e,t){if(t.ensureChildrenArePreprocessed(e),O(e,t),!e.__inFrustum)return;if(N(e,t),!function(e,t){return!(e.__error<=t.errorTarget||t.maxDepth>0&&e.__depth+1>=t.maxDepth)}(e,t))return;let s=!1,n=!1;const r=e.children;for(let i=0,a=r.length;i<a;i++){const e=r[i];V(e,t),s=s||k(e,t.frameCount),n=n||e.__inFrustum}if("REPLACE"===e.refine&&!n&&0!==r.length)return e.__inFrustum=!1,void(e.__used=!1);if(s&&"REPLACE"===e.refine)for(let i=0,a=r.length;i<a;i++){I(r[i],t)}}function z(e,t){const s=t.frameCount;if(!k(e,s))return;const n=e.children;let r=!1;for(let i=0,a=n.length;i<a;i++){const e=n[i];r=r||k(e,s)}if(r){let r=!1,i=!0;for(let e=0,a=n.length;e<a;e++){const a=n[e];if(z(a,t),r=r||a.__wasSetVisible||a.__childrenWereVisible,k(a,s)){const e=a.__allChildrenLoaded||a.__hasRenderableContent&&L(a.__loadingState)||!a.__hasContent&&0===a.children.length||a.__hasUnrenderableContent&&a.__loadingState===M;i=i&&e}}e.__childrenWereVisible=r,e.__allChildrenLoaded=i}else e.__isLeaf=!0}function j(e,t){const s=t.stats;if(!k(e,t.frameCount))return;const n=t.lruCache;if(e.__isLeaf)return void(e.__loadingState===U?(e.__inFrustum&&(e.__visible=!0,s.visible++),e.__active=!0,s.active++):!n.isFull()&&e.__hasContent&&t.queueTileForDownload(e));const r=e.children,i=e.__hasContent,a=L(e.__loadingState)&&i,o=(t.errorTarget+1)*t.errorThreshold,l=e.__error<=o,c=e.__childrenWereVisible,h=0===e.__depthFromRenderedParent,d=e.__allChildrenLoaded||h;if((l||"ADD"===e.refine)&&!a&&!n.isFull()&&i&&t.queueTileForDownload(e),(l&&!d&&!c&&a||"ADD"===e.refine&&a)&&(e.__inFrustum&&(e.__visible=!0,s.visible++),e.__active=!0,s.active++),"REPLACE"===e.refine&&l&&!d&&a)for(let u=0,p=r.length;u<p;u++){const e=r[u];k(e,t.frameCount)&&!n.isFull()&&D(e,t)}else for(let u=0,p=r.length;u<p;u++)j(r[u],t)}function H(e,t){const s=k(e,t.frameCount);if(s||e.__usedLastFrame){let n=!1,r=!1;s&&(n=e.__active,r=t.displayActiveTiles&&e.__active||e.__visible),e.__hasRenderableContent&&e.__loadingState===U&&(e.__wasSetActive!==n&&t.setTileActive(e,n),e.__wasSetVisible!==r&&t.setTileVisible(e,r)),e.__wasSetActive=n,e.__wasSetVisible=r,e.__usedLastFrame=s;const i=e.children;for(let e=0,s=i.length;e<s;e++){H(i[e],t)}}}const q=Symbol("PLUGIN_REGISTERED"),G=(e,t)=>e.__depthFromRenderedParent!==t.__depthFromRenderedParent?e.__depthFromRenderedParent>t.__depthFromRenderedParent?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0,W=(e,t)=>e.__depthFromRenderedParent!==t.__depthFromRenderedParent?e.__depthFromRenderedParent>t.__depthFromRenderedParent?1:-1:e.__lastFrameVisited!==t.__lastFrameVisited?e.__lastFrameVisited>t.__lastFrameVisited?-1:1:e.__hasUnrenderableContent!==t.__hasUnrenderableContent?e.__hasUnrenderableContent?-1:1:0;class Q{get root(){const e=this.rootTileSet;return e?e.root:null}set loadSiblings(e){console.warn('TilesRenderer: "loadSiblings" option has been removed.')}set stopAtEmptyTiles(e){console.warn('TilesRenderer: "stopAtEmptyTiles" option has been removed.')}set preprocessURL(e){console.warn('TilesRendererBase: The "preprocessURL" callback has been deprecated. Use a plugin, instead.'),this._preprocessURL=e}get preprocessURL(){return this._preprocessURL}constructor(e=null){this.rootTileSetTriggered=!1,this.rootTileSet=null,this.rootURL=e,this.fetchOptions={},this.plugins=[],this.queuedTiles=[],this._preprocessURL=null;const t=new R;t.unloadPriorityCallback=W;const s=new A;s.maxJobs=4,s.priorityCallback=G;const n=new A;n.maxJobs=1,n.priorityCallback=G,this.lruCache=t,this.downloadQueue=s,this.parseQueue=n,this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this.errorThreshold=1/0,this.displayActiveTiles=!1,this.maxDepth=1/0}registerPlugin(e){if(!0===e[q])throw new Error("TilesRendererBase: A plugin can only be registered to a single tile set");this.plugins.push(e),e[q]=!0,e.init&&e.init(this)}getPluginByName(e){return this.plugins.find((t=>t.name===e))}traverse(e,t){this.root&&B(this.root,((t,...s)=>(this.ensureChildrenArePreprocessed(t),!!e&&e(t,...s))),t)}queueTileForDownload(e){this.queuedTiles.push(e)}update(){const e=this.stats,t=this.lruCache;if(!this.rootTileSetTriggered)return void this.invokeOnePlugin((e=>e.loadRootTileSet&&e.loadRootTileSet(this.rootURL)));if(!this.root)return;const s=this.root;e.inFrustum=0,e.used=0,e.active=0,e.visible=0,this.frameCount++,V(s,this),z(s,this),j(s,this),H(s,this);const n=this.queuedTiles;n.sort(t.unloadPriorityCallback);for(let r=0,i=n.length;r<i&&!t.isFull();r++)this.requestTileContents(n[r]);n.length=0,t.scheduleUnload()}resetFailedTiles(){const e=this.stats;0!==e.failed&&(this.traverse((e=>{e.__loadingState===M&&(e.__loadingState=0)})),e.failed=0)}dispose(){this.invokeAllPlugins((e=>{e!==this&&e.dispose&&e.dispose()}));const e=this.lruCache,t=[];this.traverse((e=>(t.push(e),!1)));for(let s=0,n=t.length;s<n;s++)e.remove(t[s]);this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}parseTile(e,t,s){return null}disposeTile(e){e.__visible&&(this.setTileVisible(e,!1),e.__visible=!1),e.__active&&(this.setTileActive(e,!1),e.__active=!1)}preprocessNode(e,t,s=null){var n;if(e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=s,e.children=e.children||[],null==(n=e.content)?void 0:n.uri){const t=E(e.content.uri);e.__hasContent=!0,e.__hasUnrenderableContent=Boolean(t&&/json$/.test(t)),e.__hasRenderableContent=!e.__hasUnrenderableContent}else e.__hasContent=!1,e.__hasUnrenderableContent=!1,e.__hasRenderableContent=!1;e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=0,e.__loadIndex=0,e.__loadAbort=null,null===s?(e.__depth=0,e.__depthFromRenderedParent=0,e.refine=e.refine||"REPLACE"):(e.__depth=s.__depth+1,e.__depthFromRenderedParent=s.__depthFromRenderedParent+(e.__hasRenderableContent?1:0),e.refine=e.refine||s.refine),e.__basePath=t,e.__lastFrameVisited=-1,this.invokeAllPlugins((n=>{n!==this&&n.preprocessNode&&n.preprocessNode(e,t,s)}))}setTileActive(e,t){}setTileVisible(e,t){}calculateError(e){return 0}tileInView(e){return!0}ensureChildrenArePreprocessed(e){const t=e.children;for(let s=0,n=t.length;s<n;s++){const n=t[s];if("__depth"in n)break;this.preprocessNode(n,e.__basePath,e)}}preprocessTileSet(e,t,s=null){const n=e.asset.version,[r,i]=n.split(".").map((e=>parseInt(e)));console.assert(r<=1,"TilesRenderer: asset.version is expected to be a 1.x or a compatible version."),1===r&&i>0&&console.warn("TilesRenderer: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let a=t.replace(/\/[^/]*\/?$/,"");a=new URL(a,window.location.href).toString(),this.preprocessNode(e.root,a,s)}loadRootTileSet(e){if(!this.rootTileSetTriggered){this.rootTileSetTriggered=!0;let t=e;this.invokeAllPlugins((e=>t=e.preprocessURL?e.preprocessURL(t,null):t));const s=fetch(t,this.fetchOptions).then((e=>{if(e.ok)return e.json();throw new Error('TilesRenderer: Failed to load tileset "'.concat(t,'" with status ').concat(e.status," : ").concat(e.statusText))})).then((e=>{this.preprocessTileSet(e,t),this.rootTileSet=e}));return s.catch((e=>{console.error(e),this.rootTileSet=null})),s}}requestTileContents(e){if(0!==e.__loadingState)return;let t=!1,s=new URL(e.content.uri,e.__basePath+"/").toString();this.invokeAllPlugins((t=>s=t.preprocessURL?t.preprocessURL(s,e):s));const n=this.stats,r=this.lruCache,i=this.downloadQueue,a=this.parseQueue,o=E(s);if(!r.add(e,(e=>{1===e.__loadingState?(e.__loadAbort.abort(),e.__loadAbort=null):t?e.children.length=0:this.invokeAllPlugins((t=>{t.disposeTile&&t.disposeTile(e)})),1===e.__loadingState?n.downloading--:2===e.__loadingState&&n.parsing--,e.__loadingState=0,e.__loadIndex++,a.remove(e),i.remove(e)})))return;e.__loadIndex++;const l=e.__loadIndex,c=new AbortController,h=c.signal;n.downloading++,e.__loadAbort=c,e.__loadingState=1;return i.add(e,(e=>e.__loadIndex!==l?Promise.resolve():fetch(s,Object.assign({signal:h},this.fetchOptions)))).then((t=>{if(e.__loadIndex===l){if(t.ok)return"json"===o?t.json():t.arrayBuffer();throw new Error("Failed to load model with error code ".concat(t.status))}})).then((r=>{if(e.__loadIndex===l)return n.downloading--,n.parsing++,e.__loadAbort=null,e.__loadingState=2,a.add(e,(n=>n.__loadIndex!==l?Promise.resolve():"json"===o&&r.root?(this.preprocessTileSet(r,s,e),e.children.push(r.root),t=!0,Promise.resolve()):this.invokeOnePlugin((e=>e.parseTile&&e.parseTile(r,n,o,s)))))})).then((()=>{e.__loadIndex===l&&(n.parsing--,e.__loadingState=U,r.updateMemoryUsage(e),e.__wasSetVisible&&this.setTileVisible(e,!0),e.__wasSetActive&&this.setTileActive(e,!0))})).catch((t=>{e.__loadIndex===l&&("AbortError"!==t.name?(a.remove(e),i.remove(e),2===e.__loadingState?n.parsing--:1===e.__loadingState&&n.downloading--,n.failed++,console.error('TilesRenderer : Failed to load tile at url "'.concat(e.content.uri,'".')),console.error(t),e.__loadingState=M):r.remove(e))}))}invokeOnePlugin(e){const t=[...this.plugins,this];for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}invokeAllPlugins(e){const t=[...this.plugins,this],s=[];for(let n=0;n<t.length;n++){const r=e(t[n]);r&&s.push(r)}return 0===s.length?null:Promise.all(s)}}const J=new TextDecoder;function Z(e){return J.decode(e)}function Y(e,t,s,n,r,i){let a,o;switch(n){case"SCALAR":a=1;break;case"VEC2":a=2;break;case"VEC3":a=3;break;case"VEC4":a=4;break;default:throw new Error('FeatureTable : Feature type not provided for "'.concat(i,'".'))}const l=s*a;switch(r){case"BYTE":o=new Int8Array(e,t,l);break;case"UNSIGNED_BYTE":o=new Uint8Array(e,t,l);break;case"SHORT":o=new Int16Array(e,t,l);break;case"UNSIGNED_SHORT":o=new Uint16Array(e,t,l);break;case"INT":o=new Int32Array(e,t,l);break;case"UNSIGNED_INT":o=new Uint32Array(e,t,l);break;case"FLOAT":o=new Float32Array(e,t,l);break;case"DOUBLE":o=new Float64Array(e,t,l);break;default:throw new Error('FeatureTable : Feature component type not provided for "'.concat(i,'".'))}return o}class X{constructor(e,t,s,n){this.buffer=e,this.binOffset=t+s,this.binLength=n;let r=null;if(0!==s){const n=new Uint8Array(e,t,s);r=JSON.parse(Z(n))}else r={};this.header=r}getKeys(){return Object.keys(this.header)}getData(e,t,s=null,n=null){const r=this.header;if(!(e in r))return null;const i=r[e];if(i instanceof Object){if(Array.isArray(i))return i;{const{buffer:r,binOffset:a,binLength:o}=this,l=i.byteOffset||0,c=i.type||n,h=i.componentType||s;if("type"in i&&n&&i.type!==n)throw new Error("FeatureTable: Specified type does not match expected type.");const d=a+l,u=Y(r,d,t,c,h,e);if(d+u.byteLength>a+o)throw new Error("FeatureTable: Feature data read outside binary body length.");return u}}return i}getBuffer(e,t){const{buffer:s,binOffset:n}=this;return s.slice(n+e,n+e+t)}}class ${constructor(e){var t;this.batchTable=e;const s=e.header.extensions["3DTILES_batch_table_hierarchy"];this.classes=s.classes;for(const r of this.classes){const e=r.instances;for(const t in e)r.instances[t]=this._parseProperty(e[t],r.length,t)}if(this.instancesLength=s.instancesLength,this.classIds=this._parseProperty(s.classIds,this.instancesLength,"classIds"),s.parentCounts?this.parentCounts=this._parseProperty(s.parentCounts,this.instancesLength,"parentCounts"):this.parentCounts=new Array(this.instancesLength).fill(1),s.parentIds){const e=this.parentCounts.reduce(((e,t)=>e+t),0);this.parentIds=this._parseProperty(s.parentIds,e,"parentIds")}else this.parentIds=null;this.instancesIds=[];const n={};for(const r of this.classIds)n[r]=null!=(t=n[r])?t:0,this.instancesIds.push(n[r]),n[r]++}_parseProperty(e,t,s){if(Array.isArray(e))return e;{const{buffer:n,binOffset:r}=this.batchTable;return Y(n,r+e.byteOffset,t,"SCALAR",e.componentType||"UNSIGNED_SHORT",s)}}getDataFromId(e,t={}){const s=this.parentCounts[e];if(this.parentIds&&s>0){let n=0;for(let t=0;t<e;t++)n+=this.parentCounts[t];for(let r=0;r<s;r++){const s=this.parentIds[n+r];s!==e&&this.getDataFromId(s,t)}}const n=this.classIds[e],r=this.classes[n].instances,i=this.classes[n].name,a=this.instancesIds[e];for(const o in r)t[i]=t[i]||{},t[i][o]=r[o][a];return t}}class K extends X{get batchSize(){return console.warn("BatchTable.batchSize has been deprecated and replaced with BatchTable.count."),this.count}constructor(e,t,s,n,r){super(e,s,n,r),this.count=t,this.extensions={};const i=this.header.extensions;i&&i["3DTILES_batch_table_hierarchy"]&&(this.extensions["3DTILES_batch_table_hierarchy"]=new $(this))}getData(e,t=null,s=null){return console.warn("BatchTable: BatchTable.getData is deprecated. Use BatchTable.getDataFromId instead."),super.getData(e,this.count,t,s)}getDataFromId(e,t={}){if(e<0||e>=this.count)throw new Error('BatchTable: id value "'.concat(e,'" out of bounds for "').concat(this.count,'" features number.'));for(const s of this.getKeys())"extensions"!==s&&(t[s]=super.getData(s,this.count)[e]);for(const s in this.extensions){const n=this.extensions[s];n.getDataFromId instanceof Function&&(t[s]=t[s]||{},n.getDataFromId(e,t[s]))}return t}}class ee{constructor(){this.fetchOptions={},this.workingPath=""}load(e){return console.warn('Loader: "load" function has been deprecated in favor of "loadAsync".'),this.loadAsync(e)}loadAsync(e){return fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error('Failed to load file "'.concat(e,'" with status ').concat(t.status," : ").concat(t.statusText));return t.arrayBuffer()})).then((t=>(""===this.workingPath&&(this.workingPath=this.workingPathForURL(e)),this.parse(t))))}resolveExternalURL(e){return/^[^\\/]/.test(e)?this.workingPath+"/"+e:e}workingPathForURL(e){const t=e.split(/[\\/]/g);t.pop();return t.join("/")+"/"}parse(e){throw new Error("LoaderBase: Parse not implemented.")}}function te(e){let t;if(t=e instanceof DataView?e:new DataView(e),"{"===String.fromCharCode(t.getUint8(0)))return null;let s="";for(let n=0;n<4;n++)s+=String.fromCharCode(t.getUint8(n));return s}class se extends ee{parse(e){const t=new DataView(e),s=te(t);console.assert("b3dm"===s);const n=t.getUint32(4,!0);console.assert(1===n);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),a=t.getUint32(16,!0),o=t.getUint32(20,!0),l=t.getUint32(24,!0),c=e.slice(28,28+i+a),h=new X(c,0,i,a),d=28+i+a,u=e.slice(d,d+o+l),p=new K(u,h.getData("BATCH_LENGTH"),0,o,l),m=d+o+l;return{version:n,featureTable:h,batchTable:p,glbBytes:new Uint8Array(e,m,r-m)}}}class ne extends se{constructor(s=t){super(),this.manager=s,this.adjustmentTransform=new e}parse(e){const t=super.parse(e),n=t.glbBytes.slice().buffer;return new Promise(((e,r)=>{const i=this.manager,a=this.fetchOptions,o=i.getHandler("path.gltf")||new s(i);"include"===a.credentials&&"cors"===a.mode&&o.setCrossOrigin("use-credentials"),"credentials"in a&&o.setWithCredentials("include"===a.credentials),a.headers&&o.setRequestHeader(a.headers);let l=this.workingPath;!/[\\/]$/.test(l)&&l.length&&(l+="/");const c=this.adjustmentTransform;o.parse(n,l,(s=>{const{batchTable:n,featureTable:r}=t,{scene:i}=s,a=r.getData("RTC_CENTER");a&&(i.position.x+=a[0],i.position.y+=a[1],i.position.z+=a[2]),s.scene.updateMatrix(),s.scene.matrix.multiply(c),s.scene.matrix.decompose(s.scene.position,s.scene.quaternion,s.scene.scale),s.batchTable=n,s.featureTable=r,i.batchTable=n,i.featureTable=r,e(s)}),r)}))}}class re extends ee{parse(e){const t=new DataView(e),s=te(t);console.assert("pnts"===s);const n=t.getUint32(4,!0);console.assert(1===n);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),a=t.getUint32(16,!0),o=t.getUint32(20,!0),l=t.getUint32(24,!0),c=e.slice(28,28+i+a),h=new X(c,0,i,a),d=28+i+a,u=e.slice(d,d+o+l),p=new K(u,h.getData("BATCH_LENGTH")||h.getData("POINTS_LENGTH"),0,o,l);return Promise.resolve({version:n,featureTable:h,batchTable:p})}}function ie(e){const t=e>>11,s=e>>5&63,n=31&e;return[Math.round(t/31*255),Math.round(s/63*255),Math.round(n/31*255)]}const ae={RGB:"color",POSITION:"position"};class oe extends re{constructor(e=t){super(),this.manager=e}parse(e){return super.parse(e).then((async e=>{const{featureTable:t,batchTable:s}=e,c=new n,h=t.header.extensions,d=new r;let u;if(h&&h["3DTILES_draco_point_compression"]){const{byteOffset:e,byteLength:s,properties:n}=h["3DTILES_draco_point_compression"],r=this.manager.getHandler("draco.drc");if(null==r)throw new Error("PNTSLoader: dracoLoader not available.");const i={};for(const t in n)if(t in ae&&t in n){i[ae[t]]=n[t]}const a={attributeIDs:i,attributeTypes:{position:"Float32Array",color:"Uint8Array"},useUniqueIDs:!0},o=t.getBuffer(e,s);u=await r.decodeGeometry(o,a),u.attributes.color&&(c.vertexColors=!0)}else{const e=t.getData("POINTS_LENGTH"),s=t.getData("POSITION",e,"FLOAT","VEC3"),n=t.getData("RGB",e,"UNSIGNED_BYTE","VEC3"),r=t.getData("RGBA",e,"UNSIGNED_BYTE","VEC4"),l=t.getData("RGB565",e,"UNSIGNED_SHORT","SCALAR"),h=t.getData("CONSTANT_RGBA",e,"UNSIGNED_BYTE","VEC4"),p=t.getData("POSITION_QUANTIZED",e,"UNSIGNED_SHORT","VEC3"),m=t.getData("QUANTIZED_VOLUME_SCALE",e,"FLOAT","VEC3"),g=t.getData("QUANTIZED_VOLUME_OFFSET",e,"FLOAT","VEC3");if(u=new i,p){const t=new Float32Array(3*e);for(let s=0;s<e;s++)for(let e=0;e<3;e++){const n=3*s+e;t[n]=p[n]/65535*m[e]}d.x=g[0],d.y=g[1],d.z=g[2],u.setAttribute("position",new a(t,3,!1))}else u.setAttribute("position",new a(s,3,!1));if(null!==r)u.setAttribute("color",new a(r,4,!0)),c.vertexColors=!0,c.transparent=!0,c.depthWrite=!1;else if(null!==n)u.setAttribute("color",new a(n,3,!0)),c.vertexColors=!0;else if(null!==l){const t=new Uint8Array(3*e);for(let s=0;s<e;s++){const e=ie(l[s]);for(let n=0;n<3;n++){t[3*s+n]=e[n]}}u.setAttribute("color",new a(t,3,!0)),c.vertexColors=!0}else if(null!==h){const e=new o(h[0],h[1],h[2]);c.color=e;const t=h[3]/255;t<1&&(c.opacity=t,c.transparent=!0,c.depthWrite=!1)}}["BATCH_LENGTH","NORMAL","NORMAL_OCT16P"].forEach((e=>{e in t.header&&console.warn('PNTSLoader: Unsupported FeatureTable feature "'.concat(e,'" detected.'))}));const p=new l(u,c);p.position.copy(d),e.scene=p,e.scene.featureTable=t,e.scene.batchTable=s;const m=t.getData("RTC_CENTER");return m&&(e.scene.position.x+=m[0],e.scene.position.y+=m[1],e.scene.position.z+=m[2]),e}))}}class le extends ee{parse(e){const t=new DataView(e),s=te(t);console.assert("i3dm"===s);const n=t.getUint32(4,!0);console.assert(1===n);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),a=t.getUint32(16,!0),o=t.getUint32(20,!0),l=t.getUint32(24,!0),c=t.getUint32(28,!0),h=e.slice(32,32+i+a),d=new X(h,0,i,a),u=32+i+a,p=e.slice(u,u+o+l),m=new K(p,d.getData("INSTANCES_LENGTH"),0,o,l),g=u+o+l,f=new Uint8Array(e,g,r-g);let _=null,b=null;if(c)_=f,b=Promise.resolve();else{const e=this.resolveExternalURL(Z(f));b=fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error('I3DMLoaderBase : Failed to load file "'.concat(e,'" with status ').concat(t.status," : ").concat(t.statusText));return t.arrayBuffer()})).then((e=>{_=new Uint8Array(e)}))}return b.then((()=>({version:n,featureTable:d,batchTable:m,glbBytes:_})))}}const ce=new r,he=new r,de=new r,ue=new r,pe=new h,me=new r,ge=new e,fe=new e;class _e extends le{constructor(s=t){super(),this.manager=s,this.adjustmentTransform=new e}resolveExternalURL(e){return this.manager.resolveURL(super.resolveExternalURL(e))}parse(e){return super.parse(e).then((e=>{const{featureTable:t,batchTable:n}=e,i=e.glbBytes.slice().buffer;return new Promise(((e,a)=>{const o=this.fetchOptions,l=this.manager,h=l.getHandler("path.gltf")||new s(l);"include"===o.credentials&&"cors"===o.mode&&h.setCrossOrigin("use-credentials"),"credentials"in o&&h.setWithCredentials("include"===o.credentials),o.headers&&h.setRequestHeader(o.headers);let d=this.workingPath;/[\\/]$/.test(d)||(d+="/");const u=this.adjustmentTransform;h.parse(i,d,(s=>{const i=t.getData("INSTANCES_LENGTH"),a=t.getData("POSITION",i,"FLOAT","VEC3"),o=t.getData("NORMAL_UP",i,"FLOAT","VEC3"),l=t.getData("NORMAL_RIGHT",i,"FLOAT","VEC3"),h=t.getData("SCALE_NON_UNIFORM",i,"FLOAT","VEC3"),d=t.getData("SCALE",i,"FLOAT","SCALAR"),p=t.getData("RTC_CENTER");["QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","EAST_NORTH_UP","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach((e=>{e in t.header&&console.warn('I3DMLoader: Unsupported FeatureTable feature "'.concat(e,'" detected.'))}));const m=new r;for(let e=0;e<i;e++)m.x+=a[3*e+0]/i,m.y+=a[3*e+1]/i,m.z+=a[3*e+2]/i;const g=[],f=[];s.scene.updateMatrixWorld(),s.scene.traverse((e=>{if(e.isMesh){f.push(e);const{geometry:t,material:s}=e,n=new c(t,s,i);n.position.copy(m),p&&(n.position.x+=p[0],n.position.y+=p[1],n.position.z+=p[2]),g.push(n)}}));for(let e=0;e<i;e++){ue.set(a[3*e+0]-m.x,a[3*e+1]-m.y,a[3*e+2]-m.z),o?(he.set(o[3*e+0],o[3*e+1],o[3*e+2]),de.set(l[3*e+0],l[3*e+1],l[3*e+2]),ce.crossVectors(de,he).normalize(),ge.makeBasis(de,he,ce),pe.setFromRotationMatrix(ge)):pe.set(0,0,0,1),me.set(1,1,1),h&&me.set(h[3*e+0],h[3*e+1],h[3*e+2]),d&&me.multiplyScalar(d[e]),ge.compose(ue,pe,me).multiply(u);for(let t=0,s=g.length;t<s;t++){const s=g[t],n=f[t];fe.multiplyMatrices(ge,n.matrixWorld),s.setMatrixAt(e,fe)}}s.scene.clear(),s.scene.add(...g),s.batchTable=n,s.featureTable=t,s.scene.batchTable=n,s.scene.featureTable=t,e(s)}),a)}))}))}}class be extends ee{parse(e){const t=new DataView(e),s=te(t);console.assert("cmpt"===s,'CMPTLoader: The magic bytes equal "cmpt".');const n=t.getUint32(4,!0);console.assert(1===n,'CMPTLoader: The version listed in the header is "1".');const r=t.getUint32(8,!0);console.assert(r===e.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const i=t.getUint32(12,!0),a=[];let o=16;for(let l=0;l<i;l++){const t=new DataView(e,o,12),s=te(t),n=t.getUint32(4,!0),r=t.getUint32(8,!0),i=new Uint8Array(e,o,r);a.push({type:s,buffer:i,version:n}),o+=r}return{version:n,tiles:a}}}class ye extends be{constructor(s=t){super(),this.manager=s,this.adjustmentTransform=new e}parse(e){const t=super.parse(e),s=this.manager,n=this.adjustmentTransform,r=[];for(const i in t.tiles){const{type:e,buffer:a}=t.tiles[i];switch(e){case"b3dm":{const e=a.slice(),t=new ne(s);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions,t.adjustmentTransform.copy(n);const i=t.parse(e.buffer);r.push(i);break}case"pnts":{const e=a.slice(),t=new oe(s);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const n=t.parse(e.buffer);r.push(n);break}case"i3dm":{const e=a.slice(),t=new _e(s);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions,t.adjustmentTransform.copy(n);const i=t.parse(e.buffer);r.push(i);break}}}return Promise.all(r).then((e=>{const t=new d;return e.forEach((e=>{t.add(e.scene)})),{tiles:e,scene:t}}))}}class we{constructor(){this.name="CESIUM_RTC"}afterRoot(e){if(e.parser.json.extensions&&e.parser.json.extensions.CESIUM_RTC){const{center:t}=e.parser.json.extensions.CESIUM_RTC;t&&(e.scene.position.x+=t[0],e.scene.position.y+=t[1],e.scene.position.z+=t[2])}}}class Te extends ee{constructor(e=t){super(),this.manager=e}parse(e){return new Promise(((t,n)=>{const r=this.manager,i=this.fetchOptions;let a=r.getHandler("path.gltf")||r.getHandler("path.glb");a||(a=new s(r),a.register((()=>new we))),"include"===i.credentials&&"cors"===i.mode&&a.setCrossOrigin("use-credentials"),"credentials"in i&&a.setWithCredentials("include"===i.credentials),i.headers&&a.setRequestHeader(i.headers);let o=a.resourcePath||a.path||this.workingPath;!/[\\/]$/.test(o)&&o.length&&(o+="/"),a.parse(e,o,(e=>{t(e)}),n)}))}}const xe=new e;class Ce extends d{constructor(e){super(),this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e}raycast(e,t){return!this.tilesRenderer.optimizeRaycast||(this.tilesRenderer.raycast(e,t),!1)}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){null===this.parent?xe.copy(this.matrix):xe.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const e=xe.elements,t=this.matrixWorld.elements;let s=!1;for(let n=0;n<16;n++){const r=e[n],i=t[n];if(Math.abs(r-i)>Number.EPSILON){s=!0;break}}if(s){this.matrixWorld.copy(xe);const e=this.children;for(let t=0,s=e.length;t<s;t++)e[t].updateMatrixWorld()}}}}const Se=parseInt(p)<165,ve=new e,Pe=new u,Ee=new r,Re=[];function Ae(e,t){return e.distance-t.distance}function Ue(e,t,s){Se?(e.traverse((e=>{Object.getPrototypeOf(e).raycast.call(e,t,s)})),Re.sort(Ae)):t.intersectObject(e,!0,s)}function Me(e,t,s,n=null){const{group:r,activeTiles:i}=e;e.ensureChildrenArePreprocessed(t),null===n&&(n=Pe,ve.copy(r.matrixWorld).invert(),n.copy(s.ray).applyMatrix4(ve));const a=[],o=t.children;for(let h=0,d=o.length;h<d;h++){const e=o[h];if(!e.__used)continue;null!==e.cached.boundingVolume.intersectRay(n,Ee)&&(Ee.applyMatrix4(r.matrixWorld),a.push({distance:Ee.distanceToSquared(s.ray.origin),tile:e}))}a.sort(Ae);let l=null,c=1/0;if(i.has(t)){const e=function(e,t){Ue(e,t,Re);const s=Re[0]||null;return Re.length=0,s}(t.cached.scene,s);e&&(l=e,c=e.distance*e.distance)}for(let h=0,d=a.length;h<d;h++){const t=a[h],r=t.distance,i=t.tile;if(r>c)break;const o=Me(e,i,s,n);if(o){const e=o.distance*o.distance;e<c&&(l=o,c=e)}}return l}function Fe(e,t,s,n,r=null){const{group:i,activeTiles:a}=e,{scene:o,boundingVolume:l}=t.cached;if(e.ensureChildrenArePreprocessed(t),null===r&&(r=Pe,ve.copy(i.matrixWorld).invert(),r.copy(s.ray).applyMatrix4(ve)),!t.__used||!l.intersectsRay(r))return;a.has(t)&&Ue(o,s,n);const c=t.children;for(let h=0,d=c.length;h<d;h++)Fe(e,c[h],s,n,r)}const Le=new r,ke=new r,Oe=new r,Ie=new u;class De{constructor(t=new g,s=new e){this.box=t.clone(),this.transform=s.clone(),this.inverseTransform=new e,this.points=new Array(8).fill().map((()=>new r)),this.planes=new Array(6).fill().map((()=>new m))}clampPoint(e,t){return t.copy(e).applyMatrix4(this.inverseTransform).clamp(this.box.min,this.box.max).applyMatrix4(this.transform)}distanceToPoint(e){return this.clampPoint(e,Oe).distanceTo(e)}containsPoint(e){return Oe.copy(e).applyMatrix4(this.inverseTransform),this.box.containsPoint(Oe)}intersectsRay(e){return Ie.copy(e).applyMatrix4(this.inverseTransform),Ie.intersectsBox(this.box)}intersectRay(e,t){return Ie.copy(e).applyMatrix4(this.inverseTransform),Ie.intersectBox(this.box,t)?(t.applyMatrix4(this.transform),t):null}update(){const{points:e,inverseTransform:t,transform:s,box:n}=this;t.copy(s).invert();const{min:r,max:i}=n;let a=0;for(let o=-1;o<=1;o+=2)for(let t=-1;t<=1;t+=2)for(let n=-1;n<=1;n+=2)e[a].set(o<0?r.x:i.x,t<0?r.y:i.y,n<0?r.z:i.z).applyMatrix4(s),a++;this.updatePlanes()}updatePlanes(){Le.copy(this.box.min).applyMatrix4(this.transform),ke.copy(this.box.max).applyMatrix4(this.transform),Oe.set(0,0,1).transformDirection(this.transform),this.planes[0].setFromNormalAndCoplanarPoint(Oe,Le),this.planes[1].setFromNormalAndCoplanarPoint(Oe,ke).negate(),Oe.set(0,1,0).transformDirection(this.transform),this.planes[2].setFromNormalAndCoplanarPoint(Oe,Le),this.planes[3].setFromNormalAndCoplanarPoint(Oe,ke).negate(),Oe.set(1,0,0).transformDirection(this.transform),this.planes[4].setFromNormalAndCoplanarPoint(Oe,Le),this.planes[5].setFromNormalAndCoplanarPoint(Oe,ke).negate()}intersectsFrustum(e){const{points:t}=this,{planes:s}=e;for(let n=0;n<6;n++){const e=s[n];let r=-1/0;for(let s=0;s<8;s++){const n=t[s],i=e.distanceToPoint(n);r=r<i?i:r}if(r<0)return!1}for(let n=0;n<6;n++){const t=this.planes[n];let s=-1/0;for(let n=0;n<8;n++){const r=e.points[n],i=t.distanceToPoint(r);s=s<i?i:s}if(s<0)return!1}return!0}}new f,new r;const Ne=new f,Be=new r,Ve=new r,ze=new r,je=new r,He=new e,qe=new e,Ge=new _,We=new b,Qe=new r,Je=new r,Ze=new r,Ye=new r,Xe=new u;class $e{constructor(e=1,t=1,s=1){this.radius=new r(e,t,s)}intersectRay(e,t){return He.makeScale(...this.radius).invert(),Ge.center.set(0,0,0),Ge.radius=1,Xe.copy(e).applyMatrix4(He),Xe.intersectSphere(Ge,t)?(He.makeScale(...this.radius),t.applyMatrix4(He),t):null}getEastNorthUpFrame(e,t,s){return this.getEastNorthUpAxes(e,t,Qe,Je,Ze,Ye),s.makeBasis(Qe,Je,Ze).setPosition(Ye)}getEastNorthUpAxes(e,t,s,n,r,i=Ye){this.getCartographicToPosition(e,t,0,i),this.getCartographicToNormal(e,t,r),s.set(-i.y,i.x,0).normalize(),n.crossVectors(r,s).normalize()}getNorthernTangent(e,t,s,n=je){return console.log("Ellipsoid: getNorthernTangent has been deprecated. Use getEastNorthUpAxes instead."),this.getEastNorthUpAxes(e,t,n,s,Ze),n.multiplyScalar(-1),s}getAzElRollFromRotationMatrix(e,t,s,n,r=0){return 1===r?(We.set(-Math.PI/2,0,0,"XYZ"),qe.makeRotationFromEuler(We).premultiply(s)):2===r?(We.set(-Math.PI/2,0,Math.PI,"XYZ"),qe.makeRotationFromEuler(We).premultiply(s)):qe.copy(s),this.getEastNorthUpFrame(e,t,He).invert(),qe.premultiply(He),We.setFromRotationMatrix(qe,"ZXY"),n.azimuth=-We.z,n.elevation=We.x,n.roll=We.y,n}getRotationMatrixFromAzElRoll(e,t,s,n,r,i,a=0){return this.getEastNorthUpFrame(e,t,He),We.set(n,r,-s,"ZXY"),i.makeRotationFromEuler(We).premultiply(He).setPosition(0,0,0),1===a?(We.set(Math.PI/2,0,0,"XYZ"),qe.makeRotationFromEuler(We),i.multiply(qe)):2===a&&(We.set(-Math.PI/2,0,Math.PI,"XYZ"),qe.makeRotationFromEuler(We),i.multiply(qe)),i}getCartographicToPosition(e,t,s,n){this.getCartographicToNormal(e,t,Be);const r=this.radius;Ve.copy(Be),Ve.x*=r.x**2,Ve.y*=r.y**2,Ve.z*=r.z**2;const i=Math.sqrt(Be.dot(Ve));return Ve.divideScalar(i),n.copy(Ve).addScaledVector(Be,s)}getPositionToCartographic(e,t){this.getPositionToSurfacePoint(e,Ve),this.getPositionToNormal(e,Be);const s=ze.subVectors(e,Ve);return t.lon=Math.atan2(Be.y,Be.x),t.lat=Math.asin(Be.z),t.height=Math.sign(s.dot(e))*s.length(),t}getCartographicToNormal(e,t,s){return Ne.set(1,-e+Math.PI/2,t),s.setFromSpherical(Ne).normalize(),function(e){const{x:t,y:s,z:n}=e;e.x=n,e.y=t,e.z=s}(s),s}getPositionToNormal(e,t){const s=this.radius;return t.copy(e),t.x/=s.x**2,t.y/=s.y**2,t.z/=s.z**2,t.normalize(),t}getPositionToSurfacePoint(e,t){const s=this.radius,n=1/s.x**2,r=1/s.y**2,i=1/s.z**2,a=e.x*e.x*n,o=e.y*e.y*r,l=e.z*e.z*i,c=a+o+l,h=Math.sqrt(1/c),d=Ve.copy(e).multiplyScalar(h);if(c<.1)return isFinite(h)?t.copy(d):null;const u=ze.set(d.x*n*2,d.y*r*2,d.z*i*2);let p,m,g,f,_,b,y,w,T,x,C,S=(1-h)*e.length()/(.5*u.length()),v=0;do{S-=v,g=1/(1+S*n),f=1/(1+S*r),_=1/(1+S*i),b=g*g,y=f*f,w=_*_,T=b*g,x=y*f,C=w*_,p=a*b+o*y+l*w-1,m=a*T*n+o*x*r+l*C*i;v=p/(-2*m)}while(Math.abs(p)>1e-12);return t.set(e.x*g,e.y*f,e.z*_)}calculateHorizonDistance(e,t){const s=this.calculateEffectiveRadius(e);return Math.sqrt(2*s*t+t**2)}calculateEffectiveRadius(e){const t=this.radius.x,s=1-this.radius.z**2/t**2,n=e*y.DEG2RAD,r=Math.sin(n)**2;return t/Math.sqrt(1-s*r)}getPositionElevation(e){this.getPositionToSurfacePoint(e,Ve);const t=ze.subVectors(e,Ve);return Math.sign(t.dot(e))*t.length()}copy(e){return this.radius.copy(e.copy),this}clone(){return(new this.constructor).copy(this)}}const Ke=Math.PI,et=Ke/2,tt=new r,st=new r,nt=new r,rt=new e;let it=0;const at=[];function ot(e=!1){return e?(at[it]||(at[it]=new r),it++,at[it-1]):new r}function lt(){it=0}class ct extends $e{constructor(e,t,s,n=-et,r=et,i=0,a=2*Ke,o=0,l=0){super(e,t,s),this.latStart=n,this.latEnd=r,this.lonStart=i,this.lonEnd=a,this.heightStart=o,this.heightEnd=l}_getPoints(e=!1){const{latStart:t,latEnd:s,lonStart:n,lonEnd:r,heightStart:i,heightEnd:a}=this,o=y.mapLinear(.5,0,1,t,s),l=y.mapLinear(.5,0,1,n,r),c=Math.floor(n/et)*et,h=[[-Ke/2,0],[Ke/2,0],[0,c],[0,c+Ke/2],[0,c+Ke],[0,c+3*Ke/2],[t,r],[s,r],[t,n],[s,n],[0,n],[0,r],[o,l],[t,l],[s,l],[o,n],[o,r]],d=[],u=h.length;for(let p=0;p<=1;p++){const o=y.mapLinear(p,0,1,i,a);for(let i=0,a=u;i<a;i++){const[a,l]=h[i];if(a>=t&&a<=s&&l>=n&&l<=r){const t=ot(e);d.push(t),this.getCartographicToPosition(a,l,o,t)}}}return d}getBoundingBox(e,t){lt();const{latStart:s,latEnd:n,lonStart:r,lonEnd:i}=this;if(n-s<Ke/2){const e=y.mapLinear(.5,0,1,s,n),a=y.mapLinear(.5,0,1,r,i);this.getCartographicToNormal(e,a,nt),st.set(0,0,1),tt.crossVectors(st,nt),st.crossVectors(tt,nt),t.makeBasis(tt,st,nt)}else tt.set(1,0,0),st.set(0,1,0),nt.set(0,0,1),t.makeBasis(tt,st,nt);rt.copy(t).invert();const a=this._getPoints(!0);for(let o=0,l=a.length;o<l;o++)a[o].applyMatrix4(rt);e.makeEmpty(),e.setFromPoints(a)}getBoundingSphere(e,t){lt();const s=this._getPoints(!0);e.makeEmpty(),e.setFromPoints(s,t)}}const ht=new r,dt=new r,ut=new r,pt=new r,mt=new r;class gt{constructor(){this.sphere=null,this.obb=null,this.region=null,this.regionObb=null}intersectsRay(e){const t=this.sphere,s=this.obb||this.regionObb;return!(t&&!e.intersectsSphere(t))&&!(s&&!s.intersectsRay(e))}intersectRay(e,t=null){const s=this.sphere,n=this.obb||this.regionObb;let r=-1/0,i=-1/0;s&&e.intersectSphere(s,pt)&&(r=s.containsPoint(e.origin)?0:e.origin.distanceToSquared(pt)),n&&n.intersectRay(e,mt)&&(i=n.containsPoint(e.origin)?0:e.origin.distanceToSquared(mt));const a=Math.max(r,i);return a===-1/0?null:(e.at(Math.sqrt(a),t),t)}distanceToPoint(e){const t=this.sphere,s=this.obb||this.regionObb;let n=-1/0,r=-1/0;return t&&(n=Math.max(t.distanceToPoint(e),0)),s&&(r=s.distanceToPoint(e)),n>r?n:r}intersectsFrustum(e){const t=this.obb||this.regionObb,s=this.sphere;return!(s&&!e.intersectsSphere(s))&&(!(t&&!t.intersectsFrustum(e))&&Boolean(s||t))}getOBB(e,t){const s=this.obb||this.regionObb;s?(e.copy(s.box),t.copy(s.transform)):(this.getAABB(e),t.identity())}getAABB(e){if(this.sphere)this.sphere.getBoundingBox(e);else{const t=this.obb||this.regionObb;e.copy(t.box).applyMatrix4(t.transform)}}getSphere(e){if(this.sphere)e.copy(this.sphere);else if(this.region)this.region.getBoundingSphere(e);else{const t=this.obb||this.regionObb;t.box.getBoundingSphere(e),e.applyMatrix4(t.transform)}}setObbData(e,t){const s=new De;ht.set(e[3],e[4],e[5]),dt.set(e[6],e[7],e[8]),ut.set(e[9],e[10],e[11]);const n=ht.length(),r=dt.length(),i=ut.length();ht.normalize(),dt.normalize(),ut.normalize(),0===n&&ht.crossVectors(dt,ut),0===r&&dt.crossVectors(ht,ut),0===i&&ut.crossVectors(ht,dt),s.transform.set(ht.x,dt.x,ut.x,e[0],ht.y,dt.y,ut.y,e[1],ht.z,dt.z,ut.z,e[2],0,0,0,1).premultiply(t),s.box.min.set(-n,-r,-i),s.box.max.set(n,r,i),s.update(),this.obb=s}setSphereData(e,t,s,n,r){const i=new _;i.center.set(e,t,s),i.radius=n,i.applyMatrix4(r),this.sphere=i}setRegionData(e,t,s,n,r,i){const a=new ct(F,F,6356752.314245179,t,n,e,s,r,i),o=new De;a.getBoundingBox(o.box,o.transform),o.update(),this.region=a,this.regionObb=o}}const ft=new w;class _t extends T{constructor(){super(),this.points=Array(8).fill().map((()=>new r))}setFromProjectionMatrix(e,t){super.setFromProjectionMatrix(e,t),this.calculateFrustumPoints()}calculateFrustumPoints(){const{planes:e,points:t}=this;[[e[0],e[3],e[4]],[e[1],e[3],e[4]],[e[0],e[2],e[4]],[e[1],e[2],e[4]],[e[0],e[3],e[5]],[e[1],e[3],e[5]],[e[0],e[2],e[5]],[e[1],e[2],e[5]]].forEach(((e,s)=>{!function(e,t,s,n){const r=ft.set(e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z,s.normal.x,s.normal.y,s.normal.z);n.set(-e.constant,-t.constant,-s.constant),n.applyMatrix3(r.invert())}(e[0],e[1],e[2],t[s])}))}}const bt=parseInt(p)<165,yt=Symbol("INITIAL_FRUSTUM_CULLED"),wt=new e,Tt=new e,xt=new r,Ct=new S,St=new r(1,0,0),vt=new r(0,1,0);function Pt(e,t){e.traverse((e=>{e.frustumCulled=e[yt]&&t}))}class Et extends Q{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel((t=>{Pt(t,!e)})))}constructor(...t){super(...t),this.group=new Ce(this),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this.activeTiles=new Set,this.visibleTiles=new Set,this.optimizeRaycast=!0,this._eventDispatcher=new v,this._upRotationMatrix=new e,this.lruCache.getMemoryUsageCallback=e=>e.cached.bytesUsed||0,this._autoDisableRendererCulling=!0,this._loadingTiles=!1;const s=new P;if(s.setURLModifier((e=>this.preprocessURL?this.preprocessURL(e):e)),this.manager=s,bt){const e=this;this._overridenRaycast=function(t,s){e.optimizeRaycast||Object.getPrototypeOf(this).raycast.call(this,t,s)}}}addEventListener(...e){this._eventDispatcher.addEventListener(...e)}hasEventListener(...e){this._eventDispatcher.hasEventListener(...e)}removeEventListener(...e){this._eventDispatcher.removeEventListener(...e)}dispatchEvent(...e){this._eventDispatcher.dispatchEvent(...e)}getBounds(...e){return console.warn("TilesRenderer: getBounds has been renamed to getBoundingBox."),this.getBoundingBox(...e)}getOrientedBounds(...e){return console.warn("TilesRenderer: getOrientedBounds has been renamed to getOrientedBoundingBox."),this.getOrientedBoundingBox(...e)}getBoundingBox(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return!!t&&(t.getAABB(e),!0)}getOrientedBoundingBox(e,t){if(!this.root)return!1;const s=this.root.cached.boundingVolume;return!!s&&(s.getOBB(e,t),!0)}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return!!t&&(t.getSphere(e),!0)}forEachLoadedModel(e){this.traverse((t=>{const s=t.cached.scene;s&&e(s,t)}))}raycast(e,t){if(this.root)if(e.firstHitOnly){const s=Me(this,this.root,e);s&&t.push(s)}else Fe(this,this.root,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,s=this.cameraMap;return!s.has(e)&&(s.set(e,new S),t.push(e),this.dispatchEvent({type:"add-camera",camera:e}),!0)}setResolution(e,t,s){const n=this.cameraMap;if(!n.has(e))return!1;const r=t.isVector2?t.x:t,i=t.isVector2?t.y:s,a=n.get(e);return a.width===r&&a.height===i||(a.set(r,i),this.dispatchEvent({type:"camera-resolution-change"})),!0}setResolutionFromRenderer(e,t){return t.getSize(Ct).multiplyScalar(t.getPixelRatio()),this.setResolution(e,Ct.x,Ct.y)}deleteCamera(e){const t=this.cameras,s=this.cameraMap;if(s.has(e)){const n=t.indexOf(e);return t.splice(n,1),s.delete(e),this.dispatchEvent({type:"delete-camera",camera:e}),!0}return!1}preprocessTileSet(e,t,s){super.preprocessTileSet(e,t,s),queueMicrotask((()=>{this.dispatchEvent({type:"load-tile-set",tileSet:e,url:t})}))}loadRootTileSet(...e){return super.loadRootTileSet(...e).then((()=>{switch((this.rootTileSet.asset&&this.rootTileSet.asset.gltfUpAxis||"y").toLowerCase()){case"x":this._upRotationMatrix.makeRotationAxis(vt,-Math.PI/2);break;case"y":this._upRotationMatrix.makeRotationAxis(St,Math.PI/2)}this.dispatchEvent({type:"load-content"})})).catch((()=>{}))}update(){let e=null;if(this.invokeAllPlugins((t=>{if(t.doTilesNeedUpdate){const s=t.doTilesNeedUpdate();e=null===e?s:e||s}})),!1===e)return this.dispatchEvent({type:"update-before"}),void this.dispatchEvent({type:"update-after"});this.dispatchEvent({type:"update-before"});const t=this.group,s=this.cameras,n=this.cameraMap,i=this.cameraInfo;if(0===s.length)return void console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.");for(;i.length>s.length;)i.pop();for(;i.length<s.length;)i.push({frustum:new _t,isOrthographic:!1,sseDenominator:-1,position:new r,invScale:-1,pixelSize:0});Tt.copy(t.matrixWorld).invert(),xt.setFromMatrixScale(Tt);const a=xt.x;Math.abs(Math.max(xt.x-xt.y,xt.x-xt.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let r=0,o=i.length;r<o;r++){const e=s[r],o=i[r],l=o.frustum,c=o.position,h=n.get(e);0!==h.width&&0!==h.height||console.warn("TilesRenderer: resolution for camera error calculation is not set.");const d=e.projectionMatrix.elements;if(o.isOrthographic=1===d[15],o.isOrthographic){const e=2/d[0],t=2/d[5];o.pixelSize=Math.max(t/h.height,e/h.width)}else o.sseDenominator=2/d[5]/h.height;o.invScale=a,wt.copy(t.matrixWorld),wt.premultiply(e.matrixWorldInverse),wt.premultiply(e.projectionMatrix),l.setFromProjectionMatrix(wt),c.set(0,0,0),c.applyMatrix4(e.matrixWorld),c.applyMatrix4(Tt)}super.update(),this.dispatchEvent({type:"update-after"})}preprocessNode(t,s,n=null){super.preprocessNode(t,s,n);const r=new e;if(t.transform){const e=t.transform;for(let t=0;t<16;t++)r.elements[t]=e[t]}n&&r.premultiply(n.cached.transform);const i=(new e).copy(r).invert(),a=new gt;"sphere"in t.boundingVolume&&a.setSphereData(...t.boundingVolume.sphere,r),"box"in t.boundingVolume&&a.setObbData(t.boundingVolume.box,r),"region"in t.boundingVolume&&a.setRegionData(...t.boundingVolume.region),t.cached={_loadIndex:0,transform:r,transformInverse:i,active:!1,boundingVolume:a,metadata:null,scene:null,geometry:null,materials:null,textures:null}}async requestTileContents(...e){await super.requestTileContents(...e),this.dispatchEvent({type:"load-content"})}async parseTile(e,t,s,n){const r=t.cached;r._loadIndex++;const i=n.split(/[\\/]/g);i.pop();const a=i.join("/"),o=this.fetchOptions,l=this.manager,c=r._loadIndex;let h=null;const d=r.transform,u=this._upRotationMatrix,p=(te(e)||s).toLowerCase();switch(p){case"b3dm":{const t=new ne(l);t.workingPath=a,t.fetchOptions=o,t.adjustmentTransform.copy(u),h=t.parse(e);break}case"pnts":{const t=new oe(l);t.workingPath=a,t.fetchOptions=o,h=t.parse(e);break}case"i3dm":{const t=new _e(l);t.workingPath=a,t.fetchOptions=o,t.adjustmentTransform.copy(u),h=t.parse(e);break}case"cmpt":{const t=new ye(l);t.workingPath=a,t.fetchOptions=o,t.adjustmentTransform.copy(u),h=t.parse(e).then((e=>e.scene));break}case"gltf":case"glb":{const t=new Te(l);t.workingPath=a,t.fetchOptions=o,h=t.parse(e);break}default:console.warn('TilesRenderer: Content type "'.concat(p,'" not supported.')),h=Promise.resolve(null)}const m=this.stats;!1===this._loadingTiles&&m.parsing+m.downloading>0&&(this.dispatchEvent({type:"tiles-load-start"}),this._loadingTiles=!0);const g=await h;let f,_;if(g.isObject3D?(f=g,_=null):(f=g.scene,_=g),await this.invokeAllPlugins((e=>e.processTileModel&&e.processTileModel(f,t))),r._loadIndex!==c)return;f.updateMatrix(),"glb"!==p&&"gltf"!==p||f.matrix.multiply(u),f.matrix.premultiply(d),f.matrix.decompose(f.position,f.quaternion,f.scale),f.traverse((e=>{e[yt]=e.frustumCulled})),Pt(f,!this.autoDisableRendererCulling),bt&&f.traverse((e=>{e.raycast=this._overridenRaycast}));const b=[],y=[],w=[];f.traverse((e=>{if(e.geometry&&y.push(e.geometry),e.material){const t=e.material;b.push(e.material);for(const e in t){const s=t[e];s&&s.isTexture&&w.push(s)}}})),r.materials=b,r.geometry=y,r.textures=w,r.scene=f,r.metadata=_,r.bytesUsed=function(e){const{TextureUtils:t}=C;if(!t)return 0;const s=new Set;let n=0;return e.traverse((e=>{if(e.geometry&&!s.has(e.geometry)&&(n+=x(e.geometry),s.add(e.geometry)),e.material){const r=e.material;for(const e in r){const i=r[e];if(i&&i.isTexture&&!s.has(i)){const{format:e,type:r,image:a}=i,{width:o,height:l}=a,c=t.getByteLength(o,l,e,r);n+=i.generateMipmaps?4*c/3:c,s.add(i)}}}})),n}(f),this.dispatchEvent({type:"load-model",scene:f,tile:t}),!0===this._loadingTiles&&m.parsing+m.downloading===1&&(this.dispatchEvent({type:"tiles-load-end"}),this._loadingTiles=!1)}disposeTile(e){super.disposeTile(e);const t=e.cached;if(t.scene){const s=t.materials,n=t.geometry,r=t.textures,i=t.scene.parent;t.scene.traverse((e=>{e.userData.meshFeatures&&e.userData.meshFeatures.dispose(),e.userData.structuralMetadata&&e.userData.structuralMetadata.dispose()}));for(let e=0,t=n.length;e<t;e++)n[e].dispose();for(let e=0,t=s.length;e<t;e++)s[e].dispose();for(let e=0,t=r.length;e<t;e++){const t=r[e];t.image instanceof ImageBitmap&&t.image.close(),t.dispose()}i&&i.remove(t.scene),this.dispatchEvent({type:"dispose-model",scene:t.scene,tile:e}),t.scene=null,t.materials=null,t.textures=null,t.geometry=null,t.metadata=null}t._loadIndex++}setTileVisible(e,t){const s=e.cached.scene,n=this.visibleTiles,r=this.group;t?(r.add(s),n.add(e),s.updateMatrixWorld(!0)):(r.remove(s),n.delete(e)),this.dispatchEvent({type:"tile-visibility-change",scene:s,tile:e,visible:t})}setTileActive(e,t){const s=this.activeTiles;t?s.add(e):s.delete(e)}calculateError(e){const t=e.cached,s=this.cameras,n=this.cameraInfo,r=t.boundingVolume;let i=-1/0,a=1/0;for(let o=0,l=s.length;o<l;o++){const t=n[o],s=t.invScale;let l;if(t.isOrthographic){const n=t.pixelSize;l=e.geometricError/(n*s)}else{const n=r.distanceToPoint(t.position)*s,i=t.sseDenominator;l=e.geometricError/(n*i),a=Math.min(a,n)}i=Math.max(i,l)}e.__distanceFromCamera=a,e.__error=i}tileInView(e){const t=e.cached.boundingVolume,s=this.cameraInfo;for(let n=0,r=s.length;n<r;n++){const e=s[n].frustum;if(t.intersectsFrustum(e))return!0}return!1}}[["onLoadTileSet","load-tile-set"],["onLoadModel","load-model"],["onDisposeModel","dispose-model"],["onTileVisibilityChange","tile-visibility-change"]].forEach((([e,t])=>{const s=Symbol(e);Object.defineProperty(Et.prototype,e,{get(){return this[s]||null},set(n){console.warn('TilesRenderer: "'.concat(e,'" has been deprecated in favor of the "').concat(t,'" event.')),this[s]&&this.removeEventListener(t,this[s]),this[s]=n,this.addEventListener(t,n)}})}));export{Et as T};
