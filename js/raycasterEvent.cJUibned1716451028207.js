import{by as be,b2 as ye,aT as Me,d8 as Te,b3 as O,d9 as V,da as Q,bo as Dt,cS as Lt,aH as I,bV as Xt,bw as we,aw as ft,cF as xe,bl as K,au as st,bU as Pe,bz as Ee,av as ve,a4 as Oe,bT as Ce,bQ as je,db as Se,a1 as Re,l as _e,w as ke,o as De,c as Le,t as At,cZ as Ae,_ as Ie}from"./vendor.KwxG0fE31716451028207.js";import{c as Ne,d as Fe,a as Be}from"./ExtensionUtilities.CXR_JSZY1716451028207.js";import{F as We}from"./HeightCorrection.c8NcwD5G1716451028207.js";import{C as Ue}from"./vanilla.lotcQiIs1716451028207.js";const It={type:"change"},dt={type:"start"},Nt={type:"end"},rt=new be,Ft=new ye,Ye=Math.cos(70*Me.DEG2RAD);class bo extends Te{constructor(o,n){super(),this.object=o,this.domElement=n,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new O,this.cursor=new O,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:V.ROTATE,MIDDLE:V.DOLLY,RIGHT:V.PAN},this.touches={ONE:Q.ROTATE,TWO:Q.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return c.phi},this.getAzimuthalAngle=function(){return c.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(e){e.addEventListener("keydown",ut),this._domElementKeyEvents=e},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",ut),this._domElementKeyEvents=null},this.saveState=function(){t.target0.copy(t.target),t.position0.copy(t.object.position),t.zoom0=t.object.zoom},this.reset=function(){t.target.copy(t.target0),t.object.position.copy(t.position0),t.object.zoom=t.zoom0,t.object.updateProjectionMatrix(),t.dispatchEvent(It),t.update(),s=i.NONE},this.update=function(){const e=new O,r=new Dt().setFromUnitVectors(o.up,new O(0,1,0)),u=r.clone().invert(),m=new O,j=new Dt,H=new O,A=2*Math.PI;return function(ge=null){const _t=t.object.position;e.copy(_t).sub(t.target),e.applyQuaternion(r),c.setFromVector3(e),t.autoRotate&&s===i.NONE&&L(X(ge)),t.enableDamping?(c.theta+=l.theta*t.dampingFactor,c.phi+=l.phi*t.dampingFactor):(c.theta+=l.theta,c.phi+=l.phi);let W=t.minAzimuthAngle,U=t.maxAzimuthAngle;isFinite(W)&&isFinite(U)&&(W<-Math.PI?W+=A:W>Math.PI&&(W-=A),U<-Math.PI?U+=A:U>Math.PI&&(U-=A),W<=U?c.theta=Math.max(W,Math.min(U,c.theta)):c.theta=c.theta>(W+U)/2?Math.max(W,c.theta):Math.min(U,c.theta)),c.phi=Math.max(t.minPolarAngle,Math.min(t.maxPolarAngle,c.phi)),c.makeSafe(),t.enableDamping===!0?t.target.addScaledVector(d,t.dampingFactor):t.target.add(d),t.target.sub(t.cursor),t.target.clampLength(t.minTargetRadius,t.maxTargetRadius),t.target.add(t.cursor);let tt=!1;if(t.zoomToCursor&&D||t.object.isOrthographicCamera)c.radius=x(c.radius);else{const Y=c.radius;c.radius=x(c.radius*p),tt=Y!=c.radius}if(e.setFromSpherical(c),e.applyQuaternion(u),_t.copy(t.target).add(e),t.object.lookAt(t.target),t.enableDamping===!0?(l.theta*=1-t.dampingFactor,l.phi*=1-t.dampingFactor,d.multiplyScalar(1-t.dampingFactor)):(l.set(0,0,0),d.set(0,0,0)),t.zoomToCursor&&D){let Y=null;if(t.object.isPerspectiveCamera){const et=e.length();Y=x(et*p);const at=et-Y;t.object.position.addScaledVector(_,at),t.object.updateMatrixWorld(),tt=!!at}else if(t.object.isOrthographicCamera){const et=new O(C.x,C.y,0);et.unproject(t.object);const at=t.object.zoom;t.object.zoom=Math.max(t.minZoom,Math.min(t.maxZoom,t.object.zoom/p)),t.object.updateProjectionMatrix(),tt=at!==t.object.zoom;const kt=new O(C.x,C.y,0);kt.unproject(t.object),t.object.position.sub(kt).add(et),t.object.updateMatrixWorld(),Y=e.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),t.zoomToCursor=!1;Y!==null&&(this.screenSpacePanning?t.target.set(0,0,-1).transformDirection(t.object.matrix).multiplyScalar(Y).add(t.object.position):(rt.origin.copy(t.object.position),rt.direction.set(0,0,-1).transformDirection(t.object.matrix),Math.abs(t.object.up.dot(rt.direction))<Ye?o.lookAt(t.target):(Ft.setFromNormalAndCoplanarPoint(t.object.up,t.target),rt.intersectPlane(Ft,t.target))))}else if(t.object.isOrthographicCamera){const Y=t.object.zoom;t.object.zoom=Math.max(t.minZoom,Math.min(t.maxZoom,t.object.zoom/p)),Y!==t.object.zoom&&(t.object.updateProjectionMatrix(),tt=!0)}return p=1,D=!1,tt||m.distanceToSquared(t.object.position)>h||8*(1-j.dot(t.object.quaternion))>h||H.distanceToSquared(t.target)>h?(t.dispatchEvent(It),m.copy(t.object.position),j.copy(t.object.quaternion),H.copy(t.target),!0):!1}}(),this.dispose=function(){t.domElement.removeEventListener("contextmenu",St),t.domElement.removeEventListener("pointerdown",Et),t.domElement.removeEventListener("pointercancel",J),t.domElement.removeEventListener("wheel",vt),t.domElement.removeEventListener("pointermove",ht),t.domElement.removeEventListener("pointerup",J),t.domElement.getRootNode().removeEventListener("keydown",Ot,{capture:!0}),t._domElementKeyEvents!==null&&(t._domElementKeyEvents.removeEventListener("keydown",ut),t._domElementKeyEvents=null)};const t=this,i={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let s=i.NONE;const h=1e-6,c=new Lt,l=new Lt;let p=1;const d=new O,b=new I,f=new I,E=new I,P=new I,M=new I,w=new I,y=new I,S=new I,R=new I,_=new O,C=new I;let D=!1;const g=[],k={};let z=!1;function X(e){return e!==null?2*Math.PI/60*t.autoRotateSpeed*e:2*Math.PI/60/60*t.autoRotateSpeed}function F(e){const r=Math.abs(e*.01);return Math.pow(.95,t.zoomSpeed*r)}function L(e){l.theta-=e}function T(e){l.phi-=e}const Z=function(){const e=new O;return function(u,m){e.setFromMatrixColumn(m,0),e.multiplyScalar(-u),d.add(e)}}(),v=function(){const e=new O;return function(u,m){t.screenSpacePanning===!0?e.setFromMatrixColumn(m,1):(e.setFromMatrixColumn(m,0),e.crossVectors(t.object.up,e)),e.multiplyScalar(u),d.add(e)}}(),B=function(){const e=new O;return function(u,m){const j=t.domElement;if(t.object.isPerspectiveCamera){const H=t.object.position;e.copy(H).sub(t.target);let A=e.length();A*=Math.tan(t.object.fov/2*Math.PI/180),Z(2*u*A/j.clientHeight,t.object.matrix),v(2*m*A/j.clientHeight,t.object.matrix)}else t.object.isOrthographicCamera?(Z(u*(t.object.right-t.object.left)/t.object.zoom/j.clientWidth,t.object.matrix),v(m*(t.object.top-t.object.bottom)/t.object.zoom/j.clientHeight,t.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),t.enablePan=!1)}}();function $(e){t.object.isPerspectiveCamera||t.object.isOrthographicCamera?p/=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),t.enableZoom=!1)}function nt(e){t.object.isPerspectiveCamera||t.object.isOrthographicCamera?p*=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),t.enableZoom=!1)}function it(e,r){if(!t.zoomToCursor)return;D=!0;const u=t.domElement.getBoundingClientRect(),m=e-u.left,j=r-u.top,H=u.width,A=u.height;C.x=m/H*2-1,C.y=-(j/A)*2+1,_.set(C.x,C.y,1).unproject(t.object).sub(t.object.position).normalize()}function x(e){return Math.max(t.minDistance,Math.min(t.maxDistance,e))}function q(e){b.set(e.clientX,e.clientY)}function Jt(e){it(e.clientX,e.clientX),y.set(e.clientX,e.clientY)}function bt(e){P.set(e.clientX,e.clientY)}function te(e){f.set(e.clientX,e.clientY),E.subVectors(f,b).multiplyScalar(t.rotateSpeed);const r=t.domElement;L(2*Math.PI*E.x/r.clientHeight),T(2*Math.PI*E.y/r.clientHeight),b.copy(f),t.update()}function ee(e){S.set(e.clientX,e.clientY),R.subVectors(S,y),R.y>0?$(F(R.y)):R.y<0&&nt(F(R.y)),y.copy(S),t.update()}function oe(e){M.set(e.clientX,e.clientY),w.subVectors(M,P).multiplyScalar(t.panSpeed),B(w.x,w.y),P.copy(M),t.update()}function ne(e){it(e.clientX,e.clientY),e.deltaY<0?nt(F(e.deltaY)):e.deltaY>0&&$(F(e.deltaY)),t.update()}function ie(e){let r=!1;switch(e.code){case t.keys.UP:e.ctrlKey||e.metaKey||e.shiftKey?T(2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):B(0,t.keyPanSpeed),r=!0;break;case t.keys.BOTTOM:e.ctrlKey||e.metaKey||e.shiftKey?T(-2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):B(0,-t.keyPanSpeed),r=!0;break;case t.keys.LEFT:e.ctrlKey||e.metaKey||e.shiftKey?L(2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):B(t.keyPanSpeed,0),r=!0;break;case t.keys.RIGHT:e.ctrlKey||e.metaKey||e.shiftKey?L(-2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):B(-t.keyPanSpeed,0),r=!0;break}r&&(e.preventDefault(),t.update())}function yt(e){if(g.length===1)b.set(e.pageX,e.pageY);else{const r=G(e),u=.5*(e.pageX+r.x),m=.5*(e.pageY+r.y);b.set(u,m)}}function Mt(e){if(g.length===1)P.set(e.pageX,e.pageY);else{const r=G(e),u=.5*(e.pageX+r.x),m=.5*(e.pageY+r.y);P.set(u,m)}}function Tt(e){const r=G(e),u=e.pageX-r.x,m=e.pageY-r.y,j=Math.sqrt(u*u+m*m);y.set(0,j)}function ae(e){t.enableZoom&&Tt(e),t.enablePan&&Mt(e)}function se(e){t.enableZoom&&Tt(e),t.enableRotate&&yt(e)}function wt(e){if(g.length==1)f.set(e.pageX,e.pageY);else{const u=G(e),m=.5*(e.pageX+u.x),j=.5*(e.pageY+u.y);f.set(m,j)}E.subVectors(f,b).multiplyScalar(t.rotateSpeed);const r=t.domElement;L(2*Math.PI*E.x/r.clientHeight),T(2*Math.PI*E.y/r.clientHeight),b.copy(f)}function xt(e){if(g.length===1)M.set(e.pageX,e.pageY);else{const r=G(e),u=.5*(e.pageX+r.x),m=.5*(e.pageY+r.y);M.set(u,m)}w.subVectors(M,P).multiplyScalar(t.panSpeed),B(w.x,w.y),P.copy(M)}function Pt(e){const r=G(e),u=e.pageX-r.x,m=e.pageY-r.y,j=Math.sqrt(u*u+m*m);S.set(0,j),R.set(0,Math.pow(S.y/y.y,t.zoomSpeed)),$(R.y),y.copy(S);const H=(e.pageX+r.x)*.5,A=(e.pageY+r.y)*.5;it(H,A)}function re(e){t.enableZoom&&Pt(e),t.enablePan&&xt(e)}function ce(e){t.enableZoom&&Pt(e),t.enableRotate&&wt(e)}function Et(e){t.enabled!==!1&&(g.length===0&&(t.domElement.setPointerCapture(e.pointerId),t.domElement.addEventListener("pointermove",ht),t.domElement.addEventListener("pointerup",J)),!fe(e)&&(pe(e),e.pointerType==="touch"?jt(e):le(e)))}function ht(e){t.enabled!==!1&&(e.pointerType==="touch"?de(e):he(e))}function J(e){switch(me(e),g.length){case 0:t.domElement.releasePointerCapture(e.pointerId),t.domElement.removeEventListener("pointermove",ht),t.domElement.removeEventListener("pointerup",J),t.dispatchEvent(Nt),s=i.NONE;break;case 1:const r=g[0],u=k[r];jt({pointerId:r,pageX:u.x,pageY:u.y});break}}function le(e){let r;switch(e.button){case 0:r=t.mouseButtons.LEFT;break;case 1:r=t.mouseButtons.MIDDLE;break;case 2:r=t.mouseButtons.RIGHT;break;default:r=-1}switch(r){case V.DOLLY:if(t.enableZoom===!1)return;Jt(e),s=i.DOLLY;break;case V.ROTATE:if(e.ctrlKey||e.metaKey||e.shiftKey){if(t.enablePan===!1)return;bt(e),s=i.PAN}else{if(t.enableRotate===!1)return;q(e),s=i.ROTATE}break;case V.PAN:if(e.ctrlKey||e.metaKey||e.shiftKey){if(t.enableRotate===!1)return;q(e),s=i.ROTATE}else{if(t.enablePan===!1)return;bt(e),s=i.PAN}break;default:s=i.NONE}s!==i.NONE&&t.dispatchEvent(dt)}function he(e){switch(s){case i.ROTATE:if(t.enableRotate===!1)return;te(e);break;case i.DOLLY:if(t.enableZoom===!1)return;ee(e);break;case i.PAN:if(t.enablePan===!1)return;oe(e);break}}function vt(e){t.enabled===!1||t.enableZoom===!1||s!==i.NONE||(e.preventDefault(),t.dispatchEvent(dt),ne(ue(e)),t.dispatchEvent(Nt))}function ue(e){const r=e.deltaMode,u={clientX:e.clientX,clientY:e.clientY,deltaY:e.deltaY};switch(r){case 1:u.deltaY*=16;break;case 2:u.deltaY*=100;break}return e.ctrlKey&&!z&&(u.deltaY*=10),u}function Ot(e){e.key==="Control"&&(z=!0,t.domElement.getRootNode().addEventListener("keyup",Ct,{passive:!0,capture:!0}))}function Ct(e){e.key==="Control"&&(z=!1,t.domElement.getRootNode().removeEventListener("keyup",Ct,{passive:!0,capture:!0}))}function ut(e){t.enabled===!1||t.enablePan===!1||ie(e)}function jt(e){switch(Rt(e),g.length){case 1:switch(t.touches.ONE){case Q.ROTATE:if(t.enableRotate===!1)return;yt(e),s=i.TOUCH_ROTATE;break;case Q.PAN:if(t.enablePan===!1)return;Mt(e),s=i.TOUCH_PAN;break;default:s=i.NONE}break;case 2:switch(t.touches.TWO){case Q.DOLLY_PAN:if(t.enableZoom===!1&&t.enablePan===!1)return;ae(e),s=i.TOUCH_DOLLY_PAN;break;case Q.DOLLY_ROTATE:if(t.enableZoom===!1&&t.enableRotate===!1)return;se(e),s=i.TOUCH_DOLLY_ROTATE;break;default:s=i.NONE}break;default:s=i.NONE}s!==i.NONE&&t.dispatchEvent(dt)}function de(e){switch(Rt(e),s){case i.TOUCH_ROTATE:if(t.enableRotate===!1)return;wt(e),t.update();break;case i.TOUCH_PAN:if(t.enablePan===!1)return;xt(e),t.update();break;case i.TOUCH_DOLLY_PAN:if(t.enableZoom===!1&&t.enablePan===!1)return;re(e),t.update();break;case i.TOUCH_DOLLY_ROTATE:if(t.enableZoom===!1&&t.enableRotate===!1)return;ce(e),t.update();break;default:s=i.NONE}}function St(e){t.enabled!==!1&&e.preventDefault()}function pe(e){g.push(e.pointerId)}function me(e){delete k[e.pointerId];for(let r=0;r<g.length;r++)if(g[r]==e.pointerId){g.splice(r,1);return}}function fe(e){for(let r=0;r<g.length;r++)if(g[r]==e.pointerId)return!0;return!1}function Rt(e){let r=k[e.pointerId];r===void 0&&(r=new I,k[e.pointerId]=r),r.set(e.pageX,e.pageY)}function G(e){const r=e.pointerId===g[0]?g[1]:g[0];return k[r]}t.domElement.addEventListener("contextmenu",St),t.domElement.addEventListener("pointerdown",Et),t.domElement.addEventListener("pointercancel",J),t.domElement.addEventListener("wheel",vt,{passive:!1}),t.domElement.getRootNode().addEventListener("keydown",Ot,{passive:!0,capture:!0}),this.update()}}var ze=Math.PI/180,Xe=180/Math.PI;function Zt(a){var o=Bt(a[0]+1,a[2]),n=Bt(a[0],a[2]),t=Wt(a[1]+1,a[2]),i=Wt(a[1],a[2]);return[n,t,o,i]}function Ze(a){var o=Zt(a),n={type:"Polygon",coordinates:[[[o[0],o[3]],[o[0],o[1]],[o[2],o[1]],[o[2],o[3]],[o[0],o[3]]]]};return n}function Bt(a,o){return a/Math.pow(2,o)*360-180}function Wt(a,o){var n=Math.PI-2*Math.PI*a/Math.pow(2,o);return Xe*Math.atan(.5*(Math.exp(n)-Math.exp(-n)))}function pt(a,o,n){var t=Qt(a,o,n);return t[0]=Math.floor(t[0]),t[1]=Math.floor(t[1]),t}function Ht(a){return[[a[0]*2,a[1]*2,a[2]+1],[a[0]*2+1,a[1]*2,a[2]+1],[a[0]*2+1,a[1]*2+1,a[2]+1],[a[0]*2,a[1]*2+1,a[2]+1]]}function Kt(a){return[a[0]>>1,a[1]>>1,a[2]-1]}function qt(a){return Ht(Kt(a))}function He(a,o){for(var n=qt(a),t=0;t<n.length;t++)if(!Gt(o,n[t]))return!1;return!0}function Gt(a,o){for(var n=0;n<a.length;n++)if(Vt(a[n],o))return!0;return!1}function Vt(a,o){return a[0]===o[0]&&a[1]===o[1]&&a[2]===o[2]}function Ke(a){for(var o="",n=a[2];n>0;n--){var t=0,i=1<<n-1;a[0]&i&&t++,a[1]&i&&(t+=2),o+=t.toString()}return o}function qe(a){for(var o=0,n=0,t=a.length,i=t;i>0;i--){var s=1<<i-1,h=+a[t-i];h===1&&(o|=s),h===2&&(n|=s),h===3&&(o|=s,n|=s)}return[o,n,t]}function Ge(a){var o=pt(a[0],a[1],32),n=pt(a[2],a[3],32),t=[o[0],o[1],n[0],n[1]],i=Ve(t);if(i===0)return[0,0,0];var s=t[0]>>>32-i,h=t[1]>>>32-i;return[s,h,i]}function Ve(a){for(var o=28,n=0;n<o;n++){var t=1<<32-(n+1);if((a[0]&t)!==(a[2]&t)||(a[1]&t)!==(a[3]&t))return n}return o}function Qt(a,o,n){var t=Math.sin(o*ze),i=Math.pow(2,n),s=i*(a/360+.5),h=i*(.5-.25*Math.log((1+t)/(1-t))/Math.PI);return s=s%i,s<0&&(s=s+i),[s,h,n]}var ct={tileToGeoJSON:Ze,tileToBBOX:Zt,getChildren:Ht,getParent:Kt,getSiblings:qt,hasTile:Gt,hasSiblings:He,tilesEqual:Vt,tileToQuadkey:Ke,quadkeyToTile:qe,pointToTile:pt,bboxToTile:Ge,pointToTileFraction:Qt};class gt extends Xt{constructor(){super(),this.isDisposed=!1,this.isReady=!1,this.childrenTiles=[],this.boundingBoxWorld=new we}init(o,n,t){this.tileNo=o,Object.freeze(this.tileNo),this.map=n,this.parentTile=t,this.visible=!1,this.renderOrder=o[2],this.ready()}async ready(){if(this.content=await this.map.provider.getTile(this.tileNo),!this.isDisposed){if(this.add(this.content),this.boundingBoxWorld.setFromObject(this.content).applyMatrix4(this.matrixWorld.makeRotationX(-Math.PI/2)),this.map.add(this),this.visible=!0,this.isReady=!0,this.parentTile){const o=this.parentTile.childrenTiles;let n=0;for(let t=0;t<o.length;t++)o[t].isReady&&n++;n===4&&(this.parentTile.visible=!1)}this.update()}}update(){if(!this.isReady||this.isDisposed)return;const{cameraFrustum:o,cameraWorldPosition:n}=this.map;if(!o.intersectsBox(this.boundingBoxWorld)){this.simplify();return}this.content instanceof ft&&this.map.provider.filter&&(this.content.material.uniforms.t_Matrix.value=this.map.provider.getTranMatrix());let t=this.boundingBoxWorld.distanceToPoint(n);const i=this.tileNo[2];t/=Math.pow(2,this.map.provider.maxZoom-i),t<60&&this.subdivide(),t>80&&this.simplify(),this.childrenTiles.sort((h,c)=>h.boundingBoxWorld.distanceToPoint(n)-c.boundingBoxWorld.distanceToPoint(n)).forEach(h=>h.update())}subdivide(){const{isReady:o,tileNo:n,map:t,childrenTiles:i}=this,s=n[2];if(!o||i.length>0||s>=t.maxZoom)return;ct.getChildren(n).forEach(c=>{const l=new gt;l.init(c,t,this),i.push(l)})}simplify(){this.childrenTiles.forEach(o=>o.dispose()),this.childrenTiles=[],this.visible=!0}dispose(){this.map.remove(this),this.map.provider.abort(this.tileNo),this.childrenTiles.forEach(o=>o.dispose()),this.childrenTiles=[],this.parentTile=void 0,this.content&&(this.map.provider.dispose(this.tileNo,this.content),this.content=void 0),this.isDisposed=!0}}let yo=class extends Xt{constructor(){super(),this.bbox=[74.390592,6.900905,134.071423,54.318199],this.maxZoom=20,this.rootForward=0,this.cameraFrustum=new xe,this.cameraWorldPosition=new O,this.cameraProjectionMatrix=new K,this.lastCameraProjectionMatrix=new K,this.lastCameraWorldPosition=new O,this.rootTiles=[],this.lastUpdateTime=0,st.prototype.computeBoundsTree||(st.prototype.computeBoundsTree=Ne),st.prototype.disposeBoundsTree||(st.prototype.disposeBoundsTree=Fe),ft.prototype.raycast=Be}initRootTiles(){this.rootForward>3&&(console.warn("rootForward needs to be 0 - 3."),this.rootForward=3),this.rootForward<0&&(console.warn("rootForward needs to be 0 - 3."),this.rootForward=0);const o=[];let n=[ct.bboxToTile(this.bbox)],t=this.rootForward;for(;t>0;){const i=[...n];n=[],i.forEach(s=>{const h=ct.getChildren(s);n.push(...h)}),t--}o.push(...n),o.forEach(i=>{const s=new gt;s.init(i,this),this.rootTiles.push(s)})}update(){if(!this.visible||!this.camera)return;const o=Date.now();if(!(o-this.lastUpdateTime<300)){if(this.rootTiles.length===0){this.initRootTiles();return}this.camera.getWorldPosition(this.cameraWorldPosition),this.cameraProjectionMatrix.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),!(this.cameraWorldPosition.equals(this.lastCameraWorldPosition)&&this.cameraProjectionMatrix.equals(this.lastCameraProjectionMatrix))&&(this.cameraFrustum.setFromProjectionMatrix(this.cameraProjectionMatrix),this.rootTiles.forEach(n=>n.update()),this.lastCameraProjectionMatrix.copy(this.cameraProjectionMatrix),this.lastCameraWorldPosition.copy(this.cameraWorldPosition),this.lastUpdateTime=o)}}dispose(){throw new Error("[Map.dispose] Method not implemented.")}regenerate(){throw new Error("[Map.regenerate] Method not implemented.")}},ot;async function Qe(a,o,n=!1){const i=await(await o.ready()).blob(),s=await createImageBitmap(i,n?void 0:{imageOrientation:"flipY"});if(!n)return s;ot||(ot=new OffscreenCanvas(256,256));const h=ot.getContext("2d");if(!h)throw new Error('Offscreencanvas.getContext("2d") error!');const{width:c,height:l}=ot;return h.drawImage(s,0,0),h.rect(0,0,c,l),h.strokeStyle="#00FFFF",h.font="20px Arial",h.stroke(),h.fillStyle="#FF4444",h.fillText("".concat(a[0]),10,30),h.fillStyle="#44FF44",h.fillText("".concat(a[1]),10,55),h.fillStyle="#66AAFF",h.fillText("".concat(a[2]),10,80),await createImageBitmap(ot,{imageOrientation:"flipY"})}class $e{constructor(o){this.terminated=!0,this.map=new Map,this.worker=new o,this.worker.onmessage=this.onMessage.bind(this),this.terminated=!1}async postMessage(o){if(!this.terminated)return this.worker.postMessage(o),new Promise((n,t)=>{this.map.set(o.id,n)})}onMessage(o){const{id:n,error:t}=o.data,i=this.map.get(n);i&&!t&&i(o.data),this.map.delete(n)}terminate(){this.worker.onmessage=null,this.worker.terminate(),this.terminated=!0,this.map.clear()}}function Je(a){return new Worker(""+new URL("../static/MapWorker-InhFhe39.js",import.meta.url).href,{name:a==null?void 0:a.name})}class To{constructor(){this.maxZoom=20,this.source="https://gac-geo.googlecnapps.cn/maps/vt?lyrs=s&x=[x]&y=[y]&z=[z]",this.showTileNo=!1,this._useWorker=!1,this.fetching=new Map}set useWorker(o){var n;this._useWorker=o,this._useWorker||((n=this._worker)==null||n.terminate(),this._worker=void 0)}get useWorker(){return this._useWorker}async getTile(o){const n=this.getUrl(o),t=new Pe;if(this._useWorker){this._worker||(this._worker=new $e(Je));const i=this.getId(o),s=await this._worker.postMessage({id:i,tileNo:o,url:n,debug:this.showTileNo});t.image=s.bitmap}else{const i=new We(n,{cache:"force-cache",mode:"cors"});this.fetching.set(o,i);try{t.image=await Qe(o,i,this.showTileNo)}finally{this.fetching.delete(o)}}return t.needsUpdate=!0,t.anisotropy=4,t}abort(o){var n;if(this._useWorker)(n=this._worker)==null||n.postMessage({id:this.getId(o),abort:!0});else{const t=this.fetching.get(o);t&&t.abort(),this.fetching.delete(o)}}dispose(o,n){n.dispose()}getId(o){return o.join("-")}getUrl(o){const[n,t,i]=o;return this.source.indexOf("[x]")===-1?this.source.replace("{x}",n+"").replace("{y}",t+"").replace("{z}",i+""):this.source.replace("[x]",n+"").replace("[y]",t+"").replace("[z]",i+"")}}const mt="utm",to="merc",lt=6378137,Ut=Math.PI/180;function Yt(a,o){const n=lt*a*Ut,t=lt*Math.log(Math.tan(Math.PI*.25+o*Ut*.5));return[n,t]}function eo(a,o){let n=a/(lt*Math.PI)*180,t=o/(lt*Math.PI)*180;return t=180/Math.PI*(2*Math.atan(Math.exp(t*Math.PI/180))-Math.PI/2),[n,t]}function N(a){return a*Math.PI/180}function zt(a){return a*180/Math.PI}const $t={a:6378137,b:6356752314245e-6,f:1/298.257223563},oo="CDEFGHJKLMNPQRSTUVWXX",no=5e5,io=1e7;function ao(a,o,n){if(!(-80<=o&&o<=84))throw new RangeError("latitude ‘".concat(o,"’ outside UTM limits"));let t=n||Math.floor((a+180)/6)+1,i=N((t-1)*6-180+3);const s=oo.charAt(Math.floor(o/8+10));t===31&&s==="V"&&a>=3?(t++,i+=N(6)):t===32&&s==="X"&&a<9?(t--,i-=N(6)):t===32&&s==="X"&&a>=9?(t++,i+=N(6)):t===34&&s==="X"&&a<21?(t--,i-=N(6)):t===34&&s==="X"&&a>=21?(t++,i+=N(6)):t===36&&s==="X"&&a<33?(t--,i-=N(6)):t===36&&s==="X"&&a>=33&&(t++,i+=N(6));const h=N(o),c=N(a)-i,{a:l,f:p}=$t,d=.9996,b=Math.sqrt(p*(2-p)),f=p/(2-p),E=f*f,P=f*E,M=f*P,w=f*M,y=f*w,S=Math.cos(c),R=Math.sin(c),_=Math.tan(h),C=Math.sinh(b*Math.atanh(b*_/Math.sqrt(1+_*_))),D=_*Math.sqrt(1+C*C)-C*Math.sqrt(1+_*_),g=Math.atan2(D,S),k=Math.asinh(R/Math.sqrt(D*D+S*S)),z=l/(1+f)*(1+1/4*E+1/64*M+1/256*y),X=[null,1/2*f-2/3*E+5/16*P+41/180*M-127/288*w+7891/37800*y,13/48*E-3/5*P+557/1440*M+281/630*w-1983433/1935360*y,61/240*P-103/140*M+15061/26880*w+167603/181440*y,49561/161280*M-179/168*w+6601661/7257600*y,34729/80640*w-3418889/1995840*y,212378941/319334400*y];let F=g;for(let v=1;v<=6;v++)F+=X[v]*Math.sin(2*v*g)*Math.cosh(2*v*k);let L=k;for(let v=1;v<=6;v++)L+=X[v]*Math.cos(2*v*g)*Math.sinh(2*v*k);let T=d*z*L,Z=d*z*F;return T=T+no,Z<0&&(Z=Z+io),[T,Z]}function so(a,o,n){const i=n||50,s=5e5,{a:h,f:c}=$t,l=.9996,p=a-s,d=o,b=Math.sqrt(c*(2-c)),f=c/(2-c),E=f*f,P=f*E,M=f*P,w=f*M,y=f*w,S=h/(1+f)*(1+1/4*E+1/64*M+1/256*y),R=p/(l*S),_=d/(l*S),C=[null,1/2*f-2/3*E+37/96*P-1/360*M-81/512*w+96199/604800*y,1/48*E+1/15*P-437/1440*M+46/105*w-1118711/3870720*y,17/480*P-37/840*M-209/4480*w+5569/90720*y,4397/161280*M-11/504*w-830251/7257600*y,4583/161280*w-108847/3991680*y,20648693/638668800*y];let D=_;for(let x=1;x<=6;x++)D-=C[x]*Math.sin(2*x*_)*Math.cosh(2*x*R);let g=R;for(let x=1;x<=6;x++)g-=C[x]*Math.cos(2*x*_)*Math.sinh(2*x*R);const k=Math.sinh(g),z=Math.sin(D),X=Math.cos(D),F=z/Math.sqrt(k*k+X*X);let L=null,T=F;do{const x=Math.sinh(b*Math.atanh(b*T/Math.sqrt(1+T*T))),q=T*Math.sqrt(1+x*x)-x*Math.sqrt(1+T*T);L=(F-q)/Math.sqrt(1+q*q)*(1+(1-b*b)*T*T)/((1-b*b)*Math.sqrt(1+T*T)),T+=L}while(Math.abs(L)>1e-12);const v=Math.atan(T);let B=Math.atan2(k,X);const $=N((i-1)*6-180+3);B+=$;const nt=Number(zt(v).toFixed(14));return[Number(zt(B).toFixed(14)),nt]}class wo{constructor(){this.utmZone=50,this.coordType=mt,this.maxZoom=20}async getTile(o){const n=new Ee,t=ct.tileToBBOX(o),i=this.convertCoordinate(t[0],t[3]),s=this.convertCoordinate(t[2],t[3]),h=this.convertCoordinate(t[0],t[1]),c=this.convertCoordinate(t[2],t[1]),l=new Float32Array([i[0],i[1],0,s[0],s[1],0,h[0],h[1],0,c[0],c[1],0]);return n.setAttribute("position",new ve(l,3)),n}abort(o){}dispose(o,n){n.dispose()}convertCoordinate(o,n){switch(this.coordType){case mt:return ao(o,n,this.utmZone);case to:return Yt(o,n);default:return Yt(o,n)}}}class ro extends ft{constructor(o){super(o),this.center=new O}}class xo{constructor(o,n){this.geometryProvider=o,this.textureProvider=n,this.maxZoom=20,this.showBoundingBox=!1,this.wireframe=!1,this.flatShading=!1,this.useStandardMaterial=!1,this.filter=null}getTranMatrix(){var n,t,i,s,h;let o=new K;if((n=this.filter)!=null&&n.opposite){let c=new K;c.set(-1,0,0,0,0,-1,0,0,0,0,-1,0,1,1,1,1),o.multiply(c)}if((t=this.filter)!=null&&t.monochrome){let c=new K;const l=this.filter.monochrome.r,p=this.filter.monochrome.g,d=this.filter.monochrome.b;c.set(l,p,d,0,l,p,d,0,l,p,d,0,0,0,0,1),o.multiply(c)}if((i=this.filter)!=null&&i.genBright){let c=new K;const l=this.filter.genBright;c.set(l,0,0,0,0,l,0,0,0,0,l,0,0,0,0,1),o.multiply(c)}if((s=this.filter)!=null&&s.genContrast){let c=new K;const l=this.filter.genContrast,p=.5*(1-l);c.set(l,0,0,0,0,l,0,0,0,0,l,0,p,p,p,1),o.multiply(c)}if((h=this.filter)!=null&&h.genSaturate){let c=new K;const l=this.filter.genSaturate,p=.3*(1-l),d=.6*(1-l),b=.1*(1-l);c.set(p+l,p,p,0,d,d+l,d,0,b,b,b+l,0,0,0,0,1),o.multiply(c)}return o}async getTile(o){const n=[this.geometryProvider.getTile(o),this.textureProvider.getTile(o)],t=await Promise.all(n),i=t[0],s=t[1];s.colorSpace=Oe;const{wireframe:h,flatShading:c}=this;let l=null;const p=o[0]+o[1]+o[2];l=this.useStandardMaterial?new Ce({map:s,wireframe:h,flatShading:c}):new je({map:s,wireframe:h}),this.filter&&(l=new Ue({baseMaterial:l,vertexShader:"\n                varying vec2 vUv;    //顶点纹理坐标\n                void main () {\n                    vUv = uv;\n                    // gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4( position, 1.0 ); 着色器会抖动\n                    // gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n                    csm_Position = position * vec3(1.0);\n                }\n                ",fragmentShader:"\n                uniform sampler2D e_Texture;     //纹理图像\n                varying vec2 vUv;               //片元纹理坐标\n                uniform mat4 t_Matrix;     //接收变换矩阵\n                void main () {\n                    // gl_FragColor = texture2D( e_Texture, vUv );\n\n                    // vec4 textureColor = texture2D( e_Texture, vUv );\n                    // //计算加权平均值\n                    // float w_a = textureColor.r * 0.3 + textureColor.g * 0.6 + textureColor.b * 0.1;\n                    // gl_FragColor = vec4(w_a, w_a, w_a, 1.0);\n\n                    vec4 textureColor = texture2D( e_Texture, vUv );\n                    //变换矩阵乘以 vec4(R,G,B,1)    --->vec4(R,G,B,1) 是齐次坐标，原本是n维的向量用一个n+1维向量来表示\n                    //vec4(R,G,B,1)第四个分量不是透明度\n                    vec4 transColor =  vec4(textureColor.r, textureColor.g, textureColor.b, 1.0)*t_Matrix; \n                    //设置透明度\n                    transColor.a = 1.0;\n                    csm_FragColor = transColor;\n\n                    // if(vUv.x==0.0 || vUv.x==1.0 || vUv.y==0.0 || vUv.y==1.0){\n                    //     gl_FragColor.a = 0.0;\n                    // }\n                }",silent:!0,flatShading:c,uniforms:{e_Texture:{value:s},t_Matrix:{value:this.getTranMatrix()}}}));const d=new ro;if(d.renderOrder=p,i.computeBoundingBox(),i.boundingBox.getCenter(d.center),i.center(),i.computeBoundingSphere(),i.computeBoundsTree(),d.position.copy(d.center),d.geometry=i,d.material=l,this.showBoundingBox){const b=new Se(i.boundingBox);d.add(b)}return d}abort(o){this.geometryProvider.abort(o),this.textureProvider.abort(o)}dispose(o,n){const t=n.geometry,i=n.material;t&&this.geometryProvider.dispose(o,t),i&&i.map&&this.textureProvider.dispose(o,i.map),i==null||i.dispose()}}const co={class:"lonLatDiv"},lo=Re({__name:"raycasterEvent",props:{tileMapRef:{}},setup(a){const o=a,n=_e([0,0]);return ke(()=>o.tileMapRef,(t,i)=>{if(!i&&t){let c=function(l){h.x=l.clientX/window.innerWidth*2-1,h.y=-(l.clientY/window.innerHeight)*2+1,s.setFromCamera(h,t.camera);var p=s.intersectObjects(t.map.children);if(p.length>0){var d=p[0];t.map.provider.geometryProvider.coordType===mt?n.value=so(d.point.x,-d.point.z):n.value=eo(d.point.x,-d.point.z),n.value[0]=n.value[0].toFixed(4),n.value[1]=n.value[1].toFixed(4)}};console.log("raycasterEvent:",t);var s=new Ae,h=new I;document.addEventListener("mousemove",c,!1)}}),(t,i)=>(De(),Le("div",co," lon:"+At(n.value[0])+" lat:"+At(n.value[1]),1))}}),Po=Ie(lo,[["__scopeId","data-v-462a60f8"]]);export{yo as M,bo as O,wo as P,xo as T,mt as U,To as a,$e as b,to as c,Yt as d,ao as l,Po as r};
