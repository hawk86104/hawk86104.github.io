import{g as e,c as r}from"./@amap.D8CfaEsq1763540743861.js";import{r as t}from"./crypto-js.CLP5yTup1763540743861.js";var n={exports:{}};
/**
 * workerpool.js
 * https://github.com/josdejong/workerpool
 *
 * Offload tasks to a pool of workers on node.js and in the browser.
 *
 * @version 9.3.4
 * @date    2025-09-10
 *
 * @license
 * Copyright (C) 2014-2022 Jos de Jong <wjosdejong@gmail.com>
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License. You may obtain a copy
 * of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */!function(e){var r={},n={exports:{}};!function(e){var r=function(e){return void 0!==e&&null!=e.versions&&null!=e.versions.node&&e+""=="[object process]"};e.exports.isNode=r,e.exports.platform="undefined"!=typeof process&&r(process)?"node":"browser";var n="node"===e.exports.platform&&t;e.exports.isMainThread="node"===e.exports.platform?(!n||n.isMainThread)&&!process.connected:"undefined"!=typeof Window,e.exports.cpus="browser"===e.exports.platform?self.navigator.hardwareConcurrency:t.cpus().length}(n);var o,i=n.exports,s={};function u(){if(o)return s;function e(o,i){var s=this;if(!(this instanceof e))throw new SyntaxError("Constructor must be called with the new operator");if("function"!=typeof o)throw new SyntaxError("Function parameter handler(resolve, reject) missing");var u=[],a=[];this.resolved=!1,this.rejected=!1,this.pending=!0,this[Symbol.toStringTag]="Promise";var c=function(e,r){u.push(e),a.push(r)};this.then=function(t,n){return new e(function(e,o){var i=t?r(t,e,o):e,s=n?r(n,e,o):o;c(i,s)},s)};var f=function(e){return s.resolved=!0,s.rejected=!1,s.pending=!1,u.forEach(function(r){r(e)}),c=function(r,t){r(e)},f=p=function(){},s},p=function(e){return s.resolved=!1,s.rejected=!0,s.pending=!1,a.forEach(function(r){r(e)}),c=function(r,t){t(e)},f=p=function(){},s};this.cancel=function(){return i?i.cancel():p(new t),s},this.timeout=function(e){if(i)i.timeout(e);else{var r=setTimeout(function(){p(new n("Promise timed out after "+e+" ms"))},e);s.always(function(){clearTimeout(r)})}return s},o(function(e){f(e)},function(e){p(e)})}function r(e,r,t){return function(n){try{var o=e(n);o&&"function"==typeof o.then&&"function"==typeof o.catch?o.then(r,t):r(o)}catch(i){t(i)}}}function t(e){this.message=e||"promise cancelled",this.stack=(new Error).stack}function n(e){this.message=e||"timeout exceeded",this.stack=(new Error).stack}return o=1,e.prototype.catch=function(e){return this.then(null,e)},e.prototype.always=function(e){return this.then(e,e)},e.prototype.finally=function(r){var t=this,n=function(){return new e(function(e){return e()}).then(r).then(function(){return t})};return this.then(n,n)},e.all=function(r){return new e(function(e,t){var n=r.length,o=[];n?r.forEach(function(r,i){r.then(function(r){o[i]=r,0==--n&&e(o)},function(e){n=0,t(e)})}):e(o)})},e.defer=function(){var r={};return r.promise=new e(function(e,t){r.resolve=e,r.reject=t}),r},t.prototype=new Error,t.prototype.constructor=Error,t.prototype.name="CancellationError",e.CancellationError=t,n.prototype=new Error,n.prototype.constructor=Error,n.prototype.name="TimeoutError",e.TimeoutError=n,s.Promise=e,s}function a(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=Array(r);t<r;t++)n[t]=e[t];return n}function c(e,r){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=k(e))||r){t&&(e=t);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,u=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return s=e.done,e},e:function(e){u=!0,i=e},f:function(){try{s||null==t.return||t.return()}finally{if(u)throw i}}}}function f(e,r,t){return(r=h(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function p(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,n)}return t}function d(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?p(Object(t),!0).forEach(function(r){f(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):p(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})}return e}function l(e,r){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,r);if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(e)}function h(e){var r=l(e,"string");return"symbol"==typeof r?r:r+""}function m(e){return m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},m(e)}function k(e,r){if(e){if("string"==typeof e)return a(e,r);var t={}.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?a(e,r):void 0}}var w,y,v,g,b,O,x,T,E={exports:{}},j={};function W(){return w||(w=1,j.validateOptions=function(e,r,t){if(e){var n=e?Object.keys(e):[],o=n.find(function(e){return!r.includes(e)});if(o)throw new Error('Object "'+t+'" contains an unknown option "'+o+'"');var i=r.find(function(e){return Object.prototype[e]&&!n.includes(e)});if(i)throw new Error('Object "'+t+'" contains an inherited option "'+i+'" which is not defined in the object itself but in its prototype. Only plain objects are allowed. Please remove the option from the prototype or override it with a value "undefined".');return e}},j.workerOptsNames=["credentials","name","type"],j.forkOptsNames=["cwd","detached","env","execPath","execArgv","gid","serialization","signal","killSignal","silent","stdio","uid","windowsVerbatimArguments","timeout"],j.workerThreadOptsNames=["argv","env","eval","execArgv","stdin","stdout","stderr","workerData","trackUnmanagedFds","transferList","resourceLimits","name"]),j}function S(){return v?y:(v=1,y='!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e="undefined"!=typeof globalThis?globalThis:e||self).worker=n()}(this,(function(){"use strict";function e(n){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(n)}function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var t={};var r=function(e,n){this.message=e,this.transfer=n},o={};function i(e,n){var t=this;if(!(this instanceof i))throw new SyntaxError("Constructor must be called with the new operator");if("function"!=typeof e)throw new SyntaxError("Function parameter handler(resolve, reject) missing");var r=[],o=[];this.resolved=!1,this.rejected=!1,this.pending=!0,this[Symbol.toStringTag]="Promise";var a=function(e,n){r.push(e),o.push(n)};this.then=function(e,n){return new i((function(t,r){var o=e?s(e,t,r):t,i=n?s(n,t,r):r;a(o,i)}),t)};var f=function(e){return t.resolved=!0,t.rejected=!1,t.pending=!1,r.forEach((function(n){n(e)})),a=function(n,t){n(e)},f=d=function(){},t},d=function(e){return t.resolved=!1,t.rejected=!0,t.pending=!1,o.forEach((function(n){n(e)})),a=function(n,t){t(e)},f=d=function(){},t};this.cancel=function(){return n?n.cancel():d(new u),t},this.timeout=function(e){if(n)n.timeout(e);else{var r=setTimeout((function(){d(new c("Promise timed out after "+e+" ms"))}),e);t.always((function(){clearTimeout(r)}))}return t},e((function(e){f(e)}),(function(e){d(e)}))}function s(e,n,t){return function(r){try{var o=e(r);o&&"function"==typeof o.then&&"function"==typeof o.catch?o.then(n,t):n(o)}catch(e){t(e)}}}function u(e){this.message=e||"promise cancelled",this.stack=(new Error).stack}function c(e){this.message=e||"timeout exceeded",this.stack=(new Error).stack}return i.prototype.catch=function(e){return this.then(null,e)},i.prototype.always=function(e){return this.then(e,e)},i.prototype.finally=function(e){var n=this,t=function(){return new i((function(e){return e()})).then(e).then((function(){return n}))};return this.then(t,t)},i.all=function(e){return new i((function(n,t){var r=e.length,o=[];r?e.forEach((function(e,i){e.then((function(e){o[i]=e,0==--r&&n(o)}),(function(e){r=0,t(e)}))})):n(o)}))},i.defer=function(){var e={};return e.promise=new i((function(n,t){e.resolve=n,e.reject=t})),e},u.prototype=new Error,u.prototype.constructor=Error,u.prototype.name="CancellationError",i.CancellationError=u,c.prototype=new Error,c.prototype.constructor=Error,c.prototype.name="TimeoutError",i.TimeoutError=c,o.Promise=i,function(n){var t=r,i=o.Promise,s="__workerpool-cleanup__",u={exit:function(){}},c={addAbortListener:function(e){u.abortListeners.push(e)},emit:u.emit};if("undefined"!=typeof self&&"function"==typeof postMessage&&"function"==typeof addEventListener)u.on=function(e,n){addEventListener(e,(function(e){n(e.data)}))},u.send=function(e,n){n?postMessage(e,n):postMessage(e)};else{if("undefined"==typeof process)throw new Error("Script must be executed as a worker");var a;try{a=require("worker_threads")}catch(n){if("object"!==e(n)||null===n||"MODULE_NOT_FOUND"!==n.code)throw n}if(a&&null!==a.parentPort){var f=a.parentPort;u.send=f.postMessage.bind(f),u.on=f.on.bind(f),u.exit=process.exit.bind(process)}else u.on=process.on.bind(process),u.send=function(e){process.send(e)},u.on("disconnect",(function(){process.exit(1)})),u.exit=process.exit.bind(process)}function d(e){return e&&e.toJSON?JSON.parse(JSON.stringify(e)):JSON.parse(JSON.stringify(e,Object.getOwnPropertyNames(e)))}function l(e){return e&&"function"==typeof e.then&&"function"==typeof e.catch}u.methods={},u.methods.run=function(e,n){var t=new Function("return ("+e+").apply(this, arguments);");return t.worker=c,t.apply(t,n)},u.methods.methods=function(){return Object.keys(u.methods)},u.terminationHandler=void 0,u.abortListenerTimeout=1e3,u.abortListeners=[],u.terminateAndExit=function(e){var n=function(){u.exit(e)};if(!u.terminationHandler)return n();var t=u.terminationHandler(e);return l(t)?(t.then(n,n),t):(n(),new i((function(e,n){n(new Error("Worker terminating"))})))},u.cleanup=function(e){if(!u.abortListeners.length)return u.send({id:e,method:s,error:d(new Error("Worker terminating"))}),new i((function(e){e()}));var n,t=u.abortListeners.map((function(e){return e()})),r=new i((function(e,t){n=setTimeout((function(){t(new Error("Timeout occured waiting for abort handler, killing worker"))}),u.abortListenerTimeout)})),o=i.all(t).then((function(){clearTimeout(n),u.abortListeners.length||(u.abortListeners=[])}),(function(){clearTimeout(n),u.exit()}));return new i((function(e,n){o.then(e,n),r.then(e,n)})).then((function(){u.send({id:e,method:s,error:null})}),(function(n){u.send({id:e,method:s,error:n?d(n):null})}))};var p=null;u.on("message",(function(e){if("__workerpool-terminate__"===e)return u.terminateAndExit(0);if(e.method===s)return u.cleanup(e.id);try{var n=u.methods[e.method];if(!n)throw new Error(\'Unknown method "\'+e.method+\'"\');p=e.id;var r=n.apply(n,e.params);l(r)?r.then((function(n){n instanceof t?u.send({id:e.id,result:n.message,error:null},n.transfer):u.send({id:e.id,result:n,error:null}),p=null})).catch((function(n){u.send({id:e.id,result:null,error:d(n)}),p=null})):(r instanceof t?u.send({id:e.id,result:r.message,error:null},r.transfer):u.send({id:e.id,result:r,error:null}),p=null)}catch(n){u.send({id:e.id,result:null,error:d(n)})}})),u.register=function(e,n){if(e)for(var t in e)e.hasOwnProperty(t)&&(u.methods[t]=e[t],u.methods[t].worker=c);n&&(u.terminationHandler=n.onTerminate,u.abortListenerTimeout=n.abortListenerTimeout||1e3),u.send("ready")},u.emit=function(e){if(p){if(e instanceof t)return void u.send({id:p,isEvent:!0,payload:e.message},e.transfer);u.send({id:p,isEvent:!0,payload:e})}},n.add=u.register,n.emit=u.emit}(t),n(t)}));\n//# sourceMappingURL=worker.min.js.map\n')}function _(){if(g)return E.exports;g=1;var e=u().Promise,r=i,n=W(),o=n.validateOptions,s=n.forkOptsNames,a=n.workerThreadOptsNames,f=n.workerOptsNames,p="__workerpool-terminate__",l="__workerpool-cleanup__";function h(){var e=w();if(!e)throw new Error("WorkerPool: workerType = 'thread' is not supported, Node >= 11.7.0 required");return e}function k(){if("function"!=typeof Worker&&("object"!==("undefined"==typeof Worker?"undefined":m(Worker))||"function"!=typeof Worker.prototype.constructor))throw new Error("WorkerPool: Web Workers not supported")}function w(){try{return t}catch(e){if("object"===m(e)&&null!==e&&"MODULE_NOT_FOUND"===e.code)return null;throw e}}function y(){if("browser"===r.platform){if("undefined"==typeof Blob)throw new Error("Blob not supported by the browser");if(!window.URL||"function"!=typeof window.URL.createObjectURL)throw new Error("URL.createObjectURL not supported by the browser");var e=new Blob([S()],{type:"text/javascript"});return window.URL.createObjectURL(e)}return __dirname+"/worker.js"}function v(e,n){if("web"===n.workerType)return k(),b(e,n.workerOpts,Worker);if("thread"===n.workerType)return O(e,o=h(),n);if("process"!==n.workerType&&n.workerType){if("browser"===r.platform)return k(),b(e,n.workerOpts,Worker);var o=w();return o?O(e,o,n):x(e,T(n),t)}return x(e,T(n),t)}function b(e,r,t){o(r,f,"workerOpts");var n=new t(e,r);return n.isBrowserWorker=!0,n.on=function(e,r){this.addEventListener(e,function(e){r(e.data)})},n.send=function(e,r){this.postMessage(e,r)},n}function O(e,r,t){var n,i;o(null==t?void 0:t.workerThreadOpts,a,"workerThreadOpts");var s=new r.Worker(e,d({stdout:null!==(n=null==t?void 0:t.emitStdStreams)&&void 0!==n&&n,stderr:null!==(i=null==t?void 0:t.emitStdStreams)&&void 0!==i&&i},null==t?void 0:t.workerThreadOpts));return s.isWorkerThread=!0,s.send=function(e,r){this.postMessage(e,r)},s.kill=function(){return this.terminate(),!0},s.disconnect=function(){this.terminate()},null!=t&&t.emitStdStreams&&(s.stdout.on("data",function(e){return s.emit("stdout",e)}),s.stderr.on("data",function(e){return s.emit("stderr",e)})),s}function x(e,r,t){o(r.forkOpts,s,"forkOpts");var n=t.fork(e,r.forkArgs,r.forkOpts),i=n.send;return n.send=function(e){return i.call(n,e)},r.emitStdStreams&&(n.stdout.on("data",function(e){return n.emit("stdout",e)}),n.stderr.on("data",function(e){return n.emit("stderr",e)})),n.isChildProcess=!0,n}function T(e){e=e||{};var r=process.execArgv.join(" "),t=-1!==r.indexOf("--inspect"),n=-1!==r.indexOf("--debug-brk"),o=[];return t&&(o.push("--inspect="+e.debugPort),n&&o.push("--debug-brk")),process.execArgv.forEach(function(e){e.indexOf("--max-old-space-size")>-1&&o.push(e)}),Object.assign({},e,{forkArgs:e.forkArgs,forkOpts:Object.assign({},e.forkOpts,{execArgv:(e.forkOpts&&e.forkOpts.execArgv||[]).concat(o),stdio:e.emitStdStreams?"pipe":void 0})})}function j(e){for(var r=new Error(""),t=Object.keys(e),n=0;n<t.length;n++)r[t[n]]=e[t[n]];return r}function _(e,r){Object.values(e.processing).forEach(function(e){var t;return null==e||null===(t=e.options)||void 0===t?void 0:t.on(r)}),Object.values(e.tracking).forEach(function(e){var t;return null==e||null===(t=e.options)||void 0===t?void 0:t.on(r)})}function P(e,r){var t=this,n=r||{};function o(e){for(var r in t.terminated=!0,t.processing)void 0!==t.processing[r]&&t.processing[r].resolver.reject(e);t.processing=Object.create(null)}function i(){var e,r=c(t.requestQueue.splice(0));try{for(r.s();!(e=r.n()).done;){var n=e.value;t.worker.send(n.message,n.transfer)}}catch(o){r.e(o)}finally{r.f()}}this.script=e||y(),this.worker=v(this.script,n),this.debugPort=n.debugPort,this.forkOpts=n.forkOpts,this.forkArgs=n.forkArgs,this.workerOpts=n.workerOpts,this.workerThreadOpts=n.workerThreadOpts,this.workerTerminateTimeout=n.workerTerminateTimeout,e||(this.worker.ready=!0),this.requestQueue=[],this.worker.on("stdout",function(e){_(t,{stdout:e.toString()})}),this.worker.on("stderr",function(e){_(t,{stderr:e.toString()})}),this.worker.on("message",function(e){if(!t.terminated)if("string"==typeof e&&"ready"===e)t.worker.ready=!0,i();else{var r,n=e.id;if(void 0!==(r=t.processing[n])?e.isEvent?r.options&&"function"==typeof r.options.on&&r.options.on(e.payload):(delete t.processing[n],!0===t.terminating&&t.terminate(),e.error?r.resolver.reject(j(e.error)):r.resolver.resolve(e.result)):void 0!==(r=t.tracking[n])&&e.isEvent&&r.options&&"function"==typeof r.options.on&&r.options.on(e.payload),e.method===l){var o=t.tracking[e.id];void 0!==o&&(e.error?(clearTimeout(o.timeoutId),o.resolver.reject(j(e.error))):(t.tracking&&clearTimeout(o.timeoutId),o.resolver.reject(new A(o.error)))),delete t.tracking[n]}}});var s=this.worker;this.worker.on("error",o),this.worker.on("exit",function(e,r){var n="Workerpool Worker terminated Unexpectedly\n";n+="    exitCode: `"+e+"`\n",n+="    signalCode: `"+r+"`\n",n+="    workerpool.script: `"+t.script+"`\n",n+="    spawnArgs: `"+s.spawnargs+"`\n",n+="    spawnfile: `"+s.spawnfile+"`\n",n+="    stdout: `"+s.stdout+"`\n",n+="    stderr: `"+s.stderr+"`\n",o(new Error(n))}),this.processing=Object.create(null),this.tracking=Object.create(null),this.terminating=!1,this.terminated=!1,this.cleaning=!1,this.terminationHandler=null,this.lastId=0}function A(e){this.error=e,this.stack=(new Error).stack}return P.prototype.methods=function(){return this.exec("methods")},P.prototype.exec=function(r,t,n,o){n||(n=e.defer());var i=++this.lastId;this.processing[i]={id:i,resolver:n,options:o};var s={message:{id:i,method:r,params:t},transfer:o&&o.transfer};this.terminated?n.reject(new Error("Worker is terminated")):this.worker.ready?this.worker.send(s.message,s.transfer):this.requestQueue.push(s);var u=this;return n.promise.catch(function(r){if(r instanceof e.CancellationError||r instanceof e.TimeoutError)return u.tracking[i]={id:i,resolver:e.defer(),options:o,error:r},delete u.processing[i],u.tracking[i].resolver.promise=u.tracking[i].resolver.promise.catch(function(e){if(delete u.tracking[i],e instanceof A)throw e.error;var r=u.terminateAndNotify(!0).then(function(){throw e},function(e){throw e});return r}),u.worker.send({id:i,method:l}),u.tracking[i].timeoutId=setTimeout(function(){u.tracking[i].resolver.reject(r)},u.workerTerminateTimeout),u.tracking[i].resolver.promise;throw r})},P.prototype.busy=function(){return this.cleaning||Object.keys(this.processing).length>0},P.prototype.terminate=function(e,r){var t=this;if(e){for(var n in this.processing)void 0!==this.processing[n]&&this.processing[n].resolver.reject(new Error("Worker terminated"));this.processing=Object.create(null)}for(var o=0,i=Object.values(t.tracking);o<i.length;o++){var s=i[o];clearTimeout(s.timeoutId),s.resolver.reject(new Error("Worker Terminating"))}if(t.tracking=Object.create(null),"function"==typeof r&&(this.terminationHandler=r),this.busy())this.terminating=!0;else{var u=function(e){if(t.terminated=!0,t.cleaning=!1,null!=t.worker&&t.worker.removeAllListeners&&t.worker.removeAllListeners("message"),t.worker=null,t.terminating=!1,t.terminationHandler)t.terminationHandler(e,t);else if(e)throw e};if(this.worker){if("function"==typeof this.worker.kill){if(this.worker.killed)return void u(new Error("worker already killed!"));var a=setTimeout(function(){t.worker&&t.worker.kill()},this.workerTerminateTimeout);return this.worker.once("exit",function(){clearTimeout(a),t.worker&&(t.worker.killed=!0),u()}),this.worker.ready?this.worker.send(p):this.requestQueue.push({message:p}),void(this.cleaning=!0)}if("function"!=typeof this.worker.terminate)throw new Error("Failed to terminate worker");this.worker.terminate(),this.worker.killed=!0}u()}},P.prototype.terminateAndNotify=function(r,t){var n=e.defer();return t&&n.promise.timeout(t),this.terminate(r,function(e,r){e?n.reject(e):n.resolve(r)}),n.promise},E.exports=P,E.exports._tryRequireWorkerThreads=w,E.exports._setupProcessWorker=x,E.exports._setupBrowserWorker=b,E.exports._setupWorkerThreadWorker=O,E.exports.ensureWorkerThreads=h,E.exports}function P(){if(O)return b;O=1;var e=65535;function r(){this.ports=Object.create(null),this.length=0}return b=r,r.prototype.nextAvailableStartingAt=function(r){for(;!0===this.ports[r];)r++;if(r>=e)throw new Error("WorkerPool debug port limit reached: "+r+">= "+e);return this.ports[r]=!0,this.length++,r},r.prototype.releasePort=function(e){delete this.ports[e],this.length--},b}function A(){if(T)return x;T=1;var e=u().Promise,r=_(),t=i,n=new(P());function o(e,n){"string"==typeof e?this.script=e||null:(this.script=null,n=e),this.workers=[],this.tasks=[],n=n||{},this.forkArgs=Object.freeze(n.forkArgs||[]),this.forkOpts=Object.freeze(n.forkOpts||{}),this.workerOpts=Object.freeze(n.workerOpts||{}),this.workerThreadOpts=Object.freeze(n.workerThreadOpts||{}),this.debugPortStart=n.debugPortStart||43210,this.nodeWorker=n.nodeWorker,this.workerType=n.workerType||n.nodeWorker||"auto",this.maxQueueSize=n.maxQueueSize||1/0,this.workerTerminateTimeout=n.workerTerminateTimeout||1e3,this.onCreateWorker=n.onCreateWorker||function(){return null},this.onTerminateWorker=n.onTerminateWorker||function(){return null},this.emitStdStreams=n.emitStdStreams||!1,n&&"maxWorkers"in n?(s(n.maxWorkers),this.maxWorkers=n.maxWorkers):this.maxWorkers=Math.max((t.cpus||4)-1,1),n&&"minWorkers"in n&&("max"===n.minWorkers?this.minWorkers=this.maxWorkers:(a(n.minWorkers),this.minWorkers=n.minWorkers,this.maxWorkers=Math.max(this.minWorkers,this.maxWorkers)),this._ensureMinWorkers()),this._boundNext=this._next.bind(this),"thread"===this.workerType&&r.ensureWorkerThreads()}function s(e){if(!c(e)||!f(e)||e<1)throw new TypeError("Option maxWorkers must be an integer number >= 1")}function a(e){if(!c(e)||!f(e)||e<0)throw new TypeError("Option minWorkers must be an integer number >= 0")}function c(e){return"number"==typeof e}function f(e){return Math.round(e)==e}return o.prototype.exec=function(r,t,n){if(t&&!Array.isArray(t))throw new TypeError('Array expected as argument "params"');if("string"==typeof r){var o=e.defer();if(this.tasks.length>=this.maxQueueSize)throw new Error("Max queue size of "+this.maxQueueSize+" reached");var i=this.tasks,s={method:r,params:t,resolver:o,timeout:null,options:n};i.push(s);var u=o.promise.timeout;return o.promise.timeout=function(e){return-1!==i.indexOf(s)?(s.timeout=e,o.promise):u.call(o.promise,e)},this._next(),o.promise}if("function"==typeof r)return this.exec("run",[String(r),t],n);throw new TypeError('Function or string expected as argument "method"')},o.prototype.proxy=function(){if(arguments.length>0)throw new Error("No arguments expected");var e=this;return this.exec("methods").then(function(r){var t={};return r.forEach(function(r){t[r]=function(){return e.exec(r,Array.prototype.slice.call(arguments))}}),t})},o.prototype._next=function(){if(this.tasks.length>0){var e=this._getWorker();if(e){var r=this,t=this.tasks.shift();if(t.resolver.promise.pending){var n=e.exec(t.method,t.params,t.resolver,t.options).then(r._boundNext).catch(function(){if(e.terminated)return r._removeWorker(e)}).then(function(){r._next()});"number"==typeof t.timeout&&n.timeout(t.timeout)}else r._next()}}},o.prototype._getWorker=function(){for(var e=this.workers,r=0;r<e.length;r++){var t=e[r];if(!1===t.busy())return t}return e.length<this.maxWorkers?(t=this._createWorkerHandler(),e.push(t),t):null},o.prototype._removeWorker=function(r){var t=this;return n.releasePort(r.debugPort),this._removeWorkerFromList(r),this._ensureMinWorkers(),new e(function(e,n){r.terminate(!1,function(o){t.onTerminateWorker({forkArgs:r.forkArgs,forkOpts:r.forkOpts,workerThreadOpts:r.workerThreadOpts,script:r.script}),o?n(o):e(r)})})},o.prototype._removeWorkerFromList=function(e){var r=this.workers.indexOf(e);-1!==r&&this.workers.splice(r,1)},o.prototype.terminate=function(r,t){var o=this;this.tasks.forEach(function(e){e.resolver.reject(new Error("Pool terminated"))}),this.tasks.length=0;var i=function(e){n.releasePort(e.debugPort),this._removeWorkerFromList(e)},s=i.bind(this),u=[];return this.workers.slice().forEach(function(e){var n=e.terminateAndNotify(r,t).then(s).always(function(){o.onTerminateWorker({forkArgs:e.forkArgs,forkOpts:e.forkOpts,workerThreadOpts:e.workerThreadOpts,script:e.script})});u.push(n)}),e.all(u)},o.prototype.stats=function(){var e=this.workers.length,r=this.workers.filter(function(e){return e.busy()}).length;return{totalWorkers:e,busyWorkers:r,idleWorkers:e-r,pendingTasks:this.tasks.length,activeTasks:r}},o.prototype._ensureMinWorkers=function(){if(this.minWorkers)for(var e=this.workers.length;e<this.minWorkers;e++)this.workers.push(this._createWorkerHandler())},o.prototype._createWorkerHandler=function(){var e=this.onCreateWorker({forkArgs:this.forkArgs,forkOpts:this.forkOpts,workerOpts:this.workerOpts,workerThreadOpts:this.workerThreadOpts,script:this.script})||{};return new r(e.script||this.script,{forkArgs:e.forkArgs||this.forkArgs,forkOpts:e.forkOpts||this.forkOpts,workerOpts:e.workerOpts||this.workerOpts,workerThreadOpts:e.workerThreadOpts||this.workerThreadOpts,debugPort:n.nextAvailableStartingAt(this.debugPortStart),workerType:this.workerType,workerTerminateTimeout:this.workerTerminateTimeout,emitStdStreams:this.emitStdStreams})},x=o}var L,N,M,U={};function C(){if(N)return L;function e(e,r){this.message=e,this.transfer=r}return N=1,L=e}function H(){return M||(M=1,function(e){var r=C(),n=u().Promise,o="__workerpool-terminate__",i="__workerpool-cleanup__",s=1e3,a={exit:function(){}},c={addAbortListener:function(e){a.abortListeners.push(e)},emit:a.emit};if("undefined"!=typeof self&&"function"==typeof postMessage&&"function"==typeof addEventListener)a.on=function(e,r){addEventListener(e,function(e){r(e.data)})},a.send=function(e,r){r?postMessage(e,r):postMessage(e)};else{if("undefined"==typeof process)throw new Error("Script must be executed as a worker");var f;try{f=t}catch(k){if("object"!==m(k)||null===k||"MODULE_NOT_FOUND"!==k.code)throw k}if(f&&null!==f.parentPort){var p=f.parentPort;a.send=p.postMessage.bind(p),a.on=p.on.bind(p),a.exit=process.exit.bind(process)}else a.on=process.on.bind(process),a.send=function(e){process.send(e)},a.on("disconnect",function(){process.exit(1)}),a.exit=process.exit.bind(process)}function d(e){return e&&e.toJSON?JSON.parse(JSON.stringify(e)):JSON.parse(JSON.stringify(e,Object.getOwnPropertyNames(e)))}function l(e){return e&&"function"==typeof e.then&&"function"==typeof e.catch}a.methods={},a.methods.run=function(e,r){var t=new Function("return ("+e+").apply(this, arguments);");return t.worker=c,t.apply(t,r)},a.methods.methods=function(){return Object.keys(a.methods)},a.terminationHandler=void 0,a.abortListenerTimeout=s,a.abortListeners=[],a.terminateAndExit=function(e){var r=function(){a.exit(e)};if(!a.terminationHandler)return r();var t=a.terminationHandler(e);return l(t)?(t.then(r,r),t):(r(),new n(function(e,r){r(new Error("Worker terminating"))}))},a.cleanup=function(e){if(!a.abortListeners.length)return a.send({id:e,method:i,error:d(new Error("Worker terminating"))}),new n(function(e){e()});var r,t=function(){a.exit()},o=function(){a.abortListeners.length||(a.abortListeners=[])},s=a.abortListeners.map(function(e){return e()}),u=new n(function(e,t){r=setTimeout(function(){t(new Error("Timeout occured waiting for abort handler, killing worker"))},a.abortListenerTimeout)}),c=n.all(s).then(function(){clearTimeout(r),o()},function(){clearTimeout(r),t()});return new n(function(e,r){c.then(e,r),u.then(e,r)}).then(function(){a.send({id:e,method:i,error:null})},function(r){a.send({id:e,method:i,error:r?d(r):null})})};var h=null;a.on("message",function(e){if(e===o)return a.terminateAndExit(0);if(e.method===i)return a.cleanup(e.id);try{var t=a.methods[e.method];if(!t)throw new Error('Unknown method "'+e.method+'"');h=e.id;var n=t.apply(t,e.params);l(n)?n.then(function(t){t instanceof r?a.send({id:e.id,result:t.message,error:null},t.transfer):a.send({id:e.id,result:t,error:null}),h=null}).catch(function(r){a.send({id:e.id,result:null,error:d(r)}),h=null}):(n instanceof r?a.send({id:e.id,result:n.message,error:null},n.transfer):a.send({id:e.id,result:n,error:null}),h=null)}catch(s){a.send({id:e.id,result:null,error:d(s)})}}),a.register=function(e,r){if(e)for(var t in e)e.hasOwnProperty(t)&&(a.methods[t]=e[t],a.methods[t].worker=c);r&&(a.terminationHandler=r.onTerminate,a.abortListenerTimeout=r.abortListenerTimeout||s),a.send("ready")},a.emit=function(e){if(h){if(e instanceof r)return void a.send({id:h,isEvent:!0,payload:e.message},e.transfer);a.send({id:h,isEvent:!0,payload:e})}},e.add=a.register,e.emit=a.emit}(U)),U}var F=i.platform,z=i.isMainThread,D=i.cpus;function J(e,r){return new(A())(e,r)}var I=r.pool=J;function R(e,r){H().add(e,r)}var q=r.worker=R;function Q(e){H().emit(e)}var B=r.workerEmit=Q,V=u().Promise,$=r.Promise=V,G=r.Transfer=C(),K=r.platform=F,X=r.isMainThread=z,Y=r.cpus=D;e.Promise=$,e.Transfer=G,e.cpus=Y,e.default=r,e.isMainThread=X,e.platform=K,e.pool=I,e.worker=q,e.workerEmit=B,Object.defineProperty(e,"__esModule",{value:!0})}(n.exports);const o=e(n.exports);export{o as w};
