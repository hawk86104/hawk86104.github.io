import{importShared as e}from"./3d-tiles-renderer.qyEDeaaW1769484739493.js";import{Pane as t}from"./tweakpane.BbuIEN141769484739493.js";import{_sfc_main as o}from"./pagesShow.vue_vue_type_script_setup_true_lang.C91EoZ8t1769484739493.js";import{useTexture as a,useTres as n,useLoop as s}from"./index.CuW8EyFk1769484739493.js";const i=(e,t)=>{"updateRanges"in e?e.updateRanges[0]=t:e.updateRange=t},{Group:r,PlaneGeometry:l,InstancedBufferAttribute:d,DynamicDrawUsage:u,InstancedMesh:c,Quaternion:p,Vector3:m,MeshLambertMaterial:h,Color:f,Matrix4:g,REVISION:y}=await e("three"),w=new g,v=new m,x=new p,b=new m,A=new p,C=new m,M=e=>class extends e{constructor(){super();const e=parseInt(y.replace(/\D+/g,""))>=154?"opaque_fragment":"output_fragment";this.onBeforeCompile=t=>{t.vertexShader="attribute float cloudOpacity;\n               varying float vOpacity;\n              "+t.vertexShader.replace("#include <fog_vertex>","#include <fog_vertex>\n                 vOpacity = cloudOpacity;\n                "),t.fragmentShader="varying float vOpacity;\n              "+t.fragmentShader.replace(`#include <${e}>`,`#include <${e}>\n                 gl_FragColor = vec4(outgoingLight, diffuseColor.a * vOpacity);\n                `)}}};class S extends r{constructor({limit:e=200,range:t,material:o=h,texture:a,frustumCulled:n=!0}={}){super(),this.name="Clouds",this.ref=this;const s=new l(1,1),r=new Float32Array(Array.from({length:e},()=>1)),f=new Float32Array(Array.from({length:e},()=>[1,1,1]).flat()),g=new d(r,1);g.setUsage(u),s.setAttribute("cloudOpacity",g);const y=new(M(o));y.map=a,y.transparent=!0,y.depthWrite=!1,y.needsUpdate=!0,this.cloudMaterial=y,this.instance=new c(s,y,e);const S=this.instance;S.matrixAutoUpdate=!1,S.frustumCulled=n,S.instanceColor=new d(f,3),S.instanceColor.setUsage(u),this.add(S);const _=[],B=()=>{const e=_.length;let t=0;for(let o=0;o<this.ref.children.length;o++){const e=this.ref.children[o];e.cloudStateArray&&(t+=e.cloudStateArray.length)}if(e===t)return _;_.length=0;for(let o=0;o<this.ref.children.length;o++){const e=this.ref.children[o];e.cloudStateArray&&_.push(...e.cloudStateArray)}return O(),_},O=()=>{const o=Math.min(e,void 0!==t?t:e,_.length);S.count=o,i(S.instanceMatrix,{offset:0,count:16*o}),S.instanceColor&&i(S.instanceColor,{offset:0,count:3*o}),i(S.geometry.attributes.cloudOpacity,{offset:0,count:o})};let z,U=0,V=0;const k=new p,F=new m(0,0,1),j=new m;this.update=(e,t,o)=>{U=t,w.copy(S.matrixWorld).invert(),e.matrixWorld.decompose(b,A,C);const a=B();for(V=0;V<a.length;V++)z=a[V],z.ref.matrixWorld.decompose(v,x,C),v.add(j.copy(z.position).applyQuaternion(x).multiply(C)),x.copy(A).multiply(k.setFromAxisAngle(F,z.rotation+=o*z.rotationFactor)),C.multiplyScalar(z.volume+(1+Math.sin(U*z.density*z.speed))/2*z.growth),z.matrix.compose(v,x,C).premultiply(w),z.dist=v.distanceTo(b);for(a.sort((e,t)=>t.dist-e.dist),V=0;V<a.length;V++)z=a[V],r[V]=z.opacity*(z.dist<z.fade-1?z.dist/z.fade:1),S.setMatrixAt(V,z.matrix),S.setColorAt(V,z.color);S.geometry.attributes.cloudOpacity.needsUpdate=!0,S.instanceMatrix.needsUpdate=!0,S.instanceColor&&(S.instanceColor.needsUpdate=!0)}}}let _=0;class B extends r{constructor({opacity:e=1,speed:t=0,bounds:o=(new m).fromArray([5,1,1]),segments:a=20,color:n=new f("#ffffff"),fade:s=10,volume:i=6,smallestVolume:r=.25,distribute:l=null,growth:d=4,concentrate:u="inside",seed:c=Math.random()}={}){super(),this.name="cloud_"+_++,this.seed=c,this.segments=a,this.bounds=o,this.concentrate=u,this.volume=i,this.smallestVolume=r,this.distribute=l,this.growth=d,this.speed=t,this.fade=s,this.opacity=e,this.color=n,this.ref=this,this.cloudStateArray=[],this.updateCloud()}updateCloudStateArray(){if(this.cloudStateArray.length===this.segments)return;const{segments:e,uuid:t}=this;if(this.cloudStateArray.length>this.segments)this.cloudStateArray.splice(0,this.cloudStateArray.length-this.segments);else for(let o=this.cloudStateArray.length;o<e;o++)this.cloudStateArray.push({segments:e,bounds:new m(1,1,1),position:new m,uuid:t,index:o,ref:this,dist:0,matrix:new g,volume:0,length:0,speed:0,growth:0,opacity:1,fade:0,density:0,rotation:o*(Math.PI/e),rotationFactor:0,color:new f})}updateCloud(){const{volume:e,color:t,speed:o,growth:a,opacity:n,fade:s,bounds:i,seed:r,cloudStateArray:l,distribute:d,segments:u,concentrate:c,smallestVolume:p}=this;this.updateCloudStateArray();let m=0;function h(){const e=1e4*Math.sin(r+m);return m++,e-Math.floor(e)}l.forEach((r,l)=>{r.segments=u,r.volume=e,r.color=t,r.speed=o,r.growth=a,r.opacity=n,r.fade=s,r.bounds.copy(i),r.density=Math.max(.5,h()),r.rotationFactor=Math.max(.2,.5*h())*o;const m=null==d?void 0:d(r,l);var f;(m||u>1)&&r.position.copy(r.bounds).multiply(null!==(f=null==m?void 0:m.point)&&void 0!==f?f:{x:2*h()-1,y:2*h()-1,z:2*h()-1});const g=Math.abs(r.position.x),y=Math.abs(r.position.y),w=Math.abs(r.position.z),v=Math.max(g,y,w);r.length=1,g===v&&(r.length-=g/r.bounds.x),y===v&&(r.length-=y/r.bounds.y),w===v&&(r.length-=w/r.bounds.z),r.volume=(void 0!==(null==m?void 0:m.volume)?m.volume:Math.max(Math.max(0,p),"random"===c?h():"inside"===c?r.length:1-r.length))*e})}}const{defineComponent:O}=await e("vue"),{openBlock:z,createElementBlock:U,createCommentVNode:V}=await e("vue"),k=["object"],{watch:F,watchEffect:j,ref:I,toRaw:R}=await e("vue"),E=await e("three"),D=O({__name:"cloudsMesh",props:{color:{default:"#ffffff"},segments:{default:20},volume:{default:6},opacity:{default:1},seed:{default:0},fade:{default:10},growth:{default:4},speed:{default:0},bounds:{default:{x:5,y:1,z:1}}},setup(e){const t=e,{state:o}=a("./plugins/digitalCity/image/cloud.png"),i=I(null),r=new B({color:new E.Color(t.color)}),l=new B({color:new E.Color("pink")});l.position.set(20,0,10);const{camera:d}=n(),{onBeforeRender:u}=s();return u(({delta:e,elapsed:t})=>{i.value?.update(d.value,t,e)}),F(()=>o.value,e=>{i.value=new S({texture:e}),i.value.add(r),i.value.add(l)}),F(()=>t.color,e=>{r.color.set(e)}),j(()=>{t.segments&&(r.segments=t.segments),t.volume&&(r.volume=t.volume),t.opacity&&(r.opacity=t.opacity),t.seed&&(r.seed=t.seed),t.fade&&(r.fade=t.fade),t.growth&&(r.growth=t.growth),t.speed&&(r.speed=t.speed),t.bounds&&(r.bounds.x=t.bounds.x,r.bounds.y=t.bounds.y,r.bounds.z=t.bounds.z),r.updateCloud()}),(e,t)=>i.value?(z(),U("primitive",{key:0,object:R(i.value),renderOrder:3e3},null,8,k)):V("",!0)}}),{defineComponent:N}=await e("vue"),{createElementVNode:W,mergeProps:L,createVNode:P,withCtx:G,openBlock:Q,createBlock:T}=await e("vue"),{reactive:$}=await e("vue"),q=N({__name:"clouds2",setup(e){const a=$({color:"#ffffff",segments:20,volume:6,opacity:1,seed:0,fade:10,growth:4,speed:0,bounds:{x:5,y:1,z:1}}),n=new t({title:"云彩效果",expanded:!0});return n.addBinding(a,"color",{label:"颜色"}),n.addBinding(a,"seed",{label:"seed",min:0,max:100,step:.1}),n.addBinding(a,"segments",{label:"segments",min:1,max:80,step:.1}),n.addBinding(a,"volume",{label:"volume",min:0,max:100,step:.1}),n.addBinding(a,"opacity",{label:"opacity",min:0,max:1,step:.01}),n.addBinding(a,"fade",{label:"fade",min:0,max:4e3,step:10}),n.addBinding(a,"growth",{label:"growth",min:0,max:20,step:.1}),n.addBinding(a,"speed",{label:"speed",min:0,max:1,step:.01}),n.addBinding(a,"bounds",{x:{min:0,max:25},y:{min:0,max:25},z:{min:0,max:25}}),(e,t)=>(Q(),T(o,null,{ability:G(()=>[t[0]||(t[0]=W("TresDirectionalLight",{position:[200,100,0],intensity:1.5,color:"#ffffff"},null,-1)),P(D,L({position:[10,200,0],scale:20},a),null,16)]),_:1}))}});export{q as default};
