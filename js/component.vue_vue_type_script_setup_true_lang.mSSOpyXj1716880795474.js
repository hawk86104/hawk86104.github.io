import{bO as K,aF as ee,aw as ae,bP as re,bi as I,at as V,bQ as C,aI as $,ak as q,bR as te,l as U,v as O,bS as ne,w as A,bT as z,L as D,bU as oe,bV as Y,a1 as ie,aQ as se,aD as le,o as ue,c as ce,a0 as de,Z as _e,a9 as me,bW as W,bX as X,bY as pe,bZ as Q,aC as Z,b_ as he}from"./vendor.9G8CKric1716880795474.js";class ve extends K{constructor(){super(),this.virtualScene=null,this.virtualScene=new ee}add(...s){return this.virtualScene.add(...s),this}destructor(){this.virtualScene.traverse(s=>{s instanceof ae&&(s.geometry.dispose(),s.material.dispose(),s.material.map&&s.material.map.dispose(),this.virtualScene.remove(s))}),this.virtualScene=null}}class j extends re{constructor(s){super(s),this.type=I}parse(s){const h=function(e,t){switch(e){case 1:console.error("THREE.RGBELoader Read Error: "+(t||""));break;case 2:console.error("THREE.RGBELoader Write Error: "+(t||""));break;case 3:console.error("THREE.RGBELoader Bad File Format: "+(t||""));break;default:case 4:console.error("THREE.RGBELoader: Error: "+(t||""))}return-1},f="\n",l=function(e,t,c){t=t||1024;let u=e.pos,o=-1,a=0,d="",r=String.fromCharCode.apply(null,new Uint16Array(e.subarray(u,u+128)));for(;0>(o=r.indexOf(f))&&a<t&&u<e.byteLength;)d+=r,a+=r.length,u+=128,r+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(u,u+128)));return-1<o?(c!==!1&&(e.pos+=a+o+1),d+r.slice(0,o)):!1},b=function(e){const t=/^#\?(\S+)/,c=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,i=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,u=/^\s*FORMAT=(\S+)\s*$/,o=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,a={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let d,r;if(e.pos>=e.byteLength||!(d=l(e)))return h(1,"no header found");if(!(r=d.match(t)))return h(3,"bad initial token");for(a.valid|=1,a.programtype=r[1],a.string+=d+"\n";d=l(e),d!==!1;){if(a.string+=d+"\n",d.charAt(0)==="#"){a.comments+=d+"\n";continue}if((r=d.match(c))&&(a.gamma=parseFloat(r[1])),(r=d.match(i))&&(a.exposure=parseFloat(r[1])),(r=d.match(u))&&(a.valid|=2,a.format=r[1]),(r=d.match(o))&&(a.valid|=4,a.height=parseInt(r[1],10),a.width=parseInt(r[2],10)),a.valid&2&&a.valid&4)break}return a.valid&2?a.valid&4?a:h(3,"missing image size specifier"):h(3,"missing format specifier")},y=function(e,t,c){const i=t;if(i<8||i>32767||e[0]!==2||e[1]!==2||e[2]&128)return new Uint8Array(e);if(i!==(e[2]<<8|e[3]))return h(3,"wrong scanline width");const u=new Uint8Array(4*t*c);if(!u.length)return h(4,"unable to allocate buffer space");let o=0,a=0;const d=4*i,r=new Uint8Array(4),L=new Uint8Array(d);let H=c;for(;H>0&&a<e.byteLength;){if(a+4>e.byteLength)return h(1);if(r[0]=e[a++],r[1]=e[a++],r[2]=e[a++],r[3]=e[a++],r[0]!=2||r[1]!=2||(r[2]<<8|r[3])!=i)return h(3,"bad rgbe scanline format");let M=0,k;for(;M<d&&a<e.byteLength;){k=e[a++];const S=k>128;if(S&&(k-=128),k===0||M+k>d)return h(3,"bad scanline data");if(S){const B=e[a++];for(let P=0;P<k;P++)L[M++]=B}else L.set(e.subarray(a,a+k),M),M+=k,a+=k}const J=i;for(let S=0;S<J;S++){let B=0;u[o]=L[S+B],B+=i,u[o+1]=L[S+B],B+=i,u[o+2]=L[S+B],B+=i,u[o+3]=L[S+B],o+=4}H--}return u},v=function(e,t,c,i){const u=e[t+3],o=Math.pow(2,u-128)/255;c[i+0]=e[t+0]*o,c[i+1]=e[t+1]*o,c[i+2]=e[t+2]*o,c[i+3]=1},F=function(e,t,c,i){const u=e[t+3],o=Math.pow(2,u-128)/255;c[i+0]=C.toHalfFloat(Math.min(e[t+0]*o,65504)),c[i+1]=C.toHalfFloat(Math.min(e[t+1]*o,65504)),c[i+2]=C.toHalfFloat(Math.min(e[t+2]*o,65504)),c[i+3]=C.toHalfFloat(1)},m=new Uint8Array(s);m.pos=0;const g=b(m);if(g!==-1){const e=g.width,t=g.height,c=y(m.subarray(m.pos),e,t);if(c!==-1){let i,u,o;switch(this.type){case V:o=c.length/4;const a=new Float32Array(o*4);for(let r=0;r<o;r++)v(c,r*4,a,r*4);i=a,u=V;break;case I:o=c.length/4;const d=new Uint16Array(o*4);for(let r=0;r<o;r++)F(c,r*4,d,r*4);i=d,u=I;break;default:console.error("THREE.RGBELoader: unsupported type: ",this.type);break}return{width:e,height:t,data:i,header:g.string,gamma:g.gamma,exposure:g.exposure,type:u}}}return null}setDataType(s){return this.type=s,this}load(s,p,T,_){function G(E,h){switch(E.type){case V:case I:"colorSpace"in E?E.colorSpace="srgb-linear":E.encoding=3e3,E.minFilter=$,E.magFilter=$,E.generateMipmaps=!1,E.flipY=!0;break}p&&p(E,h)}return super.load(s,G,T,_)}}const N={sunset:"venice/venice_sunset_1k.hdr",studio:"studio/poly_haven_studio_1k.hdr",city:"city/canary_wharf_1k.hdr",umbrellas:"outdoor/outdoor_umbrellas_1k.hdr",night:"outdoor/satara_night_1k.hdr",forest:"outood/mossy_forest_1k.hdr",snow:"outdoor/snowy_forest_path_01_1k.hdr",dawn:"kiara/kiara_1_dawn_1k.hdr",hangar:"indoor/small_hangar_01_1k.hdr",urban:"indoor/abandoned_games_room_02_1k.hdr",modern:"city/modern_buildings_2_1k.hdr",shangai:"city/shanghai_bund_1k.hdr"},ge="https://raw.githubusercontent.com/Tresjs/assets/main/textures/hdr/";async function fe(x,s){const{scene:p}=q(),{preset:T,blur:_,files:G=[],path:E="",background:h}=te(x),R=U(),w=O(()=>Array.isArray(G.value)),n=O(()=>w.value?ne:j),f=U(null);return A(()=>[G,E],async([l,b])=>{if(l.value.length>0&&!T.value){try{f.value=await z(D(n),w.value?[D(l)]:D(l),y=>{b.value&&y.setPath(D(b))})}catch(y){throw new Error("Failed to load environment map: ".concat(y))}f.value&&(R.value=w.value?f.value[0]:f.value,R.value.mapping=w.value?oe:Y)}},{immediate:!0}),A(()=>R.value,l=>{p.value&&(p.value.environment=l)},{immediate:!0}),A(()=>[h.value,R.value],([l,b])=>{if(p.value){let y=s!=null&&s.value?s.value.texture:b,v=p.value.background;v!=null&&v.isColor||(v=void 0),p.value.background=l?y:v}},{immediate:!0}),A(()=>_==null?void 0:_.value,l=>{p.value&&(p.value.backgroundBlurriness=l)},{immediate:!0}),A(T,async l=>{if(l&&l in N){const b=ge,y=N[l];try{f.value=await z(j,y,v=>{b&&v.setPath(b)})}catch(v){throw new Error("Failed to load environment map: ".concat(v))}f.value&&(R.value=f.value,R.value.mapping=Y)}else if(l&&!(l in N))throw new Error("Preset must be one of: ".concat(Object.keys(N).join(", ")))},{immediate:!0}),{texture:R}}const Re=ie({__name:"component",props:{background:{type:[Boolean,String],default:!1},blur:{default:0},files:{default:[]},path:{default:""},preset:{default:void 0},resolution:{default:256},near:{default:1},far:{default:1e3},frames:{default:1/0},useDefaultScene:{type:Boolean,default:!1}},async setup(x,{expose:s}){let p,T;const _=x,G=U(null);s({texture:G});const{extend:E,renderer:h,scene:R}=q();let w=null,n=U(null),f=null;const l=U(null);se(()=>{var m,g;(m=l.value)==null||m.destructor(),(g=n.value)==null||g.dispose()});const{onBeforeLoop:b}=me();let y=1;b(()=>{f&&l.value&&n.value&&(_.frames===1/0||y<_.frames)&&(_.useDefaultScene?f.update(h.value,R.value):f.update(h.value,he(l.value.virtualScene)),y++)});const v=([p,T]=le(()=>fe(_,n)),p=await p,T(),p).texture,F=m=>{m?(R.value.environment=m.texture,_.background&&(R.value.background=m.texture)):(R.value.environment=v.value,_.background&&(R.value.background=v.value))};return A(v,m=>{n.value&&F(n.value)},{immediate:!0,deep:!0}),E({EnvSence:ve}),A(()=>pe().default,m=>{var g,e,t;if(m&&(!n.value||n.value.texture.type!==I)&&(w=m(),Array.isArray(w)&&w.length>0&&typeof((g=w[0])==null?void 0:g.type)!="symbol")){(e=n.value)==null||e.dispose(),n.value=new W(_.resolution),n.value.texture.type=I,f=new X(_.near,_.far,n.value),F(n.value);return}(t=n.value)==null||t.dispose(),n.value=null,F(null)},{immediate:!0,deep:!0}),G.value=v,A(()=>_.useDefaultScene,m=>{var g;m&&(!n.value||n.value.texture.type!==Q)&&((g=n.value)==null||g.dispose(),n.value=new W(_.resolution),f=new X(_.near,_.far,n.value),n.value.texture.type=Q,n.value.texture.generateMipmaps=!1,n.value.texture.minFilter=Z,n.value.texture.magFilter=Z,F(n.value))},{immediate:!0}),(m,g)=>D(n)?(ue(),ce("TresEnvSence",{key:0,ref_key:"envSence",ref:l},[de(m.$slots,"default")],512)):_e("",!0)}});export{Re as _};
