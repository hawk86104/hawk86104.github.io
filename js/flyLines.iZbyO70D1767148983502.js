import{importShared as v}from"./3d-tiles-renderer.DZNovkLO1767148983502.js";import{Pane as L}from"./tweakpane.BQRZXf8M1767148983502.js";import{_sfc_main as U}from"./pagesShow.vue_vue_type_script_setup_true_lang.Crq63Xp41767148983502.js";import{rz as T,_l as D}from"./index.DTe2qqjO1767148983502.js";const s=await v("three");class l extends s.BufferGeometry{constructor(){super(),this.isMeshLine=!0,this.type="MeshLine",this.positions=[],this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[],this.counters=[],this._points=[],this._geom=null,this.widthCallback=null,this.matrixWorld=new s.Matrix4,Object.defineProperties(this,{geometry:{enumerable:!0,get:function(){return this}},geom:{enumerable:!0,get:function(){return this._geom},set:function(i){this.setGeometry(i,this.widthCallback)}},points:{enumerable:!0,get:function(){return this._points},set:function(i){this.setPoints(i,this.widthCallback)}}})}}l.prototype.setMatrixWorld=function(e){this.matrixWorld=e};l.prototype.setGeometry=function(e,i){this._geometry=e,this.setPoints(e.getAttribute("position").array,i)};l.prototype.setPoints=function(e,i){if(!(e instanceof Float32Array)&&!(e instanceof Array)){console.error("ERROR: The BufferArray of points is not instancied correctly.");return}if(this._points=e,this.widthCallback=i,this.positions=[],this.counters=[],e.length&&e[0]instanceof s.Vector3)for(var t=0;t<e.length;t++){var a=e[t],r=t/e.length;this.positions.push(a.x,a.y,a.z),this.positions.push(a.x,a.y,a.z),this.counters.push(r),this.counters.push(r)}else for(var t=0;t<e.length;t+=3){var r=t/e.length;this.positions.push(e[t],e[t+1],e[t+2]),this.positions.push(e[t],e[t+1],e[t+2]),this.counters.push(r),this.counters.push(r)}this.process()};function E(e,i){var t=new s.Matrix4,a=new s.Ray,r=new s.Sphere,n=new s.Vector3,p=this.geometry;if(p.boundingSphere||p.computeBoundingSphere(),r.copy(p.boundingSphere),r.applyMatrix4(this.matrixWorld),e.ray.intersectSphere(r,n)!==!1){t.copy(this.matrixWorld).invert(),a.copy(e.ray).applyMatrix4(t);var x=new s.Vector3,m=new s.Vector3,y=new s.Vector3,u=this instanceof s.LineSegments?2:1,_=p.index,h=p.attributes;if(_!==null)for(var f=_.array,c=h.position.array,M=h.width.array,d=0,P=f.length-1;d<P;d+=u){var W=f[d],k=f[d+1];x.fromArray(c,W*3),m.fromArray(c,k*3);var z=M[Math.floor(d/3)]!==void 0?M[Math.floor(d/3)]:1,C=e.params.Line.threshold+this.material.lineWidth*z/2,F=C*C,R=a.distanceSqToSegment(x,m,n,y);if(!(R>F)){n.applyMatrix4(this.matrixWorld);var w=e.ray.origin.distanceTo(n);w<e.near||w>e.far||(i.push({distance:w,point:y.clone().applyMatrix4(this.matrixWorld),index:d,face:null,faceIndex:null,object:this}),d=P)}}}}l.prototype.raycast=E;l.prototype.compareV3=function(e,i){var t=e*6,a=i*6;return this.positions[t]===this.positions[a]&&this.positions[t+1]===this.positions[a+1]&&this.positions[t+2]===this.positions[a+2]};l.prototype.copyV3=function(e){var i=e*6;return[this.positions[i],this.positions[i+1],this.positions[i+2]]};l.prototype.process=function(){var e=this.positions.length/6;this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[];var i,t;this.compareV3(0,e-1)?t=this.copyV3(e-2):t=this.copyV3(0),this.previous.push(t[0],t[1],t[2]),this.previous.push(t[0],t[1],t[2]);for(var a=0;a<e;a++){if(this.side.push(1),this.side.push(-1),this.widthCallback?i=this.widthCallback(a/(e-1)):i=1,this.width.push(i),this.width.push(i),this.uvs.push(a/(e-1),0),this.uvs.push(a/(e-1),1),a<e-1){t=this.copyV3(a),this.previous.push(t[0],t[1],t[2]),this.previous.push(t[0],t[1],t[2]);var r=a*2;this.indices_array.push(r,r+1,r+2),this.indices_array.push(r+2,r+1,r+3)}a>0&&(t=this.copyV3(a),this.next.push(t[0],t[1],t[2]),this.next.push(t[0],t[1],t[2]))}this.compareV3(e-1,0)?t=this.copyV3(1):t=this.copyV3(e-1),this.next.push(t[0],t[1],t[2]),this.next.push(t[0],t[1],t[2]),!this._attributes||this._attributes.position.count!==this.positions.length?this._attributes={position:new s.BufferAttribute(new Float32Array(this.positions),3),previous:new s.BufferAttribute(new Float32Array(this.previous),3),next:new s.BufferAttribute(new Float32Array(this.next),3),side:new s.BufferAttribute(new Float32Array(this.side),1),width:new s.BufferAttribute(new Float32Array(this.width),1),uv:new s.BufferAttribute(new Float32Array(this.uvs),2),index:new s.BufferAttribute(new Uint16Array(this.indices_array),1),counters:new s.BufferAttribute(new Float32Array(this.counters),1)}:(this._attributes.position.copyArray(new Float32Array(this.positions)),this._attributes.position.needsUpdate=!0,this._attributes.previous.copyArray(new Float32Array(this.previous)),this._attributes.previous.needsUpdate=!0,this._attributes.next.copyArray(new Float32Array(this.next)),this._attributes.next.needsUpdate=!0,this._attributes.side.copyArray(new Float32Array(this.side)),this._attributes.side.needsUpdate=!0,this._attributes.width.copyArray(new Float32Array(this.width)),this._attributes.width.needsUpdate=!0,this._attributes.uv.copyArray(new Float32Array(this.uvs)),this._attributes.uv.needsUpdate=!0,this._attributes.index.copyArray(new Uint16Array(this.indices_array)),this._attributes.index.needsUpdate=!0),this.setAttribute("position",this._attributes.position),this.setAttribute("previous",this._attributes.previous),this.setAttribute("next",this._attributes.next),this.setAttribute("side",this._attributes.side),this.setAttribute("width",this._attributes.width),this.setAttribute("uv",this._attributes.uv),this.setAttribute("counters",this._attributes.counters),this.setIndex(this._attributes.index),this.computeBoundingSphere(),this.computeBoundingBox(),this._geometry.attributes=this.attributes,this._geometry.index=this.index,this._geometry.computeBoundingSphere(),this._geometry.computeBoundingBox()};function A(e,i,t,a,r){var n;if(e=e.subarray||e.slice?e:e.buffer,t=t.subarray||t.slice?t:t.buffer,e=i?e.subarray?e.subarray(i,r&&i+r):e.slice(i,r&&i+r):e,t.set)t.set(e,a);else for(n=0;n<e.length;n++)t[n+a]=e[n];return t}l.prototype.advance=function(e){var i=this._attributes.position.array,t=this._attributes.previous.array,a=this._attributes.next.array,r=i.length;A(i,0,t,0,r),A(i,6,i,0,r-6),i[r-6]=e.x,i[r-5]=e.y,i[r-4]=e.z,i[r-3]=e.x,i[r-2]=e.y,i[r-1]=e.z,A(i,6,a,0,r-6),a[r-6]=e.x,a[r-5]=e.y,a[r-4]=e.z,a[r-3]=e.x,a[r-2]=e.y,a[r-1]=e.z,this._attributes.position.needsUpdate=!0,this._attributes.previous.needsUpdate=!0,this._attributes.next.needsUpdate=!0};s.ShaderChunk.meshline_vert=["",s.ShaderChunk.logdepthbuf_pars_vertex,s.ShaderChunk.fog_pars_vertex,"","attribute vec3 previous;","attribute vec3 next;","attribute float side;","attribute float width;","attribute float counters;","","uniform vec2 resolution;","uniform float lineWidth;","uniform vec3 color;","uniform float opacity;","uniform float near;","uniform float far;","uniform float sizeAttenuation;","uniform vec2 offset;","","varying vec2 vUV;","varying vec4 vColor;","varying float vCounters;","","vec2 fix( vec4 i, float aspect ) {","","    vec2 res = i.xy / i.w;","    res.x *= aspect;","	 vCounters = counters;","    return res;","","}","","void main() {","","    float aspect = resolution.x / resolution.y;","    float pixelWidthRatio = 1. / (resolution.x * projectionMatrix[0][0]);","","    vColor = vec4( color, opacity );","    vUV = uv + offset;","","    mat4 m = projectionMatrix * modelViewMatrix;","    vec4 finalPosition = m * vec4( position, 1.0 );","    vec4 prevPos = m * vec4( previous, 1.0 );","    vec4 nextPos = m * vec4( next, 1.0 );","","    vec2 currentP = fix( finalPosition, aspect );","    vec2 prevP = fix( prevPos, aspect );","    vec2 nextP = fix( nextPos, aspect );","","    float pixelWidth = finalPosition.w * pixelWidthRatio;","    float w = 1.8 * pixelWidth * lineWidth * width;","","    if( sizeAttenuation == 1. ) {","        w = 1.8 * lineWidth * width;","    }","","    vec2 dir;","    if( nextP == currentP ) dir = normalize( currentP - prevP );","    else if( prevP == currentP ) dir = normalize( nextP - currentP );","    else {","        vec2 dir1 = normalize( currentP - prevP );","        vec2 dir2 = normalize( nextP - currentP );","        dir = normalize( dir1 + dir2 );","","        vec2 perp = vec2( -dir1.y, dir1.x );","        vec2 miter = vec2( -dir.y, dir.x );","        //w = clamp( w / dot( miter, perp ), 0., 4. * lineWidth * width );","","    }","","    //vec2 normal = ( cross( vec3( dir, 0. ), vec3( 0., 0., 1. ) ) ).xy;","    vec2 normal = vec2( -dir.y, dir.x );","    normal.x /= aspect;","    normal *= .5 * w;","","    vec4 offset = vec4( normal * side, 0.0, 1.0 );","    finalPosition.xy += offset.xy;","","    gl_Position = finalPosition;","",s.ShaderChunk.logdepthbuf_vertex,s.ShaderChunk.fog_vertex&&"    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );",s.ShaderChunk.fog_vertex,"}"].join(`\r
`);s.ShaderChunk.meshline_frag=["",s.ShaderChunk.fog_pars_fragment,s.ShaderChunk.logdepthbuf_pars_fragment,"","uniform sampler2D map;","uniform sampler2D alphaMap;","uniform float useMap;","uniform float useAlphaMap;","uniform float useDash;","uniform float dashArray;","uniform float dashOffset;","uniform float dashRatio;","uniform float visibility;","uniform float alphaTest;","uniform vec2 repeat;","","varying vec2 vUV;","varying vec4 vColor;","varying float vCounters;","","void main() {","",s.ShaderChunk.logdepthbuf_fragment,"","    vec4 c = vColor;","    if( useMap == 1. ) c *= texture2D( map, vUV * repeat );","    if( useAlphaMap == 1. ) c.a *= texture2D( alphaMap, vUV * repeat ).a;","    if( c.a < alphaTest ) discard;","    if( useDash == 1. ){","        c.a *= ceil(mod(vCounters + dashOffset, dashArray) - (dashArray * dashRatio));","    }","    gl_FragColor = c;","    gl_FragColor.a *= step(vCounters, visibility);","",s.ShaderChunk.fog_fragment,"}"].join(`\r
`);class V extends s.ShaderMaterial{constructor(i){super({uniforms:Object.assign({},s.UniformsLib.fog,{lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},color:{value:new s.Color(16777215)},opacity:{value:1},resolution:{value:new s.Vector2(1,1)},sizeAttenuation:{value:1},dashArray:{value:0},dashOffset:{value:0},dashRatio:{value:.5},useDash:{value:0},visibility:{value:1},alphaTest:{value:0},repeat:{value:new s.Vector2(1,1)},offset:{value:new s.Vector2(1,1)}}),vertexShader:s.ShaderChunk.meshline_vert,fragmentShader:s.ShaderChunk.meshline_frag}),this.isMeshLineMaterial=!0,this.type="MeshLineMaterial",Object.defineProperties(this,{lineWidth:{enumerable:!0,get:function(){return this.uniforms.lineWidth.value},set:function(t){this.uniforms.lineWidth.value=t}},map:{enumerable:!0,get:function(){return this.uniforms.map.value},set:function(t){this.uniforms.map.value=t}},useMap:{enumerable:!0,get:function(){return this.uniforms.useMap.value},set:function(t){this.uniforms.useMap.value=t}},alphaMap:{enumerable:!0,get:function(){return this.uniforms.alphaMap.value},set:function(t){this.uniforms.alphaMap.value=t}},useAlphaMap:{enumerable:!0,get:function(){return this.uniforms.useAlphaMap.value},set:function(t){this.uniforms.useAlphaMap.value=t}},color:{enumerable:!0,get:function(){return this.uniforms.color.value},set:function(t){this.uniforms.color.value=t}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(t){this.uniforms.opacity.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}},sizeAttenuation:{enumerable:!0,get:function(){return this.uniforms.sizeAttenuation.value},set:function(t){this.uniforms.sizeAttenuation.value=t}},dashArray:{enumerable:!0,get:function(){return this.uniforms.dashArray.value},set:function(t){this.uniforms.dashArray.value=t,this.useDash=t!==0?1:0}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(t){this.uniforms.dashOffset.value=t}},dashRatio:{enumerable:!0,get:function(){return this.uniforms.dashRatio.value},set:function(t){this.uniforms.dashRatio.value=t}},useDash:{enumerable:!0,get:function(){return this.uniforms.useDash.value},set:function(t){this.uniforms.useDash.value=t}},visibility:{enumerable:!0,get:function(){return this.uniforms.visibility.value},set:function(t){this.uniforms.visibility.value=t}},alphaTest:{enumerable:!0,get:function(){return this.uniforms.alphaTest.value},set:function(t){this.uniforms.alphaTest.value=t}},repeat:{enumerable:!0,get:function(){return this.uniforms.repeat.value},set:function(t){this.uniforms.repeat.value.copy(t)}},offset:{enumerable:!0,get:function(){return this.uniforms.offset.value},set:function(t){this.uniforms.offset.value.copy(t)}}}),this.setValues(i)}}V.prototype.copy=function(e){return s.ShaderMaterial.prototype.copy.call(this,e),this.lineWidth=e.lineWidth,this.map=e.map,this.useMap=e.useMap,this.alphaMap=e.alphaMap,this.useAlphaMap=e.useAlphaMap,this.color.copy(e.color),this.opacity=e.opacity,this.resolution.copy(e.resolution),this.sizeAttenuation=e.sizeAttenuation,this.dashArray.copy(e.dashArray),this.dashOffset.copy(e.dashOffset),this.dashRatio.copy(e.dashRatio),this.useDash=e.useDash,this.visibility=e.visibility,this.alphaTest=e.alphaTest,this.repeat.copy(e.repeat),this};const{defineComponent:O}=await v("vue"),{unref:S,openBlock:G,createElementBlock:$}=await v("vue"),H=["geometry","material"],{watch:B}=await v("vue"),o=await v("three"),g=O({__name:"arrowFlyLine",props:{linePoints:{default:[[500,0,500],[0,0,0]]},speed:{default:.01},style:{default:1},color:{default:"#fff"},opacity:{default:1},height:{default:330},lineWidth:{default:40}},setup(e){const i=e,t=["./plugins/digitalCity/image/flyLine1.png","./plugins/digitalCity/image/flyLine2.png","./plugins/digitalCity/image/flyLine3.png","./plugins/digitalCity/image/flyLine4.png","./plugins/digitalCity/image/flyLine5.png"],{textures:a,isLoading:r}=T(t);B([a,r],([h,f])=>{h&&!f&&(h.forEach(c=>{c.anisotropy=16,c.wrapS=o.RepeatWrapping,c.wrapT=o.RepeatWrapping}),u.map=h[i.style])});const n=(i.linePoints[1][0]+i.linePoints[0][0])/2,p=(i.linePoints[1][2]+i.linePoints[0][2])/2,x=new o.CubicBezierCurve3(new o.Vector3().fromArray(i.linePoints[0]),new o.Vector3(n,i.height,p),new o.Vector3(n,i.height,p),new o.Vector3().fromArray(i.linePoints[1])),m=new o.BufferGeometry;m.setFromPoints(x.getPoints(100));const y=new l;y.setGeometry(m);const u=new V({color:i.color,map:null,useMap:!0,lineWidth:i.lineWidth,resolution:new o.Vector2(100,100),dashArray:0,dashRatio:.7,dashOffset:1,transparent:!0,sizeAttenuation:1,side:o.FrontSide,depthTest:!1,blending:o.AdditiveBlending,opacity:i.opacity});u.depthWrite=!1,u.depthTest=!0;const{onBeforeRender:_}=D();return _(()=>{u.uniforms.offset.value.x-=i.speed}),B(()=>[i.color,i.opacity,i.lineWidth],([h,f,c])=>{u.uniforms.color.value.setStyle(h),u.uniforms.opacity.value=f,u.uniforms.lineWidth.value=c}),(h,f)=>(G(),$("TresMesh",{geometry:S(y)._geometry,material:S(u),"render-order":99999},null,8,H))}}),{defineComponent:I}=await v("vue"),{mergeProps:N,createVNode:b,withCtx:q,openBlock:X,createBlock:Z}=await v("vue"),{reactive:J}=await v("vue"),tt=I({__name:"flyLines",setup(e){const i=J({color:"#FFF",speed:.01,opacity:1,lineWidth:40}),t=new L({title:"效果参数",expanded:!0});return t.addBinding(i,"color",{label:"线颜色"}),t.addBinding(i,"speed",{label:"速度",min:.001,max:.05,step:.001}),t.addBinding(i,"opacity",{label:"透明度",min:0,max:1,step:.01}),t.addBinding(i,"lineWidth",{label:"线宽度",min:10,max:200,step:1}),(a,r)=>(X(),Z(U,null,{ability:q(()=>[b(g,N(i,{linePoints:[[500,20,500],[0,20,0]]}),null,16),b(g,{style:0,linePoints:[[-500,20,-500],[0,20,0]]}),b(g,{style:2,linePoints:[[500,20,-500],[0,20,0]]}),b(g,{style:3,linePoints:[[-500,20,500],[0,20,0]],opacity:.8,lineWidth:10}),b(g,{style:4,linePoints:[[200,60,600],[0,20,0]]})]),_:1}))}});export{tt as default};
