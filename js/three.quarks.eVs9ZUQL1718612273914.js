import{V as e,aj as t,s as n,j as i,bG as r,aw as a,h as o,ae as s,Q as u,am as l,M as c,ad as d,r as h,i as f,bH as p,Y as m,Z as v,aM as y,K as g,N as S,bI as x,U as w,ak as b,C as M,b9 as _,k as N,B as k,a as O,b3 as T,c as E,_ as P,b as B,a$ as A,b0 as U,aB as V,bJ as C,bK as z,f as R,g as I,I as L,a1 as F,bL as J,bM as D,aX as G,bN as q,aY as j,aZ as X,bk as W,O as H,a7 as Y,o as Z,bO as Q,bP as K,bQ as $}from"./three.HHcT7YAr1718612273914.js";var ee=r;function te(){ee.tile_pars_vertex="\n#ifdef UV_TILE\n    attribute float uvTile;\n    uniform vec2 tileCount;\n    \n    mat3 makeTileTransform(float uvTile) {\n        float col = mod(uvTile, tileCount.x);\n        float row = (tileCount.y - floor(uvTile / tileCount.x) - 1.0);\n        \n        return mat3(\n          1.0 / tileCount.x, 0.0, 0.0,\n          0.0, 1.0 / tileCount.y, 0.0, \n          col / tileCount.x, row / tileCount.y, 1.0);\n    }\n#else\n    mat3 makeTileTransform(float uvTile) {\n        return mat3(1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0);\n    }\n#endif\n\n#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\n\tvarying vec2 vUv;\n#ifdef TILE_BLEND\n    varying vec2 vUvNext;\n    varying float vUvBlend;\n#endif\n\n#endif\n#ifdef USE_MAP\n\n\tuniform mat3 mapTransform;\n\tvarying vec2 vMapUv;\n#ifdef TILE_BLEND\n    varying vec2 vMapUvNext;\n#endif\n\n#endif\n#ifdef USE_ALPHAMAP\n\n\tuniform mat3 alphaMapTransform;\n\tvarying vec2 vAlphaMapUv;\n\n#endif\n#ifdef USE_LIGHTMAP\n\n\tuniform mat3 lightMapTransform;\n\tvarying vec2 vLightMapUv;\n\n#endif\n#ifdef USE_AOMAP\n\n\tuniform mat3 aoMapTransform;\n\tvarying vec2 vAoMapUv;\n\n#endif\n#ifdef USE_BUMPMAP\n\n\tuniform mat3 bumpMapTransform;\n\tvarying vec2 vBumpMapUv;\n\n#endif\n#ifdef USE_NORMALMAP\n\n\tuniform mat3 normalMapTransform;\n\tvarying vec2 vNormalMapUv;\n\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\n\tuniform mat3 displacementMapTransform;\n\tvarying vec2 vDisplacementMapUv;\n\n#endif\n#ifdef USE_EMISSIVEMAP\n\n\tuniform mat3 emissiveMapTransform;\n\tvarying vec2 vEmissiveMapUv;\n\n#endif\n#ifdef USE_METALNESSMAP\n\n\tuniform mat3 metalnessMapTransform;\n\tvarying vec2 vMetalnessMapUv;\n\n#endif\n#ifdef USE_ROUGHNESSMAP\n\n\tuniform mat3 roughnessMapTransform;\n\tvarying vec2 vRoughnessMapUv;\n\n#endif\n#ifdef USE_ANISOTROPYMAP\n\n\tuniform mat3 anisotropyMapTransform;\n\tvarying vec2 vAnisotropyMapUv;\n\n#endif\n#ifdef USE_CLEARCOATMAP\n\n\tuniform mat3 clearcoatMapTransform;\n\tvarying vec2 vClearcoatMapUv;\n\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\n\tuniform mat3 clearcoatNormalMapTransform;\n\tvarying vec2 vClearcoatNormalMapUv;\n\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\n\tuniform mat3 clearcoatRoughnessMapTransform;\n\tvarying vec2 vClearcoatRoughnessMapUv;\n\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\n\tuniform mat3 sheenColorMapTransform;\n\tvarying vec2 vSheenColorMapUv;\n\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\n\tuniform mat3 sheenRoughnessMapTransform;\n\tvarying vec2 vSheenRoughnessMapUv;\n\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\n\tuniform mat3 iridescenceMapTransform;\n\tvarying vec2 vIridescenceMapUv;\n\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\n\tuniform mat3 iridescenceThicknessMapTransform;\n\tvarying vec2 vIridescenceThicknessMapUv;\n\n#endif\n#ifdef USE_SPECULARMAP\n\n\tuniform mat3 specularMapTransform;\n\tvarying vec2 vSpecularMapUv;\n\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\n\tuniform mat3 specularColorMapTransform;\n\tvarying vec2 vSpecularColorMapUv;\n\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\n\tuniform mat3 specularIntensityMapTransform;\n\tvarying vec2 vSpecularIntensityMapUv;\n\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n\n#endif\n#ifdef USE_THICKNESSMAP\n\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n\n#endif\n",ee.tile_vertex="\n#ifdef UV_TILE\n    mat3 tileTransform = makeTileTransform(floor(uvTile));\n    #ifdef TILE_BLEND\n        mat3 nextTileTransform = makeTileTransform(ceil(uvTile));\n        vUvBlend = fract(uvTile);\n    #endif\n#else\n    mat3 tileTransform = makeTileTransform(0.0);\n#endif\n\n#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\nvUv = (tileTransform *vec3( uv, 1 )).xy;\n#if defined( TILE_BLEND ) && defined( UV_TILE )\n    vUvNext = (nextTileTransform *vec3( uv, 1 )).xy;\n#endif\n\n#endif\n#ifdef USE_MAP\n\nvMapUv = ( tileTransform * (mapTransform * vec3( MAP_UV, 1 ) )).xy;\n#if defined( TILE_BLEND ) && defined( UV_TILE )\n    vMapUvNext = (nextTileTransform * (mapTransform * vec3( MAP_UV, 1 ))).xy;\n#endif\n\n#endif\n#ifdef USE_ALPHAMAP\n\nvAlphaMapUv = ( tileTransform * (alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) )).xy;\n    \n#endif\n#ifdef USE_LIGHTMAP\n\nvLightMapUv = ( tileTransform * (lightMapTransform * vec3( LIGHTMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_AOMAP\n\nvAoMapUv = ( tileTransform * (aoMapTransform * vec3( AOMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_BUMPMAP\n\nvBumpMapUv = ( tileTransform * (bumpMapTransform * vec3( BUMPMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_NORMALMAP\n\nvNormalMapUv = ( tileTransform * (normalMapTransform * vec3( NORMALMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\nvDisplacementMapUv = ( tileTransform * (displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_EMISSIVEMAP\n\nvEmissiveMapUv = ( tileTransform * (emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_METALNESSMAP\n\nvMetalnessMapUv = ( tileTransform * (metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_ROUGHNESSMAP\n\nvRoughnessMapUv = ( tileTransform * (roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_ANISOTROPYMAP\n\nvAnisotropyMapUv = ( tileTransform * (anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOATMAP\n\nvClearcoatMapUv = ( tileTransform * (clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\nvClearcoatNormalMapUv = ( tileTransform * (clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\nvClearcoatRoughnessMapUv = ( tileTransform * (clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\nvIridescenceMapUv = ( tileTransform * (iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\nvIridescenceThicknessMapUv = ( tileTransform * (iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\nvSheenColorMapUv = ( tileTransform * (sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\nvSheenRoughnessMapUv = ( tileTransform * (sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULARMAP\n\nvSpecularMapUv = ( tileTransform * (specularMapTransform * vec3( SPECULARMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\nvSpecularColorMapUv = ( tileTransform * (specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\nvSpecularIntensityMapUv = ( tileTransform * (specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\nvTransmissionMapUv = ( tileTransform * transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_THICKNESSMAP\n\nvThicknessMapUv = ( tileTransform * thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) )).xy;\n\n#endif\n\n",ee.tile_pars_fragment="\n#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\n\tvarying vec2 vUv;\n#ifdef TILE_BLEND\n    varying vec2 vUvNext;\n    varying float vUvBlend;\n#endif\n\n#endif\n#ifdef USE_MAP\n\n\tuniform mat3 mapTransform;\n\tvarying vec2 vMapUv;\n#ifdef TILE_BLEND\n    varying vec2 vMapUvNext;\n#endif\n\n#endif\n#ifdef USE_ALPHAMAP\n\n\tuniform mat3 alphaMapTransform;\n\tvarying vec2 vAlphaMapUv;\n\n#endif\n#ifdef USE_LIGHTMAP\n\n\tuniform mat3 lightMapTransform;\n\tvarying vec2 vLightMapUv;\n\n#endif\n#ifdef USE_AOMAP\n\n\tuniform mat3 aoMapTransform;\n\tvarying vec2 vAoMapUv;\n\n#endif\n#ifdef USE_BUMPMAP\n\n\tuniform mat3 bumpMapTransform;\n\tvarying vec2 vBumpMapUv;\n\n#endif\n#ifdef USE_NORMALMAP\n\n\tuniform mat3 normalMapTransform;\n\tvarying vec2 vNormalMapUv;\n\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\n\tuniform mat3 displacementMapTransform;\n\tvarying vec2 vDisplacementMapUv;\n\n#endif\n#ifdef USE_EMISSIVEMAP\n\n\tuniform mat3 emissiveMapTransform;\n\tvarying vec2 vEmissiveMapUv;\n\n#endif\n#ifdef USE_METALNESSMAP\n\n\tuniform mat3 metalnessMapTransform;\n\tvarying vec2 vMetalnessMapUv;\n\n#endif\n#ifdef USE_ROUGHNESSMAP\n\n\tuniform mat3 roughnessMapTransform;\n\tvarying vec2 vRoughnessMapUv;\n\n#endif\n#ifdef USE_ANISOTROPYMAP\n\n\tuniform mat3 anisotropyMapTransform;\n\tvarying vec2 vAnisotropyMapUv;\n\n#endif\n#ifdef USE_CLEARCOATMAP\n\n\tuniform mat3 clearcoatMapTransform;\n\tvarying vec2 vClearcoatMapUv;\n\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\n\tuniform mat3 clearcoatNormalMapTransform;\n\tvarying vec2 vClearcoatNormalMapUv;\n\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\n\tuniform mat3 clearcoatRoughnessMapTransform;\n\tvarying vec2 vClearcoatRoughnessMapUv;\n\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\n\tuniform mat3 sheenColorMapTransform;\n\tvarying vec2 vSheenColorMapUv;\n\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\n\tuniform mat3 sheenRoughnessMapTransform;\n\tvarying vec2 vSheenRoughnessMapUv;\n\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\n\tuniform mat3 iridescenceMapTransform;\n\tvarying vec2 vIridescenceMapUv;\n\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\n\tuniform mat3 iridescenceThicknessMapTransform;\n\tvarying vec2 vIridescenceThicknessMapUv;\n\n#endif\n#ifdef USE_SPECULARMAP\n\n\tuniform mat3 specularMapTransform;\n\tvarying vec2 vSpecularMapUv;\n\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\n\tuniform mat3 specularColorMapTransform;\n\tvarying vec2 vSpecularColorMapUv;\n\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\n\tuniform mat3 specularIntensityMapTransform;\n\tvarying vec2 vSpecularIntensityMapUv;\n\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n\n#endif\n#ifdef USE_THICKNESSMAP\n\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n\n#endif\n",ee.tile_fragment="\n#ifdef USE_MAP\n    vec4 texelColor = texture2D( map, vUv);\n    #ifdef TILE_BLEND\n        texelColor = mix( texelColor, texture2D( map, vUvNext ), vUvBlend );\n    #endif\n    diffuseColor *= texelColor;\n#endif\n",ee.soft_pars_vertex="\n#ifdef SOFT_PARTICLES\n    varying vec4 projPosition;\n    varying float linearDepth;\n#endif\n",ee.soft_vertex="\n#ifdef SOFT_PARTICLES\n    projPosition = gl_Position;\n    linearDepth = -mvPosition.z;\n#endif\n",ee.soft_pars_fragment="\n#ifdef SOFT_PARTICLES\n\n    uniform sampler2D depthTexture;\n    uniform vec4 projParams;\n    uniform vec2 softParams;\n\n    varying vec4 projPosition;\n    varying float linearDepth;\n\n    #define SOFT_NEAR_FADE softParams.x\n    #define SOFT_INV_FADE_DISTANCE softParams.y\n\n    #define zNear projParams.x\n    #define zFar projParams.y\n\n    float linearize_depth(float d)\n    {\n        return (zFar * zNear) / (zFar - d * (zFar - zNear));\n    }\n\n#endif\n",ee.soft_fragment="\n#ifdef SOFT_PARTICLES\n\n    /* #ifdef LOGDEPTH\n    float distSample = linearize_depth_log(sampleDepth, near, far);\n    #else\n    float distSample = ortho ? linearize_depth_ortho(sampleDepth, near, far) : linearize_depth(sampleDepth, near, far);\n    #endif */\n\n    vec2 p2 = projPosition.xy / projPosition.w;\n    \n    p2 = 0.5 * p2 + 0.5;\n\n    float readDepth = texture2D(depthTexture, p2.xy).r;\n    float viewDepth = linearize_depth(readDepth);\n\n    float softParticlesFade = saturate(SOFT_INV_FADE_DISTANCE * ((viewDepth - SOFT_NEAR_FADE) - linearDepth));\n    \n    gl_FragColor *= softParticlesFade;\n\n    //gl_FragColor = vec4(softParticlesFade , 0, 0, 1);\n#endif\n"}function ne(){ne=function(){return t};var e,t={},n=Object.prototype,i=n.hasOwnProperty,r=Object.defineProperty||function(e,t,n){e[t]=n.value},a="function"==typeof Symbol?Symbol:{},o=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",u=a.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(A){l=function(e,t,n){return e[t]=n}}function c(e,t,n,i){var a=t&&t.prototype instanceof y?t:y,o=Object.create(a.prototype),s=new P(i||[]);return r(o,"_invoke",{value:k(e,n,s)}),o}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(i){return{type:"throw",arg:i}}}t.wrap=c;var h="suspendedStart",f="suspendedYield",p="executing",m="completed",v={};function y(){}function g(){}function S(){}var x={};l(x,o,(function(){return this}));var w=Object.getPrototypeOf,b=w&&w(w(B([])));b&&b!==n&&i.call(b,o)&&(x=b);var M=S.prototype=y.prototype=Object.create(x);function _(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function N(e,t){function n(r,a,o,s){var u=d(e[r],e,a);if("throw"!==u.type){var l=u.arg,c=l.value;return c&&"object"==typeof c&&i.call(c,"__await")?t.resolve(c.__await).then((function(e){n("next",e,o,s)}),(function(e){n("throw",e,o,s)})):t.resolve(c).then((function(e){l.value=e,o(l)}),(function(e){return n("throw",e,o,s)}))}s(u.arg)}var a;r(this,"_invoke",{value:function(e,i){function r(){return new t((function(t,r){n(e,i,t,r)}))}return a=a?a.then(r,r):r()}})}function k(t,n,i){var r=h;return function(a,o){if(r===p)throw new Error("Generator is already running");if(r===m){if("throw"===a)throw o;return{value:e,done:!0}}for(i.method=a,i.arg=o;;){var s=i.delegate;if(s){var u=O(s,i);if(u){if(u===v)continue;return u}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if(r===h)throw r=m,i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);r=p;var l=d(t,n,i);if("normal"===l.type){if(r=i.done?m:f,l.arg===v)continue;return{value:l.arg,done:i.done}}"throw"===l.type&&(r=m,i.method="throw",i.arg=l.arg)}}}function O(t,n){var i=n.method,r=t.iterator[i];if(r===e)return n.delegate=null,"throw"===i&&t.iterator.return&&(n.method="return",n.arg=e,O(t,n),"throw"===n.method)||"return"!==i&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+i+"' method")),v;var a=d(r,t.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,v;var o=a.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,v):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,v)}function T(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function E(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function P(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(T,this),this.reset(!0)}function B(t){if(t||""===t){var n=t[o];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,a=function n(){for(;++r<t.length;)if(i.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=e,n.done=!0,n};return a.next=a}}throw new TypeError(typeof t+" is not iterable")}return g.prototype=S,r(M,"constructor",{value:S,configurable:!0}),r(S,"constructor",{value:g,configurable:!0}),g.displayName=l(S,u,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===g||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,S):(e.__proto__=S,l(e,u,"GeneratorFunction")),e.prototype=Object.create(M),e},t.awrap=function(e){return{__await:e}},_(N.prototype),l(N.prototype,s,(function(){return this})),t.AsyncIterator=N,t.async=function(e,n,i,r,a){void 0===a&&(a=Promise);var o=new N(c(e,n,i,r),a);return t.isGeneratorFunction(n)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},_(M),l(M,u,"Generator"),l(M,o,(function(){return this})),l(M,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var i in t)n.push(i);return n.reverse(),function e(){for(;n.length;){var i=n.pop();if(i in t)return e.value=i,e.done=!1,e}return e.done=!0,e}},t.values=B,P.prototype={constructor:P,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(E),!t)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function r(i,r){return s.type="throw",s.arg=t,n.next=i,r&&(n.method="next",n.arg=e),!!r}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],s=o.completion;if("root"===o.tryLoc)return r("end");if(o.tryLoc<=this.prev){var u=i.call(o,"catchLoc"),l=i.call(o,"finallyLoc");if(u&&l){if(this.prev<o.catchLoc)return r(o.catchLoc,!0);if(this.prev<o.finallyLoc)return r(o.finallyLoc)}else if(u){if(this.prev<o.catchLoc)return r(o.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return r(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&i.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var a=r;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var o=a?a.completion:{};return o.type=e,o.arg=t,a?(this.method="next",this.next=a.finallyLoc,v):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),v},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),E(n),v}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var i=n.completion;if("throw"===i.type){var r=i.arg;E(n)}return r}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,i){return this.delegate={iterator:B(t),resultName:n,nextLoc:i},"next"===this.method&&(this.arg=e),v}},t}function ie(e){return(ie="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function re(e,t,n,i,r,a,o){try{var s=e[a](o),u=s.value}catch(l){return void n(l)}s.done?t(u):Promise.resolve(u).then(i,r)}function ae(e){return function(){var t=this,n=arguments;return new Promise((function(i,r){var a=e.apply(t,n);function o(e){re(a,i,r,o,s,"next",e)}function s(e){re(a,i,r,o,s,"throw",e)}o(void 0)}))}}function oe(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function se(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,xe(i.key),i)}}function ue(e,t,n){return t&&se(e.prototype,t),n&&se(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function le(e,t,n){return(t=xe(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ce(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&he(e,t)}function de(e){return(de=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function he(e,t){return(he=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function fe(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function pe(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,i=de(e);if(t){var r=de(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return function(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return fe(e)}(this,n)}}function me(){return me="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,n){var i=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=de(e)););return e}(e,t);if(i){var r=Object.getOwnPropertyDescriptor(i,t);return r.get?r.get.call(arguments.length<3?e:n):r.value}},me.apply(this,arguments)}function ve(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,a,o,s=[],u=!0,l=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;u=!1}else for(;!(u=(i=a.call(n)).done)&&(s.push(i.value),s.length!==t);u=!0);}catch(c){l=!0,r=c}finally{try{if(!u&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(l)throw r}}return s}}(e,t)||ye(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ye(e,t){if(e){if("string"==typeof e)return ge(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ge(e,t):void 0}}function ge(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function Se(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=ye(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,r=function(){};return{s:r,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function xe(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}var we=function(e){ce(n,a);var t=pe(n);function n(e){var i;return oe(this,n),le(fe(i=t.call(this)),"type","ParticleEmitter"),le(fe(i),"system",void 0),i.system=e,i}return ue(n,[{key:"clone",value:function(){var e=this.system.clone();return e.emitter.copy(this,!0),e.emitter}},{key:"dispose",value:function(){}},{key:"extractFromCache",value:function(e){var t=[];for(var n in e){var i=e[n];delete i.metadata,t.push(i)}return t}},{key:"toJSON",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=void 0===e||"string"==typeof e,i={};n&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},i.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});var r={};if(r.uuid=this.uuid,r.type=this.type,""!==this.name&&(r.name=this.name),!0===this.castShadow&&(r.castShadow=!0),!0===this.receiveShadow&&(r.receiveShadow=!0),!1===this.visible&&(r.visible=!1),!1===this.frustumCulled&&(r.frustumCulled=!1),0!==this.renderOrder&&(r.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(r.userData=this.userData),r.layers=this.layers.mask,r.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(r.matrixAutoUpdate=!1),null!==this.system&&(r.ps=this.system.toJSON(e,t)),this.children.length>0){r.children=[];for(var a=0;a<this.children.length;a++)"ParticleSystemPreview"!==this.children[a].type&&r.children.push(this.children[a].toJSON(e).object)}if(n){var o=this.extractFromCache(e.geometries),s=this.extractFromCache(e.materials),u=this.extractFromCache(e.textures),l=this.extractFromCache(e.images);o.length>0&&(i.geometries=o),s.length>0&&(i.materials=s),u.length>0&&(i.textures=u),l.length>0&&(i.images=l)}return i.object=r,i}}]),n}(),be=function(){function e(t){oe(this,e),le(this,"data",void 0),le(this,"next",void 0),le(this,"prev",void 0),this.data=t,this.next=null,this.prev=null}return ue(e,[{key:"hasPrev",value:function(){return null!==this.prev}},{key:"hasNext",value:function(){return null!==this.next}}]),e}(),Me=function(){function e(){oe(this,e),le(this,"length",void 0),le(this,"head",void 0),le(this,"tail",void 0),this.length=0,this.head=this.tail=null}return ue(e,[{key:"isEmpty",value:function(){return null===this.head}},{key:"clear",value:function(){this.length=0,this.head=this.tail=null}},{key:"front",value:function(){return null===this.head?null:this.head.data}},{key:"back",value:function(){return null===this.tail?null:this.tail.data}},{key:"dequeue",value:function(){if(this.head){var e=this.head.data;return this.head=this.head.next,this.head?this.head.prev=null:this.tail=null,this.length--,e}}},{key:"pop",value:function(){if(this.tail){var e=this.tail.data;return this.tail=this.tail.prev,this.tail?this.tail.next=null:this.head=null,this.length--,e}}},{key:"queue",value:function(e){var t=new be(e);this.tail||(this.tail=t),this.head&&(this.head.prev=t,t.next=this.head),this.head=t,this.length++}},{key:"push",value:function(e){var t=new be(e);this.head||(this.head=t),this.tail&&(this.tail.next=t,t.prev=this.tail),this.tail=t,this.length++}},{key:"insertBefore",value:function(e,t){var n=new be(t);n.next=e,n.prev=e.prev,null!==n.prev&&(n.prev.next=n),n.next.prev=n,e==this.head&&(this.head=n),this.length++}},{key:"remove",value:function(e){if(null!==this.head&&null!==this.tail){var t=this.head;for(e===this.head.data&&(this.head=this.head.next),e===this.tail.data&&(this.tail=this.tail.prev);null!==t.next&&t.data!==e;)t=t.next;t.data===e&&(null!==t.prev&&(t.prev.next=t.next),null!==t.next&&(t.next.prev=t.prev),this.length--)}}},{key:"values",value:ne().mark((function e(){var t;return ne().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=this.head;case 1:if(null===t){e.next=7;break}return e.next=4,t.data;case 4:t=t.next,e.next=1;break;case 7:case"end":return e.stop()}}),e,this)}))}]),e}(),_e=function(){function n(){oe(this,n),le(this,"position",new e),le(this,"velocity",new e),le(this,"age",0),le(this,"life",1),le(this,"size",1),le(this,"angularVelocity",void 0),le(this,"rotation",0),le(this,"color",new t(1,1,1,1)),le(this,"uvTile",0)}return ue(n,[{key:"died",get:function(){return this.age>=this.life}},{key:"reset",value:function(){this.position.set(0,0,0),this.velocity.set(0,0,0),this.age=0,this.life=1,this.size=1,this.rotation=0,this.color.set(1,1,1,1),this.uvTile=0}}]),n}(),Ne=function(){function n(){oe(this,n),le(this,"parentMatrix",void 0),le(this,"startSpeed",0),le(this,"startColor",new t),le(this,"startSize",1),le(this,"position",new e),le(this,"velocity",new e),le(this,"age",0),le(this,"life",1),le(this,"size",1),le(this,"speedModifier",1),le(this,"angularVelocity",void 0),le(this,"rotation",0),le(this,"color",new t),le(this,"uvTile",0)}return ue(n,[{key:"died",get:function(){return this.age>=this.life}}]),n}(),ke=ue((function e(t,n,i){oe(this,e),this.position=t,this.size=n,this.color=i})),Oe=function(){function n(){oe(this,n),le(this,"parentMatrix",void 0),le(this,"startSpeed",0),le(this,"startColor",new t),le(this,"startSize",1),le(this,"position",new e),le(this,"localPosition",void 0),le(this,"velocity",new e),le(this,"age",0),le(this,"life",1),le(this,"size",1),le(this,"length",100),le(this,"speedModifier",1),le(this,"color",new t),le(this,"previous",new Me),le(this,"uvTile",0)}return ue(n,[{key:"update",value:function(){for(this.age<=this.life?this.previous.push(new ke(this.position.clone(),this.size,this.color.clone())):this.previous.length>0&&this.previous.dequeue();this.previous.length>this.length;)this.previous.dequeue()}},{key:"died",get:function(){return this.age>=this.life}},{key:"reset",value:function(){this.previous.clear()}}]),n}(),Te=function(){function e(t,n,i,r){oe(this,e),le(this,"p",void 0),this.p=[t,n,i,r]}return ue(e,[{key:"genValue",value:function(e){var t=e*e,n=e*e*e,i=1-e,r=i*i,a=r*i;return this.p[0]*a+this.p[1]*r*e*3+this.p[2]*i*t*3+this.p[3]*n}},{key:"derivativeCoefficients",value:function(e){for(var t=[],n=e,i=n.length-1;i>0;i--){for(var r=[],a=0;a<i;a++){var o=i*(n[a+1]-n[a]);r.push(o)}t.push(r),n=r}return t}},{key:"getSlope",value:function(e){var t=this.derivativeCoefficients(this.p)[0],n=1-e,i=n*e*2,r=e*e;return n*n*t[0]+i*t[1]+r*t[2]}},{key:"controlCurve",value:function(e,t){this.p[1]=e/3+this.p[0],this.p[2]=this.p[3]-t/3}},{key:"hull",value:function(e){var t,n=this.p,i=[],r=0,a=0,o=0,s=[];for(s[r++]=n[0],s[r++]=n[1],s[r++]=n[2],s[r++]=n[3];n.length>1;){for(i=[],a=0,o=n.length-1;a<o;a++)t=e*n[a]+(1-e)*n[a+1],s[r++]=t,i.push(t);n=i}return s}},{key:"split",value:function(t){var n=this.hull(t);return{left:new e(n[0],n[4],n[7],n[9]),right:new e(n[9],n[8],n[6],n[3]),span:n}}},{key:"clone",value:function(){return new e(this.p[0],this.p[1],this.p[2],this.p[3])}},{key:"toJSON",value:function(){return{p0:this.p[0],p1:this.p[1],p2:this.p[2],p3:this.p[3]}}}],[{key:"fromJSON",value:function(t){return new e(t.p0,t.p1,t.p2,t.p3)}}]),e}(),Ee=function(e){return{r:e.x,g:e.y,b:e.z,a:e.w}},Pe=function(e){return new t(e.r,e.g,e.b,e.a)},Be=function(n,i){switch(i){case"Vector3":return new e(n.x,n.y,n.z);case"Vector4":return new t(n.x,n.y,n.z,n.w);case"Color":return new e(n.r,n.g,n.b);default:return n}},Ae=function(e,t){switch(t){case"Vector3":return{x:e.x,y:e.y,z:e.z};case"Vector4":return{x:e.x,y:e.y,z:e.z,w:e.w};case"Color":return{r:e.x,g:e.y,b:e.z};default:return e}},Ue=function(){function e(t,n){oe(this,e),le(this,"type",void 0),this.a=t,this.b=n,this.type="value"}return ue(e,[{key:"genColor",value:function(e){var t=Math.random();return e.copy(this.a).lerp(this.b,t)}},{key:"toJSON",value:function(){return{type:"RandomColor",a:Ee(this.a),b:Ee(this.b)}}},{key:"clone",value:function(){return new e(this.a.clone(),this.b.clone())}}],[{key:"fromJSON",value:function(t){return new e(Pe(t.a),Pe(t.b))}}]),e}(),Ve=function(){function e(t,n){oe(this,e),le(this,"type",void 0),this.a=t,this.b=n,this.type="value"}return ue(e,[{key:"genColor",value:function(e,t){return e.copy(this.a).lerp(this.b,Math.random())}},{key:"toJSON",value:function(){return{type:"ColorRange",a:Ee(this.a),b:Ee(this.b)}}},{key:"clone",value:function(){return new e(this.a.clone(),this.b.clone())}}],[{key:"fromJSON",value:function(t){return new e(Pe(t.a),Pe(t.b))}}]),e}(),Ce=function(){function e(t,n){oe(this,e),le(this,"keys",void 0),le(this,"type",void 0),le(this,"subType",void 0),this.subType=n,this.type="function",this.keys=t}return ue(e,[{key:"findKey",value:function(e){for(var t=0,n=0,i=this.keys.length-1;n+1<i;)if(t=Math.floor((n+i)/2),e<this.getStartX(t))i=t-1;else{if(!(e>this.getEndX(t)))return t;n=t+1}for(var r=n;r<=i;r++)if(e>=this.getStartX(r)&&e<=this.getEndX(r))return r;return-1}},{key:"getStartX",value:function(e){return this.keys[e][1]}},{key:"getEndX",value:function(e){return e+1<this.keys.length?this.keys[e+1][1]:1}},{key:"genValue",value:function(e,t){var n=this.findKey(t);return"Number"===this.subType?-1===n?this.keys[0][0]:n+1>=this.keys.length?this.keys[this.keys.length-1][0]:(this.keys[n+1][0]-this.keys[n][0])*((t-this.getStartX(n))/(this.getEndX(n)-this.getStartX(n)))+this.keys[n][0]:-1===n?e.copy(this.keys[0][0]):n+1>=this.keys.length?e.copy(this.keys[this.keys.length-1][0]):e.copy(this.keys[n][0]).lerp(this.keys[n+1][0],(t-this.getStartX(n))/(this.getEndX(n)-this.getStartX(n)))}},{key:"toJSON",value:function(){var e=this;return this.keys[0][0].constructor.name,{type:"CLinearFunction",subType:this.subType,keys:this.keys.map((function(t){var n=ve(t,2),i=n[0],r=n[1];return{value:Ae(i,e.subType),pos:r}}))}}},{key:"clone",value:function(){return"Number"===this.subType?new e(this.keys.map((function(e){var t=ve(e,2);return[t[0],t[1]]})),this.subType):new e(this.keys.map((function(e){var t=ve(e,2),n=t[0],i=t[1];return[n.clone(),i]})),this.subType)}}],[{key:"fromJSON",value:function(t){return new e(t.keys.map((function(e){return[Be(e.value,t.subType),e.pos]})),t.subType)}}]),e}(),ze=new e,Re=function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[[new e(0,0,0),0],[new e(1,1,1),0]],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[[1,0],[1,1]];oe(this,t),le(this,"type",void 0),le(this,"color",void 0),le(this,"alpha",void 0),this.type="function",this.color=new Ce(n,"Color"),this.alpha=new Ce(i,"Number")}return ue(t,[{key:"genColor",value:function(e,t){return this.color.genValue(ze,t),e.set(ze.x,ze.y,ze.z,this.alpha.genValue(1,t))}},{key:"toJSON",value:function(){return{type:"Gradient",color:this.color.toJSON(),alpha:this.alpha.toJSON()}}},{key:"clone",value:function(){var e=new t;return e.alpha=this.alpha.clone(),e.color=this.color.clone(),e}}],[{key:"fromJSON",value:function(n){if(n.functions){var i=n.functions.map((function(e){return[Ve.fromJSON(e.function).a,e.start]}));return n.functions.length>0&&i.push([Ve.fromJSON(n.functions[n.functions.length-1].function).b,1]),new t(i.map((function(t){return[new e(t[0].x,t[0].y,t[0].z),t[1]]})),i.map((function(e){return[e[0].w,e[1]]})))}var r=new t;return r.alpha=Ce.fromJSON(n.alpha),r.color=Ce.fromJSON(n.color),r}}]),t}(),Ie=new t,Le=function(){function e(t,n){oe(this,e),le(this,"gradient1",void 0),le(this,"gradient2",void 0),le(this,"type",void 0),this.type="memorizedFunction",this.gradient1=t,this.gradient2=n}return ue(e,[{key:"startGen",value:function(e){e.rand=Math.random()}},{key:"genColor",value:function(e,t,n){return this.gradient1.genColor(e,t),this.gradient2.genColor(Ie,t),n&&n.rand?e.lerp(Ie,n.rand):e.lerp(Ie,Math.random()),e}},{key:"toJSON",value:function(){return{type:"RandomColorBetweenGradient",gradient1:this.gradient1.toJSON(),gradient2:this.gradient2.toJSON()}}},{key:"clone",value:function(){return new e(this.gradient1.clone(),this.gradient2.clone())}}],[{key:"fromJSON",value:function(t){return new e(Re.fromJSON(t.gradient1),Re.fromJSON(t.gradient2))}}]),e}(),Fe=function(){function e(t){oe(this,e),le(this,"type",void 0),this.color=t,this.type="value"}return ue(e,[{key:"genColor",value:function(e){return e.copy(this.color)}},{key:"toJSON",value:function(){return{type:"ConstantColor",color:Ee(this.color)}}},{key:"clone",value:function(){return new e(this.color.clone())}}],[{key:"fromJSON",value:function(t){return new e(Pe(t.color))}}]),e}();function Je(e){switch(e.type){case"ConstantColor":return Fe.fromJSON(e);case"ColorRange":return Ve.fromJSON(e);case"RandomColor":return Ue.fromJSON(e);case"Gradient":return Re.fromJSON(e);case"RandomColorBetweenGradient":return Le.fromJSON(e);default:return new Fe(new t(1,1,1,1))}}var De=function(){function e(t){oe(this,e),le(this,"type",void 0),this.value=t,this.type="value"}return ue(e,[{key:"genValue",value:function(){return this.value}},{key:"toJSON",value:function(){return{type:"ConstantValue",value:this.value}}},{key:"clone",value:function(){return new e(this.value)}}],[{key:"fromJSON",value:function(t){return new e(t.value)}}]),e}(),Ge=function(){function e(t,n){oe(this,e),le(this,"type",void 0),this.a=t,this.b=n,this.type="value"}return ue(e,[{key:"genValue",value:function(){return o.lerp(this.a,this.b,Math.random())}},{key:"toJSON",value:function(){return{type:"IntervalValue",a:this.a,b:this.b}}},{key:"clone",value:function(){return new e(this.a,this.b)}}],[{key:"fromJSON",value:function(t){return new e(t.a,t.b)}}]),e}(),qe=function(){function e(){oe(this,e),le(this,"functions",void 0),this.functions=new Array}return ue(e,[{key:"findFunction",value:function(e){for(var t=0,n=0,i=this.functions.length-1;n+1<i;)if(t=Math.floor((n+i)/2),e<this.getStartX(t))i=t-1;else{if(!(e>this.getEndX(t)))return t;n=t+1}for(var r=n;r<=i;r++)if(e>=this.functions[r][1]&&e<=this.getEndX(r))return r;return-1}},{key:"getStartX",value:function(e){return this.functions[e][1]}},{key:"setStartX",value:function(e,t){e>0&&(this.functions[e][1]=t)}},{key:"getEndX",value:function(e){return e+1<this.functions.length?this.functions[e+1][1]:1}},{key:"setEndX",value:function(e,t){e+1<this.functions.length&&(this.functions[e+1][1]=t)}},{key:"insertFunction",value:function(e,t){var n=this.findFunction(e);this.functions.splice(n+1,0,[t,e])}},{key:"removeFunction",value:function(e){return this.functions.splice(e,1)[0][0]}},{key:"getFunction",value:function(e){return this.functions[e][0]}},{key:"setFunction",value:function(e,t){this.functions[e][0]=t}},{key:"numOfFunctions",get:function(){return this.functions.length}}]),e}(),je=function(e){ce(n,qe);var t=pe(n);function n(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[[new Te(0,1/3,1/3*2,1),0]];return oe(this,n),le(fe(e=t.call(this)),"type",void 0),e.type="function",e.functions=i,e}return ue(n,[{key:"genValue",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=this.findFunction(e);return-1===t?0:this.functions[t][0].genValue((e-this.getStartX(t))/(this.getEndX(t)-this.getStartX(t)))}},{key:"toSVG",value:function(e,t){if(t<1)return"";for(var n=["M",0,this.functions[0][0].p[0]].join(" "),i=1/t;i<=1;i+=1/t)n=[n,"L",i*e,this.genValue(i)].join(" ");return n}},{key:"toJSON",value:function(){return{type:"PiecewiseBezier",functions:this.functions.map((function(e){var t=ve(e,2),n=t[0],i=t[1];return{function:n.toJSON(),start:i}}))}}},{key:"clone",value:function(){return new n(this.functions.map((function(e){var t=ve(e,2),n=t[0],i=t[1];return[n.clone(),i]})))}}],[{key:"fromJSON",value:function(e){return new n(e.functions.map((function(e){return[Te.fromJSON(e.function),e.start]})))}}]),n}();function Xe(e){switch(e.type){case"ConstantValue":return De.fromJSON(e);case"IntervalValue":return Ge.fromJSON(e);case"PiecewiseBezier":return je.fromJSON(e);default:return new De(0)}}var We=function(){function e(){oe(this,e),le(this,"type",void 0),this.type="rotation"}return ue(e,[{key:"genValue",value:function(e,t){var n,i,r,a,o,s;do{r=(n=2*Math.random()-1)*n+(i=2*Math.random()-1)*i}while(r>1);do{s=(a=2*Math.random()-1)*a+(o=2*Math.random()-1)*o}while(s>1);var u=Math.sqrt((1-r)/s);return e.set(n,i,u*a,u*o),e}},{key:"toJSON",value:function(){return{type:"RandomQuat"}}},{key:"clone",value:function(){return new e}}],[{key:"fromJSON",value:function(t){return new e}}]),e}(),He=function(){function t(e,n){oe(this,t),le(this,"type",void 0),this.axis=e,this.angle=n,this.type="rotation"}return ue(t,[{key:"genValue",value:function(e,t){return e.setFromAxisAngle(this.axis,this.angle.genValue(t))}},{key:"toJSON",value:function(){return{type:"AxisAngle",axis:{x:this.axis.x,y:this.axis.y,z:this.axis.z},angle:this.angle.toJSON()}}},{key:"clone",value:function(){return new t(this.axis.clone(),this.angle.clone())}}],[{key:"fromJSON",value:function(n){return new t(new e(n.axis.x,n.axis.y,n.axis.z),Xe(n.angle))}}]),t}(),Ye=function(){function e(t,n,i,r){oe(this,e),le(this,"type",void 0),le(this,"eular",void 0),this.angleX=t,this.angleY=n,this.angleZ=i,this.type="rotation",this.eular=new s(0,0,0,r)}return ue(e,[{key:"genValue",value:function(e,t){return this.eular.set(this.angleX.genValue(t),this.angleY.genValue(t),this.angleZ.genValue(t)),e.setFromEuler(this.eular)}},{key:"toJSON",value:function(){return{type:"Euler",angleX:this.angleX.toJSON(),angleY:this.angleY.toJSON(),angleZ:this.angleZ.toJSON(),eulerOrder:this.eular.order}}},{key:"clone",value:function(){return new e(this.angleX,this.angleY,this.angleZ,this.eular.order)}}],[{key:"fromJSON",value:function(t){return new e(Xe(t.angleX),Xe(t.angleY),Xe(t.angleZ),t.eulerOrder)}}]),e}();function Ze(e){switch(e.type){case"AxisAngle":return He.fromJSON(e);case"Euler":return Ye.fromJSON(e);case"RandomQuat":return We.fromJSON(e);default:return new We}}function Qe(e){switch(e.type){case"ConstantValue":case"IntervalValue":case"PiecewiseBezier":return Xe(e);case"AxisAngle":case"RandomQuat":case"Euler":return Ze(e);default:return new De(0)}}var Ke=function(){function e(t){oe(this,e),le(this,"type","ColorOverLife"),this.color=t}return ue(e,[{key:"initialize",value:function(e){"memorizedFunction"===this.color.type&&(e.colorOverLifeMemory={},this.color.startGen(e.colorOverLifeMemory))}},{key:"update",value:function(e,t){"memorizedFunction"===this.color.type?this.color.genColor(e.color,e.age/e.life,e.colorOverLifeMemory):this.color.genColor(e.color,e.age/e.life),e.color.x*=e.startColor.x,e.color.y*=e.startColor.y,e.color.z*=e.startColor.z,e.color.w*=e.startColor.w}},{key:"frameUpdate",value:function(e){}},{key:"toJSON",value:function(){return{type:this.type,color:this.color.toJSON()}}},{key:"clone",value:function(){return new e(this.color.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(t){return new e(Je(t.color))}}]),e}(),$e=function(){function e(t){oe(this,e),le(this,"type","RotationOverLife"),le(this,"dynamic",void 0),this.angularVelocity=t,this.dynamic=!(t instanceof De||t instanceof Ge)}return ue(e,[{key:"initialize",value:function(e){this.dynamic=!(this.angularVelocity instanceof De||this.angularVelocity instanceof Ge),this.dynamic||"number"!=typeof e.rotation||(e.angularVelocity=this.angularVelocity.genValue())}},{key:"update",value:function(e,t){this.dynamic?"number"==typeof e.rotation&&(e.rotation+=t*this.angularVelocity.genValue(e.age/e.life)):"number"==typeof e.rotation&&(e.rotation+=t*e.angularVelocity)}},{key:"toJSON",value:function(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON()}}},{key:"frameUpdate",value:function(e){}},{key:"clone",value:function(){return new e(this.angularVelocity.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(t){return new e(Xe(t.angularVelocity))}}]),e}(),et=new u,tt=function(){function e(t){oe(this,e),le(this,"type","Rotation3DOverLife"),le(this,"tempQuat",new u),le(this,"dynamic",void 0),this.angularVelocity=t,this.dynamic=!(t instanceof We)}return ue(e,[{key:"initialize",value:function(e){this.dynamic=!(this.angularVelocity instanceof We),e.rotation instanceof u&&(e.angularVelocity=new u,this.angularVelocity.genValue(e.angularVelocity))}},{key:"update",value:function(e,t){e.rotation instanceof u&&(this.dynamic?(this.angularVelocity.genValue(this.tempQuat,e.age/e.life),this.tempQuat.slerpQuaternions(et,this.tempQuat,t),e.rotation.multiply(this.tempQuat)):(this.tempQuat.slerpQuaternions(et,e.angularVelocity,t),e.rotation.multiply(this.tempQuat)))}},{key:"toJSON",value:function(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON()}}},{key:"frameUpdate",value:function(e){}},{key:"clone",value:function(){return new e(this.angularVelocity.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(t){return new e(Ze(t.angularVelocity))}}]),e}(),nt=function(){function t(n,i,r){oe(this,t),le(this,"type","ForceOverLife"),le(this,"_temp",new e),le(this,"ps",void 0),le(this,"_tempScale",new e),le(this,"_tempQ",new u),this.x=n,this.y=i,this.z=r}return ue(t,[{key:"initialize",value:function(e,t){this.ps=t}},{key:"update",value:function(e,t){this._temp.set(this.x.genValue(e.age/e.life),this.y.genValue(e.age/e.life),this.z.genValue(e.age/e.life)),this.ps.worldSpace||this._temp.multiply(this._tempScale).applyQuaternion(this._tempQ),e.velocity.addScaledVector(this._temp,t)}},{key:"toJSON",value:function(){return{type:this.type,x:this.x.toJSON(),y:this.y.toJSON(),z:this.z.toJSON()}}},{key:"frameUpdate",value:function(e){if(this.ps&&!this.ps.worldSpace){var t=this._temp,n=this._tempQ,i=this._tempScale;this.ps.emitter.matrixWorld.decompose(t,n,i),n.invert(),i.set(1/i.x,1/i.y,1/i.z)}}},{key:"clone",value:function(){return new t(this.x.clone(),this.y.clone(),this.z.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(Xe(e.x),Xe(e.y),Xe(e.z))}}]),t}(),it=function(){function e(t){oe(this,e),le(this,"type","SizeOverLife"),this.size=t}return ue(e,[{key:"initialize",value:function(e){}},{key:"update",value:function(e){e.size=e.startSize*this.size.genValue(e.age/e.life)}},{key:"toJSON",value:function(){return{type:this.type,size:this.size.toJSON()}}},{key:"frameUpdate",value:function(e){}},{key:"clone",value:function(){return new e(this.size.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(t){return new e(Xe(t.size))}}]),e}(),rt=function(){function e(t){oe(this,e),le(this,"type","SpeedOverLife"),this.speed=t}return ue(e,[{key:"initialize",value:function(e){}},{key:"update",value:function(e){e.speedModifier=this.speed.genValue(e.age/e.life)}},{key:"toJSON",value:function(){return{type:this.type,speed:this.speed.toJSON()}}},{key:"frameUpdate",value:function(e){}},{key:"clone",value:function(){return new e(this.speed.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(t){return new e(Xe(t.speed))}}]),e}(),at=function(){function e(t){oe(this,e),le(this,"type","FrameOverLife"),this.frame=t}return ue(e,[{key:"initialize",value:function(e){this.frame instanceof je||(e.uvTile=this.frame.genValue(0))}},{key:"update",value:function(e,t){this.frame instanceof je&&(e.uvTile=this.frame.genValue(e.age/e.life))}},{key:"frameUpdate",value:function(e){}},{key:"toJSON",value:function(){return{type:this.type,frame:this.frame.toJSON()}}},{key:"clone",value:function(){return new e(this.frame.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(t){return new e(Xe(t.frame))}}]),e}();new e(0,0,1);var ot=function(){function t(n){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new e(0,1,0);oe(this,t),le(this,"type","OrbitOverLife"),le(this,"rotation",void 0),le(this,"line",void 0),le(this,"temp",new e),this.orbitSpeed=n,this.axis=i,this.rotation=new u,this.line=new l}return ue(t,[{key:"initialize",value:function(e){}},{key:"update",value:function(t,n){this.line.set(new e(0,0,0),this.axis),this.line.closestPointToPoint(t.position,!1,this.temp),this.rotation.setFromAxisAngle(this.axis,this.orbitSpeed.genValue(t.age/t.life)*n),t.position.sub(this.temp),t.position.applyQuaternion(this.rotation),t.position.add(this.temp)}},{key:"frameUpdate",value:function(e){}},{key:"toJSON",value:function(){return{type:this.type,orbitSpeed:this.orbitSpeed.toJSON(),axis:[this.axis.x,this.axis.y,this.axis.z]}}},{key:"clone",value:function(){return new t(this.orbitSpeed.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(n){return new t(Xe(n.orbitSpeed),n.axis?new e(n.axis[0],n.axis[1],n.axis[2]):void 0)}}]),t}(),st=function(){function e(t){oe(this,e),le(this,"type","WidthOverLength"),this.width=t}return ue(e,[{key:"initialize",value:function(e){}},{key:"update",value:function(e){if(e instanceof Oe)for(var t=e.previous.values(),n=0;n<e.previous.length;n++){t.next().value.size=this.width.genValue((e.previous.length-n)/e.length)}}},{key:"frameUpdate",value:function(e){}},{key:"toJSON",value:function(){return{type:this.type,width:this.width.toJSON()}}},{key:"clone",value:function(){return new e(this.width.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(t){return new e(Xe(t.width))}}]),e}(),ut=function(){function t(e,n){oe(this,t),le(this,"type","ApplyForce"),le(this,"magnitudeValue",void 0),this.direction=e,this.magnitude=n,this.magnitudeValue=this.magnitude.genValue()}return ue(t,[{key:"initialize",value:function(e){}},{key:"update",value:function(e,t){e.velocity.addScaledVector(this.direction,this.magnitudeValue*t)}},{key:"frameUpdate",value:function(e){this.magnitudeValue=this.magnitude.genValue()}},{key:"toJSON",value:function(){return{type:this.type,direction:[this.direction.x,this.direction.y,this.direction.z],magnitude:this.magnitude.toJSON()}}},{key:"clone",value:function(){return new t(this.direction.clone(),this.magnitude.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(n){var i;return new t(new e(n.direction[0],n.direction[1],n.direction[2]),Xe(null!==(i=n.magnitude)&&void 0!==i?i:n.force))}}]),t}(),lt=function(){function t(n,i){oe(this,t),le(this,"type","GravityForce"),le(this,"temp",new e),this.center=n,this.magnitude=i}return ue(t,[{key:"initialize",value:function(e){}},{key:"update",value:function(e,t){this.temp.copy(this.center).sub(e.position).normalize(),e.velocity.addScaledVector(this.temp,this.magnitude/e.position.distanceToSquared(this.center)*t)}},{key:"frameUpdate",value:function(e){}},{key:"toJSON",value:function(){return{type:this.type,center:[this.center.x,this.center.y,this.center.z],magnitude:this.magnitude}}},{key:"clone",value:function(){return new t(this.center.clone(),this.magnitude)}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(n){return new t(new e(n.center[0],n.center[1],n.center[2]),n.magnitude)}}]),t}();new e(0,0,1);var ct=function(){function t(n){oe(this,t),le(this,"type","ChangeEmitDirection"),le(this,"_temp",new e),le(this,"_q",new u),this.angle=n}return ue(t,[{key:"initialize",value:function(e){var t=e.velocity.length();0!=t&&(e.velocity.normalize(),0===e.velocity.x&&0===e.velocity.y?this._temp.set(0,e.velocity.z,0):this._temp.set(-e.velocity.y,e.velocity.x,0),this._q.setFromAxisAngle(this._temp.normalize(),this.angle.genValue()),this._temp.copy(e.velocity),e.velocity.applyQuaternion(this._q),this._q.setFromAxisAngle(this._temp,Math.random()*Math.PI*2),e.velocity.applyQuaternion(this._q),e.velocity.setLength(t))}},{key:"update",value:function(e,t){}},{key:"frameUpdate",value:function(e){}},{key:"toJSON",value:function(){return{type:this.type,angle:this.angle.toJSON()}}},{key:"clone",value:function(){return new t(this.angle)}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(Xe(e.angle))}}]),t}(),dt=new e(1,1,1),ht=new e(0,0,1),ft=function(e){return e[e.Death=0]="Death",e[e.Birth=1]="Birth",e[e.Frame=2]="Frame",e}({}),pt=function(){function t(n,i,r){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ft.Frame,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;oe(this,t),le(this,"type","EmitSubParticleSystem"),le(this,"q_",new u),le(this,"v_",new e),le(this,"v2_",new e),le(this,"subEmissions",new Array),this.particleSystem=n,this.useVelocityAsBasis=i,this.subParticleSystem=r,this.mode=a,this.emitProbability=o,this.subParticleSystem&&this.subParticleSystem.system&&(this.subParticleSystem.system.onlyUsedByOther=!0)}return ue(t,[{key:"initialize",value:function(e){}},{key:"update",value:function(e,t){(this.mode===ft.Frame||this.mode===ft.Birth&&0===e.age||this.mode===ft.Death&&e.age+t>=e.life)&&this.emit(e,t)}},{key:"emit",value:function(e,t){if(this.subParticleSystem&&!(Math.random()>this.emitProbability)){var n=new c;this.setMatrixFromParticle(n,e),this.subEmissions.push({burstParticleCount:0,burstParticleIndex:0,isBursting:!1,burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0,matrix:n,travelDistance:0,particle:e})}}},{key:"frameUpdate",value:function(e){if(this.subParticleSystem)for(var t=0;t<this.subEmissions.length;t++)if(this.subEmissions[t].time>=this.subParticleSystem.system.duration)this.subEmissions[t]=this.subEmissions[this.subEmissions.length-1],this.subEmissions.length=this.subEmissions.length-1,t--;else{var n=this.subEmissions[t];n.particle&&n.particle.age<n.particle.life?this.setMatrixFromParticle(n.matrix,n.particle):n.particle=void 0,this.subParticleSystem.system.emit(e,n,n.matrix)}}},{key:"toJSON",value:function(){return{type:this.type,subParticleSystem:this.subParticleSystem?this.subParticleSystem.uuid:"",useVelocityAsBasis:this.useVelocityAsBasis,mode:this.mode,emitProbability:this.emitProbability}}},{key:"clone",value:function(){return new t(this.particleSystem,this.useVelocityAsBasis,this.subParticleSystem,this.mode,this.emitProbability)}},{key:"reset",value:function(){}},{key:"setMatrixFromParticle",value:function(e,t){var n;if(void 0===t.rotation||this.useVelocityAsBasis)if(0!==t.velocity.x||0!==t.velocity.y||1!==t.velocity.z&&0!==t.velocity.z){this.v_.copy(ht).cross(t.velocity),this.v2_.copy(t.velocity).cross(this.v_);var i=this.v_.length(),r=this.v2_.length();e.set(this.v_.x/i,this.v2_.x/r,t.velocity.x,t.position.x,this.v_.y/i,this.v2_.y/r,t.velocity.y,t.position.y,this.v_.z/i,this.v2_.z/r,t.velocity.z,t.position.z,0,0,0,1)}else e.set(1,0,0,t.position.x,0,1,0,t.position.y,0,0,1,t.position.z,0,0,0,1);else t.rotation instanceof u?n=t.rotation:(this.q_.setFromAxisAngle(ht,t.rotation),n=this.q_),e.compose(t.position,n,dt);this.particleSystem.worldSpace||e.multiplyMatrices(this.particleSystem.emitter.matrixWorld,e)}}],[{key:"fromJSON",value:function(e,n){return new t(n,e.useVelocityAsBasis,e.subParticleSystem,e.mode,e.emitProbability)}}]),t}(),mt=.5*(Math.sqrt(3)-1),vt=(3-Math.sqrt(3))/6,yt=1/6,gt=(Math.sqrt(5)-1)/4,St=(5-Math.sqrt(5))/20,xt=new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),wt=new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),bt=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Math.random;oe(this,e),le(this,"p",void 0),le(this,"perm",void 0),le(this,"permMod12",void 0);var n="function"==typeof t?t:function(e){var t=0,n=0,i=0,r=1,a=(o=4022871197,function(e){e=e.toString();for(var t=0;t<e.length;t++){var n=.02519603282416938*(o+=e.charCodeAt(t));n-=o=n>>>0,o=(n*=o)>>>0,o+=4294967296*(n-=o)}return 2.3283064365386963e-10*(o>>>0)});var o;t=a(" "),n=a(" "),i=a(" "),(t-=a(e))<0&&(t+=1);(n-=a(e))<0&&(n+=1);(i-=a(e))<0&&(i+=1);return function(){var e=2091639*t+2.3283064365386963e-10*r;return t=n,n=i,i=e-(r=0|e)}}(t);this.p=function(e){for(var t=new Uint8Array(256),n=0;n<256;n++)t[n]=n;for(var i=0;i<255;i++){var r=i+~~(e()*(256-i)),a=t[i];t[i]=t[r],t[r]=a}return t}(n),this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);for(var i=0;i<512;i++)this.perm[i]=this.p[255&i],this.permMod12[i]=this.perm[i]%12}return ue(e,[{key:"noise2D",value:function(e,t){var n,i,r=this.permMod12,a=this.perm,o=0,s=0,u=0,l=(e+t)*mt,c=Math.floor(e+l),d=Math.floor(t+l),h=(c+d)*vt,f=e-(c-h),p=t-(d-h);f>p?(n=1,i=0):(n=0,i=1);var m=f-n+vt,v=p-i+vt,y=f-1+2*vt,g=p-1+2*vt,S=255&c,x=255&d,w=.5-f*f-p*p;if(w>=0){var b=3*r[S+a[x]];o=(w*=w)*w*(xt[b]*f+xt[b+1]*p)}var M=.5-m*m-v*v;if(M>=0){var _=3*r[S+n+a[x+i]];s=(M*=M)*M*(xt[_]*m+xt[_+1]*v)}var N=.5-y*y-g*g;if(N>=0){var k=3*r[S+1+a[x+1]];u=(N*=N)*N*(xt[k]*y+xt[k+1]*g)}return 70*(o+s+u)}},{key:"noise3D",value:function(e,t,n){var i,r,a,o,s,u,l,c,d,h,f=this.permMod12,p=this.perm,m=.3333333333333333*(e+t+n),v=Math.floor(e+m),y=Math.floor(t+m),g=Math.floor(n+m),S=(v+y+g)*yt,x=e-(v-S),w=t-(y-S),b=n-(g-S);x>=w?w>=b?(s=1,u=0,l=0,c=1,d=1,h=0):x>=b?(s=1,u=0,l=0,c=1,d=0,h=1):(s=0,u=0,l=1,c=1,d=0,h=1):w<b?(s=0,u=0,l=1,c=0,d=1,h=1):x<b?(s=0,u=1,l=0,c=0,d=1,h=1):(s=0,u=1,l=0,c=1,d=1,h=0);var M=x-s+yt,_=w-u+yt,N=b-l+yt,k=x-c+2*yt,O=w-d+2*yt,T=b-h+2*yt,E=x-1+.5,P=w-1+.5,B=b-1+.5,A=255&v,U=255&y,V=255&g,C=.6-x*x-w*w-b*b;if(C<0)i=0;else{var z=3*f[A+p[U+p[V]]];i=(C*=C)*C*(xt[z]*x+xt[z+1]*w+xt[z+2]*b)}var R=.6-M*M-_*_-N*N;if(R<0)r=0;else{var I=3*f[A+s+p[U+u+p[V+l]]];r=(R*=R)*R*(xt[I]*M+xt[I+1]*_+xt[I+2]*N)}var L=.6-k*k-O*O-T*T;if(L<0)a=0;else{var F=3*f[A+c+p[U+d+p[V+h]]];a=(L*=L)*L*(xt[F]*k+xt[F+1]*O+xt[F+2]*T)}var J=.6-E*E-P*P-B*B;if(J<0)o=0;else{var D=3*f[A+1+p[U+1+p[V+1]]];o=(J*=J)*J*(xt[D]*E+xt[D+1]*P+xt[D+2]*B)}return 32*(i+r+a+o)}},{key:"noise4D",value:function(e,t,n,i){var r,a,o,s,u,l=this.perm,c=(e+t+n+i)*gt,d=Math.floor(e+c),h=Math.floor(t+c),f=Math.floor(n+c),p=Math.floor(i+c),m=(d+h+f+p)*St,v=e-(d-m),y=t-(h-m),g=n-(f-m),S=i-(p-m),x=0,w=0,b=0,M=0;v>y?x++:w++,v>g?x++:b++,v>S?x++:M++,y>g?w++:b++,y>S?w++:M++,g>S?b++:M++;var _=x>=3?1:0,N=w>=3?1:0,k=b>=3?1:0,O=M>=3?1:0,T=x>=2?1:0,E=w>=2?1:0,P=b>=2?1:0,B=M>=2?1:0,A=x>=1?1:0,U=w>=1?1:0,V=b>=1?1:0,C=M>=1?1:0,z=v-_+St,R=y-N+St,I=g-k+St,L=S-O+St,F=v-T+2*St,J=y-E+2*St,D=g-P+2*St,G=S-B+2*St,q=v-A+3*St,j=y-U+3*St,X=g-V+3*St,W=S-C+3*St,H=v-1+4*St,Y=y-1+4*St,Z=g-1+4*St,Q=S-1+4*St,K=255&d,$=255&h,ee=255&f,te=255&p,ne=.6-v*v-y*y-g*g-S*S;if(ne<0)r=0;else{var ie=l[K+l[$+l[ee+l[te]]]]%32*4;r=(ne*=ne)*ne*(wt[ie]*v+wt[ie+1]*y+wt[ie+2]*g+wt[ie+3]*S)}var re=.6-z*z-R*R-I*I-L*L;if(re<0)a=0;else{var ae=l[K+_+l[$+N+l[ee+k+l[te+O]]]]%32*4;a=(re*=re)*re*(wt[ae]*z+wt[ae+1]*R+wt[ae+2]*I+wt[ae+3]*L)}var oe=.6-F*F-J*J-D*D-G*G;if(oe<0)o=0;else{var se=l[K+T+l[$+E+l[ee+P+l[te+B]]]]%32*4;o=(oe*=oe)*oe*(wt[se]*F+wt[se+1]*J+wt[se+2]*D+wt[se+3]*G)}var ue=.6-q*q-j*j-X*X-W*W;if(ue<0)s=0;else{var le=l[K+A+l[$+U+l[ee+V+l[te+C]]]]%32*4;s=(ue*=ue)*ue*(wt[le]*q+wt[le+1]*j+wt[le+2]*X+wt[le+3]*W)}var ce=.6-H*H-Y*Y-Z*Z-Q*Q;if(ce<0)u=0;else{var de=l[K+1+l[$+1+l[ee+1+l[te+1]]]]%32*4;u=(ce*=ce)*ce*(wt[de]*H+wt[de+1]*Y+wt[de+2]*Z+wt[de+3]*Q)}return 27*(r+a+o+s+u)}}]),e}();var Mt=function(){function t(n,i,r,a){oe(this,t),le(this,"type","TurbulenceField"),le(this,"generator",new bt),le(this,"timeOffset",new e),le(this,"temp",new e),le(this,"temp2",new e),this.scale=n,this.octaves=i,this.velocityMultiplier=r,this.timeScale=a,this.timeOffset.x=Math.random()/this.scale.x*this.timeScale.x,this.timeOffset.y=Math.random()/this.scale.y*this.timeScale.y,this.timeOffset.z=Math.random()/this.scale.z*this.timeScale.z}return ue(t,[{key:"initialize",value:function(e){}},{key:"update",value:function(e,t){var n=e.position.x/this.scale.x,i=e.position.y/this.scale.y,r=e.position.z/this.scale.z;this.temp.set(0,0,0);for(var a=1,o=0;o<this.octaves;o++)this.temp2.set(this.generator.noise4D(n*a,i*a,r*a,this.timeOffset.x*a)/a,this.generator.noise4D(n*a,i*a,r*a,this.timeOffset.y*a)/a,this.generator.noise4D(n*a,i*a,r*a,this.timeOffset.z*a)/a),this.temp.add(this.temp2),a*=2;this.temp.multiply(this.velocityMultiplier),e.velocity.addScaledVector(this.temp,t)}},{key:"toJSON",value:function(){return{type:this.type,scale:[this.scale.x,this.scale.y,this.scale.z],octaves:this.octaves,velocityMultiplier:[this.velocityMultiplier.x,this.velocityMultiplier.y,this.velocityMultiplier.z],timeScale:[this.timeScale.x,this.timeScale.y,this.timeScale.z]}}},{key:"frameUpdate",value:function(e){this.timeOffset.x+=e*this.timeScale.x,this.timeOffset.y+=e*this.timeScale.y,this.timeOffset.z+=e*this.timeScale.z}},{key:"clone",value:function(){return new t(this.scale.clone(),this.octaves,this.velocityMultiplier.clone(),this.timeScale.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(n){return new t(new e(n.scale[0],n.scale[1],n.scale[2]),n.octaves,new e(n.velocityMultiplier[0],n.velocityMultiplier[1],n.velocityMultiplier[2]),new e(n.timeScale[0],n.timeScale[1],n.timeScale[2]))}}]),t}();function _t(e,t){return Math.floor(Math.random()*(t-e))+e}var Nt=[],kt=new e,Ot=new u,Tt=function(){function t(e,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new De(1),r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new De(0);if(oe(this,t),le(this,"type","Noise"),le(this,"duration",0),this.frequency=e,this.power=n,this.positionAmount=i,this.rotationAmount=r,0===Nt.length)for(var a=0;a<100;a++)Nt.push(new bt)}return ue(t,[{key:"initialize",value:function(t){t.lastPosNoise=new e,"number"==typeof t.rotation?t.lastRotNoise=0:t.lastRotNoise=new u,t.generatorIndex=[_t(0,100),_t(0,100),_t(0,100),_t(0,100)]}},{key:"update",value:function(e,t){var n=this.frequency.genValue(e.age/e.life),i=this.power.genValue(e.age/e.life),r=this.positionAmount.genValue(e.age/e.life),a=this.rotationAmount.genValue(e.age/e.life);r>0&&void 0!==e.lastPosNoise&&(e.position.sub(e.lastPosNoise),kt.set(Nt[e.generatorIndex[0]].noise2D(0,e.age*n)*i*r,Nt[e.generatorIndex[1]].noise2D(0,e.age*n)*i*r,Nt[e.generatorIndex[2]].noise2D(0,e.age*n)*i*r),e.position.add(kt),e.lastPosNoise.copy(kt)),a>0&&void 0!==e.lastRotNoise&&("number"==typeof e.rotation?(e.rotation-=e.lastRotNoise,e.rotation+=Nt[e.generatorIndex[3]].noise2D(0,e.age*n)*Math.PI*i*a):(e.lastRotNoise.invert(),e.rotation.multiply(e.lastRotNoise),Ot.set(Nt[e.generatorIndex[0]].noise2D(0,e.age*n)*i*a,Nt[e.generatorIndex[1]].noise2D(0,e.age*n)*i*a,Nt[e.generatorIndex[2]].noise2D(0,e.age*n)*i*a,Nt[e.generatorIndex[3]].noise2D(0,e.age*n)*i*a).normalize(),e.rotation.multiply(Ot),e.lastRotNoise.copy(Ot)))}},{key:"toJSON",value:function(){return{type:this.type,frequency:this.frequency.toJSON(),power:this.power.toJSON(),positionAmount:this.positionAmount.toJSON(),rotationAmount:this.rotationAmount.toJSON()}}},{key:"frameUpdate",value:function(e){this.duration+=e}},{key:"clone",value:function(){return new t(this.frequency.clone(),this.power.clone(),this.positionAmount.clone(),this.rotationAmount.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(Xe(e.frequency),Xe(e.power),Xe(e.positionAmount),Xe(e.rotationAmount))}}]),t}(),Et=function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new e;oe(this,t),le(this,"locations",[]),this.scaleX=n,this.scaleY=i,this.position=r}return ue(t,[{key:"transform",value:function(e,t){e.x=this.locations[t%this.locations.length].x*this.scaleX+this.position.x,e.y=this.locations[t%this.locations.length].y*this.scaleY+this.position.y,e.z=this.position.z}},{key:"clone",value:function(){var e=new t(this.scaleX,this.scaleY,this.position.clone());return e.locations=this.locations.map((function(e){return e.clone()})),e}},{key:"toJSON",value:function(){return{scaleX:this.scaleX,scaleY:this.scaleY,position:this.position,locations:this.locations.map((function(e){return{x:e.x,y:e.y}}))}}},{key:"fromImage",value:function(e,t){var n=document.createElement("canvas");n.width=e.width,n.height=e.height;var r=n.getContext("2d");if(r){r.drawImage(e,0,0);var a=r.getImageData(0,0,n.width,n.height,{colorSpace:"srgb"});n.remove(),this.locations.length=0;for(var o=0;o<a.height;o++)for(var s=0;s<a.width;s++)a.data[4*(o*a.width+s)+3]>t&&this.locations.push(new i(s,a.height-o))}}}],[{key:"fromJSON",value:function(n){var r=new t(n.scaleX,n.scaleY,new e(n.position[0],n.position[1],n.position[2]));return r.locations=n.locations.map((function(e){return new i(e.x,e.y)})),r}}]),t}();function Pt(e){return"TextureSequencer"===e.type?Et.fromJSON(e):new Et}var Bt,At=function(){function t(n){oe(this,t),le(this,"type","ApplySequences"),le(this,"sequencers",[]),le(this,"time",0),le(this,"index",0),le(this,"pCount",0),le(this,"delay",void 0),le(this,"tempV",new e),this.delay=n}return ue(t,[{key:"initialize",value:function(t){t.id=this.pCount,t.dst=new e,t.begin=new e,t.inMotion=!1,this.pCount++}},{key:"reset",value:function(){this.time=0,this.index=0,this.pCount=0}},{key:"update",value:function(e,n){var i=this.sequencers[this.index],r=e.id*this.delay;this.time>=i[0].a+r&&this.time<=i[0].b+r?(e.inMotion||(e.inMotion=!0,e.begin.copy(e.position),i[1].transform(e.dst,e.id)),e.position.lerpVectors(e.begin,e.dst,t.BEZIER.genValue((this.time-i[0].a-r)/(i[0].b-i[0].a)))):this.time>i[0].b+r&&(e.inMotion=!1)}},{key:"frameUpdate",value:function(e){for(;this.index+1<this.sequencers.length&&this.time>=this.sequencers[this.index+1][0].a;)this.index++;this.time+=e}},{key:"appendSequencer",value:function(e,t){this.sequencers.push([e,t])}},{key:"toJSON",value:function(){return{type:this.type,delay:this.delay,sequencers:this.sequencers.map((function(e){var t=ve(e,2),n=t[0],i=t[1];return{range:n.toJSON(),sequencer:i.toJSON()}}))}}},{key:"clone",value:function(){var e=new t(this.delay);return e.sequencers=this.sequencers.map((function(e){return[e[0].clone(),e[1].clone()]})),e}}],[{key:"fromJSON",value:function(e){var n=new t(e.delay);return e.sequencers.forEach((function(e){n.sequencers.push([Xe(e.range),Pt(e.sequencer)])})),n}}]),t}();function Ut(){return Bt}le(At,"BEZIER",new Te(0,0,1,1));var Vt=function(){function t(n,i){oe(this,t),le(this,"type","ApplyCollision"),le(this,"tempV",new e),this.resolver=n,this.bounce=i}return ue(t,[{key:"initialize",value:function(e){}},{key:"update",value:function(e,t){this.resolver.resolve(e.position,this.tempV)&&e.velocity.reflect(this.tempV).multiplyScalar(this.bounce)}},{key:"frameUpdate",value:function(e){}},{key:"toJSON",value:function(){return{type:this.type,bounce:this.bounce}}},{key:"clone",value:function(){return new t(this.resolver,this.bounce)}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(Ut(),e.bounce)}}]),t}(),Ct=function(){function e(t,n){oe(this,e),le(this,"type","ColorBySpeed"),this.color=t,this.speedRange=n}return ue(e,[{key:"initialize",value:function(e){"memorizedFunction"===this.color.type&&(e.colorOverLifeMemory={},this.color.startGen(e.colorOverLifeMemory))}},{key:"update",value:function(e,t){var n=(e.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);"memorizedFunction"===this.color.type?this.color.genColor(e.color,n,e.colorOverLifeMemory):this.color.genColor(e.color,n),e.color.x*=e.startColor.x,e.color.y*=e.startColor.y,e.color.z*=e.startColor.z,e.color.w*=e.startColor.w}},{key:"frameUpdate",value:function(e){}},{key:"toJSON",value:function(){return{type:this.type,color:this.color.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"clone",value:function(){return new e(this.color.clone(),this.speedRange.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(t){return new e(Je(t.color),Ge.fromJSON(t.speedRange))}}]),e}(),zt=function(){function e(t,n){oe(this,e),le(this,"type","SizeBySpeed"),this.size=t,this.speedRange=n}return ue(e,[{key:"initialize",value:function(e){}},{key:"update",value:function(e){var t=(e.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);e.size=e.startSize*this.size.genValue(t)}},{key:"toJSON",value:function(){return{type:this.type,size:this.size.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"frameUpdate",value:function(e){}},{key:"clone",value:function(){return new e(this.size.clone(),this.speedRange.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(t){return new e(Xe(t.size),Ge.fromJSON(t.speedRange))}}]),e}(),Rt=function(){function e(t,n){oe(this,e),le(this,"type","RotationBySpeed"),le(this,"tempQuat",new u),this.angularVelocity=t,this.speedRange=n}return ue(e,[{key:"initialize",value:function(e){}},{key:"update",value:function(e,t){var n=(e.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);e.rotation+=t*this.angularVelocity.genValue(n)}},{key:"toJSON",value:function(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"frameUpdate",value:function(e){}},{key:"clone",value:function(){return new e(this.angularVelocity.clone(),this.speedRange.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(t){return new e(Xe(t.angularVelocity),Ge.fromJSON(t.speedRange))}}]),e}(),It=function(){function e(t,n){oe(this,e),le(this,"type","LimitSpeedOverLife"),this.speed=t,this.dampen=n}return ue(e,[{key:"initialize",value:function(e){}},{key:"update",value:function(e,t){var n=e.velocity.length(),i=this.speed.genValue(e.age/e.life);if(n>i){var r=(n-i)/n;e.velocity.multiplyScalar(1-r*this.dampen*t*20)}}},{key:"toJSON",value:function(){return{type:this.type,speed:this.speed.toJSON(),dampen:this.dampen}}},{key:"frameUpdate",value:function(e){}},{key:"clone",value:function(){return new e(this.speed.clone(),this.dampen)}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(t){return new e(Xe(t.speed),t.dampen)}}]),e}(),Lt={ApplyForce:{type:"ApplyForce",constructor:ut,params:[["direction","vec3"],["magnitude","value"]],loadJSON:ut.fromJSON},Noise:{type:"Noise",constructor:Tt,params:[["frequency","value"],["power","value"],["positionAmount","value"],["rotationAmount","value"]],loadJSON:Tt.fromJSON},TurbulenceField:{type:"TurbulenceField",constructor:Mt,params:[["scale","vec3"],["octaves","number"],["velocityMultiplier","vec3"],["timeScale","vec3"]],loadJSON:Mt.fromJSON},GravityForce:{type:"GravityForce",constructor:lt,params:[["center","vec3"],["magnitude","number"]],loadJSON:lt.fromJSON},ColorOverLife:{type:"ColorOverLife",constructor:Ke,params:[["color","colorFunc"]],loadJSON:Ke.fromJSON},RotationOverLife:{type:"RotationOverLife",constructor:$e,params:[["angularVelocity","valueFunc"]],loadJSON:$e.fromJSON},Rotation3DOverLife:{type:"Rotation3DOverLife",constructor:tt,params:[["angularVelocity","rotationFunc"]],loadJSON:tt.fromJSON},SizeOverLife:{type:"SizeOverLife",constructor:it,params:[["size","valueFunc"]],loadJSON:it.fromJSON},ColorBySpeed:{type:"ColorBySpeed",constructor:Ct,params:[["color","colorFunc"],["speedRange","range"]],loadJSON:Ct.fromJSON},RotationBySpeed:{type:"RotationBySpeed",constructor:Rt,params:[["angularVelocity","valueFunc"],["speedRange","range"]],loadJSON:Rt.fromJSON},SizeBySpeed:{type:"SizeBySpeed",constructor:zt,params:[["size","valueFunc"],["speedRange","range"]],loadJSON:zt.fromJSON},SpeedOverLife:{type:"SpeedOverLife",constructor:rt,params:[["speed","valueFunc"]],loadJSON:rt.fromJSON},FrameOverLife:{type:"FrameOverLife",constructor:at,params:[["frame","valueFunc"]],loadJSON:at.fromJSON},ForceOverLife:{type:"ForceOverLife",constructor:nt,params:[["x","valueFunc"],["y","valueFunc"],["z","valueFunc"]],loadJSON:nt.fromJSON},OrbitOverLife:{type:"OrbitOverLife",constructor:ot,params:[["orbitSpeed","valueFunc"],["axis","vec3"]],loadJSON:ot.fromJSON},WidthOverLength:{type:"WidthOverLength",constructor:st,params:[["width","valueFunc"]],loadJSON:st.fromJSON},ChangeEmitDirection:{type:"ChangeEmitDirection",constructor:ct,params:[["angle","value"]],loadJSON:ct.fromJSON},EmitSubParticleSystem:{type:"EmitSubParticleSystem",constructor:pt,params:[["particleSystem","self"],["useVelocityAsBasis","boolean"],["subParticleSystem","particleSystem"],["mode","number"],["emitProbability","number"]],loadJSON:pt.fromJSON},LimitSpeedOverLife:{type:"LimitSpeedOverLife",constructor:It,params:[["speed","valueFunc"],["dampen","number"]],loadJSON:It.fromJSON}};function Ft(e,t){return Lt[e.type].loadJSON(e,t)}var Jt=function(e){return e[e.Random=0]="Random",e[e.Loop=1]="Loop",e[e.PingPong=2]="PingPong",e[e.Burst=3]="Burst",e}({});function Dt(e,t,n,i){var r;switch(Jt.Random===e?t=Math.random():Jt.Burst===e&&i.isBursting&&(t=i.burstParticleIndex/i.burstParticleCount),r=n>0?Math.floor(t/n)*n:t,e){case Jt.Loop:r%=1;break;case Jt.PingPong:r=Math.abs(r%2-1)}return r}var Gt=function(){function e(){var t,n,i,r,a,o,s,u=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};oe(this,e),le(this,"type","cone"),le(this,"radius",void 0),le(this,"arc",void 0),le(this,"thickness",void 0),le(this,"angle",void 0),le(this,"mode",void 0),le(this,"spread",void 0),le(this,"speed",void 0),le(this,"currentValue",0),this.radius=null!==(t=u.radius)&&void 0!==t?t:10,this.arc=null!==(n=u.arc)&&void 0!==n?n:2*Math.PI,this.thickness=null!==(i=u.thickness)&&void 0!==i?i:1,this.angle=null!==(r=u.angle)&&void 0!==r?r:Math.PI/6,this.mode=null!==(a=u.mode)&&void 0!==a?a:Jt.Random,this.spread=null!==(o=u.spread)&&void 0!==o?o:0,this.speed=null!==(s=u.speed)&&void 0!==s?s:new De(1)}return ue(e,[{key:"update",value:function(e,t){Jt.Random!=this.mode&&(this.currentValue+=this.speed.genValue(e.emissionState.time/e.duration)*t)}},{key:"initialize",value:function(e,t){var n=Dt(this.mode,this.currentValue,this.spread,t),i=o.lerp(1-this.thickness,1,Math.random()),r=n*this.arc,a=Math.sqrt(i),s=Math.sin(r),u=Math.cos(r);e.position.x=a*u,e.position.y=a*s,e.position.z=0;var l=this.angle*a;e.velocity.set(0,0,Math.cos(l)).addScaledVector(e.position,Math.sin(l)).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius)}},{key:"toJSON",value:function(){return{type:"cone",radius:this.radius,arc:this.arc,thickness:this.thickness,angle:this.angle,mode:this.mode,spread:this.spread,speed:this.speed.toJSON()}}},{key:"clone",value:function(){return new e({radius:this.radius,arc:this.arc,thickness:this.thickness,angle:this.angle,mode:this.mode,speed:this.speed.clone(),spread:this.spread})}}],[{key:"fromJSON",value:function(t){return new e({radius:t.radius,arc:t.arc,thickness:t.thickness,angle:t.angle,mode:t.mode,speed:t.speed?Xe(t.speed):void 0,spread:t.spread})}}]),e}(),qt=function(){function e(){var t,n,i,r,a,o,s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};oe(this,e),le(this,"type","circle"),le(this,"radius",void 0),le(this,"arc",void 0),le(this,"thickness",void 0),le(this,"mode",void 0),le(this,"spread",void 0),le(this,"speed",void 0),le(this,"currentValue",0),this.radius=null!==(t=s.radius)&&void 0!==t?t:10,this.arc=null!==(n=s.arc)&&void 0!==n?n:2*Math.PI,this.thickness=null!==(i=s.thickness)&&void 0!==i?i:1,this.mode=null!==(r=s.mode)&&void 0!==r?r:Jt.Random,this.spread=null!==(a=s.spread)&&void 0!==a?a:0,this.speed=null!==(o=s.speed)&&void 0!==o?o:new De(1)}return ue(e,[{key:"update",value:function(e,t){this.currentValue+=this.speed.genValue(e.emissionState.time/e.duration)*t}},{key:"initialize",value:function(e,t){var n=Dt(this.mode,this.currentValue,this.spread,t),i=o.lerp(1-this.thickness,1,Math.random()),r=n*this.arc;e.position.x=Math.cos(r),e.position.y=Math.sin(r),e.position.z=0,e.velocity.copy(e.position).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius*i)}},{key:"toJSON",value:function(){return{type:"circle",radius:this.radius,arc:this.arc,thickness:this.thickness,mode:this.mode,spread:this.spread,speed:this.speed.toJSON()}}},{key:"clone",value:function(){return new e({radius:this.radius,arc:this.arc,thickness:this.thickness,mode:this.mode,speed:this.speed.clone(),spread:this.spread})}}],[{key:"fromJSON",value:function(t){return new e({radius:t.radius,arc:t.arc,thickness:t.thickness,mode:t.mode,speed:t.speed?Xe(t.speed):void 0,spread:t.spread})}}]),e}(),jt=function(){function e(){var t,n,i,r,a,o,s,u=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};oe(this,e),le(this,"type","donut"),le(this,"radius",void 0),le(this,"donutRadius",void 0),le(this,"arc",void 0),le(this,"thickness",void 0),le(this,"mode",void 0),le(this,"spread",void 0),le(this,"speed",void 0),le(this,"currentValue",0),this.radius=null!==(t=u.radius)&&void 0!==t?t:10,this.arc=null!==(n=u.arc)&&void 0!==n?n:2*Math.PI,this.thickness=null!==(i=u.thickness)&&void 0!==i?i:1,this.donutRadius=null!==(r=u.donutRadius)&&void 0!==r?r:.2*this.radius,this.mode=null!==(a=u.mode)&&void 0!==a?a:Jt.Random,this.spread=null!==(o=u.spread)&&void 0!==o?o:0,this.speed=null!==(s=u.speed)&&void 0!==s?s:new De(1)}return ue(e,[{key:"update",value:function(e,t){Jt.Random!=this.mode&&(this.currentValue+=this.speed.genValue(e.emissionState.time/e.duration)*t)}},{key:"initialize",value:function(e,t){var n=Dt(this.mode,this.currentValue,this.spread,t),i=Math.random(),r=o.lerp(1-this.thickness,1,Math.random()),a=n*this.arc,s=i*Math.PI*2,u=Math.sin(a),l=Math.cos(a);e.position.x=this.radius*l,e.position.y=this.radius*u,e.position.z=0,e.velocity.z=this.donutRadius*r*Math.sin(s),e.velocity.x=this.donutRadius*r*Math.cos(s)*l,e.velocity.y=this.donutRadius*r*Math.cos(s)*u,e.position.add(e.velocity),e.velocity.normalize().multiplyScalar(e.startSpeed)}},{key:"toJSON",value:function(){return{type:"donut",radius:this.radius,arc:this.arc,thickness:this.thickness,donutRadius:this.donutRadius,mode:this.mode,spread:this.spread,speed:this.speed.toJSON()}}},{key:"clone",value:function(){return new e({radius:this.radius,arc:this.arc,thickness:this.thickness,donutRadius:this.donutRadius,mode:this.mode,speed:this.speed.clone(),spread:this.spread})}}],[{key:"fromJSON",value:function(t){return new e({radius:t.radius,arc:t.arc,thickness:t.thickness,donutRadius:t.donutRadius,mode:t.mode,speed:t.speed?Xe(t.speed):void 0,spread:t.spread})}}]),e}(),Xt=function(){function e(){oe(this,e),le(this,"type","point")}return ue(e,[{key:"update",value:function(e,t){}},{key:"initialize",value:function(e){var t=Math.random(),n=Math.random(),i=t*Math.PI*2,r=Math.acos(2*n-1),a=Math.cbrt(Math.random()),o=Math.sin(i),s=Math.cos(i),u=Math.sin(r),l=Math.cos(r);e.velocity.x=a*u*s,e.velocity.y=a*u*o,e.velocity.z=a*l,e.velocity.multiplyScalar(e.startSpeed),e.position.setScalar(0)}},{key:"toJSON",value:function(){return{type:"point"}}},{key:"clone",value:function(){return new e}}],[{key:"fromJSON",value:function(t){return new e}}]),e}(),Wt=function(){function e(){var t,n,i,r,a,o,s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};oe(this,e),le(this,"type","sphere"),le(this,"radius",void 0),le(this,"arc",void 0),le(this,"thickness",void 0),le(this,"mode",void 0),le(this,"spread",void 0),le(this,"speed",void 0),le(this,"currentValue",0),this.radius=null!==(t=s.radius)&&void 0!==t?t:10,this.arc=null!==(n=s.arc)&&void 0!==n?n:2*Math.PI,this.thickness=null!==(i=s.thickness)&&void 0!==i?i:1,this.mode=null!==(r=s.mode)&&void 0!==r?r:Jt.Random,this.spread=null!==(a=s.spread)&&void 0!==a?a:0,this.speed=null!==(o=s.speed)&&void 0!==o?o:new De(1)}return ue(e,[{key:"update",value:function(e,t){Jt.Random!=this.mode&&(this.currentValue+=this.speed.genValue(e.emissionState.time/e.duration)*t)}},{key:"initialize",value:function(e,t){var n=Dt(this.mode,this.currentValue,this.spread,t),i=Math.random(),r=o.lerp(1-this.thickness,1,Math.random()),a=n*this.arc,s=Math.acos(2*i-1),u=Math.sin(a),l=Math.cos(a),c=Math.sin(s),d=Math.cos(s);e.position.x=c*l,e.position.y=c*u,e.position.z=d,e.velocity.copy(e.position).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius*r)}},{key:"toJSON",value:function(){return{type:"sphere",radius:this.radius,arc:this.arc,thickness:this.thickness,mode:this.mode,spread:this.spread,speed:this.speed.toJSON()}}},{key:"clone",value:function(){return new e({radius:this.radius,arc:this.arc,thickness:this.thickness,mode:this.mode,speed:this.speed.clone(),spread:this.spread})}}],[{key:"fromJSON",value:function(t){return new e({radius:t.radius,arc:t.arc,thickness:t.thickness,mode:t.mode,speed:t.speed?Xe(t.speed):void 0,spread:t.spread})}}]),e}(),Ht=function(){function e(){var t,n,i,r,a,o,s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};oe(this,e),le(this,"type","sphere"),le(this,"radius",void 0),le(this,"arc",void 0),le(this,"thickness",void 0),le(this,"mode",void 0),le(this,"spread",void 0),le(this,"speed",void 0),le(this,"currentValue",0),this.radius=null!==(t=s.radius)&&void 0!==t?t:10,this.arc=null!==(n=s.arc)&&void 0!==n?n:2*Math.PI,this.thickness=null!==(i=s.thickness)&&void 0!==i?i:1,this.mode=null!==(r=s.mode)&&void 0!==r?r:Jt.Random,this.spread=null!==(a=s.spread)&&void 0!==a?a:0,this.speed=null!==(o=s.speed)&&void 0!==o?o:new De(1)}return ue(e,[{key:"update",value:function(e,t){Jt.Random!=this.mode&&(this.currentValue+=this.speed.genValue(e.emissionState.time/e.duration)*t)}},{key:"initialize",value:function(e,t){var n=Dt(this.mode,this.currentValue,this.spread,t),i=Math.random(),r=o.lerp(1-this.thickness,1,Math.random()),a=n*this.arc,s=Math.acos(i),u=Math.sin(a),l=Math.cos(a),c=Math.sin(s),d=Math.cos(s);e.position.x=c*l,e.position.y=c*u,e.position.z=d,e.velocity.copy(e.position).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius*r)}},{key:"toJSON",value:function(){return{type:"hemisphere",radius:this.radius,arc:this.arc,thickness:this.thickness,mode:this.mode,spread:this.spread,speed:this.speed.toJSON()}}},{key:"clone",value:function(){return new e({radius:this.radius,arc:this.arc,thickness:this.thickness,mode:this.mode,speed:this.speed.clone(),spread:this.spread})}}],[{key:"fromJSON",value:function(t){return new e({radius:t.radius,arc:t.arc,thickness:t.thickness,mode:t.mode,speed:t.speed?Xe(t.speed):void 0,spread:t.spread})}}]),e}(),Yt=function(){function e(){var t,n,i,r,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};oe(this,e),le(this,"type","grid"),le(this,"width",void 0),le(this,"height",void 0),le(this,"column",void 0),le(this,"row",void 0),this.width=null!==(t=a.width)&&void 0!==t?t:1,this.height=null!==(n=a.height)&&void 0!==n?n:1,this.column=null!==(i=a.column)&&void 0!==i?i:10,this.row=null!==(r=a.row)&&void 0!==r?r:10}return ue(e,[{key:"initialize",value:function(e){var t=Math.floor(Math.random()*this.row),n=Math.floor(Math.random()*this.column);e.position.x=n*this.width/this.column-this.width/2,e.position.y=t*this.height/this.row-this.height/2,e.position.z=0,e.velocity.set(0,0,e.startSpeed)}},{key:"toJSON",value:function(){return{type:"grid",width:this.width,height:this.height,column:this.column,row:this.row}}},{key:"clone",value:function(){return new e({width:this.width,height:this.height,column:this.column,row:this.row})}},{key:"update",value:function(e,t){}}],[{key:"fromJSON",value:function(t){return new e(t)}}]),e}(),Zt=function(){function t(n){oe(this,t),le(this,"type","mesh_surface"),le(this,"_triangleIndexToArea",[]),le(this,"_geometry",void 0),le(this,"_tempA",new e),le(this,"_tempB",new e),le(this,"_tempC",new e),n&&(this.geometry=n)}return ue(t,[{key:"geometry",get:function(){return this._geometry},set:function(e){if(this._geometry=e,void 0!==e&&"string"!=typeof e){var t=new d;this._triangleIndexToArea.length=0;var n=0;if(e.getIndex()){var i=e.getIndex().array,r=i.length/3;this._triangleIndexToArea.push(0);for(var a=0;a<r;a++)t.setFromAttributeAndIndices(e.getAttribute("position"),i[3*a],i[3*a+1],i[3*a+2]),n+=t.getArea(),this._triangleIndexToArea.push(n);e.userData.triangleIndexToArea=this._triangleIndexToArea}}}},{key:"initialize",value:function(e){var t=this._geometry;if(!t||null===t.getIndex())return e.position.set(0,0,0),void e.velocity.set(0,0,1).multiplyScalar(e.startSpeed);for(var n=this._triangleIndexToArea.length-1,i=0,r=n,a=Math.random()*this._triangleIndexToArea[n];i+1<r;){var o=Math.floor((i+r)/2);a<this._triangleIndexToArea[o]?r=o:i=o}var s=Math.random(),u=Math.random();s+u>1&&(s=1-s,u=1-u);var l=t.getIndex().array[3*i],c=t.getIndex().array[3*i+1],d=t.getIndex().array[3*i+2],h=t.getAttribute("position");this._tempA.fromBufferAttribute(h,l),this._tempB.fromBufferAttribute(h,c),this._tempC.fromBufferAttribute(h,d),this._tempB.sub(this._tempA),this._tempC.sub(this._tempA),this._tempA.addScaledVector(this._tempB,s).addScaledVector(this._tempC,u),e.position.copy(this._tempA),this._tempA.copy(this._tempB).cross(this._tempC).normalize(),e.velocity.copy(this._tempA).normalize().multiplyScalar(e.startSpeed)}},{key:"toJSON",value:function(){return{type:"mesh_surface",mesh:this._geometry?this._geometry.uuid:""}}},{key:"clone",value:function(){return new t(this._geometry)}},{key:"update",value:function(e,t){}}],[{key:"fromJSON",value:function(e,n){return new t(n.geometries[e.geometry])}}]),t}(),Qt={circle:{type:"circle",params:[["radius","number"],["arc","radian"],["thickness","number"],["mode","emitterMode"],["spread","number"],["speed","valueFunc"]],constructor:qt,loadJSON:qt.fromJSON},cone:{type:"cone",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"],["mode","emitterMode"],["spread","number"],["speed","valueFunc"]],constructor:Gt,loadJSON:Gt.fromJSON},donut:{type:"donut",params:[["radius","number"],["arc","radian"],["thickness","number"],["donutRadius","number"],["mode","emitterMode"],["spread","number"],["speed","valueFunc"]],constructor:jt,loadJSON:jt.fromJSON},point:{type:"point",params:[],constructor:Xt,loadJSON:Xt.fromJSON},sphere:{type:"sphere",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"],["mode","emitterMode"],["spread","number"],["speed","valueFunc"]],constructor:Wt,loadJSON:Wt.fromJSON},hemisphere:{type:"hemisphere",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"],["mode","emitterMode"],["spread","number"],["speed","valueFunc"]],constructor:Ht,loadJSON:Ht.fromJSON},grid:{type:"grid",params:[["width","number"],["height","number"],["rows","number"],["column","number"]],constructor:Yt,loadJSON:Yt.fromJSON},mesh_surface:{type:"mesh_surface",params:[["geometry","geometry"]],constructor:Zt,loadJSON:Zt.fromJSON}};function Kt(e,t){return Qt[e.type].loadJSON(e,t)}var $t=function(e){return e[e.BillBoard=0]="BillBoard",e[e.StretchedBillBoard=1]="StretchedBillBoard",e[e.Mesh=2]="Mesh",e[e.Trail=3]="Trail",e[e.HorizontalBillBoard=4]="HorizontalBillBoard",e[e.VerticalBillBoard=5]="VerticalBillBoard",e}({}),en=function(e){ce(n,h);var t=pe(n);function n(e){var i;oe(this,n),le(fe(i=t.call(this)),"type","VFXBatch"),le(fe(i),"systems",void 0),le(fe(i),"settings",void 0),le(fe(i),"maxParticles",void 0),i.maxParticles=1e3,i.systems=new Set;var r=new p;r.mask=e.layers.mask;var a=e.material.clone();return a.defines={},Object.assign(a.defines,e.material.defines),i.settings={instancingGeometry:e.instancingGeometry,renderMode:e.renderMode,renderOrder:e.renderOrder,material:a,uTileCount:e.uTileCount,vTileCount:e.vTileCount,blendTiles:e.blendTiles,softParticles:e.softParticles,softNearFade:e.softNearFade,softFarFade:e.softFarFade,layers:r},i.frustumCulled=!1,i.renderOrder=i.settings.renderOrder,i}return ue(n,[{key:"addSystem",value:function(e){this.systems.add(e)}},{key:"removeSystem",value:function(e){this.systems.delete(e)}},{key:"applyDepthTexture",value:function(e){var t=this.material.uniforms.depthTexture;t&&t.value!==e&&(t.value=e,this.material.needsUpdate=!0)}}]),n}(),tn=new e(0,0,1),nn=new u,rn=new e,an=new e;new e;var on=new n(1,1,1,1),sn=function(){function i(n){var r,a,o,s,u,l,c,d,h,m,v,y,g,S,x,w,b,M,_,N,k,O,T,E;if(oe(this,i),le(this,"autoDestroy",void 0),le(this,"prewarm",void 0),le(this,"looping",void 0),le(this,"duration",void 0),le(this,"startLife",void 0),le(this,"startSpeed",void 0),le(this,"startRotation",void 0),le(this,"startSize",void 0),le(this,"startColor",void 0),le(this,"startTileIndex",void 0),le(this,"rendererEmitterSettings",void 0),le(this,"emissionOverTime",void 0),le(this,"emissionOverDistance",void 0),le(this,"emissionBursts",void 0),le(this,"onlyUsedByOther",void 0),le(this,"worldSpace",void 0),le(this,"particleNum",void 0),le(this,"paused",void 0),le(this,"particles",void 0),le(this,"emitterShape",void 0),le(this,"emitter",void 0),le(this,"rendererSettings",void 0),le(this,"neededToUpdateRender",void 0),le(this,"behaviors",void 0),le(this,"emissionState",void 0),le(this,"prewarmed",void 0),le(this,"emitEnded",void 0),le(this,"markForDestroy",void 0),le(this,"previousWorldPos",void 0),le(this,"temp",new e),le(this,"travelDistance",0),le(this,"normalMatrix",new f),le(this,"_renderer",void 0),le(this,"firstTimeUpdate",!0),this.autoDestroy=void 0!==n.autoDestroy&&n.autoDestroy,this.duration=null!==(r=n.duration)&&void 0!==r?r:1,this.looping=void 0===n.looping||n.looping,this.prewarm=void 0!==n.prewarm&&n.prewarm,this.startLife=null!==(a=n.startLife)&&void 0!==a?a:new De(5),this.startSpeed=null!==(o=n.startSpeed)&&void 0!==o?o:new De(0),this.startRotation=null!==(s=n.startRotation)&&void 0!==s?s:new De(0),this.startSize=null!==(u=n.startSize)&&void 0!==u?u:new De(1),this.startColor=null!==(l=n.startColor)&&void 0!==l?l:new Fe(new t(1,1,1,1)),this.emissionOverTime=null!==(c=n.emissionOverTime)&&void 0!==c?c:new De(10),this.emissionOverDistance=null!==(d=n.emissionOverDistance)&&void 0!==d?d:new De(0),this.emissionBursts=null!==(h=n.emissionBursts)&&void 0!==h?h:[],this.onlyUsedByOther=null!==(m=n.onlyUsedByOther)&&void 0!==m&&m,this.emitterShape=null!==(v=n.shape)&&void 0!==v?v:new Wt,this.behaviors=null!==(y=n.behaviors)&&void 0!==y?y:new Array,this.worldSpace=null!==(g=n.worldSpace)&&void 0!==g&&g,this.rendererEmitterSettings=null!==(S=n.rendererEmitterSettings)&&void 0!==S?S:{},n.renderMode===$t.StretchedBillBoard){var P,B,A=this.rendererEmitterSettings;void 0!==n.speedFactor&&(A.speedFactor=n.speedFactor),A.speedFactor=null!==(P=A.speedFactor)&&void 0!==P?P:0,A.lengthFactor=null!==(B=A.lengthFactor)&&void 0!==B?B:0}this.rendererSettings={instancingGeometry:null!==(x=n.instancingGeometry)&&void 0!==x?x:on,renderMode:null!==(w=n.renderMode)&&void 0!==w?w:$t.BillBoard,renderOrder:null!==(b=n.renderOrder)&&void 0!==b?b:0,material:n.material,uTileCount:null!==(M=n.uTileCount)&&void 0!==M?M:1,vTileCount:null!==(_=n.vTileCount)&&void 0!==_?_:1,blendTiles:null!==(N=n.blendTiles)&&void 0!==N&&N,softParticles:null!==(k=n.softParticles)&&void 0!==k&&k,softNearFade:null!==(O=n.softNearFade)&&void 0!==O?O:0,softFarFade:null!==(T=n.softFarFade)&&void 0!==T?T:0,layers:null!==(E=n.layers)&&void 0!==E?E:new p},this.neededToUpdateRender=!0,this.particles=new Array,this.startTileIndex=n.startTileIndex||new De(0),this.emitter=new we(this),this.paused=!1,this.particleNum=0,this.emissionState={isBursting:!1,burstParticleIndex:0,burstParticleCount:0,burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0,travelDistance:0},this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}return ue(i,[{key:"time",get:function(){return this.emissionState.time},set:function(e){this.emissionState.time=e}},{key:"layers",get:function(){return this.rendererSettings.layers}},{key:"texture",get:function(){return this.rendererSettings.material.map},set:function(e){this.rendererSettings.material.map=e,this.neededToUpdateRender=!0}},{key:"material",get:function(){return this.rendererSettings.material},set:function(e){this.rendererSettings.material=e,this.neededToUpdateRender=!0}},{key:"uTileCount",get:function(){return this.rendererSettings.uTileCount},set:function(e){this.rendererSettings.uTileCount=e,this.neededToUpdateRender=!0}},{key:"vTileCount",get:function(){return this.rendererSettings.vTileCount},set:function(e){this.rendererSettings.vTileCount=e,this.neededToUpdateRender=!0}},{key:"blendTiles",get:function(){return this.rendererSettings.blendTiles},set:function(e){this.rendererSettings.blendTiles=e,this.neededToUpdateRender=!0}},{key:"softParticles",get:function(){return this.rendererSettings.softParticles},set:function(e){this.rendererSettings.softParticles=e,this.neededToUpdateRender=!0}},{key:"softNearFade",get:function(){return this.rendererSettings.softNearFade},set:function(e){this.rendererSettings.softNearFade=e,this.neededToUpdateRender=!0}},{key:"softFarFade",get:function(){return this.rendererSettings.softFarFade},set:function(e){this.rendererSettings.softFarFade=e,this.neededToUpdateRender=!0}},{key:"instancingGeometry",get:function(){return this.rendererSettings.instancingGeometry},set:function(e){this.restart(),this.particles.length=0,this.rendererSettings.instancingGeometry=e,this.neededToUpdateRender=!0}},{key:"renderMode",get:function(){return this.rendererSettings.renderMode},set:function(t){if((this.rendererSettings.renderMode!=$t.Trail&&t===$t.Trail||this.rendererSettings.renderMode==$t.Trail&&t!==$t.Trail)&&(this.restart(),this.particles.length=0),this.rendererSettings.renderMode!==t)switch(t){case $t.Trail:this.rendererEmitterSettings={startLength:new De(30),followLocalOrigin:!1};break;case $t.Mesh:this.rendererEmitterSettings={geometry:new n(1,1)},this.startRotation=new He(new e(0,1,0),new De(0));break;case $t.StretchedBillBoard:this.rendererEmitterSettings={speedFactor:0,lengthFactor:2},this.rendererSettings.renderMode===$t.Mesh&&(this.startRotation=new De(0));break;case $t.BillBoard:case $t.VerticalBillBoard:case $t.HorizontalBillBoard:this.rendererEmitterSettings={},this.rendererSettings.renderMode===$t.Mesh&&(this.startRotation=new De(0))}this.rendererSettings.renderMode=t,this.neededToUpdateRender=!0}},{key:"renderOrder",get:function(){return this.rendererSettings.renderOrder},set:function(e){this.rendererSettings.renderOrder=e,this.neededToUpdateRender=!0}},{key:"blending",get:function(){return this.rendererSettings.material.blending},set:function(e){this.rendererSettings.material.blending=e,this.neededToUpdateRender=!0}},{key:"pause",value:function(){this.paused=!0}},{key:"play",value:function(){this.paused=!1}},{key:"spawn",value:function(t,n,i){nn.setFromRotationMatrix(i);var r=rn,a=nn,o=an;i.decompose(r,a,o);for(var s=0;s<t;s++){for(n.burstParticleIndex=s,this.particleNum++;this.particles.length<this.particleNum;)this.rendererSettings.renderMode===$t.Trail?this.particles.push(new Oe):this.particles.push(new Ne);var l=this.particles[this.particleNum-1];if(l.speedModifier=1,this.startColor.genColor(l.startColor,this.emissionState.time,{}),l.color.copy(l.startColor),l.startSpeed=this.startSpeed.genValue(n.time/this.duration),l.life=this.startLife.genValue(n.time/this.duration),l.age=0,l.startSize=this.startSize.genValue(n.time/this.duration),l.uvTile=this.startTileIndex.genValue(),l.size=l.startSize,this.rendererSettings.renderMode===$t.Mesh||this.rendererSettings.renderMode===$t.BillBoard||this.rendererSettings.renderMode===$t.VerticalBillBoard||this.rendererSettings.renderMode===$t.HorizontalBillBoard||this.rendererSettings.renderMode===$t.StretchedBillBoard){var c=l;this.rendererSettings.renderMode===$t.Mesh?(c.rotation instanceof u||(c.rotation=new u),"rotation"===this.startRotation.type?this.startRotation.genValue(c.rotation,n.time/this.duration):c.rotation.setFromAxisAngle(tn,this.startRotation.genValue(n.time/this.duration))):"rotation"===this.startRotation.type?c.rotation=0:c.rotation=this.startRotation.genValue(n.time/this.duration)}else if(this.rendererSettings.renderMode===$t.Trail){l.length=this.rendererEmitterSettings.startLength.genValue(n.time/this.duration)}if(this.emitterShape.initialize(l,n),this.rendererSettings.renderMode===$t.Trail&&this.rendererEmitterSettings.followLocalOrigin){var d=l;d.localPosition=(new e).copy(d.position)}this.worldSpace?(l.position.applyMatrix4(i),l.startSize=l.startSize*(Math.abs(o.x)+Math.abs(o.y)+Math.abs(o.z))/3,l.size=l.startSize,l.velocity.multiply(o).applyMatrix3(this.normalMatrix),l.rotation&&l.rotation instanceof u&&l.rotation.multiplyQuaternions(nn,l.rotation)):this.onlyUsedByOther&&(l.parentMatrix=i);for(var h=0;h<this.behaviors.length;h++)this.behaviors[h].initialize(l,this)}}},{key:"endEmit",value:function(){this.emitEnded=!0,this.autoDestroy&&(this.markForDestroy=!0)}},{key:"dispose",value:function(){this._renderer&&this._renderer.deleteSystem(this),this.emitter.dispose(),this.emitter.parent&&this.emitter.parent.remove(this.emitter)}},{key:"restart",value:function(){this.paused=!1,this.particleNum=0,this.emissionState.isBursting=!1,this.emissionState.burstIndex=0,this.emissionState.burstWaveIndex=0,this.emissionState.time=0,this.emissionState.waitEmiting=0,this.behaviors.forEach((function(e){e.reset()})),this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}},{key:"update",value:function(e){if(!this.paused){for(var t=this.emitter;t.parent;)t=t.parent;if("Scene"===t.type)if(this.firstTimeUpdate&&(this.firstTimeUpdate=!1,this.emitter.updateWorldMatrix(!0,!1)),this.emitEnded&&0===this.particleNum)this.markForDestroy&&this.emitter.parent&&this.dispose();else{if(this.looping&&this.prewarm&&!this.prewarmed){this.prewarmed=!0;for(var n=0;n<60*this.duration;n++)this.update(1/60)}e>.1&&(e=.1),this.neededToUpdateRender&&(this._renderer&&this._renderer.updateSystem(this),this.neededToUpdateRender=!1),this.onlyUsedByOther||this.emit(e,this.emissionState,this.emitter.matrixWorld),this.emitterShape.update(this,e);for(var i=0;i<this.behaviors.length;i++){this.behaviors[i].frameUpdate(e);for(var r=0;r<this.particleNum;r++)this.particles[r].died||this.behaviors[i].update(this.particles[r],e)}for(var a=0;a<this.particleNum;a++)this.rendererEmitterSettings.followLocalOrigin&&this.particles[a].localPosition?(this.particles[a].position.copy(this.particles[a].localPosition),this.particles[a].parentMatrix?this.particles[a].position.applyMatrix4(this.particles[a].parentMatrix):this.particles[a].position.applyMatrix4(this.emitter.matrixWorld)):this.particles[a].position.addScaledVector(this.particles[a].velocity,e*this.particles[a].speedModifier),this.particles[a].age+=e;if(this.rendererSettings.renderMode===$t.Trail)for(var o=0;o<this.particleNum;o++){this.particles[o].update()}for(var s=0;s<this.particleNum;s++){var u=this.particles[s];!u.died||u instanceof Oe&&0!==u.previous.length||(this.particles[s]=this.particles[this.particleNum-1],this.particles[this.particleNum-1]=u,this.particleNum--,s--)}}else this.dispose()}}},{key:"emit",value:function(t,n,i){n.time>this.duration&&(this.looping?(n.time-=this.duration,n.burstIndex=0,this.behaviors.forEach((function(e){e.reset()}))):this.emitEnded||this.onlyUsedByOther||this.endEmit()),this.normalMatrix.getNormalMatrix(i);var r=Math.ceil(n.waitEmiting);for(this.spawn(r,n,i),n.waitEmiting-=r;n.burstIndex<this.emissionBursts.length&&this.emissionBursts[n.burstIndex].time<=n.time;){if(Math.random()<this.emissionBursts[n.burstIndex].probability){var a=this.emissionBursts[n.burstIndex].count.genValue(this.time);n.isBursting=!0,n.burstParticleCount=a,this.spawn(a,n,i),n.isBursting=!1}n.burstIndex++}if(!this.emitEnded&&(n.waitEmiting+=t*this.emissionOverTime.genValue(n.time/this.duration),null!=n.previousWorldPos)){this.temp.set(i.elements[12],i.elements[13],i.elements[14]),n.travelDistance+=n.previousWorldPos.distanceTo(this.temp);var o=this.emissionOverDistance.genValue(n.time/this.duration);if(n.travelDistance*o>0){var s=Math.floor(n.travelDistance*o);n.travelDistance-=s/o,n.waitEmiting+=s}}void 0===n.previousWorldPos&&(n.previousWorldPos=new e),n.previousWorldPos.set(i.elements[12],i.elements[13],i.elements[14]),n.time+=t}},{key:"toJSON",value:function(e){var t,n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(((void 0===e||"string"==typeof e)&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}}),e.materials[this.rendererSettings.material.uuid]=this.rendererSettings.material.toJSON(e),i.useUrlForImage)&&void 0!==(null===(t=this.texture)||void 0===t?void 0:t.source)){var r=this.texture.source;e.images[r.uuid]={uuid:r.uuid,url:this.texture.image.url}}n=this.renderMode===$t.Trail?{startLength:this.rendererEmitterSettings.startLength.toJSON(),followLocalOrigin:this.rendererEmitterSettings.followLocalOrigin}:this.renderMode===$t.Mesh?{}:this.renderMode===$t.StretchedBillBoard?{speedFactor:this.rendererEmitterSettings.speedFactor,lengthFactor:this.rendererEmitterSettings.lengthFactor}:{};var a=this.rendererSettings.instancingGeometry;return e.geometries&&!e.geometries[a.uuid]&&(e.geometries[a.uuid]=a.toJSON()),{version:"3.0",autoDestroy:this.autoDestroy,looping:this.looping,prewarm:this.prewarm,duration:this.duration,shape:this.emitterShape.toJSON(),startLife:this.startLife.toJSON(),startSpeed:this.startSpeed.toJSON(),startRotation:this.startRotation.toJSON(),startSize:this.startSize.toJSON(),startColor:this.startColor.toJSON(),emissionOverTime:this.emissionOverTime.toJSON(),emissionOverDistance:this.emissionOverDistance.toJSON(),emissionBursts:this.emissionBursts.map((function(e){return{time:e.time,count:e.count.toJSON(),probability:e.probability,interval:e.interval,cycle:e.cycle}})),onlyUsedByOther:this.onlyUsedByOther,instancingGeometry:this.rendererSettings.instancingGeometry.uuid,renderOrder:this.renderOrder,renderMode:this.renderMode,rendererEmitterSettings:n,material:this.rendererSettings.material.uuid,layers:this.layers.mask,startTileIndex:this.startTileIndex.toJSON(),uTileCount:this.uTileCount,vTileCount:this.vTileCount,blendTiles:this.blendTiles,softParticles:this.rendererSettings.softParticles,softFarFade:this.rendererSettings.softFarFade,softNearFade:this.rendererSettings.softNearFade,behaviors:this.behaviors.map((function(e){return e.toJSON()})),worldSpace:this.worldSpace}}},{key:"addBehavior",value:function(e){this.behaviors.push(e)}},{key:"getRendererSettings",value:function(){return this.rendererSettings}},{key:"clone",value:function(){var e,t=[],n=Se(this.emissionBursts);try{for(n.s();!(e=n.n()).done;){var r=e.value,a={};Object.assign(a,r),t.push(a)}}catch(h){n.e(h)}finally{n.f()}var o,s,u=[],l=Se(this.behaviors);try{for(l.s();!(o=l.n()).done;){var c=o.value;u.push(c.clone())}}catch(h){l.e(h)}finally{l.f()}s=this.renderMode===$t.Trail?{startLength:this.rendererEmitterSettings.startLength.clone(),followLocalOrigin:this.rendererEmitterSettings.followLocalOrigin}:{};var d=new p;return d.mask=this.layers.mask,new i({autoDestroy:this.autoDestroy,looping:this.looping,duration:this.duration,shape:this.emitterShape.clone(),startLife:this.startLife.clone(),startSpeed:this.startSpeed.clone(),startRotation:this.startRotation.clone(),startSize:this.startSize.clone(),startColor:this.startColor.clone(),emissionOverTime:this.emissionOverTime.clone(),emissionOverDistance:this.emissionOverDistance.clone(),emissionBursts:t,onlyUsedByOther:this.onlyUsedByOther,instancingGeometry:this.rendererSettings.instancingGeometry,renderMode:this.renderMode,renderOrder:this.renderOrder,rendererEmitterSettings:s,material:this.rendererSettings.material,startTileIndex:this.startTileIndex,uTileCount:this.uTileCount,vTileCount:this.vTileCount,blendTiles:this.blendTiles,softParticles:this.softParticles,softFarFade:this.softFarFade,softNearFade:this.softNearFade,behaviors:u,worldSpace:this.worldSpace,layers:d})}}],[{key:"fromJSON",value:function(e,t,n){var r,a,o,s=Kt(e.shape,t);if(e.renderMode===$t.Trail){var u=e.rendererEmitterSettings;o={startLength:null!=u.startLength?Xe(u.startLength):new De(30),followLocalOrigin:u.followLocalOrigin}}else e.renderMode===$t.Mesh?o={}:e.renderMode===$t.StretchedBillBoard?(o=e.rendererEmitterSettings,null!=e.speedFactor&&(o.speedFactor=e.speedFactor)):o={};var l=new p;e.layers&&(l.mask=e.layers);var c=new i({autoDestroy:e.autoDestroy,looping:e.looping,prewarm:e.prewarm,duration:e.duration,shape:s,startLife:Xe(e.startLife),startSpeed:Xe(e.startSpeed),startRotation:Qe(e.startRotation),startSize:Xe(e.startSize),startColor:Je(e.startColor),emissionOverTime:Xe(e.emissionOverTime),emissionOverDistance:Xe(e.emissionOverDistance),emissionBursts:null===(r=e.emissionBursts)||void 0===r?void 0:r.map((function(e){return{time:e.time,count:"number"==typeof e.count?new De(e.count):Xe(e.count),probability:e.probability,interval:e.interval,cycle:e.cycle}})),onlyUsedByOther:e.onlyUsedByOther,instancingGeometry:t.geometries[e.instancingGeometry],renderMode:e.renderMode,rendererEmitterSettings:o,renderOrder:e.renderOrder,layers:l,material:e.material?t.materials[e.material]:e.texture?new m({map:t.textures[e.texture],transparent:null===(a=e.transparent)||void 0===a||a,blending:e.blending,side:v}):new m({color:16777215,transparent:!0,blending:y,side:v}),startTileIndex:"number"==typeof e.startTileIndex?new De(e.startTileIndex):Xe(e.startTileIndex),uTileCount:e.uTileCount,vTileCount:e.vTileCount,blendTiles:e.blendTiles,softParticles:e.softParticles,softFarFade:e.softFarFade,softNearFade:e.softNearFade,behaviors:[],worldSpace:e.worldSpace});return c.behaviors=e.behaviors.map((function(e){var t=Ft(e,c);return"EmitSubParticleSystem"===t.type&&(n[e.subParticleSystem]=t),t})),c}}]),i}(),un="\n\n#include <common>\n#include <color_pars_fragment>\n#include <map_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n#include <alphatest_pars_fragment>\n\n#include <tile_pars_fragment>\n#include <soft_pars_fragment>\n\nvoid main() {\n\n    #include <clipping_planes_fragment>\n    \n    vec3 outgoingLight = vec3( 0.0 );\n    vec4 diffuseColor = vColor;\n    \n    #include <logdepthbuf_fragment>\n    \n    #include <tile_fragment>\n    #include <alphatest_fragment>\n\n    outgoingLight = diffuseColor.rgb;\n    \n    #ifdef USE_COLOR_AS_ALPHA\n    gl_FragColor = vec4( outgoingLight, diffuseColor.r );\n    #else\n    gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n    #endif\n    \n    #include <soft_fragment>\n    #include <tonemapping_fragment>\n}\n";function ln(e){return 0===e?"uv":"uv".concat(e)}new e(0,0,1);var cn=function(n){ce(a,en);var r=pe(a);function a(t){var n;return oe(this,a),le(fe(n=r.call(this,t)),"offsetBuffer",void 0),le(fe(n),"rotationBuffer",void 0),le(fe(n),"sizeBuffer",void 0),le(fe(n),"colorBuffer",void 0),le(fe(n),"uvTileBuffer",void 0),le(fe(n),"velocityBuffer",void 0),le(fe(n),"vector_",new e),le(fe(n),"vector2_",new e),le(fe(n),"vector3_",new e),le(fe(n),"quaternion_",new u),le(fe(n),"quaternion2_",new u),le(fe(n),"quaternion3_",new u),le(fe(n),"rotationMat_",new f),le(fe(n),"rotationMat2_",new f),n.maxParticles=1e3,n.setupBuffers(),n.rebuildMaterial(),n}return ue(a,[{key:"buildExpandableBuffers",value:function(){this.offsetBuffer=new g(new Float32Array(3*this.maxParticles),3),this.offsetBuffer.setUsage(S),this.geometry.setAttribute("offset",this.offsetBuffer),this.colorBuffer=new g(new Float32Array(4*this.maxParticles),4),this.colorBuffer.setUsage(S),this.geometry.setAttribute("color",this.colorBuffer),this.settings.renderMode===$t.Mesh?(this.rotationBuffer=new g(new Float32Array(4*this.maxParticles),4),this.rotationBuffer.setUsage(S),this.geometry.setAttribute("rotation",this.rotationBuffer)):this.settings.renderMode!==$t.BillBoard&&this.settings.renderMode!==$t.HorizontalBillBoard&&this.settings.renderMode!==$t.VerticalBillBoard&&this.settings.renderMode!==$t.StretchedBillBoard||(this.rotationBuffer=new g(new Float32Array(this.maxParticles),1),this.rotationBuffer.setUsage(S),this.geometry.setAttribute("rotation",this.rotationBuffer)),this.sizeBuffer=new g(new Float32Array(this.maxParticles),1),this.sizeBuffer.setUsage(S),this.geometry.setAttribute("size",this.sizeBuffer),this.uvTileBuffer=new g(new Float32Array(this.maxParticles),1),this.uvTileBuffer.setUsage(S),this.geometry.setAttribute("uvTile",this.uvTileBuffer),this.settings.renderMode===$t.StretchedBillBoard&&(this.velocityBuffer=new g(new Float32Array(4*this.maxParticles),4),this.velocityBuffer.setUsage(S),this.geometry.setAttribute("velocity",this.velocityBuffer))}},{key:"setupBuffers",value:function(){this.geometry&&this.geometry.dispose(),this.geometry=new x,this.geometry.setIndex(this.settings.instancingGeometry.getIndex()),this.settings.instancingGeometry.hasAttribute("normal")&&this.geometry.setAttribute("normal",this.settings.instancingGeometry.getAttribute("normal")),this.geometry.setAttribute("position",this.settings.instancingGeometry.getAttribute("position")),this.geometry.setAttribute("uv",this.settings.instancingGeometry.getAttribute("uv")),this.buildExpandableBuffers()}},{key:"expandBuffers",value:function(e){for(;e>=this.maxParticles;)this.maxParticles*=2;this.setupBuffers()}},{key:"rebuildMaterial",value:function(){var e;this.layers.mask=this.settings.layers.mask;var n={};if("MeshStandardMaterial"===this.settings.material.type||"MeshPhysicalMaterial"===this.settings.material.type){var r=this.settings.material;(e=w.merge([b.common,b.envmap,b.aomap,b.lightmap,b.emissivemap,b.bumpmap,b.normalmap,b.displacementmap,b.roughnessmap,b.metalnessmap,b.fog,b.lights,{emissive:{value:new M(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}])).diffuse.value=r.color,e.opacity.value=r.opacity,e.emissive.value=r.emissive,e.roughness.value=r.roughness,e.metalness.value=r.metalness,r.envMap&&(e.envMap.value=r.envMap,e.envMapIntensity.value=r.envMapIntensity),r.normalMap&&(e.normalMap.value=r.normalMap,e.normalScale.value=r.normalScale),r.roughnessMap&&(e.roughnessMap.value=r.roughnessMap),r.metalnessMap&&(e.metalnessMap.value=r.metalnessMap),r.map&&(e.map=new _(r.map))}else(e={}).map=new _(this.settings.material.map);this.settings.material.alphaTest&&(n.USE_ALPHATEST="",e.alphaTest=new _(this.settings.material.alphaTest)),n.USE_UV="";var a,o=this.settings.uTileCount,s=this.settings.vTileCount;if((o>1||s>1)&&(n.UV_TILE="",e.tileCount=new _(new i(o,s))),this.settings.material.defines&&void 0!==this.settings.material.defines.USE_COLOR_AS_ALPHA&&(n.USE_COLOR_AS_ALPHA=""),this.settings.material.normalMap&&(n.USE_NORMALMAP="",n.NORMALMAP_UV=ln(this.settings.material.normalMap.channel),e.normalMapTransform=new _((new f).copy(this.settings.material.normalMap.matrix))),this.settings.material.map&&(n.USE_MAP="",this.settings.blendTiles&&(n.TILE_BLEND=""),n.MAP_UV=ln(this.settings.material.map.channel),e.mapTransform=new _((new f).copy(this.settings.material.map.matrix))),n.USE_COLOR_ALPHA="",this.settings.softParticles){n.SOFT_PARTICLES="";var u=this.settings.softNearFade,l=1/(this.settings.softFarFade-this.settings.softNearFade);e.softParams=new _(new i(u,l)),e.depthTexture=new _(null);var c=e.projParams=new _(new t);a=function(e,t,n){c.value.set(n.near,n.far,0,0)}}var d=!1;if(this.settings.renderMode===$t.BillBoard||this.settings.renderMode===$t.VerticalBillBoard||this.settings.renderMode===$t.HorizontalBillBoard||this.settings.renderMode===$t.Mesh){var h,p;this.settings.renderMode===$t.Mesh?"MeshStandardMaterial"===this.settings.material.type||"MeshPhysicalMaterial"===this.settings.material.type?(n.USE_COLOR="",h="\n#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n\nattribute vec3 offset;\nattribute vec4 rotation;\nattribute float size;\n#include <tile_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n    #include <tile_vertex>\n    float x2 = rotation.x + rotation.x, y2 = rotation.y + rotation.y, z2 = rotation.z + rotation.z;\n    float xx = rotation.x * x2, xy = rotation.x * y2, xz = rotation.x * z2;\n    float yy = rotation.y * y2, yz = rotation.y * z2, zz = rotation.z * z2;\n    float wx = rotation.w * x2, wy = rotation.w * y2, wz = rotation.w * z2;\n    float sx = size, sy = size, sz = size;\n\n    mat4 particleMatrix = mat4(( 1.0 - ( yy + zz ) ) * sx, ( xy + wz ) * sx, ( xz - wy ) * sx, 0.0,  // 1. column\n                      ( xy - wz ) * sy, ( 1.0 - ( xx + zz ) ) * sy, ( yz + wx ) * sy, 0.0,  // 2. column\n                      ( xz + wy ) * sz, ( yz - wx ) * sz, ( 1.0 - ( xx + yy ) ) * sz, 0.0,  // 3. column\n                      offset.x, offset.y, offset.z, 1.0);\n\n#include <color_vertex>\n#include <morphinstance_vertex>\n#include <morphcolor_vertex>\n#include <batching_vertex>\n\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n\n\t// replace defaultnormal_vertex\n\tvec3 transformedNormal = objectNormal;\n    mat3 m = mat3( particleMatrix );\n    transformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );\n    transformedNormal = m * transformedNormal;\n    transformedNormal = normalMatrix * transformedNormal;\n    #ifdef FLIP_SIDED\n        transformedNormal = - transformedNormal;\n    #endif\n    #ifdef USE_TANGENT\n        vec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n        #ifdef FLIP_SIDED\n        transformedTangent = - transformedTangent;\n        #endif\n    #endif\n\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\n\t// replace include <project_vertex>\n  vec4 mvPosition = vec4( transformed, 1.0 );\n  mvPosition = modelViewMatrix * (particleMatrix * mvPosition);\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t\n\tvViewPosition = - mvPosition.xyz;\n\t\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n    vWorldPosition = worldPosition.xyz;\n#endif\n}\n",p="\n#define STANDARD\n\n#ifdef PHYSICAL\n#define IOR\n#define USE_SPECULAR\n#endif\n\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n\n#ifdef IOR\nuniform float ior;\n#endif\n\n#ifdef USE_SPECULAR\nuniform float specularIntensity;\nuniform vec3 specularColor;\n\n#ifdef USE_SPECULAR_COLORMAP\nuniform sampler2D specularColorMap;\n#endif\n\n#ifdef USE_SPECULAR_INTENSITYMAP\nuniform sampler2D specularIntensityMap;\n#endif\n#endif\n\n#ifdef USE_CLEARCOAT\nuniform float clearcoat;\nuniform float clearcoatRoughness;\n#endif\n\n#ifdef USE_DISPERSION\nuniform float dispersion;\n#endif\n\n#ifdef USE_IRIDESCENCE\nuniform float iridescence;\nuniform float iridescenceIOR;\nuniform float iridescenceThicknessMinimum;\nuniform float iridescenceThicknessMaximum;\n#endif\n\n#ifdef USE_SHEEN\nuniform vec3 sheenColor;\nuniform float sheenRoughness;\n\n#ifdef USE_SHEEN_COLORMAP\nuniform sampler2D sheenColorMap;\n#endif\n\n#ifdef USE_SHEEN_ROUGHNESSMAP\nuniform sampler2D sheenRoughnessMap;\n#endif\n#endif\n\n#ifdef USE_ANISOTROPY\nuniform vec2 anisotropyVector;\n\n#ifdef USE_ANISOTROPYMAP\nuniform sampler2D anisotropyMap;\n#endif\n#endif\n\nvarying vec3 vViewPosition;\n\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\nvec4 diffuseColor = vec4( diffuse, opacity );\n#include <clipping_planes_fragment>\n\nReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\nvec3 totalEmissiveRadiance = emissive;\n\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <color_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <alphahash_fragment>\n#include <roughnessmap_fragment>\n#include <metalnessmap_fragment>\n#include <normal_fragment_begin>\n#include <normal_fragment_maps>\n#include <clearcoat_normal_fragment_begin>\n#include <clearcoat_normal_fragment_maps>\n#include <emissivemap_fragment>\n\n// accumulation\n#include <lights_physical_fragment>\n#include <lights_fragment_begin>\n#include <lights_fragment_maps>\n#include <lights_fragment_end>\n\n// modulation\n#include <aomap_fragment>\n\nvec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\nvec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\n#include <transmission_fragment>\n\nvec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n\n#ifdef USE_SHEEN\n\n// Sheen energy compensation approximation calculation can be found at the end of\n// https://drive.google.com/file/d/1T0D1VSyR4AllqIJTQAraEIzjlb5h4FKH/view?usp=sharing\nfloat sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n\noutgoingLight = outgoingLight * sheenEnergyComp + sheenSpecularDirect + sheenSpecularIndirect;\n\n#endif\n\n#ifdef USE_CLEARCOAT\n\nfloat dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );\n\nvec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n\noutgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + ( clearcoatSpecularDirect + clearcoatSpecularIndirect ) * material.clearcoat;\n\n#endif\n\n#include <opaque_fragment>\n#include <tonemapping_fragment>\n#include <colorspace_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}",d=!0):(h="\n#include <common>\n#include <color_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#include <tile_pars_vertex>\n#include <soft_pars_vertex>\n\nattribute vec3 offset;\nattribute vec4 rotation;\nattribute float size;\n// attribute vec4 color;\n\nvoid main() {\n\n    float x2 = rotation.x + rotation.x, y2 = rotation.y + rotation.y, z2 = rotation.z + rotation.z;\n    float xx = rotation.x * x2, xy = rotation.x * y2, xz = rotation.x * z2;\n    float yy = rotation.y * y2, yz = rotation.y * z2, zz = rotation.z * z2;\n    float wx = rotation.w * x2, wy = rotation.w * y2, wz = rotation.w * z2;\n    float sx = size, sy = size, sz = size;\n    \n    mat4 matrix = mat4(( 1.0 - ( yy + zz ) ) * sx, ( xy + wz ) * sx, ( xz - wy ) * sx, 0.0,  // 1. column\n                      ( xy - wz ) * sy, ( 1.0 - ( xx + zz ) ) * sy, ( yz + wx ) * sy, 0.0,  // 2. column\n                      ( xz + wy ) * sz, ( yz - wx ) * sz, ( 1.0 - ( xx + yy ) ) * sz, 0.0,  // 3. column\n                      offset.x, offset.y, offset.z, 1.0);\n    \n    vec4 mvPosition = modelViewMatrix * (matrix * vec4( position, 1.0 ));\n\n\tvColor = color;\n\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n    #include <tile_vertex>\n    #include <soft_vertex>\n}\n",p=un):(h="\n#include <common>\n#include <color_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\n#include <tile_pars_vertex>\n#include <soft_pars_vertex>\n\nattribute vec3 offset;\nattribute float rotation;\nattribute float size;\n\nvoid main() {\n\t\n    vec2 alignedPosition = ( position.xy ) * size;\n    \n    vec2 rotatedPosition;\n    rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n    rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n#ifdef HORIZONTAL\n    vec4 mvPosition = modelMatrix * vec4( offset, 1.0 );\n    mvPosition.x += rotatedPosition.x;\n    mvPosition.z -= rotatedPosition.y;\n    mvPosition = viewMatrix * mvPosition;\n#elif defined(VERTICAL)\n    vec4 mvPosition = modelMatrix * vec4( offset, 1.0 );\n    mvPosition.y += rotatedPosition.y;\n    mvPosition = viewMatrix * mvPosition;\n    mvPosition.x += rotatedPosition.x;\n#else\n    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );\n    mvPosition.xy += rotatedPosition;\n#endif\n\n\tvColor = color;\n\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\n\t#include <clipping_planes_vertex>\n\n\t#include <tile_vertex>\n\t#include <soft_vertex>\n}\n",p=un),this.settings.renderMode===$t.VerticalBillBoard?n.VERTICAL="":this.settings.renderMode===$t.HorizontalBillBoard&&(n.HORIZONTAL=""),this.material=new N({uniforms:e,defines:n,vertexShader:h,fragmentShader:p,transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,blending:this.settings.material.blending,side:this.settings.material.side,alphaTest:this.settings.material.alphaTest,lights:d})}else{if(this.settings.renderMode!==$t.StretchedBillBoard)throw new Error("render mode unavailable");e.speedFactor=new _(1),this.material=new N({uniforms:e,defines:n,vertexShader:"\n#include <common>\n#include <color_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\n#include <tile_pars_vertex>\n#include <soft_pars_vertex>\n\nattribute vec3 offset;\nattribute float rotation;\nattribute float size;\nattribute vec4 velocity;\n\nuniform float speedFactor;\n\nvoid main() {\n    float lengthFactor = velocity.w;\n#ifdef USE_SKEW\n    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );\n    vec3 viewVelocity = normalMatrix * velocity.xyz;\n\n    vec3 scaledPos = vec3(position.xy * size, position.z);\n    float vlength = length(viewVelocity);\n    vec3 projVelocity =  dot(scaledPos, viewVelocity) * viewVelocity / vlength;\n    mvPosition.xyz += scaledPos + projVelocity * (speedFactor / size + lengthFactor / vlength);\n#else\n    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );\n    vec3 viewVelocity = normalMatrix * velocity.xyz;\n    float vlength = length(viewVelocity); \n    mvPosition.xyz += position.y * normalize(cross(mvPosition.xyz, viewVelocity)) * size; // switch the cross to  match unity implementation\n    mvPosition.xyz -= (position.x + 0.5) * viewVelocity * (1.0 + lengthFactor / vlength) * size; // minus position.x to match unity implementation\n#endif\n\tvColor = color;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <tile_vertex>\n\t#include <soft_vertex>\n}\n",fragmentShader:un,transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,blending:this.settings.material.blending,side:this.settings.material.side,alphaTest:this.settings.material.alphaTest})}this.material&&a&&(this.material.onBeforeRender=a)}},{key:"update",value:function(){var e=this,t=0,n=0;this.systems.forEach((function(e){n+=e.particleNum})),n>this.maxParticles&&this.expandBuffers(n),this.systems.forEach((function(n){var i=n.particles,r=n.particleNum,a=e.quaternion2_,o=e.vector2_,s=e.vector3_;n.emitter.matrixWorld.decompose(o,a,s),e.rotationMat_.setFromMatrix4(n.emitter.matrixWorld);for(var u=0;u<r;u++,t++){var l=i[u];if(e.settings.renderMode===$t.Mesh){var c=void 0;if(n.worldSpace)c=l.rotation;else{var d=void 0;d=l.parentMatrix?e.quaternion3_.setFromRotationMatrix(l.parentMatrix):a,(c=e.quaternion_).copy(d).multiply(l.rotation)}e.rotationBuffer.setXYZW(t,c.x,c.y,c.z,c.w)}else e.settings.renderMode!==$t.StretchedBillBoard&&e.settings.renderMode!==$t.VerticalBillBoard&&e.settings.renderMode!==$t.HorizontalBillBoard&&e.settings.renderMode!==$t.BillBoard||e.rotationBuffer.setX(t,l.rotation);var h=void 0;if(n.worldSpace?h=l.position:(h=e.vector_,l.parentMatrix?h.copy(l.position).applyMatrix4(l.parentMatrix):h.copy(l.position).applyMatrix4(n.emitter.matrixWorld)),e.offsetBuffer.setXYZ(t,h.x,h.y,h.z),e.colorBuffer.setXYZW(t,l.color.x,l.color.y,l.color.z,l.color.w),n.worldSpace||l.parentMatrix?e.sizeBuffer.setX(t,l.size):e.sizeBuffer.setX(t,l.size*(Math.abs(s.x)+Math.abs(s.y)+Math.abs(s.z))/3),e.uvTileBuffer.setX(t,l.uvTile),e.settings.renderMode===$t.StretchedBillBoard&&e.velocityBuffer){var f=n.rendererEmitterSettings.speedFactor;0===f&&(f=.001);var p=n.rendererEmitterSettings.lengthFactor,m=void 0;n.worldSpace?m=l.velocity:(m=e.vector_,l.parentMatrix?(e.rotationMat2_.setFromMatrix4(l.parentMatrix),m.copy(l.velocity).applyMatrix3(e.rotationMat2_)):m.copy(l.velocity).applyMatrix3(e.rotationMat_)),e.velocityBuffer.setXYZW(t,m.x*f,m.y*f,m.z*f,p)}}})),this.geometry.instanceCount=t,t>0&&(this.offsetBuffer.updateRange.count=3*t,this.offsetBuffer.needsUpdate=!0,this.sizeBuffer.updateRange.count=t,this.sizeBuffer.needsUpdate=!0,this.colorBuffer.updateRange.count=4*t,this.colorBuffer.needsUpdate=!0,this.uvTileBuffer.updateRange.count=t,this.uvTileBuffer.needsUpdate=!0,this.settings.renderMode===$t.StretchedBillBoard&&this.velocityBuffer&&(this.velocityBuffer.updateRange.count=4*t,this.velocityBuffer.needsUpdate=!0),this.settings.renderMode===$t.Mesh?(this.rotationBuffer.updateRange.count=4*t,this.rotationBuffer.needsUpdate=!0):this.settings.renderMode!==$t.StretchedBillBoard&&this.settings.renderMode!==$t.HorizontalBillBoard&&this.settings.renderMode!==$t.VerticalBillBoard&&this.settings.renderMode!==$t.BillBoard||(this.rotationBuffer.updateRange.count=t,this.rotationBuffer.needsUpdate=!0))}},{key:"dispose",value:function(){this.geometry.dispose()}}]),a}();new e(0,0,1);var dn=function(t){ce(r,en);var n=pe(r);function r(t){var i;return oe(this,r),le(fe(i=n.call(this,t)),"positionBuffer",void 0),le(fe(i),"previousBuffer",void 0),le(fe(i),"nextBuffer",void 0),le(fe(i),"uvBuffer",void 0),le(fe(i),"sideBuffer",void 0),le(fe(i),"widthBuffer",void 0),le(fe(i),"colorBuffer",void 0),le(fe(i),"indexBuffer",void 0),le(fe(i),"vector_",new e),le(fe(i),"vector2_",new e),le(fe(i),"vector3_",new e),le(fe(i),"quaternion_",new u),i.maxParticles=1e4,i.setupBuffers(),i.rebuildMaterial(),i}return ue(r,[{key:"setupBuffers",value:function(){this.geometry&&this.geometry.dispose(),this.geometry=new k,this.indexBuffer=new O(new Uint32Array(6*this.maxParticles),1),this.indexBuffer.setUsage(S),this.geometry.setIndex(this.indexBuffer),this.positionBuffer=new O(new Float32Array(6*this.maxParticles),3),this.positionBuffer.setUsage(S),this.geometry.setAttribute("position",this.positionBuffer),this.previousBuffer=new O(new Float32Array(6*this.maxParticles),3),this.previousBuffer.setUsage(S),this.geometry.setAttribute("previous",this.previousBuffer),this.nextBuffer=new O(new Float32Array(6*this.maxParticles),3),this.nextBuffer.setUsage(S),this.geometry.setAttribute("next",this.nextBuffer),this.widthBuffer=new O(new Float32Array(2*this.maxParticles),1),this.widthBuffer.setUsage(S),this.geometry.setAttribute("width",this.widthBuffer),this.sideBuffer=new O(new Float32Array(2*this.maxParticles),1),this.sideBuffer.setUsage(S),this.geometry.setAttribute("side",this.sideBuffer),this.uvBuffer=new O(new Float32Array(4*this.maxParticles),2),this.uvBuffer.setUsage(S),this.geometry.setAttribute("uv",this.uvBuffer),this.colorBuffer=new O(new Float32Array(8*this.maxParticles),4),this.colorBuffer.setUsage(S),this.geometry.setAttribute("color",this.colorBuffer)}},{key:"expandBuffers",value:function(e){for(;e>=this.maxParticles;)this.maxParticles*=2;this.setupBuffers()}},{key:"rebuildMaterial",value:function(){this.layers.mask=this.settings.layers.mask;var e={lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},resolution:{value:new i(1,1)},sizeAttenuation:{value:1},visibility:{value:1},alphaTest:{value:0}},t={USE_UV:"",USE_COLOR_ALPHA:""};if(this.settings.material.map&&(t.USE_MAP="",t.MAP_UV=ln(this.settings.material.map.channel),e.map=new _(this.settings.material.map),e.mapTransform=new _((new f).copy(this.settings.material.map.matrix))),this.settings.material.defines&&void 0!==this.settings.material.defines.USE_COLOR_AS_ALPHA&&(t.USE_COLOR_AS_ALPHA=""),this.settings.renderMode!==$t.Trail)throw new Error("render mode unavailable");this.material=new N({uniforms:e,defines:t,vertexShader:"\n#include <common>\n#include <tile_pars_vertex>\n#include <color_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <fog_pars_vertex>\n\nattribute vec3 previous;\nattribute vec3 next;\nattribute float side;\nattribute float width;\n\nuniform vec2 resolution;\nuniform float lineWidth;\nuniform float sizeAttenuation;\n    \nvec2 fix(vec4 i, float aspect) {\n    vec2 res = i.xy / i.w;\n    res.x *= aspect;\n    return res;\n}\n    \nvoid main() {\n\n    #include <tile_vertex>\n    \n    float aspect = resolution.x / resolution.y;\n\n    vColor = color;\n\n    mat4 m = projectionMatrix * modelViewMatrix;\n    vec4 finalPosition = m * vec4( position, 1.0 );\n    vec4 prevPos = m * vec4( previous, 1.0 );\n    vec4 nextPos = m * vec4( next, 1.0 );\n\n    vec2 currentP = fix( finalPosition, aspect );\n    vec2 prevP = fix( prevPos, aspect );\n    vec2 nextP = fix( nextPos, aspect );\n\n    float w = lineWidth * width;\n\n    vec2 dir;\n    if( nextP == currentP ) dir = normalize( currentP - prevP );\n    else if( prevP == currentP ) dir = normalize( nextP - currentP );\n    else {\n        vec2 dir1 = normalize( currentP - prevP );\n        vec2 dir2 = normalize( nextP - currentP );\n        dir = normalize( dir1 + dir2 );\n\n        vec2 perp = vec2( -dir1.y, dir1.x );\n        vec2 miter = vec2( -dir.y, dir.x );\n        //w = clamp( w / dot( miter, perp ), 0., 4., * lineWidth * width );\n\n    }\n\n    //vec2 normal = ( cross( vec3( dir, 0. ) vec3( 0., 0., 1. ) ) ).xy;\n    vec4 normal = vec4( -dir.y, dir.x, 0., 1. );\n    normal.xy *= .5 * w;\n    normal *= projectionMatrix;\n    if( sizeAttenuation == 0. ) {\n        normal.xy *= finalPosition.w;\n        normal.xy /= ( vec4( resolution, 0., 1. ) * projectionMatrix ).xy;\n    }\n\n    finalPosition.xy += normal.xy * side;\n\n    gl_Position = finalPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t\n    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n    \n\t#include <fog_vertex>\n}",fragmentShader:"\n\n#include <common>\n#include <tile_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nuniform sampler2D alphaMap;\nuniform float useAlphaMap;\nuniform float visibility;\nuniform float alphaTest;\n\nvarying vec4 vColor;\n    \nvoid main() {\n    #include <clipping_planes_fragment>\n    #include <logdepthbuf_fragment>\n\n    vec4 diffuseColor = vColor;\n    \n    #ifdef USE_MAP\n    #include <tile_fragment>\n    #ifndef USE_COLOR_AS_ALPHA\n    #endif\n    #endif\n    if( useAlphaMap == 1. ) diffuseColor.a *= texture2D( alphaMap, vUv).a;\n    if( diffuseColor.a < alphaTest ) discard;\n    gl_FragColor = diffuseColor;\n\n    #include <fog_fragment>\n    #include <tonemapping_fragment>\n}",transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,side:this.settings.material.side,blending:this.settings.material.blending||y})}},{key:"update",value:function(){var e=this,t=0,n=0,i=0;this.systems.forEach((function(e){for(var t=0;t<e.particleNum;t++)i+=2*e.particles[t].previous.length})),i>this.maxParticles&&this.expandBuffers(i),this.systems.forEach((function(i){var r=e.quaternion_,a=e.vector2_,o=e.vector3_;i.emitter.matrixWorld.decompose(a,r,o);for(var s=i.particles,u=i.particleNum,l=e.settings.uTileCount,c=e.settings.vTileCount,d=1/l,h=1/c,f=0;f<u;f++){var p=s[f],m=p.uvTile%c,v=Math.floor(p.uvTile/c+.001),y=p.previous.values(),g=y.next(),S=g.value,x=S;g.done||(g=y.next());var w=void 0;w=void 0!==g.value?g.value:x;for(var b=0;b<p.previous.length;b++,t+=2){if(e.positionBuffer.setXYZ(t,x.position.x,x.position.y,x.position.z),e.positionBuffer.setXYZ(t+1,x.position.x,x.position.y,x.position.z),i.worldSpace?(e.positionBuffer.setXYZ(t,x.position.x,x.position.y,x.position.z),e.positionBuffer.setXYZ(t+1,x.position.x,x.position.y,x.position.z)):(p.parentMatrix?e.vector_.copy(x.position).applyMatrix4(p.parentMatrix):e.vector_.copy(x.position).applyMatrix4(i.emitter.matrixWorld),e.positionBuffer.setXYZ(t,e.vector_.x,e.vector_.y,e.vector_.z),e.positionBuffer.setXYZ(t+1,e.vector_.x,e.vector_.y,e.vector_.z)),i.worldSpace?(e.previousBuffer.setXYZ(t,S.position.x,S.position.y,S.position.z),e.previousBuffer.setXYZ(t+1,S.position.x,S.position.y,S.position.z)):(p.parentMatrix?e.vector_.copy(S.position).applyMatrix4(p.parentMatrix):e.vector_.copy(S.position).applyMatrix4(i.emitter.matrixWorld),e.previousBuffer.setXYZ(t,e.vector_.x,e.vector_.y,e.vector_.z),e.previousBuffer.setXYZ(t+1,e.vector_.x,e.vector_.y,e.vector_.z)),i.worldSpace?(e.nextBuffer.setXYZ(t,w.position.x,w.position.y,w.position.z),e.nextBuffer.setXYZ(t+1,w.position.x,w.position.y,w.position.z)):(p.parentMatrix?e.vector_.copy(w.position).applyMatrix4(p.parentMatrix):e.vector_.copy(w.position).applyMatrix4(i.emitter.matrixWorld),e.nextBuffer.setXYZ(t,e.vector_.x,e.vector_.y,e.vector_.z),e.nextBuffer.setXYZ(t+1,e.vector_.x,e.vector_.y,e.vector_.z)),e.sideBuffer.setX(t,-1),e.sideBuffer.setX(t+1,1),i.worldSpace)e.widthBuffer.setX(t,x.size),e.widthBuffer.setX(t+1,x.size);else if(p.parentMatrix)e.widthBuffer.setX(t,x.size),e.widthBuffer.setX(t+1,x.size);else{var M=(Math.abs(o.x)+Math.abs(o.y)+Math.abs(o.z))/3;e.widthBuffer.setX(t,x.size*M),e.widthBuffer.setX(t+1,x.size*M)}e.uvBuffer.setXY(t,(b/p.previous.length+m)*d,(c-v-1)*h),e.uvBuffer.setXY(t+1,(b/p.previous.length+m)*d,(c-v)*h),e.colorBuffer.setXYZW(t,x.color.x,x.color.y,x.color.z,x.color.w),e.colorBuffer.setXYZW(t+1,x.color.x,x.color.y,x.color.z,x.color.w),b+1<p.previous.length&&(e.indexBuffer.setX(3*n,t),e.indexBuffer.setX(3*n+1,t+1),e.indexBuffer.setX(3*n+2,t+2),n++,e.indexBuffer.setX(3*n,t+2),e.indexBuffer.setX(3*n+1,t+1),e.indexBuffer.setX(3*n+2,t+3),n++),S=x,x=w,g.done||void 0!==(g=y.next()).value&&(w=g.value)}}})),this.positionBuffer.updateRange.count=3*t,this.positionBuffer.needsUpdate=!0,this.previousBuffer.updateRange.count=3*t,this.previousBuffer.needsUpdate=!0,this.nextBuffer.updateRange.count=3*t,this.nextBuffer.needsUpdate=!0,this.sideBuffer.updateRange.count=t,this.sideBuffer.needsUpdate=!0,this.widthBuffer.updateRange.count=t,this.widthBuffer.needsUpdate=!0,this.uvBuffer.updateRange.count=2*t,this.uvBuffer.needsUpdate=!0,this.colorBuffer.updateRange.count=4*t,this.colorBuffer.needsUpdate=!0,this.indexBuffer.updateRange.count=3*n,this.indexBuffer.needsUpdate=!0,this.geometry.setDrawRange(0,3*n)}},{key:"dispose",value:function(){this.geometry.dispose()}}]),r}(),hn=function(e){ce(n,a);var t=pe(n);function n(){var e;return oe(this,n),le(fe(e=t.call(this)),"batches",[]),le(fe(e),"systemToBatchIndex",new Map),le(fe(e),"type","BatchedRenderer"),le(fe(e),"depthTexture",null),e}return ue(n,[{key:"addSystem",value:function(e){e._renderer=this;for(var t,i=e.getRendererSettings(),r=0;r<this.batches.length;r++)if(n.equals(this.batches[r].settings,i))return this.batches[r].addSystem(e),void this.systemToBatchIndex.set(e,r);switch(i.renderMode){case $t.Trail:t=new dn(i);break;case $t.Mesh:case $t.BillBoard:case $t.VerticalBillBoard:case $t.HorizontalBillBoard:case $t.StretchedBillBoard:t=new cn(i)}this.depthTexture&&t.applyDepthTexture(this.depthTexture),t.addSystem(e),this.batches.push(t),this.systemToBatchIndex.set(e,this.batches.length-1),this.add(t)}},{key:"deleteSystem",value:function(e){var t=this.systemToBatchIndex.get(e);null!=t&&(this.batches[t].removeSystem(e),this.systemToBatchIndex.delete(e))}},{key:"setDepthTexture",value:function(e){this.depthTexture=e;var t,n=Se(this.batches);try{for(n.s();!(t=n.n()).done;){t.value.applyDepthTexture(e)}}catch(i){n.e(i)}finally{n.f()}}},{key:"updateSystem",value:function(e){this.deleteSystem(e),this.addSystem(e)}},{key:"update",value:function(e){this.systemToBatchIndex.forEach((function(t,n){n.update(e)}));for(var t=0;t<this.batches.length;t++)this.batches[t].update()}}],[{key:"equals",value:function(e,t){return e.material.side===t.material.side&&e.material.blending===t.material.blending&&e.material.transparent===t.material.transparent&&e.material.type===t.material.type&&e.material.alphaTest===t.material.alphaTest&&e.material.map===t.material.map&&e.renderMode===t.renderMode&&e.blendTiles===t.blendTiles&&e.softParticles===t.softParticles&&e.softFarFade===t.softFarFade&&e.softNearFade===t.softNearFade&&e.uTileCount===t.uTileCount&&e.vTileCount===t.vTileCount&&e.instancingGeometry===t.instancingGeometry&&e.renderOrder===t.renderOrder&&e.layers.mask===t.layers.mask}}]),n}(),fn=hn;function pn(){return(pn=ae(ne().mark((function e(){var t,n,i;return ne().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,null===(t=navigator.gpu)||void 0===t?void 0:t.requestAdapter();case 2:if(n=e.sent){e.next=5;break}throw"need a browser that supports WebGPU";case 5:return e.next=7,null==n?void 0:n.requestDevice();case 7:if(i=e.sent){e.next=10;break}throw"need a browser that supports WebGPU";case 10:return e.abrupt("return",{adapter:n,device:i});case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var mn=function(){function e(t,n,i,r,a){var o=this,s=arguments.length>5&&void 0!==arguments[5]&&arguments[5],u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"";oe(this,e),le(this,"numLiveParticles",0),le(this,"simulationUBOBuffer",void 0),le(this,"simulationParams",void 0),le(this,"particlesBuffer",void 0),le(this,"particleIndexBuffer",void 0),le(this,"computeBindGroup",void 0),le(this,"computePipeline",void 0),le(this,"context",void 0),le(this,"mvp",new c),le(this,"uniformBuffer",void 0),le(this,"quadVertexBuffer",void 0),le(this,"renderBindGroup",void 0),le(this,"renderPassDescriptor",void 0),le(this,"renderPipeline",void 0),le(this,"cpuReadableBuffer",void 0),le(this,"frame",function(){var e=ae(ne().mark((function e(t){var n,i,r,a;return ne().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o.deviceContext.device.queue.writeBuffer(o.simulationUBOBuffer,0,new Float32Array([o.simulationParams.simulate?o.simulationParams.deltaTime:0,0,0,0,100*Math.random(),100*Math.random(),1+Math.random(),1+Math.random()])),o.mvp.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),o.deviceContext.device.queue.writeBuffer(o.uniformBuffer,0,new Float32Array([t.matrixWorldInverse.elements[0],t.matrixWorldInverse.elements[1],t.matrixWorldInverse.elements[2],t.matrixWorldInverse.elements[3],t.matrixWorldInverse.elements[4],t.matrixWorldInverse.elements[5],t.matrixWorldInverse.elements[6],t.matrixWorldInverse.elements[7],t.matrixWorldInverse.elements[8],t.matrixWorldInverse.elements[9],t.matrixWorldInverse.elements[10],t.matrixWorldInverse.elements[11],t.matrixWorldInverse.elements[12],t.matrixWorldInverse.elements[13],t.matrixWorldInverse.elements[14],t.matrixWorldInverse.elements[15],t.projectionMatrix.elements[0],t.projectionMatrix.elements[1],t.projectionMatrix.elements[2],t.projectionMatrix.elements[3],t.projectionMatrix.elements[4],t.projectionMatrix.elements[5],t.projectionMatrix.elements[6],t.projectionMatrix.elements[7],t.projectionMatrix.elements[8],t.projectionMatrix.elements[9],t.projectionMatrix.elements[10],t.projectionMatrix.elements[11],t.projectionMatrix.elements[12],t.projectionMatrix.elements[13],t.projectionMatrix.elements[14],t.projectionMatrix.elements[15]])),n=o.context.getCurrentTexture(),o.renderPassDescriptor.colorAttachments[0].view=n.createView(),i=o.deviceContext.device.createCommandEncoder(),(r=i.beginComputePass()).setPipeline(o.computePipeline),r.setBindGroup(0,o.computeBindGroup),r.dispatchWorkgroups(Math.ceil(o.numParticles/64)),r.end(),(a=i.beginRenderPass(o.renderPassDescriptor)).setPipeline(o.renderPipeline),a.setBindGroup(0,o.renderBindGroup),a.setVertexBuffer(0,o.quadVertexBuffer),a.draw(6,o.numLiveParticles,0,0),a.end(),o.debug&&i.copyBufferToBuffer(o.particlesBuffer,0,o.cpuReadableBuffer,0,o.numParticles*o.particleInstanceByteSize),o.deviceContext.device.queue.submit([i.finish()]);case 19:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),this.deviceContext=t,this.canvas=n,this.numParticles=i,this.particleInstanceByteSize=r,this.debug=s,this.renderCode=u,this.initBuffers(),this.initRenderPipeline(),this.initSimulationPipeline(a)}return ue(e,[{key:"initBuffers",value:function(){this.numLiveParticles=this.numParticles,this.particlesBuffer=this.deviceContext.device.createBuffer({size:this.numParticles*this.particleInstanceByteSize,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),this.particleIndexBuffer=this.deviceContext.device.createBuffer({size:4*this.numParticles,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.debug&&(this.cpuReadableBuffer=this.deviceContext.device.createBuffer({size:this.numParticles*this.particleInstanceByteSize,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}));for(var e=new Uint32Array(this.numParticles),t=0;t<this.numParticles;t++)e[t]=t;this.debug&&console.log(e),this.deviceContext.device.queue.writeBuffer(this.particleIndexBuffer,0,e)}},{key:"initRenderPipeline",value:function(){var e=window.devicePixelRatio;this.canvas.width=this.canvas.clientWidth*e,this.canvas.height=this.canvas.clientHeight*e,this.context=this.canvas.getContext("webgpu");var t=navigator.gpu.getPreferredCanvasFormat();this.context.configure({device:this.deviceContext.device,format:t,alphaMode:"premultiplied"});var n=this.deviceContext.device.createShaderModule({code:""===this.renderCode?"\n////////////////////////////////////////////////////////////////////////////////\n// Vertex shader\n////////////////////////////////////////////////////////////////////////////////\nstruct RenderParams {\n  modelViewProjectionMatrix : mat4x4f,\n  right : vec3<f32>,\n  up : vec3<f32>\n}\n\nstruct Particle {\n    color: vec4<f32>,\n    position: vec3<f32>,\n    velocity: vec3<f32>,\n    life: f32,\n    age: f32,\n}\n\n@group(0) @binding(0) var<uniform> render_params : RenderParams;\n@group(0) @binding(1) var<storage, read> particles: array<Particle>;\n@group(0) @binding(2) var<storage, read> particleIndices: array<u32>;\n\nstruct VertexInput {\n  /*@location(0) position : vec3f,\n  @location(1) color : vec4f,*/\n  @location(0) quad_pos : vec2f, // -1..+1\n  @builtin(instance_index) instanceIndex: u32,\n}\n\nstruct VertexOutput {\n  @builtin(position) position : vec4f,\n  @location(0) color : vec4f,\n  @location(1) quad_pos : vec2f, // -1..+1\n}\n\n@vertex\nfn vs_main(in : VertexInput) -> VertexOutput {\n  var quad_pos = mat2x3f(render_params.right, render_params.up) * in.quad_pos;\n  \n  var particle = particles[particleIndices[in.instanceIndex]];\n  var position = particle.position + quad_pos * 0.01;\n  var out : VertexOutput;\n  out.position = render_params.modelViewProjectionMatrix * vec4f(position, 1.0);\n  out.color = particle.color;\n  out.quad_pos = in.quad_pos;\n  return out;\n}\n\n////////////////////////////////////////////////////////////////////////////////\n// Fragment shader\n////////////////////////////////////////////////////////////////////////////////\n@fragment\nfn fs_main(in : VertexOutput) -> @location(0) vec4f {\n  var color = vec4<f32>(1.0, 0.0, 0.0, 1.0); //in.color;\n  // Apply a circular particle alpha mask\n  color.a = color.a * max(1.0 - length(in.quad_pos), 0.0);\n  return color;\n}\n\n":this.renderCode});this.renderPipeline=this.deviceContext.device.createRenderPipeline({layout:"auto",vertex:{module:n,entryPoint:"vs_main",buffers:[{arrayStride:8,stepMode:"vertex",attributes:[{shaderLocation:0,offset:0,format:"float32x2"}]}]},fragment:{module:n,entryPoint:"fs_main",targets:[{format:t,blend:{color:{srcFactor:"src-alpha",dstFactor:"one",operation:"add"},alpha:{srcFactor:"zero",dstFactor:"one",operation:"add"}}}]},primitive:{topology:"triangle-list"},depthStencil:{depthWriteEnabled:!1,depthCompare:"less",format:"depth24plus"}});var i=this.deviceContext.device.createTexture({size:[this.canvas.width,this.canvas.height],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT});this.uniformBuffer=this.deviceContext.device.createBuffer({size:128,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.renderBindGroup=this.deviceContext.device.createBindGroup({layout:this.renderPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.uniformBuffer}},{binding:1,resource:{buffer:this.particlesBuffer}},{binding:2,resource:{buffer:this.particleIndexBuffer}}]}),this.renderPassDescriptor={colorAttachments:[{view:void 0,clearValue:[0,0,0,1],loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:i.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}},this.quadVertexBuffer=this.deviceContext.device.createBuffer({size:48,usage:GPUBufferUsage.VERTEX,mappedAtCreation:!0});new Float32Array(this.quadVertexBuffer.getMappedRange()).set([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),this.quadVertexBuffer.unmap()}},{key:"initSimulationPipeline",value:function(e){this.simulationUBOBuffer=this.deviceContext.device.createBuffer({size:32,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.simulationParams={simulate:!0,deltaTime:.01},this.computePipeline=this.deviceContext.device.createComputePipeline({layout:"auto",compute:{module:this.deviceContext.device.createShaderModule({code:e}),entryPoint:"simulate"}}),this.computeBindGroup=this.deviceContext.device.createBindGroup({layout:this.computePipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.simulationUBOBuffer}},{binding:1,resource:{buffer:this.particlesBuffer,offset:0,size:this.numParticles*this.particleInstanceByteSize}},{binding:2,resource:{buffer:this.particleIndexBuffer,offset:0,size:4*this.numParticles}}]})}}]),e}(),vn=function(e){ce(n,$);var t=pe(n);function n(e){return oe(this,n),t.call(this,e)}return ue(n,[{key:"linkReference",value:function(e){var t={};e.traverse((function(e){t[e.uuid]=e})),e.traverse((function(e){if("ParticleEmitter"===e.type){var n=e.system;n.emitterShape;for(var i=0;i<n.behaviors.length;i++)n.behaviors[i]instanceof pt&&(n.behaviors[i].subParticleSystem=t[n.behaviors[i].subParticleSystem])}}))}},{key:"parse",value:function(e,t){var i=me(de(n.prototype),"parse",this).call(this,e,t);return this.linkReference(i),i}},{key:"parseObject",value:function(e,t,n,i,r){var o,s,u;function l(e){return void 0===t[e]&&console.warn("THREE.ObjectLoader: Undefined geometry",e),t[e]}function c(e){if(void 0!==e){if(Array.isArray(e)){for(var t=[],i=0,r=e.length;i<r;i++){var a=e[i];void 0===n[a]&&console.warn("THREE.ObjectLoader: Undefined material",a),t.push(n[a])}return t}return void 0===n[e]&&console.warn("THREE.ObjectLoader: Undefined material",e),n[e]}}function d(e){return void 0===i[e]&&console.warn("THREE.ObjectLoader: Undefined texture",e),i[e]}var f={textures:i,geometries:t,materials:n};switch(e.type){case"ParticleEmitter":o=sn.fromJSON(e.ps,f,{}).emitter;break;case"Scene":o=new Z,void 0!==e.background&&(Number.isInteger(e.background)?o.background=new M(e.background):o.background=d(e.background)),void 0!==e.environment&&(o.environment=d(e.environment)),void 0!==e.fog&&("Fog"===e.fog.type?o.fog=new Q(e.fog.color,e.fog.near,e.fog.far):"FogExp2"===e.fog.type&&(o.fog=new K(e.fog.color,e.fog.density)),""!==e.fog.name&&(o.fog.name=e.fog.name)),void 0!==e.backgroundBlurriness&&(o.backgroundBlurriness=e.backgroundBlurriness),void 0!==e.backgroundIntensity&&(o.backgroundIntensity=e.backgroundIntensity),void 0!==e.backgroundRotation&&o.backgroundRotation.fromArray(e.backgroundRotation),void 0!==e.environmentIntensity&&(o.environmentIntensity=e.environmentIntensity),void 0!==e.environmentRotation&&o.environmentRotation.fromArray(e.environmentRotation);break;case"PerspectiveCamera":o=new Y(e.fov,e.aspect,e.near,e.far),void 0!==e.focus&&(o.focus=e.focus),void 0!==e.zoom&&(o.zoom=e.zoom),void 0!==e.filmGauge&&(o.filmGauge=e.filmGauge),void 0!==e.filmOffset&&(o.filmOffset=e.filmOffset),void 0!==e.view&&(o.view=Object.assign({},e.view));break;case"OrthographicCamera":o=new H(e.left,e.right,e.top,e.bottom,e.near,e.far),void 0!==e.zoom&&(o.zoom=e.zoom),void 0!==e.view&&(o.view=Object.assign({},e.view));break;case"AmbientLight":o=new W(e.color,e.intensity);break;case"DirectionalLight":o=new X(e.color,e.intensity);break;case"PointLight":o=new j(e.color,e.intensity,e.distance,e.decay);break;case"RectAreaLight":o=new q(e.color,e.intensity,e.width,e.height);break;case"SpotLight":o=new G(e.color,e.intensity,e.distance,e.angle,e.penumbra,e.decay);break;case"HemisphereLight":o=new D(e.color,e.groundColor,e.intensity);break;case"LightProbe":o=(new J).fromJSON(e);break;case"SkinnedMesh":s=l(e.geometry),u=c(e.material),o=new F(s,u),void 0!==e.bindMode&&(o.bindMode=e.bindMode),void 0!==e.bindMatrix&&o.bindMatrix.fromArray(e.bindMatrix),void 0!==e.skeleton&&(o.skeleton=e.skeleton);break;case"Mesh":s=l(e.geometry),u=c(e.material),o=new h(s,u);break;case"InstancedMesh":s=l(e.geometry),u=c(e.material);var p=e.count,m=e.instanceMatrix,v=e.instanceColor;(o=new L(s,u,p)).instanceMatrix=new g(new Float32Array(m.array),16),void 0!==v&&(o.instanceColor=new g(new Float32Array(v.array),v.itemSize));break;case"BatchedMesh":s=l(e.geometry),u=c(e.material),(o=new z(e.maxGeometryCount,e.maxVertexCount,e.maxIndexCount,u)).geometry=s,o.perObjectFrustumCulled=e.perObjectFrustumCulled,o.sortObjects=e.sortObjects,o._drawRanges=e.drawRanges,o._reservedRanges=e.reservedRanges,o._visibility=e.visibility,o._active=e.active,o._bounds=e.bounds.map((function(e){var t=new R;t.min.fromArray(e.boxMin),t.max.fromArray(e.boxMax);var n=new I;return n.radius=e.sphereRadius,n.center.fromArray(e.sphereCenter),{boxInitialized:e.boxInitialized,box:t,sphereInitialized:e.sphereInitialized,sphere:n}})),o._maxGeometryCount=e.maxGeometryCount,o._maxVertexCount=e.maxVertexCount,o._maxIndexCount=e.maxIndexCount,o._geometryInitialized=e.geometryInitialized,o._geometryCount=e.geometryCount,o._matricesTexture=d(e.matricesTexture.uuid);break;case"LOD":o=new C;break;case"Line":o=new V(l(e.geometry),c(e.material));break;case"LineLoop":o=new U(l(e.geometry),c(e.material));break;case"LineSegments":o=new A(l(e.geometry),c(e.material));break;case"PointCloud":case"Points":o=new B(l(e.geometry),c(e.material));break;case"Sprite":o=new P(c(e.material));break;case"Group":o=new E;break;case"Bone":o=new T;break;default:o=new a}if(o.uuid=e.uuid,void 0!==e.name&&(o.name=e.name),void 0!==e.matrix?(o.matrix.fromArray(e.matrix),void 0!==e.matrixAutoUpdate&&(o.matrixAutoUpdate=e.matrixAutoUpdate),o.matrixAutoUpdate&&(o.matrix.decompose(o.position,o.quaternion,o.scale),isNaN(o.quaternion.x)&&o.quaternion.set(0,0,0,1))):(void 0!==e.position&&o.position.fromArray(e.position),void 0!==e.rotation&&o.rotation.fromArray(e.rotation),void 0!==e.quaternion&&o.quaternion.fromArray(e.quaternion),void 0!==e.scale&&o.scale.fromArray(e.scale)),void 0!==e.up&&o.up.fromArray(e.up),void 0!==e.castShadow&&(o.castShadow=e.castShadow),void 0!==e.receiveShadow&&(o.receiveShadow=e.receiveShadow),e.shadow&&(void 0!==e.shadow.bias&&(o.shadow.bias=e.shadow.bias),void 0!==e.shadow.normalBias&&(o.normalBias=e.shadow.normalBias),void 0!==e.shadow.radius&&(o.radius=e.shadow.radius),void 0!==e.shadow.mapSize&&o.mapSize.fromArray(e.shadow.mapSize),void 0!==e.shadow.camera&&(o.camera=this.parseObject(e.shadow.camera))),void 0!==e.visible&&(o.visible=e.visible),void 0!==e.frustumCulled&&(o.frustumCulled=e.frustumCulled),void 0!==e.renderOrder&&(o.renderOrder=e.renderOrder),void 0!==e.userData&&(o.userData=e.userData),void 0!==e.layers&&(o.layers.mask=e.layers),void 0!==e.children)for(var y=e.children,S=0;S<y.length;S++)o.add(this.parseObject(y[S],t,n,i,r));if(void 0!==e.animations)for(var x=e.animations,w=0;w<x.length;w++){var b=x[w];o.animations.push(r[b])}if("LOD"===e.type){void 0!==e.autoUpdate&&(o.autoUpdate=e.autoUpdate);for(var _=e.levels,N=0;N<_.length;N++){var k=_[N],O=o.getObjectByProperty("uuid",k.object);void 0!==O&&o.addLevel(O,k.distance)}}return o}}]),n}(),yn=[];var gn=function(e){return e[e.Number=0]="Number",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Boolean=4]="Boolean",e[e.AnyType=5]="AnyType",e[e.NullableAnyType=6]="NullableAnyType",e[e.EventStream=7]="EventStream",e}({}),Sn=function(e){switch(e){case gn.Boolean:case gn.Number:return 4;case gn.Vec2:return 8;case gn.Vec3:case gn.Vec4:return 16;case gn.AnyType:case gn.NullableAnyType:default:return 0}},xn=function(e){switch(e){case gn.Boolean:return 1;case gn.Number:return 4;case gn.Vec2:return 8;case gn.Vec3:return 12;case gn.Vec4:return 16;case gn.AnyType:case gn.NullableAnyType:default:return 0}},wn=function(n){switch(n){case gn.Boolean:return!1;case gn.Number:return 0;case gn.Vec2:return new i;case gn.Vec3:return new e;case gn.Vec4:return new t;case gn.AnyType:return 0;case gn.NullableAnyType:return}},bn=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};oe(this,e),le(this,"id",void 0),le(this,"inputs",[]),le(this,"outputs",[]),le(this,"definition",void 0),le(this,"signatureIndex",-1),le(this,"data",void 0),le(this,"position",new i),le(this,"outputValues",[]),this.id=""+Math.round(1e5*Math.random()),this.definition=t,this.signatureIndex=n,this.data=r;for(var a=-1===n?0:n,o=0;o<t.nodeTypeSignatures[a].inputTypes.length;o++)this.inputs.push(void 0);for(var s=0;s<t.nodeTypeSignatures[a].outputTypes.length;s++)this.outputs.push([])}return ue(e,[{key:"inputTypes",get:function(){var e=-1===this.signatureIndex?0:this.signatureIndex;return this.definition.nodeTypeSignatures[e].inputTypes}},{key:"outputTypes",get:function(){var e=-1===this.signatureIndex?0:this.signatureIndex;return this.definition.nodeTypeSignatures[e].outputTypes}},{key:"func",value:function(e,t,n){var i=-1===this.signatureIndex?0:this.signatureIndex;this.definition.nodeTypeSignatures[i].func(e,this.data,t,n)}}]),e}(),Mn=ue((function e(t,n,i,r){oe(this,e),le(this,"input",void 0),le(this,"inputIndex",void 0),le(this,"output",void 0),le(this,"outputIndex",void 0),this.input=t,this.inputIndex=n,this.input.outputs[n].push(this),this.output=i,this.outputIndex=r,this.output.inputs[r]=this})),_n=ue((function e(t,n,i,r){if(oe(this,e),le(this,"node",void 0),le(this,"isInput",void 0),le(this,"paramIndex",void 0),le(this,"type",void 0),le(this,"inputs",void 0),le(this,"outputs",void 0),this.type=t,this.node=i,this.isInput=n,this.paramIndex=r,n)switch(t){case gn.Vec2:this.inputs=[void 0,void 0],this.outputs=[];break;case gn.Vec3:this.inputs=[void 0,void 0,void 0],this.outputs=[];break;case gn.Vec4:this.inputs=[void 0,void 0,void 0,void 0],this.outputs=[];break;default:this.inputs=[void 0],this.outputs=[]}else switch(t){case gn.Vec2:this.inputs=[],this.outputs=[[],[]];break;case gn.Vec3:this.inputs=[],this.outputs=[[],[],[]];break;case gn.Vec4:this.inputs=[],this.outputs=[[],[],[],[]];break;default:this.inputs=[],this.outputs=[[]]}})),Nn=function(){function e(){oe(this,e),le(this,"visited",new Set),le(this,"debug",!1),e.Instance=this}return ue(e,[{key:"buildExecutionOrder",value:function(e,t){e.nodesInOrder.length=0,this.visited.clear();for(var n=0;n<e.outputNodes.length;n++){var i=e.outputNodes[n];void 0!==i.inputs[0]&&this._traverse(i,e,t)}e.compiled=!0}},{key:"_traverseWire",value:function(e,t,n){}},{key:"_traverse",value:function(e,t,n){this.visited.add(e.id);for(var i=0;i<e.inputs.length;i++)if(e.inputs[i]instanceof Mn){var r=e.inputs[i].input;r instanceof bn?this.visited.has(r.id)||this._traverse(r,t,n):r instanceof _n&&(r.isInput||this._traverse(r.node,t,n))}else if(e.inputs[i]instanceof _n)for(var a=e.inputs[i],o=0;o<a.inputs.length;o++){var s=a.inputs[o];void 0!==s&&(s.input instanceof bn?this.visited.has(s.input.id)||this._traverse(s.input,t,n):this.visited.has(s.input.node.id)||this._traverse(s.input.node,t,n))}t.nodesInOrder.push(e)}}]),e}();le(Nn,"Instance",void 0);var kn=function(e){ce(n,Nn);var t=pe(n);function n(){return oe(this,n),t.call(this)}return ue(n,[{key:"executeCompiledGraph",value:function(e,t){for(var n=e.nodesInOrder,i=0;i<n.length;i++){var r=[],a=n[i];this.debug&&console.log("Node:",a);for(var o=0;o<a.inputs.length;o++)a.inputs[o]instanceof Mn?a.inputs[o].input instanceof bn&&r.push(a.inputs[o].input.outputValues[a.inputs[o].inputIndex]):a.inputs[o]instanceof _n||(void 0!==a.inputs[o]?r.push(a.inputs[o].getValue(t)):r.push(void 0));if(0===a.outputValues.length)for(var s=a.signatureIndex<0?0:a.signatureIndex,u=0;u<a.definition.nodeTypeSignatures[s].outputTypes.length;u++)a.outputValues.push(wn(a.definition.nodeTypeSignatures[s].outputTypes[u])),void 0===a.outputValues[u]&&(a.outputValues[u]=wn(a.data.type));a.func(t,r,a.outputValues)}}},{key:"run",value:function(e,t){e.compiled||this.buildExecutionOrder(e,t),this.executeCompiledGraph(e,t)}},{key:"build",value:function(e,t){return""}}]),n}(),On=function(e){return e[e.Variable=0]="Variable",e[e.Expression=1]="Expression",e[e.Storage=2]="Storage",e[e.Function=3]="Function",e}({}),Tn=function(){function e(t,n){oe(this,e),le(this,"name",void 0),le(this,"type",void 0),le(this,"nodeTypeSignatures",[]),this.name=t,this.type=n}return ue(e,[{key:"addSignature",value:function(e,t,n){this.nodeTypeSignatures.push({inputTypes:e,outputTypes:t,func:n})}}]),e}(),En=function(e){ce(n,Tn);var t=pe(n);function n(e){var i;oe(this,n);for(var r=[],a=0;a<e.inputNodes.length;a++)"input"===e.inputNodes[a].definition.name&&r.push(e.inputNodes[a].data.type);for(var o=[],s=0;s<e.outputNodes.length;s++)"output"===e.outputNodes[s].definition.name&&o.push(e.outputNodes[s].data.type);return le(fe(i=t.call(this,e.name,On.Expression)),"nodeGraph",void 0),i.addSignature(r,o,(function(t,n,i,r){t.inputs=i,t.outputs=r,kn.Instance.run(e,t)})),i.nodeGraph=e,i}return ue(n)}(),Pn={},Bn=new Tn("add",On.Expression);Bn.addSignature([gn.Number,gn.Number],[gn.Number],(function(e,t,n,i){i[0]=n[0]+n[1]})),Bn.addSignature([gn.Vec2,gn.Vec2],[gn.Vec2],(function(e,t,n,i){i[0].addVectors(n[0],n[1])})),Bn.addSignature([gn.Vec3,gn.Vec3],[gn.Vec3],(function(e,t,n,i){i[0].addVectors(n[0],n[1])})),Bn.addSignature([gn.Vec4,gn.Vec4],[gn.Vec4],(function(e,t,n,i){i[0].addVectors(n[0],n[1])})),Pn.add=Bn;var An=new Tn("sub",On.Expression);An.addSignature([gn.Number,gn.Number],[gn.Number],(function(e,t,n,i){i[0]=n[0]-n[1]})),An.addSignature([gn.Vec2,gn.Vec2],[gn.Vec2],(function(e,t,n,i){i[0].subVectors(n[0],n[1])})),An.addSignature([gn.Vec3,gn.Vec3],[gn.Vec3],(function(e,t,n,i){i[0].subVectors(n[0],n[1])})),An.addSignature([gn.Vec4,gn.Vec4],[gn.Vec4],(function(e,t,n,i){i[0].subVectors(n[0],n[1])})),Pn.sub=An;var Un=new Tn("mul",On.Expression);Un.addSignature([gn.Number,gn.Number],[gn.Number],(function(e,t,n,i){i[0]=n[0]*n[1]})),Un.addSignature([gn.Vec2,gn.Number],[gn.Vec2],(function(e,t,n,i){i[0].copy(n[0]).multiplyScalar(n[1])})),Un.addSignature([gn.Vec3,gn.Number],[gn.Vec3],(function(e,t,n,i){i[0].copy(n[0]).multiplyScalar(n[1])})),Un.addSignature([gn.Vec4,gn.Number],[gn.Vec4],(function(e,t,n,i){i[0].copy(n[0]).multiplyScalar(n[1])})),Pn.mul=Un;var Vn=new Tn("div",On.Expression);Vn.addSignature([gn.Number,gn.Number],[gn.Number],(function(e,t,n,i){i[0]=n[0]/n[1]})),Vn.addSignature([gn.Vec2,gn.Number],[gn.Vec2],(function(e,t,n,i){i[0].copy(n[0]).divideScalar(n[1])})),Vn.addSignature([gn.Vec3,gn.Number],[gn.Vec3],(function(e,t,n,i){i[0].copy(n[0]).divideScalar(n[1])})),Vn.addSignature([gn.Vec4,gn.Number],[gn.Vec4],(function(e,t,n,i){i[0].copy(n[0]).divideScalar(n[1])})),Pn.div=Vn;var Cn=new Tn("sin",On.Expression);Cn.addSignature([gn.Number],[gn.Number],(function(e,t,n,i){i[0]=Math.sin(n[0])})),Pn.sin=Cn;var zn=new Tn("cos",On.Expression);zn.addSignature([gn.Number],[gn.Number],(function(e,t,n,i){i[0]=Math.cos(n[0])})),Pn.cos=zn;var Rn=new Tn("tan",On.Expression);Rn.addSignature([gn.Number],[gn.Number],(function(e,t,n,i){i[0]=Math.tan(n[0])})),Pn.tan=Rn;var In=new Tn("abs",On.Expression);In.addSignature([gn.Number],[gn.Number],(function(e,t,n,i){i[0]=Math.abs(n[0])})),Pn.abs=In;var Ln=new Tn("min",On.Expression);Ln.addSignature([gn.Number,gn.Number],[gn.Number],(function(e,t,n,i){i[0]=Math.min(n[0],n[1])})),Pn.min=Ln;var Fn=new Tn("max",On.Expression);Fn.addSignature([gn.Number,gn.Number],[gn.Number],(function(e,t,n,i){i[0]=Math.max(n[0],n[1])})),Pn.max=Fn;var Jn=new Tn("dot",On.Expression);Jn.addSignature([gn.Vec2,gn.Vec2],[gn.Number],(function(e,t,n,i){i[0]=n[0].dot(n[1])})),Jn.addSignature([gn.Vec3,gn.Vec3],[gn.Number],(function(e,t,n,i){i[0]=n[0].dot(n[1])})),Jn.addSignature([gn.Vec4,gn.Vec4],[gn.Number],(function(e,t,n,i){i[0]=n[0].dot(n[1])})),Pn.dot=Jn;var Dn=new Tn("cross",On.Expression);Dn.addSignature([gn.Vec3,gn.Vec3],[gn.Vec3],(function(e,t,n,i){i[0].crossVectors(n[0],n[1])})),Pn.cross=Dn;var Gn=new Tn("length",On.Expression);Gn.addSignature([gn.Vec2],[gn.Number],(function(e,t,n,i){i[0]=n[0].length()})),Gn.addSignature([gn.Vec3],[gn.Number],(function(e,t,n,i){i[0]=n[0].length()})),Gn.addSignature([gn.Vec4],[gn.Number],(function(e,t,n,i){i[0]=n[0].length()})),Pn.length=Gn;var qn=new Tn("lengthSq",On.Expression);qn.addSignature([gn.Vec2],[gn.Number],(function(e,t,n,i){i[0]=n[0].lengthSq()})),qn.addSignature([gn.Vec3],[gn.Number],(function(e,t,n,i){i[0]=n[0].lengthSq()})),qn.addSignature([gn.Vec4],[gn.Number],(function(e,t,n,i){i[0]=n[0].lengthSq()})),Pn.lengthSq=qn;var jn=new Tn("normalize",On.Expression);jn.addSignature([gn.Vec2],[gn.Vec2],(function(e,t,n,i){i[0].copy(n[0]).normalize()})),jn.addSignature([gn.Vec3],[gn.Vec3],(function(e,t,n,i){i[0].copy(n[0]).normalize()})),jn.addSignature([gn.Vec4],[gn.Vec4],(function(e,t,n,i){i[0].copy(n[0]).normalize()})),Pn.normalize=jn;var Xn=new Tn("distance",On.Expression);Xn.addSignature([gn.Vec2,gn.Vec2],[gn.Number],(function(e,t,n,i){i[0]=n[0].distanceTo(n[1])})),Xn.addSignature([gn.Vec3,gn.Vec3],[gn.Number],(function(e,t,n,i){i[0]=n[0].distanceTo(n[1])})),Pn.distance=Xn;var Wn=new Tn("and",On.Expression);Wn.addSignature([gn.Boolean,gn.Boolean],[gn.Boolean],(function(e,t,n,i){i[0]=n[0]&&n[1]})),Pn.and=Wn;var Hn=new Tn("or",On.Expression);Hn.addSignature([gn.Boolean,gn.Boolean],[gn.Boolean],(function(e,t,n,i){i[0]=n[0]||n[1]})),Pn.or=Hn;var Yn=new Tn("not",On.Expression);Yn.addSignature([gn.Boolean],[gn.Boolean],(function(e,t,n,i){i[0]=!n[0]})),Pn.not=Yn;var Zn=new Tn("equal",On.Expression);Zn.addSignature([gn.Number,gn.Number],[gn.Boolean],(function(e,t,n,i){i[0]=n[0]===n[1]})),Zn.addSignature([gn.Vec2,gn.Vec2],[gn.Boolean],(function(e,t,n,i){i[0]=n[0].equals(n[1])})),Zn.addSignature([gn.Vec3,gn.Vec3],[gn.Boolean],(function(e,t,n,i){i[0]=n[0].equals(n[1])})),Zn.addSignature([gn.Vec4,gn.Vec4],[gn.Boolean],(function(e,t,n,i){i[0]=n[0].equals(n[1])})),Pn.equal=Zn;var Qn=new Tn("lessThan",On.Expression);Qn.addSignature([gn.Number,gn.Number],[gn.Boolean],(function(e,t,n,i){i[0]=n[0]<n[1]})),Pn.lessThan=Qn;var Kn=new Tn("greaterThan",On.Expression);Kn.addSignature([gn.Number,gn.Number],[gn.Boolean],(function(e,t,n,i){i[0]=n[0]>n[1]})),Pn.greaterThan=Kn;var $n=new Tn("lessThanOrEqual",On.Expression);$n.addSignature([gn.Number,gn.Number],[gn.Boolean],(function(e,t,n,i){i[0]=n[0]<=n[1]})),Pn.lessThanOrEqual=$n;var ei=new Tn("greaterThanOrEqual",On.Expression);ei.addSignature([gn.Number,gn.Number],[gn.Boolean],(function(e,t,n,i){i[0]=n[0]>=n[1]})),Pn.greaterThanOrEqual=ei;var ti=new Tn("if",On.Expression);ti.addSignature([gn.Boolean,gn.AnyType,gn.AnyType],[gn.AnyType],(function(e,t,n,i){i[0]=n[0]?n[1]:n[2]})),Pn.if=ti;var ni=new Tn("number",On.Expression);ni.addSignature([],[gn.Number],(function(e,t,n,i){i[0]=t.value})),Pn.number=ni;var ii=new Tn("vec2",On.Expression);ii.addSignature([gn.Number,gn.Number],[gn.Vec2],(function(e,t,n,i){i[0].x=n[0],i[0].y=n[1]})),Pn.vec2=ii;var ri=new Tn("vec3",On.Expression);ri.addSignature([gn.Number,gn.Number,gn.Number],[gn.Vec3],(function(e,t,n,i){i[0].x=n[0],i[0].y=n[1],i[0].z=n[2]})),Pn.vec3=ri;var ai=new Tn("vec4",On.Expression);ai.addSignature([gn.Number,gn.Number,gn.Number,gn.Number],[gn.Vec4],(function(e,t,n,i){i[0].x=n[0],i[0].y=n[1],i[0].z=n[2],i[0].w=n[3]})),Pn.vec4=ai;var oi=new Tn("bool",On.Expression);oi.addSignature([],[gn.Boolean],(function(e,t,n,i){i[0]=t.value})),Pn.bool=oi;var si=new Tn("particleProperty",On.Storage);si.addSignature([gn.NullableAnyType],[gn.NullableAnyType],(function(e,t,n,i){void 0!==n[0]&&(t.type!==gn.Number?e.particle[t.property].copy(n[0]):e.particle[t.property]=n[0]),void 0!==e.particle[t.property]&&(t.type!==gn.Number?i[0].copy(e.particle[t.property]):i[0]=e.particle[t.property])})),Pn.particleProperty=si;var ui=new Tn("emit",On.Function);ui.addSignature([gn.EventStream],[],(function(e,t,n,i){for(var r=n[0],a=0;a<r.length;a++)e.signal(a,r[a])})),Pn.emit=ui;var li=new Tn("graphProperty",On.Storage);li.addSignature([gn.NullableAnyType],[gn.NullableAnyType],(function(e,t,n,i){void 0!==n[0]&&(t.type!==gn.Number?e.graph[t.property].copy(n[0]):e.graph[t.property]=n[0]),void 0!==e.graph[t.property]&&(t.type!==gn.Number?i[0].copy(e.graph[t.property]):i[0]=e.graph[t.property])})),Pn.graphProperty=li;var ci=new Tn("startEvent",On.Expression);ci.addSignature([],[gn.EventStream],(function(e,t,n,i){i[0]=[{type:"start"}]})),Pn.startEvent=ci;var di=new Tn("repeater",On.Expression);di.addSignature([gn.EventStream,gn.Number],[gn.EventStream],(function(e,t,n,i){for(var r=n[0],a=n[1],o=[],s=0;s<r.length;s++)for(var u=0;u<a;u++)o.push(r[s]);i[0]=o})),Pn.repeater=di;var hi=new Tn("time",On.Expression);hi.addSignature([],[gn.Number],(function(e,t,n,i){i[0]=e.emissionState.time})),Pn.time=hi;var fi=new Tn("delta",On.Expression);fi.addSignature([],[gn.Number],(function(e,t,n,i){i[0]=e.delta})),Pn.delta=fi;var pi=new Tn("output",On.Storage);pi.addSignature([gn.Number],[gn.Number],(function(e,t,n,i){i[0]=n[0]})),pi.addSignature([gn.Vec2],[gn.Vec2],(function(e,t,n,i){i[0]=n[0]})),pi.addSignature([gn.Vec3],[gn.Vec3],(function(e,t,n,i){i[0]=n[0]})),pi.addSignature([gn.Vec4],[gn.Vec4],(function(e,t,n,i){i[0]=n[0]})),pi.addSignature([gn.Boolean],[gn.Boolean],(function(e,t,n,i){i[0]=n[0]})),Pn.output=pi;var mi=new Tn("lerp",On.Expression);mi.addSignature([gn.Number,gn.Number,gn.Number],[gn.Number],(function(e,t,n,i){i[0]=n[0]*(1-n[2])+n[1]*n[2]})),mi.addSignature([gn.Vec2,gn.Vec2,gn.Number],[gn.Vec2],(function(e,t,n,i){i[0].lerpVectors(n[0],n[1],n[2])})),mi.addSignature([gn.Vec3,gn.Vec3,gn.Number],[gn.Vec3],(function(e,t,n,i){i[0].lerpVectors(n[0],n[1],n[2])})),mi.addSignature([gn.Vec4,gn.Vec4,gn.Number],[gn.Vec4],(function(e,t,n,i){i[0].lerpVectors(n[0],n[1],n[2])})),Pn.lerp=mi;var vi=new Tn("normDistrib",On.Expression);vi.addSignature([gn.Number],[gn.Number],(function(e,t,n,i){var r;i[0]=(r=n[0],1/Math.sqrt(2*Math.PI)*Math.exp(r*r*-.5))})),Pn.normDistrib=vi;var yi=new Tn("normcdf",On.Expression);yi.addSignature([gn.Number],[gn.Number],(function(e,t,n,i){var r=n[0],a=1;r<0&&(a=-1);var o=1/(1+.3275911*(r=Math.abs(r)/Math.sqrt(2))),s=1-((((1.061405429*o-1.453152027)*o+1.421413741)*o-.284496736)*o+.254829592)*o*Math.exp(-r*r);i[0]=.5*(1+a*s)})),Pn.normcdf=yi;var gi=new Tn("normcdfInv",On.Expression),Si=function(e){var t=[2.515517,.802853,.010328],n=[1.432788,.189269,.001308];return e-((t[2]*e+t[1])*e+t[0])/(((n[2]*e+n[1])*e+n[0])*e+1)},xi=function(e){return e<.5?-Si(Math.sqrt(-2*Math.log(e))):Si(Math.sqrt(-2*Math.log(1-e)))};gi.addSignature([gn.Number],[gn.Number],(function(e,t,n,i){i[0]=xi(n[0])})),Pn.normcdfInv=gi;var wi=new Tn("clamp",On.Expression);wi.addSignature([gn.Number,gn.Number,gn.Number],[gn.Number],(function(e,t,n,i){i[0]=Math.max(Math.min(n[0],n[2]),n[1])})),Pn.clamp=wi;var bi=new Tn("smoothstep",On.Expression);bi.addSignature([gn.Number,gn.Number,gn.Number],[gn.Number],(function(e,t,n,i){var r=Math.max(Math.min(n[0],n[2]),n[1]);i[0]=r*r*(3-2*r)})),Pn.smoothstep=bi;var Mi=new Tn("random",On.Expression);Mi.addSignature([gn.Number,gn.Number],[gn.Number],(function(e,t,n,i){i[0]=Math.random()*(n[1]-n[0])+n[0]})),Mi.addSignature([gn.Vec2,gn.Vec2],[gn.Vec2],(function(e,t,n,i){var r=Math.random();i[0].lerpVectors(n[0],n[1],r)})),Mi.addSignature([gn.Vec3,gn.Vec3],[gn.Vec3],(function(e,t,n,i){var r=Math.random();i[0].lerpVectors(n[0],n[1],r)})),Mi.addSignature([gn.Vec4,gn.Vec4],[gn.Vec4],(function(e,t,n,i){var r=Math.random();i[0].lerpVectors(n[0],n[1],r)})),Pn.random=Mi;var _i=new Tn("vrand",On.Expression);_i.addSignature([],[gn.Vec2],(function(e,t,n,i){var r=xi(Math.random()),a=xi(Math.random()),o=Math.sqrt(r*r+a*a);i[0].set(r/o,a/o)})),_i.addSignature([],[gn.Vec3],(function(e,t,n,i){var r=xi(Math.random()),a=xi(Math.random()),o=xi(Math.random()),s=Math.sqrt(r*r+a*a+o*o);i[0].set(r/s,a/s,o/s)})),_i.addSignature([],[gn.Vec4],(function(e,t,n,i){var r=xi(Math.random()),a=xi(Math.random()),o=xi(Math.random()),s=xi(Math.random()),u=Math.sqrt(r*r+a*a+o*o+s*s);i[0].set(r/u,a/u,o/u,s/u)})),Pn.vrand=_i;var Ni=new Tn("bsdf",On.Storage);Ni.addSignature([gn.Vec3,gn.Vec3,gn.Vec3,gn.Number],[],(function(e,t,n,i){})),Pn.bsdf=Ni;var ki=new Set(["output","particleProperty","graphProperty","emit"]),Oi=function(){function e(t){oe(this,e),le(this,"uuid",void 0),le(this,"name",void 0),le(this,"version",void 0),le(this,"revision",void 0),le(this,"inputNodes",[]),le(this,"outputNodes",[]),le(this,"allNodes",new Map),le(this,"wires",[]),le(this,"compiled",!1),le(this,"nodesInOrder",[]),this.version="1.0",this.uuid=o.generateUUID(),this.name=t,this.revision=0}return ue(e,[{key:"addWire",value:function(e){this.wires.push(e),this.revision++}},{key:"addNode",value:function(e){this.allNodes.set(e.id,e),e.definition===Pn.input?this.inputNodes.push(e):ki.has(e.definition.name)&&this.outputNodes.push(e),this.revision++}},{key:"getNode",value:function(e){return this.allNodes.get(e)}},{key:"deleteNode",value:function(e){this.allNodes.delete(e.id),this.revision++}},{key:"deleteWire",value:function(e){var t=e.input.outputs[e.inputIndex].indexOf(e);-1!==t&&e.input.outputs[e.inputIndex].splice(t,1),e.output.inputs[e.outputIndex]=void 0,-1!=(t=this.wires.indexOf(e))&&(this.wires[t]=this.wires[this.wires.length-1],this.wires.pop()),this.revision++}},{key:"toJSON",value:function(){throw new Error("not implemented")}},{key:"clone",value:function(){throw new Error("not implemented")}}]),e}();new e(0,0,1);var Ti=new u,Ei=new e,Pi=new e,Bi=new n(1,1,1,1),Ai=function(){function t(n){var i,r,a,o,s,u,l;oe(this,t),le(this,"emissionGraph",void 0),le(this,"updateGraph",void 0),le(this,"interpreter",void 0),le(this,"autoDestroy",void 0),le(this,"prewarm",void 0),le(this,"looping",void 0),le(this,"duration",void 0),le(this,"particleNum",void 0),le(this,"paused",void 0),le(this,"particles",void 0),le(this,"emitter",void 0),le(this,"rendererSettings",void 0),le(this,"neededToUpdateRender",void 0),le(this,"rendererEmitterSettings",void 0),le(this,"worldSpace",void 0),le(this,"prewarmed",void 0),le(this,"emissionState",void 0),le(this,"emitEnded",void 0),le(this,"markForDestroy",void 0),le(this,"previousWorldPos",void 0),le(this,"temp",new e),le(this,"travelDistance",0),le(this,"normalMatrix",new f),le(this,"_renderer",void 0),le(this,"speedFactor",0),this.autoDestroy=void 0!==n.autoDestroy&&n.autoDestroy,this.duration=null!==(i=n.duration)&&void 0!==i?i:1,this.looping=void 0===n.looping||n.looping,this.prewarm=void 0!==n.prewarm&&n.prewarm,this.worldSpace=null!==(r=n.worldSpace)&&void 0!==r&&r,this.rendererEmitterSettings=null!==(a=n.rendererEmitterSettings)&&void 0!==a?a:{},this.emissionGraph=n.emissionGraph,this.updateGraph=n.updateGraph,this.interpreter=new kn,this.rendererSettings={instancingGeometry:null!==(o=n.instancingGeometry)&&void 0!==o?o:Bi,renderMode:null!==(s=n.renderMode)&&void 0!==s?s:$t.BillBoard,renderOrder:null!==(u=n.renderOrder)&&void 0!==u?u:0,material:n.material,layers:null!==(l=n.layers)&&void 0!==l?l:new p,uTileCount:1,vTileCount:1,blendTiles:!1,softParticles:!1,softNearFade:0,softFarFade:0},this.neededToUpdateRender=!0,this.particles=new Array,this.emitter=new we(this),this.paused=!1,this.particleNum=0,this.emissionState={time:0},this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}return ue(t,[{key:"time",get:function(){return this.emissionState.time},set:function(e){this.emissionState.time=e}},{key:"layers",get:function(){return this.rendererSettings.layers}},{key:"texture",get:function(){return this.rendererSettings.material.map},set:function(e){this.rendererSettings.material.map=e,this.neededToUpdateRender=!0}},{key:"material",get:function(){return this.rendererSettings.material},set:function(e){this.rendererSettings.material=e,this.neededToUpdateRender=!0}},{key:"instancingGeometry",get:function(){return this.rendererSettings.instancingGeometry},set:function(e){this.restart(),this.particles.length=0,this.rendererSettings.instancingGeometry=e,this.neededToUpdateRender=!0}},{key:"renderMode",get:function(){return this.rendererSettings.renderMode},set:function(e){if((this.rendererSettings.renderMode!=$t.Trail&&e===$t.Trail||this.rendererSettings.renderMode==$t.Trail&&e!==$t.Trail)&&(this.restart(),this.particles.length=0),this.rendererSettings.renderMode!==e)switch(e){case $t.Trail:this.rendererEmitterSettings={startLength:30,followLocalOrigin:!1};break;case $t.Mesh:this.rendererEmitterSettings={geometry:new n(1,1)};break;case $t.BillBoard:case $t.VerticalBillBoard:case $t.HorizontalBillBoard:case $t.StretchedBillBoard:this.rendererEmitterSettings={}}this.rendererSettings.renderMode=e,this.neededToUpdateRender=!0}},{key:"renderOrder",get:function(){return this.rendererSettings.renderOrder},set:function(e){this.rendererSettings.renderOrder=e,this.neededToUpdateRender=!0}},{key:"blending",get:function(){return this.rendererSettings.material.blending},set:function(e){this.rendererSettings.material.blending=e,this.neededToUpdateRender=!0}},{key:"pause",value:function(){this.paused=!0}},{key:"play",value:function(){this.paused=!1}},{key:"spawn",value:function(t,n){Ti.setFromRotationMatrix(n);var i=Ei,r=Ti,a=Pi;for(n.decompose(i,r,a),this.particleNum++;this.particles.length<this.particleNum;)this.particles.push(new _e);var o=this.particles[this.particleNum-1];if(o.reset(),this.interpreter.run(this.updateGraph,{particle:o,emissionState:this.emissionState}),this.rendererSettings.renderMode===$t.Trail&&this.rendererEmitterSettings.followLocalOrigin){var s=o;s.localPosition=(new e).copy(s.position)}this.worldSpace&&(o.position.applyMatrix4(n),o.size*=(Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z))/3,o.velocity.multiply(a).applyMatrix3(this.normalMatrix),o.rotation&&o.rotation instanceof u&&o.rotation.multiplyQuaternions(Ti,o.rotation))}},{key:"endEmit",value:function(){this.emitEnded=!0,this.autoDestroy&&(this.markForDestroy=!0)}},{key:"dispose",value:function(){this._renderer&&this._renderer.deleteSystem(this),this.emitter.dispose(),this.emitter.parent&&this.emitter.parent.remove(this.emitter)}},{key:"restart",value:function(){this.paused=!1,this.particleNum=0,this.emissionState.time=0,this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}},{key:"update",value:function(e){if(!this.paused){for(var t=this.emitter;t.parent;)t=t.parent;if("Scene"===t.type)if(this.emitEnded&&0===this.particleNum)this.markForDestroy&&this.emitter.parent&&this.dispose();else{if(this.looping&&this.prewarm&&!this.prewarmed){this.prewarmed=!0;for(var n=0;n<60*this.duration;n++)this.update(1/60)}e>.1&&(e=.1),this.neededToUpdateRender&&(this._renderer&&this._renderer.updateSystem(this),this.neededToUpdateRender=!1),this.emit(e,this.emissionState,this.emitter.matrixWorld);for(var i={particle:void 0,emissionState:this.emissionState,delta:e},r=0;r<this.particleNum;r++)i.particle=this.particles[r],this.interpreter.run(this.updateGraph,i);for(var a=0;a<this.particleNum;a++)this.rendererEmitterSettings.followLocalOrigin&&this.particles[a].localPosition?(this.particles[a].position.copy(this.particles[a].localPosition),this.particles[a].parentMatrix?this.particles[a].position.applyMatrix4(this.particles[a].parentMatrix):this.particles[a].position.applyMatrix4(this.emitter.matrixWorld)):this.particles[a].position.addScaledVector(this.particles[a].velocity,e),this.particles[a].age+=e;if(this.rendererSettings.renderMode===$t.Trail)for(var o=0;o<this.particleNum;o++){this.particles[o].update()}for(var s=0;s<this.particleNum;s++){var u=this.particles[s];!u.died||u instanceof Oe&&0!==u.previous.length||(this.particles[s]=this.particles[this.particleNum-1],this.particles[this.particleNum-1]=u,this.particleNum--,s--)}}else this.dispose()}}},{key:"emit",value:function(t,n,i){var r=this;n.time>this.duration&&(this.looping?n.time-=this.duration:this.emitEnded||this.endEmit()),this.normalMatrix.getNormalMatrix(i);var a={signal:function(){r.spawn(n,i)},emissionState:n,delta:t};this.emitEnded||this.interpreter.run(this.emissionGraph,a),void 0===this.previousWorldPos&&(this.previousWorldPos=new e),this.emitter.getWorldPosition(this.previousWorldPos),n.time+=t}},{key:"toJSON",value:function(e){return{}}},{key:"getRendererSettings",value:function(){return this.rendererSettings}},{key:"clone",value:function(){return this}}]),t}(),Ui={number:{buildBySigIndex:[function(e,t,n){return"".concat(t[0])}]},vec2:{buildBySigIndex:[function(e,t,n){return"vec2<f32>(".concat(t[0],", ").concat(t[1],")")}]},vec3:{buildBySigIndex:[function(e,t,n){return"vec3<f32>(".concat(t[0],", ").concat(t[1],", ").concat(t[2],")")}]},vec4:{buildBySigIndex:[function(e,t,n){return"vec4<f32>(".concat(t[0],", ").concat(t[1],", ").concat(t[2],", ").concat(t[3],")")}]},add:{buildBySigIndex:[function(e,t,n){return"(".concat(t[0]," + ").concat(t[1],")")},function(e,t,n){return"(".concat(t[0]," + ").concat(t[1],")")},function(e,t,n){return"(".concat(t[0]," + ").concat(t[1],")")},function(e,t,n){return"(".concat(t[0]," + ").concat(t[1],")")}]},subtract:{buildBySigIndex:[function(e,t,n){return"(".concat(t[0]," - ").concat(t[1],")")},function(e,t,n){return"(".concat(t[0]," - ").concat(t[1],")")},function(e,t,n){return"(".concat(t[0]," - ").concat(t[1],")")},function(e,t,n){return"(".concat(t[0]," - ").concat(t[1],")")}]},mul:{buildBySigIndex:[function(e,t,n){return"(".concat(t[0]," * ").concat(t[1],")")},function(e,t,n){return"(".concat(t[0]," * ").concat(t[1],")")},function(e,t,n){return"(".concat(t[0]," * ").concat(t[1],")")},function(e,t,n){return"(".concat(t[0]," * ").concat(t[1],")")}]},div:{buildBySigIndex:[function(e,t,n){return"(".concat(t[0]," / ").concat(t[1],")")},function(e,t,n){return"(".concat(t[0]," / ").concat(t[1],")")},function(e,t,n){return"(".concat(t[0]," / ").concat(t[1],")")},function(e,t,n){return"(".concat(t[0]," / ").concat(t[1],")")}]},power:{buildBySigIndex:[function(e,t,n){return"pow(".concat(t[0],", ").concat(t[1],")")}]},sqrt:{buildBySigIndex:[function(e,t,n){return"sqrt(".concat(t[0],")")}]},sin:{buildBySigIndex:[function(e,t,n){return"sin(".concat(t[0],")")}]},cos:{buildBySigIndex:[function(e,t,n){return"cos(".concat(t[0],")")}]},tan:{buildBySigIndex:[function(e,t,n){return"tan(".concat(t[0],")")}]},asin:{buildBySigIndex:[function(e,t,n){return"asin(".concat(t[0],")")}]},acos:{buildBySigIndex:[function(e,t,n){return"acos(".concat(t[0],")")}]},atan:{buildBySigIndex:[function(e,t,n){return"atan(".concat(t[0],")")}]},atan2:{buildBySigIndex:[function(e,t,n){return"atan(".concat(t[0],", ").concat(t[1],")")}]},abs:{buildBySigIndex:[function(e,t,n){return"abs(".concat(t[0],")")}]},floor:{buildBySigIndex:[function(e,t,n){return"floor(".concat(t[0],")")}]},ceil:{buildBySigIndex:[function(e,t,n){return"ceil(".concat(t[0],")")}]},round:{buildBySigIndex:[function(e,t,n){return"round(".concat(t[0],")")}]},min:{buildBySigIndex:[function(e,t,n){return"min(".concat(t[0],", ").concat(t[1],")")},function(e,t,n){return"min(".concat(t[0],", ").concat(t[1],")")},function(e,t,n){return"min(".concat(t[0],", ").concat(t[1],")")},function(e,t,n){return"min(".concat(t[0],", ").concat(t[1],")")}]},max:{buildBySigIndex:[function(e,t,n){return"max(".concat(t[0],", ").concat(t[1],")")},function(e,t,n){return"max(".concat(t[0],", ").concat(t[1],")")},function(e,t,n){return"max(".concat(t[0],", ").concat(t[1],")")},function(e,t,n){return"max(".concat(t[0],", ").concat(t[1],")")}]},clamp:{buildBySigIndex:[function(e,t,n){return"clamp(".concat(t[0],", ").concat(t[1],", ").concat(t[2],")")},function(e,t,n){return"clamp(".concat(t[0],", ").concat(t[1],", ").concat(t[2],")")},function(e,t,n){return"clamp(".concat(t[0],", ").concat(t[1],", ").concat(t[2],")")},function(e,t,n){return"clamp(".concat(t[0],", ").concat(t[1],", ").concat(t[2],")")}]},mix:{buildBySigIndex:[function(e,t,n){return"mix(".concat(t[0],", ").concat(t[1],", ").concat(t[2],")")},function(e,t,n){return"mix(".concat(t[0],", ").concat(t[1],", ").concat(t[2],")")},function(e,t,n){return"mix(".concat(t[0],", ").concat(t[1],", ").concat(t[2],")")},function(e,t,n){return"mix(".concat(t[0],", ").concat(t[1],", ").concat(t[2],")")}]},step:{buildBySigIndex:[function(e,t,n){return"step(".concat(t[0],", ").concat(t[1],")")},function(e,t,n){return"step(".concat(t[0],", ").concat(t[1],")")},function(e,t,n){return"step(".concat(t[0],", ").concat(t[1],")")},function(e,t,n){return"step(".concat(t[0],", ").concat(t[1],")")}]},smoothstep:{buildBySigIndex:[function(e,t,n){return"smoothstep(".concat(t[0],", ").concat(t[1],", ").concat(t[2],")")},function(e,t,n){return"smoothstep(".concat(t[0],", ").concat(t[1],", ").concat(t[2],")")},function(e,t,n){return"smoothstep(".concat(t[0],", ").concat(t[1],", ").concat(t[2],")")},function(e,t,n){return"smoothstep(".concat(t[0],", ").concat(t[1],", ").concat(t[2],")")}]},length:{buildBySigIndex:[function(e,t,n){return"length(".concat(t[0],")")},function(e,t,n){return"length(".concat(t[0],")")},function(e,t,n){return"length(".concat(t[0],")")}]},delta:{buildBySigIndex:[function(e,t,n){return"sim_params.delta"}]},particleProperty:{buildBySigIndex:[function(e,t,n){return"particle.".concat(e.data.property)}]}},Vi=function(n){ce(a,Nn);var r=pe(a);function a(){var e;return oe(this,a),le(fe(e=r.call(this)),"nodeResult",new Map),le(fe(e),"particleInstanceByteSize",0),le(fe(e),"hasRandom",!1),e}return ue(a,[{key:"run",value:function(e,t){throw new Error("Method not implemented.")}},{key:"calculateMemoryLayout",value:function(e){for(var t=0,n=0;n<e.length;n++){var i=e[n],r=Sn(i),a=xn(i);t=Math.ceil(t/r)*r,t+=a}return t=16*Math.ceil(t/16)}},{key:"buildPredefinedStructs",value:function(e,t,n){var i=this;e.push("struct SimulationParams {"),e.push("    delta : f32,"),e.push("    seed : vec4<f32>,"),e.push("}"),e.push("struct Particle {"),e.push("    color: vec4<f32>,"),e.push("    position: vec3<f32>,");var r=t.outputNodes.filter((function(e){return"particleProperty"===e.definition.name&&"position"!==e.data.property&&"color"!==e.data.property&&"life"!==e.data.property&&"size"!==e.data.property&&"rotation"!==e.data.property&&"age"!==e.data.property})).sort((function(e,t){return xn(e.data.type)-xn(t.data.type)}));this.particleInstanceByteSize=this.calculateMemoryLayout([gn.Vec4,gn.Vec3].concat(r.map((function(e){return e.data.type}))).concat([gn.Number,gn.Number,gn.Number,gn.Number])),r.forEach((function(t){e.push("    ".concat(t.data.property,": ").concat(i.getTypeFromNodeType(t.data.type),","))})),e.push("    size: f32,"),e.push("    rotation: f32,"),e.push("    life: f32,"),e.push("    age: f32,"),e.push("}"),e.push("struct Particles {"),e.push("    particles : array<Particle>,"),e.push("}")}},{key:"buildHeader",value:function(e,t,n){e.push(Ri),this.buildPredefinedStructs(e,t,n),e.push("@binding(0) @group(0) var<uniform> sim_params : SimulationParams;"),e.push("@binding(1) @group(0) var<storage, read_write> data : Particles;"),e.push("@binding(2) @group(0) var<storage, read_write> indexList : array<u32>;"),e.push("@compute @workgroup_size(64)"),e.push("fn simulate(@builtin(global_invocation_id) global_invocation_id : vec3<u32>) {"),e.push("  let invo_id = global_invocation_id.x;"),e.push("  let idx = indexList[invo_id];"),this.hasRandom&&e.push("  init_rand(invo_id, sim_params.seed);"),e.push("  var particle = data.particles[idx];")}},{key:"buildFooter",value:function(e,t,n){e.push("  particle.age += sim_params.delta;"),e.push("  data.particles[idx] = particle;"),e.push("}")}},{key:"buildWebGPUCode",value:function(e,t){var n=[];return this.buildHeader(n,e,t),this.buildDataFlow(e,n,t),this.buildFooter(n,e,t),n.join("\n")}},{key:"buildDataFlow",value:function(e,t,n){for(var i=0;i<e.nodesInOrder.length;i++){var r=e.nodesInOrder[i],a=Ui[r.definition.name];if(void 0===a)throw new Error("Node ".concat(r.id," ").concat(r.definition.name," has no builder"));for(var o=a.buildBySigIndex[r.signatureIndex],s=[],u=0;u<r.inputs.length;u++)if(r.inputs[u]instanceof Mn){var l=r.inputs[u].input;l instanceof bn?s.push(this.nodeResult.get(l)):s.push(this.buildFromAdapter(l,t,n))}else if(r.inputs[u]instanceof _n);else if(void 0!==r.inputs[u])s.push(this.buildFromValue(r.inputs[u].getValue(n)));else if(r.definition.type!==On.Storage)throw new Error("Node ".concat(r.id," misses input on index ").concat(u));var c=o(r,s,n);1===r.outputs.length?r.definition.type===On.Storage?(s.length>0&&t.push("".concat(c," = ").concat(s[0],";")),this.nodeResult.set(r,c)):r.outputs[0].length>1?(t.push("let v".concat(t.length," = ").concat(c,";")),this.nodeResult.set(r,"v"+(t.length-1))):r.outputs[0].length>0&&this.nodeResult.set(r,c):r.outputs.length}}},{key:"build",value:function(e,t){return e.compiled||this.buildExecutionOrder(e,t),this.buildWebGPUCode(e,t)}},{key:"buildFromValue",value:function(n){if("number"==typeof n)return""+n;if(n instanceof i)return"vec2<f32>(".concat(n.x,", ").concat(n.y,")");if(n instanceof e)return"vec3<f32>(".concat(n.x,", ").concat(n.y,", ").concat(n.z,")");if(n instanceof t)return"vec4<f32>(".concat(n.x,", ").concat(n.y,", ").concat(n.z,", ").concat(n.w,")");throw new Error("Unknown value type ".concat(ie(n)))}},{key:"getTypeFromNodeType",value:function(e){switch(e){case gn.Number:return"f32";case gn.Vec2:return"vec<f32>";case gn.Vec3:return"vec3<f32>";case gn.Vec4:return"vec4<f32>";default:throw new Error("Unknown node value type ".concat(e))}}},{key:"buildFromAdapter",value:function(e,t,n){if(e.isInput)switch(e.node.definition.type){case On.Storage:for(var i=0;i<Ci.get(e.type);i++)if(e.inputs[i]instanceof Mn){var r=Ui[e.node.definition.name].buildBySigIndex[e.node.signatureIndex];n.param=zi[i],t.push(r(e.node,[this.getResult(e.inputs[i])],n))}break;case On.Variable:case On.Expression:for(var a="",o=0;o<Ci.get(e.type)-1;o++)a=this.getResult(e.inputs[o])+", ";a+=this.getResult(e.inputs[Ci.get(e.type)-1]),t.push("".concat(this.getTypeFromNodeType(e.type),"(").concat(a,")"))}return""}},{key:"getResult",value:function(e){var t=e.input;if(t instanceof _n){if(t.isInput)throw new Error("node ".concat(t.node.id,"'s output adapter has to be output"));return this.nodeResult.get(t.node)+"."+zi[t.outputs.findIndex((function(t){return t.includes(e)}))]}return this.nodeResult.get(t)}}]),a}(),Ci=new Map([[gn.Vec2,2],[gn.Vec3,3],[gn.Vec4,4]]),zi=["x","y","z","w"],Ri="\nvar<private> rand_seed : vec2<f32>;\n\nfn init_rand(invocation_id : u32, seed : vec4<f32>) {\n  rand_seed = seed.xz;\n  rand_seed = fract(rand_seed * cos(35.456+f32(invocation_id) * seed.yw));\n  rand_seed = fract(rand_seed * cos(41.235+f32(invocation_id) * seed.xw));\n}\n\nfn rand() -> f32 {\n  rand_seed.x = fract(cos(dot(rand_seed, vec2<f32>(23.14077926, 232.61690225))) * 136.8168);\n  rand_seed.y = fract(cos(dot(rand_seed, vec2<f32>(54.47856553, 345.84153136))) * 534.7645);\n  return rand_seed.y;\n}\n";te(),console.log("%c Particle system powered by three.quarks. https://quarks.art/","font-size: 14px; font-weight: bold;");const Ii=Object.freeze(Object.defineProperty({__proto__:null,Adapter:_n,ApplyCollision:Vt,ApplyForce:ut,ApplySequences:At,AxisAngleGenerator:He,BatchedParticleRenderer:fn,BatchedRenderer:hn,BehaviorFromJSON:Ft,BehaviorTypes:Lt,Bezier:Te,ChangeEmitDirection:ct,CircleEmitter:qt,ColorBySpeed:Ct,ColorGeneratorFromJSON:Je,ColorOverLife:Ke,ColorRange:Ve,ConeEmitter:Gt,ConstantColor:Fe,ConstantValue:De,DonutEmitter:jt,EmitSubParticleSystem:pt,EmitterFromJSON:Kt,EmitterMode:Jt,EmitterShapes:Qt,EulerGenerator:Ye,ForceOverLife:nt,FrameOverLife:at,GeneratorFromJSON:Qe,Gradient:Re,GraphNodeType:En,GravityForce:lt,GridEmitter:Yt,HemisphereEmitter:Ht,Interpreter:kn,IntervalValue:Ge,LimitSpeedOverLife:It,MeshSurfaceEmitter:Zt,Node:bn,NodeDef:Tn,NodeGraph:Oi,NodeParticle:_e,NodeType:On,NodeTypes:Pn,NodeVFX:Ai,NodeValueType:gn,Noise:Tt,OrbitOverLife:ot,OutputNodeTypeNames:ki,ParticleEmitter:we,ParticleSystem:sn,PiecewiseBezier:je,PiecewiseFunction:qe,Plugins:yn,PointEmitter:Xt,QuarksLoader:vn,RandomColor:Ue,RandomColorBetweenGradient:Le,RandomQuatGenerator:We,RecordState:ke,RenderMode:$t,Rotation3DOverLife:tt,RotationBySpeed:Rt,RotationGeneratorFromJSON:Ze,RotationOverLife:$e,SequencerFromJSON:Pt,SizeBySpeed:zt,SizeOverLife:it,SpeedOverLife:rt,SphereEmitter:Wt,SpriteBatch:cn,SpriteParticle:Ne,SubParticleEmitMode:ft,TextureSequencer:Et,TrailBatch:dn,TrailParticle:Oe,TurbulenceField:Mt,VFXBatch:en,ValueGeneratorFromJSON:Xe,WebGPUCompiler:Vi,WebGPURenderer:mn,WidthOverLength:st,Wire:Mn,genDefaultForNodeValueType:wn,getAlignOfNodeValueType:Sn,getPhysicsResolver:Ut,getSizeOfNodeValueType:xn,getValueFromEmitterMode:Dt,initWebGPU:function(){return pn.apply(this,arguments)},loadPlugin:function(e){if(!yn.find((function(t){return t.id===e.id}))){e.initialize();var t,n=Se(e.emitterShapes);try{for(n.s();!(t=n.n()).done;){var i=t.value;Qt[i.type]||(Qt[i.type]=i)}}catch(s){n.e(s)}finally{n.f()}var r,a=Se(e.behaviors);try{for(a.s();!(r=a.n()).done;){var o=r.value;Lt[o.type]||(Lt[o.type]=o)}}catch(s){a.e(s)}finally{a.f()}}},registerShaderChunks:te,setPhysicsResolver:function(e){Bt=e},unloadPlugin:function(e){var t=yn.find((function(t){return t.id===e}));if(t){var n,i=Se(t.emitterShapes);try{for(i.s();!(n=i.n()).done;){var r=n.value;Qt[r.type]&&delete Qt[r.type]}}catch(u){i.e(u)}finally{i.f()}var a,o=Se(t.behaviors);try{for(o.s();!(a=o.n()).done;){var s=a.value;Lt[s.type]&&delete Lt[s.type]}}catch(u){o.e(u)}finally{o.f()}}}},Symbol.toStringTag,{value:"Module"}));export{hn as B,Fe as C,Ge as I,je as P,it as S,Ii as _,Ve as a};
