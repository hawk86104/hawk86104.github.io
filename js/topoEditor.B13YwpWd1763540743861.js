import"./mobx-preact.CWb_pbao1763540743861.js";import"./preact.8mrV7GhH1763540743861.js";import{H as t,a as e,E as o,R as s,b as i,D as l,c as r,L as n,d as a,M as h,S as d,e as p}from"./@logicflow.M1mrFPeZ1763540743861.js";import{_ as c}from"./index.vue_vue_type_script_setup_true_lang.D76qwcxN1763540743861.js";import{$ as u,S as f}from"./@vue.Co_gxueH1763540743861.js";import m from"./index.DCxBYR9O1763540743861.js";import{l as y}from"./lodash.CybtBilg1763540743861.js";import{E as g}from"./elkjs.D22xAZRm1763540743861.js";import{M as x}from"./index.Lv5YXFoE1763540743861.js";const b=[{key:"text:base",parent:"文本",label:"基础文本",icon:"./plugins/topoEditor/image/text.svg",properties:{width:100,height:60}},{key:"text:area",parent:"文本",label:"区域文本",icon:"./plugins/topoEditor/image/text.svg",properties:{width:100,height:60,style:{fill:"#666",stroke:"#000",strokeWidth:0,radius:5},textStyle:{color:"#fff",fontSize:12}}},{key:"node:base",parent:"基础节点",label:"矩形节点",icon:"./plugins/topoEditor/image/node.svg"},{key:"group:base",parent:"容器",label:"分组",icon:"./plugins/topoEditor/image/group.png",properties:{collapsible:!1,isCollapsed:!1}}];class E{constructor({lf:t,options:e}){this.offsetX=0,this.offsetY=0,this.x=0,this.y=0,this.closeTimer=null,this.jumpTimer=null,this.rootEl=document.createElement("div"),this.renderContext=null,this.lf=t,this.init(),this.rootEl.style.position="absolute",this.rootEl.style.top="0",this.rootEl.style.left="0",this.rootEl.style.zIndex="1000",this.rootEl.style.pointerEvents="none",this.clearCloseTimer=this.clearCloseTimer.bind(this),this.removeToolbar=this.removeToolbar.bind(this),this.updateOffset=this.updateOffset.bind(this)}static{this.pluginName="toolbar"}init(){this.lf.on("node:mouseenter",({data:t,e:e})=>{const o=this.lf.getModelById(t.id);if(!o)return;const s=o.height||0;this.x=t.x*this.lf.graphModel.transformModel.SCALE_X,this.y=(t.y+s/2+10)*this.lf.graphModel.transformModel.SCALE_Y,this.jumpTimer=window.setTimeout(()=>{this.clearCloseTimer(),this.updateToolbar(o)},100)}),this.lf.on("node:drag,node:resize",({data:t})=>{const e=this.lf.getModelById(t.id);if(!e)return;const o=e.height||0;this.x=t.x,this.y=t.y+o/2+10,this.updateToolbar(e)}),this.lf.on("node:mouseleave",()=>{this.removeToolbar()}),this.lf.on("graph:transform",()=>{this.updateOffset()}),this.lf.graphModel.rootEl.parentNode?.appendChild(this.rootEl)}updateToolbar(t){u(null,this.rootEl);const e=f(c,{x:this.x,y:this.y,onMouseenter:this.clearCloseTimer,onMouseleave:this.removeToolbar,model:t});u(e,this.rootEl),this.renderContext=e}clearCloseTimer(){this.closeTimer&&(window.clearTimeout(this.closeTimer),this.closeTimer=null),this.jumpTimer&&(window.clearTimeout(this.jumpTimer),this.jumpTimer=null)}async removeToolbar(){this.clearCloseTimer(),this.closeTimer=window.setTimeout(()=>{u(null,this.rootEl),this.renderContext=null},300)}updateOffset(){const{transform:t}=this.lf.graphModel.transformModel.getTransformStyle(),[e,o,s,i,l,r]=t?.match(/matrix\((.*?)\)/)?.pop()?.split(",").map(Number)||[];this.offsetX=l,this.offsetY=r,this.rootEl.style.transform=`translate(${this.offsetX}px, ${this.offsetY}px)`}}const v=(t,e)=>({defaultValue:o=>o.properties.textStyle?.[t]||e,onUpdate:(e,o)=>{e.setProperty("textStyle",{...e.properties.textStyle,[t]:o})}}),w=(t,e)=>({defaultValue:o=>o.properties.style?.[t]||e,onUpdate:(e,o)=>{e.setProperty("style",{...e.properties.style,[t]:o})}});class C extends e{constructor(t){super(t),this._text="",this.rootDiv=document.createElement("div"),t.graphModel.eventCenter.on("text:update",({data:t})=>{t.id===this.props.model.id&&(this._text=t.text,this.rootDiv.innerHTML=this._text)})}setHtml(t){const{properties:e,text:o}=this.props.model,{style:s,textStyle:i}=e;this.rootDiv.style.width="100%",this.rootDiv.style.height="100%",this.rootDiv.style.boxSizing="border-box",this.rootDiv.style.padding="4px",this.rootDiv.style.backgroundColor=s?.fill||"#fff",this.rootDiv.style.border=`${s?.strokeWidth}px solid ${s?.stroke||"#000"}`,this.rootDiv.style.borderRadius=`${s?.radius}px`,this.rootDiv.style.color=`${i?.color||"#666"}`,this.rootDiv.style.fontSize=`${i?.fontSize||12}px`,this._text=o.value,this.rootDiv.innerHTML=this._text,t.appendChild(this.rootDiv)}getText(){const{model:t}=this.props;return t.state===o.TEXT_EDIT?this.rootDiv.innerHTML="":this.rootDiv.innerHTML=this._text,null}}class T extends t{constructor(){super(...arguments),this.toolbarList=[{title:"基础配置",children:[{type:"color",label:"颜色",...w("fill","#fff")}]},{title:"文字配置",children:[{type:"range",label:"文字大小",...v("fontSize",12)},{type:"color",label:"文字颜色",...v("color","#000")}]}]}}class k extends i{}class M extends s{constructor(){super(...arguments),this.toolbarList=[{title:"基础配置",children:[{type:"color",label:"颜色",...w("fill","#fff")}]},{title:"文字配置",children:[{type:"range",label:"文字大小",...v("fontSize",12)},{type:"color",label:"文字颜色",...v("color","#000")}]}]}setAttributes(){super.setAttributes(),this.text.draggable=!0,this.text.editable=!0}}class N extends r{}class L extends l{constructor(){super(...arguments),this.toolbarList=[{type:"button",label:"布局",onClick:async t=>{const e=t.graphModel.autoLayout;await e.layoutByGroup(t)}},{title:"基础配置",children:[{type:"color",label:"颜色",...w("fill","#fff")}]},{title:"文字配置",children:[{type:"range",label:"文字大小",...v("fontSize",12)},{type:"color",label:"文字颜色",...v("color","#000")}]}]}setAttributes(){super.setAttributes(),this.text.draggable=!0,this.text.editable=!0}}const I={text:(t,e)=>(t.register({type:e.key,view:C,model:T}),{type:e.key,label:e.label,text:e.label,icon:e.icon,properties:e.properties}),node:(t,e)=>(t.register({type:e.key,view:k,model:M}),{type:e.key,label:e.label,text:e.label,icon:e.icon,properties:e.properties}),group:(t,e)=>(t.register({type:e.key,view:N,model:L}),{type:e.key,label:e.label,text:e.label,icon:e.icon,properties:e.properties})};class D{constructor({lf:t,options:e={}}){this.rootEl=document.createElement("div"),this.renderContext=null,this.groups=[],this.lf=t,this.options=e,this.init()}static{this.pluginName="dndPanel"}init(){this.rootEl.style.position="absolute";const{position:t={left:"10px",top:"10px"}}=this.options;Object.entries(t).forEach(([t,e])=>{this.rootEl.style[t]="number"==typeof e?`${e}px`:e}),this.rootEl.style.zIndex="999",this.lf.graphModel.rootEl.parentNode?.appendChild(this.rootEl),this.renderPanel()}renderPanel(){const t=f(m,{lf:this.lf,groups:this.groups});u(t,this.rootEl),this.renderContext=t}destroy(){u(null,this.rootEl),this.renderContext=null}setNodes(t){const e=y.groupBy(t,"parent"),o=Object.keys(e);o.forEach(t=>{e[t].forEach(t=>{const e=t.key.split(":")[0]||t.key;I[e](this.lf,t)})}),this.groups=o.map(t=>({name:"undefined"===t?"默认":t,items:e[t].map(t=>({type:t.key,label:t.label,text:t.label,icon:t.icon,properties:t.properties}))})),this.renderPanel()}}const S=new g;class j{constructor({lf:t,options:e}){this.map=new Map,this.lf=t,this.options=Object.assign({spacing:60,padding:60},e),this.lf.graphModel.autoLayout=this}static{this.pluginName="autoLayout"}getTextSize(t,e){let o=0;for(let s=0;s<t.length;s++){const i=t.charAt(s);/[\u4e00-\u9fa5\uFF00-\uFFFF]/.test(i)?o+=e:o+=e/2}return{width:o,height:e}}getMap(t){let e=this.map.get(t);return e||(e=new Map,this.map.set(t,e)),e}getLayoutNode(t,e){const o=this.getMap(e),s=this.lf.graphModel.getNodeModelById(t);if(!s)return;let i,l,r;if(s instanceof L){i=Array.from(s.children.values()).map(t=>this.getLayoutNode(t,e)).filter(t=>void 0!==t);const t=s.getTextStyle(),o=this.getTextSize(s.text?.value||"",t.fontSize);i.push({id:`${s.id}-text`,width:o.width,height:o.height})}return l=Array.from(s.anchors.values()).filter(t=>void 0!==t.id).map(t=>({id:t.id,x:t.x-s.x,y:t.y-s.y,layoutOptions:this.getLayoutOptions()})),r=[...s.incoming.edges,...s.outgoing.edges].map(t=>{if(o.has(t.id))return;const e={id:t.id,sources:[t.sourceAnchorId||t.sourceNodeId],targets:[t.targetAnchorId||t.targetNodeId]};return o.set(t.id,"1"),e}).filter(t=>void 0!==t),{id:s.id,width:s.width,height:s.height,children:i,ports:l,edges:r,layoutOptions:this.getLayoutOptions()}}async layoutAll(){const t=this.lf.graphModel.nodes,e=t.filter(t=>t instanceof L).map(t=>Array.from(t.children.values())).flat(),o=t.filter(t=>!e.includes(t.id)).map(t=>t.id),s=await this.layoutByIds(o);s.children?.forEach(t=>{this.updateByLayoutAll(t,0,0)})}updateByLayoutAll(t,e,o){if(t.id.endsWith("-text")){const s=this.lf.graphModel.getNodeModelById(t.id.replace("-text",""));if(!s)return;const i=(t.x||0)+e+(t.width||0)/2,l=(t.y||0)+o+(t.height||0)/2,r=s.text?.x||0,n=s.text?.y||0;return void s.moveText(i-r,l-n)}const s=this.lf.graphModel.nodes,i=(t.x||0)+e,l=(t.y||0)+o,r=i+(t.width||0)/2,n=l+(t.height||0)/2;this.lf.graphModel?.moveNode2Coordinate(t.id,r,n);const a=s.find(e=>e.id===t.id);a&&(a.width=t.width||0,a.height=t.height||0,a.setProperties({width:t.width||0,height:t.height||0})),t.children?.forEach(t=>{this.updateByLayoutAll(t,i,l)})}async layoutByGroup(t){const e=await this.layoutByIds([t.id]);if(!e)return;const o=t.width,s=t.height;t.width=e.width||0,t.height=e.height||0,t.setProperties({width:e.width||0,height:e.height||0});const i=(o-t.width)/2,l=(s-t.height)/2;this.lf.graphModel?.moveNode(t.id,-i,-l),e.children?.forEach(e=>{this.updateByLayoutAll(e,t.x-t.width/2,t.y-t.height/2)})}getLayoutOptions(){const{spacing:t,padding:e}=this.options;return{"elk.hierarchyHandling":"INCLUDE_CHILDREN","elk.algorithm":"layered","elk.spacing.nodeNode":`${t}`,"elk.padding":`[top=${e}.0,left=${e}.0,bottom=${e}.0,right=${e}.0]`,"elk.layered.spacing.nodeNodeBetweenLayers":`${t}`}}async layoutByIds(t){const e=t.map(t=>this.getLayoutNode(t,Math.random().toString(36).substring(2,15))),o=new Set,s=t=>{t.forEach(t=>{t&&(o.add(t.id),t.ports?.forEach(t=>{o.add(t.id)}),t.children&&s(t.children))})};s(e);const i=t=>{t.forEach(t=>{t?.edges&&(t.edges=t.edges.filter(t=>t.sources.every(t=>o.has(t))&&t.targets.every(t=>o.has(t)))),t?.children&&i(t.children)})};i(e);const l=await S.layout({id:"root",children:e.filter(t=>void 0!==t),layoutOptions:this.getLayoutOptions()},{layoutOptions:this.getLayoutOptions()});return l}}class z{constructor({lf:t,options:e}){this.rootEl=document.createElement("div"),this.lf=t,this.lf.graphModel.manager=this,this.rootEl.style.position="absolute",this.rootEl.style.bottom="0",this.rootEl.style.left="0",this.rootEl.style.zIndex="1000",this.lf.graphModel.rootEl.parentNode?.appendChild(this.rootEl);const o=f(x,{lf:this.lf,options:e});u(o,this.rootEl)}static{this.pluginName="manager"}}class O{constructor({lf:t}){this.controlItems=[{key:"zoom-out",iconClass:"lf-control-zoomOut",title:"缩小流程图",text:"缩小",onClick:()=>{this.lf.zoom(!1)}},{key:"zoom-in",iconClass:"lf-control-zoomIn",title:"放大流程图",text:"放大",onClick:()=>{this.lf.zoom(!0)}},{key:"reset",iconClass:"lf-control-fit",title:"恢复流程原有尺寸",text:"适应",onClick:()=>{this.lf.fitView(20,20);const t=this.lf?.extension.toolbar;t.updateOffset()}},{key:"undo",iconClass:"lf-control-undo",title:"回到上一步",text:"上一步",onClick:()=>{this.lf.undo()}},{key:"redo",iconClass:"lf-control-redo",title:"移到下一步",text:"下一步",onClick:()=>{this.lf.redo()}}],this.lf=t}static{this.pluginName="control"}render(t,e){this.destroy();const o=this.getControlTool();this.toolEl=o,e.appendChild(o),this.domContainer=e}destroy(){this.domContainer&&this.toolEl&&this.domContainer.contains(this.toolEl)&&this.domContainer.removeChild(this.toolEl)}addItem(t){this.controlItems.push(t)}removeItem(t){const e=this.controlItems.findIndex(e=>e.key===t);return-1==e?null:this.controlItems.splice(e,1)[0]}getControlTool(){const t="lf-control-item",e="lf-control-item disabled",o=document.createElement("div"),s=[];return o.className="lf-control",this.controlItems.forEach(o=>{const i=document.createElement("div"),l=document.createElement("i"),r=document.createElement("span");switch(i.className=e,o.onClick&&(i.onclick=o.onClick.bind(null,this.lf)),o.onMouseEnter&&(i.onmouseenter=o.onMouseEnter.bind(null,this.lf)),o.onMouseLeave&&(i.onmouseleave=o.onMouseLeave.bind(null,this.lf)),l.className=o.iconClass,r.className="lf-control-text",r.title=o.title,r.innerText=o.text,i.append(l,r),o.text){case"上一步":this.lf.on("history:change",({data:{undoAble:o}})=>{i.className=o?t:e});break;case"下一步":this.lf.on("history:change",({data:{redoAble:o}})=>{i.className=o?t:e});break;default:i.className=t}s.push(i)}),o.append(...s),o}}class A{constructor(t,e){this.lf=new n({container:t,grid:!0,keyboard:{enabled:!0},allowResize:!0,allowRotate:!0,textDraggable:!0,edgeTextDraggable:!1,nodeTextDraggable:!0,snapline:!0,textEdit:!0,isSilentMode:!1,stopZoomGraph:!0,stopScrollGraph:!1,plugins:[a,O,h,d,p,E,D,j,z],pluginsOptions:{dndPanel:{position:{left:"10px",top:"10px"}},manager:Object.assign({save:!0,download:!0,handleLoad:!1,autoLayout:!0},e?.manager)},style:{rect:{strokeWidth:1}}}),this.miniMapInit(),this.registerNodes(e?.nodeConfig)}miniMapInit(){const t=this.lf?.extension.miniMap;t.show()}registerNodes(t){const e=this.lf.extension.dndPanel;t?e.setNodes(t):e.setNodes(b)}render(t){this.lf.render(t||{}),this.lf.fitView(20,20);const e=this.lf?.extension.toolbar;e.updateOffset()}getGraphData(){return this.lf.getGraphData()}}const _=async t=>{const e=document.createElement("div");e.style.position="absolute",e.style.left="-9999px",e.style.top="-9999px",document.body.appendChild(e);const o=new A(e);o.render(t);const s=o.lf.extension.autoLayout;await s.layoutAll();const i=o.getGraphData();return document.body.removeChild(e),i};export{A as T,_ as a,b as d};
