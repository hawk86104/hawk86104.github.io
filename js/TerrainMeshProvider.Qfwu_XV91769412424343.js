import{importShared as t}from"./3d-tiles-renderer.DFcJBJdg1769412424343.js";import{computeBoundsTree as e,disposeBoundsTree as r,acceleratedRaycast as i}from"./ExtensionUtilities.Do3kYtmK1769412424343.js";import{B as s}from"./three-custom-shader-material.es.DUHaOnDf1769412424343.js";const o=Math.PI/180,n=180/Math.PI;function a(t,e){return t/Math.pow(2,e)*360-180}function h(t,e){const r=Math.PI-2*Math.PI*t/Math.pow(2,e);return n*Math.atan(.5*(Math.exp(r)-Math.exp(-r)))}function l(t,e,r){const i=function(t,e,r){const i=Math.sin(e*o),s=Math.pow(2,r);let n=s*(t/360+.5);const a=s*(.5-.25*Math.log((1+i)/(1-i))/Math.PI);n%=s,n<0&&(n+=s);return[n,a,r]}(t,e,r);return i[0]=Math.floor(i[0]),i[1]=Math.floor(i[1]),i}function c(t){return[[2*t[0],2*t[1],t[2]+1],[2*t[0]+1,2*t[1],t[2]+1],[2*t[0]+1,2*t[1]+1,t[2]+1],[2*t[0],2*t[1]+1,t[2]+1]]}function d(t){const e=l(t[0],t[1],32),r=l(t[2],t[3],32),i=[e[0],e[1],r[0],r[1]],s=function(t){for(let e=0;e<28;e++){const r=1<<32-(e+1);if((t[0]&r)!==(t[2]&r)||(t[1]&r)!==(t[3]&r))return e}return 28}(i);if(0===s)return[0,0,0];return[i[0]>>>32-s,i[1]>>>32-s,s]}const{Box3:u,Object3D:m,Mesh:p}=await t("three");class f extends m{constructor(){super(),this.isDisposed=!1,this.isReady=!1,this.childrenTiles=[],this.boundingBoxWorld=new u}init(t,e,r){this.tileNo=t,Object.freeze(this.tileNo),this.map=e,this.parentTile=r,this.visible=!1,this.renderOrder=t[2],this.ready()}async ready(){if(this.content=await this.map.provider.getTile(this.tileNo),!this.isDisposed){if(this.add(this.content),this.boundingBoxWorld.setFromObject(this.content).applyMatrix4(this.matrixWorld.makeRotationX(-Math.PI/2)),this.map.add(this),this.visible=!0,this.isReady=!0,this.parentTile){const t=this.parentTile.childrenTiles;let e=0;for(let r=0;r<t.length;r++)t[r].isReady&&e++;4===e&&(this.parentTile.visible=!1)}this.update()}}update(){if(!this.isReady||this.isDisposed)return;const{cameraFrustum:t,cameraWorldPosition:e}=this.map;if(!t.intersectsBox(this.boundingBoxWorld))return void this.simplify();this.content instanceof p&&this.map.provider.filter&&(this.content.material.uniforms.t_Matrix.value=this.map.provider.getTranMatrix());let r=this.boundingBoxWorld.distanceToPoint(e);const i=this.tileNo[2];r/=Math.pow(2,this.map.provider.maxZoom-i),r<60&&this.subdivide(),r>80&&this.simplify();this.childrenTiles.sort((t,r)=>t.boundingBoxWorld.distanceToPoint(e)-r.boundingBoxWorld.distanceToPoint(e)).forEach(t=>t.update())}subdivide(){const{isReady:t,tileNo:e,map:r,childrenTiles:i}=this,s=e[2];if(!t||i.length>0||s>=r.maxZoom)return;c(e).forEach(t=>{const e=new f;e.init(t,r,this),i.push(e)})}simplify(){this.childrenTiles.forEach(t=>t.dispose()),this.childrenTiles=[],this.visible=!0}dispose(){this.map.remove(this),this.map.provider.abort(this.tileNo),this.childrenTiles.forEach(t=>t.dispose()),this.childrenTiles=[],this.parentTile=void 0,this.content&&(this.map.provider.dispose(this.tileNo,this.content),this.content=void 0),this.isDisposed=!0}}const{Frustum:g,Matrix4:M,Object3D:w,Vector3:x,BufferGeometry:v,Mesh:y}=await t("three");let T,b=class extends w{constructor(){super(),this.bbox=[74.390592,6.900905,134.071423,54.318199],this.maxZoom=20,this.rootForward=0,this.cameraFrustum=new g,this.cameraWorldPosition=new x,this.cameraProjectionMatrix=new M,this.lastCameraProjectionMatrix=new M,this.lastCameraWorldPosition=new x,this.rootTiles=[],this.lastUpdateTime=0,v.prototype.computeBoundsTree||(v.prototype.computeBoundsTree=e),v.prototype.disposeBoundsTree||(v.prototype.disposeBoundsTree=r),y.prototype.raycast=i}initRootTiles(){this.rootForward>3&&(console.warn("rootForward needs to be 0 - 3."),this.rootForward=3),this.rootForward<0&&(console.warn("rootForward needs to be 0 - 3."),this.rootForward=0);const t=[];let e=[d(this.bbox)],r=this.rootForward;for(;r>0;){const t=[...e];e=[],t.forEach(t=>{const r=c(t);e.push(...r)}),r--}t.push(...e),t.forEach(t=>{const e=new f;e.init(t,this),this.rootTiles.push(e)})}update(){if(!this.visible||!this.camera)return;const t=Date.now();t-this.lastUpdateTime<300||(0!==this.rootTiles.length?(this.camera.getWorldPosition(this.cameraWorldPosition),this.cameraProjectionMatrix.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),this.cameraWorldPosition.equals(this.lastCameraWorldPosition)&&this.cameraProjectionMatrix.equals(this.lastCameraProjectionMatrix)||(this.cameraFrustum.setFromProjectionMatrix(this.cameraProjectionMatrix),this.rootTiles.forEach(t=>t.update()),this.lastCameraProjectionMatrix.copy(this.cameraProjectionMatrix),this.lastCameraWorldPosition.copy(this.cameraWorldPosition),this.lastUpdateTime=t)):this.initRootTiles())}dispose(){throw new Error("[Map.dispose] Method not implemented.")}regenerate(){throw new Error("[Map.regenerate] Method not implemented.")}};class P{constructor(){this._controller=new AbortController,this.listeners=new Set}static{this.pendings=new Map}fetch(t,e={}){P.pendings.has(t)||(P.pendings.set(t,this),fetch(t,{...e,signal:this._controller.signal}).then(t=>{this.listeners.forEach(e=>e.resolve(t.clone()))}).catch(t=>{this.listeners.forEach(e=>e.reject(t))}).finally(()=>{P.pendings.delete(t)}))}abort(){this._controller.abort()}}class _{constructor(t,e){this.url=t,this.init=e,this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}ready(){let t=P.pendings.get(this.url);return t||(t=new P,t.fetch(this.url,this.init)),t.listeners.add(this),this.promise}abort(){this.reject("User abort.");const t=P.pendings.get(this.url);t&&(t.listeners.delete(this),0===t.listeners.size&&t.abort())}}class k{constructor(t){this.terminated=!0,this.map=new Map,this.worker=new t,this.worker.onmessage=this.onMessage.bind(this),this.terminated=!1}async postMessage(t){if(!this.terminated)return this.worker.postMessage(t),new Promise((e,r)=>{this.map.set(t.id,e)})}onMessage(t){const{id:e,error:r}=t.data,i=this.map.get(e);i&&!r&&i(t.data),this.map.delete(e)}terminate(){this.worker.onmessage=null,this.worker.terminate(),this.terminated=!0,this.map.clear()}}function W(t){return new Worker(""+new URL("../static/MapWorker-BP068Z4Y.js",import.meta.url).href,{name:t?.name})}const{Texture:B}=await t("three");class C{constructor(){this.maxZoom=20,this.source="https://gac-geo.googlecnapps.cn/maps/vt?lyrs=s&x=[x]&y=[y]&z=[z]",this.showTileNo=!1,this._useWorker=!1,this.fetching=new Map}set useWorker(t){this._useWorker=t,this._useWorker||(this._worker?.terminate(),this._worker=void 0)}get useWorker(){return this._useWorker}async getTile(t){const e=this.getUrl(t),r=new B;if(this._useWorker){this._worker||(this._worker=new k(W));const i=this.getId(t),s=await this._worker.postMessage({id:i,tileNo:t,url:e,debug:this.showTileNo});r.image=s.bitmap}else{const i=new _(e,{cache:"force-cache",mode:"cors"});this.fetching.set(t,i);try{r.image=await async function(t,e,r=!1){const i=await e.ready(),s=await i.blob(),o=await createImageBitmap(s,r?void 0:{imageOrientation:"flipY"});if(!r)return o;T||(T=new OffscreenCanvas(256,256));const n=T.getContext("2d");if(!n)throw new Error('Offscreencanvas.getContext("2d") error!');const{width:a,height:h}=T;return n.drawImage(o,0,0),n.rect(0,0,a,h),n.strokeStyle="#00FFFF",n.font="20px Arial",n.stroke(),n.fillStyle="#FF4444",n.fillText(`${t[0]}`,10,30),n.fillStyle="#44FF44",n.fillText(`${t[1]}`,10,55),n.fillStyle="#66AAFF",n.fillText(`${t[2]}`,10,80),await createImageBitmap(T,{imageOrientation:"flipY"})}(t,i,this.showTileNo)}finally{this.fetching.delete(t)}}return r.needsUpdate=!0,r.anisotropy=4,r}abort(t){if(this._useWorker)this._worker?.postMessage({id:this.getId(t),abort:!0});else{const e=this.fetching.get(t);e&&e.abort(),this.fetching.delete(t)}}dispose(t,e){e.dispose()}getId(t){return t.join("-")}getUrl(t){const[e,r,i]=t;return-1===this.source.indexOf("[x]")?this.source.replace("{x}",e+"").replace("{y}",r+"").replace("{z}",i+""):this.source.replace("[x]",e+"").replace("[y]",r+"").replace("[z]",i+"")}}const F="utm",I="merc",j=6378137,U=Math.PI/180;function S(t,e){return[j*t*U,j*Math.log(Math.tan(.25*Math.PI+e*U*.5))]}function R(t,e){let r=t/(j*Math.PI)*180,i=e/(j*Math.PI)*180;return i=180/Math.PI*(2*Math.atan(Math.exp(i*Math.PI/180))-Math.PI/2),[r,i]}function Z(t){return t*Math.PI/180}function E(t){return 180*t/Math.PI}const N={a:6378137,f:1/298.257223563};function q(t,e,r){if(!(-80<=e&&e<=84))throw new RangeError(`latitude ‘${e}’ outside UTM limits`);let i=r||Math.floor((t+180)/6)+1,s=Z(6*(i-1)-180+3);const o="CDEFGHJKLMNPQRSTUVWXX".charAt(Math.floor(e/8+10));31===i&&"V"===o&&t>=3?(i++,s+=Z(6)):32===i&&"X"===o&&t<9?(i--,s-=Z(6)):32===i&&"X"===o&&t>=9?(i++,s+=Z(6)):34===i&&"X"===o&&t<21?(i--,s-=Z(6)):34===i&&"X"===o&&t>=21?(i++,s+=Z(6)):36===i&&"X"===o&&t<33?(i--,s-=Z(6)):36===i&&"X"===o&&t>=33&&(i++,s+=Z(6));const n=Z(e),a=Z(t)-s,{a:h,f:l}=N,c=.9996,d=Math.sqrt(l*(2-l)),u=l/(2-l),m=u*u,p=u*m,f=u*p,g=u*f,M=u*g,w=Math.cos(a),x=Math.sin(a),v=Math.tan(n),y=Math.sinh(d*Math.atanh(d*v/Math.sqrt(1+v*v))),T=v*Math.sqrt(1+y*y)-y*Math.sqrt(1+v*v),b=Math.atan2(T,w),P=Math.asinh(x/Math.sqrt(T*T+w*w)),_=h/(1+u)*(1+1/4*m+1/64*f+1/256*M),k=[null,.5*u-2/3*m+5/16*p+41/180*f-127/288*g+7891/37800*M,13/48*m-.6*p+557/1440*f+281/630*g-1983433/1935360*M,61/240*p-103/140*f+15061/26880*g+167603/181440*M,49561/161280*f-179/168*g+6601661/7257600*M,34729/80640*g-3418889/1995840*M,.6650675310896665*M];let W=b;for(let I=1;I<=6;I++)W+=k[I]*Math.sin(2*I*b)*Math.cosh(2*I*P);let B=P;for(let I=1;I<=6;I++)B+=k[I]*Math.cos(2*I*b)*Math.sinh(2*I*P);let C=c*_*B,F=c*_*W;return C+=5e5,F<0&&(F+=1e7),[C,F]}function D(t,e,r){const{a:i,f:s}=N,o=.9996,n=t-5e5,a=e,h=Math.sqrt(s*(2-s)),l=s/(2-s),c=l*l,d=l*c,u=l*d,m=l*u,p=l*m,f=i/(1+l)*(1+1/4*c+1/64*u+1/256*p),g=n/(o*f),M=a/(o*f),w=[null,.5*l-2/3*c+37/96*d-1/360*u-81/512*m+96199/604800*p,1/48*c+1/15*d-437/1440*u+46/105*m-1118711/3870720*p,17/480*d-37/840*u-209/4480*m+5569/90720*p,4397/161280*u-11/504*m-830251/7257600*p,4583/161280*m-108847/3991680*p,20648693/638668800*p];let x=M;for(let I=1;I<=6;I++)x-=w[I]*Math.sin(2*I*M)*Math.cosh(2*I*g);let v=g;for(let I=1;I<=6;I++)v-=w[I]*Math.cos(2*I*M)*Math.sinh(2*I*g);const y=Math.sinh(v),T=Math.sin(x),b=Math.cos(x),P=T/Math.sqrt(y*y+b*b);let _=null,k=P;do{const t=Math.sinh(h*Math.atanh(h*k/Math.sqrt(1+k*k))),e=k*Math.sqrt(1+t*t)-t*Math.sqrt(1+k*k);_=(P-e)/Math.sqrt(1+e*e)*(1+(1-h*h)*k*k)/((1-h*h)*Math.sqrt(1+k*k)),k+=_}while(Math.abs(_)>1e-12);const W=k,B=Math.atan(W);let C=Math.atan2(y,b);C+=Z(117);const F=Number(E(B).toFixed(14));return[Number(E(C).toFixed(14)),F]}const{BufferAttribute:O,PlaneGeometry:A}=await t("three");class X{constructor(){this.utmZone=50,this.coordType=F,this.maxZoom=20}async getTile(t){const e=new A,r=function(t){const e=a(t[0]+1,t[2]);return[a(t[0],t[2]),h(t[1]+1,t[2]),e,h(t[1],t[2])]}(t),i=this.convertCoordinate(r[0],r[3]),s=this.convertCoordinate(r[2],r[3]),o=this.convertCoordinate(r[0],r[1]),n=this.convertCoordinate(r[2],r[1]),l=new Float32Array([i[0],i[1],0,s[0],s[1],0,o[0],o[1],0,n[0],n[1],0]);return e.setAttribute("position",new O(l,3)),e}abort(t){}dispose(t,e){e.dispose()}convertCoordinate(t,e){return this.coordType===F?q(t,e,this.utmZone):S(t,e)}}function z(t){return new Worker(""+new URL("../static/MartiniWorker-Ryjx9cZO.js",import.meta.url).href,{name:t?.name})}const{BufferAttribute:G,BufferGeometry:L}=await t("three");class V{constructor(){this.maxZoom=12,this.coordType=F,this.utmZone=50,this._useWorker=!0,this.source="https://api.maptiler.com/tiles/terrain-rgb-v2/[z]/[x]/[y].webp?key=L55MtSxL94Yb4hQeWewp"}set useWorker(t){this._useWorker=t,this._useWorker||(this._worker?.terminate(),this._worker=void 0)}get useWorker(){return this._useWorker}async getTile(t){return this._useWorker?this.getInWorkerThread(t):this.getInMainThread()}async getInMainThread(){return new L}async getInWorkerThread(t){this._worker||(this._worker=new k(z));const e={tileNo:t,id:this.getId(t),url:this.getUrl(t),maxZ:this.maxZoom,coordType:this.coordType,utmZone:this.utmZone},r=await this._worker.postMessage(e),i=new L;return i.setAttribute("position",new G(r.positions,3)),i.setAttribute("uv",new G(r.uv,2)),i.setIndex(new G(r.triangles,1)),i}async abort(t){this._useWorker&&this._worker?.postMessage({id:this.getId(t),abort:!0})}async dispose(t,e){e.dispose(),this._useWorker&&this._worker?.postMessage({id:this.getId(t),dispose:!0})}getId(t){return t.join("-")}getUrl(t){const[e,r,i]=t;return this.source.replace("[x]",e+"").replace("[y]",r+"").replace("[z]",i+"")}}const{Mesh:Y,Vector3:$}=await t("three");class H extends Y{constructor(t){super(t),this.center=new $}}const{Box3Helper:Q,MeshBasicMaterial:J,MeshStandardMaterial:K,SRGBColorSpace:tt,Matrix4:et}=await t("three");class rt{constructor(t,e){this.geometryProvider=t,this.textureProvider=e,this.maxZoom=20,this.showBoundingBox=!1,this.wireframe=!1,this.flatShading=!1,this.useStandardMaterial=!1,this.filter=null}getTranMatrix(){let t=new et;if(this.filter?.opposite){let e=new et;e.set(-1,0,0,0,0,-1,0,0,0,0,-1,0,1,1,1,1),t.multiply(e)}if(this.filter?.monochrome){let e=new et;const r=this.filter.monochrome.r,i=this.filter.monochrome.g,s=this.filter.monochrome.b;e.set(r,i,s,0,r,i,s,0,r,i,s,0,0,0,0,1),t.multiply(e)}if(this.filter?.genBright){let e=new et;const r=this.filter.genBright;e.set(r,0,0,0,0,r,0,0,0,0,r,0,0,0,0,1),t.multiply(e)}if(this.filter?.genContrast){let e=new et;const r=this.filter.genContrast,i=.5*(1-r);e.set(r,0,0,0,0,r,0,0,0,0,r,0,i,i,i,1),t.multiply(e)}if(this.filter?.genSaturate){let e=new et;const r=this.filter.genSaturate,i=.3*(1-r),s=.6*(1-r),o=.1*(1-r);e.set(i+r,i,i,0,s,s+r,s,0,o,o,o+r,0,0,0,0,1),t.multiply(e)}return t}async getTile(t){const e=[this.geometryProvider.getTile(t),this.textureProvider.getTile(t)],r=await Promise.all(e),i=r[0],o=r[1];o.colorSpace=tt;const{wireframe:n,flatShading:a}=this;let h=null;const l=t[0]+t[1]+t[2];h=this.useStandardMaterial?new K({map:o,wireframe:n,flatShading:a}):new J({map:o,wireframe:n}),this.filter&&(h=new s({baseMaterial:h,vertexShader:"\n                varying vec2 vUv;    //顶点纹理坐标\n                void main () {\n                    vUv = uv;\n                    // gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4( position, 1.0 ); 着色器会抖动\n                    // gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n                    csm_Position = position * vec3(1.0);\n                }\n                ",fragmentShader:"\n                uniform sampler2D e_Texture;     //纹理图像\n                varying vec2 vUv;               //片元纹理坐标\n                uniform mat4 t_Matrix;     //接收变换矩阵\n                void main () {\n                    // gl_FragColor = texture2D( e_Texture, vUv );\n\n                    // vec4 textureColor = texture2D( e_Texture, vUv );\n                    // //计算加权平均值\n                    // float w_a = textureColor.r * 0.3 + textureColor.g * 0.6 + textureColor.b * 0.1;\n                    // gl_FragColor = vec4(w_a, w_a, w_a, 1.0);\n\n                    vec4 textureColor = texture2D( e_Texture, vUv );\n                    //变换矩阵乘以 vec4(R,G,B,1)    ---\x3evec4(R,G,B,1) 是齐次坐标，原本是n维的向量用一个n+1维向量来表示\n                    //vec4(R,G,B,1)第四个分量不是透明度\n                    vec4 transColor =  vec4(textureColor.r, textureColor.g, textureColor.b, 1.0)*t_Matrix; \n                    //设置透明度\n                    transColor.a = 1.0;\n                    csm_FragColor = transColor;\n\n                    // if(vUv.x==0.0 || vUv.x==1.0 || vUv.y==0.0 || vUv.y==1.0){\n                    //     gl_FragColor.a = 0.0;\n                    // }\n                }",silent:!0,flatShading:a,uniforms:{e_Texture:{value:o},t_Matrix:{value:this.getTranMatrix()}}}));const c=new H;if(c.renderOrder=l,i.computeBoundingBox(),i.boundingBox.getCenter(c.center),i.center(),i.computeBoundingSphere(),i.computeBoundsTree(),c.position.copy(c.center),c.geometry=i,c.material=h,this.showBoundingBox){const t=new Q(i.boundingBox);c.add(t)}return c}abort(t){this.geometryProvider.abort(t),this.textureProvider.abort(t)}dispose(t,e){const r=e.geometry,i=e.material;r&&this.geometryProvider.dispose(t,r),i&&i.map&&this.textureProvider.dispose(t,i.map),i?.dispose()}}export{I as MERC,b as Map,C as MapProvider,V as MartiniTerrainProvider,X as PlaneProvider,rt as TerrainMeshProvider,F as UTM,q as lonLatToUtm,S as lonLatToWebMerctor,D as utmToLonLat,R as webMercatorToLonLat};
