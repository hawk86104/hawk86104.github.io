import{i as t}from"./3d-tiles-renderer.CbgZh8zU1767066396612.js";import{g as e,b as r,t as i}from"./@mapbox.DBNDgF_h1767066396612.js";import{c as s,d as o,a}from"./three-mesh-bvh.BBErpT9w1767066396612.js";import{B as n}from"./three-custom-shader-material.DAA_4JPH1767066396612.js";const{Box3:h,Object3D:l,Mesh:c}=await t("three");class d extends l{constructor(){super(),this.isDisposed=!1,this.isReady=!1,this.childrenTiles=[],this.boundingBoxWorld=new h}init(t,e,r){this.tileNo=t,Object.freeze(this.tileNo),this.map=e,this.parentTile=r,this.visible=!1,this.renderOrder=t[2],this.ready()}async ready(){if(this.content=await this.map.provider.getTile(this.tileNo),!this.isDisposed){if(this.add(this.content),this.boundingBoxWorld.setFromObject(this.content).applyMatrix4(this.matrixWorld.makeRotationX(-Math.PI/2)),this.map.add(this),this.visible=!0,this.isReady=!0,this.parentTile){const t=this.parentTile.childrenTiles;let e=0;for(let r=0;r<t.length;r++)t[r].isReady&&e++;4===e&&(this.parentTile.visible=!1)}this.update()}}update(){if(!this.isReady||this.isDisposed)return;const{cameraFrustum:t,cameraWorldPosition:e}=this.map;if(!t.intersectsBox(this.boundingBoxWorld))return void this.simplify();this.content instanceof c&&this.map.provider.filter&&(this.content.material.uniforms.t_Matrix.value=this.map.provider.getTranMatrix());let r=this.boundingBoxWorld.distanceToPoint(e);const i=this.tileNo[2];r/=Math.pow(2,this.map.provider.maxZoom-i),r<60&&this.subdivide(),r>80&&this.simplify();this.childrenTiles.sort((t,r)=>t.boundingBoxWorld.distanceToPoint(e)-r.boundingBoxWorld.distanceToPoint(e)).forEach(t=>t.update())}subdivide(){const{isReady:t,tileNo:r,map:i,childrenTiles:s}=this,o=r[2];if(!t||s.length>0||o>=i.maxZoom)return;e(r).forEach(t=>{const e=new d;e.init(t,i,this),s.push(e)})}simplify(){this.childrenTiles.forEach(t=>t.dispose()),this.childrenTiles=[],this.visible=!0}dispose(){this.map.remove(this),this.map.provider.abort(this.tileNo),this.childrenTiles.forEach(t=>t.dispose()),this.childrenTiles=[],this.parentTile=void 0,this.content&&(this.map.provider.dispose(this.tileNo,this.content),this.content=void 0),this.isDisposed=!0}}const{Frustum:u,Matrix4:m,Object3D:p,Vector3:g,BufferGeometry:w,Mesh:f}=await t("three");let M,x=class extends p{constructor(){super(),this.bbox=[74.390592,6.900905,134.071423,54.318199],this.maxZoom=20,this.rootForward=0,this.cameraFrustum=new u,this.cameraWorldPosition=new g,this.cameraProjectionMatrix=new m,this.lastCameraProjectionMatrix=new m,this.lastCameraWorldPosition=new g,this.rootTiles=[],this.lastUpdateTime=0,w.prototype.computeBoundsTree||(w.prototype.computeBoundsTree=s),w.prototype.disposeBoundsTree||(w.prototype.disposeBoundsTree=o),f.prototype.raycast=a}initRootTiles(){this.rootForward>3&&(console.warn("rootForward needs to be 0 - 3."),this.rootForward=3),this.rootForward<0&&(console.warn("rootForward needs to be 0 - 3."),this.rootForward=0);const t=[];let i=[r(this.bbox)],s=this.rootForward;for(;s>0;){const t=[...i];i=[],t.forEach(t=>{const r=e(t);i.push(...r)}),s--}t.push(...i),t.forEach(t=>{const e=new d;e.init(t,this),this.rootTiles.push(e)})}update(){if(!this.visible||!this.camera)return;const t=Date.now();t-this.lastUpdateTime<300||(0!==this.rootTiles.length?(this.camera.getWorldPosition(this.cameraWorldPosition),this.cameraProjectionMatrix.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),this.cameraWorldPosition.equals(this.lastCameraWorldPosition)&&this.cameraProjectionMatrix.equals(this.lastCameraProjectionMatrix)||(this.cameraFrustum.setFromProjectionMatrix(this.cameraProjectionMatrix),this.rootTiles.forEach(t=>t.update()),this.lastCameraProjectionMatrix.copy(this.cameraProjectionMatrix),this.lastCameraWorldPosition.copy(this.cameraWorldPosition),this.lastUpdateTime=t)):this.initRootTiles())}dispose(){throw new Error("[Map.dispose] Method not implemented.")}regenerate(){throw new Error("[Map.regenerate] Method not implemented.")}};class v{constructor(){this._controller=new AbortController,this.listeners=new Set}static{this.pendings=new Map}fetch(t,e={}){v.pendings.has(t)||(v.pendings.set(t,this),fetch(t,{...e,signal:this._controller.signal}).then(t=>{this.listeners.forEach(e=>e.resolve(t.clone()))}).catch(t=>{this.listeners.forEach(e=>e.reject(t))}).finally(()=>{v.pendings.delete(t)}))}abort(){this._controller.abort()}}class y{constructor(t,e){this.url=t,this.init=e,this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}ready(){let t=v.pendings.get(this.url);return t||(t=new v,t.fetch(this.url,this.init)),t.listeners.add(this),this.promise}abort(){this.reject("User abort.");const t=v.pendings.get(this.url);t&&(t.listeners.delete(this),0===t.listeners.size&&t.abort())}}class b{constructor(t){this.terminated=!0,this.map=new Map,this.worker=new t,this.worker.onmessage=this.onMessage.bind(this),this.terminated=!1}async postMessage(t){if(!this.terminated)return this.worker.postMessage(t),new Promise((e,r)=>{this.map.set(t.id,e)})}onMessage(t){const{id:e,error:r}=t.data,i=this.map.get(e);i&&!r&&i(t.data),this.map.delete(e)}terminate(){this.worker.onmessage=null,this.worker.terminate(),this.terminated=!0,this.map.clear()}}function T(t){return new Worker(""+new URL("../static/MapWorker-BP068Z4Y.js",import.meta.url).href,{name:t?.name})}const{Texture:P}=await t("three");class _{constructor(){this.maxZoom=20,this.source="https://gac-geo.googlecnapps.cn/maps/vt?lyrs=s&x=[x]&y=[y]&z=[z]",this.showTileNo=!1,this._useWorker=!1,this.fetching=new Map}set useWorker(t){this._useWorker=t,this._useWorker||(this._worker?.terminate(),this._worker=void 0)}get useWorker(){return this._useWorker}async getTile(t){const e=this.getUrl(t),r=new P;if(this._useWorker){this._worker||(this._worker=new b(T));const i=this.getId(t),s=await this._worker.postMessage({id:i,tileNo:t,url:e,debug:this.showTileNo});r.image=s.bitmap}else{const i=new y(e,{cache:"force-cache",mode:"cors"});this.fetching.set(t,i);try{r.image=await async function(t,e,r=!1){const i=await e.ready(),s=await i.blob(),o=await createImageBitmap(s,r?void 0:{imageOrientation:"flipY"});if(!r)return o;M||(M=new OffscreenCanvas(256,256));const a=M.getContext("2d");if(!a)throw new Error('Offscreencanvas.getContext("2d") error!');const{width:n,height:h}=M;return a.drawImage(o,0,0),a.rect(0,0,n,h),a.strokeStyle="#00FFFF",a.font="20px Arial",a.stroke(),a.fillStyle="#FF4444",a.fillText(`${t[0]}`,10,30),a.fillStyle="#44FF44",a.fillText(`${t[1]}`,10,55),a.fillStyle="#66AAFF",a.fillText(`${t[2]}`,10,80),await createImageBitmap(M,{imageOrientation:"flipY"})}(t,i,this.showTileNo)}finally{this.fetching.delete(t)}}return r.needsUpdate=!0,r.anisotropy=4,r}abort(t){if(this._useWorker)this._worker?.postMessage({id:this.getId(t),abort:!0});else{const e=this.fetching.get(t);e&&e.abort(),this.fetching.delete(t)}}dispose(t,e){e.dispose()}getId(t){return t.join("-")}getUrl(t){const[e,r,i]=t;return-1===this.source.indexOf("[x]")?this.source.replace("{x}",e+"").replace("{y}",r+"").replace("{z}",i+""):this.source.replace("[x]",e+"").replace("[y]",r+"").replace("[z]",i+"")}}const k="utm",W="merc",B=6378137,C=Math.PI/180;function F(t,e){return[B*t*C,B*Math.log(Math.tan(.25*Math.PI+e*C*.5))]}function j(t,e){let r=t/(B*Math.PI)*180,i=e/(B*Math.PI)*180;return i=180/Math.PI*(2*Math.atan(Math.exp(i*Math.PI/180))-Math.PI/2),[r,i]}function I(t){return t*Math.PI/180}function U(t){return 180*t/Math.PI}const S={a:6378137,f:1/298.257223563};function R(t,e,r){if(!(-80<=e&&e<=84))throw new RangeError(`latitude ‘${e}’ outside UTM limits`);let i=r||Math.floor((t+180)/6)+1,s=I(6*(i-1)-180+3);const o="CDEFGHJKLMNPQRSTUVWXX".charAt(Math.floor(e/8+10));31===i&&"V"===o&&t>=3?(i++,s+=I(6)):32===i&&"X"===o&&t<9?(i--,s-=I(6)):32===i&&"X"===o&&t>=9?(i++,s+=I(6)):34===i&&"X"===o&&t<21?(i--,s-=I(6)):34===i&&"X"===o&&t>=21?(i++,s+=I(6)):36===i&&"X"===o&&t<33?(i--,s-=I(6)):36===i&&"X"===o&&t>=33&&(i++,s+=I(6));const a=I(e),n=I(t)-s,{a:h,f:l}=S,c=.9996,d=Math.sqrt(l*(2-l)),u=l/(2-l),m=u*u,p=u*m,g=u*p,w=u*g,f=u*w,M=Math.cos(n),x=Math.sin(n),v=Math.tan(a),y=Math.sinh(d*Math.atanh(d*v/Math.sqrt(1+v*v))),b=v*Math.sqrt(1+y*y)-y*Math.sqrt(1+v*v),T=Math.atan2(b,M),P=Math.asinh(x/Math.sqrt(b*b+M*M)),_=h/(1+u)*(1+1/4*m+1/64*g+1/256*f),k=[null,.5*u-2/3*m+5/16*p+41/180*g-127/288*w+7891/37800*f,13/48*m-.6*p+557/1440*g+281/630*w-1983433/1935360*f,61/240*p-103/140*g+15061/26880*w+167603/181440*f,49561/161280*g-179/168*w+6601661/7257600*f,34729/80640*w-3418889/1995840*f,.6650675310896665*f];let W=T;for(let j=1;j<=6;j++)W+=k[j]*Math.sin(2*j*T)*Math.cosh(2*j*P);let B=P;for(let j=1;j<=6;j++)B+=k[j]*Math.cos(2*j*T)*Math.sinh(2*j*P);let C=c*_*B,F=c*_*W;return C+=5e5,F<0&&(F+=1e7),[C,F]}function Z(t,e,r){const{a:i,f:s}=S,o=.9996,a=t-5e5,n=e,h=Math.sqrt(s*(2-s)),l=s/(2-s),c=l*l,d=l*c,u=l*d,m=l*u,p=l*m,g=i/(1+l)*(1+1/4*c+1/64*u+1/256*p),w=a/(o*g),f=n/(o*g),M=[null,.5*l-2/3*c+37/96*d-1/360*u-81/512*m+96199/604800*p,1/48*c+1/15*d-437/1440*u+46/105*m-1118711/3870720*p,17/480*d-37/840*u-209/4480*m+5569/90720*p,4397/161280*u-11/504*m-830251/7257600*p,4583/161280*m-108847/3991680*p,20648693/638668800*p];let x=f;for(let j=1;j<=6;j++)x-=M[j]*Math.sin(2*j*f)*Math.cosh(2*j*w);let v=w;for(let j=1;j<=6;j++)v-=M[j]*Math.cos(2*j*f)*Math.sinh(2*j*w);const y=Math.sinh(v),b=Math.sin(x),T=Math.cos(x),P=b/Math.sqrt(y*y+T*T);let _=null,k=P;do{const t=Math.sinh(h*Math.atanh(h*k/Math.sqrt(1+k*k))),e=k*Math.sqrt(1+t*t)-t*Math.sqrt(1+k*k);_=(P-e)/Math.sqrt(1+e*e)*(1+(1-h*h)*k*k)/((1-h*h)*Math.sqrt(1+k*k)),k+=_}while(Math.abs(_)>1e-12);const W=k,B=Math.atan(W);let C=Math.atan2(y,T);C+=I(117);const F=Number(U(B).toFixed(14));return[Number(U(C).toFixed(14)),F]}const{BufferAttribute:N,PlaneGeometry:q}=await t("three");class E{constructor(){this.utmZone=50,this.coordType=k,this.maxZoom=20}async getTile(t){const e=new q,r=i(t),s=this.convertCoordinate(r[0],r[3]),o=this.convertCoordinate(r[2],r[3]),a=this.convertCoordinate(r[0],r[1]),n=this.convertCoordinate(r[2],r[1]),h=new Float32Array([s[0],s[1],0,o[0],o[1],0,a[0],a[1],0,n[0],n[1],0]);return e.setAttribute("position",new N(h,3)),e}abort(t){}dispose(t,e){e.dispose()}convertCoordinate(t,e){return this.coordType===k?R(t,e,this.utmZone):F(t,e)}}function D(t){return new Worker(""+new URL("../static/MartiniWorker-Ryjx9cZO.js",import.meta.url).href,{name:t?.name})}const{BufferAttribute:O,BufferGeometry:A}=await t("three");class X{constructor(){this.maxZoom=12,this.coordType=k,this.utmZone=50,this._useWorker=!0,this.source="https://api.maptiler.com/tiles/terrain-rgb-v2/[z]/[x]/[y].webp?key=L55MtSxL94Yb4hQeWewp"}set useWorker(t){this._useWorker=t,this._useWorker||(this._worker?.terminate(),this._worker=void 0)}get useWorker(){return this._useWorker}async getTile(t){return this._useWorker?this.getInWorkerThread(t):this.getInMainThread()}async getInMainThread(){return new A}async getInWorkerThread(t){this._worker||(this._worker=new b(D));const e={tileNo:t,id:this.getId(t),url:this.getUrl(t),maxZ:this.maxZoom,coordType:this.coordType,utmZone:this.utmZone},r=await this._worker.postMessage(e),i=new A;return i.setAttribute("position",new O(r.positions,3)),i.setAttribute("uv",new O(r.uv,2)),i.setIndex(new O(r.triangles,1)),i}async abort(t){this._useWorker&&this._worker?.postMessage({id:this.getId(t),abort:!0})}async dispose(t,e){e.dispose(),this._useWorker&&this._worker?.postMessage({id:this.getId(t),dispose:!0})}getId(t){return t.join("-")}getUrl(t){const[e,r,i]=t;return this.source.replace("[x]",e+"").replace("[y]",r+"").replace("[z]",i+"")}}const{Mesh:z,Vector3:G}=await t("three");class L extends z{constructor(t){super(t),this.center=new G}}const{Box3Helper:V,MeshBasicMaterial:Y,MeshStandardMaterial:$,SRGBColorSpace:H,Matrix4:Q}=await t("three");class J{constructor(t,e){this.geometryProvider=t,this.textureProvider=e,this.maxZoom=20,this.showBoundingBox=!1,this.wireframe=!1,this.flatShading=!1,this.useStandardMaterial=!1,this.filter=null}getTranMatrix(){let t=new Q;if(this.filter?.opposite){let e=new Q;e.set(-1,0,0,0,0,-1,0,0,0,0,-1,0,1,1,1,1),t.multiply(e)}if(this.filter?.monochrome){let e=new Q;const r=this.filter.monochrome.r,i=this.filter.monochrome.g,s=this.filter.monochrome.b;e.set(r,i,s,0,r,i,s,0,r,i,s,0,0,0,0,1),t.multiply(e)}if(this.filter?.genBright){let e=new Q;const r=this.filter.genBright;e.set(r,0,0,0,0,r,0,0,0,0,r,0,0,0,0,1),t.multiply(e)}if(this.filter?.genContrast){let e=new Q;const r=this.filter.genContrast,i=.5*(1-r);e.set(r,0,0,0,0,r,0,0,0,0,r,0,i,i,i,1),t.multiply(e)}if(this.filter?.genSaturate){let e=new Q;const r=this.filter.genSaturate,i=.3*(1-r),s=.6*(1-r),o=.1*(1-r);e.set(i+r,i,i,0,s,s+r,s,0,o,o,o+r,0,0,0,0,1),t.multiply(e)}return t}async getTile(t){const e=[this.geometryProvider.getTile(t),this.textureProvider.getTile(t)],r=await Promise.all(e),i=r[0],s=r[1];s.colorSpace=H;const{wireframe:o,flatShading:a}=this;let h=null;const l=t[0]+t[1]+t[2];h=this.useStandardMaterial?new $({map:s,wireframe:o,flatShading:a}):new Y({map:s,wireframe:o}),this.filter&&(h=new n({baseMaterial:h,vertexShader:"\n                varying vec2 vUv;    //顶点纹理坐标\n                void main () {\n                    vUv = uv;\n                    // gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4( position, 1.0 ); 着色器会抖动\n                    // gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n                    csm_Position = position * vec3(1.0);\n                }\n                ",fragmentShader:"\n                uniform sampler2D e_Texture;     //纹理图像\n                varying vec2 vUv;               //片元纹理坐标\n                uniform mat4 t_Matrix;     //接收变换矩阵\n                void main () {\n                    // gl_FragColor = texture2D( e_Texture, vUv );\n\n                    // vec4 textureColor = texture2D( e_Texture, vUv );\n                    // //计算加权平均值\n                    // float w_a = textureColor.r * 0.3 + textureColor.g * 0.6 + textureColor.b * 0.1;\n                    // gl_FragColor = vec4(w_a, w_a, w_a, 1.0);\n\n                    vec4 textureColor = texture2D( e_Texture, vUv );\n                    //变换矩阵乘以 vec4(R,G,B,1)    ---\x3evec4(R,G,B,1) 是齐次坐标，原本是n维的向量用一个n+1维向量来表示\n                    //vec4(R,G,B,1)第四个分量不是透明度\n                    vec4 transColor =  vec4(textureColor.r, textureColor.g, textureColor.b, 1.0)*t_Matrix; \n                    //设置透明度\n                    transColor.a = 1.0;\n                    csm_FragColor = transColor;\n\n                    // if(vUv.x==0.0 || vUv.x==1.0 || vUv.y==0.0 || vUv.y==1.0){\n                    //     gl_FragColor.a = 0.0;\n                    // }\n                }",silent:!0,flatShading:a,uniforms:{e_Texture:{value:s},t_Matrix:{value:this.getTranMatrix()}}}));const c=new L;if(c.renderOrder=l,i.computeBoundingBox(),i.boundingBox.getCenter(c.center),i.center(),i.computeBoundingSphere(),i.computeBoundsTree(),c.position.copy(c.center),c.geometry=i,c.material=h,this.showBoundingBox){const t=new V(i.boundingBox);c.add(t)}return c}abort(t){this.geometryProvider.abort(t),this.textureProvider.abort(t)}dispose(t,e){const r=e.geometry,i=e.material;r&&this.geometryProvider.dispose(t,r),i&&i.map&&this.textureProvider.dispose(t,i.map),i?.dispose()}}export{_ as M,E as P,J as T,k as U,x as a,W as b,X as c,F as d,R as l,Z as u,j as w};
