import{i as e}from"./3d-tiles-renderer.CbgZh8zU1767066396612.js";import{F as a,_ as t,K as o}from"./@tresjs.B1f7s3pS1767066396612.js";import{G as n}from"./three.BD1hRFgo1767066396612.js";import{_ as i}from"./@fesjs.BK66sTPr1767066396612.js";const{defineComponent:s}=await e("vue"),{onMounted:r,ref:l,watch:c,nextTick:d,markRaw:u}=await e("vue"),p=await e("three"),h=s({__name:"legend",props:{deviceConfig:{},title:{default:"SYSTEM MONITOR"},panelPosition:{default:()=>({top:"20px",right:"20px"})},panelWidth:{default:"220px"},statusDotColor:{default:"#0f0"},sceneBackground:{default:1710618},sceneFogColor:{default:1710618},sceneFogRange:{default:()=>[10,30]},groundColor:{default:1381653},groundSize:{default:()=>[30,30]},gridSize:{default:30},gridDivisions:{default:30},gridColor1:{default:5592405},gridColor2:{default:2236962},ambientLightIntensity:{default:.8},directionalLightIntensity:{default:1.2},directionalLightPosition:{default:()=>[5,15,7]},fillLightIntensity:{default:.3},fillLightPosition:{default:()=>[-5,5,-5]},cameraInitialPosition:{default:()=>[0,5,10]},legendCameraPosition:{default:()=>[2,1.5,2.5]},legendCameraLookAt:{default:()=>[0,0,0]},legendCameraFov:{default:50},autoRotateSpeed:{default:.5},cameraMoveLerp:{default:.05},cameraFocusOffset:{default:()=>[0,3,5]},deviceRotationSpeed:{default:.01},pulseBaseIntensity:{default:.3},pulseRange:{default:1.5},pulseFrequency:{default:3}},setup(e,{expose:o}){const i=e,s=a(),{camera:h,renderer:m,scene:v,controls:f}=s,{onRender:g}=t(),w=new p.Clock,y=l([]),M=l([]),b=l(null),C=l(new p.Vector3),S=l(new p.Vector3),x=l(!1),R=e=>new Promise((a,t)=>{if("model"===e.type&&e.modelUrl){return void(new n).load(e.modelUrl,t=>{const o=t.scene,n=e.modelScale||1;o.scale.set(n,n,n),a(o)},void 0,t)}const o=(i=e.color,new p.MeshStandardMaterial({color:5592405,emissive:i,emissiveIntensity:.5,roughness:.3,metalness:.8}));var i;let s;s="cube"===e.type?(e=>{const a=new p.Group,t=new p.Mesh(new p.BoxGeometry(1.2,1.2,1.2),e);a.add(t);const o=new p.Mesh(new p.BoxGeometry(1.4,1.4,1.4),new p.MeshBasicMaterial({color:e.emissive.getHex(),wireframe:!0,transparent:!0,opacity:.15}));return a.add(o),a})(o):"sphere"===e.type?(e=>{const a=new p.Group,t=new p.Mesh(new p.IcosahedronGeometry(.7,1),e);a.add(t);const o=new p.Mesh(new p.TorusGeometry(1,.05,6,30),new p.MeshBasicMaterial({color:e.emissive.getHex(),transparent:!0,opacity:.5}));return o.rotation.x=Math.PI/2,a.add(o),a})(o):(e=>{const a=new p.Group,t=new p.Mesh(new p.ConeGeometry(.6,1.5,6),e);t.position.y=.2,a.add(t);const o=new p.Mesh(new p.CylinderGeometry(.8,.8,.1,6),e);return o.position.y=-.6,a.add(o),a})(o),a(s)}),P=async()=>{const e=i.deviceConfig.map(async e=>{try{const a=await R(e),t=[];a.traverse(a=>{if(a instanceof p.Mesh){a.castShadow=!0,a.receiveShadow=!0;const o=a.material;(Array.isArray(o)?o:[o]).forEach(a=>{a instanceof p.MeshStandardMaterial&&(a.emissive&&a.emissive instanceof p.Color?a.emissive.set(e.color):a.emissive=new p.Color(e.color),a.emissiveIntensity=.5,t.push(u(a)))})}}),a.position.set(...e.position),v.value&&v.value.add(u(a));const o=new p.Vector3(...e.position);y.value.push({config:e,materials:t,mainMesh:u(a),originalPosition:o,anchorId:`anchor-${e.id}`})}catch(a){console.error(`加载模型 ${e.id} 失败`,a)}});await Promise.all(e)},F=()=>{if(!(m&&v.value&&h.value&&b.value))return;const e=w.getElapsedTime();if(x.value&&h.value instanceof p.PerspectiveCamera&&f.value){const e=f.value;h.value.position.lerp(C.value,i.cameraMoveLerp),"target"in e&&e.target instanceof p.Vector3&&e.target.lerp(S.value,i.cameraMoveLerp),h.value.position.distanceTo(C.value)<.01&&(h.value.position.copy(C.value),"target"in e&&e.target instanceof p.Vector3&&e.target.copy(S.value),x.value=!1,"autoRotate"in e&&(e.autoRotate=!0),"dampingFactor"in e&&(e.dampingFactor=.005))}if(y.value.forEach(a=>{const t=a.config.speed||1,o=.5*(Math.sin(e*i.pulseFrequency*t)+1);a.materials.forEach(e=>{e.emissiveIntensity=i.pulseBaseIntensity+o*i.pulseRange}),a.mainMesh.rotation.y+=i.deviceRotationSpeed*t}),f.value){const e=f.value;"update"in e&&"function"==typeof e.update&&e.update()}const a=m.getDrawingBufferSize(new p.Vector2);m.setViewport(0,0,a.x,a.y),m.setScissor(0,0,a.x,a.y),m.setScissorTest(!1),m.clear(),m.render(v.value,h.value),m.setScissorTest(!0),m.clearDepth(),y.value.forEach(e=>{const a=document.getElementById(e.anchorId);if(!a)return;const t=a.getBoundingClientRect(),o=m.getPixelRatio();if(t.bottom<0||t.top>window.innerHeight)return;const n=e.mainMesh.position.clone(),i=[];y.value.forEach(a=>{i.push(a.mainMesh.visible),a!==e&&(a.mainMesh.visible=!1)});const s=[];M.value.forEach(e=>{s.push(e.visible),e.visible=!1}),e.mainMesh.position.set(0,0,0),e.mainMesh.visible=!0;const r=t.width*o,l=t.height*o,c=t.left*o,d=(window.innerHeight-t.bottom)*o;m.setScissor(c,d,r,l),m.setViewport(c,d,r,l),m.render(v.value,b.value),e.mainMesh.position.copy(n),y.value.forEach((e,a)=>{e.mainMesh.visible=i[a]}),M.value.forEach((e,a)=>{e.visible=s[a]})}),m.setScissorTest(!1)};r(async()=>{await d(),(()=>{if(!v.value||!m||!h.value)return;i.sceneBackground,v.value.background=new p.Color(i.sceneBackground),"number"==typeof i.sceneFogColor?v.value.fog=new p.Fog(i.sceneFogColor,i.sceneFogRange[0],i.sceneFogRange[1]):v.value.fog=new p.Fog(new p.Color(i.sceneFogColor),i.sceneFogRange[0],i.sceneFogRange[1]),m.shadowMap&&(m.shadowMap.enabled=!0,m.shadowMap.type=p.PCFSoftShadowMap);const e=new p.PlaneGeometry(...i.groundSize),a=new p.MeshStandardMaterial({color:i.groundColor,metalness:.1,roughness:.8}),t=new p.Mesh(e,a);t.rotation.x=-Math.PI/2,t.receiveShadow=!0,v.value.add(t),M.value.push(t);const o=new p.GridHelper(i.gridSize,i.gridDivisions,i.gridColor1,i.gridColor2);v.value.add(o),M.value.push(o);const n=new p.AmbientLight(16777215,i.ambientLightIntensity);v.value.add(n);const s=new p.DirectionalLight(16777215,i.directionalLightIntensity);s.position.set(...i.directionalLightPosition),s.castShadow=!0,s.shadow.mapSize.width=2048,s.shadow.mapSize.height=2048,s.shadow.camera.near=.5,s.shadow.camera.far=50,s.shadow.camera.left=-15,s.shadow.camera.right=15,s.shadow.camera.top=15,s.shadow.camera.bottom=-15,v.value.add(s);const r=new p.PointLight(16777215,i.fillLightIntensity,20);if(r.position.set(...i.fillLightPosition),v.value.add(r),h.value instanceof p.PerspectiveCamera&&h.value.position.set(...i.cameraInitialPosition),f.value){const e=f.value;"autoRotate"in e&&(e.autoRotate=!0,e.autoRotateSpeed=i.autoRotateSpeed)}b.value=new p.PerspectiveCamera(i.legendCameraFov,1,.1,50),b.value.position.set(...i.legendCameraPosition),b.value.lookAt(...i.legendCameraLookAt)})(),await P(),g(F)}),c(()=>i.deviceConfig,async(e,a)=>{if(!a||0===a.length)return void(await P());const t=new Set(y.value.map(e=>e.config.id)),o=e.filter(e=>!t.has(e.id));if(o.length>0)for(const r of o)try{const e=await R(r),a=[];e.traverse(e=>{if(e instanceof p.Mesh){e.castShadow=!0,e.receiveShadow=!0;const t=e.material;(Array.isArray(t)?t:[t]).forEach(e=>{e instanceof p.MeshStandardMaterial&&(e.emissive&&e.emissive instanceof p.Color?e.emissive.set(r.color):e.emissive=new p.Color(r.color),e.emissiveIntensity=.5,a.push(u(e)))})}}),e.position.set(...r.position),v.value&&v.value.add(u(e));const t=new p.Vector3(...r.position);y.value.push({config:r,materials:a,mainMesh:u(e),originalPosition:t,anchorId:`anchor-${r.id}`})}catch(s){console.error(`加载模型 ${r.id} 失败`,s)}const n=new Set(e.map(e=>e.id)),i=y.value.filter(e=>!n.has(e.config.id));i.length>0&&(i.forEach(e=>{v.value&&(v.value.remove(e.mainMesh),e.mainMesh.traverse(e=>{e instanceof p.Mesh&&(e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose()))}))}),y.value=y.value.filter(e=>n.has(e.config.id)))},{deep:!0});return o({handleDeviceClick:e=>{const a=y.value.find(a=>a.config.id===e);a&&(e=>{if(!h.value||!f.value)return;const a=f.value;"autoRotate"in a&&(a.autoRotate=!1);const t=new p.Vector3(...i.cameraFocusOffset),o=e.clone().add(t);S.value.copy(e),C.value.copy(o),x.value=!0,"enableDamping"in a&&(a.enableDamping=!0,a.dampingFactor=.05)})(a.mainMesh.position)},addRandomMesh:()=>{const e=["box","sphere","cone","cylinder","torus","octahedron","tetrahedron"],a=e[Math.floor(Math.random()*e.length)],t={box:"cube",sphere:"sphere",cone:"cone",cylinder:"cube",torus:"cube",octahedron:"sphere",tetrahedron:"cone"}[a]||"cube",o=15*(Math.random()-.5),n=3*Math.random()+.5,i=15*(Math.random()-.5),s=[65535,16711765,4521728,16755200,11141375,65450,16711850],r=s[Math.floor(Math.random()*s.length)];return{id:`random-mesh-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:{box:"立方体",sphere:"球体",cone:"圆锥",cylinder:"圆柱",torus:"圆环",octahedron:"八面体",tetrahedron:"四面体"}[a]||"形状",type:t,color:r,position:[o,n,i],speed:.5+1.5*Math.random(),author:"随机生成"}}}),(e,a)=>null}}),{defineComponent:m}=await e("vue"),{toDisplayString:v,createElementVNode:f,renderList:g,Fragment:w,openBlock:y,createElementBlock:M,createTextVNode:b,normalizeStyle:C,createCommentVNode:S,unref:x,normalizeProps:R,guardReactiveProps:P,createVNode:F,Suspense:I,withCtx:k,createBlock:L,resolveComponent:E,mergeProps:A}=await e("vue"),B={class:"legend-container"},T={class:"legend-list"},V=["id","onClick"],D=["id"],$={class:"legend-info"},G={class:"item-name"},_={class:"item-status"},z={class:"item-value"},{reactive:j,ref:H,computed:N}=await e("vue"),O=i(m({__name:"legend",setup(e){const a=H([{id:"core-reactor",name:"T",type:"cube",color:65535,position:[0,0,0],speed:1,author:"Jsonco"},{id:"sensor-array",name:"V",type:"sphere",color:16711765,position:[-4,0,2],speed:1.5,author:"Jsonco"},{id:"storage-unit",name:"T",type:"cone",color:4521728,position:[4,0,-2],speed:.8,author:"Jsonco"}]),t=j({windowSize:!0,alpha:!0,antialias:!0}),n=j({enableDamping:!0,enableZoom:!0,enablePan:!0,enableRotate:!0,makeDefault:!0,autoRotate:!0,autoRotateSpeed:.5}),i=H(null),s={top:"20px",right:"20px"},r=N(()=>{const e=s||{};return{top:e&&"number"==typeof e.top?`${e.top}px`:e?.top||"20px",right:e&&"number"==typeof e.right?`${e.right}px`:e?.right||"20px",bottom:e&&"number"==typeof e.bottom?`${e.bottom}px`:e?.bottom||void 0,left:e&&"number"==typeof e.left?`${e.left}px`:e?.left||void 0,width:"220px"}}),l=()=>{if(i.value){const e=i.value.addRandomMesh();e&&a.value.push(e)}};return(e,s)=>{const c=E("TresCanvas");return y(),M("div",B,[f("div",{class:"legend-panel",style:C(r.value)},[f("div",{class:"legend-header"},[f("span",{class:"legend-title"},v("图例")),f("button",{class:"add-mesh-btn",onClick:l},[...s[0]||(s[0]=[f("span",{class:"btn-icon"},"+",-1),f("span",{class:"btn-text"},"添加随机形状",-1)])])]),f("div",T,[(y(!0),M(w,null,g(a.value,e=>(y(),M("div",{key:e.id,id:`item-${e.id}`,class:"legend-item",onClick:a=>{return t=e.id,void(i.value&&i.value.handleDeviceClick(t));var t}},[f("div",{id:`anchor-${e.id}`,class:"legend-icon-anchor"},null,8,D),f("div",$,[f("span",G,v(e.name),1),f("span",_,[s[1]||(s[1]=b(" Author: ",-1)),f("span",z,v(e.author),1)])]),e.color?(y(),M("div",{key:0,class:"corner-deco",style:C({borderColor:`#${e.color.toString(16).padStart(6,"0")}`})},null,4)):S("",!0)],8,V))),128))])],4),F(c,A({clearColor:"#1A1A1A"},t),{default:k(()=>[s[2]||(s[2]=f("TresPerspectiveCamera",{fov:60,near:.1,far:1e3,position:[0,5,10]},null,-1)),s[3]||(s[3]=f("TresAmbientLight",{intensity:.8},null,-1)),F(x(o),R(P(n)),null,16),(y(),L(I,null,{default:k(()=>[F(h,{ref_key:"legendRef",ref:i,"device-config":a.value},null,8,["device-config"])]),_:1}))]),_:1},16)])}}}),[["__scopeId","data-v-bd9b39fa"]]);export{O as default};
