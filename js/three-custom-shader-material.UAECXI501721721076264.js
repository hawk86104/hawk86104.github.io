import{o as e}from"./object-hash.n-lQHd521721721076264.js";import{h as n,aT as t}from"./three.fnkrvySq1721721076264.js";import{t as r}from"./glsl-tokenizer.rVSxTaVo1721721076264.js";import{s as a}from"./glsl-token-string.qKZvKI-H1721721076264.js";import{t as i}from"./glsl-token-functions.nzsekdRK1721721076264.js";import"./@amap.b3gYyCW_1721721076264.js";function o(e){var n=function(e,n){if("object"!=typeof e||null===e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,n||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(e)}(e,"string");return"symbol"==typeof n?n:String(n)}function c(e,n,t){return(n=o(n))in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function f(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){c(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}function m(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,o(r.key),r)}}function u(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function d(e,n){return(d=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,n){return e.__proto__=n,e})(e,n)}function _(e){return(_=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function h(e){var n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var t,r=_(e);if(n){var a=_(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return function(e,n){if(n&&("object"==typeof n||"function"==typeof n))return n;if(void 0!==n)throw new TypeError("Derived constructors may only return object or undefined");return u(e)}(this,t)}}var p,M,v,S="csm_Position",g="csm_PositionRaw",y="csm_PointSize",E="csm_FragColor",b="csm_DiffuseColor",A="csm_Normal",O="csm_Roughness",I="csm_Metalness",C="csm_Emissive",D="csm_AO",j="csm_Bump",P="csm_DepthAlpha",T=(c(p={},"".concat(A),{"#include <beginnormal_vertex>":"\n    vec3 objectNormal = ".concat(A,";\n    #ifdef USE_TANGENT\n\t    vec3 objectTangent = vec3( tangent.xyz );\n    #endif\n    ")}),c(p,"".concat(S),{"#include <begin_vertex>":"\n    vec3 transformed = ".concat(S,";\n  ")}),c(p,"".concat(g),{"#include <begin_vertex>":"\n    vec4 csm_internal_positionUnprojected = ".concat(g,";\n    mat4x4 csm_internal_unprojectMatrix = projectionMatrix * modelViewMatrix;\n    #ifdef USE_INSTANCING\n      csm_internal_unprojectMatrix = csm_internal_unprojectMatrix * instanceMatrix;\n    #endif\n    csm_internal_positionUnprojected = inverse(csm_internal_unprojectMatrix) * csm_internal_positionUnprojected;\n    vec3 transformed = csm_internal_positionUnprojected.xyz;\n  ")}),c(p,"".concat(y),{"gl_PointSize = size;":"\n    gl_PointSize = ".concat(y,";\n    ")}),c(p,"".concat(b),{"#include <color_fragment>":"\n    #include <color_fragment>\n    diffuseColor = ".concat(b,";\n  ")}),c(p,"".concat(E),{"#include <dithering_fragment>":"\n    #include <dithering_fragment>\n    gl_FragColor  = ".concat(E,";\n  ")}),c(p,"".concat(C),{"vec3 totalEmissiveRadiance = emissive;":"\n    vec3 totalEmissiveRadiance = ".concat(C,";\n    ")}),c(p,"".concat(O),{"#include <roughnessmap_fragment>":"\n    #include <roughnessmap_fragment>\n    roughnessFactor = ".concat(O,";\n    ")}),c(p,"".concat(I),{"#include <metalnessmap_fragment>":"\n    #include <metalnessmap_fragment>\n    metalnessFactor = ".concat(I,";\n    ")}),c(p,"".concat(D),{"#include <aomap_fragment>":"\n    #include <aomap_fragment>\n    reflectedLight.indirectDiffuse *= 1. - ".concat(D,";\n    ")}),c(p,"".concat(j),{"#include <normal_fragment_maps>":"\n    #include <normal_fragment_maps>\n\n    vec3 csm_internal_orthogonal = ".concat(j," - (dot(").concat(j,", normal) * normal);\n    vec3 csm_internal_projectedbump = mat3(csm_internal_vModelViewMatrix) * csm_internal_orthogonal;\n    normal = normalize(normal - csm_internal_projectedbump);\n    ")}),c(p,"".concat(P),{"gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );":"\n      gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity * ".concat(P," );\n    "),"gl_FragColor = packDepthToRGBA( fragCoordZ );":"\n      gl_FragColor = packDepthToRGBA( fragCoordZ );\n      gl_FragColor.a *= ".concat(P,";\n    ")}),p),R=(c(M={},"".concat(S),{"gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );":"\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( ".concat(S,", 1.0 );\n  ")}),c(M,"".concat(g),{"gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );":"\n    gl_Position = ".concat(S,";\n  ")}),c(M,"".concat(b),{"gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );":"\n    gl_FragColor = ".concat(b,";\n  ")}),c(M,"".concat(E),{"gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );":"\n    gl_FragColor = ".concat(E,";\n  ")}),M),x=(c(v={},"".concat(S),"*"),c(v,"".concat(g),"*"),c(v,"".concat(A),"*"),c(v,"".concat(y),["PointsMaterial"]),c(v,"".concat(b),"*"),c(v,"".concat(E),"*"),c(v,"".concat(C),["MeshStandardMaterial","MeshPhysicalMaterial"]),c(v,"".concat(O),["MeshStandardMaterial","MeshPhysicalMaterial"]),c(v,"".concat(I),["MeshStandardMaterial","MeshPhysicalMaterial"]),c(v,"".concat(D),["MeshStandardMaterial","MeshPhysicalMaterial","MeshBasicMaterial","MeshLambertMaterial","MeshPhongMaterial","MeshToonMaterial"]),c(v,"".concat(j),["MeshLambertMaterial","MeshMatcapMaterial","MeshNormalMaterial","MeshPhongMaterial","MeshPhysicalMaterial","MeshStandardMaterial","MeshToonMaterial","ShadowMaterial"]),c(v,"".concat(P),"*"),v),w=["baseMaterial","fragmentShader","vertexShader","uniforms","patchMap","cacheKey","silent"];function N(e){return e.replace(/\s/g,"")}var L=function(o){!function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),n&&d(e,n)}(M,t);var c,s,_,p=h(M);function M(e){var t,r,a,i,o=e.baseMaterial,c=e.fragmentShader,s=e.vertexShader,m=e.uniforms,d=e.patchMap,_=e.cacheKey,h=e.silent,v=l(e,w);if(function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,M),!function(e){try{new e}catch(n){if(n.message.indexOf("is not a constructor")>=0)return!1}return!0}(o)?(r=o,Object.assign(r,v)):r=new o(v),"RawShaderMaterial"===r.type)throw new Error("CustomShaderMaterial does not support RawShaderMaterial");(function(e,n){var t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];Object.assign(e,n);var r=Object.getPrototypeOf(n);Object.entries(Object.getOwnPropertyDescriptors(r)).filter((function(e){var n="function"==typeof e[1].get,t="function"==typeof e[1].set,r="function"==typeof e[1].value,a="constructor"===e[0];return(n||t||r)&&!a})).forEach((function(n){if("function"!=typeof e[n[0]])Object.defineProperty(e,n[0],n[1]);else{t||console.warn("Function ".concat(n[0]," already exists on CSM, renaming to base_").concat(n[0]));var r="base_".concat(n[0]);e[r]=n[1].value.bind(e)}}))})(u(t=p.call(this)),r,h),t.__csm={patchMap:d||{},fragmentShader:c||"",vertexShader:s||"",cacheKey:_,baseMaterial:o,instanceID:n.generateUUID(),type:r.type,isAlreadyExtended:(a=r.onBeforeCompile,i=a.toString().trim(),!(0===i.substring(i.indexOf("{")+1,i.lastIndexOf("}")).trim().length)),cacheHash:"",silent:h},t.uniforms=f(f({},t.uniforms||{}),m||{});var S=t.__csm,g=S.fragmentShader,y=S.vertexShader,E=t.uniforms;return t.__csm.cacheHash=t.getCacheHash(),t.generateMaterial(g,y,E),t}return c=M,s=[{key:"update",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.uniforms=e.uniforms||this.uniforms,Object.assign(this.__csm,e);var n=this.__csm,t=n.fragmentShader,r=n.vertexShader,a=this.uniforms,i=this.getCacheHash();this.__csm.cacheHash=i,this.generateMaterial(t,r,a)}},{key:"clone",value:function(){var e={baseMaterial:this.__csm.baseMaterial,fragmentShader:this.__csm.fragmentShader,vertexShader:this.__csm.vertexShader,uniforms:this.uniforms,silent:this.__csm.silent,patchMap:this.__csm.patchMap,cacheKey:this.__csm.cacheKey},n=new this.constructor(e);return Object.assign(this,n),n}},{key:"getCacheHash",value:function(){var n=this.__csm,t=n.fragmentShader,r=n.vertexShader,a=this.uniforms,i=Object.values(a).reduce((function(e,n){var t=n.value;return e+JSON.stringify(t)}),""),o=N(t)+N(r)+i;return o.trim().length>0?e(o):this.customProgramCacheKey()}},{key:"generateMaterial",value:function(e,n,t){var r=this,a=this.parseShader(e),i=this.parseShader(n);this.uniforms=t||{},this.customProgramCacheKey=function(){return r.__csm.cacheHash};var o=function(e){try{if(a){var n=r.patchShader(a,e.fragmentShader,!0);e.fragmentShader=r.getMaterialDefine()+n}if(i){var t=r.patchShader(i,e.vertexShader);e.vertexShader="#define IS_VERTEX;\n"+t,e.vertexShader=r.getMaterialDefine()+e.vertexShader}e.uniforms=f(f({},e.uniforms),r.uniforms),r.uniforms=e.uniforms}catch(o){console.error(o)}};if(this.__csm.isAlreadyExtended){var c=this.onBeforeCompile;this.onBeforeCompile=function(e,n){c(e,n),o(e)}}else this.onBeforeCompile=o;this.needsUpdate=!0}},{key:"patchShader",value:function(e,n,t){var r=this,a=n,i=f(f({},this.getPatchMapForMaterial()),this.__csm.patchMap);Object.keys(i).forEach((function(n){Object.keys(i[n]).forEach((function(t){var o,c,s=x[n],f=r.__csm.type;if("*"===n||(o=e.main,new RegExp("\\b".concat((c=n,c.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")),"\\b")).test(o))){if(!(!s||Array.isArray(s)&&s.includes(f)||"*"===s))throw new Error("CSM: ".concat(n," is not available in ").concat(f,". Shader cannot compile."));a=function(e,n,t){return e.split(n).join(t)}(a,t,i[n][t])}}))})),a=a.replace("void main() {","\n        #ifndef CSM_IS_HEAD_DEFAULTS_DEFINED\n          ".concat("\n    varying mat4 csm_internal_vModelViewMatrix;\n","\n          #define CSM_IS_HEAD_DEFAULTS_DEFINED 1\n        #endif\n\n        ").concat(e.header,"\n        \n        void main() {\n          #ifndef CSM_IS_DEFAULTS_DEFINED\n            ").concat("\n\n#ifdef IS_VERTEX\n    // csm_Position & csm_PositionRaw\n    #ifdef IS_UNKNOWN\n        vec3 csm_Position = vec3(0.0);\n        vec4 csm_PositionRaw = vec4(0.0);\n        vec3 csm_Normal = vec3(0.0);\n    #else\n        vec3 csm_Position = position;\n        vec4 csm_PositionRaw = projectionMatrix * modelViewMatrix * vec4(position, 1.);\n        vec3 csm_Normal = normal;\n    #endif\n\n    // csm_PointSize\n    #ifdef IS_POINTSMATERIAL\n        float csm_PointSize = size;\n    #endif\n#else\n    // csm_DiffuseColor & csm_FragColor\n    #if defined IS_UNKNOWN || defined IS_SHADERMATERIAL || defined IS_MESHDEPTHMATERIAL || defined IS_MESHNORMALMATERIAL || defined IS_SHADOWMATERIAL\n        vec4 csm_DiffuseColor = vec4(1.0, 0.0, 1.0, 1.0);\n        vec4 csm_FragColor = vec4(1.0, 0.0, 1.0, 1.0);\n    #else\n        #ifdef USE_MAP\n            vec4 _csm_sampledDiffuseColor = texture2D(map, vMapUv);\n\n            #ifdef DECODE_VIDEO_TEXTURE\n            // inline sRGB decode (TODO: Remove this code when https://crbug.com/1256340 is solved)\n            _csm_sampledDiffuseColor = vec4(mix(pow(_csm_sampledDiffuseColor.rgb * 0.9478672986 + vec3(0.0521327014), vec3(2.4)), _csm_sampledDiffuseColor.rgb * 0.0773993808, vec3(lessThanEqual(_csm_sampledDiffuseColor.rgb, vec3(0.04045)))), _csm_sampledDiffuseColor.w);\n            #endif\n\n            vec4 csm_DiffuseColor = vec4(diffuse, opacity) * _csm_sampledDiffuseColor;\n            vec4 csm_FragColor = vec4(diffuse, opacity) * _csm_sampledDiffuseColor;\n        #else\n            vec4 csm_DiffuseColor = vec4(diffuse, opacity);\n            vec4 csm_FragColor = vec4(diffuse, opacity);\n        #endif\n    #endif\n\n    // csm_Emissive, csm_Roughness, csm_Metalness\n    #if defined IS_MESHSTANDARDMATERIAL || defined IS_MESHPHYSICALMATERIAL\n        vec3 csm_Emissive = emissive;\n        float csm_Roughness = roughness;\n        float csm_Metalness = metalness;\n    #endif\n\n    // csm_AO\n    #if defined IS_MESHSTANDARDMATERIAL || defined IS_MESHPHYSICALMATERIAL || defined IS_MESHBASICMATERIAL || defined IS_MESHLAMBERTMATERIAL || defined IS_MESHPHONGMATERIAL || defined IS_MESHTOONMATERIAL\n        float csm_AO = 0.0;\n    #endif\n\n    // csm_Bump\n    #if defined IS_MESHLAMBERTMATERIAL || defined IS_MESHMATCAPMATERIAL || defined IS_MESHNORMALMATERIAL || defined IS_MESHPHONGMATERIAL || defined IS_MESHPHYSICALMATERIAL || defined IS_MESHSTANDARDMATERIAL || defined IS_MESHTOONMATERIAL || defined IS_SHADOWMATERIAL \n        vec3 csm_Bump = vec3(0.0);\n    #endif\n\n    float csm_DepthAlpha = 1.0;\n#endif\n","\n            #define CSM_IS_DEFAULTS_DEFINED 1\n          #endif\n          \n          #ifndef CSM_IS_MAIN_DEFAULTS_DEFINED\n            ").concat(t?"\n    \n":"\n    csm_internal_vModelViewMatrix = modelViewMatrix;\n","\n            #define CSM_IS_MAIN_DEFAULTS_DEFINED 1\n          #endif\n\n          // CSM_START\n      "));var o,c,s,l,m=this.__csm.isAlreadyExtended,u=a.includes("// CSM_END");return m&&u?(o=a,c="// CSM_END",s="\n          // CSM_END\n          ".concat(e.main,"\n          // CSM_END\n        "),l=o.lastIndexOf(c),a=-1===l?o:o.substring(0,l)+s+o.substring(l+c.length)):a=a.replace("// CSM_START","\n        // CSM_START\n        ".concat(e.main,"\n        // CSM_END\n          ")),a=e.defines+a}},{key:"parseShader",value:function(e){if(e){var n=e.replace(/\/\*\*(.*?)\*\/|\/\/(.*?)\n/gm,""),t=r(n),o=i(t),c=o.map((function(e){return e.name})).indexOf("main");return{defines:"",header:a(t.slice(0,c>=0?o[c].outer[0]:void 0)),main:c>=0?this.getShaderFromIndex(t,o[c].body):""}}}},{key:"getMaterialDefine",value:function(){var e=this.__csm.type;return e?"#define IS_".concat(e.toUpperCase(),";\n"):"#define IS_UNKNOWN;\n"}},{key:"getPatchMapForMaterial",value:function(){return"ShaderMaterial"===this.__csm.type?R:T}},{key:"getShaderFromIndex",value:function(e,n){return a(e.slice(n[0],n[1]))}}],s&&m(c.prototype,s),_&&m(c,_),Object.defineProperty(c,"prototype",{writable:!1}),M}();export{L as C};
