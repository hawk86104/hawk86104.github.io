import{importShared as v}from"./3d-tiles-renderer.DZNovkLO1767148983502.js";import{Pane as j}from"./tweakpane.BQRZXf8M1767148983502.js";import{_sfc_main as H}from"./pagesShow.vue_vue_type_script_setup_true_lang.Crq63Xp41767148983502.js";import{no as J,Fs as K,_l as X}from"./index.DTe2qqjO1767148983502.js";const E=(f,e)=>{"updateRanges"in f?f.updateRanges[0]=e:f.updateRange=e},{Group:G,PlaneGeometry:Y,InstancedBufferAttribute:D,DynamicDrawUsage:F,InstancedMesh:Z,Quaternion:U,Vector3:w,MeshLambertMaterial:ee,Color:I,Matrix4:L,REVISION:te}=await v("three"),R=new L,V=new w,z=new U,N=new w,P=new U,B=new w,ne=f=>class extends f{constructor(){super();const e=parseInt(te.replace(/\D+/g,""))>=154?"opaque_fragment":"output_fragment";this.onBeforeCompile=n=>{n.vertexShader=`attribute float cloudOpacity;
               varying float vOpacity;
              `+n.vertexShader.replace("#include <fog_vertex>",`#include <fog_vertex>
                 vOpacity = cloudOpacity;
                `),n.fragmentShader=`varying float vOpacity;
              `+n.fragmentShader.replace(`#include <${e}>`,`#include <${e}>
                 gl_FragColor = vec4(outgoingLight, diffuseColor.a * vOpacity);
                `)}}};class oe extends G{constructor({limit:e=200,range:n,material:s=ee,texture:a,frustumCulled:h=!0}={}){super(),this.name="Clouds",this.ref=this;const C=this,g=new Y(1,1),l=new Float32Array(Array.from({length:e},()=>1)),y=new Float32Array(Array.from({length:e},()=>[1,1,1]).flat()),b=new D(l,1);b.setUsage(F),g.setAttribute("cloudOpacity",b);const _=ne(s),c=new _;c.map=a,c.transparent=!0,c.depthWrite=!1,c.needsUpdate=!0,this.cloudMaterial=c,this.instance=new Z(g,c,e);const i=this.instance;i.matrixAutoUpdate=!1,i.frustumCulled=h,i.instanceColor=new D(y,3),i.instanceColor.setUsage(F),C.add(i);const p=[],x=()=>{const d=p.length;let O=0;for(let m=0;m<this.ref.children.length;m++){const u=this.ref.children[m];u.cloudStateArray&&(O+=u.cloudStateArray.length)}if(d===O)return p;p.length=0;for(let m=0;m<this.ref.children.length;m++){const u=this.ref.children[m];u.cloudStateArray&&p.push(...u.cloudStateArray)}return t(),p},t=()=>{const d=Math.min(e,n!==void 0?n:e,p.length);i.count=d,E(i.instanceMatrix,{offset:0,count:d*16}),i.instanceColor&&E(i.instanceColor,{offset:0,count:d*3}),E(i.geometry.attributes.cloudOpacity,{offset:0,count:d})};let k=0,r=0,o;const M=new U,A=new w(0,0,1),S=new w;this.update=(d,O,m)=>{k=O,R.copy(i.matrixWorld).invert(),d.matrixWorld.decompose(N,P,B);const u=x();for(r=0;r<u.length;r++)o=u[r],o.ref.matrixWorld.decompose(V,z,B),V.add(S.copy(o.position).applyQuaternion(z).multiply(B)),z.copy(P).multiply(M.setFromAxisAngle(A,o.rotation+=m*o.rotationFactor)),B.multiplyScalar(o.volume+(1+Math.sin(k*o.density*o.speed))/2*o.growth),o.matrix.compose(V,z,B).premultiply(R),o.dist=V.distanceTo(N);for(u.sort((Q,T)=>T.dist-Q.dist),r=0;r<u.length;r++)o=u[r],l[r]=o.opacity*(o.dist<o.fade-1?o.dist/o.fade:1),i.setMatrixAt(r,o.matrix),i.setColorAt(r,o.color);i.geometry.attributes.cloudOpacity.needsUpdate=!0,i.instanceMatrix.needsUpdate=!0,i.instanceColor&&(i.instanceColor.needsUpdate=!0)}}}let ae=0;class W extends G{constructor({opacity:e=1,speed:n=0,bounds:s=new w().fromArray([5,1,1]),segments:a=20,color:h=new I("#ffffff"),fade:C=10,volume:g=6,smallestVolume:l=.25,distribute:y=null,growth:b=4,concentrate:_="inside",seed:c=Math.random()}={}){super(),this.name="cloud_"+ae++,this.seed=c,this.segments=a,this.bounds=s,this.concentrate=_,this.volume=g,this.smallestVolume=l,this.distribute=y,this.growth=b,this.speed=n,this.fade=C,this.opacity=e,this.color=h,this.ref=this,this.cloudStateArray=[],this.updateCloud()}updateCloudStateArray(){if(this.cloudStateArray.length===this.segments)return;const{segments:e,uuid:n}=this;if(this.cloudStateArray.length>this.segments)this.cloudStateArray.splice(0,this.cloudStateArray.length-this.segments);else for(let s=this.cloudStateArray.length;s<e;s++)this.cloudStateArray.push({segments:e,bounds:new w(1,1,1),position:new w,uuid:n,index:s,ref:this,dist:0,matrix:new L,volume:0,length:0,speed:0,growth:0,opacity:1,fade:0,density:0,rotation:s*(Math.PI/e),rotationFactor:0,color:new I})}updateCloud(){const{volume:e,color:n,speed:s,growth:a,opacity:h,fade:C,bounds:g,seed:l,cloudStateArray:y,distribute:b,segments:_,concentrate:c,smallestVolume:i}=this;this.updateCloudStateArray();let p=0;function x(){const t=Math.sin(l+p)*1e4;return p++,t-Math.floor(t)}y.forEach((t,k)=>{t.segments=_,t.volume=e,t.color=n,t.speed=s,t.growth=a,t.opacity=h,t.fade=C,t.bounds.copy(g),t.density=Math.max(.5,x()),t.rotationFactor=Math.max(.2,.5*x())*s;const r=b?.(t,k);if(r||_>1){var o;t.position.copy(t.bounds).multiply((o=r?.point)!==null&&o!==void 0?o:{x:x()*2-1,y:x()*2-1,z:x()*2-1})}const M=Math.abs(t.position.x),A=Math.abs(t.position.y),S=Math.abs(t.position.z),d=Math.max(M,A,S);t.length=1,M===d&&(t.length-=M/t.bounds.x),A===d&&(t.length-=A/t.bounds.y),S===d&&(t.length-=S/t.bounds.z),t.volume=(r?.volume!==void 0?r.volume:Math.max(Math.max(0,i),c==="random"?x():c==="inside"?t.length:1-t.length))*e})}}const{defineComponent:se}=await v("vue"),{openBlock:ie,createElementBlock:re,createCommentVNode:le}=await v("vue"),de=["object"],{watch:$,watchEffect:ce,ref:ue,toRaw:fe}=await v("vue"),q=await v("three"),pe=se({__name:"cloudsMesh",props:{color:{default:"#ffffff"},segments:{default:20},volume:{default:6},opacity:{default:1},seed:{default:0},fade:{default:10},growth:{default:4},speed:{default:0},bounds:{default:{x:5,y:1,z:1}}},setup(f){const e=f,{state:n}=J("./plugins/digitalCity/image/cloud.png"),s=ue(null),a=new W({color:new q.Color(e.color)}),h=new W({color:new q.Color("pink")});h.position.set(20,0,10);const{camera:C}=K(),{onBeforeRender:g}=X();return g(({delta:l,elapsed:y})=>{s.value?.update(C.value,y,l)}),$(()=>n.value,l=>{s.value=new oe({texture:l}),s.value.add(a),s.value.add(h)}),$(()=>e.color,l=>{a.color.set(l)}),ce(()=>{e.segments&&(a.segments=e.segments),e.volume&&(a.volume=e.volume),e.opacity&&(a.opacity=e.opacity),e.seed&&(a.seed=e.seed),e.fade&&(a.fade=e.fade),e.growth&&(a.growth=e.growth),e.speed&&(a.speed=e.speed),e.bounds&&(a.bounds.x=e.bounds.x,a.bounds.y=e.bounds.y,a.bounds.z=e.bounds.z),a.updateCloud()}),(l,y)=>s.value?(ie(),re("primitive",{key:0,object:fe(s.value),renderOrder:3e3},null,8,de)):le("",!0)}}),{defineComponent:me}=await v("vue"),{createElementVNode:he,mergeProps:ge,createVNode:ye,withCtx:xe,openBlock:we,createBlock:ve}=await v("vue"),{reactive:Ce}=await v("vue"),Se=me({__name:"clouds2",setup(f){const e=Ce({color:"#ffffff",segments:20,volume:6,opacity:1,seed:0,fade:10,growth:4,speed:0,bounds:{x:5,y:1,z:1}}),n=new j({title:"云彩效果",expanded:!0});return n.addBinding(e,"color",{label:"颜色"}),n.addBinding(e,"seed",{label:"seed",min:0,max:100,step:.1}),n.addBinding(e,"segments",{label:"segments",min:1,max:80,step:.1}),n.addBinding(e,"volume",{label:"volume",min:0,max:100,step:.1}),n.addBinding(e,"opacity",{label:"opacity",min:0,max:1,step:.01}),n.addBinding(e,"fade",{label:"fade",min:0,max:4e3,step:10}),n.addBinding(e,"growth",{label:"growth",min:0,max:20,step:.1}),n.addBinding(e,"speed",{label:"speed",min:0,max:1,step:.01}),n.addBinding(e,"bounds",{x:{min:0,max:25},y:{min:0,max:25},z:{min:0,max:25}}),(s,a)=>(we(),ve(H,null,{ability:xe(()=>[a[0]||(a[0]=he("TresDirectionalLight",{position:[200,100,0],intensity:1.5,color:"#ffffff"},null,-1)),ye(pe,ge({position:[10,200,0],scale:20},e),null,16)]),_:1}))}});export{Se as default};
