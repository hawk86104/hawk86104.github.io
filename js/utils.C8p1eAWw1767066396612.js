import{i as t}from"./3d-tiles-renderer.CbgZh8zU1767066396612.js";import{T as o,E as e}from"./@tweenjs.C9YEcV0Y1767066396612.js";import{l as a}from"./utils.DguR31dd1767066396612.js";import{m as r}from"./d3-geo.C51lZA-81767066396612.js";const n=await t("three"),s=(t,a,r,n=1e3)=>{const s=t.value.position.clone(),i=r.value.target.clone(),l=a.clone(),c=a.clone();c.y=0;const u=new o({x:s.x,y:s.y,z:s.z,lookAtX:i.x,lookAtY:i.y,lookAtZ:i.z}).to({x:l.x,y:l.y,z:l.z,lookAtX:c.x,lookAtY:c.y,lookAtZ:c.z},n).easing(e.Quadratic.InOut).onUpdate(o=>{t.value.position.set(o.x,o.y,o.z),r.value.target.set(o.lookAtX,o.lookAtY,o.lookAtZ)}).start().onComplete(()=>{u.stop()});return u},i=(t,a,r,n=[-2e3,-2e3],s=1e3)=>{const i=t.position.clone(),l=r.target.clone(),c=a.clone(),u=a.clone();u.y=0,u.x=u.x+n[0],u.z=u.z+n[1];const p=new o({x:i.x,y:i.y,z:i.z,lookAtX:l.x,lookAtY:l.y,lookAtZ:l.z}).to({x:c.x,y:c.y,z:c.z,lookAtX:u.x,lookAtY:u.y,lookAtZ:u.z},s).easing(e.Quadratic.InOut).onUpdate(o=>{t.position.set(o.x,o.y,o.z),r.target.set(o.lookAtX,o.lookAtY,o.lookAtZ)}).start().onComplete(()=>{p.stop()});return p},l=async t=>{const o=await a(t),e=r().center(o[0].properties.center).translate([0,0]).scale(1e3),n=[];return o[0].geometry.coordinates[0].forEach(t=>{t.forEach(t=>{const[o,a]=e(t);n.push([o,0,a])})}),n},c=(t,o=!0,e=!0)=>{if(o||e){const a=new n.Matrix4;o&&a.multiply(t.userData.tilesData.rotationMatrix),e&&a.multiply(t.userData.tilesData.translationMatrix),t.matrixAutoUpdate=!1,t.matrix.identity(),t.matrix.copy(a)}else t.matrix.copy(t.userData.tilesData.initialMatrix);t.updateMatrixWorld(!0)},u=(t,o=!0,e=!0)=>{t.group.userData.tilesData={initialMatrix:t.group.matrix.clone()};const a=new n.Box3,r=new n.Sphere,s=new n.Vector3;if(t.getBoundingBox(a))a.getCenter(s);else{if(!t.getBoundingSphere(r))return void console.warn("tiles 没有 bounding 信息");s.copy(r.center)}const{east:i,north:l,up:u}=(t=>{const o=t.x,e=t.y;t.z;const a=Math.atan2(e,o),r=t.clone().normalize(),s=new n.Vector3(-Math.sin(a),Math.cos(a),0),i=r.clone().multiplyScalar(s.dot(r));return s.sub(i).normalize(),{east:s,north:(new n.Vector3).crossVectors(r,s).normalize(),up:r}})(s),p=(new n.Matrix4).makeBasis(i,l,u).clone().transpose();t.group.userData.tilesData.rotationMatrix=p.clone();const x=(new n.Matrix4).makeTranslation(-s.x,-s.y,-s.z);t.group.userData.tilesData.translationMatrix=x.clone(),c(t.group,o,e)},p=async t=>{if(!t.toLowerCase().endsWith(".json"))return!1;try{const o=await fetch(t);if(!o.ok)return!1;const e=await o.json(),a="object"==typeof e.asset&&void 0!==e.geometricError&&"object"==typeof e.root,r="1.0"===e.asset?.version||"1.1"===e.asset?.version;return a&&r}catch(o){return console.error("❌ 验证失败:",o),!1}};export{c as a,u as b,s as c,i as f,l as g,p as i};
