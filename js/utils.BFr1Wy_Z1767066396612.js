import{i as e}from"./3d-tiles-renderer.CbgZh8zU1767066396612.js";import"./@fesjs.BK66sTPr1767066396612.js";import{J as s}from"./jszip.B4-qMbOM1767066396612.js";import{F as a}from"./file-saver.b9R696E81767066396612.js";const t=await e("three");async function r(e){const s=new t.FileLoader;return new Promise((a,t)=>{s.load(e,e=>a(JSON.parse(e)),void 0,e=>t(e))})}t.Cache.enabled=!0;class i extends t.Loader{constructor(e){super(e)}load(e,s,a,r){const i=new t.FileLoader(this.manager);i.setResponseType("json"),i.load(e,e=>s&&s(e),a,r)}}async function n(e){const s=new t.FileLoader;return new Promise((a,t)=>{s.setResponseType("blob"),s.load(e,s=>{const r=new FileReader;r.onloadend=()=>{const s=function(e){return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",bmp:"image/bmp",webp:"image/webp"}[e.split(".").pop().toLowerCase()]||"application/octet-stream"}(e),t=r.result.split(",")[1];a(`data:${s};base64,${t}`)},r.onerror=e=>{t(e)},r.readAsDataURL(s)},void 0,e=>t(e))})}class o extends t.Loader{constructor(e){super(e)}load(e,a,r,i){const n=new t.FileLoader(this.manager);n.setResponseType("blob"),n.load(e,async e=>{try{const t=await s.loadAsync(e);a&&a(t)}catch(t){i&&i(t)}},r,i)}}const l=e=>{const s=e.substring(0,15);return"data:image/jpeg;base64,".startsWith(s)||"data:image/JPEG;base64,".startsWith(s)?"JPEG":"data:image/png;base64,".startsWith(s)||"data:image/PNG;base64,".startsWith(s)?"PNG":"data:image/gif;base64,".startsWith(s)||"data:image/GIF;base64,".startsWith(s)?"GIF":"data:image/webp;base64,".startsWith(s||"data:image/WEBP;base64,".startsWith(s))?"WEBP":"Unknown"},c=e=>{const t=[];e.scene.geometries&&e.scene.geometries.forEach(e=>{"BufferGeometry"===e.type&&(t.push({uuid:e.uuid,data:e.data}),e.data=`url:geometries/${e.uuid}.json`)});const r=[];e.scene.images&&e.scene.images.forEach(e=>{e.url&&(r.push({uuid:e.uuid,url:e.url}),e.url.type?e.url=`url:images/${e.uuid}.${e.url.type}.json`:e.url=`url:images/${e.uuid}.${l(e.url)}`)});const i=new s;if(t.length){const e=i.folder("geometries");t.forEach(s=>{e.file(`${s.uuid}.json`,JSON.stringify(s.data))})}if(r.length){const e=i.folder("images");r.forEach(s=>{s.url.type?e.file(`${s.uuid}.${s.url.type}.json`,JSON.stringify(s.url)):e.file(`${s.uuid}.${l(s.url)}`,s.url.split(";base64,").pop(),{base64:!0})})}const n=JSON.stringify(e);return i.file("app.json",n),i.generateAsync({type:"blob"}).then(e=>{a.saveAs(e,"config.zip")})},g=(e,s,a)=>{e.geometries<=0&&e.images<=0&&a(s)},u=(e,a)=>{let t=null;return s.loadAsync(e).then(e=>{e.files["app.json"]?e.files["app.json"].async("string").then(s=>{t=JSON.parse(s);const r=(e=>{const s={geometries:0,images:0};return e.scene.geometries?.forEach(e=>{e.data?.startsWith("url:")&&s.geometries++}),e.scene.images?.forEach(e=>{e.url.startsWith("url:")&&s.images++}),s})(t);g(r,t,a),t.scene.geometries?.forEach(s=>{s.data?.startsWith("url:")&&e.files[s.data.slice(4)].async("string").then(e=>{s.data=JSON.parse(e),r.geometries--,g(r,t,a)})}),t.scene.images?.forEach(s=>{if(s.url.startsWith("url:")){const i=s.url.slice(4);i.endsWith(".json")?e.files[i].async("string").then(e=>{s.url=JSON.parse(e),r.images--,g(r,t,a)}):e.files[i].async("base64").then(e=>{const n=i.split("."),o=n[n.length-1].toUpperCase();s.url=`data:image/${o};base64,${e}`,r.images--,g(r,t,a)})}})}):console.error("非标准文件：不存在 app.json")},s=>{console.error(`${e.name}: ${s.message}`)}),t};export{i as J,o as Z,n as a,c as e,l as g,u as i,r as l};
