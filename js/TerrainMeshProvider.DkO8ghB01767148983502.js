import{importShared as k}from"./3d-tiles-renderer.DZNovkLO1767148983502.js";import{computeBoundsTree as ot,disposeBoundsTree as nt,acceleratedRaycast as at}from"./ExtensionUtilities.2O-yyDsQ1767148983502.js";import{B as ht}from"./three-custom-shader-material.es.DIiohWIA1767148983502.js";const ct=Math.PI/180,lt=180/Math.PI;function L(i,t){return i/Math.pow(2,t)*360-180}function G(i,t){const r=Math.PI-2*Math.PI*i/Math.pow(2,t);return lt*Math.atan(.5*(Math.exp(r)-Math.exp(-r)))}function ut(i){const t=L(i[0]+1,i[2]),r=L(i[0],i[2]),e=G(i[1]+1,i[2]),s=G(i[1],i[2]);return[r,e,t,s]}function V(i,t,r){const e=dt(i,t,r);return e[0]=Math.floor(e[0]),e[1]=Math.floor(e[1]),e}function dt(i,t,r){const e=Math.sin(t*ct),s=Math.pow(2,r);let o=s*(i/360+.5);const n=s*(.5-.25*Math.log((1+e)/(1-e))/Math.PI);return o=o%s,o<0&&(o=o+s),[o,n,r]}function tt(i){return[[i[0]*2,i[1]*2,i[2]+1],[i[0]*2+1,i[1]*2,i[2]+1],[i[0]*2+1,i[1]*2+1,i[2]+1],[i[0]*2,i[1]*2+1,i[2]+1]]}function mt(i){for(let r=0;r<28;r++){const e=1<<32-(r+1);if((i[0]&e)!==(i[2]&e)||(i[1]&e)!==(i[3]&e))return r}return 28}function pt(i){const t=V(i[0],i[1],32),r=V(i[2],i[3],32),e=[t[0],t[1],r[0],r[1]],s=mt(e);if(s===0)return[0,0,0];const o=e[0]>>>32-s,n=e[1]>>>32-s;return[o,n,s]}const{Box3:ft,Object3D:gt,Mesh:Mt}=await k("three");class X extends gt{constructor(){super(),this.isDisposed=!1,this.isReady=!1,this.childrenTiles=[],this.boundingBoxWorld=new ft}init(t,r,e){this.tileNo=t,Object.freeze(this.tileNo),this.map=r,this.parentTile=e,this.visible=!1,this.renderOrder=t[2],this.ready()}async ready(){if(this.content=await this.map.provider.getTile(this.tileNo),!this.isDisposed){if(this.add(this.content),this.boundingBoxWorld.setFromObject(this.content).applyMatrix4(this.matrixWorld.makeRotationX(-Math.PI/2)),this.map.add(this),this.visible=!0,this.isReady=!0,this.parentTile){const t=this.parentTile.childrenTiles;let r=0;for(let e=0;e<t.length;e++)t[e].isReady&&r++;r===4&&(this.parentTile.visible=!1)}this.update()}}update(){if(!this.isReady||this.isDisposed)return;const{cameraFrustum:t,cameraWorldPosition:r}=this.map;if(!t.intersectsBox(this.boundingBoxWorld)){this.simplify();return}this.content instanceof Mt&&this.map.provider.filter&&(this.content.material.uniforms.t_Matrix.value=this.map.provider.getTranMatrix());let e=this.boundingBoxWorld.distanceToPoint(r);const s=this.tileNo[2];e/=Math.pow(2,this.map.provider.maxZoom-s),e<60&&this.subdivide(),e>80&&this.simplify(),this.childrenTiles.sort((n,a)=>n.boundingBoxWorld.distanceToPoint(r)-a.boundingBoxWorld.distanceToPoint(r)).forEach(n=>n.update())}subdivide(){const{isReady:t,tileNo:r,map:e,childrenTiles:s}=this,o=r[2];if(!t||s.length>0||o>=e.maxZoom)return;tt(r).forEach(a=>{const c=new X;c.init(a,e,this),s.push(c)})}simplify(){this.childrenTiles.forEach(t=>t.dispose()),this.childrenTiles=[],this.visible=!0}dispose(){this.map.remove(this),this.map.provider.abort(this.tileNo),this.childrenTiles.forEach(t=>t.dispose()),this.childrenTiles=[],this.parentTile=void 0,this.content&&(this.map.provider.dispose(this.tileNo,this.content),this.content=void 0),this.isDisposed=!0}}const{Frustum:wt,Matrix4:N,Object3D:xt,Vector3:H,BufferGeometry:E,Mesh:vt}=await k("three");let $t=class extends xt{constructor(){super(),this.bbox=[74.390592,6.900905,134.071423,54.318199],this.maxZoom=20,this.rootForward=0,this.cameraFrustum=new wt,this.cameraWorldPosition=new H,this.cameraProjectionMatrix=new N,this.lastCameraProjectionMatrix=new N,this.lastCameraWorldPosition=new H,this.rootTiles=[],this.lastUpdateTime=0,E.prototype.computeBoundsTree||(E.prototype.computeBoundsTree=ot),E.prototype.disposeBoundsTree||(E.prototype.disposeBoundsTree=nt),vt.prototype.raycast=at}initRootTiles(){this.rootForward>3&&(console.warn("rootForward needs to be 0 - 3."),this.rootForward=3),this.rootForward<0&&(console.warn("rootForward needs to be 0 - 3."),this.rootForward=0);const t=[];let r=[pt(this.bbox)],e=this.rootForward;for(;e>0;){const s=[...r];r=[],s.forEach(o=>{const n=tt(o);r.push(...n)}),e--}t.push(...r),t.forEach(s=>{const o=new X;o.init(s,this),this.rootTiles.push(o)})}update(){if(!this.visible||!this.camera)return;const t=Date.now();if(!(t-this.lastUpdateTime<300)){if(this.rootTiles.length===0){this.initRootTiles();return}this.camera.getWorldPosition(this.cameraWorldPosition),this.cameraProjectionMatrix.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),!(this.cameraWorldPosition.equals(this.lastCameraWorldPosition)&&this.cameraProjectionMatrix.equals(this.lastCameraProjectionMatrix))&&(this.cameraFrustum.setFromProjectionMatrix(this.cameraProjectionMatrix),this.rootTiles.forEach(r=>r.update()),this.lastCameraProjectionMatrix.copy(this.cameraProjectionMatrix),this.lastCameraWorldPosition.copy(this.cameraWorldPosition),this.lastUpdateTime=t)}}dispose(){throw new Error("[Map.dispose] Method not implemented.")}regenerate(){throw new Error("[Map.regenerate] Method not implemented.")}};class W{constructor(){this._controller=new AbortController,this.listeners=new Set}static{this.pendings=new Map}fetch(t,r={}){W.pendings.has(t)||(W.pendings.set(t,this),fetch(t,{...r,signal:this._controller.signal}).then(e=>{this.listeners.forEach(s=>s.resolve(e.clone()))}).catch(e=>{this.listeners.forEach(s=>s.reject(e))}).finally(()=>{W.pendings.delete(t)}))}abort(){this._controller.abort()}}class yt{constructor(t,r){this.url=t,this.init=r,this.promise=new Promise((e,s)=>{this.resolve=e,this.reject=s})}ready(){let t=W.pendings.get(this.url);return t||(t=new W,t.fetch(this.url,this.init)),t.listeners.add(this),this.promise}abort(){this.reject("User abort.");const t=W.pendings.get(this.url);t&&(t.listeners.delete(this),t.listeners.size===0&&t.abort())}}let R;async function Tt(i,t,r=!1){const s=await(await t.ready()).blob(),o=await createImageBitmap(s,r?void 0:{imageOrientation:"flipY"});if(!r)return o;R||(R=new OffscreenCanvas(256,256));const n=R.getContext("2d");if(!n)throw new Error('Offscreencanvas.getContext("2d") error!');const{width:a,height:c}=R;return n.drawImage(o,0,0),n.rect(0,0,a,c),n.strokeStyle="#00FFFF",n.font="20px Arial",n.stroke(),n.fillStyle="#FF4444",n.fillText(`${i[0]}`,10,30),n.fillStyle="#44FF44",n.fillText(`${i[1]}`,10,55),n.fillStyle="#66AAFF",n.fillText(`${i[2]}`,10,80),await createImageBitmap(R,{imageOrientation:"flipY"})}class et{constructor(t){this.terminated=!0,this.map=new Map,this.worker=new t,this.worker.onmessage=this.onMessage.bind(this),this.terminated=!1}async postMessage(t){if(!this.terminated)return this.worker.postMessage(t),new Promise((r,e)=>{this.map.set(t.id,r)})}onMessage(t){const{id:r,error:e}=t.data,s=this.map.get(r);s&&!e&&s(t.data),this.map.delete(r)}terminate(){this.worker.onmessage=null,this.worker.terminate(),this.terminated=!0,this.map.clear()}}function bt(i){return new Worker(""+new URL("../static/MapWorker-Bg0QcWDM.js",import.meta.url).href,{name:i?.name})}const{Texture:Pt}=await k("three");class Gt{constructor(){this.maxZoom=20,this.source="https://gac-geo.googlecnapps.cn/maps/vt?lyrs=s&x=[x]&y=[y]&z=[z]",this.showTileNo=!1,this._useWorker=!1,this.fetching=new Map}set useWorker(t){this._useWorker=t,this._useWorker||(this._worker?.terminate(),this._worker=void 0)}get useWorker(){return this._useWorker}async getTile(t){const r=this.getUrl(t),e=new Pt;if(this._useWorker){this._worker||(this._worker=new et(bt));const s=this.getId(t),o=await this._worker.postMessage({id:s,tileNo:t,url:r,debug:this.showTileNo});e.image=o.bitmap}else{const s=new yt(r,{cache:"force-cache",mode:"cors"});this.fetching.set(t,s);try{e.image=await Tt(t,s,this.showTileNo)}finally{this.fetching.delete(t)}}return e.needsUpdate=!0,e.anisotropy=4,e}abort(t){if(this._useWorker)this._worker?.postMessage({id:this.getId(t),abort:!0});else{const r=this.fetching.get(t);r&&r.abort(),this.fetching.delete(t)}}dispose(t,r){r.dispose()}getId(t){return t.join("-")}getUrl(t){const[r,e,s]=t;return this.source.indexOf("[x]")===-1?this.source.replace("{x}",r+"").replace("{y}",e+"").replace("{z}",s+""):this.source.replace("[x]",r+"").replace("[y]",e+"").replace("[z]",s+"")}}const q="utm",Wt="merc",Z=6378137,Q=Math.PI/180;function Y(i,t){const r=Z*i*Q,e=Z*Math.log(Math.tan(Math.PI*.25+t*Q*.5));return[r,e]}function Vt(i,t){let r=i/(Z*Math.PI)*180,e=t/(Z*Math.PI)*180;return e=180/Math.PI*(2*Math.atan(Math.exp(e*Math.PI/180))-Math.PI/2),[r,e]}function w(i){return i*Math.PI/180}function J(i){return i*180/Math.PI}const rt={a:6378137,f:1/298.257223563},kt="CDEFGHJKLMNPQRSTUVWXX",_t=5e5,Bt=1e7;function Ct(i,t,r){if(!(-80<=t&&t<=84))throw new RangeError(`latitude ‘${t}’ outside UTM limits`);let e=r||Math.floor((i+180)/6)+1,s=w((e-1)*6-180+3);const o=kt.charAt(Math.floor(t/8+10));e===31&&o==="V"&&i>=3?(e++,s+=w(6)):e===32&&o==="X"&&i<9?(e--,s-=w(6)):e===32&&o==="X"&&i>=9?(e++,s+=w(6)):e===34&&o==="X"&&i<21?(e--,s-=w(6)):e===34&&o==="X"&&i>=21?(e++,s+=w(6)):e===36&&o==="X"&&i<33?(e--,s-=w(6)):e===36&&o==="X"&&i>=33&&(e++,s+=w(6));const n=w(t),a=w(i)-s,{a:c,f:T}=rt,m=.9996,M=Math.sqrt(T*(2-T)),h=T/(2-T),v=h*h,y=h*v,p=h*y,f=h*p,u=h*f,_=Math.cos(a),U=Math.sin(a),x=Math.tan(n),B=Math.sinh(M*Math.atanh(M*x/Math.sqrt(1+x*x))),b=x*Math.sqrt(1+B*B)-B*Math.sqrt(1+x*x),C=Math.atan2(b,_),P=Math.asinh(U/Math.sqrt(b*b+_*_)),z=c/(1+h)*(1+1/4*v+1/64*p+1/256*u),F=[null,1/2*h-2/3*v+5/16*y+41/180*p-127/288*f+7891/37800*u,13/48*v-3/5*y+557/1440*p+281/630*f-1983433/1935360*u,61/240*y-103/140*p+15061/26880*f+167603/181440*u,49561/161280*p-179/168*f+6601661/7257600*u,34729/80640*f-3418889/1995840*u,212378941/319334400*u];let S=C;for(let g=1;g<=6;g++)S+=F[g]*Math.sin(2*g*C)*Math.cosh(2*g*P);let I=P;for(let g=1;g<=6;g++)I+=F[g]*Math.cos(2*g*C)*Math.sinh(2*g*P);let l=m*z*I,O=m*z*S;return l=l+_t,O<0&&(O=O+Bt),[l,O]}function Nt(i,t,r){const{a:n,f:a}=rt,c=.9996,T=i-5e5,m=t,M=Math.sqrt(a*(2-a)),h=a/(2-a),v=h*h,y=h*v,p=h*y,f=h*p,u=h*f,_=n/(1+h)*(1+1/4*v+1/64*p+1/256*u),U=T/(c*_),x=m/(c*_),B=[null,1/2*h-2/3*v+37/96*y-1/360*p-81/512*f+96199/604800*u,1/48*v+1/15*y-437/1440*p+46/105*f-1118711/3870720*u,17/480*y-37/840*p-209/4480*f+5569/90720*u,4397/161280*p-11/504*f-830251/7257600*u,4583/161280*f-108847/3991680*u,20648693/638668800*u];let b=x;for(let d=1;d<=6;d++)b-=B[d]*Math.sin(2*d*x)*Math.cosh(2*d*U);let C=U;for(let d=1;d<=6;d++)C-=B[d]*Math.cos(2*d*x)*Math.sinh(2*d*U);const P=Math.sinh(C),z=Math.sin(b),F=Math.cos(b),S=z/Math.sqrt(P*P+F*F);let I=null,l=S;do{const d=Math.sinh(M*Math.atanh(M*l/Math.sqrt(1+l*l))),D=l*Math.sqrt(1+d*d)-d*Math.sqrt(1+l*l);I=(S-D)/Math.sqrt(1+D*D)*(1+(1-M*M)*l*l)/((1-M*M)*Math.sqrt(1+l*l)),l+=I}while(Math.abs(I)>1e-12);const g=Math.atan(l);let $=Math.atan2(P,F);const st=w(49*6-180+3);$+=st;const it=Number(J(g).toFixed(14));return[Number(J($).toFixed(14)),it]}const{BufferAttribute:Ft,PlaneGeometry:It}=await k("three");class Ht{constructor(){this.utmZone=50,this.coordType=q,this.maxZoom=20}async getTile(t){const r=new It,e=ut(t),s=this.convertCoordinate(e[0],e[3]),o=this.convertCoordinate(e[2],e[3]),n=this.convertCoordinate(e[0],e[1]),a=this.convertCoordinate(e[2],e[1]),c=new Float32Array([s[0],s[1],0,o[0],o[1],0,n[0],n[1],0,a[0],a[1],0]);return r.setAttribute("position",new Ft(c,3)),r}abort(t){}dispose(t,r){r.dispose()}convertCoordinate(t,r){switch(this.coordType){case q:return Ct(t,r,this.utmZone);case Wt:return Y(t,r);default:return Y(t,r)}}}function jt(i){return new Worker(""+new URL("../static/MartiniWorker-BvI0tGCv.js",import.meta.url).href,{name:i?.name})}const{BufferAttribute:A,BufferGeometry:K}=await k("three");class Qt{constructor(){this.maxZoom=12,this.coordType=q,this.utmZone=50,this._useWorker=!0,this.source="https://api.maptiler.com/tiles/terrain-rgb-v2/[z]/[x]/[y].webp?key=L55MtSxL94Yb4hQeWewp"}set useWorker(t){this._useWorker=t,this._useWorker||(this._worker?.terminate(),this._worker=void 0)}get useWorker(){return this._useWorker}async getTile(t){return this._useWorker?this.getInWorkerThread(t):this.getInMainThread()}async getInMainThread(){return new K}async getInWorkerThread(t){this._worker||(this._worker=new et(jt));const r={tileNo:t,id:this.getId(t),url:this.getUrl(t),maxZ:this.maxZoom,coordType:this.coordType,utmZone:this.utmZone},e=await this._worker.postMessage(r),s=new K;return s.setAttribute("position",new A(e.positions,3)),s.setAttribute("uv",new A(e.uv,2)),s.setIndex(new A(e.triangles,1)),s}async abort(t){this._useWorker&&this._worker?.postMessage({id:this.getId(t),abort:!0})}async dispose(t,r){r.dispose(),this._useWorker&&this._worker?.postMessage({id:this.getId(t),dispose:!0})}getId(t){return t.join("-")}getUrl(t){const[r,e,s]=t;return this.source.replace("[x]",r+"").replace("[y]",e+"").replace("[z]",s+"")}}const{Mesh:Ut,Vector3:St}=await k("three");class Ot extends Ut{constructor(t){super(t),this.center=new St}}const{Box3Helper:Rt,MeshBasicMaterial:zt,MeshStandardMaterial:Et,SRGBColorSpace:Zt,Matrix4:j}=await k("three");class Yt{constructor(t,r){this.geometryProvider=t,this.textureProvider=r,this.maxZoom=20,this.showBoundingBox=!1,this.wireframe=!1,this.flatShading=!1,this.useStandardMaterial=!1,this.filter=null}getTranMatrix(){let t=new j;if(this.filter?.opposite){let r=new j;r.set(-1,0,0,0,0,-1,0,0,0,0,-1,0,1,1,1,1),t.multiply(r)}if(this.filter?.monochrome){let r=new j;const e=this.filter.monochrome.r,s=this.filter.monochrome.g,o=this.filter.monochrome.b;r.set(e,s,o,0,e,s,o,0,e,s,o,0,0,0,0,1),t.multiply(r)}if(this.filter?.genBright){let r=new j;const e=this.filter.genBright;r.set(e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),t.multiply(r)}if(this.filter?.genContrast){let r=new j;const e=this.filter.genContrast,s=.5*(1-e);r.set(e,0,0,0,0,e,0,0,0,0,e,0,s,s,s,1),t.multiply(r)}if(this.filter?.genSaturate){let r=new j;const e=this.filter.genSaturate,s=.3*(1-e),o=.6*(1-e),n=.1*(1-e);r.set(s+e,s,s,0,o,o+e,o,0,n,n,n+e,0,0,0,0,1),t.multiply(r)}return t}async getTile(t){const r=[this.geometryProvider.getTile(t),this.textureProvider.getTile(t)],e=await Promise.all(r),s=e[0],o=e[1];o.colorSpace=Zt;const{wireframe:n,flatShading:a}=this;let c=null;const T=t[0]+t[1]+t[2];c=this.useStandardMaterial?new Et({map:o,wireframe:n,flatShading:a}):new zt({map:o,wireframe:n}),this.filter&&(c=new ht({baseMaterial:c,vertexShader:`
                varying vec2 vUv;    //顶点纹理坐标
                void main () {
                    vUv = uv;
                    // gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4( position, 1.0 ); 着色器会抖动
                    // gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                    csm_Position = position * vec3(1.0);
                }
                `,fragmentShader:`
                uniform sampler2D e_Texture;     //纹理图像
                varying vec2 vUv;               //片元纹理坐标
                uniform mat4 t_Matrix;     //接收变换矩阵
                void main () {
                    // gl_FragColor = texture2D( e_Texture, vUv );

                    // vec4 textureColor = texture2D( e_Texture, vUv );
                    // //计算加权平均值
                    // float w_a = textureColor.r * 0.3 + textureColor.g * 0.6 + textureColor.b * 0.1;
                    // gl_FragColor = vec4(w_a, w_a, w_a, 1.0);

                    vec4 textureColor = texture2D( e_Texture, vUv );
                    //变换矩阵乘以 vec4(R,G,B,1)    --->vec4(R,G,B,1) 是齐次坐标，原本是n维的向量用一个n+1维向量来表示
                    //vec4(R,G,B,1)第四个分量不是透明度
                    vec4 transColor =  vec4(textureColor.r, textureColor.g, textureColor.b, 1.0)*t_Matrix; 
                    //设置透明度
                    transColor.a = 1.0;
                    csm_FragColor = transColor;

                    // if(vUv.x==0.0 || vUv.x==1.0 || vUv.y==0.0 || vUv.y==1.0){
                    //     gl_FragColor.a = 0.0;
                    // }
                }`,silent:!0,flatShading:a,uniforms:{e_Texture:{value:o},t_Matrix:{value:this.getTranMatrix()}}}));const m=new Ot;if(m.renderOrder=T,s.computeBoundingBox(),s.boundingBox.getCenter(m.center),s.center(),s.computeBoundingSphere(),s.computeBoundsTree(),m.position.copy(m.center),m.geometry=s,m.material=c,this.showBoundingBox){const M=new Rt(s.boundingBox);m.add(M)}return m}abort(t){this.geometryProvider.abort(t),this.textureProvider.abort(t)}dispose(t,r){const e=r.geometry,s=r.material;e&&this.geometryProvider.dispose(t,e),s&&s.map&&this.textureProvider.dispose(t,s.map),s?.dispose()}}export{Wt as MERC,$t as Map,Gt as MapProvider,Qt as MartiniTerrainProvider,Ht as PlaneProvider,Yt as TerrainMeshProvider,q as UTM,Ct as lonLatToUtm,Y as lonLatToWebMerctor,Nt as utmToLonLat,Vt as webMercatorToLonLat};
