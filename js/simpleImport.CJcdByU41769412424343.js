import{importShared as t}from"./3d-tiles-renderer.DFcJBJdg1769412424343.js";import{useTres as e,useLoop as n,TresCanvas_default as r,OrbitControls_default as o}from"./index.B2-FHinZ1769412424343.js";import{JSZip as i,FileSaver_minExports as s,getImageFormat as a,importJsonZip as l,exporterJsonZip as c}from"./utils.BogpQIGH1769412424343.js";import{Pane as u}from"./tweakpane.BbuIEN141769412424343.js";import{FMessage as p}from"./index.obM9lz0L1769412424343.js";const d=await t("three");function m(t,e){for(let n=0,r=t.length;n<r;n++)t[n](e)}window.THREE=d;const v={init:[],start:[],stop:[],keydown:[],keyup:[],pointerdown:[],pointerup:[],pointermove:[],update:[]},f=()=>{};function h(t){m(v.keydown,t)}function g(t){m(v.keyup,t)}function w(t){m(v.pointerdown,t)}function y(t){m(v.pointerup,t)}function b(t){m(v.pointermove,t)}let $=[];const j=(t,e,n,r,o)=>{e.childLevel;let i=`\n    <primitive :object="sceneObject.children[${r}]" name="${n.name}" uuid="${n.uuid}" type="${n.type}">\n    `;if(n.children&&n.children.length){const e=((t,e)=>{const n=t-1,r=["firstLevel","secondLevel","thirdLevel"],o=e.split("-").pop();return{fileName:`${r[n]}-${o}.vue`,comName:`${r[n]}${o}`}})(o,n.uuid);i+=`<${e.comName} :object="sceneObject.children[${r}].children" />`,((t,e,n)=>{let r="";n.forEach((t,e)=>{r+=`\n        <primitive :object="object[${e}]" name="${t.name}" uuid="${t.uuid}" type="${t.type}"/>\n        `});const o=`<template>\n    ${r}\n</template>\n\n<script setup lang="ts">\nconst props = withDefaults(\n    defineProps<{\n        object: any\n    }>(),\n    {},\n)\n<\/script>\n`;t.file(`${e.fileName}`,o),$.push(e)})(t,e,n.children)}return i+="\n    </primitive>\n",i},E=(t,e,n)=>{let r="";const o=t.folder("components/childComponent");return n.object&&n.object.children&&n.object.children.length&&n.object.children.forEach((t,n)=>{e.childLevel>0&&t.children&&t.children.length?r+=j(o,e,t,n,1):r+=`    \n    <primitive :object="sceneObject.children[${n}]" name="${t.name}" uuid="${t.uuid}" type="${t.type}"/>\n    `}),t.file("components/scene.vue",`<template>\n        ${r}</template>\n<script setup lang="ts">\nimport { onMounted } from 'vue'\nimport * as THREE from 'three'\nimport { loadImageToBase64, loadJsonFile } from 'PLS/tresEditor'\nimport { useTres, useLoop } from '@tresjs/core'\nimport player from '../common/eventScript'\n${(()=>{let t="";return $.forEach(e=>{t+=`import ${e.comName} from './childComponent/${e.fileName}'\n`}),t})()}\n\nconst { scene: tresScene, renderer, camera, sizes } = useTres()\nplayer.init(tresScene, renderer, camera, sizes)\n\nconst loader = new THREE.ObjectLoader()\nconst scene = await loadJsonFile('./plugins/${e.pluginName}/json/scene.json')\n\nif (scene.geometries) {\n    for (const geometry of scene.geometries) {\n        if (geometry.data && geometry.data.startsWith('url:')) {\n            let url = geometry.data.slice(4)\n            if (url.startsWith('geometries/')) {\n                url = \`./plugins/${e.pluginName}/\${url}\`\n            }\n            geometry.data = await loadJsonFile(url)\n        }\n    }\n}\nif (scene.images) {\n    for (const image of scene.images) {\n        if (image.url && image.url.startsWith('url:')) {\n            let url = image.url.slice(4)\n            if (url.startsWith('images/')) {\n                url = \`./plugins/${e.pluginName}/\${url}\`\n            }\n            if (url.endsWith(".json")) {\n                image.url = await loadJsonFile(url)\n            } else {\n                image.url = await loadImageToBase64(url)\n            }\n        }\n    }\n}\n\nconst sceneObject = loader.parse(scene) as any\nonMounted(() => {\n    tresScene.value.background = sceneObject.background\n    tresScene.value.environment = sceneObject.environment\n    tresScene.value.fog = sceneObject.fog\n    player.load(sceneObject)\n    player.play()\n})\nconst { onBeforeRender } = useLoop()\nonBeforeRender(({ delta, elapsed }) => {\n    if (player.renderer) {\n        player.render(elapsed * 1000, delta * 1000)\n    }\n})\n<\/script>`),"<Suspense>\n\t\t\t<sceneCom />\n\t\t</Suspense>"};function S(t,e){$=[];const n=e.pluginName,r=new i;((t,e)=>{const n=[];e.geometries&&e.geometries.forEach(t=>{"BufferGeometry"===t.type&&(n.push({uuid:t.uuid,data:t.data}),t.data=`url:geometries/${t.uuid}.json`)});const r=[];if(e.images&&e.images.forEach(t=>{t.url&&(r.push({uuid:t.uuid,url:t.url}),t.url.type?t.url=`url:images/${t.uuid}.${t.url.type}.json`:t.url=`url:images/${t.uuid}.${a(t.url)}`)}),n.length){const e=t.folder("geometries");n.forEach(t=>{e.file(`${t.uuid}.json`,JSON.stringify(t.data))})}if(r.length){const e=t.folder("images");r.forEach(t=>{t.url.type?e.file(`${t.uuid}.${t.url.type}.json`,JSON.stringify(t.url)):e.file(`${t.uuid}.${a(t.url)}`,t.url.split(";base64,").pop(),{base64:!0})})}t.file("json/scene.json",JSON.stringify(e))})(r.folder(`public/plugins/${n}`),t.scene);const o=r.folder(`src/plugins/${n}`);o.file("config.js",(t=>{const e=new Date,n=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`;return`\n\texport default {\n\t\t"name": "${t}",\n\t\t"title": "编辑器导出的插件",\n\t\t"intro": "描述",\n\t\t"version": "0.0.1",\n\t\t"author": "作者名",\n\t\t"website": "站点地址",\n\t\t"state": "active",\n\t\t"creatTime": "${n}",\n\t\t"updateTime": "${n}",\n\t\t"require": [],\n        "tvtstore": 'LOCAL',\n\t\t"preview": [\n\t\t\t{ "src": "plugins/basic/base/preview/theBasic.png", "type": "img", "name": "index", "title": "实例" ,"disableFPSGraph": false, "disableSrcBtn": false},\n\t\t]\n\t}`})(n));const l=((t,e,n,r)=>{const{uuid:o,...i}=n.object,s=JSON.parse(JSON.stringify(n));return s.object=i,`\n<template>\n    <loading />\n\t<TresCanvas v-bind="state">\n\t\t${r.orbitControls?"<OrbitControls />":""}\n\t\t${n?`<Tres${n.object.type}  ref="cameraRef" uuid="${n.object.uuid}" name="${n.object.name}" />`:""}\n\t\t${t}\n\t\t${r.gridHelper?"<TresGridHelper />":""}\n\t</TresCanvas>\n</template>\n<script setup lang="ts">\nimport * as THREE from 'three'\nimport { reactive, watch, ref } from 'vue'\nimport { TresCanvas } from '@tresjs/core'\nimport { OrbitControls } from '@tresjs/cientos'\nimport sceneCom from '../components/scene.vue'\nimport { loading2 as loading } from 'PLS/UIdemo'\n\nconst state = reactive({\n\tclearColor: '#201919',\n\twindowSize:true,\n\tantialias: true,\n\tshadows: ${e.shadows?"true":"false"},\n\tshadowMapType: ${e.shadowType?e.shadowType:"THREE.PCFShadowMap"},\n\ttoneMapping: ${e.toneMapping?e.toneMapping:"THREE.NoToneMapping"},\n\ttoneMappingExposure:${e.toneMappingExposure?e.toneMappingExposure:"1"},\n})\n\nconst cameraConfig = ${s?`${JSON.stringify(s)}`:"{}"}\nconst loader = new THREE.ObjectLoader()\nconst cameraObject = loader.parse(cameraConfig)\nconst cameraRef = ref(null)\nwatch(\n\t() => cameraRef.value,\n\t(val) => {\n\t\t\tval.copy(cameraObject)\n\t},\n)\n<\/script>\n\t`})(E(o,e,t.scene),t.project,t.camera,e);var c;return o.file("pages/index.vue",l),o.file("common/eventScript.js",(c=t.scripts,`/* eslint-disable prefer-rest-params */\n/* eslint-disable no-undefined */\n/* eslint-disable guard-for-in */\nimport * as THREE from 'three'\n\nwindow.THREE = THREE // Used by APP Scripts.\nconst Grscwh = { scene: null, renderer: null, camera: null, sizes: null }\nconst player = {\n\tget renderer() {\n\t\treturn Grscwh.renderer?.value\n\t},\n\tloader: new THREE.TextureLoader(),\n\tget scene() {\n\t\t\treturn Grscwh.scene?.value\n\t},\n\tget camera() {\n\t\t\treturn Grscwh.camera?.value\n\t},\n\tget width() {\n\t\t\treturn Grscwh.sizes?.width?.value\n\t},\n\tget height() {\n\t\t\treturn Grscwh.sizes?.height?.value\n\t},\n\tget dom() {\n\t\t\treturn Grscwh.renderer?.domElement.parentElement\n\t},\n\tget canvas() {\n\t\t\treturn Grscwh.renderer?.domElement\n\t},\n\tevents: {},\n\tinit(scene, renderer, camera, sizes) {\n\t\t\tGrscwh.scene = scene\n\t\t\tGrscwh.renderer = renderer\n\t\t\tGrscwh.camera = camera\n\t\t\tGrscwh.sizes = sizes\n\t},\n\tload(sceneObject) {\n\t\tconst scriptsJson = \n${JSON.stringify(c)}\n\n\t\tthis.events = {\n\t\t\t\tinit: [],\n\t\t\t\tstart: [],\n\t\t\t\tstop: [],\n\t\t\t\tkeydown: [],\n\t\t\t\tkeyup: [],\n\t\t\t\tpointerdown: [],\n\t\t\t\tpointerup: [],\n\t\t\t\tpointermove: [],\n\t\t\t\tupdate: [],\n\t\t}\n\t\tlet scriptWrapParams = 'player,renderer,scene,camera'\n\t\tconst scriptWrapResultObj = {}\n\n\t\tfor (const eventKey in this.events) {\n\t\t\t\tscriptWrapParams += \`,\${eventKey}\`\n\t\t\t\tscriptWrapResultObj[eventKey] = eventKey\n\t\t}\n\t\tconst scriptWrapResult = JSON.stringify(scriptWrapResultObj).replace(/\\"/g, '')\n\t\tfor (const uuid in scriptsJson) {\n\t\t\t\tlet curUuid = uuid\n\t\t\t\t//这里解决一个问题 目前并没有把 主场景scene直接替换而是通过group 加进入的，所以 如果事件是基于主场景scene 那么替换这个uuid为现在tres主场景的uuid\n\t\t\t\tif (uuid === sceneObject.uuid) {\n\t\t\t\t\t\tcurUuid = this.scene.uuid\n\t\t\t\t}\n\t\t\t\tconst object = this.scene.getObjectByProperty('uuid', curUuid, true)\n\t\t\t\tif (object === undefined) {\n\t\t\t\t\t\tconsole.warn('player: Script without object.', curUuid)\n\t\t\t\t\t\tcontinue\n\t\t\t\t}\n\t\t\t\tconst scripts = scriptsJson[uuid]\n\t\t\t\tfor (let i = 0; i < scripts.length; i++) {\n\t\t\t\t\t\tconst script = scripts[i]\n\t\t\t\t\t\t// eslint-disable-next-line no-new-func\n\t\t\t\t\t\tconst functions = new Function(scriptWrapParams, \`\${script.source}\nreturn \${scriptWrapResult};\`).bind(object)(\n\t\t\t\t\t\t\t\tthis,\n\t\t\t\t\t\t\t\tthis.renderer,\n\t\t\t\t\t\t\t\tthis.scene,\n\t\t\t\t\t\t\t\tthis.camera,\n\t\t\t\t\t\t)\n\t\t\t\t\t\tfor (const name in functions) {\n\t\t\t\t\t\t\t\tif (functions[name] === undefined) continue\n\t\t\t\t\t\t\t\tif (this.events[name] === undefined) {\n\t\t\t\t\t\t\t\t\t\tconsole.warn('player: Event type not supported (', name, ')')\n\t\t\t\t\t\t\t\t\t\tcontinue\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tthis.events[name].push(functions[name].bind(object))\n\t\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tthis.dispatch(this.events.init, arguments)\n\t\t}\n\t},\n\tdispatch(array, event) {\n\t\tfor (let i = 0, l = array.length; i < l; i++) {\n\t\t\t\tarray[i](event)\n\t\t}\n\t},\n\tsetCamera(value) {\n\t\t\tconsole.warn('暂时不考虑摄像机的设置函数', value)\n\t\t\t// camera = value\n\t\t\t// camera.aspect = this.width / this.height\n\t\t\t// camera.updateProjectionMatrix()\n\t},\n\tsetScene(value) {\n\t\t\tconsole.warn('暂时不考虑场景的设置函数', value)\n\t\t\t// scene = value\n\t},\n\tsetPixelRatio(value) {\n\t\t\tconsole.warn('暂时不考虑像素比的设置函数', value)\n\t},\n\tsetSize(value) {\n\t\t\tconsole.warn('暂时不考虑尺寸的设置函数', value)\n\t},\n\tdispose() {\n\t\t\t// renderer.dispose();\n\t\t\t// camera = undefined;\n\t\t\t// scene = undefined;\n\t\t\tconsole.warn('暂时不考虑释放资源的函数')\n\t},\n\tonKeyDown(event) {\n\t\tplayer.dispatch(player.events.keydown, event)\n\t},\n\tonKeyUp(event) {\n\t\t\tplayer.dispatch(player.events.keyup, event)\n\t},\n\tonPointerDown(event) {\n\t\t\tplayer.dispatch(player.events.pointerdown, event)\n\t},\n\tonPointerUp(event) {\n\t\t\tplayer.dispatch(player.events.pointerup, event)\n\t},\n\tonPointerMove(event) {\n\t\t\tplayer.dispatch(player.events.pointermove, event)\n\t},\n\tplay() {\n\t\t\tdocument.addEventListener('keydown', this.onKeyDown)\n\t\t\tdocument.addEventListener('keyup', this.onKeyUp)\n\t\t\tdocument.addEventListener('pointerdown', this.onPointerDown)\n\t\t\tdocument.addEventListener('pointerup', this.onPointerUp)\n\t\t\tdocument.addEventListener('pointermove', this.onPointerMove)\n\t\t\tthis.dispatch(this.events.start, null)\n\t\t\t//renderer.setAnimationLoop( animate ); 播放是自动的\n\t},\n\tstop() {\n\t\t\tdocument.removeEventListener('keydown', this.onKeyDown)\n\t\t\tdocument.removeEventListener('keyup', this.onKeyUp)\n\t\t\tdocument.removeEventListener('pointerdown', this.onPointerDown)\n\t\t\tdocument.removeEventListener('pointerup', this.onPointerUp)\n\t\t\tdocument.removeEventListener('pointermove', this.onPointerMove)\n\t\t\tthis.dispatch(this.events.stop, arguments)\n\t\t\t// renderer.setAnimationLoop( null );播放是自动的\n\t},\n\trender(elapsed, delta) {\n\t\t\tthis.dispatch(this.events.update, { time: elapsed, delta })\n\t},\n}\nexport default player\n`)),r.generateAsync({type:"blob"}).then(t=>{s.saveAs(t,`${n}.zip`)})}const{defineComponent:L}=await t("vue"),k=await t("three"),{onMounted:P}=await t("vue"),T=L({__name:"importJson",setup(t){let r,o=null;var i=new k.ObjectLoader;let s=null;const{scene:a,renderer:d,camera:$,sizes:j}=e(),E=t=>{(()=>{if(!s)return;const t=e=>{let n=e.children.filter(t=>!!t);n.forEach(e=>{e.children.length?t(e):((t=>{t.geometry?.dispose(),t.material?.dispose()})(e),e.clear())}),e.clear(),n=null};t(s),s=null})(),document.removeEventListener("keydown",h),document.removeEventListener("keyup",g),document.removeEventListener("pointerdown",w),document.removeEventListener("pointerup",y),document.removeEventListener("pointermove",b),m(v.stop,null),v.init=[],v.start=[],v.stop=[],v.keydown=[],v.keyup=[],v.pointerdown=[],v.pointerup=[],v.pointermove=[],v.update=[],s=new k.Group,t.children&&(s.children=t.children,a.value.add(s),a.value.background=t.background,a.value.environment=t.environment,a.value.fog=t.fog)},L=new u;L.addButton({title:"清空场景",label:"clear"}).on("click",()=>{confirm("确定要执行操作吗？")&&window.location.reload()});L.addButton({title:"导入原生场景Json",label:"srcJson"}).on("click",()=>{o?p.warning?.({content:"先清空场景",colorful:!0}):r&&(r.accept=".json",r.value=null,r.click())});const T=L.addFolder({title:"分解场景[中间件 测试用]",expanded:!1});T.addButton({title:"生成分解场景Zip",label:"Json2Zip"}).on("click",()=>{o?c(o):p.warning?.({content:"场景内无物体",colorful:!0})});T.addButton({title:"导入分解场景Zip",label:"Zip2Json"}).on("click",()=>{o?p.warning?.({content:"先清空场景",colorful:!0}):r&&(r.accept=".zip",r.value=null,r.click())});const O={orbitControls:!0,gridHelper:!0,pluginName:"testEditor",childLevel:1},N=L.addFolder({title:"TvT插件包"});N.addBinding(O,"pluginName",{label:"插件名称"}),N.addBinding(O,"orbitControls",{label:"默认控制器"}),N.addBinding(O,"gridHelper",{label:"默认网格"});N.addButton({title:"生成插件包",label:"MakePlugin"}).on("click",()=>{o?O.pluginName?S(o,O):p.warning?.({content:"请正确填写插件名称",colorful:!0}):p.warning?.({content:"场景内无物体",colorful:!0})});const R=t=>{o=t,E(i.parse(o.scene)),((t,e,n,r,o)=>{const i=o.scripts||{};let s="player,renderer,scene,camera";const a={};for(const c in v)s+=`,${c}`,a[c]=c;const l=JSON.stringify(a).replace(/\"/g,"");for(const c in i){let a=c;c===o.scene.object.uuid&&(a=e.uuid);const u=e.getObjectByProperty("uuid",a,!0);if(void 0===u){console.warn("APP.Player: Script without object.",a);continue}const p=i[c];for(let o=0;o<p.length;o++){const i=p[o],a=new Function(s,`${i.source}\nreturn ${l};`).bind(u)({width:r.width.value,height:r.height.value,setCamera:f},t,e,n);for(const t in a)void 0!==a[t]&&(void 0!==v[t]?v[t].push(a[t].bind(u)):console.warn("APP.Player: Event type not supported (",t,")"))}}m(v.init,null)})(d,a.value,$.value,j,o),document.addEventListener("keydown",h),document.addEventListener("keyup",g),document.addEventListener("pointerdown",w),document.addEventListener("pointerup",y),document.addEventListener("pointermove",b),m(v.start,null)};P(()=>{r=document.getElementById("fileInput"),r&&(r.onchange=t=>{const e=t.target.files[0];if(".json"===r.accept){const t=new FileReader;t.onload=t=>{const e=t.target.result;R(JSON.parse(e))},t.readAsText(e)}".zip"===r.accept&&l(e,R)})});const{onBeforeRender:C}=n();return C(({delta:t,elapsed:e})=>{((t,e)=>{m(v.update,{time:t,delta:e})})(1e3*e,1e3*t)}),(t,e)=>null}}),{defineComponent:O}=await t("vue"),{createElementVNode:N,unref:R,normalizeProps:C,guardReactiveProps:B,createVNode:J,Suspense:M,withCtx:x,openBlock:z,createBlock:G,mergeProps:H,Fragment:F,createElementBlock:W}=await t("vue"),{SRGBColorSpace:U,BasicShadowMap:D,NoToneMapping:K}=await t("three"),{reactive:A,shallowRef:I,watchEffect:_}=await t("vue"),Z=O({__name:"simpleImport",setup(t){const e=A({clearColor:"#201919",shadows:!0,alpha:!1,shadowMapType:D,outputColorSpace:U,toneMapping:K}),n=A({enableDamping:!0,dampingFactor:.05}),i=I(null);return _(()=>{i.value}),(t,i)=>(z(),W(F,null,[J(R(r),H(e,{"window-size":""}),{default:x(()=>[i[0]||(i[0]=N("TresPerspectiveCamera",{position:[15,15,15],fov:45,near:.1,far:1e3,"look-at":[0,0,0]},null,-1)),J(R(o),C(B(n)),null,16),(z(),G(M,null,{default:x(()=>[J(T)]),_:1})),i[1]||(i[1]=N("TresGridHelper",null,null,-1))]),_:1},16),i[2]||(i[2]=N("input",{id:"fileInput",type:"file",accept:".zip",style:{display:"none"}},null,-1))],64))}});export{Z as default};
