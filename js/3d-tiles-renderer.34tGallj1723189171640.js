import{M as e,D as t,G as s,P as n,V as r,B as i,a as o,C as a,b as l,I as c,Q as h,c as u,R as d,d as p,e as m,f as g,S as _,g as f,h as b,i as w,F as T,E as y,j as x,L as S}from"./three.5MXJ6W7w1723189171640.js";function C(e){let t;try{t=new URL(e,"http://fakehost.com/")}catch(r){return null}const s=t.pathname.split("/").pop(),n=s.lastIndexOf(".");if(-1===n||n===s.length-1)return null;return s.substring(n+1)}class E{constructor(){this.maxSize=800,this.minSize=600,this.unloadPercent=.05,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadPriorityCallback=null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize}add(e,t){const s=this.itemSet;if(s.has(e))return!1;if(this.isFull())return!1;const n=this.usedSet,r=this.itemList,i=this.callbacks;return r.push(e),n.add(e),s.set(e,Date.now()),i.set(e,t),!0}remove(e){const t=this.usedSet,s=this.itemSet,n=this.itemList,r=this.callbacks;if(s.has(e)){r.get(e)(e);const i=n.indexOf(e);return n.splice(i,1),t.delete(e),s.delete(e),r.delete(e),!0}return!1}markUsed(e){const t=this.itemSet,s=this.usedSet;t.has(e)&&!s.has(e)&&(t.set(e,Date.now()),s.add(e))}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const e=this.unloadPercent,t=this.minSize,s=this.itemList,n=this.itemSet,r=this.usedSet,i=this.callbacks,o=s.length-r.size,a=s.length-t,l=this.unloadPriorityCallback||this.defaultPriorityCallback;if(a>0&&o>0){s.sort(((e,t)=>{const s=r.has(e),n=r.has(t);return s&&n?0:s||n?s?1:-1:l(t)-l(e)}));const c=Math.min(a,o),h=Math.max(t*e,c*e);let u=Math.min(h,o);u=Math.ceil(u);const d=s.splice(0,u);for(let e=0,t=d.length;e<t;e++){const t=d[e];i.get(t)(t),n.delete(t),i.delete(t)}}}scheduleUnload(e=!0){this.scheduled||(this.scheduled=!0,queueMicrotask((()=>{this.scheduled=!1,this.unloadUnusedContent(),e&&this.markAllUnused()})))}}class v{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise(((s,n)=>{const r=this.items,i=this.callbacks;r.push(e),i.set(e,((...e)=>t(...e).then(s).catch(n))),this.autoUpdate&&this.scheduleJobRun()}))}remove(e){const t=this.items,s=this.callbacks,n=t.indexOf(e);-1!==n&&(t.splice(n,1),s.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,s=this.maxJobs;let n=this.currJobs;for(;s>n&&e.length>0;){n++;const s=e.pop(),r=t.get(s);t.delete(s),r(s).then((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})).catch((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}))}this.currJobs=n}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const P=3,R=4,L=6378137;function A(e){return e===P||e===R}function M(e,t){return e.__lastFrameVisited===t&&e.__used}function O(e,t){e.__lastFrameVisited!==t&&(e.__lastFrameVisited=t,e.__used=!1,e.__inFrustum=!1,e.__isLeaf=!1,e.__visible=!1,e.__active=!1,e.__error=1/0,e.__distanceFromCamera=1/0,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1)}function U(e,t,s,n){if(n.ensureChildrenArePreprocessed(e),O(e,t),e.__used=!0,s.markUsed(e),e.__contentEmpty){const r=e.children;for(let e=0,i=r.length;e<i;e++)U(r[e],t,s,n)}}function F(e,t,s){s.ensureChildrenArePreprocessed(e);if(e.__contentEmpty&&(!e.__externalTileSet||A(e.__loadingState))){const n=e.children;for(let e=0,r=n.length;e<r;e++){const r=n[e];r.__depthFromRenderedParent=t,F(r,t,s)}}else s.requestTileContents(e)}function D(e,t=null,s=null,n=null,r=0){if(t&&t(e,n,r))return void(s&&s(e,n,r));const i=e.children;for(let o=0,a=i.length;o<a;o++)D(i[o],t,s,e,r+1);s&&s(e,n,r)}function I(e,t){t.ensureChildrenArePreprocessed(e);const s=t.stats,n=t.frameCount,r=t.errorTarget,i=t.maxDepth,o=t.loadSiblings,a=t.lruCache,l=t.stopAtEmptyTiles;O(e,n);if(!1===t.tileInView(e))return!1;if(e.__used=!0,a.markUsed(e),e.__inFrustum=!0,s.inFrustum++,(l||!e.__contentEmpty)&&!e.__externalTileSet){t.calculateError(e);if(e.__error<=r)return!0;if(t.maxDepth>0&&e.__depth+1>=i)return!0}let c=!1;const h=e.children;for(let u=0,d=h.length;u<d;u++){const e=I(h[u],t);c=c||e}if(c&&o)for(let u=0,d=h.length;u<d;u++){U(h[u],n,a,t)}return!0}function N(e,t){const s=t.stats,n=t.frameCount;if(!M(e,n))return;s.used++;const r=e.children;let i=!1;for(let o=0,a=r.length;o<a;o++){const e=r[o];i=i||M(e,n)}if(i){let s=!1,i=!0;for(let e=0,o=r.length;e<o;e++){const o=r[e];if(N(o,t),s=s||o.__wasSetVisible||o.__childrenWereVisible,M(o,n)){const e=o.__allChildrenLoaded||!o.__contentEmpty&&A(o.__loadingState)||!o.__externalTileSet&&o.__contentEmpty&&0===o.children.length||o.__externalTileSet&&o.__loadingState===R;i=i&&e}}e.__childrenWereVisible=s,e.__allChildrenLoaded=i}else e.__isLeaf=!0}function k(e,t){const s=t.stats,n=t.frameCount;if(!M(e,n))return;const r=e.parent,i=r?r.__depthFromRenderedParent:-1;e.__depthFromRenderedParent=i;const o=t.lruCache;if(e.__isLeaf)return e.__depthFromRenderedParent++,void(e.__loadingState===P?(e.__inFrustum&&(e.__visible=!0,s.visible++),e.__active=!0,s.active++):o.isFull()||e.__contentEmpty&&!e.__externalTileSet||t.requestTileContents(e));const a=(t.errorTarget+1)*t.errorThreshold,l=e.__error<=a,c=l||"ADD"===e.refine,h=!e.__contentEmpty,u=h||e.__externalTileSet,d=A(e.__loadingState)&&u,p=e.__childrenWereVisible,m=e.children,g=e.__allChildrenLoaded;if(c&&h&&e.__depthFromRenderedParent++,c&&!d&&!o.isFull()&&u&&t.requestTileContents(e),(l&&!g&&!p&&d||"ADD"===e.refine&&d)&&(e.__inFrustum&&(e.__visible=!0,s.visible++),e.__active=!0,s.active++),"ADD"!==e.refine&&l&&!g&&d)for(let _=0,f=m.length;_<f;_++){const s=m[_];M(s,n)&&!o.isFull()&&(s.__depthFromRenderedParent=e.__depthFromRenderedParent+1,F(s,s.__depthFromRenderedParent,t))}else for(let _=0,f=m.length;_<f;_++){const e=m[_];M(e,n)&&k(e,t)}}function V(e,t){const s=M(e,t.frameCount);if(s||e.__usedLastFrame){let n=!1,r=!1;s&&(n=e.__active,r=t.displayActiveTiles&&e.__active||e.__visible),e.__contentEmpty||e.__loadingState!==P||(e.__wasSetActive!==n&&t.setTileActive(e,n),e.__wasSetVisible!==r&&t.setTileVisible(e,r)),e.__wasSetActive=n,e.__wasSetVisible=r,e.__usedLastFrame=s;const i=e.children;for(let e=0,s=i.length;e<s;e++){V(i[e],t)}}}const B=(e,t)=>e.__depth!==t.__depth?e.__depth>t.__depth?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0,z=e=>1/(e.__depthFromRenderedParent+1);class j{get rootTileSet(){const e=this.tileSets[this.rootURL];return!e||e instanceof Promise?null:e}get root(){const e=this.rootTileSet;return e?e.root:null}constructor(e){this.tileSets={},this.rootURL=e,this.fetchOptions={},this.preprocessURL=null;const t=new E;t.unloadPriorityCallback=z;const s=new v;s.maxJobs=4,s.priorityCallback=B;const n=new v;n.maxJobs=1,n.priorityCallback=B,this.lruCache=t,this.downloadQueue=s,this.parseQueue=n,this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this.errorThreshold=1/0,this.loadSiblings=!0,this.displayActiveTiles=!1,this.maxDepth=1/0,this.stopAtEmptyTiles=!0}traverse(e,t){const s=this.tileSets[this.rootURL];s&&s.root&&D(s.root,((t,...s)=>(this.ensureChildrenArePreprocessed(t),!!e&&e(t,...s))),t)}update(){const e=this.stats,t=this.lruCache,s=this.tileSets,n=s[this.rootURL];if(!(this.rootURL in s))return void this.loadRootTileSet(this.rootURL);if(!n||!n.root)return;const r=n.root;e.inFrustum=0,e.used=0,e.active=0,e.visible=0,this.frameCount++,I(r,this),N(r,this),k(r,this),V(r,this),t.scheduleUnload()}parseTile(e,t,s){return null}disposeTile(e){}preprocessNode(e,t,s=null){e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.uri&&(e.content.uri=new URL(e.content.uri,t+"/").toString()),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=s,e.children=e.children||[];if(e.content&&e.content.uri){const t=C(e.content.uri),s=Boolean(t&&"json"===t.toLowerCase());e.__externalTileSet=s,e.__contentEmpty=s}else e.__externalTileSet=!1,e.__contentEmpty=!0;e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=0,e.__loadIndex=0,e.__loadAbort=null,e.__depthFromRenderedParent=-1,null===s?(e.__depth=0,e.refine=e.refine||"REPLACE"):(e.__depth=s.__depth+1,e.refine=e.refine||s.refine),e.__basePath=t}setTileActive(e,t){}setTileVisible(e,t){}calculateError(e){return 0}tileInView(e){return!0}ensureChildrenArePreprocessed(e){const t=e.children;for(let s=0,n=t.length;s<n;s++){const n=t[s];if("__depth"in n)break;this.preprocessNode(n,e.__basePath,e)}}resetFailedTiles(){const e=this.stats;0!==e.failed&&(this.traverse((e=>{e.__loadingState===R&&(e.__loadingState=0)})),e.failed=0)}fetchTileSet(e,t,s=null){return fetch(e,t).then((t=>{if(t.ok)return t.json();throw new Error('TilesRenderer: Failed to load tileset "'.concat(e,'" with status ').concat(t.status," : ").concat(t.statusText))})).then((t=>{const n=t.asset.version,[r,i]=n.split(".").map((e=>parseInt(e)));console.assert(r<=1,"TilesRenderer: asset.version is expected to be a 1.x or a compatible version."),1===r&&i>0&&console.warn("TilesRenderer: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let o=e.replace(/\/[^/]*\/?$/,"");return o=new URL(o,window.location.href).toString(),this.preprocessNode(t.root,o,s),t}))}loadRootTileSet(e){const t=this.tileSets;if(e in t)return t[e]instanceof Error?Promise.reject(t[e]):Promise.resolve(t[e]);{const s=this.fetchTileSet(this.preprocessURL?this.preprocessURL(e):e,this.fetchOptions).then((s=>{t[e]=s}));return s.catch((s=>{console.error(s),t[e]=s})),t[e]=s,s}}requestTileContents(e){if(0!==e.__loadingState)return;const t=this.stats,s=this.lruCache,n=this.downloadQueue,r=this.parseQueue,i=e.__externalTileSet;s.add(e,(e=>{1===e.__loadingState?(e.__loadAbort.abort(),e.__loadAbort=null):i?e.children.length=0:this.disposeTile(e),1===e.__loadingState?t.downloading--:2===e.__loadingState&&t.parsing--,e.__loadingState=0,e.__loadIndex++,r.remove(e),n.remove(e)})),e.__loadIndex++;const o=e.__loadIndex,a=new AbortController,l=a.signal;t.downloading++,e.__loadAbort=a,e.__loadingState=1;const c=i=>{e.__loadIndex===o&&("AbortError"!==i.name?(r.remove(e),n.remove(e),2===e.__loadingState?t.parsing--:1===e.__loadingState&&t.downloading--,t.failed++,console.error('TilesRenderer : Failed to load tile at url "'.concat(e.content.uri,'".')),console.error(i),e.__loadingState=R):s.remove(e))};i?n.add(e,(e=>{if(e.__loadIndex!==o)return Promise.resolve();const t=this.preprocessURL?this.preprocessURL(e.content.uri):e.content.uri;return this.fetchTileSet(t,Object.assign({signal:l},this.fetchOptions),e)})).then((s=>{e.__loadIndex===o&&(t.downloading--,e.__loadAbort=null,e.__loadingState=P,e.children.push(s.root))})).catch(c):n.add(e,(e=>{if(e.__loadIndex!==o)return Promise.resolve();const t=this.preprocessURL?this.preprocessURL(e.content.uri):e.content.uri;return fetch(t,Object.assign({signal:l},this.fetchOptions))})).then((t=>{if(e.__loadIndex===o){if(t.ok)return t.arrayBuffer();throw new Error("Failed to load model with error code ".concat(t.status))}})).then((s=>{if(e.__loadIndex===o)return t.downloading--,t.parsing++,e.__loadAbort=null,e.__loadingState=2,r.add(e,(e=>{if(e.__loadIndex!==o)return Promise.resolve();const t=C(e.content.uri);return this.parseTile(s,e,t)}))})).then((()=>{e.__loadIndex===o&&(t.parsing--,e.__loadingState=P,e.__wasSetVisible&&this.setTileVisible(e,!0),e.__wasSetActive&&this.setTileActive(e,!0))})).catch(c)}dispose(){const e=this.lruCache,t=[];this.traverse((e=>(t.push(e),!1)));for(let s=0,n=t.length;s<n;s++)e.remove(t[s]);this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}}const H=new TextDecoder;function W(e){return H.decode(e)}class G{constructor(e,t,s,n){this.buffer=e,this.binOffset=t+s,this.binLength=n;let r=null;if(0!==s){const n=new Uint8Array(e,t,s);r=JSON.parse(W(n))}else r={};this.header=r}getKeys(){return Object.keys(this.header)}getData(e,t,s=null,n=null){const r=this.header;if(!(e in r))return null;const i=r[e];if(i instanceof Object){if(Array.isArray(i))return i;{const{buffer:r,binOffset:o,binLength:a}=this,l=i.byteOffset||0,c=i.type||n,h=i.componentType||s;if("type"in i&&n&&i.type!==n)throw new Error("FeatureTable: Specified type does not match expected type.");let u,d;switch(c){case"SCALAR":u=1;break;case"VEC2":u=2;break;case"VEC3":u=3;break;case"VEC4":u=4;break;default:throw new Error('FeatureTable : Feature type not provided for "'.concat(e,'".'))}const p=o+l,m=t*u;switch(h){case"BYTE":d=new Int8Array(r,p,m);break;case"UNSIGNED_BYTE":d=new Uint8Array(r,p,m);break;case"SHORT":d=new Int16Array(r,p,m);break;case"UNSIGNED_SHORT":d=new Uint16Array(r,p,m);break;case"INT":d=new Int32Array(r,p,m);break;case"UNSIGNED_INT":d=new Uint32Array(r,p,m);break;case"FLOAT":d=new Float32Array(r,p,m);break;case"DOUBLE":d=new Float64Array(r,p,m);break;default:throw new Error('FeatureTable : Feature component type not provided for "'.concat(e,'".'))}if(p+m*d.BYTES_PER_ELEMENT>o+a)throw new Error("FeatureTable: Feature data read outside binary body length.");return d}}return i}getBuffer(e,t){const{buffer:s,binOffset:n}=this;return s.slice(n+e,n+e+t)}}class q extends G{constructor(e,t,s,n,r){super(e,s,n,r),this.batchSize=t}getData(e,t=null,s=null){return super.getData(e,this.batchSize,t,s)}}class J{constructor(){this.fetchOptions={},this.workingPath=""}load(e){return fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error('Failed to load file "'.concat(e,'" with status ').concat(t.status," : ").concat(t.statusText));return t.arrayBuffer()})).then((t=>(""===this.workingPath&&(this.workingPath=this.workingPathForURL(e)),this.parse(t))))}resolveExternalURL(e){return/^[^\\/]/.test(e)?this.workingPath+"/"+e:e}workingPathForURL(e){const t=e.split(/[\\/]/g);t.pop();return t.join("/")+"/"}parse(e){throw new Error("LoaderBase: Parse not implemented.")}}function Q(e){let t;if(t=e instanceof DataView?e:new DataView(e),"{"===String.fromCharCode(t.getUint8(0)))return null;let s="";for(let n=0;n<4;n++)s+=String.fromCharCode(t.getUint8(n));return s}class Y extends J{parse(e){const t=new DataView(e),s=Q(t);console.assert("b3dm"===s);const n=t.getUint32(4,!0);console.assert(1===n);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),o=t.getUint32(16,!0),a=t.getUint32(20,!0),l=t.getUint32(24,!0),c=e.slice(28,28+i+o),h=new G(c,0,i,o),u=28+i+o,d=e.slice(u,u+a+l),p=new q(d,h.getData("BATCH_LENGTH"),0,a,l),m=u+a+l;return{version:n,featureTable:h,batchTable:p,glbBytes:new Uint8Array(e,m,r-m)}}}class Z extends Y{constructor(s=t){super(),this.manager=s,this.adjustmentTransform=new e}parse(e){const t=super.parse(e),n=t.glbBytes.slice().buffer;return new Promise(((e,r)=>{const i=this.manager,o=this.fetchOptions,a=i.getHandler("path.gltf")||new s(i);"include"===o.credentials&&"cors"===o.mode&&a.setCrossOrigin("use-credentials"),"credentials"in o&&a.setWithCredentials("include"===o.credentials),o.headers&&a.setRequestHeader(o.headers);let l=this.workingPath;!/[\\/]$/.test(l)&&l.length&&(l+="/");const c=this.adjustmentTransform;a.parse(n,l,(s=>{const{batchTable:n,featureTable:r}=t,{scene:i}=s,o=r.getData("RTC_CENTER");o&&(i.position.x+=o[0],i.position.y+=o[1],i.position.z+=o[2]),s.scene.updateMatrix(),s.scene.matrix.multiply(c),s.scene.matrix.decompose(s.scene.position,s.scene.quaternion,s.scene.scale),s.batchTable=n,s.featureTable=r,i.batchTable=n,i.featureTable=r,e(s)}),r)}))}}class $ extends J{parse(e){const t=new DataView(e),s=Q(t);console.assert("pnts"===s);const n=t.getUint32(4,!0);console.assert(1===n);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),o=t.getUint32(16,!0),a=t.getUint32(20,!0),l=t.getUint32(24,!0),c=e.slice(28,28+i+o),h=new G(c,0,i,o),u=28+i+o,d=e.slice(u,u+a+l),p=new q(d,h.getData("BATCH_LENGTH")||h.getData("POINTS_LENGTH"),0,a,l);return Promise.resolve({version:n,featureTable:h,batchTable:p})}}function K(e){const t=e>>11,s=e>>5&63,n=31&e;return[Math.round(t/31*255),Math.round(s/63*255),Math.round(n/31*255)]}const X={RGB:"color",POSITION:"position"};class ee extends ${constructor(e=t){super(),this.manager=e}parse(e){return super.parse(e).then((async e=>{const{featureTable:t,batchTable:s}=e,c=new n,h=t.header.extensions,u=new r;let d;if(h&&h["3DTILES_draco_point_compression"]){const{byteOffset:e,byteLength:s,properties:n}=h["3DTILES_draco_point_compression"],r=this.manager.getHandler("draco.drc");if(null==r)throw new Error("PNTSLoader: dracoLoader not available.");const i={};for(const t in n)if(t in X&&t in n){i[X[t]]=n[t]}const o={attributeIDs:i,attributeTypes:{position:"Float32Array",color:"Uint8Array"},useUniqueIDs:!0},a=t.getBuffer(e,s);d=await r.decodeGeometry(a,o),d.attributes.color&&(c.vertexColors=!0)}else{const e=t.getData("POINTS_LENGTH"),s=t.getData("POSITION",e,"FLOAT","VEC3"),n=t.getData("RGB",e,"UNSIGNED_BYTE","VEC3"),r=t.getData("RGBA",e,"UNSIGNED_BYTE","VEC4"),l=t.getData("RGB565",e,"UNSIGNED_SHORT","SCALAR"),h=t.getData("CONSTANT_RGBA",e,"UNSIGNED_BYTE","VEC4"),p=t.getData("POSITION_QUANTIZED",e,"UNSIGNED_SHORT","VEC3"),m=t.getData("QUANTIZED_VOLUME_SCALE",e,"FLOAT","VEC3"),g=t.getData("QUANTIZED_VOLUME_OFFSET",e,"FLOAT","VEC3");if(d=new i,p){const t=new Float32Array(3*e);for(let s=0;s<e;s++)for(let e=0;e<3;e++){const n=3*s+e;t[n]=p[n]/65535*m[e]}u.x=g[0],u.y=g[1],u.z=g[2],d.setAttribute("position",new o(t,3,!1))}else d.setAttribute("position",new o(s,3,!1));if(null!==r)d.setAttribute("color",new o(r,4,!0)),c.vertexColors=!0,c.transparent=!0,c.depthWrite=!1;else if(null!==n)d.setAttribute("color",new o(n,3,!0)),c.vertexColors=!0;else if(null!==l){const t=new Uint8Array(3*e);for(let s=0;s<e;s++){const e=K(l[s]);for(let n=0;n<3;n++){t[3*s+n]=e[n]}}d.setAttribute("color",new o(t,3,!0)),c.vertexColors=!0}else if(null!==h){const e=new a(h[0],h[1],h[2]);c.color=e;const t=h[3]/255;t<1&&(c.opacity=t,c.transparent=!0,c.depthWrite=!1)}}["BATCH_LENGTH","NORMAL","NORMAL_OCT16P"].forEach((e=>{e in t.header&&console.warn('PNTSLoader: Unsupported FeatureTable feature "'.concat(e,'" detected.'))}));const p=new l(d,c);p.position.copy(u),e.scene=p,e.scene.featureTable=t,e.scene.batchTable=s;const m=t.getData("RTC_CENTER");return m&&(e.scene.position.x+=m[0],e.scene.position.y+=m[1],e.scene.position.z+=m[2]),e}))}}class te extends J{parse(e){const t=new DataView(e),s=Q(t);console.assert("i3dm"===s);const n=t.getUint32(4,!0);console.assert(1===n);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),o=t.getUint32(16,!0),a=t.getUint32(20,!0),l=t.getUint32(24,!0),c=t.getUint32(28,!0),h=e.slice(32,32+i+o),u=new G(h,0,i,o),d=32+i+o,p=e.slice(d,d+a+l),m=new q(p,u.getData("INSTANCES_LENGTH"),0,a,l),g=d+a+l,_=new Uint8Array(e,g,r-g);let f=null,b=null;if(c)f=_,b=Promise.resolve();else{const e=this.resolveExternalURL(W(_));b=fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error('I3DMLoaderBase : Failed to load file "'.concat(e,'" with status ').concat(t.status," : ").concat(t.statusText));return t.arrayBuffer()})).then((e=>{f=new Uint8Array(e)}))}return b.then((()=>({version:n,featureTable:u,batchTable:m,glbBytes:f})))}}const se=new r,ne=new r,re=new r,ie=new r,oe=new h,ae=new r,le=new e;class ce extends te{constructor(s=t){super(),this.manager=s,this.adjustmentTransform=new e}resolveExternalURL(e){return this.manager.resolveURL(super.resolveExternalURL(e))}parse(e){return super.parse(e).then((e=>{const{featureTable:t,batchTable:n}=e,i=e.glbBytes.slice().buffer;return new Promise(((e,o)=>{const a=this.fetchOptions,l=this.manager,h=l.getHandler("path.gltf")||new s(l);"include"===a.credentials&&"cors"===a.mode&&h.setCrossOrigin("use-credentials"),"credentials"in a&&h.setWithCredentials("include"===a.credentials),a.headers&&h.setRequestHeader(a.headers);let u=this.workingPath;/[\\/]$/.test(u)||(u+="/");const d=this.adjustmentTransform;h.parse(i,u,(s=>{const i=t.getData("INSTANCES_LENGTH"),o=t.getData("POSITION",i,"FLOAT","VEC3"),a=t.getData("NORMAL_UP",i,"FLOAT","VEC3"),l=t.getData("NORMAL_RIGHT",i,"FLOAT","VEC3"),h=t.getData("SCALE_NON_UNIFORM",i,"FLOAT","VEC3"),u=t.getData("SCALE",i,"FLOAT","SCALAR");["RTC_CENTER","QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","EAST_NORTH_UP","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach((e=>{e in t.header&&console.warn('I3DMLoader: Unsupported FeatureTable feature "'.concat(e,'" detected.'))}));const p=new Map,m=[];s.scene.traverse((e=>{if(e.isMesh){const{geometry:t,material:s}=e,n=new c(t,s,i);n.position.copy(e.position),n.rotation.copy(e.rotation),n.scale.copy(e.scale),m.push(n),p.set(e,n)}}));const g=new r;for(let e=0;e<i;e++)g.x+=o[3*e+0]/i,g.y+=o[3*e+1]/i,g.z+=o[3*e+2]/i;p.forEach(((e,t)=>{const s=t.parent;s&&(s.remove(t),s.add(e),e.updateMatrixWorld(),e.position.copy(g).applyMatrix4(e.matrixWorld))}));for(let e=0;e<i;e++){ie.set(o[3*e+0]-g.x,o[3*e+1]-g.y,o[3*e+2]-g.z),a?(ne.set(a[3*e+0],a[3*e+1],a[3*e+2]),re.set(l[3*e+0],l[3*e+1],l[3*e+2]),se.crossVectors(re,ne).normalize(),le.makeBasis(re,ne,se),oe.setFromRotationMatrix(le)):oe.set(0,0,0,1),u?ae.setScalar(u[e]):h?ae.set(h[3*e+0],h[3*e+1],h[3*e+2]):ae.set(1,1,1),le.compose(ie,oe,ae).multiply(d);for(let t=0,s=m.length;t<s;t++){m[t].setMatrixAt(e,le)}}s.batchTable=n,s.featureTable=t,s.scene.batchTable=n,s.scene.featureTable=t,e(s)}),o)}))}))}}class he extends J{parse(e){const t=new DataView(e),s=Q(t);console.assert("cmpt"===s,'CMPTLoader: The magic bytes equal "cmpt".');const n=t.getUint32(4,!0);console.assert(1===n,'CMPTLoader: The version listed in the header is "1".');const r=t.getUint32(8,!0);console.assert(r===e.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const i=t.getUint32(12,!0),o=[];let a=16;for(let l=0;l<i;l++){const t=new DataView(e,a,12),s=Q(t),n=t.getUint32(4,!0),r=t.getUint32(8,!0),i=new Uint8Array(e,a,r);o.push({type:s,buffer:i,version:n}),a+=r}return{version:n,tiles:o}}}class ue extends he{constructor(s=t){super(),this.manager=s,this.adjustmentTransform=new e}parse(e){const t=super.parse(e),s=this.manager,n=this.adjustmentTransform,r=[];for(const i in t.tiles){const{type:e,buffer:o}=t.tiles[i];switch(e){case"b3dm":{const e=o.slice(),t=new Z(s);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions,t.adjustmentTransform.copy(n);const i=t.parse(e.buffer);r.push(i);break}case"pnts":{const e=o.slice(),t=new ee(s);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const n=t.parse(e.buffer);r.push(n);break}case"i3dm":{const e=o.slice(),t=new ce(s);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions,t.adjustmentTransform.copy(n);const i=t.parse(e.buffer);r.push(i);break}}}return Promise.all(r).then((e=>{const t=new u;return e.forEach((e=>{t.add(e.scene)})),{tiles:e,scene:t}}))}}class de{constructor(){this.name="CESIUM_RTC"}afterRoot(e){if(e.parser.json.extensions&&e.parser.json.extensions.CESIUM_RTC){const{center:t}=e.parser.json.extensions.CESIUM_RTC;t&&(e.scene.position.x+=t[0],e.scene.position.y+=t[1],e.scene.position.z+=t[2])}}}class pe extends J{constructor(e=t){super(),this.manager=e}parse(e){return new Promise(((t,n)=>{const r=this.manager,i=this.fetchOptions;let o=r.getHandler("path.gltf")||r.getHandler("path.glb");o||(o=new s(r),o.register((()=>new de))),"include"===i.credentials&&"cors"===i.mode&&o.setCrossOrigin("use-credentials"),"credentials"in i&&o.setWithCredentials("include"===i.credentials),i.headers&&o.setRequestHeader(i.headers);let a=o.resourcePath||o.path||this.workingPath;!/[\\/]$/.test(a)&&a.length&&(a+="/"),o.parse(e,a,(e=>{t(e)}),n)}))}}const me=new e;class ge extends u{constructor(e){super(),this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e}raycast(e,t){return!this.tilesRenderer.optimizeRaycast||(this.tilesRenderer.raycast(e,t),!1)}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){null===this.parent?me.copy(this.matrix):me.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const e=me.elements,t=this.matrixWorld.elements;let s=!1;for(let n=0;n<16;n++){const r=e[n],i=t[n];if(Math.abs(r-i)>Number.EPSILON){s=!0;break}}if(s){this.matrixWorld.copy(me);const e=this.children;for(let t=0,s=e.length;t<s;t++)e[t].updateMatrixWorld()}}}}const _e=parseInt(p)<165,fe=new e,be=new d,we=new r,Te=[];function ye(e,t){return e.distance-t.distance}function xe(e,t,s){_e?(e.traverse((e=>{Object.getPrototypeOf(e).raycast.call(e,t,s)})),Te.sort(ye)):t.intersectObject(e,!0,s)}function Se(e,t,s,n=null){const{group:r,activeTiles:i}=e;e.ensureChildrenArePreprocessed(t),null===n&&(n=be,fe.copy(r.matrixWorld).invert(),n.copy(s.ray).applyMatrix4(fe));const o=[],a=t.children;for(let h=0,u=a.length;h<u;h++){const e=a[h];if(!e.__used)continue;null!==e.cached.boundingVolume.intersectRay(n,we)&&(we.applyMatrix4(r.matrixWorld),o.push({distance:we.distanceToSquared(s.ray.origin),tile:e}))}o.sort(ye);let l=null,c=1/0;if(i.has(t)){const e=function(e,t){xe(e,t,Te);const s=Te[0]||null;return Te.length=0,s}(t.cached.scene,s);e&&(l=e,c=e.distance*e.distance)}for(let h=0,u=o.length;h<u;h++){const t=o[h],r=t.distance,i=t.tile;if(r>c)break;const a=Se(e,i,s,n);if(a){const e=a.distance*a.distance;e<c&&(l=a,c=e)}}return l}function Ce(e,t,s,n,r=null){const{group:i,activeTiles:o}=e,{scene:a,boundingVolume:l}=t.cached;if(e.ensureChildrenArePreprocessed(t),null===r&&(r=be,fe.copy(i.matrixWorld).invert(),r.copy(s.ray).applyMatrix4(fe)),!t.__used||!l.intersectsRay(r))return;o.has(t)&&xe(a,s,n);const c=t.children;for(let h=0,u=c.length;h<u;h++)Ce(e,c[h],s,n,r)}const Ee=new r,ve=new r,Pe=new r;class Re{constructor(t=new g,s=new e){this.box=t.clone(),this.transform=s.clone(),this.inverseTransform=new e,this.points=new Array(8).fill().map((()=>new r)),this.planes=new Array(6).fill().map((()=>new m))}update(){const{points:e,inverseTransform:t,transform:s,box:n}=this;t.copy(s).invert();const{min:r,max:i}=n;let o=0;for(let a=-1;a<=1;a+=2)for(let t=-1;t<=1;t+=2)for(let n=-1;n<=1;n+=2)e[o].set(a<0?r.x:i.x,t<0?r.y:i.y,n<0?r.z:i.z).applyMatrix4(s),o++;this.updatePlanes()}updatePlanes(){Ee.copy(this.box.min).applyMatrix4(this.transform),ve.copy(this.box.max).applyMatrix4(this.transform),Pe.set(0,0,1).transformDirection(this.transform),this.planes[0].setFromNormalAndCoplanarPoint(Pe,Ee),this.planes[1].setFromNormalAndCoplanarPoint(Pe,ve).negate(),Pe.set(0,1,0).transformDirection(this.transform),this.planes[2].setFromNormalAndCoplanarPoint(Pe,Ee),this.planes[3].setFromNormalAndCoplanarPoint(Pe,ve).negate(),Pe.set(1,0,0).transformDirection(this.transform),this.planes[4].setFromNormalAndCoplanarPoint(Pe,Ee),this.planes[5].setFromNormalAndCoplanarPoint(Pe,ve).negate()}intersectsFrustum(e){const{points:t}=this,{planes:s}=e;for(let n=0;n<6;n++){const e=s[n];let r=-1/0;for(let s=0;s<8;s++){const n=t[s],i=e.distanceToPoint(n);r=r<i?i:r}if(r<0)return!1}for(let n=0;n<6;n++){const t=this.planes[n];let s=-1/0;for(let n=0;n<8;n++){const r=e.points[n],i=t.distanceToPoint(r);s=s<i?i:s}if(s<0)return!1}return!0}}new _,new r;const Le=new _,Ae=new r,Me=new r,Oe=new r,Ue=new r,Fe=new e,De=new f,Ie=new r,Ne=new r,ke=new r,Ve=new r,Be=new d;class ze{constructor(e=1,t=1,s=1){this.radius=new r(e,t,s)}intersectRay(e,t){return Fe.makeScale(...this.radius).invert(),De.center.set(0,0,0),De.radius=1,Be.copy(e).applyMatrix4(Fe),Be.intersectSphere(De,t)?(Fe.makeScale(...this.radius),t.applyMatrix4(Fe),t):null}constructLatLonFrame(e,t,s){return this.getCartographicToPosition(e,t,0,Ve),this.getCartographicToNormal(e,t,ke),this.getNorthernTangent(e,t,Ne),Ie.crossVectors(Ne,ke),s.makeBasis(Ie,Ne,ke).setPosition(Ve)}getNorthernTangent(e,t,s,n=Ue){let r=1,i=e+1e-7;e>Math.PI/4&&(r=-1,i=e-1e-7);const o=this.getCartographicToNormal(e,t,Me).normalize(),a=this.getCartographicToNormal(i,t,Oe).normalize();return n.crossVectors(o,a).normalize().multiplyScalar(r),s.crossVectors(n,o).normalize()}getCartographicToPosition(e,t,s,n){this.getCartographicToNormal(e,t,Ae);const r=this.radius;Me.copy(Ae),Me.x*=r.x**2,Me.y*=r.y**2,Me.z*=r.z**2;const i=Math.sqrt(Ae.dot(Me));return Me.divideScalar(i),n.copy(Me).addScaledVector(Ae,s)}getPositionToCartographic(e,t){this.getPositionToSurfacePoint(e,Me),this.getPositionToNormal(e,Ae);const s=Oe.subVectors(e,Me);return t.lon=Math.atan2(Ae.y,Ae.x),t.lat=Math.asin(Ae.z),t.height=Math.sign(s.dot(e))*s.length(),t}getCartographicToNormal(e,t,s){return Le.set(1,-e+Math.PI/2,t),s.setFromSpherical(Le).normalize(),function(e){const{x:t,y:s,z:n}=e;e.x=n,e.y=t,e.z=s}(s),s}getPositionToNormal(e,t){const s=this.radius;return t.copy(e),t.x/=s.x**2,t.y/=s.y**2,t.z/=s.z**2,t.normalize(),t}getPositionToSurfacePoint(e,t){const s=this.radius,n=1/s.x**2,r=1/s.y**2,i=1/s.z**2,o=e.x*e.x*n,a=e.y*e.y*r,l=e.z*e.z*i,c=o+a+l,h=Math.sqrt(1/c),u=Me.copy(e).multiplyScalar(h);if(c<.1)return isFinite(h)?t.copy(u):null;const d=Oe.set(u.x*n*2,u.y*r*2,u.z*i*2);let p,m,g,_,f,b,w,T,y,x,S,C=(1-h)*e.length()/(.5*d.length()),E=0;do{C-=E,g=1/(1+C*n),_=1/(1+C*r),f=1/(1+C*i),b=g*g,w=_*_,T=f*f,y=b*g,x=w*_,S=T*f,p=o*b+a*w+l*T-1,m=o*y*n+a*x*r+l*S*i;E=p/(-2*m)}while(Math.abs(p)>1e-12);return t.set(e.x*g,e.y*_,e.z*f)}calculateHorizonDistance(e,t){const s=this.calculateEffectiveRadius(e);return Math.sqrt(2*s*t+t**2)}calculateEffectiveRadius(e){const t=this.radius.x,s=1-this.radius.z**2/t**2,n=e*b.DEG2RAD,r=Math.sin(n)**2;return t/Math.sqrt(1-s*r)}getPositionElevation(e){this.getPositionToSurfacePoint(e,Me);const t=Oe.subVectors(e,Me);return Math.sign(t.dot(e))*t.length()}}const je=Math.PI,He=je/2,We=new r,Ge=new r,qe=new r,Je=new e;let Qe=0;const Ye=[];function Ze(e=!1){return e?(Ye[Qe]||(Ye[Qe]=new r),Qe++,Ye[Qe-1]):new r}function $e(){Qe=0}class Ke extends ze{constructor(e,t,s,n=-He,r=He,i=0,o=2*je,a=0,l=0){super(e,t,s),this.latStart=n,this.latEnd=r,this.lonStart=i,this.lonEnd=o,this.heightStart=a,this.heightEnd=l}_getPoints(e=!1){const{latStart:t,latEnd:s,lonStart:n,lonEnd:r,heightStart:i,heightEnd:o}=this,a=b.mapLinear(.5,0,1,t,s),l=b.mapLinear(.5,0,1,n,r),c=Math.floor(n/He)*He,h=[[-je/2,0],[je/2,0],[0,c],[0,c+je/2],[0,c+je],[0,c+3*je/2],[t,r],[s,r],[t,n],[s,n],[0,n],[0,r],[a,l],[t,l],[s,l],[a,n],[a,r]],u=[],d=h.length;for(let p=0;p<=1;p++){const a=b.mapLinear(p,0,1,i,o);for(let i=0,o=d;i<o;i++){const[o,l]=h[i];if(o>=t&&o<=s&&l>=n&&l<=r){const t=Ze(e);u.push(t),this.getCartographicToPosition(o,l,a,t)}}}return u}getBoundingBox(e,t){$e();const{latStart:s,latEnd:n,lonStart:r,lonEnd:i}=this;if(n-s<je/2){const e=b.mapLinear(.5,0,1,s,n),o=b.mapLinear(.5,0,1,r,i);this.getCartographicToNormal(e,o,qe),Ge.set(0,0,1),We.crossVectors(Ge,qe),Ge.crossVectors(We,qe),t.makeBasis(We,Ge,qe)}else We.set(1,0,0),Ge.set(0,1,0),qe.set(0,0,1),t.makeBasis(We,Ge,qe);Je.copy(t).invert();const o=this._getPoints(!0);for(let a=0,l=o.length;a<l;a++)o[a].applyMatrix4(Je);e.makeEmpty(),e.setFromPoints(o)}getBoundingSphere(e,t){$e();const s=this._getPoints(!0);e.makeEmpty(),e.setFromPoints(s,t)}}const Xe=new r,et=new r,tt=new r,st=new r,nt=new r,rt=new r,it=new d;class ot{constructor(){this.sphere=null,this.obb=null,this.region=null,this.regionObb=null}intersectsRay(e){const t=this.sphere,s=this.obb||this.regionObb;return!(t&&!e.intersectsSphere(t))&&!(s&&(it.copy(e).applyMatrix4(s.inverseTransform),!it.intersectsBox(s.box)))}intersectRay(e,t=null){const s=this.sphere,n=this.obb||this.regionObb;let r=-1/0,i=-1/0;s&&e.intersectSphere(s,nt)&&(r=s.containsPoint(e.origin)?0:e.origin.distanceToSquared(nt)),n&&(it.copy(e).applyMatrix4(n.inverseTransform),it.intersectBox(n.box,rt)&&(i=n.box.containsPoint(it.origin)?0:it.origin.distanceToSquared(rt)));const o=Math.max(r,i);return o===-1/0?null:(e.at(Math.sqrt(o),t),t)}distanceToPoint(e){const t=this.sphere,s=this.obb||this.regionObb;let n=-1/0,r=-1/0;return t&&(n=Math.max(t.distanceToPoint(e),0)),s&&(st.copy(e).applyMatrix4(s.inverseTransform),r=s.box.distanceToPoint(st)),n>r?n:r}intersectsFrustum(e){const t=this.obb||this.regionObb,s=this.sphere;return!(s&&!e.intersectsSphere(s))&&(!(t&&!t.intersectsFrustum(e))&&Boolean(s||t))}getOBB(e,t){const s=this.obb||this.regionObb;s?(e.copy(s.box),t.copy(s.transform)):(this.getAABB(e),t.identity())}getAABB(e){if(this.sphere)this.sphere.getBoundingBox(e);else{const t=this.obb||this.regionObb;e.copy(t.box).applyMatrix4(t.transform)}}getSphere(e){if(this.sphere)e.copy(this.sphere);else if(this.region)this.region.getBoundingSphere(e);else{const t=this.obb||this.regionObb;t.box.getBoundingSphere(e),e.applyMatrix4(t.transform)}}setObbData(e,t){const s=new Re;Xe.set(e[3],e[4],e[5]),et.set(e[6],e[7],e[8]),tt.set(e[9],e[10],e[11]);const n=Xe.length(),r=et.length(),i=tt.length();Xe.normalize(),et.normalize(),tt.normalize(),0===n&&Xe.crossVectors(et,tt),0===r&&et.crossVectors(Xe,tt),0===i&&tt.crossVectors(Xe,et),s.transform.set(Xe.x,et.x,tt.x,e[0],Xe.y,et.y,tt.y,e[1],Xe.z,et.z,tt.z,e[2],0,0,0,1).premultiply(t),s.box.min.set(-n,-r,-i),s.box.max.set(n,r,i),s.update(),this.obb=s}setSphereData(e,t,s,n,r){const i=new f;i.center.set(e,t,s),i.radius=n,i.applyMatrix4(r),this.sphere=i}setRegionData(e,t,s,n,r,i){const o=new Ke(L,L,6356752.314245179,t,n,e,s,r,i),a=new Re;o.getBoundingBox(a.box,a.transform),a.update(),this.region=o,this.regionObb=a}}const at=new w;class lt extends T{constructor(){super(),this.points=Array(8).fill().map((()=>new r))}setFromProjectionMatrix(e,t){super.setFromProjectionMatrix(e,t),this.calculateFrustumPoints()}calculateFrustumPoints(){const{planes:e,points:t}=this;[[e[0],e[3],e[4]],[e[1],e[3],e[4]],[e[0],e[2],e[4]],[e[1],e[2],e[4]],[e[0],e[3],e[5]],[e[1],e[3],e[5]],[e[0],e[2],e[5]],[e[1],e[2],e[5]]].forEach(((e,s)=>{!function(e,t,s,n){const r=at.set(e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z,s.normal.x,s.normal.y,s.normal.z);n.set(-e.constant,-t.constant,-s.constant),n.applyMatrix3(r.invert())}(e[0],e[1],e[2],t[s])}))}}const ct=parseInt(p)<165,ht=Symbol("INITIAL_FRUSTUM_CULLED"),ut=new e,dt=new e,pt=new r,mt=new r(1,0,0),gt=new r(0,1,0);function _t(e,t){e.traverse((e=>{e.frustumCulled=e[ht]&&t}))}class ft extends j{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel((t=>{_t(t,!e)})))}constructor(...e){super(...e),this.group=new ge(this),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this.activeTiles=new Set,this.visibleTiles=new Set,this.optimizeRaycast=!0,this._autoDisableRendererCulling=!0,this._eventDispatcher=new y,this.onLoadTileSet=null,this.onLoadModel=null,this.onDisposeModel=null,this.onTileVisibilityChange=null;const t=new S;if(t.setURLModifier((e=>this.preprocessURL?this.preprocessURL(e):e)),this.manager=t,ct){const e=this;this._overridenRaycast=function(t,s){e.optimizeRaycast||Object.getPrototypeOf(this).raycast.call(this,t,s)}}}addEventListener(...e){this._eventDispatcher.addEventListener(...e)}hasEventListener(...e){this._eventDispatcher.hasEventListener(...e)}removeEventListener(...e){this._eventDispatcher.removeEventListener(...e)}dispatchEvent(...e){this._eventDispatcher.dispatchEvent(...e)}getBounds(...e){return console.warn("TilesRenderer: getBounds has been renamed to getBoundingBox."),this.getBoundingBox(...e)}getOrientedBounds(...e){return console.warn("TilesRenderer: getOrientedBounds has been renamed to getOrientedBoundingBox."),this.getOrientedBoundingBox(...e)}getBoundingBox(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return!t||(t.getAABB(e),!0)}getOrientedBoundingBox(e,t){if(!this.root)return!1;const s=this.root.cached.boundingVolume;return!s||(s.getOBB(e,t),!0)}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return!!t&&(t.getSphere(e),!0)}forEachLoadedModel(e){this.traverse((t=>{const s=t.cached.scene;s&&e(s,t)}))}raycast(e,t){if(this.root)if(e.firstHitOnly){const s=Se(this,this.root,e);s&&t.push(s)}else Ce(this,this.root,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,s=this.cameraMap;return!s.has(e)&&(s.set(e,new x),t.push(e),!0)}setResolution(e,t,s){const n=this.cameraMap;return!!n.has(e)&&(t instanceof x?n.get(e).copy(t):n.get(e).set(t,s),!0)}setResolutionFromRenderer(e,t){const s=this.cameraMap;if(!s.has(e))return!1;const n=s.get(e);return t.getSize(n),n.multiplyScalar(t.getPixelRatio()),!0}deleteCamera(e){const t=this.cameras,s=this.cameraMap;if(s.has(e)){const n=t.indexOf(e);return t.splice(n,1),s.delete(e),!0}return!1}fetchTileSet(e,...t){const s=super.fetchTileSet(e,...t);return s.then((t=>{queueMicrotask((()=>{this.dispatchEvent({type:"load-tile-set",tileSet:t,url:e}),this.onLoadTileSet&&this.onLoadTileSet(t,e)}))})).catch((()=>{})),s}update(){const e=this.group,t=this.cameras,s=this.cameraMap,n=this.cameraInfo;if(0===t.length)return void console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.");for(;n.length>t.length;)n.pop();for(;n.length<t.length;)n.push({frustum:new lt,isOrthographic:!1,sseDenominator:-1,position:new r,invScale:-1,pixelSize:0});dt.copy(e.matrixWorld).invert(),pt.setFromMatrixScale(dt);const i=pt.x;Math.abs(Math.max(pt.x-pt.y,pt.x-pt.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let r=0,o=n.length;r<o;r++){const o=t[r],a=n[r],l=a.frustum,c=a.position,h=s.get(o);0!==h.width&&0!==h.height||console.warn("TilesRenderer: resolution for camera error calculation is not set.");const u=o.projectionMatrix.elements;if(a.isOrthographic=1===u[15],a.isOrthographic){const e=2/u[0],t=2/u[5];a.pixelSize=Math.max(t/h.height,e/h.width)}else a.sseDenominator=2/u[5]/h.height;a.invScale=i,ut.copy(e.matrixWorld),ut.premultiply(o.matrixWorldInverse),ut.premultiply(o.projectionMatrix),l.setFromProjectionMatrix(ut),c.set(0,0,0),c.applyMatrix4(o.matrixWorld),c.applyMatrix4(dt)}super.update()}preprocessNode(t,s,n=null){super.preprocessNode(t,s,n);const r=new e;if(t.transform){const e=t.transform;for(let t=0;t<16;t++)r.elements[t]=e[t]}n&&r.premultiply(n.cached.transform);const i=(new e).copy(r).invert(),o=new ot;"sphere"in t.boundingVolume&&o.setSphereData(...t.boundingVolume.sphere,r),"box"in t.boundingVolume&&o.setObbData(t.boundingVolume.box,r),"region"in t.boundingVolume&&o.setRegionData(...t.boundingVolume.region),t.cached={loadIndex:0,transform:r,transformInverse:i,active:!1,inFrustum:[],boundingVolume:o,scene:null,geometry:null,materials:null,textures:null}}parseTile(t,s,n){s._loadIndex=s._loadIndex||0,s._loadIndex++;const r=s.content.uri.split(/[\\/]/g);r.pop();const i=r.join("/"),o=this.fetchOptions,a=this.manager,l=s._loadIndex;let c=null;const h=this.rootTileSet.asset&&this.rootTileSet.asset.gltfUpAxis||"y",u=s.cached,d=u.transform,p=new e;switch(h.toLowerCase()){case"x":p.makeRotationAxis(gt,-Math.PI/2);break;case"y":p.makeRotationAxis(mt,Math.PI/2)}const m=(Q(t)||n).toLowerCase();switch(m){case"b3dm":{const e=new Z(a);e.workingPath=i,e.fetchOptions=o,e.adjustmentTransform.copy(p),c=e.parse(t);break}case"pnts":{const e=new ee(a);e.workingPath=i,e.fetchOptions=o,c=e.parse(t);break}case"i3dm":{const e=new ce(a);e.workingPath=i,e.fetchOptions=o,e.adjustmentTransform.copy(p),c=e.parse(t);break}case"cmpt":{const e=new ue(a);e.workingPath=i,e.fetchOptions=o,e.adjustmentTransform.copy(p),c=e.parse(t).then((e=>e.scene));break}case"gltf":case"glb":{const e=new pe(a);e.workingPath=i,e.fetchOptions=o,c=e.parse(t);break}default:console.warn('TilesRenderer: Content type "'.concat(m,'" not supported.')),c=Promise.resolve(null)}return c.then((e=>{let t,n;if(e.isObject3D?(t=e,n=null):(t=e.scene,n=e),s._loadIndex!==l)return;t.updateMatrix(),"glb"!==m&&"gltf"!==m||t.matrix.multiply(p),t.matrix.premultiply(d),t.matrix.decompose(t.position,t.quaternion,t.scale),t.traverse((e=>{e[ht]=e.frustumCulled})),_t(t,!this.autoDisableRendererCulling),ct&&t.traverse((e=>{e.raycast=this._overridenRaycast}));const r=[],i=[],o=[];t.traverse((e=>{if(e.geometry&&i.push(e.geometry),e.material){const t=e.material;r.push(e.material);for(const e in t){const s=t[e];s&&s.isTexture&&o.push(s)}}})),u.materials=r,u.geometry=i,u.textures=o,u.scene=t,u.metadata=n,this.dispatchEvent({type:"load-model",scene:t,tile:s}),this.onLoadModel&&this.onLoadModel(t,s)}))}disposeTile(e){const t=e.cached;if(t.scene){const s=t.materials,n=t.geometry,r=t.textures,i=t.scene.parent;t.scene.traverse((e=>{e.userData.meshFeatures&&e.userData.meshFeatures.dispose(),e.userData.structuralMetadata&&e.userData.structuralMetadata.dispose()}));for(let e=0,t=n.length;e<t;e++)n[e].dispose();for(let e=0,t=s.length;e<t;e++)s[e].dispose();for(let e=0,t=r.length;e<t;e++){const t=r[e];t.image instanceof ImageBitmap&&t.image.close(),t.dispose()}i&&i.remove(t.scene),this.dispatchEvent({type:"dispose-model",scene:t.scene,tile:e}),this.onDisposeModel&&this.onDisposeModel(t.scene,e),t.scene=null,t.materials=null,t.textures=null,t.geometry=null,t.metadata=null}this.activeTiles.delete(e),this.visibleTiles.delete(e),e._loadIndex++}setTileVisible(e,t){const s=e.cached.scene,n=this.visibleTiles,r=this.group;t?(r.add(s),n.add(e),s.updateMatrixWorld(!0)):(r.remove(s),n.delete(e)),this.dispatchEvent({type:"tile-visibility-change",scene:s,tile:e,visible:t}),this.onTileVisibilityChange&&this.onTileVisibilityChange(s,e,t)}setTileActive(e,t){const s=this.activeTiles;t?s.add(e):s.delete(e)}calculateError(e){const t=e.cached,s=t.inFrustum,n=this.cameras,r=this.cameraInfo,i=t.boundingVolume;let o=-1/0,a=1/0;for(let l=0,c=n.length;l<c;l++){if(!s[l])continue;const t=r[l],n=t.invScale;let c;if(t.isOrthographic){const s=t.pixelSize;c=e.geometricError/(s*n)}else{const s=i.distanceToPoint(t.position)*n,r=t.sseDenominator;c=e.geometricError/(s*r),a=Math.min(a,s)}o=Math.max(o,c)}e.__distanceFromCamera=a,e.__error=o}tileInView(e){const t=e.cached,s=t.boundingVolume,n=t.inFrustum,r=this.cameraInfo;let i=!1;for(let o=0,a=r.length;o<a;o++){const e=r[o].frustum;s.intersectsFrustum(e)?(i=!0,n[o]=!0):n[o]=!1}return i}}export{ft as T};
