import{_ as t}from"./@tresjs.BCHtwiaC1763540743861.js";import{B as o}from"./three-custom-shader-material.C6taB_aY1763540743861.js";import{d as e,a6 as i,w as r,H as n,o as l,u as a}from"./@vue.Co_gxueH1763540743861.js";import{x as u,ae as m,l as s}from"./three.rXKzP9fQ1763540743861.js";const d=["object"],f=e({__name:"bModel",props:{model:{},bulidingsColor:{default:"#e523ff"},landColor:{default:"#112233"},topColor:{default:"#ffff00"},opacity:{default:.9},gradient:{type:Boolean,default:!0}},setup(e){const f=e,c=f.model.city;f.model.model.children[0].material=new u({color:"#ffff00"}),c.renderOrder=1001;const v=f.model.land;(()=>{const{geometry:t}=c;t.computeBoundingBox(),t.computeBoundingSphere();const{max:e,min:i}=t.boundingBox;if(c.material.__csm)return;const r=new o({al:c.material,vertexShader:"\n\t\tvarying vec4 vPosition;\n\t\tvoid main() {\n\t\t\tvPosition = modelMatrix * vec4(position,1.0);\n\t\t\tcsm_Position = position * vec3(1.0);\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform mat4 modelMatrix;\n\t\tvarying vec4 vPosition;\n\t\tuniform vec3 uMax; \n\t\tuniform vec3 uMin; \n\t\tuniform float uOpacity;  \n\t\tuniform float uBorderWidth; \n\t\tuniform vec3 uLightColor;\n\t\tuniform vec3 uColor;\n\t\tuniform float uCircleTime; \n\t\tuniform float uTime; \n\t\tuniform vec3 uTopColor;\t\t\t\t\t//顶部颜色\n\t\tuniform bool uGradient;\n\t\tvec4 uMax_world;\n\t\tvec4 uMin_world;\n\t\tvoid main() {\n\t\t\t// 转世界坐标\n\t\t\tuMax_world =  modelMatrix * vec4(uMax,1.0);\n\t\t\tuMin_world =  modelMatrix * vec4(uMin,1.0);\n\t\t\tvec3 distColor = uColor;\n\t\t\tfloat residue = uTime - floor(uTime / uCircleTime) * uCircleTime;\n\t\t\tfloat rate = residue / uCircleTime;\n\t\t\tfloat lightOffset = rate * (uMax_world.y - uMin_world.y);\n\n\t\t\tif (uMin_world.y + lightOffset < vPosition.y && uMin_world.y + lightOffset + uBorderWidth > vPosition.y) {\n\t\t\t\tcsm_DiffuseColor = vec4(uLightColor, uOpacity);\n\t\t\t} else {\n\t\t\t\tcsm_DiffuseColor = vec4(distColor, uOpacity);\n\t\t\t}\n\n\t\t\t//根据高度计算颜色\n\t\t\tif(uGradient){\n\t\t\t\tfloat rateHight = (vPosition.y - uMin_world.y) / (uMax_world.y - uMin_world.y); \n\t\t\t\tvec3 outColor = mix(csm_DiffuseColor.xyz, uTopColor, rateHight*2.0);\n\t\t\t\tcsm_DiffuseColor = vec4(outColor, uOpacity);\n\t\t\t}\n    }\n\t\t",silent:!0,uniforms:{uMax:{value:e},uMin:{value:i},uBorderWidth:{value:5},uCircleTime:{value:5},uColor:{value:new s(f.bulidingsColor)},uOpacity:{value:f.opacity},uLightColor:{value:new s("#ffffff")},uTopColor:{value:new s(f.topColor)},uTime:{value:0},uGradient:{value:f.gradient}},depthWrite:!0,depthTest:!0,transparent:!0,side:m});c.material.dispose(),c.material=r})();const{onBeforeRender:p}=t();p(({delta:t})=>{c.material.uniforms.uTime.value+=t}),i(()=>{f.bulidingsColor&&c.material.uniforms.uColor.value.setStyle(f.bulidingsColor),f.landColor&&((t,o)=>{let e;e=Array.isArray(v.material)?v.material:[v.material],e.forEach(t=>{t[o].setStyle(f.landColor),t.side=m})})(0,"color"),f.opacity&&(c.material.uniforms.uOpacity.value=f.opacity)}),r(f,(t,o)=>{c.material.uniforms.uGradient.value=t.gradient});const C=f.model.model.clone();return(t,o)=>(l(),n("primitive",{object:a(C)},null,8,d))}});export{f as _};
