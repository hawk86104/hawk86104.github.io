import{D as t,M as e,G as s,V as i,a as r,b as n,P as a,B as o,c as l,C as c,d as h,S as d,R as u,E as p,e as m,I as f,Q as g,f as y,g as _,h as b,F as x,i as T,j as v,T as w,L as P,k as C,l as M,m as S,n as A,o as E,p as D,q as U,O as R,r as I,s as L,t as F,W as k,u as O,v as z,w as V,Z as N,x as B,y as W,z as j,A as G,H,U as q,J as Z}from"./three.COeOkYug1753782659653.js";function $(t){if(!t)return null;const e=t.replace(/[a-z]+:\/\/[^/]+/i,"").replace(/\?.*$/i,"").replace(/.*\//g,""),s=e.lastIndexOf(".");return-1===s?null:e.substring(s+1)||null}class Q{get unloadPriorityCallback(){return this._unloadPriorityCallback}set unloadPriorityCallback(t){1===t.length?(console.warn('LRUCache: "unloadPriorityCallback" function has been changed to take two arguments.'),this._unloadPriorityCallback=(e,s)=>{const i=t(e),r=t(s);return i<r?-1:i>r?1:0}):this._unloadPriorityCallback=t}constructor(){this.minSize=6e3,this.maxSize=8e3,this.minBytesSize=322122547.2,this.maxBytesSize=429496729.6,this.unloadPercent=.05,this.autoMarkUnused=!0,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadingHandle=-1,this.cachedBytes=0,this.bytesMap=new Map,this.loadedSet=new Set,this._unloadPriorityCallback=null,this.computeMemoryUsageCallback=()=>null;const t=this.itemSet;this.defaultPriorityCallback=e=>t.get(e)}isFull(){return this.itemSet.size>=this.maxSize||this.cachedBytes>=this.maxBytesSize}getMemoryUsage(t){return this.bytesMap.get(t)??null}add(t,e){const s=this.itemSet;if(s.has(t))return!1;if(this.isFull())return!1;const i=this.usedSet,r=this.itemList,n=this.callbacks,a=this.bytesMap;r.push(t),i.add(t),s.set(t,Date.now()),n.set(t,e);const o=this.computeMemoryUsageCallback(t);return this.cachedBytes+=o||0,a.set(t,o),!0}has(t){return this.itemSet.has(t)}remove(t){const e=this.usedSet,s=this.itemSet,i=this.itemList,r=this.bytesMap,n=this.callbacks,a=this.loadedSet;if(s.has(t)){this.cachedBytes-=r.get(t)||0,r.delete(t),n.get(t)(t);const o=i.indexOf(t);return i.splice(o,1),e.delete(t),s.delete(t),n.delete(t),a.delete(t),!0}return!1}setLoaded(t,e){const{itemSet:s,loadedSet:i}=this;s.has(t)&&(!0===e?i.add(t):i.delete(t))}updateMemoryUsage(t){const e=this.itemSet,s=this.bytesMap;if(!e.has(t))return;this.cachedBytes-=s.get(t)||0;const i=this.computeMemoryUsageCallback(t);s.set(t,i),this.cachedBytes+=i}markUsed(t){const e=this.itemSet,s=this.usedSet;e.has(t)&&!s.has(t)&&(e.set(t,Date.now()),s.add(t))}markUnused(t){this.usedSet.delete(t)}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const{unloadPercent:t,minSize:e,maxSize:s,itemList:i,itemSet:r,usedSet:n,loadedSet:a,callbacks:o,bytesMap:l,minBytesSize:c,maxBytesSize:h}=this,d=i.length-n.size,u=i.length-a.size,p=Math.max(Math.min(i.length-e,d),0),m=this.cachedBytes-c,f=this.unloadPriorityCallback||this.defaultPriorityCallback;let g=!1;const y=p>0&&d>0||u&&i.length>s;if(d&&this.cachedBytes>c||u&&this.cachedBytes>h||y){i.sort(((t,e)=>{const s=n.has(t);if(s===n.has(e)){const s=a.has(t);return s===a.has(e)?-f(t,e):s?1:-1}return s?1:-1}));const u=Math.max(e*t,p*t),y=Math.ceil(Math.min(u,d,p)),_=Math.max(t*m,t*c),b=Math.min(_,m);let x=0,T=0;for(;this.cachedBytes-T>h||i.length-x>s;){const t=i[x],e=l.get(t)||0;if(n.has(t)&&a.has(t)||this.cachedBytes-T-e<h&&i.length-x<=s)break;T+=e,x++}for(;T<b||x<y;){const t=i[x],e=l.get(t)||0;if(n.has(t)||this.cachedBytes-T-e<c&&x>=y)break;T+=e,x++}i.splice(0,x).forEach((t=>{this.cachedBytes-=l.get(t)||0,o.get(t)(t),l.delete(t),r.delete(t),o.delete(t),a.delete(t),n.delete(t)})),g=x<p||T<m&&x<d,g=g&&x>0}g&&(this.unloadingHandle=requestAnimationFrame((()=>this.scheduleUnload())))}scheduleUnload(){cancelAnimationFrame(this.unloadingHandle),this.scheduled||(this.scheduled=!0,queueMicrotask((()=>{this.scheduled=!1,this.unloadUnusedContent()})))}}class Y{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=t=>{requestAnimationFrame(t)},this._runjobs=()=>{this.scheduled=!1,this.tryRunJobs()}}sort(){const t=this.priorityCallback;this.items.sort(t)}has(t){return this.callbacks.has(t)}add(t,e){return new Promise(((s,i)=>{const r=this.items,n=this.callbacks;r.push(t),n.set(t,{callback:e,resolve:s,reject:i}),this.autoUpdate&&this.scheduleJobRun()}))}remove(t){const e=this.items,s=this.callbacks,i=e.indexOf(t);-1!==i&&(e.splice(i,1),s.delete(t))}tryRunJobs(){this.sort();const t=this.items,e=this.callbacks,s=this.maxJobs;let i=0;const r=()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()};for(;s>this.currJobs&&t.length>0&&i<s;){this.currJobs++,i++;const s=t.pop(),{callback:a,resolve:o,reject:l}=e.get(s);let c;e.delete(s);try{c=a(s)}catch(n){l(n),r()}c instanceof Promise?c.then(o).catch(l).finally(r):(o(c),r())}}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const J=-1,X=6378137,K={inView:!1,error:1/0,distance:1/0};function tt(t){return 3===t||t===J}function et(t,e){return t.__lastFrameVisited===e&&t.__used}function st(t){return t.__childrenProcessed===t.children.length}function it(t,e){t.__lastFrameVisited!==e.frameCount&&(t.__lastFrameVisited=e.frameCount,t.__used=!1,t.__inFrustum=!1,t.__isLeaf=!1,t.__visible=!1,t.__active=!1,t.__error=1/0,t.__distanceFromCamera=1/0,t.__childrenWereVisible=!1,t.__allChildrenLoaded=!1,e.calculateTileViewError(t,K),t.__inFrustum=K.inView,t.__error=K.error,t.__distanceFromCamera=K.distance)}function rt(t,e){if(e.ensureChildrenArePreprocessed(t),it(t,e),at(t,e),!t.__hasRenderableContent&&st(t)){const s=t.children;for(let t=0,i=s.length;t<i;t++)rt(s[t],e)}}function nt(t,e){if(e.ensureChildrenArePreprocessed(t),et(t,e.frameCount)&&(t.__hasContent&&0===t.__loadingState&&!e.lruCache.isFull()&&e.queueTileForDownload(t),st(t))){const s=t.children;for(let t=0,i=s.length;t<i;t++)nt(s[t],e)}}function at(t,e){t.__used||(t.__used=!0,e.markTileUsed(t),e.stats.used++,!0===t.__inFrustum&&e.stats.inFrustum++)}function ot(t,e=null,s=null){const i=[];for(i.push(t),i.push(null),i.push(0);i.length>0;){const t=i.pop(),r=i.pop(),n=i.pop();if(e&&e(n,r,t))return void(s&&s(n,r,t));const a=n.children;if(a)for(let e=a.length-1;e>=0;e--)i.push(a[e]),i.push(n),i.push(t+1);s&&s(n,r,t)}}function lt(t,e){if(e.ensureChildrenArePreprocessed(t),it(t,e),!t.__inFrustum)return;if(!function(t,e){return!(t.__error<=e.errorTarget||e.maxDepth>0&&t.__depth+1>=e.maxDepth||!st(t))}(t,e))return void at(t,e);let s=!1,i=!1;const r=t.children;for(let n=0,a=r.length;n<a;n++){const t=r[n];lt(t,e),s=s||et(t,e.frameCount),i=i||t.__inFrustum}if("REPLACE"!==t.refine||i||0===r.length||t.__hasUnrenderableContent){if(at(t,e),s&&"REPLACE"===t.refine)for(let n=0,a=r.length;n<a;n++){rt(r[n],e)}}else t.__inFrustum=!1}function ct(t,e){const s=e.frameCount;if(!et(t,s))return;const i=t.children;let r=!1;for(let n=0,a=i.length;n<a;n++){const t=i[n];r=r||et(t,s)}if(r){let r=!1,n=!0;for(let t=0,a=i.length;t<a;t++){const a=i[t];if(ct(a,e),r=r||a.__wasSetVisible||a.__childrenWereVisible,et(a,s)){const t=a.__allChildrenLoaded||a.__hasRenderableContent&&tt(a.__loadingState)||!a.__hasContent&&0===a.children.length||a.__hasUnrenderableContent&&a.__loadingState===J;n=n&&t}}t.__childrenWereVisible=r,t.__allChildrenLoaded=n}else t.__isLeaf=!0}function ht(t,e){const s=e.stats;if(!et(t,e.frameCount))return;const i=e.lruCache;if(t.__isLeaf)return void(3===t.__loadingState?(t.__inFrustum&&(t.__visible=!0,s.visible++),t.__active=!0,s.active++):!i.isFull()&&t.__hasContent&&e.queueTileForDownload(t));const r=t.children,n=t.__hasContent,a=tt(t.__loadingState)&&n,o=(e.errorTarget+1)*e.errorThreshold,l=t.__error<=o,c=t.__childrenWereVisible,h=t.__allChildrenLoaded;if((l||"ADD"===t.refine)&&!a&&!i.isFull()&&n&&e.queueTileForDownload(t),(l&&!h&&!c&&a||"ADD"===t.refine&&a)&&(t.__inFrustum&&(t.__visible=!0,s.visible++),t.__active=!0,s.active++),"REPLACE"===t.refine&&l&&!h)for(let d=0,u=r.length;d<u;d++){const t=r[d];et(t,e.frameCount)&&nt(t,e)}else for(let d=0,u=r.length;d<u;d++)ht(r[d],e)}function dt(t,e){const s=et(t,e.frameCount);if(s||t.__usedLastFrame){let i=!1,r=!1;s?(i=t.__active,r=e.displayActiveTiles&&t.__active||t.__visible):it(t,e),t.__hasRenderableContent&&3===t.__loadingState&&(t.__wasSetActive!==i&&e.invokeOnePlugin((e=>e.setTileActive&&e.setTileActive(t,i))),t.__wasSetVisible!==r&&e.invokeOnePlugin((e=>e.setTileVisible&&e.setTileVisible(t,r)))),t.__wasSetActive=i,t.__wasSetVisible=r,t.__usedLastFrame=s;const n=t.children;for(let t=0,s=n.length;t<s;t++){dt(n[t],e)}}}const ut=Symbol("PLUGIN_REGISTERED"),pt=(t,e)=>t.__depthFromRenderedParent!==e.__depthFromRenderedParent?t.__depthFromRenderedParent>e.__depthFromRenderedParent?-1:1:t.__inFrustum!==e.__inFrustum?t.__inFrustum?1:-1:t.__used!==e.__used?t.__used?1:-1:t.__error!==e.__error?t.__error>e.__error?1:-1:t.__distanceFromCamera!==e.__distanceFromCamera?t.__distanceFromCamera>e.__distanceFromCamera?-1:1:0,mt=(t,e)=>t.__depthFromRenderedParent!==e.__depthFromRenderedParent?t.__depthFromRenderedParent>e.__depthFromRenderedParent?1:-1:t.__loadingState!==e.__loadingState?t.__loadingState>e.__loadingState?-1:1:t.__lastFrameVisited!==e.__lastFrameVisited?t.__lastFrameVisited>e.__lastFrameVisited?-1:1:t.__hasUnrenderableContent!==e.__hasUnrenderableContent?t.__hasUnrenderableContent?-1:1:t.__error!==e.__error?t.__error>e.__error?-1:1:0;class ft{get root(){const t=this.rootTileSet;return t?t.root:null}get loadProgress(){const t=this.stats,e=t.downloading+t.parsing,s=t.inCacheSinceLoad;return 0===s?1:1-e/s}get errorThreshold(){return this._errorThreshold}set errorThreshold(t){console.warn('TilesRenderer: The "errorThreshold" option has been deprecated.'),this._errorThreshold=t}constructor(t=null){this.rootLoadingState=0,this.rootTileSet=null,this.rootURL=t,this.fetchOptions={},this.plugins=[],this.queuedTiles=[],this.cachedSinceLoadComplete=new Set;const e=new Q;e.unloadPriorityCallback=mt;const s=new Y;s.maxJobs=10,s.priorityCallback=pt;const i=new Y;i.maxJobs=1,i.priorityCallback=pt;const r=new Y;r.maxJobs=25,r.priorityCallback=pt,r.log=!0,this.visibleTiles=new Set,this.activeTiles=new Set,this.usedSet=new Set,this.lruCache=e,this.downloadQueue=s,this.parseQueue=i,this.processNodeQueue=r,this.stats={inCacheSinceLoad:0,inCache:0,parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this._errorThreshold=1/0,this.displayActiveTiles=!1,this.maxDepth=1/0}registerPlugin(t){if(!0===t[ut])throw new Error("TilesRendererBase: A plugin can only be registered to a single tile set");const e=this.plugins,s=t.priority||0;let i=e.length;for(let r=0;r<e.length;r++){if((e[r].priority||0)>s){i=r;break}}e.splice(i,0,t),t[ut]=!0,t.init&&t.init(this)}unregisterPlugin(t){const e=this.plugins;if("string"==typeof t&&(t=this.getPluginByName(name)),e.includes(t)){const s=e.indexOf(t);return e.splice(s,1),t.dispose&&t.dispose(),!0}return!1}getPluginByName(t){return this.plugins.find((e=>e.name===t))||null}traverse(t,e,s=!0){this.root&&ot(this.root,((e,...i)=>(s&&this.ensureChildrenArePreprocessed(e,!0),!!t&&t(e,...i))),e)}queueTileForDownload(t){0===t.__loadingState&&this.queuedTiles.push(t)}markTileUsed(t){this.usedSet.add(t),this.lruCache.markUsed(t)}update(){const{lruCache:t,usedSet:e,stats:s,root:i}=this;if(0===this.rootLoadingState&&(this.rootLoadingState=1,this.invokeOnePlugin((t=>t.loadRootTileSet&&t.loadRootTileSet())).then((t=>{this.rootLoadingState=3,this.rootTileSet=t,this.dispatchEvent({type:"load-content"}),this.dispatchEvent({type:"load-tile-set",tileSet:t})})).catch((t=>{this.rootLoadingState=J,console.error(t),this.rootTileSet=null,this.dispatchEvent({type:"load-error",tile:null,error:t})}))),!i)return;s.inFrustum=0,s.used=0,s.active=0,s.visible=0,this.frameCount++,e.forEach((e=>t.markUnused(e))),e.clear(),lt(i,this),ct(i,this),ht(i,this),dt(i,this);const r=this.queuedTiles;r.sort(t.unloadPriorityCallback);for(let n=0,a=r.length;n<a&&!t.isFull();n++)this.requestTileContents(r[n]);r.length=0,t.scheduleUnload()}resetFailedTiles(){this.rootLoadingState===J&&(this.rootLoadingState=0);const t=this.stats;0!==t.failed&&(this.traverse((t=>{t.__loadingState===J&&(t.__loadingState=0)}),null,!1),t.failed=0)}dispose(){this.plugins.forEach((t=>{this.unregisterPlugin(t)}));const t=this.lruCache,e=[];this.traverse((t=>(e.push(t),!1)),null,!1);for(let s=0,i=e.length;s<i;s++)t.remove(e[s]);this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}dispatchEvent(t){}fetchData(t,e){return fetch(t,e)}parseTile(t,e,s){return null}disposeTile(t){t.__visible&&(this.invokeOnePlugin((e=>e.setTileVisible&&e.setTileVisible(t,!1))),t.__visible=!1),t.__active&&(this.invokeOnePlugin((e=>e.setTileActive&&e.setTileActive(t,!1))),t.__active=!1)}preprocessNode(t,e,s=null){if(t.content&&(!("uri"in t.content)&&"url"in t.content&&(t.content.uri=t.content.url,delete t.content.url),t.content.boundingVolume&&!("box"in t.content.boundingVolume||"sphere"in t.content.boundingVolume||"region"in t.content.boundingVolume)&&delete t.content.boundingVolume),t.parent=s,t.children=t.children||[],t.content?.uri){const e=$(t.content.uri);t.__hasContent=!0,t.__hasUnrenderableContent=Boolean(e&&/json$/.test(e)),t.__hasRenderableContent=!t.__hasUnrenderableContent}else t.__hasContent=!1,t.__hasUnrenderableContent=!1,t.__hasRenderableContent=!1;t.__childrenProcessed=0,s&&s.__childrenProcessed++,t.__distanceFromCamera=1/0,t.__error=1/0,t.__inFrustum=!1,t.__isLeaf=!1,t.__usedLastFrame=!1,t.__used=!1,t.__wasSetVisible=!1,t.__visible=!1,t.__childrenWereVisible=!1,t.__allChildrenLoaded=!1,t.__wasSetActive=!1,t.__active=!1,t.__loadingState=0,null===s?(t.__depth=0,t.__depthFromRenderedParent=t.__hasRenderableContent?1:0,t.refine=t.refine||"REPLACE"):(t.__depth=s.__depth+1,t.__depthFromRenderedParent=s.__depthFromRenderedParent+(t.__hasRenderableContent?1:0),t.refine=t.refine||s.refine),t.__basePath=e,t.__lastFrameVisited=-1,this.invokeAllPlugins((i=>{i!==this&&i.preprocessNode&&i.preprocessNode(t,e,s)}))}setTileActive(t,e){e?this.activeTiles.add(t):this.activeTiles.delete(t)}setTileVisible(t,e){e?this.visibleTiles.add(t):this.visibleTiles.delete(t)}calculateTileViewError(t,e){}ensureChildrenArePreprocessed(t,e=!1){const s=t.children;for(let i=0,r=s.length;i<r;i++){const r=s[i];if("__depth"in r)break;e?(this.processNodeQueue.remove(r),this.preprocessNode(r,t.__basePath,t)):this.processNodeQueue.has(r)||this.processNodeQueue.add(r,(e=>{this.preprocessNode(e,t.__basePath,t)}))}}preprocessTileSet(t,e,s=null){const i=t.asset.version,[r,n]=i.split(".").map((t=>parseInt(t)));console.assert(r<=1,"TilesRenderer: asset.version is expected to be a 1.x or a compatible version."),1===r&&n>0&&console.warn("TilesRenderer: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let a=e.replace(/\/[^/]*\/?$/,"");a=new URL(a,window.location.href).toString(),this.preprocessNode(t.root,a,s)}loadRootTileSet(){let t=this.rootURL;this.invokeAllPlugins((e=>t=e.preprocessURL?e.preprocessURL(t,null):t));return this.invokeOnePlugin((e=>e.fetchData&&e.fetchData(t,this.fetchOptions))).then((e=>{if(e.ok)return e.json();throw new Error(`TilesRenderer: Failed to load tileset "${t}" with status ${e.status} : ${e.statusText}`)})).then((e=>(this.preprocessTileSet(e,t),e)))}requestTileContents(t){if(0!==t.__loadingState)return;let e=!1,s=new URL(t.content.uri,t.__basePath+"/").toString();this.invokeAllPlugins((e=>s=e.preprocessURL?e.preprocessURL(s,t):s));const i=this.stats,r=this.lruCache,n=this.downloadQueue,a=this.parseQueue,o=$(s),l=new AbortController,c=l.signal;return r.add(t,(s=>{l.abort(),e?(s.children.length=0,s.__childrenProcessed=0):this.invokeAllPlugins((t=>{t.disposeTile&&t.disposeTile(s)})),i.inCache--,this.cachedSinceLoadComplete.has(t)&&(this.cachedSinceLoadComplete.delete(t),i.inCacheSinceLoad--),1===s.__loadingState?i.downloading--:2===s.__loadingState&&i.parsing--,s.__loadingState=0,a.remove(s),n.remove(s)}))?(0===i.parsing&&0===i.downloading&&this.dispatchEvent({type:"tiles-load-start"}),this.cachedSinceLoadComplete.add(t),i.inCacheSinceLoad++,i.inCache++,i.downloading++,t.__loadingState=1,n.add(t,(t=>c.aborted?Promise.resolve():this.invokeOnePlugin((t=>t.fetchData&&t.fetchData(s,{...this.fetchOptions,signal:c}))))).then((t=>{if(!c.aborted){if(t.ok)return"json"===o?t.json():t.arrayBuffer();throw new Error(`Failed to load model with error code ${t.status}`)}})).then((r=>{if(!c.aborted)return i.downloading--,i.parsing++,t.__loadingState=2,a.add(t,(i=>c.aborted?Promise.resolve():"json"===o&&r.root?(this.preprocessTileSet(r,s,t),t.children.push(r.root),e=!0,Promise.resolve()):this.invokeOnePlugin((t=>t.parseTile&&t.parseTile(r,i,o,s,c)))))})).then((()=>{c.aborted||(i.parsing--,t.__loadingState=3,r.setLoaded(t,!0),null===r.getMemoryUsage(t)&&(r.isFull()&&r.computeMemoryUsageCallback(t)>0?r.remove(t):r.updateMemoryUsage(t)),this.dispatchEvent({type:"load-content"}),t.cached.scene&&this.dispatchEvent({type:"load-model",scene:t.cached.scene,tile:t}))})).catch((e=>{c.aborted||("AbortError"!==e.name?(a.remove(t),n.remove(t),2===t.__loadingState?i.parsing--:1===t.__loadingState&&i.downloading--,i.failed++,console.error(`TilesRenderer : Failed to load tile at url "${t.content.uri}".`),console.error(e),t.__loadingState=J,r.setLoaded(t,!0),this.dispatchEvent({type:"load-error",tile:t,error:e,uri:s})):r.remove(t))})).finally((()=>{0===i.parsing&&0===i.downloading&&(this.cachedSinceLoadComplete.clear(),i.inCacheSinceLoad=0,this.dispatchEvent({type:"tiles-load-end"}))}))):void 0}getAttributions(t=[]){return this.invokeAllPlugins((e=>e!==this&&e.getAttributions&&e.getAttributions(t))),t}invokeOnePlugin(t){const e=[...this.plugins,this];for(let s=0;s<e.length;s++){const i=t(e[s]);if(i)return i}return null}invokeAllPlugins(t){const e=[...this.plugins,this],s=[];for(let i=0;i<e.length;i++){const r=t(e[i]);r&&s.push(r)}return 0===s.length?null:Promise.all(s)}}const gt=new TextDecoder;function yt(t){return gt.decode(t)}function _t(t,e,s,i,r,n){let a,o;switch(i){case"SCALAR":a=1;break;case"VEC2":a=2;break;case"VEC3":a=3;break;case"VEC4":a=4;break;default:throw new Error(`FeatureTable : Feature type not provided for "${n}".`)}const l=s*a;switch(r){case"BYTE":o=new Int8Array(t,e,l);break;case"UNSIGNED_BYTE":o=new Uint8Array(t,e,l);break;case"SHORT":o=new Int16Array(t,e,l);break;case"UNSIGNED_SHORT":o=new Uint16Array(t,e,l);break;case"INT":o=new Int32Array(t,e,l);break;case"UNSIGNED_INT":o=new Uint32Array(t,e,l);break;case"FLOAT":o=new Float32Array(t,e,l);break;case"DOUBLE":o=new Float64Array(t,e,l);break;default:throw new Error(`FeatureTable : Feature component type not provided for "${n}".`)}return o}class bt{constructor(t,e,s,i){this.buffer=t,this.binOffset=e+s,this.binLength=i;let r=null;if(0!==s){const i=new Uint8Array(t,e,s);r=JSON.parse(yt(i))}else r={};this.header=r}getKeys(){return Object.keys(this.header)}getData(t,e,s=null,i=null){const r=this.header;if(!(t in r))return null;const n=r[t];if(n instanceof Object){if(Array.isArray(n))return n;{const{buffer:r,binOffset:a,binLength:o}=this,l=n.byteOffset||0,c=n.type||i,h=n.componentType||s;if("type"in n&&i&&n.type!==i)throw new Error("FeatureTable: Specified type does not match expected type.");const d=a+l,u=_t(r,d,e,c,h,t);if(d+u.byteLength>a+o)throw new Error("FeatureTable: Feature data read outside binary body length.");return u}}return n}getBuffer(t,e){const{buffer:s,binOffset:i}=this;return s.slice(i+t,i+t+e)}}class xt{constructor(t){this.batchTable=t;const e=t.header.extensions["3DTILES_batch_table_hierarchy"];this.classes=e.classes;for(const i of this.classes){const t=i.instances;for(const e in t)i.instances[e]=this._parseProperty(t[e],i.length,e)}if(this.instancesLength=e.instancesLength,this.classIds=this._parseProperty(e.classIds,this.instancesLength,"classIds"),e.parentCounts?this.parentCounts=this._parseProperty(e.parentCounts,this.instancesLength,"parentCounts"):this.parentCounts=new Array(this.instancesLength).fill(1),e.parentIds){const t=this.parentCounts.reduce(((t,e)=>t+e),0);this.parentIds=this._parseProperty(e.parentIds,t,"parentIds")}else this.parentIds=null;this.instancesIds=[];const s={};for(const i of this.classIds)s[i]=s[i]??0,this.instancesIds.push(s[i]),s[i]++}_parseProperty(t,e,s){if(Array.isArray(t))return t;{const{buffer:i,binOffset:r}=this.batchTable;return _t(i,r+t.byteOffset,e,"SCALAR",t.componentType||"UNSIGNED_SHORT",s)}}getDataFromId(t,e={}){const s=this.parentCounts[t];if(this.parentIds&&s>0){let i=0;for(let e=0;e<t;e++)i+=this.parentCounts[e];for(let r=0;r<s;r++){const s=this.parentIds[i+r];s!==t&&this.getDataFromId(s,e)}}const i=this.classIds[t],r=this.classes[i].instances,n=this.classes[i].name,a=this.instancesIds[t];for(const o in r)e[n]=e[n]||{},e[n][o]=r[o][a];return e}}class Tt extends bt{get batchSize(){return console.warn("BatchTable.batchSize has been deprecated and replaced with BatchTable.count."),this.count}constructor(t,e,s,i,r){super(t,s,i,r),this.count=e,this.extensions={};const n=this.header.extensions;n&&n["3DTILES_batch_table_hierarchy"]&&(this.extensions["3DTILES_batch_table_hierarchy"]=new xt(this))}getData(t,e=null,s=null){return console.warn("BatchTable: BatchTable.getData is deprecated. Use BatchTable.getDataFromId to get allproperties for an id or BatchTable.getPropertyArray for getting an array of value for a property."),super.getData(t,this.count,e,s)}getDataFromId(t,e={}){if(t<0||t>=this.count)throw new Error(`BatchTable: id value "${t}" out of bounds for "${this.count}" features number.`);for(const s of this.getKeys())"extensions"!==s&&(e[s]=super.getData(s,this.count)[t]);for(const s in this.extensions){const i=this.extensions[s];i.getDataFromId instanceof Function&&(e[s]=e[s]||{},i.getDataFromId(t,e[s]))}return e}getPropertyArray(t){return super.getData(t,this.count)}}class vt{constructor(){this.fetchOptions={},this.workingPath=""}load(t){return console.warn('Loader: "load" function has been deprecated in favor of "loadAsync".'),this.loadAsync(t)}loadAsync(t){return fetch(t,this.fetchOptions).then((e=>{if(!e.ok)throw new Error(`Failed to load file "${t}" with status ${e.status} : ${e.statusText}`);return e.arrayBuffer()})).then((e=>(""===this.workingPath&&(this.workingPath=this.workingPathForURL(t)),this.parse(e))))}resolveExternalURL(t){return/^[^\\/]/.test(t)&&!/^http/.test(t)?this.workingPath+"/"+t:t}workingPathForURL(t){const e=t.split(/[\\/]/g);e.pop();return e.join("/")+"/"}parse(t){throw new Error("LoaderBase: Parse not implemented.")}}function wt(t){let e;if(e=t instanceof DataView?t:new DataView(t),"{"===String.fromCharCode(e.getUint8(0)))return null;let s="";for(let i=0;i<4;i++)s+=String.fromCharCode(e.getUint8(i));return s}class Pt extends vt{parse(t){const e=new DataView(t),s=wt(e);console.assert("b3dm"===s);const i=e.getUint32(4,!0);console.assert(1===i);const r=e.getUint32(8,!0);console.assert(r===t.byteLength);const n=e.getUint32(12,!0),a=e.getUint32(16,!0),o=e.getUint32(20,!0),l=e.getUint32(24,!0),c=t.slice(28,28+n+a),h=new bt(c,0,n,a),d=28+n+a,u=t.slice(d,d+o+l),p=new Tt(u,h.getData("BATCH_LENGTH"),0,o,l),m=d+o+l;return{version:i,featureTable:h,batchTable:p,glbBytes:new Uint8Array(t,m,r-m)}}}class Ct extends Pt{constructor(s=t){super(),this.manager=s,this.adjustmentTransform=new e}parse(t){const e=super.parse(t),i=e.glbBytes.slice().buffer;return new Promise(((t,r)=>{const n=this.manager,a=this.fetchOptions,o=n.getHandler("path.gltf")||new s(n);"include"===a.credentials&&"cors"===a.mode&&o.setCrossOrigin("use-credentials"),"credentials"in a&&o.setWithCredentials("include"===a.credentials),a.headers&&o.setRequestHeader(a.headers);let l=this.workingPath;!/[\\/]$/.test(l)&&l.length&&(l+="/");const c=this.adjustmentTransform;o.parse(i,l,(s=>{const{batchTable:i,featureTable:r}=e,{scene:n}=s,a=r.getData("RTC_CENTER");a&&(n.position.x+=a[0],n.position.y+=a[1],n.position.z+=a[2]),s.scene.updateMatrix(),s.scene.matrix.multiply(c),s.scene.matrix.decompose(s.scene.position,s.scene.quaternion,s.scene.scale),s.batchTable=i,s.featureTable=r,n.batchTable=i,n.featureTable=r,t(s)}),r)}))}}class Mt extends vt{parse(t){const e=new DataView(t),s=wt(e);console.assert("pnts"===s);const i=e.getUint32(4,!0);console.assert(1===i);const r=e.getUint32(8,!0);console.assert(r===t.byteLength);const n=e.getUint32(12,!0),a=e.getUint32(16,!0),o=e.getUint32(20,!0),l=e.getUint32(24,!0),c=t.slice(28,28+n+a),h=new bt(c,0,n,a),d=28+n+a,u=t.slice(d,d+o+l),p=new Tt(u,h.getData("BATCH_LENGTH")||h.getData("POINTS_LENGTH"),0,o,l);return Promise.resolve({version:i,featureTable:h,batchTable:p})}}function St(t){const e=t>>11,s=t>>5&63,i=31&t;return[Math.round(e/31*255),Math.round(s/63*255),Math.round(i/31*255)]}const At=new r;function Et(t,e,s=new i){At.set(t,e).divideScalar(256).multiplyScalar(2).subScalar(1),s.set(At.x,At.y,1-Math.abs(At.x)-Math.abs(At.y));const r=n.clamp(-s.z,0,1);return s.x>=0?s.setX(s.x-r):s.setX(s.x+r),s.y>=0?s.setY(s.y-r):s.setY(s.y+r),s.normalize(),s}const Dt={RGB:"color",POSITION:"position"};class Ut extends Mt{constructor(e=t){super(),this.manager=e}parse(t){return super.parse(t).then((async t=>{const{featureTable:e,batchTable:s}=t,r=new a,n=e.header.extensions,d=new i;let u;if(n&&n["3DTILES_draco_point_compression"]){const{byteOffset:t,byteLength:s,properties:i}=n["3DTILES_draco_point_compression"],a=this.manager.getHandler("draco.drc");if(null==a)throw new Error("PNTSLoader: dracoLoader not available.");const o={};for(const e in i)if(e in Dt&&e in i){o[Dt[e]]=i[e]}const l={attributeIDs:o,attributeTypes:{position:"Float32Array",color:"Uint8Array"},useUniqueIDs:!0},c=e.getBuffer(t,s);u=await a.decodeGeometry(c,l),u.attributes.color&&(r.vertexColors=!0)}else{const t=e.getData("POINTS_LENGTH"),s=e.getData("POSITION",t,"FLOAT","VEC3"),n=e.getData("NORMAL",t,"FLOAT","VEC3"),a=e.getData("NORMAL",t,"UNSIGNED_BYTE","VEC2"),h=e.getData("RGB",t,"UNSIGNED_BYTE","VEC3"),p=e.getData("RGBA",t,"UNSIGNED_BYTE","VEC4"),m=e.getData("RGB565",t,"UNSIGNED_SHORT","SCALAR"),f=e.getData("CONSTANT_RGBA",t,"UNSIGNED_BYTE","VEC4"),g=e.getData("POSITION_QUANTIZED",t,"UNSIGNED_SHORT","VEC3"),y=e.getData("QUANTIZED_VOLUME_SCALE",t,"FLOAT","VEC3"),_=e.getData("QUANTIZED_VOLUME_OFFSET",t,"FLOAT","VEC3");if(u=new o,g){const e=new Float32Array(3*t);for(let s=0;s<t;s++)for(let t=0;t<3;t++){const i=3*s+t;e[i]=g[i]/65535*y[t]}d.x=_[0],d.y=_[1],d.z=_[2],u.setAttribute("position",new l(e,3,!1))}else u.setAttribute("position",new l(s,3,!1));if(null!==n)u.setAttribute("normal",new l(n,3,!1));else if(null!==a){const e=new Float32Array(3*t),s=new i;for(let i=0;i<t;i++){const t=Et(a[2*i],a[2*i+1],s);e[3*i]=t.x,e[3*i+1]=t.y,e[3*i+2]=t.z}u.setAttribute("normal",new l(e,3,!1))}if(null!==p)u.setAttribute("color",new l(p,4,!0)),r.vertexColors=!0,r.transparent=!0,r.depthWrite=!1;else if(null!==h)u.setAttribute("color",new l(h,3,!0)),r.vertexColors=!0;else if(null!==m){const e=new Uint8Array(3*t);for(let s=0;s<t;s++){const t=St(m[s]);for(let i=0;i<3;i++){e[3*s+i]=t[i]}}u.setAttribute("color",new l(e,3,!0)),r.vertexColors=!0}else if(null!==f){const t=new c(f[0],f[1],f[2]);r.color=t;const e=f[3]/255;e<1&&(r.opacity=e,r.transparent=!0,r.depthWrite=!1)}}const p=new h(u,r);p.position.copy(d),t.scene=p,t.scene.featureTable=e,t.scene.batchTable=s;const m=e.getData("RTC_CENTER");return m&&(t.scene.position.x+=m[0],t.scene.position.y+=m[1],t.scene.position.z+=m[2]),t}))}}class Rt extends vt{parse(t){const e=new DataView(t),s=wt(e);console.assert("i3dm"===s);const i=e.getUint32(4,!0);console.assert(1===i);const r=e.getUint32(8,!0);console.assert(r===t.byteLength);const n=e.getUint32(12,!0),a=e.getUint32(16,!0),o=e.getUint32(20,!0),l=e.getUint32(24,!0),c=e.getUint32(28,!0),h=t.slice(32,32+n+a),d=new bt(h,0,n,a),u=32+n+a,p=t.slice(u,u+o+l),m=new Tt(p,d.getData("INSTANCES_LENGTH"),0,o,l),f=u+o+l,g=new Uint8Array(t,f,r-f);let y=null,_=null,b=null;if(c)y=g,_=Promise.resolve();else{const t=this.resolveExternalURL(yt(g)),e=t.split(/[\\/]/g);e.pop(),b=e.join("/"),_=fetch(t,this.fetchOptions).then((e=>{if(!e.ok)throw new Error(`I3DMLoaderBase : Failed to load file "${t}" with status ${e.status} : ${e.statusText}`);return e.arrayBuffer()})).then((t=>{y=new Uint8Array(t)}))}return _.then((()=>({version:i,featureTable:d,batchTable:m,glbBytes:y,gltfWorkingPath:b})))}}new i;const It=new m,Lt=new i,Ft=new i,kt=new i,Ot=new e,zt=new e,Vt=new d,Nt=new p,Bt=new i,Wt=new i,jt=new i,Gt=new i,Ht=new u;class qt{constructor(t=1,e=1,s=1){this.name="",this.radius=new i(t,e,s)}intersectRay(t,e){return Ot.makeScale(...this.radius).invert(),Vt.center.set(0,0,0),Vt.radius=1,Ht.copy(t).applyMatrix4(Ot),Ht.intersectSphere(Vt,e)?(Ot.makeScale(...this.radius),e.applyMatrix4(Ot),e):null}getEastNorthUpFrame(t,e,s){return this.getEastNorthUpAxes(t,e,Bt,Wt,jt,Gt),s.makeBasis(Bt,Wt,jt).setPosition(Gt)}getEastNorthUpAxes(t,e,s,i,r,n=Gt){this.getCartographicToPosition(t,e,0,n),this.getCartographicToNormal(t,e,r),s.set(-n.y,n.x,0).normalize(),i.crossVectors(r,s).normalize()}getAzElRollFromRotationMatrix(t,e,s,i,r=0){return 1===r?(Nt.set(-Math.PI/2,0,0,"XYZ"),zt.makeRotationFromEuler(Nt).premultiply(s)):2===r?(Nt.set(-Math.PI/2,0,Math.PI,"XYZ"),zt.makeRotationFromEuler(Nt).premultiply(s)):zt.copy(s),this.getEastNorthUpFrame(t,e,Ot).invert(),zt.premultiply(Ot),Nt.setFromRotationMatrix(zt,"ZXY"),i.azimuth=-Nt.z,i.elevation=Nt.x,i.roll=Nt.y,i}getRotationMatrixFromAzElRoll(t,e,s,i,r,n,a=0){return this.getEastNorthUpFrame(t,e,Ot),Nt.set(i,r,-s,"ZXY"),n.makeRotationFromEuler(Nt).premultiply(Ot).setPosition(0,0,0),1===a?(Nt.set(Math.PI/2,0,0,"XYZ"),zt.makeRotationFromEuler(Nt),n.multiply(zt)):2===a&&(Nt.set(-Math.PI/2,0,Math.PI,"XYZ"),zt.makeRotationFromEuler(Nt),n.multiply(zt)),n}getFrame(t,e,s,i,r,n,a,o=0){return this.getRotationMatrixFromAzElRoll(t,e,s,i,r,a,o),this.getCartographicToPosition(t,e,n,Gt),a.setPosition(Gt),a}getCartographicToPosition(t,e,s,i){this.getCartographicToNormal(t,e,Lt);const r=this.radius;Ft.copy(Lt),Ft.x*=r.x**2,Ft.y*=r.y**2,Ft.z*=r.z**2;const n=Math.sqrt(Lt.dot(Ft));return Ft.divideScalar(n),i.copy(Ft).addScaledVector(Lt,s)}getPositionToCartographic(t,e){this.getPositionToSurfacePoint(t,Ft),this.getPositionToNormal(t,Lt);const s=kt.subVectors(t,Ft);return e.lon=Math.atan2(Lt.y,Lt.x),e.lat=Math.asin(Lt.z),e.height=Math.sign(s.dot(t))*s.length(),e}getCartographicToNormal(t,e,s){return It.set(1,-t+Math.PI/2,e),s.setFromSpherical(It).normalize(),function(t){const{x:e,y:s,z:i}=t;t.x=i,t.y=e,t.z=s}(s),s}getPositionToNormal(t,e){const s=this.radius;return e.copy(t),e.x/=s.x**2,e.y/=s.y**2,e.z/=s.z**2,e.normalize(),e}getPositionToSurfacePoint(t,e){const s=this.radius,i=1/s.x**2,r=1/s.y**2,n=1/s.z**2,a=t.x*t.x*i,o=t.y*t.y*r,l=t.z*t.z*n,c=a+o+l,h=Math.sqrt(1/c),d=Ft.copy(t).multiplyScalar(h);if(c<.1)return isFinite(h)?e.copy(d):null;const u=kt.set(d.x*i*2,d.y*r*2,d.z*n*2);let p,m,f,g,y,_,b,x,T,v,w,P=(1-h)*t.length()/(.5*u.length()),C=0;do{P-=C,f=1/(1+P*i),g=1/(1+P*r),y=1/(1+P*n),_=f*f,b=g*g,x=y*y,T=_*f,v=b*g,w=x*y,p=a*_+o*b+l*x-1,m=a*T*i+o*v*r+l*w*n;C=p/(-2*m)}while(Math.abs(p)>1e-12);return e.set(t.x*f,t.y*g,t.z*y)}calculateHorizonDistance(t,e){const s=this.calculateEffectiveRadius(t);return Math.sqrt(2*s*e+e**2)}calculateEffectiveRadius(t){const e=this.radius.x,s=1-this.radius.z**2/e**2,i=t*n.DEG2RAD,r=Math.sin(i)**2;return e/Math.sqrt(1-s*r)}getPositionElevation(t){this.getPositionToSurfacePoint(t,Ft);const e=kt.subVectors(t,Ft);return Math.sign(e.dot(t))*e.length()}copy(t){return this.radius.copy(t.radius),this}clone(){return(new this.constructor).copy(this)}}const Zt=new qt(X,X,6356752.314245179);Zt.name="WGS84 Earth";const $t=new i,Qt=new i,Yt=new i,Jt=new i,Xt=new g,Kt=new i,te=new e,ee=new e,se=new i,ie=new e,re=new g,ne={};class ae extends Rt{constructor(s=t){super(),this.manager=s,this.adjustmentTransform=new e,this.ellipsoid=Zt.clone()}resolveExternalURL(t){return this.manager.resolveURL(super.resolveExternalURL(t))}parse(t){return super.parse(t).then((t=>{const{featureTable:e,batchTable:r}=t,n=t.glbBytes.slice().buffer;return new Promise(((a,o)=>{const l=this.fetchOptions,c=this.manager,h=c.getHandler("path.gltf")||new s(c);"include"===l.credentials&&"cors"===l.mode&&h.setCrossOrigin("use-credentials"),"credentials"in l&&h.setWithCredentials("include"===l.credentials),l.headers&&h.setRequestHeader(l.headers);let d=t.gltfWorkingPath??this.workingPath;/[\\/]$/.test(d)||(d+="/");const u=this.adjustmentTransform;h.parse(n,d,(t=>{const s=e.getData("INSTANCES_LENGTH"),n=e.getData("POSITION",s,"FLOAT","VEC3"),o=e.getData("NORMAL_UP",s,"FLOAT","VEC3"),l=e.getData("NORMAL_RIGHT",s,"FLOAT","VEC3"),c=e.getData("SCALE_NON_UNIFORM",s,"FLOAT","VEC3"),h=e.getData("SCALE",s,"FLOAT","SCALAR"),d=e.getData("RTC_CENTER"),p=e.getData("EAST_NORTH_UP");["QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach((t=>{t in e.header&&console.warn(`I3DMLoader: Unsupported FeatureTable feature "${t}" detected.`)}));const m=new i;for(let e=0;e<s;e++)m.x+=n[3*e+0]/s,m.y+=n[3*e+1]/s,m.z+=n[3*e+2]/s;const g=[],y=[];t.scene.updateMatrixWorld(),t.scene.traverse((t=>{if(t.isMesh){y.push(t);const{geometry:e,material:i}=t,r=new f(e,i,s);r.position.copy(m),d&&(r.position.x+=d[0],r.position.y+=d[1],r.position.z+=d[2]),g.push(r)}}));for(let e=0;e<s;e++){Jt.set(n[3*e+0]-m.x,n[3*e+1]-m.y,n[3*e+2]-m.z),Xt.identity(),o&&(Qt.set(o[3*e+0],o[3*e+1],o[3*e+2]),Yt.set(l[3*e+0],l[3*e+1],l[3*e+2]),$t.crossVectors(Yt,Qt).normalize(),te.makeBasis(Yt,Qt,$t),Xt.setFromRotationMatrix(te)),Kt.set(1,1,1),c&&Kt.set(c[3*e+0],c[3*e+1],c[3*e+2]),h&&Kt.multiplyScalar(h[e]);for(let t=0,s=g.length;t<s;t++){const s=g[t];re.copy(Xt),p&&(s.updateMatrixWorld(),se.copy(Jt).applyMatrix4(s.matrixWorld),this.ellipsoid.getPositionToCartographic(se,ne),this.ellipsoid.getEastNorthUpFrame(ne.lat,ne.lon,ie),re.setFromRotationMatrix(ie)),te.compose(Jt,re,Kt).multiply(u);const i=y[t];ee.multiplyMatrices(te,i.matrixWorld),s.setMatrixAt(e,ee)}}t.scene.clear(),t.scene.add(...g),t.batchTable=r,t.featureTable=e,t.scene.batchTable=r,t.scene.featureTable=e,a(t)}),o)}))}))}}class oe extends vt{parse(t){const e=new DataView(t),s=wt(e);console.assert("cmpt"===s,'CMPTLoader: The magic bytes equal "cmpt".');const i=e.getUint32(4,!0);console.assert(1===i,'CMPTLoader: The version listed in the header is "1".');const r=e.getUint32(8,!0);console.assert(r===t.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const n=e.getUint32(12,!0),a=[];let o=16;for(let l=0;l<n;l++){const e=new DataView(t,o,12),s=wt(e),i=e.getUint32(4,!0),r=e.getUint32(8,!0),n=new Uint8Array(t,o,r);a.push({type:s,buffer:n,version:i}),o+=r}return{version:i,tiles:a}}}class le extends oe{constructor(s=t){super(),this.manager=s,this.adjustmentTransform=new e,this.ellipsoid=Zt.clone()}parse(t){const e=super.parse(t),{manager:s,ellipsoid:i,adjustmentTransform:r}=this,n=[];for(const a in e.tiles){const{type:t,buffer:o}=e.tiles[a];switch(t){case"b3dm":{const t=o.slice(),e=new Ct(s);e.workingPath=this.workingPath,e.fetchOptions=this.fetchOptions,e.adjustmentTransform.copy(r);const i=e.parse(t.buffer);n.push(i);break}case"pnts":{const t=o.slice(),e=new Ut(s);e.workingPath=this.workingPath,e.fetchOptions=this.fetchOptions;const i=e.parse(t.buffer);n.push(i);break}case"i3dm":{const t=o.slice(),e=new ae(s);e.workingPath=this.workingPath,e.fetchOptions=this.fetchOptions,e.ellipsoid.copy(i),e.adjustmentTransform.copy(r);const a=e.parse(t.buffer);n.push(a);break}}}return Promise.all(n).then((t=>{const e=new y;return t.forEach((t=>{e.add(t.scene)})),{tiles:t,scene:e}}))}}const ce=new e;class he extends y{constructor(t){super(),this.isTilesGroup=!0,this.name="TilesRenderer.TilesGroup",this.tilesRenderer=t,this.matrixWorldInverse=new e}raycast(t,e){return!this.tilesRenderer.optimizeRaycast||(this.tilesRenderer.raycast(t,e),!1)}updateMatrixWorld(t){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||t){null===this.parent?ce.copy(this.matrix):ce.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const t=ce.elements,e=this.matrixWorld.elements;let s=!1;for(let i=0;i<16;i++){const r=t[i],n=e[i];if(Math.abs(r-n)>Number.EPSILON){s=!0;break}}if(s){this.matrixWorld.copy(ce),this.matrixWorldInverse.copy(ce).invert();const t=this.children;for(let e=0,s=t.length;e<s;e++)t[e].updateMatrixWorld()}}}}const de=new u,ue=new i,pe=[];function me(t,e){return t.distance-e.distance}function fe(t,e,s,i){const{scene:r}=t.cached;s.invokeOnePlugin((s=>s.raycastTile&&s.raycastTile(t,r,e,i)))||e.intersectObject(r,!0,i)}function ge(t){return"__used"in t}function ye(t,e,s,i=null){const{group:r,activeTiles:n}=t;null===i&&(i=de).copy(s.ray).applyMatrix4(r.matrixWorldInverse);const a=[],o=e.children;for(let h=0,d=o.length;h<d;h++){const t=o[h];if(!ge(t)||!t.__used)continue;null!==t.cached.boundingVolume.intersectRay(i,ue)&&(ue.applyMatrix4(r.matrixWorld),a.push({distance:ue.distanceToSquared(s.ray.origin),tile:t}))}a.sort(me);let l=null,c=1/0;if(n.has(e)){const i=function(t,e,s){fe(t,e,s,pe),pe.sort(me);const i=pe[0]||null;return pe.length=0,i}(e,s,t);i&&(l=i,c=i.distance*i.distance)}for(let h=0,d=a.length;h<d;h++){const e=a[h],r=e.distance,n=e.tile;if(r>c)break;const o=ye(t,n,s,i);if(o){const t=o.distance*o.distance;t<c&&(l=o,c=t)}}return l}function _e(t,e,s,i,r=null){if(!ge(e))return;const{group:n,activeTiles:a}=t,{boundingVolume:o}=e.cached;if(null===r&&(r=de).copy(s.ray).applyMatrix4(n.matrixWorldInverse),!e.__used||!o.intersectsRay(r))return;a.has(e)&&fe(e,s,t,i);const l=e.children;for(let c=0,h=l.length;c<h;c++)_e(t,l[c],s,i,r)}const be=new i,xe=new i,Te=new i,ve=new u;class we{constructor(t=new _,s=new e){this.box=t.clone(),this.transform=s.clone(),this.inverseTransform=new e,this.points=new Array(8).fill().map((()=>new i)),this.planes=new Array(6).fill().map((()=>new b))}copy(t){return this.box.copy(t.box),this.transform.copy(t.transform),this.update(),this}clone(){return(new this.constructor).copy(this)}clampPoint(t,e){return e.copy(t).applyMatrix4(this.inverseTransform).clamp(this.box.min,this.box.max).applyMatrix4(this.transform)}distanceToPoint(t){return this.clampPoint(t,Te).distanceTo(t)}containsPoint(t){return Te.copy(t).applyMatrix4(this.inverseTransform),this.box.containsPoint(Te)}intersectsRay(t){return ve.copy(t).applyMatrix4(this.inverseTransform),ve.intersectsBox(this.box)}intersectRay(t,e){return ve.copy(t).applyMatrix4(this.inverseTransform),ve.intersectBox(this.box,e)?(e.applyMatrix4(this.transform),e):null}update(){const{points:t,inverseTransform:e,transform:s,box:i}=this;e.copy(s).invert();const{min:r,max:n}=i;let a=0;for(let o=-1;o<=1;o+=2)for(let e=-1;e<=1;e+=2)for(let i=-1;i<=1;i+=2)t[a].set(o<0?r.x:n.x,e<0?r.y:n.y,i<0?r.z:n.z).applyMatrix4(s),a++;this.updatePlanes()}updatePlanes(){be.copy(this.box.min).applyMatrix4(this.transform),xe.copy(this.box.max).applyMatrix4(this.transform),Te.set(0,0,1).transformDirection(this.transform),this.planes[0].setFromNormalAndCoplanarPoint(Te,be),this.planes[1].setFromNormalAndCoplanarPoint(Te,xe).negate(),Te.set(0,1,0).transformDirection(this.transform),this.planes[2].setFromNormalAndCoplanarPoint(Te,be),this.planes[3].setFromNormalAndCoplanarPoint(Te,xe).negate(),Te.set(1,0,0).transformDirection(this.transform),this.planes[4].setFromNormalAndCoplanarPoint(Te,be),this.planes[5].setFromNormalAndCoplanarPoint(Te,xe).negate()}intersectsSphere(t){return this.clampPoint(t.center,Te),Te.distanceToSquared(t.center)<=t.radius*t.radius}intersectsFrustum(t){return this._intersectsPlaneShape(t.planes,t.points)}intersectsOBB(t){return this._intersectsPlaneShape(t.planes,t.points)}_intersectsPlaneShape(t,e){const s=this.points,i=this.planes;for(let r=0;r<6;r++){const e=t[r];let i=-1/0;for(let t=0;t<8;t++){const r=s[t],n=e.distanceToPoint(r);i=i<n?n:i}if(i<0)return!1}for(let r=0;r<6;r++){const t=i[r];let s=-1/0;for(let i=0;i<8;i++){const r=e[i],n=t.distanceToPoint(r);s=s<n?n:s}if(s<0)return!1}return!0}}const Pe=Math.PI,Ce=Pe/2,Me=new i,Se=new i,Ae=new i,Ee=new e;let De=0;const Ue=[];function Re(t=!1){return t?(Ue[De]||(Ue[De]=new i),De++,Ue[De-1]):new i}function Ie(){De=0}class Le extends qt{constructor(t,e,s,i=-Ce,r=Ce,n=0,a=2*Pe,o=0,l=0){super(t,e,s),this.latStart=i,this.latEnd=r,this.lonStart=n,this.lonEnd=a,this.heightStart=o,this.heightEnd=l}_getPoints(t=!1){const{latStart:e,latEnd:s,lonStart:i,lonEnd:r,heightStart:a,heightEnd:o}=this,l=n.mapLinear(.5,0,1,e,s),c=n.mapLinear(.5,0,1,i,r),h=Math.floor(i/Ce)*Ce,d=[[-Pe/2,0],[Pe/2,0],[0,h],[0,h+Pe/2],[0,h+Pe],[0,h+3*Pe/2],[e,r],[s,r],[e,i],[s,i],[0,i],[0,r],[l,c],[e,c],[s,c],[l,i],[l,r]],u=[],p=d.length;for(let m=0;m<=1;m++){const l=n.mapLinear(m,0,1,a,o);for(let n=0,a=p;n<a;n++){const[a,o]=d[n];if(a>=e&&a<=s&&o>=i&&o<=r){const e=Re(t);u.push(e),this.getCartographicToPosition(a,o,l,e)}}}return u}getBoundingBox(t,e){Ie();const{latStart:s,latEnd:i,lonStart:r,lonEnd:a}=this;if(i-s<Pe/2){const t=n.mapLinear(.5,0,1,s,i),o=n.mapLinear(.5,0,1,r,a);this.getCartographicToNormal(t,o,Ae),Se.set(0,0,1),Me.crossVectors(Se,Ae),Se.crossVectors(Me,Ae),e.makeBasis(Me,Se,Ae)}else Me.set(1,0,0),Se.set(0,1,0),Ae.set(0,0,1),e.makeBasis(Me,Se,Ae);Ee.copy(e).invert();const o=this._getPoints(!0);for(let n=0,l=o.length;n<l;n++)o[n].applyMatrix4(Ee);t.makeEmpty(),t.setFromPoints(o)}getBoundingSphere(t,e){Ie();const s=this._getPoints(!0);t.makeEmpty(),t.setFromPoints(s,e)}}const Fe=new i,ke=new i,Oe=new i,ze=new i,Ve=new i;class Ne{constructor(){this.sphere=null,this.obb=null,this.region=null,this.regionObb=null}intersectsRay(t){const e=this.sphere,s=this.obb||this.regionObb;return!(e&&!t.intersectsSphere(e))&&!(s&&!s.intersectsRay(t))}intersectRay(t,e=null){const s=this.sphere,i=this.obb||this.regionObb;let r=-1/0,n=-1/0;s&&t.intersectSphere(s,ze)&&(r=s.containsPoint(t.origin)?0:t.origin.distanceToSquared(ze)),i&&i.intersectRay(t,Ve)&&(n=i.containsPoint(t.origin)?0:t.origin.distanceToSquared(Ve));const a=Math.max(r,n);return a===-1/0?null:(t.at(Math.sqrt(a),e),e)}distanceToPoint(t){const e=this.sphere,s=this.obb||this.regionObb;let i=-1/0,r=-1/0;return e&&(i=Math.max(e.distanceToPoint(t),0)),s&&(r=s.distanceToPoint(t)),i>r?i:r}intersectsFrustum(t){const e=this.obb||this.regionObb,s=this.sphere;return!(s&&!t.intersectsSphere(s))&&(!(e&&!e.intersectsFrustum(t))&&Boolean(s||e))}intersectsSphere(t){const e=this.obb||this.regionObb,s=this.sphere;return!(s&&!s.intersectsSphere(t))&&(!(e&&!e.intersectsSphere(t))&&Boolean(s||e))}intersectsOBB(t){const e=this.obb||this.regionObb,s=this.sphere;return!(s&&!t.intersectsSphere(s))&&(!(e&&!e.intersectsOBB(t))&&Boolean(s||e))}getOBB(t,e){const s=this.obb||this.regionObb;s?(t.copy(s.box),e.copy(s.transform)):(this.getAABB(t),e.identity())}getAABB(t){if(this.sphere)this.sphere.getBoundingBox(t);else{const e=this.obb||this.regionObb;t.copy(e.box).applyMatrix4(e.transform)}}getSphere(t){if(this.sphere)t.copy(this.sphere);else if(this.region)this.region.getBoundingSphere(t);else{const e=this.obb||this.regionObb;e.box.getBoundingSphere(t),t.applyMatrix4(e.transform)}}setObbData(t,e){const s=new we;Fe.set(t[3],t[4],t[5]),ke.set(t[6],t[7],t[8]),Oe.set(t[9],t[10],t[11]);const i=Fe.length(),r=ke.length(),n=Oe.length();Fe.normalize(),ke.normalize(),Oe.normalize(),0===i&&Fe.crossVectors(ke,Oe),0===r&&ke.crossVectors(Fe,Oe),0===n&&Oe.crossVectors(Fe,ke),s.transform.set(Fe.x,ke.x,Oe.x,t[0],Fe.y,ke.y,Oe.y,t[1],Fe.z,ke.z,Oe.z,t[2],0,0,0,1).premultiply(e),s.box.min.set(-i,-r,-n),s.box.max.set(i,r,n),s.update(),this.obb=s}setSphereData(t,e,s,i,r){const n=new d;n.center.set(t,e,s),n.radius=i,n.applyMatrix4(r),this.sphere=n}setRegionData(t,e,s,i,r,n,a){const o=new Le(...t.radius,s,r,e,i,n,a),l=new we;o.getBoundingBox(l.box,l.transform),l.update(),this.region=o,this.regionObb=l}}const Be=new T;class We extends x{constructor(){super(),this.points=Array(8).fill().map((()=>new i))}setFromProjectionMatrix(t,e){return super.setFromProjectionMatrix(t,e),this.calculateFrustumPoints(),this}calculateFrustumPoints(){const{planes:t,points:e}=this;[[t[0],t[3],t[4]],[t[1],t[3],t[4]],[t[0],t[2],t[4]],[t[1],t[2],t[4]],[t[0],t[3],t[5]],[t[1],t[3],t[5]],[t[0],t[2],t[5]],[t[1],t[2],t[5]]].forEach(((t,s)=>{!function(t,e,s,i){const r=Be.set(t.normal.x,t.normal.y,t.normal.z,e.normal.x,e.normal.y,e.normal.z,s.normal.x,s.normal.y,s.normal.z);i.set(-t.constant,-e.constant,-s.constant),i.applyMatrix3(r.invert())}(t[0],t[1],t[2],e[s])}))}}const je=new e,Ge=new p,He=Symbol("INITIAL_FRUSTUM_CULLED"),qe=new e,Ze=new i,$e=new r,Qe={inView:!1,error:1/0},Ye=new i(1,0,0),Je=new i(0,1,0);function Xe(t,e){t.traverse((t=>{t.frustumCulled=t[He]&&e}))}class Ke extends ft{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(t){this._autoDisableRendererCulling!==t&&(super._autoDisableRendererCulling=t,this.forEachLoadedModel((e=>{Xe(e,!t)})))}get optimizeRaycast(){return this._optimizeRaycast}set optimizeRaycast(t){console.warn('TilesRenderer: The "optimizeRaycast" option has been deprecated.'),this._optimizeRaycast=t}constructor(...t){super(...t),this.group=new he(this),this.ellipsoid=Zt.clone(),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this._optimizeRaycast=!0,this._upRotationMatrix=new e,this.lruCache.computeMemoryUsageCallback=t=>t.cached.bytesUsed??null,this._autoDisableRendererCulling=!0;const s=new P;s.setURLModifier((t=>this.preprocessURL?this.preprocessURL(t):t)),this.manager=s,this._listeners={}}addEventListener(...t){C.prototype.addEventListener.call(this,...t)}hasEventListener(...t){C.prototype.hasEventListener.call(this,...t)}removeEventListener(...t){C.prototype.removeEventListener.call(this,...t)}dispatchEvent(...t){C.prototype.dispatchEvent.call(this,...t)}getBoundingBox(t){if(!this.root)return!1;const e=this.root.cached.boundingVolume;return!!e&&(e.getAABB(t),!0)}getOrientedBoundingBox(t,e){if(!this.root)return!1;const s=this.root.cached.boundingVolume;return!!s&&(s.getOBB(t,e),!0)}getBoundingSphere(t){if(!this.root)return!1;const e=this.root.cached.boundingVolume;return!!e&&(e.getSphere(t),!0)}forEachLoadedModel(t){this.traverse((e=>{const s=e.cached&&e.cached.scene;s&&t(s,e)}),null,!1)}raycast(t,e){if(this.root)if(t.firstHitOnly){const s=ye(this,this.root,t);s&&e.push(s)}else _e(this,this.root,t,e)}hasCamera(t){return this.cameraMap.has(t)}setCamera(t){const e=this.cameras,s=this.cameraMap;return!s.has(t)&&(s.set(t,new r),e.push(t),this.dispatchEvent({type:"add-camera",camera:t}),!0)}setResolution(t,e,s){const i=this.cameraMap;if(!i.has(t))return!1;const r=e.isVector2?e.x:e,n=e.isVector2?e.y:s,a=i.get(t);return a.width===r&&a.height===n||(a.set(r,n),this.dispatchEvent({type:"camera-resolution-change"})),!0}setResolutionFromRenderer(t,e){return e.getSize($e).multiplyScalar(e.getPixelRatio()),this.setResolution(t,$e.x,$e.y)}deleteCamera(t){const e=this.cameras,s=this.cameraMap;if(s.has(t)){const i=e.indexOf(t);return e.splice(i,1),s.delete(t),this.dispatchEvent({type:"delete-camera",camera:t}),!0}return!1}loadRootTileSet(...t){return super.loadRootTileSet(...t).then((t=>{const{asset:e,extensions:s={}}=t;switch((e&&e.gltfUpAxis||"y").toLowerCase()){case"x":this._upRotationMatrix.makeRotationAxis(Je,-Math.PI/2);break;case"y":this._upRotationMatrix.makeRotationAxis(Ye,Math.PI/2)}if("3DTILES_ellipsoid"in s){const t=s["3DTILES_ellipsoid"],{ellipsoid:e}=this;e.name=t.body,t.radii?e.radius.set(...t.radii):e.radius.set(1,1,1)}return t}))}update(){let t=null;if(this.invokeAllPlugins((e=>{if(e.doTilesNeedUpdate){const s=e.doTilesNeedUpdate();t=null===t?s:Boolean(t||s)}})),!1===t)return this.dispatchEvent({type:"update-before"}),void this.dispatchEvent({type:"update-after"});this.dispatchEvent({type:"update-before"});const e=this.group,s=this.cameras,r=this.cameraMap,n=this.cameraInfo;if(0===s.length){let t=!1;if(this.invokeAllPlugins((e=>t=t||Boolean(e!==this&&e.calculateTileViewError))),!1===t)return void console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.")}for(;n.length>s.length;)n.pop();for(;n.length<s.length;)n.push({frustum:new We,isOrthographic:!1,sseDenominator:-1,position:new i,invScale:-1,pixelSize:0});Ze.setFromMatrixScale(e.matrixWorldInverse),Math.abs(Math.max(Ze.x-Ze.y,Ze.x-Ze.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let i=0,a=n.length;i<a;i++){const t=s[i],a=n[i],o=a.frustum,l=a.position,c=r.get(t);0!==c.width&&0!==c.height||console.warn("TilesRenderer: resolution for camera error calculation is not set.");const h=t.projectionMatrix.elements;if(a.isOrthographic=1===h[15],a.isOrthographic){const t=2/h[0],e=2/h[5];a.pixelSize=Math.max(e/c.height,t/c.width)}else a.sseDenominator=2/h[5]/c.height;qe.copy(e.matrixWorld),qe.premultiply(t.matrixWorldInverse),qe.premultiply(t.projectionMatrix),o.setFromProjectionMatrix(qe),l.set(0,0,0),l.applyMatrix4(t.matrixWorld),l.applyMatrix4(e.matrixWorldInverse)}super.update(),this.dispatchEvent({type:"update-after"})}preprocessNode(t,s,i=null){super.preprocessNode(t,s,i);const r=new e;if(t.transform){const e=t.transform;for(let t=0;t<16;t++)r.elements[t]=e[t]}i&&r.premultiply(i.cached.transform);const n=(new e).copy(r).invert(),a=new Ne;"sphere"in t.boundingVolume&&a.setSphereData(...t.boundingVolume.sphere,r),"box"in t.boundingVolume&&a.setObbData(t.boundingVolume.box,r),"region"in t.boundingVolume&&a.setRegionData(this.ellipsoid,...t.boundingVolume.region),t.cached={transform:r,transformInverse:n,active:!1,boundingVolume:a,metadata:null,scene:null,geometry:null,materials:null,textures:null}}async parseTile(t,e,i,r,n){const a=e.cached,o=r.split(/[\\/]/g);o.pop();const l=o.join("/"),c=this.fetchOptions,h=this.manager;let d=null;const u=a.transform,p=this._upRotationMatrix,m=(wt(t)||i).toLowerCase();switch(m){case"b3dm":{const e=new Ct(h);e.workingPath=l,e.fetchOptions=c,e.adjustmentTransform.copy(p),d=e.parse(t);break}case"pnts":{const e=new Ut(h);e.workingPath=l,e.fetchOptions=c,d=e.parse(t);break}case"i3dm":{const e=new ae(h);e.workingPath=l,e.fetchOptions=c,e.adjustmentTransform.copy(p),e.ellipsoid.copy(this.ellipsoid),d=e.parse(t);break}case"cmpt":{const e=new le(h);e.workingPath=l,e.fetchOptions=c,e.adjustmentTransform.copy(p),e.ellipsoid.copy(this.ellipsoid),d=e.parse(t).then((t=>t.scene));break}case"gltf":case"glb":{const e=h.getHandler("path.gltf")||h.getHandler("path.glb")||new s(h);e.setWithCredentials("include"===c.credentials),e.setRequestHeader(c.headers||{}),"include"===c.credentials&&"cors"===c.mode&&e.setCrossOrigin("use-credentials");let i=e.resourcePath||e.path||l;!/[\\/]$/.test(i)&&i.length&&(i+="/"),d=e.parseAsync(t,i).then((t=>{t.scene=t.scene||new y;const{scene:e}=t;return e.updateMatrix(),e.matrix.multiply(p).decompose(e.position,e.quaternion,e.scale),t}));break}default:d=this.invokeOnePlugin((s=>s.parseToMesh&&s.parseToMesh(t,e,i,r,n)))}const f=await d;if(null===f)throw new Error(`TilesRenderer: Content type "${m}" not supported.`);let g,_;f.isObject3D?(g=f,_=null):(g=f.scene,_=f),await this.invokeAllPlugins((t=>t.processTileModel&&t.processTileModel(g,e))),g.updateMatrix(),g.matrix.premultiply(u),g.matrix.decompose(g.position,g.quaternion,g.scale),g.traverse((t=>{t[He]=t.frustumCulled})),Xe(g,!this.autoDisableRendererCulling);const b=[],x=[],T=[];if(g.traverse((t=>{if(t.geometry&&x.push(t.geometry),t.material){const e=t.material;b.push(t.material);for(const t in e){const s=e[t];s&&s.isTexture&&T.push(s)}}})),n.aborted)for(let s=0,y=T.length;s<y;s++){const t=T[s];t.image instanceof ImageBitmap&&t.image.close(),t.dispose()}else a.materials=b,a.geometry=x,a.textures=T,a.scene=g,a.metadata=_,a.bytesUsed=function(t){const{TextureUtils:e}=w;if(!e)return 0;const s=new Set;let i=0;return t.traverse((t=>{if(t.geometry&&!s.has(t.geometry)&&(i+=v(t.geometry),s.add(t.geometry)),t.material){const r=t.material;for(const t in r){const n=r[t];if(n&&n.isTexture&&!s.has(n)){const{format:t,type:r,image:a}=n,{width:o,height:l}=a,c=e.getByteLength(o,l,t,r);i+=n.generateMipmaps?4*c/3:c,s.add(n)}}}})),i}(g)}disposeTile(t){super.disposeTile(t);const e=t.cached;if(e.scene){const s=e.materials,i=e.geometry,r=e.textures,n=e.scene.parent;e.scene.traverse((t=>{t.userData.meshFeatures&&t.userData.meshFeatures.dispose(),t.userData.structuralMetadata&&t.userData.structuralMetadata.dispose()}));for(let t=0,e=i.length;t<e;t++)i[t].dispose();for(let t=0,e=s.length;t<e;t++)s[t].dispose();for(let t=0,e=r.length;t<e;t++){const e=r[t];e.image instanceof ImageBitmap&&e.image.close(),e.dispose()}n&&n.remove(e.scene),this.dispatchEvent({type:"dispose-model",scene:e.scene,tile:t}),e.scene=null,e.materials=null,e.textures=null,e.geometry=null,e.metadata=null}}setTileVisible(t,e){const s=t.cached.scene,i=this.group;e?s&&(i.add(s),s.updateMatrixWorld(!0)):s&&i.remove(s),super.setTileVisible(t,e),this.dispatchEvent({type:"tile-visibility-change",scene:s,tile:t,visible:e})}calculateTileViewError(t,e){const s=t.cached,i=this.cameras,r=this.cameraInfo,n=s.boundingVolume;let a=!1,o=-1/0,l=1/0,c=-1/0,h=1/0;for(let d=0,u=i.length;d<u;d++){const e=r[d];let s,i;if(e.isOrthographic){const r=e.pixelSize;s=t.geometricError/r,i=1/0}else{const r=e.sseDenominator;i=n.distanceToPoint(e.position),s=t.geometricError/(i*r)}const u=r[d].frustum;n.intersectsFrustum(u)&&(a=!0,o=Math.max(o,s),l=Math.min(l,i)),c=Math.max(c,s),h=Math.min(h,i)}this.invokeAllPlugins((e=>{e!==this&&e.calculateTileViewError&&(e.calculateTileViewError(t,Qe),Qe.inView&&(a=!0,o=Math.max(o,Qe.error)),c=Math.max(c,Qe.error))})),a?(e.inView=!0,e.error=o,e.distanceToCamera=l):(e.inView=!1,e.error=c,e.distanceToCamera=h)}setLatLonToYUp(t,e){console.warn("TilesRenderer: setLatLonToYUp is deprecated. Use the ReorientationPlugin, instead.");const{ellipsoid:s,group:i}=this;Ge.set(Math.PI/2,Math.PI/2,0),je.makeRotationFromEuler(Ge),s.getEastNorthUpFrame(t,e,i.matrix).multiply(je).invert().decompose(i.position,i.quaternion,i.scale),i.updateMatrixWorld(!0)}dispose(){super.dispose(),this.group.removeFromParent()}}class ts extends M{constructor(){super(new S(0,0),new es),this.renderOrder=1/0}onBeforeRender(t){const e=this.material.uniforms;t.getSize(e.resolution.value)}updateMatrixWorld(){this.matrixWorld.makeTranslation(this.position)}dispose(){this.geometry.dispose(),this.material.dispose()}}class es extends A{constructor(){super({depthWrite:!1,depthTest:!1,transparent:!0,uniforms:{resolution:{value:new r},size:{value:15},thickness:{value:2},opacity:{value:1}},vertexShader:"\n\n\t\t\t\tuniform float pixelRatio;\n\t\t\t\tuniform float size;\n\t\t\t\tuniform float thickness;\n\t\t\t\tuniform vec2 resolution;\n\t\t\t\tvarying vec2 vUv;\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvUv = uv;\n\n\t\t\t\t\tfloat aspect = resolution.x / resolution.y;\n\t\t\t\t\tvec2 offset = uv * 2.0 - vec2( 1.0 );\n\t\t\t\t\toffset.y *= aspect;\n\n\t\t\t\t\tvec4 screenPoint = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t\tscreenPoint.xy += offset * ( size + thickness ) * screenPoint.w / resolution.x;\n\n\t\t\t\t\tgl_Position = screenPoint;\n\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\n\t\t\t\tuniform float size;\n\t\t\t\tuniform float thickness;\n\t\t\t\tuniform float opacity;\n\n\t\t\t\tvarying vec2 vUv;\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tfloat ht = 0.5 * thickness;\n\t\t\t\t\tfloat planeDim = size + thickness;\n\t\t\t\t\tfloat offset = ( planeDim - ht - 2.0 ) / planeDim;\n\t\t\t\t\tfloat texelThickness = ht / planeDim;\n\n\t\t\t\t\tvec2 vec = vUv * 2.0 - vec2( 1.0 );\n\t\t\t\t\tfloat dist = abs( length( vec ) - offset );\n\t\t\t\t\tfloat fw = fwidth( dist ) * 0.5;\n\t\t\t\t\tfloat a = smoothstep( texelThickness - fw, texelThickness + fw, dist );\n\n\t\t\t\t\tgl_FragColor = vec4( 1, 1, 1, opacity * ( 1.0 - a ) );\n\n\t\t\t\t}\n\t\t\t"})}}const ss=new r,is=new r;class rs{constructor(){this.domElement=null,this.buttons=0,this.pointerType=null,this.pointerOrder=[],this.previousPositions={},this.pointerPositions={},this.startPositions={},this.pointerSetThisFrame={},this.hoverPosition=new r,this.hoverSet=!1}reset(){this.buttons=0,this.pointerType=null,this.pointerOrder=[],this.previousPositions={},this.pointerPositions={},this.startPositions={},this.pointerSetThisFrame={},this.hoverPosition=new r,this.hoverSet=!1}updateFrame(){const{previousPositions:t,pointerPositions:e}=this;for(const s in e)t[s].copy(e[s])}setHoverEvent(t){"mouse"!==t.pointerType&&"wheel"!==t.type||(this.getAdjustedPointer(t,this.hoverPosition),this.hoverSet=!0)}getLatestPoint(t){return null!==this.pointerType?(this.getCenterPoint(t),t):this.hoverSet?(t.copy(this.hoverPosition),t):null}getAdjustedPointer(t,e){const s=(this.domElement?this.domElement:t.target).getBoundingClientRect(),i=t.clientX-s.left,r=t.clientY-s.top;e.set(i,r)}addPointer(t){const e=t.pointerId,s=new r;this.getAdjustedPointer(t,s),this.pointerOrder.push(e),this.pointerPositions[e]=s,this.previousPositions[e]=s.clone(),this.startPositions[e]=s.clone(),1===this.getPointerCount()&&(this.pointerType=t.pointerType,this.buttons=t.buttons)}updatePointer(t){const e=t.pointerId;return e in this.pointerPositions&&(this.getAdjustedPointer(t,this.pointerPositions[e]),!0)}deletePointer(t){const e=t.pointerId,s=this.pointerOrder;s.splice(s.indexOf(e),1),delete this.pointerPositions[e],delete this.previousPositions[e],delete this.startPositions[e],0===this.getPointerCount.length&&(this.buttons=0,this.pointerType=null)}getPointerCount(){return this.pointerOrder.length}getCenterPoint(t,e=this.pointerPositions){const s=this.pointerOrder;if(1===this.getPointerCount()||"mouse"===this.getPointerType()){const i=s[0];return t.copy(e[i]),t}if(2===this.getPointerCount()){const s=this.pointerOrder[0],i=this.pointerOrder[1],r=e[s],n=e[i];return t.addVectors(r,n).multiplyScalar(.5),t}return null}getPreviousCenterPoint(t){return this.getCenterPoint(t,this.previousPositions)}getStartCenterPoint(t){return this.getCenterPoint(t,this.startPositions)}getMoveDistance(){return this.getCenterPoint(ss),this.getPreviousCenterPoint(is),ss.sub(is).length()}getTouchPointerDistance(t=this.pointerPositions){if(this.getPointerCount()<=1||"mouse"===this.getPointerType())return 0;const{pointerOrder:e}=this,s=e[0],i=e[1],r=t[s],n=t[i];return r.distanceTo(n)}getPreviousTouchPointerDistance(){return this.getTouchPointerDistance(this.previousPositions)}getStartTouchPointerDistance(){return this.getTouchPointerDistance(this.startPositions)}getPointerType(){return this.pointerType}isPointerTouch(){return"touch"===this.getPointerType()}getPointerButtons(){return this.buttons}isLeftClicked(){return Boolean(1&this.buttons)}isRightClicked(){return Boolean(2&this.buttons)}}const ns=new e,as=new u,os=new i;function ls(t,e,s){return s.makeTranslation(-t.x,-t.y,-t.z),ns.makeRotationFromQuaternion(e),s.premultiply(ns),ns.makeTranslation(t.x,t.y,t.z),s.premultiply(ns),s}function cs(t,e,s,i){i.x=(t-s.offsetLeft)/s.clientWidth*2-1,i.y=-(e-s.offsetTop)/s.clientHeight*2+1,i.isVector3&&(i.z=0)}function hs(t,e,s){return e.intersectRay(t,s)?s:(ns.makeScale(...e.radius).invert(),as.copy(t).applyMatrix4(ns),os.set(0,0,0),as.closestPointToPoint(os,s).normalize(),ns.makeScale(...e.radius),s.applyMatrix4(ns))}function ds(t,e,s){const i=t instanceof u?t:t.ray,{origin:r,direction:n}=i;r.set(e.x,e.y,-1).unproject(s),n.set(e.x,e.y,1).unproject(s).sub(r),t.isRay||(t.near=0,t.far=n.length(),t.camera=s),n.normalize()}const us=.05,ps=.025,ms=new e,fs=new i,gs=new i,ys=new i,_s=new i,bs=new i,xs=new g,Ts=new b,vs=new i,ws=new i,Ps=new i,Cs=new g,Ms=new u,Ss=new r,As=new r,Es=new r,Ds=new r,Us=new r,Rs=new r,Is={type:"change"},Ls={type:"start"},Fs={type:"end"};class ks extends C{get enabled(){return this._enabled}set enabled(t){t!==this.enabled&&(this._enabled=t,this.resetState(),this.pointerTracker.reset(),this.enabled||(this.dragInertia.set(0,0,0),this.rotationInertia.set(0,0)))}constructor(t=null,e=null,s=null,n=null){super(),this.isEnvironmentControls=!0,this.domElement=null,this.camera=null,this.scene=null,this.tilesRenderer=null,this._enabled=!0,this.cameraRadius=5,this.rotationSpeed=1,this.minAltitude=0,this.maxAltitude=.45*Math.PI,this.minDistance=10,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.zoomSpeed=1,this.adjustHeight=!0,this.enableDamping=!1,this.dampingFactor=.15,this.reorientOnDrag=!0,this.scaleZoomOrientationAtEdges=!1,this.state=0,this.pointerTracker=new rs,this.needsUpdate=!1,this.actionHeightOffset=0,this.pivotPoint=new i,this.zoomDirectionSet=!1,this.zoomPointSet=!1,this.zoomDirection=new i,this.zoomPoint=new i,this.zoomDelta=0,this.rotationInertiaPivot=new i,this.rotationInertia=new r,this.dragInertia=new i,this.inertiaTargetDistance=1/0,this.inertiaStableFrames=0,this.pivotMesh=new ts,this.pivotMesh.raycast=()=>{},this.pivotMesh.scale.setScalar(.25),this.raycaster=new E,this.raycaster.firstHitOnly=!0,this.up=new i(0,1,0),this.clock=new D,this.fallbackPlane=new b(new i(0,1,0),0),this.useFallbackPlane=!0,this._detachCallback=null,this._upInitialized=!1,this._lastUsedState=0,this._zoomPointWasSet=!1,this._tilesOnChangeCallback=()=>this.zoomPointSet=!1,s&&this.attach(s),e&&this.setCamera(e),t&&this.setScene(t),n&&this.setTilesRenderer(n)}setScene(t){this.scene=t}setCamera(t){this.camera=t,this._upInitialized=!1,this.zoomDirectionSet=!1,this.zoomPointSet=!1,this.needsUpdate=!0,this.raycaster.camera=t,this.resetState()}setTilesRenderer(t){this.tilesRenderer&&this.tilesRenderer.removeEventListener("tile-visibility-change",this._tilesOnChangeCallback),this.tilesRenderer=t,null!==this.tilesRenderer&&(this.tilesRenderer.addEventListener("tile-visibility-change",this._tilesOnChangeCallback),null===this.scene&&this.setScene(this.tilesRenderer.group))}attach(t){if(this.domElement)throw new Error("EnvironmentControls: Controls already attached to element");this.domElement=t,this.pointerTracker.domElement=t,t.style.touchAction="none";const e=t=>{t.preventDefault()},s=t=>{t.preventDefault();const{camera:e,raycaster:s,domElement:i,up:r,pivotMesh:n,pointerTracker:a,scene:o,pivotPoint:l,enabled:c}=this;if(a.addPointer(t),this.needsUpdate=!0,a.isPointerTouch())if(n.visible=!1,0===a.getPointerCount())i.setPointerCapture(t.pointerId);else if(a.getPointerCount()>2)return void this.resetState();a.getCenterPoint(As),cs(As.x,As.y,i,As),ds(s,As,e);const h=Math.abs(s.ray.direction.dot(r));if(h<us||h<ps)return;const d=this._raycast(s);d&&(2===a.getPointerCount()||a.isRightClicked()||a.isLeftClicked()&&t.shiftKey?(this.setState(a.isPointerTouch()?4:2),l.copy(d.point),n.position.copy(d.point),n.visible=!a.isPointerTouch()&&c,n.updateMatrixWorld(),o.add(n)):a.isLeftClicked()&&(this.setState(1),l.copy(d.point),n.position.copy(d.point),n.updateMatrixWorld(),o.add(n)))};let i=!1;const r=t=>{t.preventDefault();const{pivotMesh:e,enabled:s}=this;this.zoomDirectionSet=!1,this.zoomPointSet=!1,0!==this.state&&(this.needsUpdate=!0);const{pointerTracker:r}=this;r.setHoverEvent(t),r.updatePointer(t)&&(r.isPointerTouch()&&2===r.getPointerCount()&&(i||(i=!0,queueMicrotask((()=>{i=!1,r.getCenterPoint(Us);const t=r.getStartTouchPointerDistance(),n=r.getTouchPointerDistance(),a=n-t;if(0===this.state||4===this.state){r.getCenterPoint(Us),r.getStartCenterPoint(Rs);const t=2*window.devicePixelRatio,e=Us.distanceTo(Rs);(Math.abs(a)>t||e>t)&&(Math.abs(a)>e?(this.setState(3),this.zoomDirectionSet=!1):this.setState(2))}if(3===this.state){const t=r.getPreviousTouchPointerDistance();this.zoomDelta+=n-t,e.visible=!1}else 2===this.state&&(e.visible=s)})))),this.dispatchEvent(Is))},n=e=>{const{pointerTracker:s}=this;s.deletePointer(e),"touch"===s.getPointerType()&&0===s.getPointerCount()&&t.releasePointerCapture(e.pointerId),this.resetState(),this.needsUpdate=!0},a=t=>{t.preventDefault();const{pointerTracker:e}=this;let s;switch(e.setHoverEvent(t),e.updatePointer(t),this.dispatchEvent(Ls),t.deltaMode){case 2:s=800*t.deltaY;break;case 1:s=40*t.deltaY;break;case 0:s=t.deltaY}const i=Math.sign(s),r=Math.abs(s);this.zoomDelta-=.25*i*r,this.needsUpdate=!0,this._lastUsedState=3,this.dispatchEvent(Fs)},o=t=>{const{pointerTracker:e}=this;t.buttons!==e.getPointerButtons()&&(e.deletePointer(t),this.resetState())};t.addEventListener("contextmenu",e),t.addEventListener("pointerdown",s),t.addEventListener("pointermove",r),t.addEventListener("pointerup",n),t.addEventListener("wheel",a,{passive:!1}),t.addEventListener("pointerenter",o),this._detachCallback=()=>{t.removeEventListener("contextmenu",e),t.removeEventListener("pointerdown",s),t.removeEventListener("pointermove",r),t.removeEventListener("pointerup",n),t.removeEventListener("wheel",a),t.removeEventListener("pointerenter",o)}}getUpDirection(t,e){e.copy(this.up)}getCameraUpDirection(t){this.getUpDirection(this.camera.position,t)}getPivotPoint(t){let e=null;3===this._lastUsedState?this._zoomPointWasSet&&(e=t.copy(this.zoomPoint)):2!==this._lastUsedState&&1!==this._lastUsedState||(e=t.copy(this.pivotPoint));const{camera:s,raycaster:i}=this;null!==e&&(gs.copy(e).project(s),(gs.x<-1||gs.x>1||gs.y<-1||gs.y>1)&&(e=null)),ds(i,{x:0,y:0},s);const r=this._raycast(i);return r&&(null===e||r.distance<e.distanceTo(i.ray.origin))&&(e=t.copy(r.point)),e}detach(){this.domElement=null,this._detachCallback&&(this._detachCallback(),this._detachCallback=null,this.pointerTracker.reset())}resetState(){0!==this.state&&this.dispatchEvent(Fs),this.state=0,this.pivotMesh.removeFromParent(),this.pivotMesh.visible=this.enabled,this.actionHeightOffset=0}setState(t=this.state,e=!0){this.state!==t&&(0===this.state&&e&&this.dispatchEvent(Ls),this.pivotMesh.visible=this.enabled,this.dragInertia.set(0,0,0),this.rotationInertia.set(0,0),this.inertiaStableFrames=0,this.state=t,0!==t&&4!==t&&(this._lastUsedState=t))}update(t=Math.min(this.clock.getDelta(),.064)){if(!this.enabled||!this.camera||0===t)return;const{camera:e,cameraRadius:s,pivotPoint:i,up:r,state:n,adjustHeight:a}=this;e.updateMatrixWorld(),this.getCameraUpDirection(vs),this._upInitialized||(this._upInitialized=!0,this.up.copy(vs));const o=this._inertiaNeedsUpdate();if(this.needsUpdate||o){const s=this.zoomDelta;this._updateZoom(),this._updatePosition(t),this._updateRotation(t),1===n||2===n?(ys.set(0,0,-1).transformDirection(e.matrixWorld),this.inertiaTargetDistance=gs.copy(this.pivotPoint).sub(e.position).dot(ys)):0===n&&this._updateInertia(t),(0!==n||0!==s||o)&&this.dispatchEvent(Is),this.needsUpdate=!1}const l=e.isOrthographicCamera?null:a&&this._getPointBelowCamera()||null,c=e.isOrthographicCamera?i:l&&l.point||null;if(this.getCameraUpDirection(vs),this._setFrame(vs,c),(1===this.state||2===this.state)&&0!==this.actionHeightOffset){const{actionHeightOffset:t}=this;e.position.addScaledVector(r,-t),i.addScaledVector(r,-t),l&&(l.distance-=t)}if(this.actionHeightOffset=0,l){const t=l.distance;if(t<s){const n=s-t;e.position.addScaledVector(r,n),i.addScaledVector(r,n),this.actionHeightOffset=n}}this.pointerTracker.updateFrame()}adjustCamera(t){const{adjustHeight:e,cameraRadius:s}=this;if(t.isPerspectiveCamera){this.getUpDirection(t.position,vs);const i=e&&this._getPointBelowCamera(t.position,vs)||null;if(i){const e=i.distance;e<s&&t.position.addScaledVector(vs,s-e)}}}dispose(){this.detach()}_updateInertia(t){const{rotationInertia:e,pivotPoint:s,dragInertia:i,enableDamping:r,dampingFactor:n,camera:a,cameraRadius:o,minDistance:l,inertiaTargetDistance:c}=this;if(!this.enableDamping||this.inertiaStableFrames>1)return i.set(0,0,0),void e.set(0,0,0);const h=Math.pow(2,-t/n),d=Math.max(a.near,o,l,c),u=25e-5;if(e.lengthSq()>0){ds(Ms,gs.set(0,0,-1),a),Ms.applyMatrix4(a.matrixWorldInverse),Ms.direction.normalize(),Ms.recast(-Ms.direction.dot(Ms.origin)).at(d/Ms.direction.z,gs),gs.applyMatrix4(a.matrixWorld),ds(Ms,fs.set(u,u,-1),a),Ms.applyMatrix4(a.matrixWorldInverse),Ms.direction.normalize(),Ms.recast(-Ms.direction.dot(Ms.origin)).at(d/Ms.direction.z,fs),fs.applyMatrix4(a.matrixWorld),gs.sub(s).normalize(),fs.sub(s).normalize();const i=gs.angleTo(fs)/t;e.multiplyScalar(h),(e.lengthSq()<i**2||!r)&&e.set(0,0)}if(i.lengthSq()>0){ds(Ms,gs.set(0,0,-1),a),Ms.applyMatrix4(a.matrixWorldInverse),Ms.direction.normalize(),Ms.recast(-Ms.direction.dot(Ms.origin)).at(d/Ms.direction.z,gs),gs.applyMatrix4(a.matrixWorld),ds(Ms,fs.set(u,u,-1),a),Ms.applyMatrix4(a.matrixWorldInverse),Ms.direction.normalize(),Ms.recast(-Ms.direction.dot(Ms.origin)).at(d/Ms.direction.z,fs),fs.applyMatrix4(a.matrixWorld);const e=gs.distanceTo(fs)/t;i.multiplyScalar(h),(i.lengthSq()<e**2||!r)&&i.set(0,0,0)}e.lengthSq()>0&&this._applyRotation(e.x*t,e.y*t,s),i.lengthSq()>0&&(a.position.addScaledVector(i,t),a.updateMatrixWorld())}_inertiaNeedsUpdate(){const{rotationInertia:t,dragInertia:e}=this;return 0!==t.lengthSq()||0!==e.lengthSq()}_updateZoom(){const{zoomPoint:t,zoomDirection:e,camera:s,minDistance:i,maxDistance:r,pointerTracker:n,domElement:a,minZoom:o,maxZoom:l,zoomSpeed:c,state:h}=this;let d=this.zoomDelta;if(this.zoomDelta=0,n.getLatestPoint(As)&&(0!==d||3===h))if(this.rotationInertia.set(0,0),this.dragInertia.set(0,0,0),s.isOrthographicCamera){this._updateZoomDirection();const t=this.zoomPointSet||this._updateZoomPoint();ws.unproject(s);const e=Math.pow(.95,Math.abs(.05*d));let i=d>0?1/Math.abs(e):e;i*=c,i>1?l<s.zoom*i&&(i=1):o>s.zoom*i&&(i=1),s.zoom*=i,s.updateProjectionMatrix(),t&&(cs(As.x,As.y,a,Ps),Ps.unproject(s),s.position.sub(Ps).add(ws),s.updateMatrixWorld())}else{this._updateZoomDirection();const n=gs.copy(e);if(this.zoomPointSet||this._updateZoomPoint()){const n=t.distanceTo(s.position);if(d<0){const t=Math.min(0,n-r);d=d*n*c*.0025,d=Math.max(d,t)}else{const t=Math.max(0,n-i);d=d*Math.max(n-i,0)*c*.0025,d=Math.min(d,t)}s.position.addScaledVector(e,d),s.updateMatrixWorld()}else{const t=this._getPointBelowCamera();if(t){const e=t.distance;n.set(0,0,-1).transformDirection(s.matrixWorld),s.position.addScaledVector(n,d*e*.01),s.updateMatrixWorld()}}}}_updateZoomDirection(){if(this.zoomDirectionSet)return;const{domElement:t,raycaster:e,camera:s,zoomDirection:i,pointerTracker:r}=this;r.getLatestPoint(As),cs(As.x,As.y,t,ws),ds(e,ws,s),i.copy(e.ray.direction).normalize(),this.zoomDirectionSet=!0}_updateZoomPoint(){const{camera:t,zoomDirectionSet:e,zoomDirection:s,raycaster:i,zoomPoint:r,pointerTracker:n,domElement:a}=this;if(this._zoomPointWasSet=!1,!e)return!1;t.isOrthographicCamera&&n.getLatestPoint(Ss)?(cs(Ss.x,Ss.y,a,Ss),ds(i,Ss,t)):(i.ray.origin.copy(t.position),i.ray.direction.copy(s),i.near=0,i.far=1/0);const o=this._raycast(i);return!!o&&(r.copy(o.point),this.zoomPointSet=!0,this._zoomPointWasSet=!0,!0)}_getPointBelowCamera(t=this.camera.position,e=this.up){const{raycaster:s}=this;s.ray.direction.copy(e).multiplyScalar(-1),s.ray.origin.copy(t).addScaledVector(e,1e5),s.near=0,s.far=1/0;const i=this._raycast(s);return i&&(i.distance-=1e5),i}_updatePosition(t){const{raycaster:e,camera:s,pivotPoint:i,up:r,pointerTracker:n,domElement:a,state:o,dragInertia:l}=this;if(1===o){if(n.getCenterPoint(As),cs(As.x,As.y,a,As),Ts.setFromNormalAndCoplanarPoint(r,i),ds(e,As,s),Math.abs(e.ray.direction.dot(r))<us){const t=Math.acos(us);bs.crossVectors(e.ray.direction,r).normalize(),e.ray.direction.copy(r).applyAxisAngle(bs,t).multiplyScalar(-1)}if(this.getUpDirection(i,vs),Math.abs(e.ray.direction.dot(vs))<ps){const t=Math.acos(ps);bs.crossVectors(e.ray.direction,vs).normalize(),e.ray.direction.copy(vs).applyAxisAngle(bs,t).multiplyScalar(-1)}e.ray.intersectPlane(Ts,gs)&&(fs.subVectors(i,gs),s.position.add(fs),s.updateMatrixWorld(),fs.multiplyScalar(1/t),n.getMoveDistance()/t<2*window.devicePixelRatio?this.inertiaStableFrames++:(l.copy(fs),this.inertiaStableFrames=0))}}_updateRotation(t){const{pivotPoint:e,pointerTracker:s,domElement:i,state:r,rotationInertia:n}=this;2===r&&(s.getCenterPoint(As),s.getPreviousCenterPoint(Es),Ds.subVectors(As,Es).multiplyScalar(2*Math.PI/i.clientHeight),this._applyRotation(Ds.x,Ds.y,e),Ds.multiplyScalar(1/t),s.getMoveDistance()/t<2*window.devicePixelRatio?this.inertiaStableFrames++:(n.copy(Ds),this.inertiaStableFrames=0))}_applyRotation(t,e,s){if(0===t&&0===e)return;const{camera:i,minAltitude:r,maxAltitude:n,rotationSpeed:a}=this,o=-t*a;let l=e*a;ys.set(0,0,1).transformDirection(i.matrixWorld),this.getUpDirection(s,vs),gs.crossVectors(vs,ys).normalize(),_s.set(1,0,0).transformDirection(i.matrixWorld).normalize();const c=Math.sign(gs.dot(_s))*vs.angleTo(ys);l>0?(l=Math.min(c-r-.01,l),l=Math.max(0,l)):(l=Math.max(c-n,l),l=Math.min(0,l)),xs.setFromAxisAngle(vs,o),ls(s,xs,ms),i.matrixWorld.premultiply(ms),bs.set(-1,0,0).transformDirection(i.matrixWorld),xs.setFromAxisAngle(bs,l),ls(s,xs,ms),i.matrixWorld.premultiply(ms),i.matrixWorld.decompose(i.position,i.quaternion,gs)}_setFrame(t,e){const{up:s,camera:i,state:r,zoomPoint:a,zoomDirectionSet:o,zoomPointSet:l,reorientOnDrag:c,scaleZoomOrientationAtEdges:h}=this;i.updateMatrixWorld(),xs.setFromUnitVectors(s,t);const d=r;if(o&&(l||this._updateZoomPoint())){if(this.getUpDirection(a,gs),h){let t=Math.max(gs.dot(s)-.6,0)/.4;t=n.mapLinear(t,0,.5,0,1),t=Math.min(t,1),i.isOrthographicCamera&&(t*=.1),xs.slerp(Cs,1-t)}ls(a,xs,ms),i.matrixWorld.premultiply(ms),i.matrixWorld.decompose(i.position,i.quaternion,gs),this.zoomDirectionSet=!1,this._updateZoomDirection()}else 1===d&&c&&e&&(ls(e,xs,ms),i.matrixWorld.premultiply(ms),i.matrixWorld.decompose(i.position,i.quaternion,gs));s.copy(t),i.updateMatrixWorld()}_raycast(t){const{scene:e,useFallbackPlane:s,fallbackPlane:i}=this,r=t.intersectObject(e)[0]||null;if(r)return r;if(s){const e=i;if(t.ray.intersectPlane(e,gs)){return{point:gs.clone(),distance:t.ray.origin.distanceTo(gs)}}}return null}}const Os=new e,zs=new e,Vs=new i,Ns=new i,Bs=new i,Ws=new i,js=new i,Gs=new i,Hs=new i,qs=new g,Zs=new i,$s=new i,Qs=new u,Ys=new qt,Js={},Xs=new r;class Ks extends ks{get ellipsoid(){return this.tilesRenderer?this.tilesRenderer.ellipsoid:null}get tilesGroup(){return this.tilesRenderer?this.tilesRenderer.group:null}constructor(t=null,e=null,s=null,i=null){super(t,e,s),this.isGlobeControls=!0,this._dragMode=0,this._rotationMode=0,this.maxZoom=.01,this.nearMargin=.25,this.farMargin=0,this.useFallbackPlane=!1,this.reorientOnDrag=!1,this.globeInertia=new g,this.globeInertiaFactor=0,this.setTilesRenderer(i)}setScene(t){null===t&&null!==this.tilesRenderer?super.setScene(this.tilesRenderer.group):super.setScene(t)}getPivotPoint(t){const{camera:e,tilesGroup:s,ellipsoid:i}=this;return Ws.set(0,0,-1).transformDirection(e.matrixWorld),Qs.origin.copy(e.position),Qs.direction.copy(Ws),Qs.applyMatrix4(s.matrixWorldInverse),hs(Qs,i,Ns),Ns.applyMatrix4(s.matrixWorld),(null===super.getPivotPoint(t)||t.distanceTo(Qs.origin)>Ns.distanceTo(Qs.origin))&&t.copy(Ns),t}getVectorToCenter(t){const{tilesGroup:e,camera:s}=this;return t.setFromMatrixPosition(e.matrixWorld).sub(s.position)}getDistanceToCenter(){return this.getVectorToCenter(Ns).length()}getUpDirection(t,e){const{tilesGroup:s,ellipsoid:i}=this;Ns.copy(t).applyMatrix4(s.matrixWorldInverse),i.getPositionToNormal(Ns,e),e.transformDirection(s.matrixWorld)}getCameraUpDirection(t){const{tilesGroup:e,ellipsoid:s,camera:i}=this;i.isOrthographicCamera?(this._getVirtualOrthoCameraPosition(Ns),Ns.applyMatrix4(e.matrixWorldInverse),s.getPositionToNormal(Ns,t),t.transformDirection(e.matrixWorld)):this.getUpDirection(i.position,t)}update(t=Math.min(this.clock.getDelta(),.064)){if(!this.enabled||!this.tilesGroup||!this.camera||0===t)return;const{camera:e,pivotMesh:s}=this;this._isNearControls()?this.scaleZoomOrientationAtEdges=this.zoomDelta<0:(0!==this.state&&1!==this._dragMode&&1!==this._rotationMode&&(s.visible=!1),this.scaleZoomOrientationAtEdges=!1),super.update(t),this.adjustCamera(e)}adjustCamera(t){super.adjustCamera(t);const{tilesGroup:e,ellipsoid:s,nearMargin:i,farMargin:r}=this,a=Math.max(...s.radius);if(t.isPerspectiveCamera){const o=Ns.setFromMatrixPosition(e.matrixWorld).sub(t.position).length(),l=i*a,c=n.clamp((o-a)/l,0,1),h=n.lerp(1,1e3,c);t.near=Math.max(h,o-a-l),Vs.copy(t.position).applyMatrix4(e.matrixWorldInverse),s.getPositionToCartographic(Vs,Js);const d=Math.max(s.getPositionElevation(Vs),400),u=s.calculateHorizonDistance(Js.lat,d);t.far=2.5*u+.1+a*r,t.updateProjectionMatrix()}else{this._getVirtualOrthoCameraPosition(t.position,t),t.updateMatrixWorld(),Os.copy(t.matrixWorld).invert(),Ns.setFromMatrixPosition(e.matrixWorld).applyMatrix4(Os);const s=-Ns.z;t.near=s-a*(1+i),t.far=s+.1+a*r,t.position.addScaledVector(Ws,t.near),t.far-=t.near,t.near=0,t.updateProjectionMatrix(),t.updateMatrixWorld()}}resetState(){super.resetState(),this._dragMode=0,this._rotationMode=0}_updateInertia(t){super._updateInertia(t);const{globeInertia:e,enableDamping:s,dampingFactor:i,camera:r,cameraRadius:n,minDistance:a,inertiaTargetDistance:o,tilesGroup:l}=this;if(!this.enableDamping||this.inertiaStableFrames>1)return this.globeInertiaFactor=0,void this.globeInertia.identity();const c=Math.pow(2,-t/i),h=Math.max(r.near,n,a,o),d=25e-5;if(Bs.setFromMatrixPosition(l.matrixWorld),0!==this.globeInertiaFactor){ds(Qs,Ns.set(0,0,-1),r),Qs.applyMatrix4(r.matrixWorldInverse),Qs.direction.normalize(),Qs.recast(-Qs.direction.dot(Qs.origin)).at(h/Qs.direction.z,Ns),Ns.applyMatrix4(r.matrixWorld),ds(Qs,Vs.set(d,d,-1),r),Qs.applyMatrix4(r.matrixWorldInverse),Qs.direction.normalize(),Qs.recast(-Qs.direction.dot(Qs.origin)).at(h/Qs.direction.z,Vs),Vs.applyMatrix4(r.matrixWorld),Ns.sub(Bs).normalize(),Vs.sub(Bs).normalize(),this.globeInertiaFactor*=c;const i=Ns.angleTo(Vs)/t;(2*Math.acos(e.w)*this.globeInertiaFactor<i||!s)&&(this.globeInertiaFactor=0,e.identity())}0!==this.globeInertiaFactor&&(1!==e.w||0===e.x&&0===e.y&&0===e.z||(e.w=Math.min(e.w,1-1e-9)),Bs.setFromMatrixPosition(l.matrixWorld),qs.identity().slerp(e,this.globeInertiaFactor*t),ls(Bs,qs,zs),r.matrixWorld.premultiply(zs),r.matrixWorld.decompose(r.position,r.quaternion,Ns))}_inertiaNeedsUpdate(){return super._inertiaNeedsUpdate()||0!==this.globeInertiaFactor}_updatePosition(t){if(1===this.state){0===this._dragMode&&(this._dragMode=this._isNearControls()?1:-1);const{raycaster:e,camera:s,pivotPoint:i,pointerTracker:r,domElement:n,tilesGroup:a}=this,o=Vs,l=Gs;r.getCenterPoint(Xs),cs(Xs.x,Xs.y,n,Xs),ds(e,Xs,s),e.ray.applyMatrix4(a.matrixWorldInverse);const c=Ns.copy(i).applyMatrix4(a.matrixWorldInverse).length();Ys.radius.setScalar(c),s.isPerspectiveCamera?Ys.intersectRay(e.ray,Ns)||function(t,e,s){const i=t.origin.length(),r=Math.acos(e/i);s.copy(t.origin).multiplyScalar(-1).normalize();const n=os.crossVectors(s,t.direction).normalize();s.multiplyScalar(-1).applyAxisAngle(n,-r).normalize().multiplyScalar(e)}(e.ray,c,Ns):hs(e.ray,Ys,Ns),Ns.applyMatrix4(a.matrixWorld),Bs.setFromMatrixPosition(a.matrixWorld),o.subVectors(i,Bs).normalize(),l.subVectors(Ns,Bs).normalize(),qs.setFromUnitVectors(l,o),ls(Bs,qs,zs),s.matrixWorld.premultiply(zs),s.matrixWorld.decompose(s.position,s.quaternion,Ns),r.getMoveDistance()/t<2*window.devicePixelRatio?this.inertiaStableFrames++:(this.globeInertia.copy(qs),this.globeInertiaFactor=1/t,this.inertiaStableFrames=0)}this._alignCameraUp(this.up)}_updateRotation(...t){1===this._rotationMode||this._isNearControls()?(this._rotationMode=1,super._updateRotation(...t)):(this.pivotMesh.visible=!1,this._rotationMode=-1),this._alignCameraUp(this.up)}_updateZoom(){const{zoomDelta:t,ellipsoid:e,zoomSpeed:s,zoomPoint:i,camera:r,maxZoom:a,state:o}=this;if(3!==o&&0===t)return;this.rotationInertia.set(0,0),this.dragInertia.set(0,0,0),this.globeInertia.identity(),this.globeInertiaFactor=0;const l=n.clamp(n.mapLinear(Math.abs(t),0,20,0,1),0,1);if(this._isNearControls()||t>0){if(this._updateZoomDirection(),t<0&&(this.zoomPointSet||this._updateZoomPoint())){Ws.set(0,0,-1).transformDirection(r.matrixWorld).normalize(),$s.copy(this.up).multiplyScalar(-1),this.getUpDirection(i,Zs);const t=n.clamp(n.mapLinear(-Zs.dot($s),1,.95,0,1),0,1),e=1-Ws.dot($s),s=r.isOrthographicCamera?.05:1,a=n.clamp(3*l,0,1),o=Math.min(t*e*s*a,.1);$s.lerpVectors(Ws,$s,o).normalize(),qs.setFromUnitVectors(Ws,$s),ls(i,qs,zs),r.matrixWorld.premultiply(zs),r.matrixWorld.decompose(r.position,r.quaternion,$s),this.zoomDirection.subVectors(i,r.position).normalize()}super._updateZoom()}else if(r.isPerspectiveCamera){const i=this._getPerspectiveTransitionDistance(),r=this._getMaxPerspectiveDistance(),a=n.mapLinear(this.getDistanceToCenter(),i,r,0,1);this._tiltTowardsCenter(n.lerp(0,.4,a*l)),this._alignCameraUpToNorth(n.lerp(0,.2,a*l));const o=t*(this.getDistanceToCenter()-e.radius.x)*s*.0025,c=Math.max(o,Math.min(this.getDistanceToCenter()-r,0));this.getVectorToCenter(Ns).normalize(),this.camera.position.addScaledVector(Ns,c),this.camera.updateMatrixWorld(),this.zoomDelta=0}else{const t=this._getOrthographicTransitionZoom(),e=this._getMinOrthographicZoom(),i=n.mapLinear(r.zoom,t,e,0,1);this._tiltTowardsCenter(n.lerp(0,.4,i*l)),this._alignCameraUpToNorth(n.lerp(0,.2,i*l));const o=this.zoomDelta,c=Math.pow(.95,Math.abs(.05*o)),h=o>0?1/Math.abs(c):c,d=e/r.zoom,u=Math.max(h*s,Math.min(d,1));r.zoom=Math.min(a,r.zoom*u),r.updateProjectionMatrix(),this.zoomDelta=0,this.zoomDirectionSet=!1}}_alignCameraUpToNorth(t){const{tilesGroup:e}=this;Hs.set(0,0,1).transformDirection(e.matrixWorld),this._alignCameraUp(Hs,t)}_alignCameraUp(t,e=null){const{camera:s}=this;Ws.set(0,0,-1).transformDirection(s.matrixWorld),js.set(-1,0,0).transformDirection(s.matrixWorld),Gs.crossVectors(t,Ws),null===e&&(e=1-Math.abs(Ws.dot(t)),e=n.mapLinear(e,0,1,-.01,1),e=n.clamp(e,0,1)**2),Gs.lerp(js,1-e).normalize(),qs.setFromUnitVectors(js,Gs),s.quaternion.premultiply(qs),s.updateMatrixWorld()}_tiltTowardsCenter(t){const{camera:e,tilesGroup:s}=this;Ws.set(0,0,-1).transformDirection(e.matrixWorld).normalize(),Ns.setFromMatrixPosition(s.matrixWorld).sub(e.position).normalize(),Ns.lerp(Ws,1-t).normalize(),qs.setFromUnitVectors(Ws,Ns),e.quaternion.premultiply(qs),e.updateMatrixWorld()}_getPerspectiveTransitionDistance(){const{camera:t,ellipsoid:e}=this;if(!t.isPerspectiveCamera)throw new Error;const s=Math.max(...e.radius),i=2*Math.atan(Math.tan(n.DEG2RAD*t.fov*.5)*t.aspect),r=s/Math.tan(n.DEG2RAD*t.fov*.5),a=s/Math.tan(.5*i);return Math.max(r,a)}_getMaxPerspectiveDistance(){const{camera:t,ellipsoid:e}=this;if(!t.isPerspectiveCamera)throw new Error;const s=Math.max(...e.radius),i=2*Math.atan(Math.tan(n.DEG2RAD*t.fov*.5)*t.aspect),r=s/Math.tan(n.DEG2RAD*t.fov*.5),a=s/Math.tan(.5*i);return 2*Math.max(r,a)}_getOrthographicTransitionZoom(){const{camera:t,ellipsoid:e}=this;if(!t.isOrthographicCamera)throw new Error;const s=t.top-t.bottom,i=t.right-t.left;return 2*Math.max(s,i)/(2*Math.max(...e.radius))}_getMinOrthographicZoom(){const{camera:t,ellipsoid:e}=this;if(!t.isOrthographicCamera)throw new Error;const s=t.top-t.bottom,i=t.right-t.left;return.7*Math.min(s,i)/(2*Math.max(...e.radius))}_getVirtualOrthoCameraPosition(t,e=this.camera){const{tilesGroup:s,ellipsoid:i}=this;if(!e.isOrthographicCamera)throw new Error;Qs.origin.copy(e.position),Qs.direction.set(0,0,-1).transformDirection(e.matrixWorld),Qs.applyMatrix4(s.matrixWorldInverse),hs(Qs,i,Vs),Vs.applyMatrix4(s.matrixWorld);const r=e.top-e.bottom,n=e.right-e.left,a=Math.max(r,n)/e.zoom;Ws.set(0,0,-1).transformDirection(e.matrixWorld);const o=Vs.sub(e.position).dot(Ws);t.copy(e.position).addScaledVector(Ws,o-4*a)}_isNearControls(){const{camera:t}=this;return t.isPerspectiveCamera?this.getDistanceToCenter()<this._getPerspectiveTransitionDistance():t.zoom>this._getOrthographicTransitionZoom()}_raycast(t){const e=super._raycast(t);if(null===e){const{ellipsoid:e,tilesGroup:s}=this;Qs.copy(t.ray).applyMatrix4(s.matrixWorldInverse);const i=e.intersectRay(Qs,Ns);return null!==i?{point:i.clone().applyMatrix4(s.matrixWorld)}:null}return e}}const ti=new i,ei=new i,si=new R,ii=new i,ri=new i,ni=new i,ai=new g,oi=new g;class li extends C{get animating(){return 0!==this._alpha&&1!==this._alpha}get alpha(){return 0===this._target?1-this._alpha:this._alpha}get camera(){return 0===this._alpha?this.perspectiveCamera:1===this._alpha?this.orthographicCamera:this.transitionCamera}get mode(){return 0===this._target?"perspective":"orthographic"}set mode(t){if(t===this.mode)return;const e=this.camera;"perspective"===t?(this._target=0,this._alpha=0):(this._target=1,this._alpha=1),this.dispatchEvent({type:"camera-change",camera:this.camera,prevCamera:e})}constructor(t=new U,e=new R){super(),this.perspectiveCamera=t,this.orthographicCamera=e,this.transitionCamera=new U,this.orthographicPositionalZoom=!0,this.orthographicOffset=50,this.fixedPoint=new i,this.duration=200,this.autoSync=!0,this.easeFunction=t=>t,this._target=0,this._alpha=0,this._clock=new D}toggle(){this._target=1===this._target?0:1,this._clock.getDelta(),this.dispatchEvent({type:"toggle"})}update(t=Math.min(this._clock.getDelta(),.064)){this.autoSync&&this.syncCameras();const{perspectiveCamera:e,orthographicCamera:s,transitionCamera:i,camera:r}=this,a=1e3*t;if(this._alpha!==this._target){const t=Math.sign(this._target-this._alpha)*a/this.duration;this._alpha=n.clamp(this._alpha+t,0,1),this.dispatchEvent({type:"change",alpha:this.alpha})}const o=r;let l=null;0===this._alpha?l=e:1===this._alpha?l=s:(l=i,this._updateTransitionCamera()),o!==l&&(l===i&&this.dispatchEvent({type:"transition-start"}),this.dispatchEvent({type:"camera-change",camera:l,prevCamera:o}),o===i&&this.dispatchEvent({type:"transition-end"}))}syncCameras(){const t=this._getFromCamera(),{perspectiveCamera:e,orthographicCamera:s,transitionCamera:i,fixedPoint:r}=this;if(ti.set(0,0,-1).transformDirection(t.matrixWorld).normalize(),t.isPerspectiveCamera){if(this.orthographicPositionalZoom)s.position.copy(e.position).addScaledVector(ti,-this.orthographicOffset),s.rotation.copy(e.rotation),s.updateMatrixWorld();else{const t=ei.subVectors(r,s.position).dot(ti),i=ei.subVectors(r,e.position).dot(ti);ei.copy(e.position).addScaledVector(ti,i),s.rotation.copy(e.rotation),s.position.copy(ei).addScaledVector(ti,-t),s.updateMatrixWorld()}const t=Math.abs(ei.subVectors(e.position,r).dot(ti)),i=2*Math.tan(n.DEG2RAD*e.fov*.5)*t,a=s.top-s.bottom;s.zoom=a/i,s.updateProjectionMatrix()}else{const t=Math.abs(ei.subVectors(s.position,r).dot(ti)),i=.5*((s.top-s.bottom)/s.zoom)/Math.tan(n.DEG2RAD*e.fov*.5);e.rotation.copy(s.rotation),e.position.copy(s.position).addScaledVector(ti,t).addScaledVector(ti,-i),e.updateMatrixWorld(),this.orthographicPositionalZoom&&(s.position.copy(e.position).addScaledVector(ti,-this.orthographicOffset),s.updateMatrixWorld())}i.position.copy(e.position),i.rotation.copy(e.rotation)}_getTransitionDirection(){return Math.sign(this._target-this._alpha)}_getToCamera(){const t=this._getTransitionDirection();return 0===t?0===this._target?this.perspectiveCamera:this.orthographicCamera:t>0?this.orthographicCamera:this.perspectiveCamera}_getFromCamera(){const t=this._getTransitionDirection();return 0===t?0===this._target?this.perspectiveCamera:this.orthographicCamera:t>0?this.perspectiveCamera:this.orthographicCamera}_updateTransitionCamera(){const{perspectiveCamera:t,orthographicCamera:e,transitionCamera:s,fixedPoint:i}=this,r=this.easeFunction(this._alpha);ti.set(0,0,-1).transformDirection(e.matrixWorld).normalize(),si.copy(e),si.position.addScaledVector(ti,e.near),e.far-=e.near,e.near=0,ti.set(0,0,-1).transformDirection(t.matrixWorld).normalize();const a=Math.abs(ei.subVectors(t.position,i).dot(ti)),o=2*Math.tan(n.DEG2RAD*t.fov*.5)*a,l=oi.slerpQuaternions(t.quaternion,si.quaternion,r),c=n.lerp(t.fov,1,r),h=.5*o/Math.tan(n.DEG2RAD*c*.5),d=ni.copy(si.position).sub(i).applyQuaternion(ai.copy(si.quaternion).invert()),u=ri.copy(t.position).sub(i).applyQuaternion(ai.copy(t.quaternion).invert()),p=ii.lerpVectors(u,d,r);p.z-=Math.abs(p.z)-h;const m=-(u.z-p.z),f=-(d.z-p.z),g=n.lerp(m+t.near,f+si.near,r),y=n.lerp(m+t.far,f+si.far,r),_=Math.max(y,0)-Math.max(g,0);s.aspect=t.aspect,s.fov=c,s.near=Math.max(g,1e-5*_),s.far=y,s.position.copy(p).applyQuaternion(l).add(i),s.quaternion.copy(l),s.updateProjectionMatrix(),s.updateMatrixWorld()}}class ci{constructor(){this.creditsCount={}}_adjustAttributions(t,e){const s=this.creditsCount,i=t.split(/;/g);for(let r=0,n=i.length;r<n;r++){const t=i[r];t in s||(s[t]=0),s[t]+=e?1:-1,s[t]<=0&&delete s[t]}}addAttributions(t){this._adjustAttributions(t,!0)}removeAttributions(t){this._adjustAttributions(t,!1)}toString(){return Object.entries(this.creditsCount).sort(((t,e)=>{const s=t[1];return e[1]-s})).map((t=>t[0])).join("; ")}}function hi(t){let e=null;return ot(t,(t=>{if(t.content&&t.content.uri){const[,s]=t.content.uri.split("?");return e=new URLSearchParams(s).get("session"),!0}return!1})),e}class di{constructor({apiToken:t,autoRefreshToken:e=!1,logoUrl:s=null,useRecommendedSettings:i=!0}){this.name="GOOGLE_CLOUD_AUTH_PLUGIN",this.priority=-1/0,this.apiToken=t,this.autoRefreshToken=e,this.useRecommendedSettings=i,this.logoUrl=s,this.sessionToken=null,this.tiles=null,this._onLoadCallback=null,this._visibilityChangeCallback=null,this._tokenRefreshPromise=null,this._attributionsManager=new ci,this._logoAttribution={value:"",type:"image",collapsible:!1},this._attribution={value:"",type:"string",collapsible:!0}}init(t){null!=t&&(t.resetFailedTiles(),null==t.rootURL&&(t.rootURL="https://tile.googleapis.com/v1/3dtiles/root.json"),this.useRecommendedSettings&&(t.parseQueue.maxJobs=10,t.downloadQueue.maxJobs=30,t.errorTarget=40),this.tiles=t,this._onLoadCallback=({tileSet:e})=>{this.sessionToken=hi(e.root),t.removeEventListener("load-tile-set",this._onLoadCallback)},this._visibilityChangeCallback=({tile:t,visible:e})=>{const s=t.cached.metadata.asset.copyright||"";e?this._attributionsManager.addAttributions(s):this._attributionsManager.removeAttributions(s)},t.addEventListener("load-tile-set",this._onLoadCallback),t.addEventListener("tile-visibility-change",this._visibilityChangeCallback))}getAttributions(t){this.tiles.visibleTiles.size>0&&(this.logoUrl&&(this._logoAttribution.value=this.logoUrl,t.push(this._logoAttribution)),this._attribution.value=this._attributionsManager.toString(),t.push(this._attribution))}preprocessURL(t){return t=new URL(t),/^http/.test(t.protocol)&&(t.searchParams.append("key",this.apiToken),null!==this.sessionToken&&t.searchParams.append("session",this.sessionToken)),t.toString()}dispose(){const{tiles:t}=this;t.removeEventListener("load-tile-set",this._onLoadCallback),t.removeEventListener("tile-visibility-change",this._visibilityChangeCallback)}async fetchData(t,e){null!==this._tokenRefreshPromise&&(await this._tokenRefreshPromise,t=this.preprocessURL(t));const s=await fetch(t,e);return s.status>=400&&s.status<=499&&this.autoRefreshToken?(await this._refreshToken(e),fetch(this.preprocessURL(t),e)):s}_refreshToken(t){if(null===this._tokenRefreshPromise){const e=new URL(this.tiles.rootURL);e.searchParams.append("key",this.apiToken),this._tokenRefreshPromise=fetch(e,t).then((t=>t.json())).then((t=>{this.sessionToken=hi(t.root),this._tokenRefreshPromise=null})),this._tokenRefreshPromise.catch((t=>{this.tiles.dispatchEvent({type:"load-error",tile:null,error:t,rootURL:e})}))}return this._tokenRefreshPromise}}class ui{constructor({apiToken:t,assetId:e=null,autoRefreshToken:s=!1}){this.name="CESIUM_ION_AUTH_PLUGIN",this.priority=-1/0,this.apiToken=t,this.assetId=e,this.autoRefreshToken=s,this.tiles=null,this.endpointURL=null,this._bearerToken=null,this._tileSetVersion=-1,this._tokenRefreshPromise=null,this._attributions=[],this._disposed=!1}init(t){null!==this.assetId&&(t.rootURL=`https://api.cesium.com/v1/assets/${this.assetId}/endpoint`),this.tiles=t,this.endpointURL=t.rootURL,t.resetFailedTiles()}loadRootTileSet(){return this._refreshToken().then((()=>this.tiles.invokeOnePlugin((t=>t!==this&&t.loadRootTileSet&&t.loadRootTileSet()))))}preprocessURL(t){return t=new URL(t),/^http/.test(t.protocol)&&-1!=this._tileSetVersion&&t.searchParams.append("v",this._tileSetVersion),t.toString()}fetchData(t,e){return null!==this.tiles.getPluginByName("GOOGLE_CLOUD_AUTH_PLUGIN")?null:Promise.resolve().then((async()=>{null!==this._tokenRefreshPromise&&(await this._tokenRefreshPromise,t=this.preprocessURL(t));const s=await fetch(t,e);return s.status>=400&&s.status<=499&&this.autoRefreshToken?(await this._refreshToken(e),fetch(this.preprocessURL(t),e)):s}))}getAttributions(t){this.tiles.visibleTiles.size>0&&t.push(...this._attributions)}_refreshToken(t){if(null===this._tokenRefreshPromise){const e=new URL(this.endpointURL);e.searchParams.append("access_token",this.apiToken),this._tokenRefreshPromise=fetch(e,t).then((t=>{if(this._disposed)return null;if(!t.ok)throw new Error(`CesiumIonAuthPlugin: Failed to load data with error code ${t.status}`);return t.json()})).then((t=>{if(this._disposed)return null;const s=this.tiles;if("externalType"in t){const e=new URL(t.options.url);s.rootURL=t.options.url,s.registerPlugin(new di({apiToken:e.searchParams.get("key"),autoRefreshToken:this.autoRefreshToken}))}else{if(s.rootURL=t.url,s.fetchOptions.headers=s.fetchOptions.headers||{},s.fetchOptions.headers.Authorization=`Bearer ${t.accessToken}`,e.searchParams.has("v")&&-1===this._tileSetVersion){const e=new URL(t.url);this._tileSetVersion=e.searchParams.get("v")}this._bearerToken=t.accessToken,t.attributions&&(this._attributions=t.attributions.map((t=>({value:t.html,type:"html",collapsible:t.collapsible}))))}return this._tokenRefreshPromise=null,t})),this._tokenRefreshPromise.catch((t=>{this.tiles.dispatchEvent({type:"load-error",tile:null,error:t,url:e})}))}return this._tokenRefreshPromise}dispose(){this._disposed=!0}}const pi=new e;class mi{constructor(){this.name="UPDATE_ON_CHANGE_PLUGIN",this.tiles=null,this.needsUpdate=!1,this.cameraMatrices=new Map}init(t){this.tiles=t,this._needsUpdateCallback=()=>{this.needsUpdate=!0},this._onCameraAdd=({camera:t})=>{this.needsUpdate=!0,this.cameraMatrices.set(t,new e)},this._onCameraDelete=({camera:t})=>{this.needsUpdate=!0,this.cameraMatrices.delete(t)},t.addEventListener("camera-resolution-change",this._needsUpdateCallback),t.addEventListener("load-content",this._needsUpdateCallback),t.addEventListener("add-camera",this._onCameraAdd),t.addEventListener("delete-camera",this._onCameraDelete),t.cameras.forEach((t=>{this._onCameraAdd({camera:t})}))}doTilesNeedUpdate(){const t=this.tiles;let e=!1;this.cameraMatrices.forEach(((s,i)=>{pi.copy(t.group.matrixWorld).premultiply(i.matrixWorldInverse).premultiply(i.projectionMatrixInverse),e=e||!pi.equals(s),s.copy(pi)}));const s=this.needsUpdate;return this.needsUpdate=!1,s||e}preprocessNode(){this.needsUpdate=!0}dispose(){const t=this.tiles;t.removeEventListener("camera-resolution-change",this._needsUpdateCallback),t.removeEventListener("load-content",this._needsUpdateCallback),t.removeEventListener("camera-add",this._onCameraAdd),t.removeEventListener("camera-delete",this._onCameraDelete)}}const fi=new i;function gi(t,e){if(t.isInterleavedBufferAttribute||t.array instanceof e)return t;const s=e===Int8Array||e===Int16Array||e===Int32Array?-1:0,i=new e(t.count*t.itemSize),r=new l(i,t.itemSize,!0),a=t.itemSize,o=t.count;for(let l=0;l<o;l++)for(let e=0;e<a;e++){const i=n.clamp(t.getComponent(l,e),s,1);r.setComponent(l,e,i)}return r}class yi{constructor(t){this._options={generateNormals:!1,disableMipmaps:!0,compressIndex:!0,compressNormals:!1,compressUvs:!1,compressPosition:!1,uvType:Int8Array,normalType:Int8Array,positionType:Int16Array,...t},this.name="TILES_COMPRESSION_PLUGIN",this.priority=-100}processTileModel(t,e){const{generateNormals:s,disableMipmaps:i,compressIndex:r,compressUvs:a,compressNormals:o,compressPosition:c,uvType:h,normalType:d,positionType:u}=this._options;t.traverse((t=>{if(t.material&&i){const e=t.material;for(const t in e){const s=e[t];s&&s.isTexture&&s.generateMipmaps&&(s.generateMipmaps=!1,s.minFilter=I)}}if(t.geometry){const e=t.geometry,i=e.attributes;if(a){const{uv:t,uv1:e,uv2:s,uv3:r}=i;t&&(i.uv=gi(t,h)),e&&(i.uv1=gi(e,h)),s&&(i.uv2=gi(s,h)),r&&(i.uv3=gi(r,h))}if(s&&!i.normals&&e.computeVertexNormals(),o&&i.normals&&(i.normals=gi(i.normals,d)),c&&function(t,e=Int16Array){const s=t.geometry,i=s.attributes,r=i.position;if(r.isInterleavedBufferAttribute||r.array instanceof e)return r;const a=new e(r.count*r.itemSize),o=new l(a,r.itemSize,!1),c=r.itemSize,h=r.count;s.computeBoundingBox();const d=s.boundingBox,{min:u,max:p}=d,m=2**(8*e.BYTES_PER_ELEMENT-1)-1,f=-m;for(let l=0;l<h;l++)for(let t=0;t<c;t++){const e=0===t?"x":1===t?"y":"z",s=u[e],i=p[e],a=n.mapLinear(r.getComponent(l,t),s,i,f,m);o.setComponent(l,t,a)}d.getCenter(fi),t.position.add(fi),t.scale.x*=.5*(p.x-u.x)/m,t.scale.y*=.5*(p.y-u.y)/m,t.scale.z*=.5*(p.z-u.z)/m,i.position=o,t.geometry.boundingBox=null,t.geometry.boundingSphere=null,t.updateMatrixWorld()}(t,u),r&&e.index){const t=i.position.count,s=e.index,r=t>65535?Uint32Array:t>255?Uint16Array:Uint8Array;if(!(s.array instanceof r)){const t=new r(e.index.count);t.set(s.array);const i=new l(t,1);e.setIndex(i)}}}}))}}function _i(t,e,s){return t&&e in t?t[e]:s}function bi(t){return"BOOLEAN"!==t&&"STRING"!==t&&"ENUM"!==t}function xi(t){return/^VEC/.test(t)}function Ti(t){return/^MAT/.test(t)}function vi(t,e,s,i=null){return Ti(s)||xi(s)?i.fromArray(t,e):t[e]}function wi(t){const{type:s,componentType:n}=t;switch(s){case"SCALAR":return"INT64"===n?0n:0;case"VEC2":return new r;case"VEC3":return new i;case"VEC4":return new F;case"MAT2":return new L;case"MAT3":return new T;case"MAT4":return new e;case"BOOLEAN":return!1;case"STRING":return"";case"ENUM":return 0}}function Pi(t,e){if(null==e)return!1;switch(t){case"SCALAR":case"ENUM":return"number"==typeof e||"bigint"==typeof e;case"VEC2":return e.isVector2;case"VEC3":return e.isVector3;case"VEC4":return e.isVector4;case"MAT2":return e.isMatrix2;case"MAT3":return e.isMatrix3;case"MAT4":return e.isMatrix4;case"BOOLEAN":return"boolean"==typeof e;case"STRING":return"string"==typeof e}throw new Error("ClassProperty: invalid type.")}function Ci(t,e=null){switch(t){case"INT8":return Int8Array;case"INT16":return Int16Array;case"INT32":return Int32Array;case"INT64":return BigInt64Array;case"UINT8":return Uint8Array;case"UINT16":return Uint16Array;case"UINT32":return Uint32Array;case"UINT64":return BigUint64Array;case"FLOAT32":return Float32Array;case"FLOAT64":return Float64Array}switch(e){case"BOOLEAN":case"STRING":return Uint8Array}throw new Error("ClassProperty: invalid type.")}function Mi(t,e=null){const s=t.default,i=t.type;if(e=e||wi(t),null===s){switch(i){case"SCALAR":return 0;case"VEC2":return e.set(0,0);case"VEC3":return e.set(0,0,0);case"VEC4":return e.set(0,0,0,0);case"MAT2":case"MAT3":case"MAT4":return e.identity();case"BOOLEAN":return!1;case"STRING":case"ENUM":return""}throw new Error("ClassProperty: invalid type.")}if(Ti(i))e.fromArray(s);else{if(!xi(i))return s;e.fromArray(s)}}function Si(t,e){if(null===t.noData)return e;const s=t.noData,i=t.type;if(Array.isArray(e))for(let n=0,a=e.length;n<a;n++)e[n]=r(e[n]);else e=r(e);return e;function r(e){return function(t){if(Ti(i)){const e=t.elements;for(let t=0,i=s.length;t<i;t++)if(s[t]!==e[t])return!1;return!0}if(xi(i)){for(let e=0,i=s.length;e<i;e++)if(s[e]!==t.getComponent(e))return!1;return!0}return s===t}(e)&&(e=Mi(t,e)),e}}function Ai(t,e){const{type:s,componentType:i,scale:r,offset:n,normalized:a}=t;if(Array.isArray(e))for(let c=0,h=e.length;c<h;c++)e[c]=o(e[c]);else e=o(e);return e;function o(t){return t=Ti(s)?function(t){const e=t.elements;for(let s=0,i=e.length;s<i;s++)e[s]=l(e[s]);return t}(t):xi(s)?function(t){t.x=l(t.x),t.y=l(t.y),"z"in t&&(t.z=l(t.z));"w"in t&&(t.w=l(t.w));return t}(t):l(t)}function l(t){return a&&(t=function(t,e){switch(t){case"INT8":return Math.max(e/127,-1);case"INT16":return Math.max(e,32767,-1);case"INT32":return Math.max(e/2147483647,-1);case"INT64":return Math.max(Number(e)/0x8000000000000000,-1);case"UINT8":return e/255;case"UINT16":return e/65535;case"UINT32":return e/4294967295;case"UINT64":return Number(e)/0x10000000000000000}}(i,t)),(a||function(t){return/^FLOAT/.test(t)}(i))&&(t=t*r+n),t}}function Ei(t,e,s=null){if(t.array){Array.isArray(e)||(e=new Array(t.count||0)),e.length=null!==s?s:t.count;for(let s=0,i=e.length;s<i;s++)Pi(t.type,e[s])||(e[s]=wi(t))}else Pi(t.type,e)||(e=wi(t));return e}function Di(t,e){for(const s in e)s in t||delete e[s];for(const s in t){const i=t[s];e[s]=Ei(i,e[s])}}class Ui{constructor(t,e,s=null){this.name=e.name||null,this.description=e.description||null,this.type=e.type,this.componentType=e.componentType||null,this.enumType=e.enumType||null,this.array=e.array||!1,this.count=e.count||0,this.normalized=e.normalized||!1,this.offset=e.offset||0,this.scale=_i(e,"scale",1),this.max=_i(e,"max",1/0),this.min=_i(e,"min",-1/0),this.required=e.required||!1,this.noData=_i(e,"noData",null),this.default=_i(e,"default",null),this.semantic=_i(e,"semantic",null),this.enumSet=null,this.accessorProperty=s,s&&(this.offset=_i(s,"offset",this.offset),this.scale=_i(s,"scale",this.scale),this.max=_i(s,"max",this.max),this.min=_i(s,"min",this.min)),"ENUM"===e.type&&(this.enumSet=t[this.enumType],null===this.componentType&&(this.componentType=_i(this.enumSet,"valueType","UINT16")))}shapeToProperty(t,e=null){return Ei(this,t,e)}resolveDefaultElement(t){return Mi(this,t)}resolveDefault(t){return function(t,e=null){if(t.array){(e=e&&Array.isArray(e)?e:[]).length=t.count;for(let s=0,i=e.length;s<i;s++)e[s]=Mi(t,e[s])}else e=Mi(t,e);return e}(this,t)}resolveNoData(t){return Si(this,t)}resolveEnumsToStrings(t){const e=this.enumSet;if("ENUM"===this.type)if(Array.isArray(t))for(let i=0,r=t.length;i<r;i++)t[i]=s(t[i]);else t=s(t);return t;function s(t){const s=e.values.find((e=>e.value===t));return null===s?"":s.name}}adjustValueScaleOffset(t){return bi(this.type)?Ai(this,t):t}}class Ri{constructor(t,e={},s={},i=null){this.definition=t,this.class=e[t.class],this.className=t.class,this.enums=s,this.data=i,this.name="name"in t?t.name:null,this.properties=null}getPropertyNames(){return Object.keys(this.class.properties)}includesData(t){return Boolean(this.definition.properties[t])}dispose(){}_initProperties(t=Ui){const e={};for(const s in this.class.properties)e[s]=new t(this.enums,this.class.properties[s],this.definition.properties[s]);this.properties=e}}class Ii extends Ui{constructor(t,e,s=null){super(t,e,s),this.attribute=s.attribute}}class Li extends Ri{constructor(...t){super(...t),this.isPropertyAttributeAccessor=!0,this._initProperties(Ii)}getData(t,e,s={}){const i=this.properties;Di(i,s);for(const r in i)s[r]=this.getPropertyValue(r,t,e,s[r]);return s}getPropertyValue(t,e,s,i=null){if(e>=this.count)throw new Error("PropertyAttributeAccessor: Requested index is outside the range of the buffer.");const r=this.properties[t],n=r.type;if(!r)throw new Error("PropertyAttributeAccessor: Requested class property does not exist.");if(!this.definition.properties[t])return r.resolveDefault(i);i=r.shapeToProperty(i);const a=s.getAttribute(r.attribute.toLowerCase());if(Ti(n)){const t=i.elements;for(let s=0,i=t.length;s<i;s<i)t[s]=a.getComponent(e,s)}else if(xi(n))i.fromBufferAttribute(a,e);else{if("SCALAR"!==n&&"ENUM"!==n)throw new Error("StructuredMetadata.PropertyAttributeAccessor: BOOLEAN and STRING types are not supported by property attributes.");i=a.getX(e)}return i=r.adjustValueScaleOffset(i),i=r.resolveEnumsToStrings(i),i=r.resolveNoData(i)}}class Fi extends Ui{constructor(t,e,s=null){super(t,e,s),this.values=s.values,this.valueLength=function(t){switch(t){case"ENUM":case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return-1}}(this.type),this.arrayOffsets=_i(s,"arrayOffsets",null),this.stringOffsets=_i(s,"stringOffsets",null),this.arrayOffsetType=_i(s,"arrayOffsetType","UINT32"),this.stringOffsetType=_i(s,"stringOffsetType","UINT32")}getArrayLengthFromId(t,e){let s=this.count;if(null!==this.arrayOffsets){const{arrayOffsets:i,arrayOffsetType:r}=this,n=new(Ci(r))(t[i]);s=n[e+1]-n[e]}return s}getIndexOffsetFromId(t,e){let s=e;if(this.arrayOffsets){const{arrayOffsets:e,arrayOffsetType:i}=this;s=new(Ci(i))(t[e])[s]}else this.array&&(s*=this.count);return s}}class ki extends Ri{constructor(...t){super(...t),this.isPropertyTableAccessor=!0,this.count=this.definition.count,this._initProperties(Fi)}getData(t,e={}){const s=this.properties;Di(s,e);for(const i in s)e[i]=this.getPropertyValue(i,t,e[i]);return e}_readValueAtIndex(t,e,s,i=null){const r=this.properties[t],{componentType:n,type:a}=r,o=this.data,l=o[r.values],c=new(Ci(n,a))(l),h=r.getIndexOffsetFromId(o,e);if(bi(a)||"ENUM"===a)return vi(c,(h+s)*r.valueLength,a,i);if("STRING"===a){let t=h+s,e=0;if(null!==r.stringOffsets){const{stringOffsets:s,stringOffsetType:i}=r,n=new(Ci(i))(o[s]);e=n[t+1]-n[t],t=n[t]}const n=new Uint8Array(c.buffer,t,e);i=(new TextDecoder).decode(n)}else if("BOOLEAN"===a){const t=h+s,e=t%8;i=1===(c[Math.floor(t/8)]>>e&1)}return i}getPropertyValue(t,e,s=null){if(e>=this.count)throw new Error("PropertyTableAccessor: Requested index is outside the range of the table.");const i=this.properties[t];if(!i)throw new Error("PropertyTableAccessor: Requested property does not exist.");if(!this.definition.properties[t])return i.resolveDefault(s);const r=i.array,n=this.data,a=i.getArrayLengthFromId(n,e);if(s=i.shapeToProperty(s,a),r)for(let o=0,l=s.length;o<l;o++)s[o]=this._readValueAtIndex(t,e,o,s[o]);else s=this._readValueAtIndex(t,e,0,s);return s=i.adjustValueScaleOffset(s),s=i.resolveEnumsToStrings(s),s=i.resolveNoData(s)}}const Oi=new W;class zi{constructor(){this._renderer=new k,this._target=new O(1,1),this._texTarget=new O,this._quad=new z(new A({blending:B,blendDst:N,blendSrc:V,uniforms:{map:{value:null},pixel:{value:new r}},vertexShader:"\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\t\t\t\tuniform sampler2D map;\n\t\t\t\tuniform ivec2 pixel;\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tgl_FragColor = texelFetch( map, pixel, 0 );\n\n\t\t\t\t}\n\t\t\t"}))}increaseSizeTo(t){this._target.setSize(Math.max(this._target.width,t),1)}readDataAsync(t){const{_renderer:e,_target:s}=this;return e.readRenderTargetPixelsAsync(s,0,0,t.length/4,1,t)}readData(t){const{_renderer:e,_target:s}=this;e.readRenderTargetPixels(s,0,0,t.length/4,1,t)}renderPixelToTarget(t,e,s){const{_renderer:i,_target:r}=this;Oi.min.copy(e),Oi.max.copy(e),Oi.max.x+=1,Oi.max.y+=1,i.initRenderTarget(r),i.copyTextureToTexture(t,r.texture,Oi,s,0)}}const Vi=new class{constructor(){let t=null;Object.getOwnPropertyNames(zi.prototype).forEach((e=>{"constructor"!==e&&(this[e]=(...s)=>(t=t||new zi,t[e](...s)))}))}},Ni=new r,Bi=new r,Wi=new r;function ji(t,e,s=new Array(3)){let i=3*e,r=3*e+1,n=3*e+2;return t.index&&(i=t.index.getX(i),r=t.index.getX(r),n=t.index.getX(n)),s[0]=i,s[1]=r,s[2]=n,s}function Gi(t,e,s,i,r){const[n,a,o]=i,l=function(t,e){return 0===e?t.getAttribute("uv"):t.getAttribute(`uv${e}`)}(t,e);Ni.fromBufferAttribute(l,n),Bi.fromBufferAttribute(l,a),Wi.fromBufferAttribute(l,o),r.set(0,0,0).addScaledVector(Ni,s.x).addScaledVector(Bi,s.y).addScaledVector(Wi,s.z)}function Hi(t,e,s,i){const r=t.x-Math.floor(t.x),n=t.y-Math.floor(t.y),a=Math.floor(r*e%e),o=Math.floor(n*s%s);return i.set(a,o),i}const qi=new r,Zi=new r,$i=new r;class Qi extends Ui{constructor(t,e,s=null){super(t,e,s),this.channels=_i(s,"channels",[0]),this.index=_i(s,"index",null),this.texCoord=_i(s,"texCoord",null),this.valueLength=parseInt(this.type.replace(/[^0-9]/g,""))||1}readDataFromBuffer(t,e,s=null){const i=this.type;if("BOOLEAN"===i||"STRING"===i)throw new Error("PropertyTextureAccessor: BOOLEAN and STRING types not supported.");return vi(t,e*this.valueLength,i,s)}}class Yi extends Ri{constructor(...t){super(...t),this.isPropertyTextureAccessor=!0,this._asyncRead=!1,this._initProperties(Qi)}getData(t,e,s,i={}){const r=this.properties;Di(r,i);const n=Object.keys(r),a=n.map((t=>i[t]));return this.getPropertyValuesAtTexel(n,t,e,s,a),n.forEach(((t,e)=>i[t]=a[e])),i}async getDataAsync(t,e,s,i={}){const r=this.properties;Di(r,i);const n=Object.keys(r),a=n.map((t=>i[t]));return await this.getPropertyValuesAtTexelAsync(n,t,e,s,a),n.forEach(((t,e)=>i[t]=a[e])),i}getPropertyValuesAtTexelAsync(...t){this._asyncRead=!0;const e=this.getPropertyValuesAtTexel(...t);return this._asyncRead=!1,e}getPropertyValuesAtTexel(t,e,s,i,r=[]){for(;r.length<t.length;)r.push(null);r.length=t.length,Vi.increaseSizeTo(r.length);const n=this.data,a=this.definition.properties,o=this.properties,l=ji(i,e);for(let d=0,u=t.length;d<u;d++){const e=t[d];if(!a[e])continue;const r=o[e],c=n[r.index];Gi(i,r.texCoord,s,l,qi),Hi(qi,c.image.width,c.image.height,Zi),$i.set(d,0),Vi.renderPixelToTarget(c,Zi,$i)}const c=new Uint8Array(4*t.length);return this._asyncRead?Vi.readDataAsync(c).then((()=>(h.call(this),r))):(Vi.readData(c),h.call(this),r);function h(){for(let e=0,s=t.length;e<s;e++){const s=t[e],i=o[s],n=i.type;if(r[e]=Ei(i,r[e]),!i)throw new Error("PropertyTextureAccessor: Requested property does not exist.");if(!a[s]){r[e]=i.resolveDefault(r);continue}const l=i.valueLength*(i.count||1),h=i.channels.map((t=>c[4*e+t])),d=new(Ci(i.componentType,n))(l);if(new Uint8Array(d.buffer).set(h),i.array){const t=r[e];for(let e=0,s=t.length;e<s;e++)t[e]=i.readDataFromBuffer(d,e,t[e])}else r[e]=i.readDataFromBuffer(d,0,r[e]);r[e]=i.adjustValueScaleOffset(r[e]),r[e]=i.resolveEnumsToStrings(r[e]),r[e]=i.resolveNoData(r[e])}}}dispose(){this.data.forEach((t=>{t&&(t.dispose(),t.image instanceof ImageBitmap&&t.image.close())}))}}class Ji{constructor(t,e,s,i=null,r=null){const{schema:n,propertyTables:a=[],propertyTextures:o=[],propertyAttributes:l=[]}=t,{enums:c,classes:h}=n,d=a.map((t=>new ki(t,h,c,s)));let u=[],p=[];i&&(i.propertyTextures&&(u=i.propertyTextures.map((t=>new Yi(o[t],h,c,e)))),i.propertyAttributes&&(p=i.propertyAttributes.map((t=>new Li(l[t],h,c))))),this.schema=n,this.tableAccessors=d,this.textureAccessors=u,this.attributeAccessors=p,this.object=r,this.textures=e,this.nodeMetadata=i}getPropertyTableData(t,e,s=null){if(Array.isArray(t)&&Array.isArray(e)){s=s||[];const i=Math.min(t.length,e.length);s.length=i;for(let r=0;r<i;r++){const i=this.tableAccessors[t[r]];s[r]=i.getData(e[r],s[r])}}else{s=s||{};s=this.tableAccessors[t].getData(e,s)}return s}getPropertyTableInfo(t=null){if(null===t&&(t=this.tableAccessors.map(((t,e)=>e))),Array.isArray(t))return t.map((t=>{const e=this.tableAccessors[t];return{name:e.name,className:e.definition.class}}));{const e=this.tableAccessors[t];return{name:e.name,className:e.definition.class}}}getPropertyTextureData(t,e,s=[]){const i=this.textureAccessors;s.length=i.length;for(let r=0;r<i.length;r++){const n=i[r];s[r]=n.getData(t,e,this.object.geometry,s[r])}return s}async getPropertyTextureDataAsync(t,e,s=[]){const i=this.textureAccessors;s.length=i.length;const r=[];for(let n=0;n<i.length;n++){const a=i[n].getDataAsync(t,e,this.object.geometry,s[n]).then((t=>{s[n]=t}));r.push(a)}return await Promise.all(r),s}getPropertyTextureInfo(){return this.textureAccessors}getPropertyAttributeData(t,e=[]){const s=this.attributeAccessors;e.length=s.length;for(let i=0;i<s.length;i++){const r=s[i];e[i]=r.getData(t,this.object.geometry,e[i])}return e}getPropertyAttributeInfo(){return this.attributeAccessors.map((t=>({name:t.name,className:t.definition.class})))}dispose(){this.textureAccessors.forEach((t=>t.dispose())),this.tableAccessors.forEach((t=>t.dispose())),this.attributeAccessors.forEach((t=>t.dispose()))}}const Xi="EXT_structural_metadata";function Ki(t,e=[]){const s=t.json.textures?.length||0,i=new Array(s).fill(null);return e.forEach((({properties:e})=>{for(const s in e){const{index:r}=e[s];null===i[r]&&(i[r]=t.loadTexture(r))}})),Promise.all(i)}function tr(t,e=[]){const s=t.json.bufferViews?.length||0,i=new Array(s).fill(null);return e.forEach((({properties:e})=>{for(const s in e){const{values:r,arrayOffsets:n,stringOffsets:a}=e[s];null===i[r]&&(i[r]=t.loadBufferView(r)),null===i[n]&&(i[n]=t.loadBufferView(n)),null===i[a]&&(i[a]=t.loadBufferView(a))}})),Promise.all(i)}class er{constructor(t){this.parser=t,this.name=Xi}async afterRoot({scene:t,parser:e}){const s=e.json.extensionsUsed;if(!s||!s.includes(Xi))return;let i=null,r=e.json.extensions[Xi];if(r.schemaUri){const{manager:t,path:s,requestHeader:n,crossOrigin:a}=e.options,o=new URL(r.schemaUri,s).toString(),l=new j(t);l.setCrossOrigin(a),l.setResponseType("json"),l.setRequestHeader(n),i=l.loadAsync(o).then((t=>{r={...r,schema:t}}))}const[n,a]=await Promise.all([Ki(e,r.propertyTextures),tr(e,r.propertyTables),i]),o=new Ji(r,n,a);t.userData.structuralMetadata=o,t.traverse((t=>{if(e.associations.has(t)){const{meshes:s,primitives:i}=e.associations.get(t),l=e.json.meshes[s]?.primitives[i];if(l&&l.extensions&&l.extensions[Xi]){const e=l.extensions[Xi];t.userData.structuralMetadata=new Ji(r,n,a,e,t)}else t.userData.structuralMetadata=o}}))}}const sr=new r,ir=new r,rr=new r;class nr{constructor(t,e,s){this.geometry=t,this.textures=e,this.data=s,this._asyncRead=!1,this.featureIds=s.featureIds.map((t=>{const{texture:e,...s}=t,i={label:null,propertyTable:null,nullFeatureId:null,...s};return e&&(i.texture={texCoord:0,channels:[0],...e}),i}))}getTextures(){return this.textures}getFeatureInfo(){return this.featureIds}getFeaturesAsync(...t){this._asyncRead=!0;const e=this.getFeatures(...t);return this._asyncRead=!1,e}getFeatures(t,e){const{geometry:s,textures:i,featureIds:r}=this,n=new Array(r.length).fill(null),a=r.length;Vi.increaseSizeTo(a);const o=ji(s,t),l=o[function(t){return t.x>t.y&&t.x>t.z?0:t.y>t.z?1:2}(e)];for(let d=0,u=r.length;d<u;d++){const t=r[d],a="nullFeatureId"in t?t.nullFeatureId:null;if("texture"in t){const r=i[t.texture.index];Gi(s,t.texture.texCoord,e,o,sr),Hi(sr,r.image.width,r.image.height,ir),rr.set(d,0),Vi.renderPixelToTarget(i[t.texture.index],ir,rr)}else if("attribute"in t){const e=s.getAttribute(`_feature_id_${t.attribute}`).getX(l);e!==a&&(n[d]=e)}else{const t=l;t!==a&&(n[d]=t)}}const c=new Uint8Array(4*a);return this._asyncRead?Vi.readDataAsync(c).then((()=>(h(),n))):(Vi.readData(c),h(),n);function h(){const t=new Uint32Array(1);for(let e=0,s=r.length;e<s;e++){const s=r[e],i="nullFeatureId"in s?s.nullFeatureId:null;if("texture"in s){const{channels:r}=s.texture,a=r.map((t=>c[4*e+t]));new Uint8Array(t.buffer).set(a);const o=t[0];o!==i&&(n[e]=o)}}}}dispose(){this.textures.forEach((t=>{t&&(t.dispose(),t.image instanceof ImageBitmap&&t.image.close())}))}}const ar="EXT_mesh_features";function or(t,e,s){t.traverse((t=>{if(e.associations.has(t)){const{meshes:i,primitives:r}=e.associations.get(t),n=e.json.meshes[i]?.primitives[r];n&&n.extensions&&n.extensions[ar]&&s(t,n.extensions[ar])}}))}class lr{constructor(t){this.parser=t,this.name=ar}async afterRoot({scene:t,parser:e}){const s=e.json.extensionsUsed;if(!s||!s.includes(ar))return;const i=e.json.textures?.length||0,r=new Array(i).fill(null);or(t,e,((t,{featureIds:s})=>{s.forEach((t=>{if(t.texture&&null===r[t.texture.index]){const s=t.texture.index;r[s]=e.loadTexture(s)}}))}));const n=await Promise.all(r);or(t,e,((t,e)=>{t.userData.meshFeatures=new nr(t.geometry,n,e)}))}}class cr{constructor(){this.name="CESIUM_RTC"}afterRoot(t){if(t.parser.json.extensions&&t.parser.json.extensions.CESIUM_RTC){const{center:e}=t.parser.json.extensions.CESIUM_RTC;e&&(t.scene.position.x+=e[0],t.scene.position.y+=e[1],t.scene.position.z+=e[2])}}}class hr{constructor(t){t={metadata:!0,rtc:!0,plugins:[],dracoLoader:null,ktxLoader:null,meshoptDecoder:null,autoDispose:!0,...t},this.tiles=null,this.metadata=t.metadata,this.rtc=t.rtc,this.plugins=t.plugins,this.dracoLoader=t.dracoLoader,this.ktxLoader=t.ktxLoader,this.meshoptDecoder=t.meshoptDecoder,this._gltfRegex=/\.(gltf|glb)$/g,this._dracoRegex=/\.drc$/g,this._loader=null}init(t){const e=new s(t.manager);this.dracoLoader&&(e.setDRACOLoader(this.dracoLoader),t.manager.addHandler(this._dracoRegex,this.dracoLoader)),this.ktxLoader&&e.setKTX2Loader(this.ktxLoader),this.meshoptDecoder&&e.setMeshoptDecoder(this.meshoptDecoder),this.rtc&&e.register((()=>new cr)),this.metadata&&(e.register((()=>new er)),e.register((()=>new lr))),this.plugins.forEach((t=>e.register(t))),t.manager.addHandler(this._gltfRegex,e),this.tiles=t,this._loader=e}dispose(){this.tiles.manager.removeHandler(this._gltfRegex),this.tiles.manager.removeHandler(this._dracoRegex),this.autoDispose&&(this.ktxLoader.dispose(),this.dracoLoader.dispose())}}class dr{set delay(t){this.deferCallbacks.delay=t}get delay(){return this.deferCallbacks.delay}set bytesTarget(t){this.lruCache.minBytesSize=t}get bytesTarget(){return this.lruCache.minBytesSize}get estimatedGpuBytes(){return this.lruCache.cachedBytes}constructor(t={}){const{delay:e=0,bytesTarget:s=0}=t;this.name="UNLOAD_TILES_PLUGIN",this.tiles=null,this.lruCache=new Q,this.deferCallbacks=new ur,this.delay=e,this.bytesTarget=s}init(t){this.tiles=t;const{lruCache:e,deferCallbacks:s}=this;s.callback=t=>{e.markUnused(t),e.scheduleUnload(!1)};const i=e=>{const s=e.cached.scene;t.visibleTiles.has(e)||t.invokeOnePlugin((t=>t.unloadTileFromGPU&&t.unloadTileFromGPU(s,e)))};this._onUpdateBefore=()=>{e.unloadPriorityCallback=t.lruCache.unloadPriorityCallback,e.computeMemoryUsageCallback=t.lruCache.computeMemoryUsageCallback,e.minSize=1/0,e.maxSize=1/0,e.maxBytesSize=1/0,e.unloadPercent=1,e.autoMarkUnused=!1},this._onVisibilityChangeCallback=({tile:r,visible:n})=>{n?(e.add(r,i),t.markTileUsed(r),s.cancel(r)):s.run(r)},t.forEachLoadedModel(((e,s)=>{const i=t.visibleTiles.has(s);this._onVisibilityChangeCallback({scene:e,visible:i})})),t.addEventListener("tile-visibility-change",this._onVisibilityChangeCallback),t.addEventListener("update-before",this._onUpdateBefore)}unloadTileFromGPU(t,e){t&&t.traverse((t=>{if(t.material){const e=t.material;e.dispose();for(const t in e){const s=e[t];s&&s.isTexture&&s.dispose()}}t.geometry&&t.geometry.dispose()}))}dispose(){this.tiles.removeEventListener("tile-visibility-change",this._onVisibilityChangeCallback),this.tiles.removeEventListener("update-before",this._onUpdateBefore),this.deferCallbacks.cancelAll()}}class ur{constructor(t=()=>{}){this.map=new Map,this.callback=t,this.delay=0}run(t){const{map:e,delay:s}=this;if(e.has(t))throw new Error("DeferCallbackManager: Callback already initialized.");0===s?this.callback(t):e.set(t,setTimeout((()=>this.callback(t)),s))}cancel(t){const{map:e}=this;e.has(t)&&(clearTimeout(e.get(t)),e.delete(t))}cancelAll(){this.map.forEach(((t,e)=>{this.cancel(e)}))}}const{clamp:pr}=n;class mr{constructor(){this.duration=250,this.fadeCount=0,this._lastTick=-1,this._fadeState=new Map,this.onFadeComplete=null,this.onFadeStart=null,this.onFadeSetComplete=null,this.onFadeSetStart=null}deleteObject(t){t&&this.completeFade(t)}guaranteeState(t){const e=this._fadeState;if(e.has(t))return!1;return e.set(t,{fadeInTarget:0,fadeOutTarget:0,fadeIn:0,fadeOut:0}),!0}completeFade(t){const e=this._fadeState;if(!e.has(t))return;const s=0===e.get(t).fadeOutTarget;e.delete(t),this.fadeCount--,this.onFadeComplete&&this.onFadeComplete(t,s),0===this.fadeCount&&this.onFadeSetComplete&&this.onFadeSetComplete()}completeAllFades(){this._fadeState.forEach(((t,e)=>{this.completeFade(e)}))}forEachObject(t){this._fadeState.forEach(((e,s)=>{t(s,e)}))}fadeIn(t){const e=this.guaranteeState(t),s=this._fadeState.get(t);s.fadeInTarget=1,s.fadeOutTarget=0,s.fadeOut=0,e&&(this.fadeCount++,1===this.fadeCount&&this.onFadeSetStart&&this.onFadeSetStart(),this.onFadeStart&&this.onFadeStart(t))}fadeOut(t){const e=this.guaranteeState(t),s=this._fadeState.get(t);s.fadeOutTarget=1,e&&(s.fadeInTarget=1,s.fadeIn=1,this.fadeCount++,1===this.fadeCount&&this.onFadeSetStart&&this.onFadeSetStart(),this.onFadeStart&&this.onFadeStart(t))}isFading(t){return this._fadeState.has(t)}isFadingOut(t){const e=this._fadeState.get(t);return e&&1===e.fadeOutTarget}update(){const t=window.performance.now();-1===this._lastTick&&(this._lastTick=t);const e=pr((t-this._lastTick)/this.duration,0,1);this._lastTick=t;this._fadeState.forEach(((t,s)=>{const{fadeOutTarget:i,fadeInTarget:r}=t;let{fadeOut:n,fadeIn:a}=t;const o=Math.sign(r-a);a=pr(a+o*e,0,1);const l=Math.sign(i-n);n=pr(n+l*e,0,1),t.fadeIn=a,t.fadeOut=n;((1===n||0===n)&&(1===a||0===a)||n>=a)&&this.completeFade(s)}))}}function fr(t,e){const s={fadeIn:{value:0},fadeOut:{value:0},fadeTexture:{value:null}};return t.defines={...t.defines||{},FEATURE_FADE:0},t.onBeforeCompile=t=>{e&&e(t),t.uniforms={...t.uniforms,...s},t.vertexShader=t.vertexShader.replace(/void\s+main\(\)\s+{/,(t=>`\n\t\t\t\t\t#ifdef USE_BATCHING_FRAG\n\n\t\t\t\t\tvarying float vBatchId;\n\n\t\t\t\t\t#endif\n\n\t\t\t\t\t${t}\n\n\t\t\t\t\t\t#ifdef USE_BATCHING_FRAG\n\n\t\t\t\t\t\t// add 0.5 to the value to avoid floating error that may cause flickering\n\t\t\t\t\t\tvBatchId = getIndirectIndex( gl_DrawID ) + 0.5;\n\n\t\t\t\t\t\t#endif\n\t\t\t\t`)),t.fragmentShader=t.fragmentShader.replace(/void main\(/,(t=>`\n\t\t\t\t#if FEATURE_FADE\n\n\t\t\t\t// adapted from https://www.shadertoy.com/view/Mlt3z8\n\t\t\t\tfloat bayerDither2x2( vec2 v ) {\n\n\t\t\t\t\treturn mod( 3.0 * v.y + 2.0 * v.x, 4.0 );\n\n\t\t\t\t}\n\n\t\t\t\tfloat bayerDither4x4( vec2 v ) {\n\n\t\t\t\t\tvec2 P1 = mod( v, 2.0 );\n\t\t\t\t\tvec2 P2 = floor( 0.5 * mod( v, 4.0 ) );\n\t\t\t\t\treturn 4.0 * bayerDither2x2( P1 ) + bayerDither2x2( P2 );\n\n\t\t\t\t}\n\n\t\t\t\t// the USE_BATCHING define is not available in fragment shaders\n\t\t\t\t#ifdef USE_BATCHING_FRAG\n\n\t\t\t\t// functions for reading the fade state of a given batch id\n\t\t\t\tuniform sampler2D fadeTexture;\n\t\t\t\tvarying float vBatchId;\n\t\t\t\tvec2 getFadeValues( const in float i ) {\n\n\t\t\t\t\tint size = textureSize( fadeTexture, 0 ).x;\n\t\t\t\t\tint j = int( i );\n\t\t\t\t\tint x = j % size;\n\t\t\t\t\tint y = j / size;\n\t\t\t\t\treturn texelFetch( fadeTexture, ivec2( x, y ), 0 ).rg;\n\n\t\t\t\t}\n\n\t\t\t\t#else\n\n\t\t\t\tuniform float fadeIn;\n\t\t\t\tuniform float fadeOut;\n\n\t\t\t\t#endif\n\n\t\t\t\t#endif\n\n\t\t\t\t${t}\n\t\t\t`)).replace(/#include <dithering_fragment>/,(t=>`\n\n\t\t\t\t${t}\n\n\t\t\t\t#if FEATURE_FADE\n\n\t\t\t\t#ifdef USE_BATCHING_FRAG\n\n\t\t\t\tvec2 fadeValues = getFadeValues( vBatchId );\n\t\t\t\tfloat fadeIn = fadeValues.r;\n\t\t\t\tfloat fadeOut = fadeValues.g;\n\n\t\t\t\t#endif\n\n\t\t\t\tfloat bayerValue = bayerDither4x4( floor( mod( gl_FragCoord.xy, 4.0 ) ) );\n\t\t\t\tfloat bayerBins = 16.0;\n\t\t\t\tfloat dither = ( 0.5 + bayerValue ) / bayerBins;\n\t\t\t\tif ( dither >= fadeIn ) {\n\n\t\t\t\t\tdiscard;\n\n\t\t\t\t}\n\n\t\t\t\tif ( dither < fadeOut ) {\n\n\t\t\t\t\tdiscard;\n\n\t\t\t\t}\n\n\t\t\t\t#endif\n\n\t\t\t`))},s}class gr{constructor(){this._fadeParams=new WeakMap,this.fading=0}setFade(t,e,s){if(!t)return;const i=this._fadeParams;t.traverse((t=>{const r=t.material;if(r){const t=i.get(r);t.fadeIn.value=e,t.fadeOut.value=s;const n=Number(!(0===e||1===e)||!(0===s||1===s));r.defines.FEATURE_FADE!==n&&(this.fading+=1===n?1:-1,r.defines.FEATURE_FADE=n,r.needsUpdate=!0)}}))}prepareScene(t){t.traverse((t=>{t.material&&this.prepareMaterial(t.material)}))}deleteScene(t){if(!t)return;const e=this._fadeParams;t.traverse((t=>{const s=t.material;s&&(e.delete(s),s.onBeforeCompile=()=>{},s.needsUpdate=!0)}))}prepareMaterial(t){const e=this._fadeParams;e.has(t)||e.set(t,fr(t))}}class yr{constructor(t,e=new G){this.other=t,this.material=e,this.visible=!0,this.parent=null,this._instanceInfo=[],this._visibilityChanged=!0;const s=new Proxy(this,{get(e,i){if(i in e)return e[i];{const r=t[i];return r instanceof Function?(...t)=>(e.syncInstances(),r.call(s,...t)):t[i]}},set:(e,s,i)=>(s in e?e[s]=i:t[s]=i,!0),deleteProperty:(e,s)=>s in e?delete e[s]:delete t[s]});return s}syncInstances(){const t=this._instanceInfo,e=this.other._instanceInfo;for(;e.length>t.length;){const s=t.length;t.push(new Proxy({visible:!1},{get:(t,i)=>i in t?t[i]:e[s][i],set:(t,i,r)=>(i in t?t[i]=r:e[s][i]=r,!0)}))}}}class _r extends yr{constructor(...t){super(...t);const e=this.material,s=fr(e,e.onBeforeCompile);e.defines.FEATURE_FADE=1,e.defines.USE_BATCHING_FRAG=1,e.needsUpdate=!0,this.fadeTexture=null,this._fadeParams=s}setFadeAt(t,e,s){this._initFadeTexture(),this.fadeTexture.setValueAt(t,255*e,255*s)}_initFadeTexture(){let t=Math.sqrt(this._maxInstanceCount);t=Math.ceil(t);const e=t*t*2,s=this.fadeTexture;if(!s||s.image.data.length!==e){const i=new Uint8Array(e),r=new br(i,t,t,H,q);if(s){s.dispose();const t=s.image.data,e=this.fadeTexture.image.data,i=Math.min(t.length,e.length);e.set(new t.constructor(t.buffer,0,i))}this.fadeTexture=r,this._fadeParams.fadeTexture.value=r,r.needsUpdate=!0}}dispose(){this.fadeTexture&&this.fadeTexture.dispose()}}class br extends Z{setValueAt(t,...e){const{data:s,width:i,height:r}=this.image,n=Math.floor(s.length/(i*r));let a=!1;for(let o=0;o<n;o++){const i=t*n+o,r=s[i],l=e[o]||0;r!==l&&(s[i]=l,a=!0)}a&&(this.needsUpdate=!0)}}const xr=Symbol("HAS_POPPED_IN"),Tr=new i,vr=new i,wr=new g,Pr=new g,Cr=new i;function Mr(){const t=this._fadeManager,e=this.tiles;this._fadingBefore=t.fadeCount,this._displayActiveTiles=e.displayActiveTiles,e.displayActiveTiles=!0}function Sr(){const t=this._fadeManager,e=this._fadeMaterialManager,s=this._displayActiveTiles,i=this._fadingBefore,r=this._prevCameraTransforms,{tiles:n,maximumFadeOutTiles:a,batchedMesh:o}=this,{cameras:l}=n;n.displayActiveTiles=s,t.update();const c=t.fadeCount;if(0!==i&&0!==c&&(n.dispatchEvent({type:"fade-change"}),n.dispatchEvent({type:"force-rerender"})),s||n.visibleTiles.forEach((t=>{const e=t.cached.scene;e&&(e.visible=t.__inFrustum),this.forEachBatchIds(t,((e,s,i)=>{s.setVisibleAt(e,t.__inFrustum),i.batchedMesh.setVisibleAt(e,t.__inFrustum)}))})),a<this._fadingOutCount){let e=!0;l.forEach((t=>{if(!r.has(t))return;const s=t.matrixWorld,i=r.get(t);s.decompose(vr,Pr,Cr),i.decompose(Tr,wr,Cr);const n=Pr.angleTo(wr),a=vr.distanceTo(Tr);e=e&&(n>.25||a>.1)})),e&&t.completeAllFades()}if(l.forEach((t=>{r.get(t).copy(t.matrixWorld)})),t.forEachObject(((s,{fadeIn:i,fadeOut:r})=>{const a=s.cached.scene,o=t.isFadingOut(s);n.markTileUsed(s),a&&(e.setFade(a,i,r),o&&(a.visible=!0)),this.forEachBatchIds(s,((t,e,s)=>{e.setFadeAt(t,i,r),e.setVisibleAt(t,!0),s.batchedMesh.setVisibleAt(t,!1)}))})),o){const t=n.getPluginByName("BATCHED_TILES_PLUGIN").batchedMesh.material;o.material.map=t.map}}class Ar{get fadeDuration(){return this._fadeManager.duration}set fadeDuration(t){this._fadeManager.duration=Number(t)}get fadingTiles(){return this._fadeManager.fadeCount}constructor(t){t={maximumFadeOutTiles:50,fadeRootTiles:!1,fadeDuration:250,...t},this.name="FADE_TILES_PLUGIN",this.priority=-2,this.tiles=null,this.batchedMesh=null,this._fadeManager=new mr,this._fadeMaterialManager=new gr,this._prevCameraTransforms=null,this._fadingOutCount=0,this.maximumFadeOutTiles=t.maximumFadeOutTiles,this.fadeRootTiles=t.fadeRootTiles,this.fadeDuration=t.fadeDuration}init(t){this._onLoadModel=({scene:t})=>{this._fadeMaterialManager.prepareScene(t)},this._onDisposeModel=({tile:t,scene:e})=>{this._fadeManager.deleteObject(t),this._fadeMaterialManager.deleteScene(e)},this._onAddCamera=({camera:t})=>{this._prevCameraTransforms.set(t,new e)},this._onDeleteCamera=({camera:t})=>{this._prevCameraTransforms.delete(t)},this._onTileVisibilityChange=({tile:t,visible:e})=>{const s=t.cached.scene;s&&(s.visible=!0),this.forEachBatchIds(t,((t,e,s)=>{e.setFadeAt(t,0,0),e.setVisibleAt(t,!1),s.batchedMesh.setVisibleAt(t,!1)}))},this._onUpdateBefore=()=>{Mr.call(this)},this._onUpdateAfter=()=>{Sr.call(this)},t.addEventListener("load-model",this._onLoadModel),t.addEventListener("dispose-model",this._onDisposeModel),t.addEventListener("add-camera",this._onAddCamera),t.addEventListener("delete-camera",this._onDeleteCamera),t.addEventListener("update-before",this._onUpdateBefore),t.addEventListener("update-after",this._onUpdateAfter),t.addEventListener("tile-visibility-change",this._onTileVisibilityChange);const s=this._fadeManager;s.onFadeSetStart=()=>{t.dispatchEvent({type:"fade-start"}),t.dispatchEvent({type:"force-rerender"})},s.onFadeSetComplete=()=>{t.dispatchEvent({type:"fade-end"}),t.dispatchEvent({type:"force-rerender"})},s.onFadeComplete=(e,s)=>{this._fadeMaterialManager.setFade(e.cached.scene,0,0),this.forEachBatchIds(e,((t,e,i)=>{e.setFadeAt(t,0,0),e.setVisibleAt(t,!1),i.batchedMesh.setVisibleAt(t,s)})),s||(t.invokeOnePlugin((t=>t!==this&&t.setTileVisible&&t.setTileVisible(e,!1))),this._fadingOutCount--)};const i=new Map;t.cameras.forEach((t=>{i.set(t,new e)})),t.forEachLoadedModel(((t,e)=>{this._onLoadModel({scene:t})})),this.tiles=t,this._fadeManager=s,this._prevCameraTransforms=i}initBatchedMesh(){const t=this.tiles.getPluginByName("BATCHED_TILES_PLUGIN")?.batchedMesh;if(t){if(null===this.batchedMesh){this._onBatchedMeshDispose=()=>{this.batchedMesh.dispose(),this.batchedMesh.removeFromParent(),this.batchedMesh=null,t.removeEventListener("dispose",this._onBatchedMeshDispose)};const e=t.material.clone();e.onBeforeCompile=t.material.onBeforeCompile,this.batchedMesh=new _r(t,e),this.tiles.group.add(this.batchedMesh)}}else null!==this.batchedMesh&&(this._onBatchedMeshDispose(),this._onBatchedMeshDispose=null)}setTileVisible(t,e){const s=this._fadeManager,i=s.isFading(t);if(s.isFadingOut(t)&&this._fadingOutCount--,e){1===t.__depthFromRenderedParent?((t[xr]||this.fadeRootTiles)&&this._fadeManager.fadeIn(t),t[xr]=!0):this._fadeManager.fadeIn(t)}else this._fadingOutCount++,s.fadeOut(t);if(i)return!0;const r=this._fadeManager.isFading(t);return!(e||!r)}dispose(){const t=this.tiles;this._fadeManager.completeAllFades(),null!==this.batchedMesh&&this._onBatchedMeshDispose(),t.removeEventListener("load-model",this._onLoadModel),t.removeEventListener("dispose-model",this._onDisposeModel),t.removeEventListener("add-camera",this._onAddCamera),t.removeEventListener("delete-camera",this._onDeleteCamera),t.removeEventListener("update-before",this._onUpdateBefore),t.removeEventListener("update-after",this._onUpdateAfter),t.removeEventListener("tile-visibility-change",this._onTileVisibilityChange),t.forEachLoadedModel(((t,e)=>{this._fadeManager.deleteObject(e),t&&(t.visible=!0)}))}forEachBatchIds(t,e){if(this.initBatchedMesh(),this.batchedMesh){const s=this.tiles.getPluginByName("BATCHED_TILES_PLUGIN"),i=s.getTileBatchIds(t);i&&i.forEach((t=>{e(t,this.batchedMesh,s)}))}}}export{ui as C,hr as G,Ke as T,mi as U,li as a,Ks as b,yi as c,dr as d,Ar as e};
